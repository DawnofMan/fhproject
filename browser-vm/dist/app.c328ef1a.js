// modules are defined as an array
// [ module function, map of requires ]
//
// map of requires is short require name -> numeric require
//
// anything defined in a previous bundle is accessed via the
// orig method which is the require for previous bundles
parcelRequire = (function (modules, cache, entry, globalName) {
  // Save the require from previous bundle to this closure if any
  var previousRequire = typeof parcelRequire === 'function' && parcelRequire;
  var nodeRequire = typeof require === 'function' && require;

  function newRequire(name, jumped) {
    if (!cache[name]) {
      if (!modules[name]) {
        // if we cannot find the module within our internal map or
        // cache jump to the current global require ie. the last bundle
        // that was added to the page.
        var currentRequire = typeof parcelRequire === 'function' && parcelRequire;
        if (!jumped && currentRequire) {
          return currentRequire(name, true);
        }

        // If there are other bundles on this page the require from the
        // previous one is saved to 'previousRequire'. Repeat this as
        // many times as there are bundles until the module is found or
        // we exhaust the require chain.
        if (previousRequire) {
          return previousRequire(name, true);
        }

        // Try the node require function if it exists.
        if (nodeRequire && typeof name === 'string') {
          return nodeRequire(name);
        }

        var err = new Error('Cannot find module \'' + name + '\'');
        err.code = 'MODULE_NOT_FOUND';
        throw err;
      }

      localRequire.resolve = resolve;
      localRequire.cache = {};

      var module = cache[name] = new newRequire.Module(name);

      modules[name][0].call(module.exports, localRequire, module, module.exports, this);
    }

    return cache[name].exports;

    function localRequire(x){
      return newRequire(localRequire.resolve(x));
    }

    function resolve(x){
      return modules[name][1][x] || x;
    }
  }

  function Module(moduleName) {
    this.id = moduleName;
    this.bundle = newRequire;
    this.exports = {};
  }

  newRequire.isParcelRequire = true;
  newRequire.Module = Module;
  newRequire.modules = modules;
  newRequire.cache = cache;
  newRequire.parent = previousRequire;
  newRequire.register = function (id, exports) {
    modules[id] = [function (require, module) {
      module.exports = exports;
    }, {}];
  };

  var error;
  for (var i = 0; i < entry.length; i++) {
    try {
      newRequire(entry[i]);
    } catch (e) {
      // Save first error but execute all entries
      if (!error) {
        error = e;
      }
    }
  }

  if (entry.length) {
    // Expose entry point to Node, AMD or browser globals
    // Based on https://github.com/ForbesLindesay/umd/blob/master/template.js
    var mainExports = newRequire(entry[entry.length - 1]);

    // CommonJS
    if (typeof exports === "object" && typeof module !== "undefined") {
      module.exports = mainExports;

    // RequireJS
    } else if (typeof define === "function" && define.amd) {
     define(function () {
       return mainExports;
     });

    // <script>
    } else if (globalName) {
      this[globalName] = mainExports;
    }
  }

  // Override the current require with this new one
  parcelRequire = newRequire;

  if (error) {
    // throw error from earlier, _after updating parcelRequire_
    throw error;
  }

  return newRequire;
})({"../node_modules/workbox-window/build/workbox-window.prod.es5.mjs":[function(require,module,exports) {
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.messageSW = exports.Workbox = void 0;

try {
  self["workbox:window:4.3.1"] && _();
} catch (n) {}

var n = function (n, t) {
  return new Promise(function (i) {
    var e = new MessageChannel();
    e.port1.onmessage = function (n) {
      return i(n.data);
    }, n.postMessage(t, [e.port2]);
  });
};

exports.messageSW = n;

function t(n, t) {
  for (var i = 0; i < t.length; i++) {
    var e = t[i];
    e.enumerable = e.enumerable || !1, e.configurable = !0, "value" in e && (e.writable = !0), Object.defineProperty(n, e.key, e);
  }
}

function i(n) {
  if (void 0 === n) throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
  return n;
}

try {
  self["workbox:core:4.3.1"] && _();
} catch (n) {}

var e = function () {
  var n = this;
  this.promise = new Promise(function (t, i) {
    n.resolve = t, n.reject = i;
  });
},
    r = function (n, t) {
  return new URL(n, location).href === new URL(t, location).href;
},
    o = function (n, t) {
  Object.assign(this, t, {
    type: n
  });
};

function u(n) {
  return function () {
    for (var t = [], i = 0; i < arguments.length; i++) t[i] = arguments[i];

    try {
      return Promise.resolve(n.apply(this, t));
    } catch (n) {
      return Promise.reject(n);
    }
  };
}

function a(n, t, i) {
  return i ? t ? t(n) : n : (n && n.then || (n = Promise.resolve(n)), t ? n.then(t) : n);
}

function s() {}

var c = function (c) {
  var f, h;

  function v(n, t) {
    var r;
    return void 0 === t && (t = {}), (r = c.call(this) || this).t = n, r.i = t, r.o = 0, r.u = new e(), r.s = new e(), r.h = new e(), r.v = r.v.bind(i(i(r))), r.l = r.l.bind(i(i(r))), r.g = r.g.bind(i(i(r))), r.m = r.m.bind(i(i(r))), r;
  }

  h = c, (f = v).prototype = Object.create(h.prototype), f.prototype.constructor = f, f.__proto__ = h;
  var l,
      w,
      g,
      d = v.prototype;
  return d.register = u(function (n) {
    var t,
        i,
        e = this,
        u = (void 0 === n ? {} : n).immediate,
        c = void 0 !== u && u;
    return t = function () {
      return e.p = Boolean(navigator.serviceWorker.controller), e.P = e.R(), a(e.k(), function (n) {
        e.B = n, e.P && (e.O = e.P, e.s.resolve(e.P), e.h.resolve(e.P), e.j(e.P), e.P.addEventListener("statechange", e.l, {
          once: !0
        }));
        var t = e.B.waiting;
        return t && r(t.scriptURL, e.t) && (e.O = t, Promise.resolve().then(function () {
          e.dispatchEvent(new o("waiting", {
            sw: t,
            wasWaitingBeforeRegister: !0
          }));
        })), e.O && e.u.resolve(e.O), e.B.addEventListener("updatefound", e.g), navigator.serviceWorker.addEventListener("controllerchange", e.m, {
          once: !0
        }), "BroadcastChannel" in self && (e.C = new BroadcastChannel("workbox"), e.C.addEventListener("message", e.v)), navigator.serviceWorker.addEventListener("message", e.v), e.B;
      });
    }, (i = function () {
      if (!c && "complete" !== document.readyState) return function (n, t) {
        if (!t) return n && n.then ? n.then(s) : Promise.resolve();
      }(new Promise(function (n) {
        return addEventListener("load", n);
      }));
    }()) && i.then ? i.then(t) : t(i);
  }), d.getSW = u(function () {
    return this.O || this.u.promise;
  }), d.messageSW = u(function (t) {
    return a(this.getSW(), function (i) {
      return n(i, t);
    });
  }), d.R = function () {
    var n = navigator.serviceWorker.controller;
    if (n && r(n.scriptURL, this.t)) return n;
  }, d.k = u(function () {
    var n = this;
    return function (n, t) {
      try {
        var i = n();
      } catch (n) {
        return t(n);
      }

      return i && i.then ? i.then(void 0, t) : i;
    }(function () {
      return a(navigator.serviceWorker.register(n.t, n.i), function (t) {
        return n.L = performance.now(), t;
      });
    }, function (n) {
      throw n;
    });
  }), d.j = function (t) {
    n(t, {
      type: "WINDOW_READY",
      meta: "workbox-window"
    });
  }, d.g = function () {
    var n = this.B.installing;
    this.o > 0 || !r(n.scriptURL, this.t) || performance.now() > this.L + 6e4 ? (this.W = n, this.B.removeEventListener("updatefound", this.g)) : (this.O = n, this.u.resolve(n)), ++this.o, n.addEventListener("statechange", this.l);
  }, d.l = function (n) {
    var t = this,
        i = n.target,
        e = i.state,
        r = i === this.W,
        u = r ? "external" : "",
        a = {
      sw: i,
      originalEvent: n
    };
    !r && this.p && (a.isUpdate = !0), this.dispatchEvent(new o(u + e, a)), "installed" === e ? this._ = setTimeout(function () {
      "installed" === e && t.B.waiting === i && t.dispatchEvent(new o(u + "waiting", a));
    }, 200) : "activating" === e && (clearTimeout(this._), r || this.s.resolve(i));
  }, d.m = function (n) {
    var t = this.O;
    t === navigator.serviceWorker.controller && (this.dispatchEvent(new o("controlling", {
      sw: t,
      originalEvent: n
    })), this.h.resolve(t));
  }, d.v = function (n) {
    var t = n.data;
    this.dispatchEvent(new o("message", {
      data: t,
      originalEvent: n
    }));
  }, l = v, (w = [{
    key: "active",
    get: function () {
      return this.s.promise;
    }
  }, {
    key: "controlling",
    get: function () {
      return this.h.promise;
    }
  }]) && t(l.prototype, w), g && t(l, g), v;
}(function () {
  function n() {
    this.D = {};
  }

  var t = n.prototype;
  return t.addEventListener = function (n, t) {
    this.T(n).add(t);
  }, t.removeEventListener = function (n, t) {
    this.T(n).delete(t);
  }, t.dispatchEvent = function (n) {
    n.target = this, this.T(n.type).forEach(function (t) {
      return t(n);
    });
  }, t.T = function (n) {
    return this.D[n] = this.D[n] || new Set();
  }, n;
}());

exports.Workbox = c;
},{}],"dtconfig.js":[function(require,module,exports) {
'use strict';

module.exports = {
  snapshotUrl: 'bios/dtsnapshot.bin',
  dtSnapshotsCache: 'dt_snapshots',
  emulatorDefaultParams: {
    memory_size: 64 * 1024 * 1024,
    vga_memory_size: 2 * 1024 * 1024,
    screen_container: document.getElementById('dt_container'),
    bios: {
      url: 'bios/seabios.bin'
    },
    vga_bios: {
      url: 'bios/vgabios.bin'
    },
    cdrom: {
      url: 'build/embed_buildroot_test.iso'
    },
    //network_relay_url: 'ws://localhost:8080/',
    disable_mouse: false,
    disable_keyboard: false,
    disable_speaker: true,
    autostart: true
  }
};
},{}],"../node_modules/filer/dist/filer.min.js":[function(require,module,exports) {
var define;
parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"c0Ea":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.promisify=e;var r="__ES6-PROMISIFY--CUSTOM-ARGUMENTS__";function e(n){if("function"!=typeof n)throw new TypeError("Argument to promisify must be a function");var o=n[r],t=e.Promise||Promise;if("function"!=typeof t)throw new Error("No Promise implementation found; do you need a polyfill?");return function(){for(var r=this,e=arguments.length,i=new Array(e),f=0;f<e;f++)i[f]=arguments[f];return new t(function(e,t){i.push(function(r){if(r)return t(r);for(var n=arguments.length,i=new Array(n>1?n-1:0),f=1;f<n;f++)i[f-1]=arguments[f];if(1===i.length||!o)return e(i[0]);var u={};i.forEach(function(r,e){var n=o[e];n&&(u[n]=r)}),e(u)}),n.apply(r,i)})}}e.argumentNames=r,e.Promise=void 0;
},{}],"pBGv":[function(require,module,exports) {

var t,e,n=module.exports={};function r(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(t===setTimeout)return setTimeout(e,0);if((t===r||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}function u(t){if(e===clearTimeout)return clearTimeout(t);if((e===o||!e)&&clearTimeout)return e=clearTimeout,clearTimeout(t);try{return e(t)}catch(n){try{return e.call(null,t)}catch(n){return e.call(this,t)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:r}catch(n){t=r}try{e="function"==typeof clearTimeout?clearTimeout:o}catch(n){e=o}}();var c,s=[],l=!1,a=-1;function f(){l&&c&&(l=!1,c.length?s=c.concat(s):a=-1,s.length&&h())}function h(){if(!l){var t=i(f);l=!0;for(var e=s.length;e;){for(c=s,s=[];++a<e;)c&&c[a].run();a=-1,e=s.length}c=null,l=!1,u(t)}}function m(t,e){this.fun=t,this.array=e}function p(){}n.nextTick=function(t){var e=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)e[n-1]=arguments[n];s.push(new m(t,e)),1!==s.length||l||i(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},n.title="browser",n.env={},n.argv=[],n.version="",n.versions={},n.on=p,n.addListener=p,n.once=p,n.off=p,n.removeListener=p,n.removeAllListeners=p,n.emit=p,n.prependListener=p,n.prependOnceListener=p,n.listeners=function(t){return[]},n.binding=function(t){throw new Error("process.binding is not supported")},n.cwd=function(){return"/"},n.chdir=function(t){throw new Error("process.chdir is not supported")},n.umask=function(){return 0};
},{}],"UUq2":[function(require,module,exports) {
var process = require("process");
var r=require("process");function t(r,t){for(var e=0,n=r.length-1;n>=0;n--){var o=r[n];"."===o?r.splice(n,1):".."===o?(r.splice(n,1),e++):e&&(r.splice(n,1),e--)}if(t)for(;e--;e)r.unshift("..");return r}function e(r){"string"!=typeof r&&(r+="");var t,e=0,n=-1,o=!0;for(t=r.length-1;t>=0;--t)if(47===r.charCodeAt(t)){if(!o){e=t+1;break}}else-1===n&&(o=!1,n=t+1);return-1===n?"":r.slice(e,n)}function n(r,t){if(r.filter)return r.filter(t);for(var e=[],n=0;n<r.length;n++)t(r[n],n,r)&&e.push(r[n]);return e}exports.resolve=function(){for(var e="",o=!1,s=arguments.length-1;s>=-1&&!o;s--){var i=s>=0?arguments[s]:r.cwd();if("string"!=typeof i)throw new TypeError("Arguments to path.resolve must be strings");i&&(e=i+"/"+e,o="/"===i.charAt(0))}return(o?"/":"")+(e=t(n(e.split("/"),function(r){return!!r}),!o).join("/"))||"."},exports.normalize=function(r){var e=exports.isAbsolute(r),s="/"===o(r,-1);return(r=t(n(r.split("/"),function(r){return!!r}),!e).join("/"))||e||(r="."),r&&s&&(r+="/"),(e?"/":"")+r},exports.isAbsolute=function(r){return"/"===r.charAt(0)},exports.join=function(){var r=Array.prototype.slice.call(arguments,0);return exports.normalize(n(r,function(r,t){if("string"!=typeof r)throw new TypeError("Arguments to path.join must be strings");return r}).join("/"))},exports.relative=function(r,t){function e(r){for(var t=0;t<r.length&&""===r[t];t++);for(var e=r.length-1;e>=0&&""===r[e];e--);return t>e?[]:r.slice(t,e-t+1)}r=exports.resolve(r).substr(1),t=exports.resolve(t).substr(1);for(var n=e(r.split("/")),o=e(t.split("/")),s=Math.min(n.length,o.length),i=s,u=0;u<s;u++)if(n[u]!==o[u]){i=u;break}var f=[];for(u=i;u<n.length;u++)f.push("..");return(f=f.concat(o.slice(i))).join("/")},exports.sep="/",exports.delimiter=":",exports.dirname=function(r){if("string"!=typeof r&&(r+=""),0===r.length)return".";for(var t=r.charCodeAt(0),e=47===t,n=-1,o=!0,s=r.length-1;s>=1;--s)if(47===(t=r.charCodeAt(s))){if(!o){n=s;break}}else o=!1;return-1===n?e?"/":".":e&&1===n?"/":r.slice(0,n)},exports.basename=function(r,t){var n=e(r);return t&&n.substr(-1*t.length)===t&&(n=n.substr(0,n.length-t.length)),n},exports.extname=function(r){"string"!=typeof r&&(r+="");for(var t=-1,e=0,n=-1,o=!0,s=0,i=r.length-1;i>=0;--i){var u=r.charCodeAt(i);if(47!==u)-1===n&&(o=!1,n=i+1),46===u?-1===t?t=i:1!==s&&(s=1):-1!==t&&(s=-1);else if(!o){e=i+1;break}}return-1===t||-1===n||0===s||1===s&&t===n-1&&t===e+1?"":r.slice(t,n)};var o="b"==="ab".substr(-1)?function(r,t,e){return r.substr(t,e)}:function(r,t,e){return t<0&&(t=r.length+t),r.substr(t,e)};
},{"process":"pBGv"}],"UzoP":[function(require,module,exports) {
var process = require("process");
var e=require("process");e.cwd=function(){return"/"};var r=require("path"),n=Object.create(r);n.basename=function(e,n){var i=r.basename(e,n);return""===i?"/":i},n.normalize=function(e){return"/"===(e=r.normalize(e))?e:n.removeTrailing(e)},n.isNull=function(e){return-1!==(""+e).indexOf("\0")},n.addTrailing=function(e){return e.replace(/\/*$/,"/")},n.removeTrailing=function(e){return""===(e=e.replace(/\/*$/,""))?"/":e},module.exports=n;
},{"path":"UUq2","process":"pBGv"}],"iJA9":[function(require,module,exports) {
var _="READ",E="WRITE",O="CREATE",R="EXCLUSIVE",I="TRUNCATE",S="APPEND",T="CREATE",N="REPLACE";module.exports={FILE_SYSTEM_NAME:"local",FILE_STORE_NAME:"files",IDB_RO:"readonly",IDB_RW:"readwrite",WSQL_VERSION:"1",WSQL_SIZE:5242880,WSQL_DESC:"FileSystem Storage",NODE_TYPE_FILE:"FILE",NODE_TYPE_DIRECTORY:"DIRECTORY",NODE_TYPE_SYMBOLIC_LINK:"SYMLINK",NODE_TYPE_META:"META",DEFAULT_DIR_PERMISSIONS:493,DEFAULT_FILE_PERMISSIONS:420,FULL_READ_WRITE_EXEC_PERMISSIONS:511,READ_WRITE_PERMISSIONS:438,SYMLOOP_MAX:10,BINARY_MIME_TYPE:"application/octet-stream",JSON_MIME_TYPE:"application/json",ROOT_DIRECTORY_NAME:"/",FS_FORMAT:"FORMAT",FS_NOCTIME:"NOCTIME",FS_NOMTIME:"NOMTIME",FS_NODUPEIDCHECK:"FS_NODUPEIDCHECK",O_READ:_,O_WRITE:E,O_CREATE:O,O_EXCLUSIVE:R,O_TRUNCATE:I,O_APPEND:S,O_FLAGS:{r:[_],"r+":[_,E],w:[E,O,I],"w+":[E,_,O,I],wx:[E,O,R,I],"wx+":[E,_,O,R,I],a:[E,O,S],"a+":[E,_,O,S],ax:[E,O,R,S],"ax+":[E,_,O,R,S]},XATTR_CREATE:T,XATTR_REPLACE:N,FS_READY:"READY",FS_PENDING:"PENDING",FS_ERROR:"ERROR",SUPER_NODE_ID:"00000000-0000-0000-0000-000000000000",STDIN:0,STDOUT:1,STDERR:2,FIRST_DESCRIPTOR:3,ENVIRONMENT:{TMP:"/tmp",PATH:""},fsConstants:{O_RDONLY:0,O_WRONLY:1,O_RDWR:2,S_IFMT:61440,S_IFREG:32768,S_IFDIR:16384,S_IFCHR:8192,S_IFBLK:24576,S_IFIFO:4096,S_IFLNK:40960,S_IFSOCK:49152,O_CREAT:512,O_EXCL:2048,O_NOCTTY:131072,O_TRUNC:1024,O_APPEND:8,O_DIRECTORY:1048576,O_NOFOLLOW:256,O_SYNC:128,O_DSYNC:4194304,O_SYMLINK:2097152,O_NONBLOCK:4,S_IRWXU:448,S_IRUSR:256,S_IWUSR:128,S_IXUSR:64,S_IRWXG:56,S_IRGRP:32,S_IWGRP:16,S_IXGRP:8,S_IRWXO:7,S_IROTH:4,S_IWOTH:2,S_IXOTH:1,F_OK:0,R_OK:4,W_OK:2,X_OK:1,UV_FS_COPYFILE_EXCL:1,COPYFILE_EXCL:1}};
},{}],"yh9p":[function(require,module,exports) {
"use strict";exports.byteLength=u,exports.toByteArray=i,exports.fromByteArray=d;for(var r=[],t=[],e="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=0,a=n.length;o<a;++o)r[o]=n[o],t[n.charCodeAt(o)]=o;function h(r){var t=r.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var e=r.indexOf("=");return-1===e&&(e=t),[e,e===t?0:4-e%4]}function u(r){var t=h(r),e=t[0],n=t[1];return 3*(e+n)/4-n}function c(r,t,e){return 3*(t+e)/4-e}function i(r){var n,o,a=h(r),u=a[0],i=a[1],f=new e(c(r,u,i)),A=0,d=i>0?u-4:u;for(o=0;o<d;o+=4)n=t[r.charCodeAt(o)]<<18|t[r.charCodeAt(o+1)]<<12|t[r.charCodeAt(o+2)]<<6|t[r.charCodeAt(o+3)],f[A++]=n>>16&255,f[A++]=n>>8&255,f[A++]=255&n;return 2===i&&(n=t[r.charCodeAt(o)]<<2|t[r.charCodeAt(o+1)]>>4,f[A++]=255&n),1===i&&(n=t[r.charCodeAt(o)]<<10|t[r.charCodeAt(o+1)]<<4|t[r.charCodeAt(o+2)]>>2,f[A++]=n>>8&255,f[A++]=255&n),f}function f(t){return r[t>>18&63]+r[t>>12&63]+r[t>>6&63]+r[63&t]}function A(r,t,e){for(var n,o=[],a=t;a<e;a+=3)n=(r[a]<<16&16711680)+(r[a+1]<<8&65280)+(255&r[a+2]),o.push(f(n));return o.join("")}function d(t){for(var e,n=t.length,o=n%3,a=[],h=0,u=n-o;h<u;h+=16383)a.push(A(t,h,h+16383>u?u:h+16383));return 1===o?(e=t[n-1],a.push(r[e>>2]+r[e<<4&63]+"==")):2===o&&(e=(t[n-2]<<8)+t[n-1],a.push(r[e>>10]+r[e>>4&63]+r[e<<2&63]+"=")),a.join("")}t["-".charCodeAt(0)]=62,t["_".charCodeAt(0)]=63;
},{}],"JgNJ":[function(require,module,exports) {
exports.read=function(a,o,t,r,h){var M,p,w=8*h-r-1,f=(1<<w)-1,e=f>>1,i=-7,N=t?h-1:0,n=t?-1:1,s=a[o+N];for(N+=n,M=s&(1<<-i)-1,s>>=-i,i+=w;i>0;M=256*M+a[o+N],N+=n,i-=8);for(p=M&(1<<-i)-1,M>>=-i,i+=r;i>0;p=256*p+a[o+N],N+=n,i-=8);if(0===M)M=1-e;else{if(M===f)return p?NaN:1/0*(s?-1:1);p+=Math.pow(2,r),M-=e}return(s?-1:1)*p*Math.pow(2,M-r)},exports.write=function(a,o,t,r,h,M){var p,w,f,e=8*M-h-1,i=(1<<e)-1,N=i>>1,n=23===h?Math.pow(2,-24)-Math.pow(2,-77):0,s=r?0:M-1,u=r?1:-1,l=o<0||0===o&&1/o<0?1:0;for(o=Math.abs(o),isNaN(o)||o===1/0?(w=isNaN(o)?1:0,p=i):(p=Math.floor(Math.log(o)/Math.LN2),o*(f=Math.pow(2,-p))<1&&(p--,f*=2),(o+=p+N>=1?n/f:n*Math.pow(2,1-N))*f>=2&&(p++,f/=2),p+N>=i?(w=0,p=i):p+N>=1?(w=(o*f-1)*Math.pow(2,h),p+=N):(w=o*Math.pow(2,N-1)*Math.pow(2,h),p=0));h>=8;a[t+s]=255&w,s+=u,w/=256,h-=8);for(p=p<<h|w,e+=h;e>0;a[t+s]=255&p,s+=u,p/=256,e-=8);a[t+s-u]|=128*l};
},{}],"REa7":[function(require,module,exports) {
var r={}.toString;module.exports=Array.isArray||function(t){return"[object Array]"==r.call(t)};
},{}],"dskh":[function(require,module,exports) {

var global = arguments[3];
var t=arguments[3],r=require("base64-js"),e=require("ieee754"),n=require("isarray");function i(){try{var t=new Uint8Array(1);return t.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===t.foo()&&"function"==typeof t.subarray&&0===t.subarray(1,1).byteLength}catch(r){return!1}}function o(){return f.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function u(t,r){if(o()<r)throw new RangeError("Invalid typed array length");return f.TYPED_ARRAY_SUPPORT?(t=new Uint8Array(r)).__proto__=f.prototype:(null===t&&(t=new f(r)),t.length=r),t}function f(t,r,e){if(!(f.TYPED_ARRAY_SUPPORT||this instanceof f))return new f(t,r,e);if("number"==typeof t){if("string"==typeof r)throw new Error("If encoding is specified then the first argument must be a string");return c(this,t)}return s(this,t,r,e)}function s(t,r,e,n){if("number"==typeof r)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&r instanceof ArrayBuffer?g(t,r,e,n):"string"==typeof r?l(t,r,e):y(t,r)}function h(t){if("number"!=typeof t)throw new TypeError('"size" argument must be a number');if(t<0)throw new RangeError('"size" argument must not be negative')}function a(t,r,e,n){return h(r),r<=0?u(t,r):void 0!==e?"string"==typeof n?u(t,r).fill(e,n):u(t,r).fill(e):u(t,r)}function c(t,r){if(h(r),t=u(t,r<0?0:0|w(r)),!f.TYPED_ARRAY_SUPPORT)for(var e=0;e<r;++e)t[e]=0;return t}function l(t,r,e){if("string"==typeof e&&""!==e||(e="utf8"),!f.isEncoding(e))throw new TypeError('"encoding" must be a valid string encoding');var n=0|v(r,e),i=(t=u(t,n)).write(r,e);return i!==n&&(t=t.slice(0,i)),t}function p(t,r){var e=r.length<0?0:0|w(r.length);t=u(t,e);for(var n=0;n<e;n+=1)t[n]=255&r[n];return t}function g(t,r,e,n){if(r.byteLength,e<0||r.byteLength<e)throw new RangeError("'offset' is out of bounds");if(r.byteLength<e+(n||0))throw new RangeError("'length' is out of bounds");return r=void 0===e&&void 0===n?new Uint8Array(r):void 0===n?new Uint8Array(r,e):new Uint8Array(r,e,n),f.TYPED_ARRAY_SUPPORT?(t=r).__proto__=f.prototype:t=p(t,r),t}function y(t,r){if(f.isBuffer(r)){var e=0|w(r.length);return 0===(t=u(t,e)).length?t:(r.copy(t,0,0,e),t)}if(r){if("undefined"!=typeof ArrayBuffer&&r.buffer instanceof ArrayBuffer||"length"in r)return"number"!=typeof r.length||W(r.length)?u(t,0):p(t,r);if("Buffer"===r.type&&n(r.data))return p(t,r.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function w(t){if(t>=o())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+o().toString(16)+" bytes");return 0|t}function d(t){return+t!=t&&(t=0),f.alloc(+t)}function v(t,r){if(f.isBuffer(t))return t.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(t)||t instanceof ArrayBuffer))return t.byteLength;"string"!=typeof t&&(t=""+t);var e=t.length;if(0===e)return 0;for(var n=!1;;)switch(r){case"ascii":case"latin1":case"binary":return e;case"utf8":case"utf-8":case void 0:return $(t).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*e;case"hex":return e>>>1;case"base64":return K(t).length;default:if(n)return $(t).length;r=(""+r).toLowerCase(),n=!0}}function E(t,r,e){var n=!1;if((void 0===r||r<0)&&(r=0),r>this.length)return"";if((void 0===e||e>this.length)&&(e=this.length),e<=0)return"";if((e>>>=0)<=(r>>>=0))return"";for(t||(t="utf8");;)switch(t){case"hex":return x(this,r,e);case"utf8":case"utf-8":return Y(this,r,e);case"ascii":return L(this,r,e);case"latin1":case"binary":return D(this,r,e);case"base64":return S(this,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,r,e);default:if(n)throw new TypeError("Unknown encoding: "+t);t=(t+"").toLowerCase(),n=!0}}function b(t,r,e){var n=t[r];t[r]=t[e],t[e]=n}function R(t,r,e,n,i){if(0===t.length)return-1;if("string"==typeof e?(n=e,e=0):e>2147483647?e=2147483647:e<-2147483648&&(e=-2147483648),e=+e,isNaN(e)&&(e=i?0:t.length-1),e<0&&(e=t.length+e),e>=t.length){if(i)return-1;e=t.length-1}else if(e<0){if(!i)return-1;e=0}if("string"==typeof r&&(r=f.from(r,n)),f.isBuffer(r))return 0===r.length?-1:_(t,r,e,n,i);if("number"==typeof r)return r&=255,f.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(t,r,e):Uint8Array.prototype.lastIndexOf.call(t,r,e):_(t,[r],e,n,i);throw new TypeError("val must be string, number or Buffer")}function _(t,r,e,n,i){var o,u=1,f=t.length,s=r.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(t.length<2||r.length<2)return-1;u=2,f/=2,s/=2,e/=2}function h(t,r){return 1===u?t[r]:t.readUInt16BE(r*u)}if(i){var a=-1;for(o=e;o<f;o++)if(h(t,o)===h(r,-1===a?0:o-a)){if(-1===a&&(a=o),o-a+1===s)return a*u}else-1!==a&&(o-=o-a),a=-1}else for(e+s>f&&(e=f-s),o=e;o>=0;o--){for(var c=!0,l=0;l<s;l++)if(h(t,o+l)!==h(r,l)){c=!1;break}if(c)return o}return-1}function A(t,r,e,n){e=Number(e)||0;var i=t.length-e;n?(n=Number(n))>i&&(n=i):n=i;var o=r.length;if(o%2!=0)throw new TypeError("Invalid hex string");n>o/2&&(n=o/2);for(var u=0;u<n;++u){var f=parseInt(r.substr(2*u,2),16);if(isNaN(f))return u;t[e+u]=f}return u}function m(t,r,e,n){return Q($(r,t.length-e),t,e,n)}function P(t,r,e,n){return Q(G(r),t,e,n)}function T(t,r,e,n){return P(t,r,e,n)}function B(t,r,e,n){return Q(K(r),t,e,n)}function U(t,r,e,n){return Q(H(r,t.length-e),t,e,n)}function S(t,e,n){return 0===e&&n===t.length?r.fromByteArray(t):r.fromByteArray(t.slice(e,n))}function Y(t,r,e){e=Math.min(t.length,e);for(var n=[],i=r;i<e;){var o,u,f,s,h=t[i],a=null,c=h>239?4:h>223?3:h>191?2:1;if(i+c<=e)switch(c){case 1:h<128&&(a=h);break;case 2:128==(192&(o=t[i+1]))&&(s=(31&h)<<6|63&o)>127&&(a=s);break;case 3:o=t[i+1],u=t[i+2],128==(192&o)&&128==(192&u)&&(s=(15&h)<<12|(63&o)<<6|63&u)>2047&&(s<55296||s>57343)&&(a=s);break;case 4:o=t[i+1],u=t[i+2],f=t[i+3],128==(192&o)&&128==(192&u)&&128==(192&f)&&(s=(15&h)<<18|(63&o)<<12|(63&u)<<6|63&f)>65535&&s<1114112&&(a=s)}null===a?(a=65533,c=1):a>65535&&(a-=65536,n.push(a>>>10&1023|55296),a=56320|1023&a),n.push(a),i+=c}return O(n)}exports.Buffer=f,exports.SlowBuffer=d,exports.INSPECT_MAX_BYTES=50,f.TYPED_ARRAY_SUPPORT=void 0!==t.TYPED_ARRAY_SUPPORT?t.TYPED_ARRAY_SUPPORT:i(),exports.kMaxLength=o(),f.poolSize=8192,f._augment=function(t){return t.__proto__=f.prototype,t},f.from=function(t,r,e){return s(null,t,r,e)},f.TYPED_ARRAY_SUPPORT&&(f.prototype.__proto__=Uint8Array.prototype,f.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&f[Symbol.species]===f&&Object.defineProperty(f,Symbol.species,{value:null,configurable:!0})),f.alloc=function(t,r,e){return a(null,t,r,e)},f.allocUnsafe=function(t){return c(null,t)},f.allocUnsafeSlow=function(t){return c(null,t)},f.isBuffer=function(t){return!(null==t||!t._isBuffer)},f.compare=function(t,r){if(!f.isBuffer(t)||!f.isBuffer(r))throw new TypeError("Arguments must be Buffers");if(t===r)return 0;for(var e=t.length,n=r.length,i=0,o=Math.min(e,n);i<o;++i)if(t[i]!==r[i]){e=t[i],n=r[i];break}return e<n?-1:n<e?1:0},f.isEncoding=function(t){switch(String(t).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},f.concat=function(t,r){if(!n(t))throw new TypeError('"list" argument must be an Array of Buffers');if(0===t.length)return f.alloc(0);var e;if(void 0===r)for(r=0,e=0;e<t.length;++e)r+=t[e].length;var i=f.allocUnsafe(r),o=0;for(e=0;e<t.length;++e){var u=t[e];if(!f.isBuffer(u))throw new TypeError('"list" argument must be an Array of Buffers');u.copy(i,o),o+=u.length}return i},f.byteLength=v,f.prototype._isBuffer=!0,f.prototype.swap16=function(){var t=this.length;if(t%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var r=0;r<t;r+=2)b(this,r,r+1);return this},f.prototype.swap32=function(){var t=this.length;if(t%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var r=0;r<t;r+=4)b(this,r,r+3),b(this,r+1,r+2);return this},f.prototype.swap64=function(){var t=this.length;if(t%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var r=0;r<t;r+=8)b(this,r,r+7),b(this,r+1,r+6),b(this,r+2,r+5),b(this,r+3,r+4);return this},f.prototype.toString=function(){var t=0|this.length;return 0===t?"":0===arguments.length?Y(this,0,t):E.apply(this,arguments)},f.prototype.equals=function(t){if(!f.isBuffer(t))throw new TypeError("Argument must be a Buffer");return this===t||0===f.compare(this,t)},f.prototype.inspect=function(){var t="",r=exports.INSPECT_MAX_BYTES;return this.length>0&&(t=this.toString("hex",0,r).match(/.{2}/g).join(" "),this.length>r&&(t+=" ... ")),"<Buffer "+t+">"},f.prototype.compare=function(t,r,e,n,i){if(!f.isBuffer(t))throw new TypeError("Argument must be a Buffer");if(void 0===r&&(r=0),void 0===e&&(e=t?t.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),r<0||e>t.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&r>=e)return 0;if(n>=i)return-1;if(r>=e)return 1;if(this===t)return 0;for(var o=(i>>>=0)-(n>>>=0),u=(e>>>=0)-(r>>>=0),s=Math.min(o,u),h=this.slice(n,i),a=t.slice(r,e),c=0;c<s;++c)if(h[c]!==a[c]){o=h[c],u=a[c];break}return o<u?-1:u<o?1:0},f.prototype.includes=function(t,r,e){return-1!==this.indexOf(t,r,e)},f.prototype.indexOf=function(t,r,e){return R(this,t,r,e,!0)},f.prototype.lastIndexOf=function(t,r,e){return R(this,t,r,e,!1)},f.prototype.write=function(t,r,e,n){if(void 0===r)n="utf8",e=this.length,r=0;else if(void 0===e&&"string"==typeof r)n=r,e=this.length,r=0;else{if(!isFinite(r))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");r|=0,isFinite(e)?(e|=0,void 0===n&&(n="utf8")):(n=e,e=void 0)}var i=this.length-r;if((void 0===e||e>i)&&(e=i),t.length>0&&(e<0||r<0)||r>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return A(this,t,r,e);case"utf8":case"utf-8":return m(this,t,r,e);case"ascii":return P(this,t,r,e);case"latin1":case"binary":return T(this,t,r,e);case"base64":return B(this,t,r,e);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return U(this,t,r,e);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},f.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var I=4096;function O(t){var r=t.length;if(r<=I)return String.fromCharCode.apply(String,t);for(var e="",n=0;n<r;)e+=String.fromCharCode.apply(String,t.slice(n,n+=I));return e}function L(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(127&t[i]);return n}function D(t,r,e){var n="";e=Math.min(t.length,e);for(var i=r;i<e;++i)n+=String.fromCharCode(t[i]);return n}function x(t,r,e){var n=t.length;(!r||r<0)&&(r=0),(!e||e<0||e>n)&&(e=n);for(var i="",o=r;o<e;++o)i+=Z(t[o]);return i}function C(t,r,e){for(var n=t.slice(r,e),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function M(t,r,e){if(t%1!=0||t<0)throw new RangeError("offset is not uint");if(t+r>e)throw new RangeError("Trying to access beyond buffer length")}function k(t,r,e,n,i,o){if(!f.isBuffer(t))throw new TypeError('"buffer" argument must be a Buffer instance');if(r>i||r<o)throw new RangeError('"value" argument is out of bounds');if(e+n>t.length)throw new RangeError("Index out of range")}function N(t,r,e,n){r<0&&(r=65535+r+1);for(var i=0,o=Math.min(t.length-e,2);i<o;++i)t[e+i]=(r&255<<8*(n?i:1-i))>>>8*(n?i:1-i)}function z(t,r,e,n){r<0&&(r=4294967295+r+1);for(var i=0,o=Math.min(t.length-e,4);i<o;++i)t[e+i]=r>>>8*(n?i:3-i)&255}function F(t,r,e,n,i,o){if(e+n>t.length)throw new RangeError("Index out of range");if(e<0)throw new RangeError("Index out of range")}function j(t,r,n,i,o){return o||F(t,r,n,4,3.4028234663852886e38,-3.4028234663852886e38),e.write(t,r,n,i,23,4),n+4}function q(t,r,n,i,o){return o||F(t,r,n,8,1.7976931348623157e308,-1.7976931348623157e308),e.write(t,r,n,i,52,8),n+8}f.prototype.slice=function(t,r){var e,n=this.length;if((t=~~t)<0?(t+=n)<0&&(t=0):t>n&&(t=n),(r=void 0===r?n:~~r)<0?(r+=n)<0&&(r=0):r>n&&(r=n),r<t&&(r=t),f.TYPED_ARRAY_SUPPORT)(e=this.subarray(t,r)).__proto__=f.prototype;else{var i=r-t;e=new f(i,void 0);for(var o=0;o<i;++o)e[o]=this[o+t]}return e},f.prototype.readUIntLE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n},f.prototype.readUIntBE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t+--r],i=1;r>0&&(i*=256);)n+=this[t+--r]*i;return n},f.prototype.readUInt8=function(t,r){return r||M(t,1,this.length),this[t]},f.prototype.readUInt16LE=function(t,r){return r||M(t,2,this.length),this[t]|this[t+1]<<8},f.prototype.readUInt16BE=function(t,r){return r||M(t,2,this.length),this[t]<<8|this[t+1]},f.prototype.readUInt32LE=function(t,r){return r||M(t,4,this.length),(this[t]|this[t+1]<<8|this[t+2]<<16)+16777216*this[t+3]},f.prototype.readUInt32BE=function(t,r){return r||M(t,4,this.length),16777216*this[t]+(this[t+1]<<16|this[t+2]<<8|this[t+3])},f.prototype.readIntLE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=this[t],i=1,o=0;++o<r&&(i*=256);)n+=this[t+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*r)),n},f.prototype.readIntBE=function(t,r,e){t|=0,r|=0,e||M(t,r,this.length);for(var n=r,i=1,o=this[t+--n];n>0&&(i*=256);)o+=this[t+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*r)),o},f.prototype.readInt8=function(t,r){return r||M(t,1,this.length),128&this[t]?-1*(255-this[t]+1):this[t]},f.prototype.readInt16LE=function(t,r){r||M(t,2,this.length);var e=this[t]|this[t+1]<<8;return 32768&e?4294901760|e:e},f.prototype.readInt16BE=function(t,r){r||M(t,2,this.length);var e=this[t+1]|this[t]<<8;return 32768&e?4294901760|e:e},f.prototype.readInt32LE=function(t,r){return r||M(t,4,this.length),this[t]|this[t+1]<<8|this[t+2]<<16|this[t+3]<<24},f.prototype.readInt32BE=function(t,r){return r||M(t,4,this.length),this[t]<<24|this[t+1]<<16|this[t+2]<<8|this[t+3]},f.prototype.readFloatLE=function(t,r){return r||M(t,4,this.length),e.read(this,t,!0,23,4)},f.prototype.readFloatBE=function(t,r){return r||M(t,4,this.length),e.read(this,t,!1,23,4)},f.prototype.readDoubleLE=function(t,r){return r||M(t,8,this.length),e.read(this,t,!0,52,8)},f.prototype.readDoubleBE=function(t,r){return r||M(t,8,this.length),e.read(this,t,!1,52,8)},f.prototype.writeUIntLE=function(t,r,e,n){(t=+t,r|=0,e|=0,n)||k(this,t,r,e,Math.pow(2,8*e)-1,0);var i=1,o=0;for(this[r]=255&t;++o<e&&(i*=256);)this[r+o]=t/i&255;return r+e},f.prototype.writeUIntBE=function(t,r,e,n){(t=+t,r|=0,e|=0,n)||k(this,t,r,e,Math.pow(2,8*e)-1,0);var i=e-1,o=1;for(this[r+i]=255&t;--i>=0&&(o*=256);)this[r+i]=t/o&255;return r+e},f.prototype.writeUInt8=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,1,255,0),f.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),this[r]=255&t,r+1},f.prototype.writeUInt16LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,65535,0),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):N(this,t,r,!0),r+2},f.prototype.writeUInt16BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,65535,0),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):N(this,t,r,!1),r+2},f.prototype.writeUInt32LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,4294967295,0),f.TYPED_ARRAY_SUPPORT?(this[r+3]=t>>>24,this[r+2]=t>>>16,this[r+1]=t>>>8,this[r]=255&t):z(this,t,r,!0),r+4},f.prototype.writeUInt32BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,4294967295,0),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):z(this,t,r,!1),r+4},f.prototype.writeIntLE=function(t,r,e,n){if(t=+t,r|=0,!n){var i=Math.pow(2,8*e-1);k(this,t,r,e,i-1,-i)}var o=0,u=1,f=0;for(this[r]=255&t;++o<e&&(u*=256);)t<0&&0===f&&0!==this[r+o-1]&&(f=1),this[r+o]=(t/u>>0)-f&255;return r+e},f.prototype.writeIntBE=function(t,r,e,n){if(t=+t,r|=0,!n){var i=Math.pow(2,8*e-1);k(this,t,r,e,i-1,-i)}var o=e-1,u=1,f=0;for(this[r+o]=255&t;--o>=0&&(u*=256);)t<0&&0===f&&0!==this[r+o+1]&&(f=1),this[r+o]=(t/u>>0)-f&255;return r+e},f.prototype.writeInt8=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,1,127,-128),f.TYPED_ARRAY_SUPPORT||(t=Math.floor(t)),t<0&&(t=255+t+1),this[r]=255&t,r+1},f.prototype.writeInt16LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,32767,-32768),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8):N(this,t,r,!0),r+2},f.prototype.writeInt16BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,2,32767,-32768),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>8,this[r+1]=255&t):N(this,t,r,!1),r+2},f.prototype.writeInt32LE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,2147483647,-2147483648),f.TYPED_ARRAY_SUPPORT?(this[r]=255&t,this[r+1]=t>>>8,this[r+2]=t>>>16,this[r+3]=t>>>24):z(this,t,r,!0),r+4},f.prototype.writeInt32BE=function(t,r,e){return t=+t,r|=0,e||k(this,t,r,4,2147483647,-2147483648),t<0&&(t=4294967295+t+1),f.TYPED_ARRAY_SUPPORT?(this[r]=t>>>24,this[r+1]=t>>>16,this[r+2]=t>>>8,this[r+3]=255&t):z(this,t,r,!1),r+4},f.prototype.writeFloatLE=function(t,r,e){return j(this,t,r,!0,e)},f.prototype.writeFloatBE=function(t,r,e){return j(this,t,r,!1,e)},f.prototype.writeDoubleLE=function(t,r,e){return q(this,t,r,!0,e)},f.prototype.writeDoubleBE=function(t,r,e){return q(this,t,r,!1,e)},f.prototype.copy=function(t,r,e,n){if(e||(e=0),n||0===n||(n=this.length),r>=t.length&&(r=t.length),r||(r=0),n>0&&n<e&&(n=e),n===e)return 0;if(0===t.length||0===this.length)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(e<0||e>=this.length)throw new RangeError("sourceStart out of bounds");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),t.length-r<n-e&&(n=t.length-r+e);var i,o=n-e;if(this===t&&e<r&&r<n)for(i=o-1;i>=0;--i)t[i+r]=this[i+e];else if(o<1e3||!f.TYPED_ARRAY_SUPPORT)for(i=0;i<o;++i)t[i+r]=this[i+e];else Uint8Array.prototype.set.call(t,this.subarray(e,e+o),r);return o},f.prototype.fill=function(t,r,e,n){if("string"==typeof t){if("string"==typeof r?(n=r,r=0,e=this.length):"string"==typeof e&&(n=e,e=this.length),1===t.length){var i=t.charCodeAt(0);i<256&&(t=i)}if(void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!f.isEncoding(n))throw new TypeError("Unknown encoding: "+n)}else"number"==typeof t&&(t&=255);if(r<0||this.length<r||this.length<e)throw new RangeError("Out of range index");if(e<=r)return this;var o;if(r>>>=0,e=void 0===e?this.length:e>>>0,t||(t=0),"number"==typeof t)for(o=r;o<e;++o)this[o]=t;else{var u=f.isBuffer(t)?t:$(new f(t,n).toString()),s=u.length;for(o=0;o<e-r;++o)this[o+r]=u[o%s]}return this};var V=/[^+\/0-9A-Za-z-_]/g;function X(t){if((t=J(t).replace(V,"")).length<2)return"";for(;t.length%4!=0;)t+="=";return t}function J(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}function Z(t){return t<16?"0"+t.toString(16):t.toString(16)}function $(t,r){var e;r=r||1/0;for(var n=t.length,i=null,o=[],u=0;u<n;++u){if((e=t.charCodeAt(u))>55295&&e<57344){if(!i){if(e>56319){(r-=3)>-1&&o.push(239,191,189);continue}if(u+1===n){(r-=3)>-1&&o.push(239,191,189);continue}i=e;continue}if(e<56320){(r-=3)>-1&&o.push(239,191,189),i=e;continue}e=65536+(i-55296<<10|e-56320)}else i&&(r-=3)>-1&&o.push(239,191,189);if(i=null,e<128){if((r-=1)<0)break;o.push(e)}else if(e<2048){if((r-=2)<0)break;o.push(e>>6|192,63&e|128)}else if(e<65536){if((r-=3)<0)break;o.push(e>>12|224,e>>6&63|128,63&e|128)}else{if(!(e<1114112))throw new Error("Invalid code point");if((r-=4)<0)break;o.push(e>>18|240,e>>12&63|128,e>>6&63|128,63&e|128)}}return o}function G(t){for(var r=[],e=0;e<t.length;++e)r.push(255&t.charCodeAt(e));return r}function H(t,r){for(var e,n,i,o=[],u=0;u<t.length&&!((r-=2)<0);++u)n=(e=t.charCodeAt(u))>>8,i=e%256,o.push(i),o.push(n);return o}function K(t){return r.toByteArray(X(t))}function Q(t,r,e,n){for(var i=0;i<n&&!(i+e>=r.length||i>=t.length);++i)r[i+e]=t[i];return i}function W(t){return t!=t}
},{"base64-js":"yh9p","ieee754":"JgNJ","isarray":"REa7","buffer":"dskh"}],"QO4x":[function(require,module,exports) {
var Buffer = require("buffer").Buffer;
var global = arguments[3];
var t=require("buffer").Buffer,e=arguments[3],r=require("../constants.js").FILE_SYSTEM_NAME,n=require("../constants.js").FILE_STORE_NAME,o=require("../constants.js").IDB_RW,u=require("../constants.js").IDB_RO;function c(t,e){this.db=t,this.mode=e}function i(t){this.name=t||r,this.db=null}c.prototype._getObjectStore=function(){if(this.objectStore)return this.objectStore;var t=this.db.transaction(n,this.mode);return this.objectStore=t.objectStore(n),this.objectStore},c.prototype.clear=function(t){try{var e=this._getObjectStore().clear();e.onsuccess=function(){t()},e.onerror=function(e){e.preventDefault(),t(e.error)}}catch(r){t(r)}},c.prototype._get=function(t,e){try{var r=this._getObjectStore().get(t);r.onsuccess=function(t){var r=t.target.result;e(null,r)},r.onerror=function(t){t.preventDefault(),e(t.error)}}catch(n){e(n)}},c.prototype.getObject=function(t,e){this._get(t,e)},c.prototype.getBuffer=function(e,r){this._get(e,function(e,n){if(e)return r(e);r(null,t.from(n))})},c.prototype._put=function(t,e,r){try{var n=this._getObjectStore().put(e,t);n.onsuccess=function(t){var e=t.target.result;r(null,e)},n.onerror=function(t){t.preventDefault(),r(t.error)}}catch(o){r(o)}},c.prototype.putObject=function(t,e,r){this._put(t,e,r)},c.prototype.putBuffer=function(t,e,r){var n=e.buffer;this._put(t,n,r)},c.prototype.delete=function(t,e){try{var r=this._getObjectStore().delete(t);r.onsuccess=function(t){var r=t.target.result;e(null,r)},r.onerror=function(t){t.preventDefault(),e(t.error)}}catch(n){e(n)}},i.isSupported=function(){return!!(e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB)},i.prototype.open=function(t){var r=this;if(r.db)return t();try{var o=(e.indexedDB||e.mozIndexedDB||e.webkitIndexedDB||e.msIndexedDB).open(r.name);o.onupgradeneeded=function(t){var e=t.target.result;e.objectStoreNames.contains(n)&&e.deleteObjectStore(n),e.createObjectStore(n)},o.onsuccess=function(e){r.db=e.target.result,t()},o.onerror=function(e){e.preventDefault(),t(e.error)}}catch(u){t(u)}},i.prototype.getReadOnlyContext=function(){return new c(this.db,u)},i.prototype.getReadWriteContext=function(){return new c(this.db,o)},module.exports=i;
},{"../constants.js":"iJA9","buffer":"dskh"}],"u4Zs":[function(require,module,exports) {
var process = require("process");
var define;
var e,t=require("process");!function(){var n={};void 0!==t&&t.nextTick?(n.nextTick=t.nextTick,"undefined"!=typeof setImmediate?n.setImmediate=function(e){setImmediate(e)}:n.setImmediate=n.nextTick):"function"==typeof setImmediate?(n.nextTick=function(e){setImmediate(e)},n.setImmediate=n.nextTick):(n.nextTick=function(e){setTimeout(e,0)},n.setImmediate=n.nextTick),n.eachSeries=function(e,t,n){if(n=n||function(){},!e.length)return n();var i=0;!function o(){t(e[i],function(t){t?(n(t),n=function(){}):(i+=1)>=e.length?n():o()})}()},n.forEachSeries=n.eachSeries,void 0!==e&&e.amd?e([],function(){return n}):"undefined"!=typeof module&&module.exports?module.exports=n:root.async=n}();
},{"process":"pBGv"}],"OWym":[function(require,module,exports) {
var t=require("../constants.js").FILE_SYSTEM_NAME,e=require("../../lib/async.js").setImmediate,o=function(){var t={};return function(e){return Object.prototype.hasOwnProperty.call(t,e)||(t[e]={}),t[e]}}();function n(t,e){this.readOnly=e,this.objectStore=t}function r(e){this.name=e||t}n.prototype.clear=function(t){if(this.readOnly)e(function(){t("[MemoryContext] Error: write operation on read only context")});else{var o=this.objectStore;Object.keys(o).forEach(function(t){delete o[t]}),e(t)}},n.prototype.getObject=n.prototype.getBuffer=function(t,o){var n=this;e(function(){o(null,n.objectStore[t])})},n.prototype.putObject=n.prototype.putBuffer=function(t,o,n){this.readOnly?e(function(){n("[MemoryContext] Error: write operation on read only context")}):(this.objectStore[t]=o,e(n))},n.prototype.delete=function(t,o){this.readOnly?e(function(){o("[MemoryContext] Error: write operation on read only context")}):(delete this.objectStore[t],e(o))},r.isSupported=function(){return!0},r.prototype.open=function(t){this.db=o(this.name),e(t)},r.prototype.getReadOnlyContext=function(){return new n(this.db,!0)},r.prototype.getReadWriteContext=function(){return new n(this.db,!1)},module.exports=r;
},{"../constants.js":"iJA9","../../lib/async.js":"u4Zs"}],"AiW7":[function(require,module,exports) {
var e=require("./indexeddb.js"),r=require("./memory.js");module.exports={IndexedDB:e,Default:e,Memory:r};
},{"./indexeddb.js":"QO4x","./memory.js":"OWym"}],"p8GN":[function(require,module,exports) {
var t={};["3:EACCES:permission denied","9:EBADF:bad file descriptor","10:EBUSY:resource busy or locked","18:EINVAL:invalid argument","27:ENOTDIR:not a directory","28:EISDIR:illegal operation on a directory","34:ENOENT:no such file or directory","47:EEXIST:file already exists","50:EPERM:operation not permitted","51:ELOOP:too many symbolic links encountered","53:ENOTEMPTY:directory not empty","55:EIO:i/o error","1000:ENOTMOUNTED:not mounted","1001:EFILESYSTEMERROR:missing super node, use 'FORMAT' flag to format filesystem.","1002:ENOATTR:attribute does not exist"].forEach(function(e){var o=+(e=e.split(":"))[0],r=e[1],i=e[2];function s(t,e){Error.call(this),this.name=r,this.code=r,this.errno=o,this.message=t||i,e&&(this.path=e),this.stack=new Error(this.message).stack}s.prototype=Object.create(Error.prototype),s.prototype.constructor=s,s.prototype.toString=function(){var t=this.path?", '"+this.path+"'":"";return this.name+": "+this.message+t},t[r]=t[o]=s}),module.exports=t;
},{}],"QMiB":[function(require,module,exports) {
"use strict";var t=require("../constants.js").ENVIRONMENT;module.exports=function(n){(n=n||{}).TMP=n.TMP||t.TMP,n.PATH=n.PATH||t.PATH,this.get=function(t){return n[t]},this.set=function(t,s){n[t]=s}};
},{"../constants.js":"iJA9"}],"bQx9":[function(require,module,exports) {
module.exports=function(t,o){for(var a=[],e=0;e<t.length;e++){var n=o(t[e],e);r(n)?a.push.apply(a,n):a.push(n)}return a};var r=Array.isArray||function(r){return"[object Array]"===Object.prototype.toString.call(r)};
},{}],"D9yG":[function(require,module,exports) {
"use strict";function e(e,r,i){e instanceof RegExp&&(e=n(e,i)),r instanceof RegExp&&(r=n(r,i));var o=t(e,r,i);return o&&{start:o[0],end:o[1],pre:i.slice(0,o[0]),body:i.slice(o[0]+e.length,o[1]),post:i.slice(o[1]+r.length)}}function n(e,n){var t=n.match(e);return t?t[0]:null}function t(e,n,t){var r,i,o,f,l,s=t.indexOf(e),c=t.indexOf(n,s+1),p=s;if(s>=0&&c>0){for(r=[],o=t.length;p>=0&&!l;)p==s?(r.push(p),s=t.indexOf(e,p+1)):1==r.length?l=[r.pop(),c]:((i=r.pop())<o&&(o=i,f=c),c=t.indexOf(n,p+1)),p=s<c&&s>=0?s:c;r.length&&(l=[o,f])}return l}module.exports=e,e.range=t;
},{}],"dwXQ":[function(require,module,exports) {
var t=require("concat-map"),r=require("balanced-match");module.exports=f;var n="\0SLASH"+Math.random()+"\0",e="\0OPEN"+Math.random()+"\0",i="\0CLOSE"+Math.random()+"\0",o="\0COMMA"+Math.random()+"\0",a="\0PERIOD"+Math.random()+"\0";function s(t){return parseInt(t,10)==t?parseInt(t,10):t.charCodeAt(0)}function p(t){return t.split("\\\\").join(n).split("\\{").join(e).split("\\}").join(i).split("\\,").join(o).split("\\.").join(a)}function u(t){return t.split(n).join("\\").split(e).join("{").split(i).join("}").split(o).join(",").split(a).join(".")}function l(t){if(!t)return[""];var n=[],e=r("{","}",t);if(!e)return t.split(",");var i=e.pre,o=e.body,a=e.post,s=i.split(",");s[s.length-1]+="{"+o+"}";var p=l(a);return a.length&&(s[s.length-1]+=p.shift(),s.push.apply(s,p)),n.push.apply(n,s),n}function f(t){return t?("{}"===t.substr(0,2)&&(t="\\{\\}"+t.substr(2)),m(p(t),!0).map(u)):[]}function h(t){return t}function d(t){return"{"+t+"}"}function c(t){return/^-?0\d/.test(t)}function v(t,r){return t<=r}function g(t,r){return t>=r}function m(n,e){var o=[],a=r("{","}",n);if(!a||/\$$/.test(a.pre))return[n];var p,u=/^-?\d+\.\.-?\d+(?:\.\.-?\d+)?$/.test(a.body),f=/^[a-zA-Z]\.\.[a-zA-Z](?:\.\.-?\d+)?$/.test(a.body),h=u||f,b=a.body.indexOf(",")>=0;if(!h&&!b)return a.post.match(/,.*\}/)?m(n=a.pre+"{"+a.body+i+a.post):[n];if(h)p=a.body.split(/\.\./);else if(1===(p=l(a.body)).length&&1===(p=m(p[0],!1).map(d)).length)return(M=a.post.length?m(a.post,!1):[""]).map(function(t){return a.pre+p[0]+t});var j,y=a.pre,M=a.post.length?m(a.post,!1):[""];if(h){var A=s(p[0]),C=s(p[1]),O=Math.max(p[0].length,p[1].length),S=3==p.length?Math.abs(s(p[2])):1,$=v;C<A&&(S*=-1,$=g);var x=p.some(c);j=[];for(var E=A;$(E,C);E+=S){var I;if(f)"\\"===(I=String.fromCharCode(E))&&(I="");else if(I=String(E),x){var q=O-I.length;if(q>0){var z=new Array(q+1).join("0");I=E<0?"-"+z+I.slice(1):z+I}}j.push(I)}}else j=t(p,function(t){return m(t,!1)});for(var L=0;L<j.length;L++)for(var P=0;P<M.length;P++){var Z=y+j[L]+M[P];(!e||h||Z)&&o.push(Z)}return o}
},{"concat-map":"bQx9","balanced-match":"D9yG"}],"NtKi":[function(require,module,exports) {
module.exports=g,g.Minimatch=l;var t={sep:"/"};try{t=require("path")}catch(O){}var e=g.GLOBSTAR=l.GLOBSTAR={},n=require("brace-expansion"),r={"!":{open:"(?:(?!(?:",close:"))[^/]*?)"},"?":{open:"(?:",close:")?"},"+":{open:"(?:",close:")+"},"*":{open:"(?:",close:")*"},"@":{open:"(?:",close:")"}},i="[^/]",s=i+"*?",a="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",o="(?:(?!(?:\\/|^)\\.).)*?",h=c("().*{}+?[]^$\\!");function c(t){return t.split("").reduce(function(t,e){return t[e]=!0,t},{})}var u=/\/+/;function p(t,e){return e=e||{},function(n,r,i){return g(n,t,e)}}function f(t,e){t=t||{},e=e||{};var n={};return Object.keys(e).forEach(function(t){n[t]=e[t]}),Object.keys(t).forEach(function(e){n[e]=t[e]}),n}function g(t,e,n){if("string"!=typeof e)throw new TypeError("glob pattern string required");return n||(n={}),!(!n.nocomment&&"#"===e.charAt(0))&&(""===e.trim()?""===t:new l(e,n).match(t))}function l(e,n){if(!(this instanceof l))return new l(e,n);if("string"!=typeof e)throw new TypeError("glob pattern string required");n||(n={}),e=e.trim(),"/"!==t.sep&&(e=e.split(t.sep).join("/")),this.options=n,this.set=[],this.pattern=e,this.regexp=null,this.negate=!1,this.comment=!1,this.empty=!1,this.make()}function d(){if(!this._made){var t=this.pattern,e=this.options;if(e.nocomment||"#"!==t.charAt(0))if(t){this.parseNegate();var n=this.globSet=this.braceExpand();e.debug&&(this.debug=console.error),this.debug(this.pattern,n),n=this.globParts=n.map(function(t){return t.split(u)}),this.debug(this.pattern,n),n=n.map(function(t,e,n){return t.map(this.parse,this)},this),this.debug(this.pattern,n),n=n.filter(function(t){return-1===t.indexOf(!1)}),this.debug(this.pattern,n),this.set=n}else this.empty=!0;else this.comment=!0}}function b(){var t=this.pattern,e=!1,n=0;if(!this.options.nonegate){for(var r=0,i=t.length;r<i&&"!"===t.charAt(r);r++)e=!e,n++;n&&(this.pattern=t.substr(n)),this.negate=e}}function m(t,e){if(e||(e=this instanceof l?this.options:{}),void 0===(t=void 0===t?this.pattern:t))throw new TypeError("undefined pattern");return e.nobrace||!t.match(/\{.*\}/)?[t]:n(t)}g.filter=p,g.defaults=function(t){if(!t||!Object.keys(t).length)return g;var e=g,n=function(n,r,i){return e.minimatch(n,r,f(t,i))};return n.Minimatch=function(n,r){return new e.Minimatch(n,f(t,r))},n},l.defaults=function(t){return t&&Object.keys(t).length?g.defaults(t).Minimatch:l},l.prototype.debug=function(){},l.prototype.make=d,l.prototype.parseNegate=b,g.braceExpand=function(t,e){return m(t,e)},l.prototype.braceExpand=m,l.prototype.parse=y;var v={};function y(t,n){if(t.length>65536)throw new TypeError("pattern is too long");var a=this.options;if(!a.noglobstar&&"**"===t)return e;if(""===t)return"";var o,c="",u=!!a.nocase,p=!1,f=[],g=[],l=!1,d=-1,b=-1,m="."===t.charAt(0)?"":a.dot?"(?!(?:^|\\/)\\.{1,2}(?:$|\\/))":"(?!\\.)",y=this;function w(){if(o){switch(o){case"*":c+=s,u=!0;break;case"?":c+=i,u=!0;break;default:c+="\\"+o}y.debug("clearStateChar %j %j",o,c),o=!1}}for(var x,j=0,k=t.length;j<k&&(x=t.charAt(j));j++)if(this.debug("%s\t%s %s %j",t,j,c,x),p&&h[x])c+="\\"+x,p=!1;else switch(x){case"/":return!1;case"\\":w(),p=!0;continue;case"?":case"*":case"+":case"@":case"!":if(this.debug("%s\t%s %s %j <-- stateChar",t,j,c,x),l){this.debug("  in class"),"!"===x&&j===b+1&&(x="^"),c+=x;continue}y.debug("call clearStateChar %j",o),w(),o=x,a.noext&&w();continue;case"(":if(l){c+="(";continue}if(!o){c+="\\(";continue}f.push({type:o,start:j-1,reStart:c.length,open:r[o].open,close:r[o].close}),c+="!"===o?"(?:(?!(?:":"(?:",this.debug("plType %j %j",o,c),o=!1;continue;case")":if(l||!f.length){c+="\\)";continue}w(),u=!0;var A=f.pop();c+=A.close,"!"===A.type&&g.push(A),A.reEnd=c.length;continue;case"|":if(l||!f.length||p){c+="\\|",p=!1;continue}w(),c+="|";continue;case"[":if(w(),l){c+="\\"+x;continue}l=!0,b=j,d=c.length,c+=x;continue;case"]":if(j===b+1||!l){c+="\\"+x,p=!1;continue}if(l){var S=t.substring(b+1,j);try{RegExp("["+S+"]")}catch(O){var $=this.parse(S,v);c=c.substr(0,d)+"\\["+$[0]+"\\]",u=u||$[1],l=!1;continue}}u=!0,l=!1,c+=x;continue;default:w(),p?p=!1:!h[x]||"^"===x&&l||(c+="\\"),c+=x}for(l&&(S=t.substr(b+1),$=this.parse(S,v),c=c.substr(0,d)+"\\["+$[0],u=u||$[1]),A=f.pop();A;A=f.pop()){var R=c.slice(A.reStart+A.open.length);this.debug("setting tail",c,A),R=R.replace(/((?:\\{2}){0,64})(\\?)\|/g,function(t,e,n){return n||(n="\\"),e+e+n+"|"}),this.debug("tail=%j\n   %s",R,R,A,c);var T="*"===A.type?s:"?"===A.type?i:"\\"+A.type;u=!0,c=c.slice(0,A.reStart)+T+"\\("+R}w(),p&&(c+="\\\\");var C=!1;switch(c.charAt(0)){case".":case"[":case"(":C=!0}for(var L=g.length-1;L>-1;L--){var q=g[L],B=c.slice(0,q.reStart),M=c.slice(q.reStart,q.reEnd-8),N=c.slice(q.reEnd-8,q.reEnd),_=c.slice(q.reEnd);N+=_;var G=B.split("(").length-1,P=_;for(j=0;j<G;j++)P=P.replace(/\)[+*?]?/,"");var z="";""===(_=P)&&n!==v&&(z="$"),c=B+M+_+z+N}if(""!==c&&u&&(c="(?=.)"+c),C&&(c=m+c),n===v)return[c,u];if(!u)return E(t);var D=a.nocase?"i":"";try{var F=new RegExp("^"+c+"$",D)}catch(O){return new RegExp("$.")}return F._glob=t,F._src=c,F}function w(){if(this.regexp||!1===this.regexp)return this.regexp;var t=this.set;if(!t.length)return this.regexp=!1,this.regexp;var n=this.options,r=n.noglobstar?s:n.dot?a:o,i=n.nocase?"i":"",h=t.map(function(t){return t.map(function(t){return t===e?r:"string"==typeof t?j(t):t._src}).join("\\/")}).join("|");h="^(?:"+h+")$",this.negate&&(h="^(?!"+h+").*$");try{this.regexp=new RegExp(h,i)}catch(c){this.regexp=!1}return this.regexp}function x(e,n){if(this.debug("match",e,this.pattern),this.comment)return!1;if(this.empty)return""===e;if("/"===e&&n)return!0;var r=this.options;"/"!==t.sep&&(e=e.split(t.sep).join("/")),e=e.split(u),this.debug(this.pattern,"split",e);var i,s,a=this.set;for(this.debug(this.pattern,"set",a),s=e.length-1;s>=0&&!(i=e[s]);s--);for(s=0;s<a.length;s++){var o=a[s],h=e;if(r.matchBase&&1===o.length&&(h=[i]),this.matchOne(h,o,n))return!!r.flipNegate||!this.negate}return!r.flipNegate&&this.negate}function E(t){return t.replace(/\\(.)/g,"$1")}function j(t){return t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}g.makeRe=function(t,e){return new l(t,e||{}).makeRe()},l.prototype.makeRe=w,g.match=function(t,e,n){var r=new l(e,n=n||{});return t=t.filter(function(t){return r.match(t)}),r.options.nonull&&!t.length&&t.push(e),t},l.prototype.match=x,l.prototype.matchOne=function(t,n,r){var i=this.options;this.debug("matchOne",{this:this,file:t,pattern:n}),this.debug("matchOne",t.length,n.length);for(var s=0,a=0,o=t.length,h=n.length;s<o&&a<h;s++,a++){this.debug("matchOne loop");var c,u=n[a],p=t[s];if(this.debug(n,u,p),!1===u)return!1;if(u===e){this.debug("GLOBSTAR",[n,u,p]);var f=s,g=a+1;if(g===h){for(this.debug("** at the end");s<o;s++)if("."===t[s]||".."===t[s]||!i.dot&&"."===t[s].charAt(0))return!1;return!0}for(;f<o;){var l=t[f];if(this.debug("\nglobstar while",t,f,n,g,l),this.matchOne(t.slice(f),n.slice(g),r))return this.debug("globstar found match!",f,o,l),!0;if("."===l||".."===l||!i.dot&&"."===l.charAt(0)){this.debug("dot detected!",t,f,n,g);break}this.debug("globstar swallow a segment, and continue"),f++}return!(!r||(this.debug("\n>>> no match, partial?",t,f,n,g),f!==o))}if("string"==typeof u?(c=i.nocase?p.toLowerCase()===u.toLowerCase():p===u,this.debug("string match",u,p,c)):(c=p.match(u),this.debug("pattern match",u,p,c)),!c)return!1}if(s===o&&a===h)return!0;if(s===o)return r;if(a===h)return s===o-1&&""===t[s];throw new Error("wtf?")};
},{"path":"UUq2","brace-expansion":"dwXQ"}],"D1Ra":[function(require,module,exports) {
var n=require("es6-promisify"),t=n.promisify,e=require("../path.js"),i=require("../errors.js"),r=require("./environment.js"),o=require("../../lib/async.js"),u=require("minimatch");function c(n,o){var u=this,c=new r((o=o||{}).env),f="/";Object.defineProperty(this,"fs",{get:function(){return n},enumerable:!0}),Object.defineProperty(this,"env",{get:function(){return c},enumerable:!0}),this.cd=function(t,r){t=e.resolve(f,t),n.stat(t,function(n,e){n?r(new i.ENOTDIR(null,t)):"DIRECTORY"===e.type?(f=t,r()):r(new i.ENOTDIR(null,t))})},this.pwd=function(){return f},this.promises={},["cd","exec","touch","cat","ls","rm","tempDir","mkdirp","find"].forEach(function(n){u.promises[n]=t(u[n].bind(u))})}c.prototype.exec=function(n,t,i){var r=this.fs;"function"==typeof t&&(i=t,t=[]),t=t||[],i=i||function(){},n=e.resolve(this.pwd(),n),r.readFile(n,"utf8",function(n,e){if(n)i(n);else try{new Function("fs","args","callback",e)(r,t,i)}catch(o){i(o)}})},c.prototype.touch=function(n,t,i){var r=this.fs;"function"==typeof t&&(i=t,t={}),t=t||{},i=i||function(){},n=e.resolve(this.pwd(),n),r.stat(n,function(e){e?!0===t.updateOnly?i():function(n){r.writeFile(n,"",i)}(n):function(n){var e=Date.now(),o=t.date||e,u=t.date||e;r.utimes(n,o,u,i)}(n)})},c.prototype.cat=function(n,t){var r=this,u=r.fs,c="";t=t||function(){},n?(n="string"==typeof n?[n]:n,o.eachSeries(n,function(n,t){var i=e.resolve(r.pwd(),n);u.readFile(i,"utf8",function(n,e){n?t(n):(c+=e+"\n",t())})},function(n){n?t(n):t(null,c.replace(/\n$/,""))})):t(new i.EINVAL("Missing files argument"))},c.prototype.ls=function(n,t,r){var u=this,c=u.fs;"function"==typeof t&&(r=t,t={}),t=t||{},r=r||function(){},n?function n(i,r){var f=e.resolve(u.pwd(),i),s=[];c.readdir(f,function(i,u){i?r(i):o.eachSeries(u,function(i,r){i=e.join(f,i),c.stat(i,function(i,o){if(i)r(i);else{var u=o;t.recursive&&"DIRECTORY"===o.type?n(e.join(f,u.name),function(n,t){n?r(n):(u.contents=t,s.push(u),r())}):(s.push(u),r())}})},function(n){r(n,s)})})}(n,r):r(new i.EINVAL("Missing dir argument"))},c.prototype.rm=function(n,t,r){var u=this,c=u.fs;"function"==typeof t&&(r=t,t={}),t=t||{},r=r||function(){},n?function n(r,f){r=e.resolve(u.pwd(),r),c.stat(r,function(u,s){u?f(u):"FILE"!==s.type?c.readdir(r,function(u,s){u?f(u):0!==s.length?t.recursive?(s=s.map(function(n){return e.join(r,n)}),o.eachSeries(s,n,function(n){n?f(n):c.rmdir(r,f)})):f(new i.ENOTEMPTY(null,r)):c.rmdir(r,f)}):c.unlink(r,f)})}(n,r):r(new i.EINVAL("Missing path argument"))},c.prototype.tempDir=function(n){var t=this.fs,e=this.env.get("TMP");n=n||function(){},t.mkdir(e,function(){n(null,e)})},c.prototype.mkdirp=function(n,t){var r=this.fs;t=t||function(){},n?"/"!==(n=e.resolve(this.pwd(),n))?function n(t,o){r.stat(t,function(u,c){if(c){if(c.isDirectory())return void o();if(c.isFile())return void o(new i.ENOTDIR(null,t))}else{if(u&&"ENOENT"!==u.code)return void o(u);var f=e.dirname(t);"/"===f?r.mkdir(t,function(n){n&&"EEXIST"!==n.code?o(n):o()}):n(f,function(n){if(n)return o(n);r.mkdir(t,function(n){n&&"EEXIST"!==n.code?o(n):o()})})}})}(n,t):t():t(new i.EINVAL("Missing path argument"))},c.prototype.find=function(n,t,r){var c=this,f=c.fs;"function"==typeof t&&(r=t,t={}),r=r||function(){};var s=(t=t||{}).exec||function(n,t){t()},a=[];function p(n,i){var r=e.removeTrailing(n);!t.regex||t.regex.test(r)?t.name&&!u(e.basename(r),t.name)||t.path&&!u(e.dirname(r),t.path)?i():function(n,t){s(n,function(e){e?t(e):(a.push(n),t())})}(n,i):i()}function d(n,t){n=e.resolve(c.pwd(),n),f.readdir(n,function(i,r){i?"ENOTDIR"===i.code?p(n,t):t(i):p(e.addTrailing(n),function(i){i?t(i):(r=r.map(function(t){return e.join(n,t)}),o.eachSeries(r,d,function(n){t(n,a)}))})})}n?f.stat(n,function(t,e){t?r(t):e.isDirectory()?d(n,r):r(new i.ENOTDIR(null,n))}):r(new i.EINVAL("Missing path argument"))},module.exports=c;
},{"es6-promisify":"c0Ea","../path.js":"UzoP","../errors.js":"p8GN","./environment.js":"QMiB","../../lib/async.js":"u4Zs","minimatch":"NtKi"}],"J4Qg":[function(require,module,exports) {
function t(t,r){for(var o=r.length-1;o>=0;o--)r[o]===t&&r.splice(o,1);return r}var r=function(){};r.createInterface=function(r){var o={on:function(t,o){void 0===this[r]&&(this[r]={}),this[r].hasOwnProperty(t)||(this[r][t]=[]),this[r][t].push(o)},off:function(o,e){void 0!==this[r]&&this[r].hasOwnProperty(o)&&t(e,this[r][o])},trigger:function(t){if(void 0!==this[r]&&this[r].hasOwnProperty(t))for(var o=Array.prototype.slice.call(arguments,1),e=0;e<this[r][t].length;e++)this[r][t][e].apply(this[r][t][e],o)},removeAllListeners:function(t){if(void 0!==this[r]){var o=this;o[r][t].forEach(function(r){o.off(t,r)})}}};return o};var o=r.createInterface("_handlers");r.prototype._on=o.on,r.prototype._off=o.off,r.prototype._trigger=o.trigger;var e=r.createInterface("handlers");r.prototype.on=function(){e.on.apply(this,arguments),Array.prototype.unshift.call(arguments,"on"),this._trigger.apply(this,arguments)},r.prototype.off=e.off,r.prototype.trigger=e.trigger,r.prototype.removeAllListeners=e.removeAllListeners,module.exports=r;
},{}],"zBMa":[function(require,module,exports) {
function x(x){return x.replace(/[xy]/g,function(x){var n=16*Math.random()|0;return("x"===x?n:3&n|8).toString(16)})}function n(){return x("xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx").toUpperCase()}function r(n){return x("x".repeat(n=n||6))}function t(){}module.exports={guid:n,nop:t,randomChars:r};
},{}],"u7Jv":[function(require,module,exports) {
var global = arguments[3];
var t=arguments[3];function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var n=require("./eventemitter.js"),o=require("../src/shared.js").guid;function r(t,e){var n=0;return function(){var o=Date.now();o-n>t&&(n=o,e.apply(this,arguments))}}function i(t,n){if(void 0!==t&&t||(t={}),"object"===e(n))for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o]);return t}var a=function(t){return void 0===t||void 0===t.localStorage?{getItem:function(){},setItem:function(){},removeItem:function(){}}:t.localStorage}(t);function s(){var e=this,n=Date.now();this.origin=o(),this.lastMessage=n,this.receivedIDs={},this.previousValues={};var r=function(){e._onStorageEvent.apply(e,arguments)};"undefined"!=typeof document&&(document.attachEvent?document.attachEvent("onstorage",r):t.addEventListener("storage",r,!1))}s.prototype._transaction=function(t){var e=1e3,n=20,o=this,r=!1,i=!1,s=null;function c(){if(!r){var u=Date.now(),f=0|a.getItem(p);if(f&&u-f<e)return i||(o._on("storage",c),i=!0),void(s=setTimeout(c,n));r=!0,a.setItem(p,u),t(),function(){i&&o._off("storage",c);s&&clearTimeout(s);a.removeItem(p)}()}}c()},s.prototype._cleanup_emit=r(100,function(){this._transaction(function(){var t,e=Date.now()-f,n=0;try{t=JSON.parse(a.getItem(c)||"[]")}catch(r){t=[]}for(var o=t.length-1;o>=0;o--)t[o].timestamp<e&&(t.splice(o,1),n++);n>0&&a.setItem(c,JSON.stringify(t))})}),s.prototype._cleanup_once=r(100,function(){var t=this;t._transaction(function(){Date.now();var e,n,o=0;try{n=JSON.parse(a.getItem(u)||"{}")}catch(r){n={}}for(e in n)t._once_expired(e,n)&&(delete n[e],o++);o>0&&a.setItem(u,JSON.stringify(n))})}),s.prototype._once_expired=function(t,n){if(!n)return!0;if(!n.hasOwnProperty(t))return!0;if("object"!==e(n[t]))return!0;var o=n[t].ttl||m,r=Date.now();return n[t].timestamp<r-o},s.prototype._localStorageChanged=function(t,e){if(t&&t.key)return t.key===e;var n=a.getItem(e);return n!==this.previousValues[e]&&(this.previousValues[e]=n,!0)},s.prototype._onStorageEvent=function(e){e=e||t.event;var n=this;this._localStorageChanged(e,c)&&this._transaction(function(){var t,e=Date.now(),o=a.getItem(c);try{t=JSON.parse(o||"[]")}catch(i){t=[]}for(var r=0;r<t.length;r++)if(t[r].origin!==n.origin&&!(t[r].timestamp<n.lastMessage)){if(t[r].id){if(n.receivedIDs.hasOwnProperty(t[r].id))continue;n.receivedIDs[t[r].id]=!0}n.trigger(t[r].name,t[r].payload)}n.lastMessage=e}),this._trigger("storage",e)},s.prototype._emit=function(t,e,n){if((n="string"==typeof n||"number"==typeof n?String(n):null)&&n.length){if(this.receivedIDs.hasOwnProperty(n))return;this.receivedIDs[n]=!0}var o={id:n,name:t,origin:this.origin,timestamp:Date.now(),payload:e},r=this;this._transaction(function(){var n=a.getItem(c)||"[]",i="[]"===n?"":",";n=[n.substring(0,n.length-1),i,JSON.stringify(o),"]"].join(""),a.setItem(c,n),r.trigger(t,e),setTimeout(function(){r._cleanup_emit()},50)})},s.prototype.emit=function(t,e){this._emit.apply(this,arguments),this._trigger("emit",t,e)},s.prototype.once=function(t,e,n){if(s.supported){var o=this;this._transaction(function(){var r;try{r=JSON.parse(a.getItem(u)||"{}")}catch(i){r={}}o._once_expired(t,r)&&(r[t]={},r[t].timestamp=Date.now(),"number"==typeof n&&(r[t].ttl=1e3*n),a.setItem(u,JSON.stringify(r)),e(),setTimeout(function(){o._cleanup_once()},50))})}},i(s.prototype,n.prototype),s.supported=void 0!==a;var c="intercom",u="intercom_once",p="intercom_lock",f=5e4,m=36e5;s.destroy=function(){a.removeItem(p),a.removeItem(c),a.removeItem(u)},s.getInstance=function(){var t;return function(){return t||(t=new s),t}}(),module.exports=s;
},{"./eventemitter.js":"J4Qg","../src/shared.js":"zBMa"}],"VLEe":[function(require,module,exports) {
var e=require("../lib/eventemitter.js"),t=require("./path.js"),n=require("../lib/intercom.js");function r(){e.call(this);var r,i,o=this,s=!1;function c(e){(i===e||s&&0===e.indexOf(r))&&o.trigger("change","change",e)}o.start=function(e,o,a){if(!i){if(t.isNull(e))throw new Error("Path must be a string without null bytes.");i=t.normalize(e),(s=!0===a)&&(r="/"===i?"/":i+"/"),n.getInstance().on("change",c)}},o.close=function(){n.getInstance().off("change",c),o.removeAllListeners("change")}}r.prototype=new e,r.prototype.constructor=r,module.exports=r;
},{"../lib/eventemitter.js":"J4Qg","./path.js":"UzoP","../lib/intercom.js":"u7Jv"}],"ZECt":[function(require,module,exports) {
var t=require("./constants.js").NODE_TYPE_FILE;module.exports=function(s,e){this.id=s,this.type=e||t};
},{"./constants.js":"iJA9"}],"osLK":[function(require,module,exports) {
var r=require("./constants"),e=r.FIRST_DESCRIPTOR,n={},t=function(){for(var r=e;o(r);)r++;return r},o=function(r){return n[r]},i=function(r){var e=t();return n[e]=r,e},u=function(r){return delete n[r]};module.exports={allocDescriptor:i,releaseDescriptor:u,getOpenFileDescription:o};
},{"./constants":"iJA9"}],"KKNo":[function(require,module,exports) {
function t(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function i(t,i){for(var s=0;s<i.length;s++){var e=i[s];e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(t,e.key,e)}}function s(t,s,e){return s&&i(t.prototype,s),e&&i(t,e),t}var e=require("./constants"),n=e.NODE_TYPE_FILE,r=e.NODE_TYPE_DIRECTORY,a=e.NODE_TYPE_SYMBOLIC_LINK,o=e.DEFAULT_FILE_PERMISSIONS,u=e.DEFAULT_DIR_PERMISSIONS,h=require("./constants").fsConstants,c=h.S_IFREG,f=h.S_IFDIR,m=h.S_IFLNK;function d(t,i,s){if(t[i])return s();t.guid(function(e,n){if(e)return s(e);t[i]=n,s()})}function l(t,i){switch(t){case r:return(i||u)|f;case a:return(i||o)|m;case n:default:return(i||o)|c}}var p=function(){function i(s){t(this,i);var e=Date.now();this.id=s.id,this.data=s.data,this.size=s.size||0,this.atime=s.atime||e,this.ctime=s.ctime||e,this.mtime=s.mtime||e,this.flags=s.flags||[],this.xattrs=s.xattrs||{},this.nlinks=s.nlinks||0,"string"==typeof s.type?this.type=s.type:"string"==typeof s.mode?this.type=s.mode:this.type=n,this.permissions=s.permissions||l(this.type),this.uid=s.uid||0,this.gid=s.gid||0}return s(i,[{key:"toJSON",value:function(){return{id:this.id,data:this.data,size:this.size,atime:this.atime,ctime:this.ctime,mtime:this.ctime,flags:this.flags,xattrs:this.xattrs,nlinks:this.nlinks,mode:this.type,permissions:this.permissions,uid:this.uid,gid:this.gid}}},{key:"mode",get:function(){return l(this.type,this.permissions)},set:function(t){this.permissions=t}}]),i}();module.exports.create=function(t,i){d(t,"id",function(s){if(s)return i(s);d(t,"data",function(s){if(s)return i(s);i(null,new p(t))})})};
},{"./constants":"iJA9"}],"XWaV":[function(require,module,exports) {
var e=require("./errors.js"),t=require("./node");function i(e,t,i,r){this.path=e,this.id=t,this.flags=i,this.position=r}i.prototype.getNode=function(i,r){var o=this.id,n=this.path;i.getObject(o,function(i,o){return i?r(i):o?void t.create(o,r):r(new e.EBADF("file descriptor refers to unknown node",n))})},module.exports=i;
},{"./errors.js":"p8GN","./node":"KKNo"}],"JEp0":[function(require,module,exports) {
var t=require("./constants.js");function e(e){var i=Date.now();this.id=t.SUPER_NODE_ID,this.type=t.NODE_TYPE_META,this.atime=e.atime||i,this.ctime=e.ctime||i,this.mtime=e.mtime||i,this.rnode=e.rnode}e.create=function(t,i){t.guid(function(n,o){n?i(n):(t.rnode=t.rnode||o,i(null,new e(t)))})},module.exports=e;
},{"./constants.js":"iJA9"}],"dsCT":[function(require,module,exports) {
"use strict";var t=require("./constants.js"),i=require("./path.js");function e(t){return new Date(Number(t))}function s(t,s,o){this.dev=o,this.node=s.id,this.type=s.type,this.size=s.size,this.nlinks=s.nlinks,this.atime=e(s.atime),this.mtime=e(s.mtime),this.ctime=e(s.ctime),this.atimeMs=s.atime,this.mtimeMs=s.mtime,this.ctimeMs=s.ctime,this.version=s.version,this.mode=s.mode,this.uid=s.uid,this.gid=s.gid,this.name=i.basename(t)}s.prototype.isFile=function(){return this.type===t.NODE_TYPE_FILE},s.prototype.isDirectory=function(){return this.type===t.NODE_TYPE_DIRECTORY},s.prototype.isSymbolicLink=function(){return this.type===t.NODE_TYPE_SYMBOLIC_LINK},s.prototype.isSocket=s.prototype.isFIFO=s.prototype.isCharacterDevice=s.prototype.isBlockDevice=function(){return!1},module.exports=s;
},{"./constants.js":"iJA9","./path.js":"UzoP"}],"bsBG":[function(require,module,exports) {
var Buffer = require("buffer").Buffer;
var e=require("buffer").Buffer;function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var n=require("../path.js"),i=n.normalize,o=n.dirname,r=n.basename,u=n.isAbsolute,a=require("../shared.js"),c=require("../constants.js"),f=c.NODE_TYPE_FILE,l=c.NODE_TYPE_DIRECTORY,s=c.NODE_TYPE_SYMBOLIC_LINK,p=c.NODE_TYPE_META,d=c.FULL_READ_WRITE_EXEC_PERMISSIONS,m=c.ROOT_DIRECTORY_NAME,E=c.SUPER_NODE_ID,g=c.SYMLOOP_MAX,w=c.O_READ,O=c.O_WRITE,b=c.O_CREATE,y=c.O_EXCLUSIVE,v=c.O_APPEND,N=c.O_FLAGS,I=c.XATTR_CREATE,h=c.XATTR_REPLACE,A=c.FS_NOMTIME,D=c.FS_NOCTIME,j=require("../errors.js"),T=require("../directory-entry.js"),L=require("../open-files.js"),R=require("../open-file-description.js"),_=require("../super-node.js"),F=require("../node.js"),V=require("../stats.js");function S(e,t,n,i,o){var r=e.flags;r.includes(D)&&delete i.ctime,r.includes(A)&&delete i.mtime;var u=!1;function a(n){e.changes.push({event:"change",path:t}),o(n)}i.ctime&&(n.ctime=i.ctime,n.atime=i.ctime,u=!0),i.atime&&(n.atime=i.atime,u=!0),i.mtime&&(n.mtime=i.mtime,u=!0),u?e.putObject(n.id,n,a):a()}function B(e,t,n,u){if(n!==l&&n!==f)return u(new j.EINVAL("type must be a directory or file",t));t=i(t);var a,c,s,p=r(t),d=o(t);function m(n,i){!n&&i?u(new j.EEXIST("path name already exists",t)):!n||n instanceof j.ENOENT?e.getObject(a.data,E):u(n)}function E(t,i){t?u(t):(c=i,F.create({guid:e.guid,type:n},function(t,n){t?u(t):((s=n).nlinks+=1,e.putObject(s.id,s,w))}))}function g(t){if(t)u(t);else{var n=Date.now();S(e,d,s,{mtime:n,ctime:n},u)}}function w(t){t?u(t):(c[p]=new T(s.id,n),e.putObject(a.data,c,g))}P(e,d,function(n,i){n?u(n):i.type!==l?u(new j.ENOTDIR("a component of the path prefix is not a directory",t)):(a=i,P(e,t,m))})}function P(e,t,n){if(!(t=i(t)))return n(new j.ENOENT("path is an empty string"));var u=r(t),a=o(t),c=0;function f(t,i){if(t)return n(t);var o=new _(i);o&&o.type===p&&o.rnode?e.getObject(o.rnode,d):n(new j.EFILESYSTEMERROR)}function d(e,t){e?n(e):t?F.create(t,n):n(new j.ENOENT)}function w(i,o){i?n(i):o.type===l&&o.data?e.getObject(o.data,O):n(new j.ENOTDIR("a component of the path prefix is not a directory",t))}function O(i,o){if(i)n(i);else if(Object.prototype.hasOwnProperty.call(o,u)){var r=o[u].id;e.getObject(r,b)}else n(new j.ENOENT(null,t))}function b(e,t){if(e)return n(e);F.create(t,y)}function y(l,p){var d;l?n(l):p.type===s?++c>g?n(new j.ELOOP(null,t)):(d=p.data,d=i(d),a=o(d),u=r(d),m===u?e.getObject(E,f):P(e,a,w)):n(null,p)}m===u?e.getObject(E,f):P(e,a,w)}function x(e,t,n,i,o,r,u){var a=n.xattrs;r===I&&Object.prototype.hasOwnProperty.call(a,i)?u(new j.EEXIST("attribute already exists",t)):r!==h||Object.prototype.hasOwnProperty.call(a,i)?(a[i]=o,e.putObject(n.id,n,function(i){i?u(i):S(e,t,n,{ctime:Date.now()},u)})):u(new j.ENOATTR(null,t))}function k(e,t){var n,i,o;function r(o){o?t(o):F.create({guid:e.guid,id:n.rnode,type:l},function(n,o){n?t(n):((i=o).nlinks+=1,e.putObject(i.id,i,u))})}function u(n){n?t(n):(o={},e.putObject(i.data,o,t))}e.getObject(E,function(i,o){!i&&o?t():!i||i instanceof j.ENOENT?_.create({guid:e.guid},function(i,o){i?t(i):(n=o,e.putObject(n.id,n,r))}):t(i)})}function C(e,t,n){t=i(t);var u,a,c,f,s=r(t),p=o(t);function d(t,i){t?n(t):(c=i,e.getObject(c.data,m))}function m(t,i){t?n(t):(f=i,F.create({guid:e.guid,type:l},function(t,i){t?n(t):((u=i).nlinks+=1,e.putObject(u.id,u,E))}))}function E(t){t?n(t):(a={},e.putObject(u.data,a,w))}function g(t){if(t)n(t);else{var i=Date.now();S(e,p,c,{mtime:i,ctime:i},n)}}function w(t){t?n(t):(f[s]=new T(u.id,l),e.putObject(c.data,f,g))}P(e,t,function(i,o){!i&&o?n(new j.EEXIST(null,t)):!i||i instanceof j.ENOENT?P(e,p,d):n(i)})}function X(e,t,n,o){var r=c.fsConstants,u=r.F_OK,a=r.R_OK,f=r.W_OK,l=r.X_OK,s=r.S_IXUSR,p=r.S_IXGRP,d=r.S_IXOTH;P(e,t=i(t),function(e,i){if(e)return o(e);if(n===u)return o(null);var r=Ve(i.mode,o);return r?n&(a|f)?o(null):n&l&&r&(s|p|d)?o(null):void o(new j.EACCES("permission denied",t)):void 0})}function M(e,t,n){t=i(t);var u,a,c,f,s=r(t),p=o(t);function d(i,o){i?n(i):m===s?n(new j.EBUSY(null,t)):Object.prototype.hasOwnProperty.call(o,s)?(u=(f=o)[s].id,e.getObject(u,E)):n(new j.ENOENT(null,t))}function E(i,o){i?n(i):o.type!==l?n(new j.ENOTDIR(null,t)):(u=o,e.getObject(u.data,g))}function g(i,o){i?n(i):(a=o,Object.keys(a).length>0?n(new j.ENOTEMPTY(null,t)):(delete f[s],e.putObject(c.data,f,w)))}function w(t){if(t)n(t);else{var i=Date.now();S(e,p,c,{mtime:i,ctime:i},O)}}function O(t){t?n(t):e.delete(u.id,b)}function b(t){t?n(t):e.delete(u.data,n)}P(e,p,function(t,i){t?n(t):(c=i,e.getObject(c.data,d))})}function q(t,n,u,a,c){"function"==typeof a&&(c=a,a=null),n=i(n);var p,d,E,w,v,N=r(n),I=o(n),h=0;function A(e,i){e?c(e):i.type!==l?c(new j.ENOENT(null,n)):(p=i,t.getObject(p.data,D))}function D(e,i){e?c(e):(d=i,Object.prototype.hasOwnProperty.call(d,N)?u.includes(y)?c(new j.EEXIST("O_CREATE and O_EXCLUSIVE are set, and the named file exists",n)):(E=d[N]).type===l&&u.includes(O)?c(new j.EISDIR("the named file is a directory and O_WRITE is set",n)):t.getObject(E.id,L):u.includes(b)?F.create({guid:t.guid,type:f},function(e,n){e?c(e):((w=n).nlinks+=1,a&&(w.mode=a),t.putObject(w.id,w,_))}):c(new j.ENOENT("O_CREATE is not set and the named file does not exist",n)))}function L(e,a){if(e)c(e);else{var f=a;f.type===s?++h>g?c(new j.ELOOP(null,n)):function(e){e=i(e),I=o(e),N=r(e),m===N&&(u.includes(O)?c(new j.EISDIR("the named file is a directory and O_WRITE is set",n)):P(t,n,R));P(t,I,A)}(f.data):R(void 0,f)}}function R(e,t){e?c(e):c(null,w=t)}function _(n){n?c(n):(v=e.alloc(0),t.putBuffer(w.data,v,B))}function V(e){if(e)c(e);else{var n=Date.now();S(t,I,p,{mtime:n,ctime:n},x)}}function B(e){e?c(e):(d[N]=new T(w.id,f),t.putObject(p.data,d,V))}function x(e){e?c(e):c(null,w)}m===N?u.includes(O)?c(new j.EISDIR("the named file is a directory and O_WRITE is set",n)):P(t,n,R):P(t,I,A)}function z(t,n,i,o,r,u){var a;function c(e){e?u(e):u(null,r)}function f(e){if(e)u(e);else{var i=Date.now();S(t,n.path,a,{mtime:i,ctime:i},c)}}function l(e){e?u(e):t.putObject(a.id,a,f)}t.getObject(n.id,function(c,f){if(c)u(c);else{a=f;var s=e.alloc(r);i.copy(s,0,o,o+r),n.position=r,a.size=r,a.version+=1,t.putBuffer(a.data,s,l)}})}function Y(t,n,i,o,r,u,a){var c,f;function l(e){e?a(e):a(null,r)}function s(e){if(e)a(e);else{var i=Date.now();S(t,n.path,c,{mtime:i,ctime:i},l)}}function p(e){e?a(e):t.putObject(c.id,c,s)}function d(l,s){if(l)a(l);else{if(!(f=s))return a(new j.EIO("Expected Buffer"));var d=null!=u?u:n.position,m=Math.max(f.length,d+r),E=e.alloc(m);f&&f.copy(E),i.copy(E,d,o,o+r),void 0===u&&(n.position+=r),c.size=m,c.version+=1,t.putBuffer(c.data,E,p)}}t.getObject(n.id,function(e,n){e?a(e):(c=n,t.getBuffer(c.data,d))})}function K(e,t,n,i,o,r,u){var a,c;function f(e,a){if(e)u(e);else{if(!(c=a))return u(new j.EIO("Expected Buffer"));var f=null!=r?r:t.position;o=f+o>n.length?o-f:o,c.copy(n,i,f,f+o),void 0===r&&(t.position+=o),u(null,o)}}e.getObject(t.id,function(n,i){n?u(n):i.type===l?u(new j.EISDIR("the named file is a directory",t.path)):(a=i,e.getBuffer(a.data,f))})}function U(e,t,n){P(e,t=i(t),n)}function W(e,t,n){t.getNode(e,n)}function G(e,t,n){t=i(t);var u,a,c=r(t),f=o(t);function l(e,t){if(e)return n(e);F.create(t,n)}function s(i,o){i?n(i):(a=o,Object.prototype.hasOwnProperty.call(a,c)?e.getObject(a[c].id,l):n(new j.ENOENT("a component of the path does not name an existing file",t)))}m===c?P(e,t,n):P(e,f,function(t,i){t?n(t):(u=i,e.getObject(u.data,s))})}function H(e,t,n,u){t=i(t);var a=r(t),c=o(t);n=i(n);var f,s,p,d,m,E,g=r(n),w=o(n),O=Date.now();function b(t){t?u(t):S(e,n,E,{ctime:O},u)}function y(t,n){t?u(t):((E=n).nlinks+=1,e.putObject(E.id,E,b))}function v(t){t?u(t):e.getObject(m,y)}function N(t,n){t?u(t):(d=n,Object.prototype.hasOwnProperty.call(d,g)?u(new j.EEXIST("newpath resolves to an existing file",g)):(d[g]=s[a],m=d[g].id,e.putObject(p.data,d,v)))}function I(t,n){t?u(t):(p=n,e.getObject(p.data,N))}function h(t,n){t?u(t):(s=n,Object.prototype.hasOwnProperty.call(s,a)?s[a].type===l?u(new j.EPERM("oldpath refers to a directory")):P(e,w,I):u(new j.ENOENT("a component of either path prefix does not exist",a)))}P(e,c,function(t,n){t?u(t):(f=n,e.getObject(f.data,h))})}function $(e,t,n){t=i(t);var u,a,c,f=r(t),s=o(t);function p(t){t?n(t):(delete a[f],e.putObject(u.data,a,function(t){if(t)n(t);else{var i=Date.now();S(e,s,u,{mtime:i,ctime:i},n)}}))}function d(t){t?n(t):e.delete(c.data,p)}function m(i,o){i?n(i):o.type===l?n(new j.EPERM("unlink not permitted on directories",f)):function(i,o){i?n(i):((c=o).nlinks-=1,c.nlinks<1?e.delete(c.id,d):e.putObject(c.id,c,function(i){i?n(i):S(e,t,c,{ctime:Date.now()},p)}))}(null,o)}function E(t,i){t?n(t):(a=i,Object.prototype.hasOwnProperty.call(a,f)?e.getObject(a[f].id,m):n(new j.ENOENT("a component of the path does not name an existing file",f)))}P(e,s,function(t,i){t?n(t):(u=i,e.getObject(u.data,E))})}function J(e,t,n){var o,r;function u(e,t){if(e)n(e);else{r=t;var i=Object.keys(r);n(null,i)}}t=i(t),P(e,t,function(i,r){i?n(i):r.type!==l?n(new j.ENOTDIR(null,t)):(o=r,e.getObject(o.data,u))})}function Q(e,t,a,c){a=i(a);var f,l,p,d=r(a),E=o(a);function g(i,o){i?c(i):(l=o,Object.prototype.hasOwnProperty.call(l,d)?c(new j.EEXIST(null,d)):F.create({guid:e.guid,type:s},function(i,o){i?c(i):((p=o).nlinks+=1,u(t)||(p.symlink_relpath=t,t=n.resolve(E,t)),p.size=t.length,p.data=t,e.putObject(p.id,p,O))}))}function w(t){if(t)c(t);else{var n=Date.now();S(e,E,f,{mtime:n,ctime:n},c)}}function O(t){t?c(t):(l[d]=new T(p.id,s),e.putObject(f.data,l,w))}m===d?c(new j.EEXIST(null,d)):P(e,E,function(t,n){t?c(t):(f=n,e.getObject(f.data,g))})}function Z(e,t,n){t=i(t);var u,a,c=r(t),f=o(t);function l(t,i){t?n(t):(a=i,Object.prototype.hasOwnProperty.call(a,c)?e.getObject(a[c].id,p):n(new j.ENOENT("a component of the path does not name an existing file",c)))}function p(e,i){if(e)n(e);else if(i.type!==s)n(new j.EINVAL("path not a symbolic link",t));else{var o=i.symlink_relpath?i.symlink_relpath:i.data;n(null,o)}}P(e,f,function(t,i){t?n(t):(u=i,e.getObject(u.data,l))})}function ee(t,n,o,r){var u;function a(n,i){if(n)r(n);else{if(!i)return r(new j.EIO("Expected Buffer"));var a=e.alloc(o);i&&i.copy(a),t.putBuffer(u.data,a,f)}}function c(e){if(e)r(e);else{var i=Date.now();S(t,n,u,{mtime:i,ctime:i},r)}}function f(e){e?r(e):(u.size=o,u.version+=1,t.putObject(u.id,u,c))}n=i(n),o<0?r(new j.EINVAL("length cannot be negative")):P(t,n,function(e,i){e?r(e):i.type===l?r(new j.EISDIR(null,n)):(u=i,t.getBuffer(u.data,a))})}function te(t,n,i,o){var r;function u(n,u){if(n)o(n);else{var a;if(!u)return o(new j.EIO("Expected Buffer"));a=u?u.slice(0,i):e.alloc(i),t.putBuffer(r.data,a,c)}}function a(e){if(e)o(e);else{var i=Date.now();S(t,n.path,r,{mtime:i,ctime:i},o)}}function c(e){e?o(e):(r.size=i,r.version+=1,t.putObject(r.id,r,a))}i<0?o(new j.EINVAL("length cannot be negative")):n.getNode(t,function(e,n){e?o(e):n.type===l?o(new j.EISDIR):(r=n,t.getBuffer(r.data,u))})}function ne(e,t,n,o,r){t=i(t),"number"!=typeof n||"number"!=typeof o?r(new j.EINVAL("atime and mtime must be number",t)):n<0||o<0?r(new j.EINVAL("atime and mtime must be positive integers",t)):P(e,t,function(i,u){i?r(i):S(e,t,u,{atime:n,ctime:o,mtime:o},r)})}function ie(e,t,n,i,o){"number"!=typeof n||"number"!=typeof i?o(new j.EINVAL("atime and mtime must be a number")):n<0||i<0?o(new j.EINVAL("atime and mtime must be positive integers")):t.getNode(e,function(r,u){r?o(r):S(e,t.path,u,{atime:n,ctime:i,mtime:i},o)})}function oe(e,t,n,o,r,u){t=i(t),"string"!=typeof n?u(new j.EINVAL("attribute name must be a string",t)):n?null!==r&&r!==I&&r!==h?u(new j.EINVAL("invalid flag, must be null, XATTR_CREATE or XATTR_REPLACE",t)):P(e,t,function(i,a){if(i)return u(i);x(e,t,a,n,o,r,u)}):u(new j.EINVAL("attribute name cannot be an empty string",t))}function re(e,t,n,i,o,r){"string"!=typeof n?r(new j.EINVAL("attribute name must be a string")):n?null!==o&&o!==I&&o!==h?r(new j.EINVAL("invalid flag, must be null, XATTR_CREATE or XATTR_REPLACE")):t.getNode(e,function(u,a){if(u)return r(u);x(e,t.path,a,n,i,o,r)}):r(new j.EINVAL("attribute name cannot be an empty string"))}function ue(e,t,n,o){t=i(t),"string"!=typeof n?o(new j.EINVAL("attribute name must be a string",t)):n?P(e,t,function(e,i){if(e)return o(e);var r=i.xattrs;Object.prototype.hasOwnProperty.call(r,n)?o(null,r[n]):o(new j.ENOATTR(null,t))}):o(new j.EINVAL("attribute name cannot be an empty string",t))}function ae(e,t,n,i){"string"!=typeof n?i(new j.EINVAL):n?t.getNode(e,function(e,t){if(e)return i(e);var o=t.xattrs;Object.prototype.hasOwnProperty.call(o,n)?i(null,o[n]):i(new j.ENOATTR)}):i(new j.EINVAL("attribute name cannot be an empty string"))}function ce(e,t,n,o){t=i(t),"string"!=typeof n?o(new j.EINVAL("attribute name must be a string",t)):n?P(e,t,function(i,r){if(i)return o(i);var u=r.xattrs;Object.prototype.hasOwnProperty.call(u,n)?(delete u[n],e.putObject(r.id,r,function(n){n?o(n):S(e,t,r,{ctime:Date.now()},o)})):o(new j.ENOATTR(null,t))}):o(new j.EINVAL("attribute name cannot be an empty string",t))}function fe(e,t,n,i){"string"!=typeof n?i(new j.EINVAL("attribute name must be a string")):n?t.getNode(e,function(o,r){if(o)return i(o);var u=r.xattrs;Object.prototype.hasOwnProperty.call(u,n)?(delete u[n],e.putObject(r.id,r,function(n){n?i(n):S(e,t.path,r,{ctime:Date.now()},i)})):i(new j.ENOATTR)}):i(new j.EINVAL("attribute name cannot be an empty string"))}function le(e){return Object.prototype.hasOwnProperty.call(N,e)?N[e]:null}function se(e,t,n){return e?"function"==typeof e?e={encoding:t,flag:n}:"string"==typeof e&&(e={encoding:e,flag:n}):e={encoding:t,flag:n},e}function pe(e,t,n,i,o){if(arguments.length<5?(o=arguments[arguments.length-1],i=420):i=Ve(i,d,o),!(n=le(n)))return o(new j.EINVAL("flags is not valid"),t);q(e,t,n,i,function(e,i){if(e)o(e);else{var r;r=n.includes(v)?i.size:0;var u=new R(t,i.id,n,r),a=L.allocDescriptor(u);o(null,a)}})}function de(e,t,n){L.getOpenFileDescription(t)?(L.releaseDescriptor(t),n(null)):n(new j.EBADF)}function me(e,t,n,i){B(e,t,n,i)}function Ee(e,t,n,i){if(arguments.length<4)i=n,n=d;else if(!(n=Ve(n,d,i)))return;C(e,t,i)}function ge(e,t,n,i){"function"==typeof n&&(i=n,n=c.fsConstants.F_OK),X(e,t,n|=c.fsConstants.F_OK,i)}function we(e,t,n,i){if(i=arguments[arguments.length-1],!t)return i(new Error("filename prefix is required"));var o=t+"-"+a.randomChars(6);C(e,o,function(e){i(e,o)})}function Oe(e,t,n){M(e,t,n)}function be(e,t,n){U(e,t,function(i,o){if(i)n(i);else{var r=new V(t,o,e.name);n(null,r)}})}function ye(e,t,n){var i=L.getOpenFileDescription(t);i?W(e,i,function(t,o){if(t)n(t);else{var r=new V(i.path,o,e.name);n(null,r)}}):n(new j.EBADF)}function ve(e,t,n,i){H(e,t,n,i)}function Ne(e,t,n){$(e,t,n)}function Ie(e,t,n,i,o,r,u){i=void 0===i?0:i,o=void 0===o?n.length-i:o,u=arguments[arguments.length-1];var a=L.getOpenFileDescription(t);a?a.flags.includes(w)?K(e,a,n,i,o,r,function(e,t){u(e,t||0,n)}):u(new j.EBADF("descriptor does not permit reading")):u(new j.EBADF)}function he(e,t,n){Re(t,n)===t&&(L.getOpenFileDescription(t)?n():n(new j.EBADF))}function Ae(t,n,i,o){o=arguments[arguments.length-1];var r=le((i=se(i,null,"r")).flag||"r");if(!r)return o(new j.EINVAL("flags is not valid",n));q(t,n,r,function(u,a){if(u)return o(u);var c=new R(n,a.id,r,0),f=L.allocDescriptor(c);function l(){L.releaseDescriptor(f)}W(t,c,function(r,u){if(r)return l(),o(r);var a=new V(c.path,u,t.name);if(a.isDirectory())return l(),o(new j.EISDIR("illegal operation on directory",n));var f=a.size,s=e.alloc(f);K(t,c,s,0,f,0,function(e){if(l(),e)return o(e);var t;t="utf8"===i.encoding?s.toString("utf8"):s,o(null,t)})})})}function De(e,t,n,i,o,r,u){u=arguments[arguments.length-1],i=void 0===i?0:i,o=void 0===o?n.length-i:o;var a=L.getOpenFileDescription(t);a?a.flags.includes(O)?n.length-i<o?u(new j.EIO("input buffer is too small")):Y(e,a,n,i,o,r,u):u(new j.EBADF("descriptor does not permit writing")):u(new j.EBADF)}function je(t,n,i,o,r){r=arguments[arguments.length-1];var u=le((o=se(o,"utf8","w")).flag||"w");if(!u)return r(new j.EINVAL("flags is not valid",n));"number"==typeof(i=i||"")&&(i=""+i),"string"==typeof i&&"utf8"===o.encoding&&(i=e.from(i)),q(t,n,u,function(e,o){if(e)return r(e);var a=new R(n,o.id,u,0),c=L.allocDescriptor(a);z(t,a,i,0,i.length,function(e){if(L.releaseDescriptor(c),e)return r(e);r(null)})})}function Te(t,n,i,o,r){r=arguments[arguments.length-1];var u=le((o=se(o,"utf8","a")).flag||"a");if(!u)return r(new j.EINVAL("flags is not valid",n));"number"==typeof(i=i||"")&&(i=""+i),"string"==typeof i&&"utf8"===o.encoding&&(i=e.from(i)),q(t,n,u,function(e,o){if(e)return r(e);var a=new R(n,o.id,u,o.size),c=L.allocDescriptor(a);Y(t,a,i,0,i.length,a.position,function(e){if(L.releaseDescriptor(c),e)return r(e);r(null)})})}function Le(e,t,n){be(e,t,function(e){n(!e)})}function Re(e,t){if("number"==typeof e)return e;t(new j.EINVAL("Expected integer",e))}var _e=/^[0-7]+$/;function Fe(e){return e===e>>>0}function Ve(e,t,n){return"function"==typeof t&&(n=t,t=void 0),Fe(e)?e&d:"number"==typeof e?(Number.isInteger(e),n(new j.EINVAL("mode not a valid an integer value",e)),!1):"string"==typeof e?_e.test(e)?parseInt(e,8)&d:(n(new j.EINVAL("mode not a valid octal string",e)),!1):void 0!==t?t:(n(new j.EINVAL("mode not valid",e)),!1)}function Se(e,t,n,o){t=i(t),"number"!=typeof n?o(new j.EINVAL("mode must be number",t)):P(e,t,function(i,r){i?o(i):(r.mode=n,S(e,t,r,{mtime:Date.now()},o))})}function Be(e,t,n,i){"number"!=typeof n?i(new j.EINVAL("mode must be a number")):t.getNode(e,function(o,r){o?i(o):(r.mode=n,S(e,t.path,r,{mtime:Date.now()},i))})}function Pe(e,t,n,o,r){t=i(t),P(e,t,function(i,u){i?r(i):(u.uid=n,u.gid=o,S(e,t,u,{mtime:Date.now()},r))})}function xe(e,t,n,i,o){t.getNode(e,function(r,u){r?o(r):(u.uid=n,u.gid=i,S(e,t.path,u,{mtime:Date.now()},o))})}function ke(e,t,n,i){ue(e,t,n,i)}function Ce(e,t,n,i){var o=L.getOpenFileDescription(t);o?ae(e,o,n,i):i(new j.EBADF)}function Xe(e,t,n,i,o,r){"function"==typeof o&&(r=o,o=null),oe(e,t,n,i,o,r)}function Me(e,t,n,i,o,r){"function"==typeof o&&(r=o,o=null);var u=L.getOpenFileDescription(t);u?u.flags.includes(O)?re(e,u,n,i,o,r):r(new j.EBADF("descriptor does not permit writing")):r(new j.EBADF)}function qe(e,t,n,i){ce(e,t,n,i)}function ze(e,t,n,i){var o=L.getOpenFileDescription(t);o?o.flags.includes(O)?fe(e,o,n,i):i(new j.EBADF("descriptor does not permit writing")):i(new j.EBADF)}function Ye(e,t,n,i,o){var r=L.getOpenFileDescription(t);r||o(new j.EBADF),"SET"===i?n<0?o(new j.EINVAL("resulting file offset would be negative")):(r.position=n,o(null,r.position)):"CUR"===i?r.position+n<0?o(new j.EINVAL("resulting file offset would be negative")):(r.position+=n,o(null,r.position)):"END"===i?W(e,r,function(e,t){e?o(e):t.size+n<0?o(new j.EINVAL("resulting file offset would be negative")):(r.position=t.size+n,o(null,r.position))}):o(new j.EINVAL("whence argument is not a proper value"))}function Ke(e,t,n){J(e,t,n)}function Ue(e){return"number"==typeof e?e:"object"===t(e)&&"function"==typeof e.getTime?e.getTime():void 0}function We(e,t,n,i,o){var r=Date.now();ne(e,t,n=Ue(n||r),i=Ue(i||r),o)}function Ge(e,t,n,i,o){var r=Date.now();n=Ue(n||r),i=Ue(i||r);var u=L.getOpenFileDescription(t);u?u.flags.includes(O)?ie(e,u,n,i,o):o(new j.EBADF("descriptor does not permit writing")):o(new j.EBADF)}function He(e,t,n,i){(n=Ve(n,i))&&Se(e,t,n,i)}function $e(e,t,n,i){if(n=Ve(n,i)){var o=L.getOpenFileDescription(t);o?o.flags.includes(O)?Be(e,o,n,i):i(new j.EBADF("descriptor does not permit writing")):i(new j.EBADF)}}function Je(e,t,n,i,o){return Fe(n)?Fe(i)?void Pe(e,t,n,i,o):o(new j.EINVAL("gid must be a valid integer",i)):o(new j.EINVAL("uid must be a valid integer",n))}function Qe(e,t,n,i,o){if(!Fe(n))return o(new j.EINVAL("uid must be a valid integer",n));if(!Fe(i))return o(new j.EINVAL("gid must be a valid integer",i));var r=L.getOpenFileDescription(t);r?r.flags.includes(O)?xe(e,r,n,i,o):o(new j.EBADF("descriptor does not permit writing")):o(new j.EBADF)}function Ze(e,t,o,r){t=i(t),o=i(o);var u,a,c,f,s=n.dirname(t),p=n.dirname(t),d=n.basename(t),m=n.basename(o),E=Date.now();function g(t,n){t?r(t):S(e,o,n,{ctime:E},r)}function w(t){t?r(t):e.getObject(f[m].id,g)}function O(t){t?r(t):(u.id===c.id&&(a=f),delete a[d],e.putObject(u.data,a,w))}function b(t){t?r(t):(f[m]=a[d],e.putObject(c.data,f,O))}function y(t,n){t?r(t):(f=n,Object.prototype.hasOwnProperty.call(f,m)?M(e,o,b):b())}function v(t,n){t?r(t):(c=n,e.getObject(c.data,y))}function N(t,n){t?r(t):(a=n,P(e,p,v))}function I(t,n){t?r(t):(u=n,e.getObject(n.data,N))}function h(n){n?r(n):$(e,t,r)}P(e,t,function(n,i){n?r(n):i.type===l?P(e,s,I):H(e,t,o,h)})}function et(e,t,n,i,o){Q(e,t,n,o=arguments[arguments.length-1])}function tt(e,t,n){Z(e,t,n)}function nt(e,t,n){G(e,t,function(i,o){if(i)n(i);else{var r=new V(t,o,e.name);n(null,r)}})}function it(e,t,n,i){Re(n=n||0,i=arguments[arguments.length-1])===n&&ee(e,t,n,i)}function ot(e,t,n,i){i=arguments[arguments.length-1],n=n||0;var o=L.getOpenFileDescription(t);if(o)if(o.flags.includes(O)){if(Re(n,i)!==n)return;te(e,o,n,i)}else i(new j.EBADF("descriptor does not permit writing"));else i(new j.EBADF)}module.exports={appendFile:Te,access:ge,chown:Je,chmod:He,close:de,ensureRootDirectory:k,exists:Le,fchown:Qe,fchmod:$e,fgetxattr:Ce,fremovexattr:ze,fsetxattr:Me,fstat:ye,fsync:he,ftruncate:ot,futimes:Ge,getxattr:ke,link:ve,lseek:Ye,lstat:nt,mkdir:Ee,mkdtemp:we,mknod:me,open:pe,readdir:Ke,read:Ie,readFile:Ae,readlink:tt,removexattr:qe,rename:Ze,rmdir:Oe,setxattr:Xe,stat:be,symlink:et,truncate:it,unlink:Ne,utimes:We,writeFile:je,write:De};
},{"../path.js":"UzoP","../shared.js":"zBMa","../constants.js":"iJA9","../errors.js":"p8GN","../directory-entry.js":"ZECt","../open-files.js":"osLK","../open-file-description.js":"XWaV","../super-node.js":"JEp0","../node.js":"KKNo","../stats.js":"dsCT","buffer":"dskh"}],"GMi4":[function(require,module,exports) {
var Buffer = require("buffer").Buffer;
var e=require("buffer").Buffer,r=require("es6-promisify"),t=r.promisify,n=require("../path.js"),a=require("../providers/index.js"),s=require("../shell/shell.js"),o=require("../../lib/intercom.js"),i=require("../fs-watcher.js"),u=require("../errors.js"),m=require("../shared.js"),c=m.nop,f=m.guid,l=require("../constants.js"),h=l.fsConstants,p=l.FILE_SYSTEM_NAME,d=l.FS_FORMAT,g=l.FS_READY,b=l.FS_PENDING,A=l.FS_ERROR,P=l.FS_NODUPEIDCHECK,v=l.STDIN,y=l.STDOUT,E=l.STDERR,R=require("./implementation.js");function w(e){return"function"==typeof e?e:function(e){if(e)throw e}}function S(e){e&&console.error("Filer error: ",e)}function O(e){if(!(e&&e.protocol&&e.pathname))return e;if("file:"!==e.protocol)throw new u.EINVAL("only file: URLs are supported for paths",e);for(var r=e.pathname,t=0;t<r.length;t++)if("%"===r[t]){var n=32|r.codePointAt(t+2);if("2"===r[t+1]&&102===n)throw new u.EINVAL("file: URLs must not include encoded / characters",e)}return decodeURIComponent(r)}function x(r){return e.isBuffer(r)?r.toString():r}function F(e,r){return e?n.isNull(e)?new u.EINVAL("Path must be a string without null bytes.",e):r||n.isAbsolute(e)?void 0:new u.EINVAL("Path must be absolute.",e):new u.EINVAL("Path must be a string",e)}function _(e,r,t){var n=e[r],a=F(n=x(n=O(n)),t);if(a)throw a;e[r]=n}function q(e,r){r=r||S;var m=(e=e||{}).flags||[],l=e.guid?e.guid:f,O=e.provider||new a.Default(e.name||p),x=e.name||O.name,F=m.includes(d),I=this;I.readyState=b,I.name=x,I.error=null,I.stdin=v,I.stdout=y,I.stderr=E,I.constants=h,I.F_OK=h.F_OK,I.R_OK=h.R_OK,I.W_OK=h.W_OK,I.X_OK=h.X_OK,this.Shell=s.bind(void 0,this);var N=[];function j(e){return function(r){m.includes(P)?r(null,l()):function r(t){var n=l();e.getObject(n,function(e,a){e?t(e):a?r(t):t(null,n)})}(r)}}this.queueOrRun=function(e){var r;return g===I.readyState?e.call(I):A===I.readyState?r=new u.EFILESYSTEMERROR("unknown error"):N.push(e),r},this.watch=function(e,r,t){if(n.isNull(e))throw new Error("Path must be a string without null bytes.");"function"==typeof r&&(t=r,r={}),r=r||{},t=t||c;var a=new i;return a.start(e,!1,r.recursive),a.on("change",t),a},O.open(function(e){function t(e){function t(e){var r=O[e]();return r.name=x,r.flags=m,r.changes=[],r.guid=j(r),r.close=function(){var e=r.changes;!function(e){if(e.length){var r=o.getInstance();e.forEach(function(e){r.emit(e.event,e.path)})}}(e),e.length=0},r}I.provider={openReadWriteContext:function(){return t("getReadWriteContext")},openReadOnlyContext:function(){return t("getReadOnlyContext")}},I.readyState=e?A:g,N.forEach(function(e){e.call(this)}.bind(I)),N=null,r(e,I)}if(e)return t(e);var n=O.getReadWriteContext();n.guid=j(n),F?n.clear(function(e){if(e)return t(e);R.ensureRootDirectory(n,t)}):R.ensureRootDirectory(n,t)}),q.prototype.promises={},[{name:"appendFile",promises:!0,absPathArgs:[0]},{name:"access",promises:!0,absPathArgs:[0]},{name:"chown",promises:!0,absPathArgs:[0]},{name:"chmod",promises:!0,absPathArgs:[0]},{name:"close"},{name:"exists",absPathArgs:[0]},{name:"fchown"},{name:"fchmod"},{name:"fgetxattr"},{name:"fremovexattr"},{name:"fsetxattr"},{name:"fstat"},{name:"fsync"},{name:"ftruncate"},{name:"futimes"},{name:"getxattr",promises:!0,absPathArgs:[0]},{name:"link",promises:!0,absPathArgs:[0,1]},{name:"lseek"},{name:"lstat",promises:!0},{name:"mkdir",promises:!0,absPathArgs:[0]},{name:"mkdtemp",promises:!0},{name:"mknod",promises:!0,absPathArgs:[0]},{name:"open",promises:!0,absPathArgs:[0]},{name:"readdir",promises:!0,absPathArgs:[0]},{name:"read"},{name:"readFile",promises:!0,absPathArgs:[0]},{name:"readlink",promises:!0,absPathArgs:[0]},{name:"removexattr",promises:!0,absPathArgs:[0]},{name:"rename",promises:!0,absPathArgs:[0,1]},{name:"rmdir",promises:!0,absPathArgs:[0]},{name:"setxattr",promises:!0,absPathArgs:[0]},{name:"stat",promises:!0,absPathArgs:[0]},{name:"symlink",promises:!0,relPathArgs:[0],absPathArgs:[1]},{name:"truncate",promises:!0,absPathArgs:[0]},{name:"unlink",promises:!0,absPathArgs:[0]},{name:"utimes",promises:!0,absPathArgs:[0]},{name:"writeFile",promises:!0,absPathArgs:[0]},{name:"write"}].forEach(function(e){var r=e.name,n=!0===e.promises;q.prototype[r]=function(){var t=this,n=Array.prototype.slice.call(arguments,0),a=n.length-1,s="function"!=typeof n[a],o=w(n[a]);e.absPathArgs&&e.absPathArgs.forEach(function(e){return _(n,e,!1)}),e.relPathArgs&&e.relPathArgs.forEach(function(e){return _(n,e,!0)});var i=t.queueOrRun(function(){var e=t.provider.openReadWriteContext();if(A===t.readyState){var i=new u.EFILESYSTEMERROR("filesystem unavailable, operation canceled");return o.call(t,i)}function m(){e.close(),o.apply(t,arguments)}s?n.push(m):n[a]=m;var c=[e].concat(n);R[r].apply(null,c)});i&&o(i)},n&&(q.prototype.promises[r]=t(q.prototype[r].bind(I)))})}q.providers=a,module.exports=q;
},{"es6-promisify":"c0Ea","../path.js":"UzoP","../providers/index.js":"AiW7","../shell/shell.js":"D1Ra","../../lib/intercom.js":"u7Jv","../fs-watcher.js":"VLEe","../errors.js":"p8GN","../shared.js":"zBMa","../constants.js":"iJA9","./implementation.js":"bsBG","buffer":"dskh"}],"Focm":[function(require,module,exports) {
var Buffer = require("buffer").Buffer;
var e=require("buffer").Buffer,r=null,l=null;module.exports=l={FileSystem:require("./filesystem/interface.js"),Buffer:e,Path:require("./path.js"),path:require("./path.js"),Errors:require("./errors.js"),Shell:require("./shell/shell.js")},Object.defineProperty(l,"fs",{enumerable:!0,get:function(){return r||(r=new l.FileSystem),r}});
},{"./filesystem/interface.js":"GMi4","./path.js":"UzoP","./errors.js":"p8GN","./shell/shell.js":"D1Ra","buffer":"dskh"}]},{},["Focm"], "Filer")

},{}],"filesystem.js":[function(require,module,exports) {

'use strict';

var _require = require('./dtconfig'),
    fsRoot = _require.fsRoot;

var _require2 = require('filer'),
    fs = _require2.fs,
    Path = _require2.Path,
    Buffer = _require2.Buffer;

var sh = new fs.Shell();
window.fs = fs;
window.path = Path;
window.Buffer = Buffer; // File Upload

document.addEventListener("DOMContentLoaded", function () {
  document.querySelector('#dt_upload').addEventListener('change', function (e) {
    for (var i = 0; i < e.target.files.length; i++) {
      uploadFile(e.target.files[i].name, e.target.files[i]);
    }

    function uploadFile(fileName, file) {
      // Browser FileReader API
      var reader = new FileReader();

      reader.onload = function (e) {
        var resultArr = new Uint8Array(e.target.result);
        var buffer = new Buffer(resultArr); // Filer API - write file to Indexed DB

        fs.writeFile('/' + fileName, buffer, function (err) {
          if (err) {
            alert("File Upload error");
          }
        });
      };

      reader.readAsArrayBuffer(file);
    }

    ;
  });
}); // File Download

var readFile = function readFile(file) {
  var fileName = file.replace(/\//g, '');
  fs.readFile(file, 'utf8', function (err, data) {
    if (err) {
      //console.error(err);
      alert('File not found! Verify path and filename.');
      return;
    }

    setDownload(fileName, data);
    document.querySelector('#dt_downpath').value = '';
  });

  function setDownload(fileName, data) {
    var dt = document.createElement("a");
    dt.download = fileName;
    dt.href = window.URL.createObjectURL(new Blob([data]));
    dt.dataset.downloadurl = "application/octet-stream:" + dt.download + ":" + dt.href;
    dt.click();
  }

  ;
};

document.addEventListener("DOMContentLoaded", function () {
  document.querySelector('#dt_downpath').addEventListener('keypress', function (e) {
    if (e.which == 13) {
      readFile(e.target.value);
    }
  });
}); // Welcome files placement in filesystem

function welcome() {
  var readme = "Welcome to Digital Twin! You can access mounted files /mnt using upload and download options. This Digital Twin is a compilation of Embedded Linux system, SPRECON specific process, Filer filesystem, and I/O.";
  fs.writeFile('/README.txt', readme, function (err) {
    if (err) console.error(err);
  });
}

;
module.exports = {
  welcome: welcome,
  fs: fs,
  sh: sh,
  Path: Path,
  Buffer: Buffer
};
},{"./dtconfig":"dtconfig.js","filer":"../node_modules/filer/dist/filer.min.js"}],"dtwebserver.js":[function(require,module,exports) {
'use strict';

var _require = require('workbox-window'),
    Workbox = _require.Workbox;

var filesystem = require('./filesystem');

var fsRoot = 'fs'; // function setFrame() {
//   const iframe = document.querySelector('#webserver');
//   const iframeWindow = iframe.contentWindow;
//   iframe.src
// }

/**
 * Register the nohost service worker, passing `route`
 */

function start() {
  if (!('serviceWorker' in navigator)) {
    console.log('[nohost] unable to initialize service worker: not supported.');
    return;
  } //const wb = new Workbox(`nohost-sw.js?route=${encodeURIComponent(fsRoot)}`);


  var wb = new Workbox("nohost-sw.js?route=/fs"); // Wait on the server to be fully ready to handle routing requests

  wb.controlling.then(function () {//console.log('ready for handling request');
    //fixFsUrls();
  }); // Deal with first-run install, if necessary

  wb.addEventListener('installed', function (event) {
    if (!event.isUpdate) {
      filesystem.welcome(); //console.log('first run');
      // setFrame();
    }
  }); // Register the service worker after event listeners have been added.

  wb.register();
}

module.exports.start = start;
},{"workbox-window":"../node_modules/workbox-window/build/workbox-window.prod.es5.mjs","./filesystem":"filesystem.js"}],"../node_modules/xterm/lib/xterm.js":[function(require,module,exports) {
var define;
!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var i in r)("object"==typeof exports?exports:e)[i]=r[i]}}(self,(function(){return(()=>{"use strict";var e={4567:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.AccessibilityManager=void 0;var o=r(9042),s=r(6114),a=r(6193),c=r(3656),l=r(844),h=r(5596),u=r(9631),f=function(e){function t(t,r){var i=e.call(this)||this;i._terminal=t,i._renderService=r,i._liveRegionLineCount=0,i._charsToConsume=[],i._charsToAnnounce="",i._accessibilityTreeRoot=document.createElement("div"),i._accessibilityTreeRoot.classList.add("xterm-accessibility"),i._rowContainer=document.createElement("div"),i._rowContainer.setAttribute("role","list"),i._rowContainer.classList.add("xterm-accessibility-tree"),i._rowElements=[];for(var n=0;n<i._terminal.rows;n++)i._rowElements[n]=i._createAccessibilityTreeNode(),i._rowContainer.appendChild(i._rowElements[n]);if(i._topBoundaryFocusListener=function(e){return i._onBoundaryFocus(e,0)},i._bottomBoundaryFocusListener=function(e){return i._onBoundaryFocus(e,1)},i._rowElements[0].addEventListener("focus",i._topBoundaryFocusListener),i._rowElements[i._rowElements.length-1].addEventListener("focus",i._bottomBoundaryFocusListener),i._refreshRowsDimensions(),i._accessibilityTreeRoot.appendChild(i._rowContainer),i._renderRowsDebouncer=new a.RenderDebouncer(i._renderRows.bind(i)),i._refreshRows(),i._liveRegion=document.createElement("div"),i._liveRegion.classList.add("live-region"),i._liveRegion.setAttribute("aria-live","assertive"),i._accessibilityTreeRoot.appendChild(i._liveRegion),!i._terminal.element)throw new Error("Cannot enable accessibility before Terminal.open");return i._terminal.element.insertAdjacentElement("afterbegin",i._accessibilityTreeRoot),i.register(i._renderRowsDebouncer),i.register(i._terminal.onResize((function(e){return i._onResize(e.rows)}))),i.register(i._terminal.onRender((function(e){return i._refreshRows(e.start,e.end)}))),i.register(i._terminal.onScroll((function(){return i._refreshRows()}))),i.register(i._terminal.onA11yChar((function(e){return i._onChar(e)}))),i.register(i._terminal.onLineFeed((function(){return i._onChar("\n")}))),i.register(i._terminal.onA11yTab((function(e){return i._onTab(e)}))),i.register(i._terminal.onKey((function(e){return i._onKey(e.key)}))),i.register(i._terminal.onBlur((function(){return i._clearLiveRegion()}))),i.register(i._renderService.onDimensionsChange((function(){return i._refreshRowsDimensions()}))),i._screenDprMonitor=new h.ScreenDprMonitor,i.register(i._screenDprMonitor),i._screenDprMonitor.setListener((function(){return i._refreshRowsDimensions()})),i.register(c.addDisposableDomListener(window,"resize",(function(){return i._refreshRowsDimensions()}))),i}return n(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),u.removeElementFromParent(this._accessibilityTreeRoot),this._rowElements.length=0},t.prototype._onBoundaryFocus=function(e,t){var r=e.target,i=this._rowElements[0===t?1:this._rowElements.length-2];if(r.getAttribute("aria-posinset")!==(0===t?"1":""+this._terminal.buffer.lines.length)&&e.relatedTarget===i){var n,o;if(0===t?(n=r,o=this._rowElements.pop(),this._rowContainer.removeChild(o)):(n=this._rowElements.shift(),o=r,this._rowContainer.removeChild(n)),n.removeEventListener("focus",this._topBoundaryFocusListener),o.removeEventListener("focus",this._bottomBoundaryFocusListener),0===t){var s=this._createAccessibilityTreeNode();this._rowElements.unshift(s),this._rowContainer.insertAdjacentElement("afterbegin",s)}else s=this._createAccessibilityTreeNode(),this._rowElements.push(s),this._rowContainer.appendChild(s);this._rowElements[0].addEventListener("focus",this._topBoundaryFocusListener),this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._terminal.scrollLines(0===t?-1:1),this._rowElements[0===t?1:this._rowElements.length-2].focus(),e.preventDefault(),e.stopImmediatePropagation()}},t.prototype._onResize=function(e){this._rowElements[this._rowElements.length-1].removeEventListener("focus",this._bottomBoundaryFocusListener);for(var t=this._rowContainer.children.length;t<this._terminal.rows;t++)this._rowElements[t]=this._createAccessibilityTreeNode(),this._rowContainer.appendChild(this._rowElements[t]);for(;this._rowElements.length>e;)this._rowContainer.removeChild(this._rowElements.pop());this._rowElements[this._rowElements.length-1].addEventListener("focus",this._bottomBoundaryFocusListener),this._refreshRowsDimensions()},t.prototype._createAccessibilityTreeNode=function(){var e=document.createElement("div");return e.setAttribute("role","listitem"),e.tabIndex=-1,this._refreshRowDimensions(e),e},t.prototype._onTab=function(e){for(var t=0;t<e;t++)this._onChar(" ")},t.prototype._onChar=function(e){var t=this;this._liveRegionLineCount<21&&(this._charsToConsume.length>0?this._charsToConsume.shift()!==e&&(this._charsToAnnounce+=e):this._charsToAnnounce+=e,"\n"===e&&(this._liveRegionLineCount++,21===this._liveRegionLineCount&&(this._liveRegion.textContent+=o.tooMuchOutput)),s.isMac&&this._liveRegion.textContent&&this._liveRegion.textContent.length>0&&!this._liveRegion.parentNode&&setTimeout((function(){t._accessibilityTreeRoot.appendChild(t._liveRegion)}),0))},t.prototype._clearLiveRegion=function(){this._liveRegion.textContent="",this._liveRegionLineCount=0,s.isMac&&u.removeElementFromParent(this._liveRegion)},t.prototype._onKey=function(e){this._clearLiveRegion(),this._charsToConsume.push(e)},t.prototype._refreshRows=function(e,t){this._renderRowsDebouncer.refresh(e,t,this._terminal.rows)},t.prototype._renderRows=function(e,t){for(var r=this._terminal.buffer,i=r.lines.length.toString(),n=e;n<=t;n++){var o=r.translateBufferLineToString(r.ydisp+n,!0),s=(r.ydisp+n+1).toString(),a=this._rowElements[n];a&&(0===o.length?a.innerText=" ":a.textContent=o,a.setAttribute("aria-posinset",s),a.setAttribute("aria-setsize",i))}this._announceCharacters()},t.prototype._refreshRowsDimensions=function(){if(this._renderService.dimensions.actualCellHeight){this._rowElements.length!==this._terminal.rows&&this._onResize(this._terminal.rows);for(var e=0;e<this._terminal.rows;e++)this._refreshRowDimensions(this._rowElements[e])}},t.prototype._refreshRowDimensions=function(e){e.style.height=this._renderService.dimensions.actualCellHeight+"px"},t.prototype._announceCharacters=function(){0!==this._charsToAnnounce.length&&(this._liveRegion.textContent+=this._charsToAnnounce,this._charsToAnnounce="")},t}(l.Disposable);t.AccessibilityManager=f},3614:(e,t)=>{function r(e){return e.replace(/\r?\n/g,"\r")}function i(e,t){return t?"[200~"+e+"[201~":e}function n(e,t,n){e=i(e=r(e),n.decPrivateModes.bracketedPasteMode),n.triggerDataEvent(e,!0),t.value=""}function o(e,t,r){var i=r.getBoundingClientRect(),n=e.clientX-i.left-10,o=e.clientY-i.top-10;t.style.width="20px",t.style.height="20px",t.style.left=n+"px",t.style.top=o+"px",t.style.zIndex="1000",t.focus()}Object.defineProperty(t,"__esModule",{value:!0}),t.rightClickHandler=t.moveTextAreaUnderMouseCursor=t.paste=t.handlePasteEvent=t.copyHandler=t.bracketTextForPaste=t.prepareTextForTerminal=void 0,t.prepareTextForTerminal=r,t.bracketTextForPaste=i,t.copyHandler=function(e,t){e.clipboardData&&e.clipboardData.setData("text/plain",t.selectionText),e.preventDefault()},t.handlePasteEvent=function(e,t,r){e.stopPropagation(),e.clipboardData&&n(e.clipboardData.getData("text/plain"),t,r)},t.paste=n,t.moveTextAreaUnderMouseCursor=o,t.rightClickHandler=function(e,t,r,i,n){o(e,t,r),n&&i.rightClickSelect(e),t.value=i.selectionText,t.select()}},4774:(e,t)=>{var r,i,n,o;function s(e){var t=e.toString(16);return t.length<2?"0"+t:t}function a(e,t){return e<t?(t+.05)/(e+.05):(e+.05)/(t+.05)}Object.defineProperty(t,"__esModule",{value:!0}),t.contrastRatio=t.toPaddedHex=t.rgba=t.rgb=t.css=t.color=t.channels=void 0,function(e){e.toCss=function(e,t,r,i){return void 0!==i?"#"+s(e)+s(t)+s(r)+s(i):"#"+s(e)+s(t)+s(r)},e.toRgba=function(e,t,r,i){return void 0===i&&(i=255),(e<<24|t<<16|r<<8|i)>>>0}}(r=t.channels||(t.channels={})),(i=t.color||(t.color={})).blend=function(e,t){var i=(255&t.rgba)/255;if(1===i)return{css:t.css,rgba:t.rgba};var n=t.rgba>>24&255,o=t.rgba>>16&255,s=t.rgba>>8&255,a=e.rgba>>24&255,c=e.rgba>>16&255,l=e.rgba>>8&255,h=a+Math.round((n-a)*i),u=c+Math.round((o-c)*i),f=l+Math.round((s-l)*i);return{css:r.toCss(h,u,f),rgba:r.toRgba(h,u,f)}},i.isOpaque=function(e){return 255==(255&e.rgba)},i.ensureContrastRatio=function(e,t,r){var i=o.ensureContrastRatio(e.rgba,t.rgba,r);if(i)return o.toColor(i>>24&255,i>>16&255,i>>8&255)},i.opaque=function(e){var t=(255|e.rgba)>>>0,i=o.toChannels(t),n=i[0],s=i[1],a=i[2];return{css:r.toCss(n,s,a),rgba:t}},i.opacity=function(e,t){var i=Math.round(255*t),n=o.toChannels(e.rgba),s=n[0],a=n[1],c=n[2];return{css:r.toCss(s,a,c,i),rgba:r.toRgba(s,a,c,i)}},(t.css||(t.css={})).toColor=function(e){switch(e.length){case 7:return{css:e,rgba:(parseInt(e.slice(1),16)<<8|255)>>>0};case 9:return{css:e,rgba:parseInt(e.slice(1),16)>>>0}}throw new Error("css.toColor: Unsupported css format")},function(e){function t(e,t,r){var i=e/255,n=t/255,o=r/255;return.2126*(i<=.03928?i/12.92:Math.pow((i+.055)/1.055,2.4))+.7152*(n<=.03928?n/12.92:Math.pow((n+.055)/1.055,2.4))+.0722*(o<=.03928?o/12.92:Math.pow((o+.055)/1.055,2.4))}e.relativeLuminance=function(e){return t(e>>16&255,e>>8&255,255&e)},e.relativeLuminance2=t}(n=t.rgb||(t.rgb={})),function(e){function t(e,t,r){for(var i=e>>24&255,o=e>>16&255,s=e>>8&255,c=t>>24&255,l=t>>16&255,h=t>>8&255,u=a(n.relativeLuminance2(c,h,l),n.relativeLuminance2(i,o,s));u<r&&(c>0||l>0||h>0);)c-=Math.max(0,Math.ceil(.1*c)),l-=Math.max(0,Math.ceil(.1*l)),h-=Math.max(0,Math.ceil(.1*h)),u=a(n.relativeLuminance2(c,h,l),n.relativeLuminance2(i,o,s));return(c<<24|l<<16|h<<8|255)>>>0}function i(e,t,r){for(var i=e>>24&255,o=e>>16&255,s=e>>8&255,c=t>>24&255,l=t>>16&255,h=t>>8&255,u=a(n.relativeLuminance2(c,h,l),n.relativeLuminance2(i,o,s));u<r&&(c<255||l<255||h<255);)c=Math.min(255,c+Math.ceil(.1*(255-c))),l=Math.min(255,l+Math.ceil(.1*(255-l))),h=Math.min(255,h+Math.ceil(.1*(255-h))),u=a(n.relativeLuminance2(c,h,l),n.relativeLuminance2(i,o,s));return(c<<24|l<<16|h<<8|255)>>>0}e.ensureContrastRatio=function(e,r,o){var s=n.relativeLuminance(e>>8),c=n.relativeLuminance(r>>8);if(a(s,c)<o)return c<s?t(e,r,o):i(e,r,o)},e.reduceLuminance=t,e.increaseLuminance=i,e.toChannels=function(e){return[e>>24&255,e>>16&255,e>>8&255,255&e]},e.toColor=function(e,t,i){return{css:r.toCss(e,t,i),rgba:r.toRgba(e,t,i)}}}(o=t.rgba||(t.rgba={})),t.toPaddedHex=s,t.contrastRatio=a},7239:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColorContrastCache=void 0;var r=function(){function e(){this._color={},this._rgba={}}return e.prototype.clear=function(){this._color={},this._rgba={}},e.prototype.setCss=function(e,t,r){this._rgba[e]||(this._rgba[e]={}),this._rgba[e][t]=r},e.prototype.getCss=function(e,t){return this._rgba[e]?this._rgba[e][t]:void 0},e.prototype.setColor=function(e,t,r){this._color[e]||(this._color[e]={}),this._color[e][t]=r},e.prototype.getColor=function(e,t){return this._color[e]?this._color[e][t]:void 0},e}();t.ColorContrastCache=r},5680:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ColorManager=t.DEFAULT_ANSI_COLORS=void 0;var i=r(4774),n=r(7239),o=i.css.toColor("#ffffff"),s=i.css.toColor("#000000"),a=i.css.toColor("#ffffff"),c=i.css.toColor("#000000"),l={css:"rgba(255, 255, 255, 0.3)",rgba:4294967117};t.DEFAULT_ANSI_COLORS=Object.freeze(function(){for(var e=[i.css.toColor("#2e3436"),i.css.toColor("#cc0000"),i.css.toColor("#4e9a06"),i.css.toColor("#c4a000"),i.css.toColor("#3465a4"),i.css.toColor("#75507b"),i.css.toColor("#06989a"),i.css.toColor("#d3d7cf"),i.css.toColor("#555753"),i.css.toColor("#ef2929"),i.css.toColor("#8ae234"),i.css.toColor("#fce94f"),i.css.toColor("#729fcf"),i.css.toColor("#ad7fa8"),i.css.toColor("#34e2e2"),i.css.toColor("#eeeeec")],t=[0,95,135,175,215,255],r=0;r<216;r++){var n=t[r/36%6|0],o=t[r/6%6|0],s=t[r%6];e.push({css:i.channels.toCss(n,o,s),rgba:i.channels.toRgba(n,o,s)})}for(r=0;r<24;r++){var a=8+10*r;e.push({css:i.channels.toCss(a,a,a),rgba:i.channels.toRgba(a,a,a)})}return e}());var h=function(){function e(e,r){this.allowTransparency=r;var h=e.createElement("canvas");h.width=1,h.height=1;var u=h.getContext("2d");if(!u)throw new Error("Could not get rendering context");this._ctx=u,this._ctx.globalCompositeOperation="copy",this._litmusColor=this._ctx.createLinearGradient(0,0,1,1),this._contrastCache=new n.ColorContrastCache,this.colors={foreground:o,background:s,cursor:a,cursorAccent:c,selectionTransparent:l,selectionOpaque:i.color.blend(s,l),ansi:t.DEFAULT_ANSI_COLORS.slice(),contrastCache:this._contrastCache}}return e.prototype.onOptionsChange=function(e){"minimumContrastRatio"===e&&this._contrastCache.clear()},e.prototype.setTheme=function(e){void 0===e&&(e={}),this.colors.foreground=this._parseColor(e.foreground,o),this.colors.background=this._parseColor(e.background,s),this.colors.cursor=this._parseColor(e.cursor,a,!0),this.colors.cursorAccent=this._parseColor(e.cursorAccent,c,!0),this.colors.selectionTransparent=this._parseColor(e.selection,l,!0),this.colors.selectionOpaque=i.color.blend(this.colors.background,this.colors.selectionTransparent),i.color.isOpaque(this.colors.selectionTransparent)&&(this.colors.selectionTransparent=i.color.opacity(this.colors.selectionTransparent,.3)),this.colors.ansi[0]=this._parseColor(e.black,t.DEFAULT_ANSI_COLORS[0]),this.colors.ansi[1]=this._parseColor(e.red,t.DEFAULT_ANSI_COLORS[1]),this.colors.ansi[2]=this._parseColor(e.green,t.DEFAULT_ANSI_COLORS[2]),this.colors.ansi[3]=this._parseColor(e.yellow,t.DEFAULT_ANSI_COLORS[3]),this.colors.ansi[4]=this._parseColor(e.blue,t.DEFAULT_ANSI_COLORS[4]),this.colors.ansi[5]=this._parseColor(e.magenta,t.DEFAULT_ANSI_COLORS[5]),this.colors.ansi[6]=this._parseColor(e.cyan,t.DEFAULT_ANSI_COLORS[6]),this.colors.ansi[7]=this._parseColor(e.white,t.DEFAULT_ANSI_COLORS[7]),this.colors.ansi[8]=this._parseColor(e.brightBlack,t.DEFAULT_ANSI_COLORS[8]),this.colors.ansi[9]=this._parseColor(e.brightRed,t.DEFAULT_ANSI_COLORS[9]),this.colors.ansi[10]=this._parseColor(e.brightGreen,t.DEFAULT_ANSI_COLORS[10]),this.colors.ansi[11]=this._parseColor(e.brightYellow,t.DEFAULT_ANSI_COLORS[11]),this.colors.ansi[12]=this._parseColor(e.brightBlue,t.DEFAULT_ANSI_COLORS[12]),this.colors.ansi[13]=this._parseColor(e.brightMagenta,t.DEFAULT_ANSI_COLORS[13]),this.colors.ansi[14]=this._parseColor(e.brightCyan,t.DEFAULT_ANSI_COLORS[14]),this.colors.ansi[15]=this._parseColor(e.brightWhite,t.DEFAULT_ANSI_COLORS[15]),this._contrastCache.clear()},e.prototype._parseColor=function(e,t,r){if(void 0===r&&(r=this.allowTransparency),void 0===e)return t;if(this._ctx.fillStyle=this._litmusColor,this._ctx.fillStyle=e,"string"!=typeof this._ctx.fillStyle)return console.warn("Color: "+e+" is invalid using fallback "+t.css),t;this._ctx.fillRect(0,0,1,1);var n=this._ctx.getImageData(0,0,1,1).data;if(255!==n[3]){if(!r)return console.warn("Color: "+e+" is using transparency, but allowTransparency is false. Using fallback "+t.css+"."),t;var o=this._ctx.fillStyle.substring(5,this._ctx.fillStyle.length-1).split(",").map((function(e){return Number(e)})),s=o[0],a=o[1],c=o[2],l=o[3],h=Math.round(255*l);return{rgba:i.channels.toRgba(s,a,c,h),css:e}}return{css:this._ctx.fillStyle,rgba:i.channels.toRgba(n[0],n[1],n[2],n[3])}},e}();t.ColorManager=h},9631:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeElementFromParent=void 0,t.removeElementFromParent=function(){for(var e,t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];for(var i=0,n=t;i<n.length;i++){var o=n[i];null===(e=null==o?void 0:o.parentElement)||void 0===e||e.removeChild(o)}}},3656:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.addDisposableDomListener=void 0,t.addDisposableDomListener=function(e,t,r,i){e.addEventListener(t,r,i);var n=!1;return{dispose:function(){n||(n=!0,e.removeEventListener(t,r,i))}}}},3551:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MouseZone=t.Linkifier=void 0;var o=r(8460),s=r(2585),a=function(){function e(e,t,r){this._bufferService=e,this._logService=t,this._unicodeService=r,this._linkMatchers=[],this._nextLinkMatcherId=0,this._onShowLinkUnderline=new o.EventEmitter,this._onHideLinkUnderline=new o.EventEmitter,this._onLinkTooltip=new o.EventEmitter,this._rowsToLinkify={start:void 0,end:void 0}}return Object.defineProperty(e.prototype,"onShowLinkUnderline",{get:function(){return this._onShowLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onHideLinkUnderline",{get:function(){return this._onHideLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onLinkTooltip",{get:function(){return this._onLinkTooltip.event},enumerable:!1,configurable:!0}),e.prototype.attachToDom=function(e,t){this._element=e,this._mouseZoneManager=t},e.prototype.linkifyRows=function(t,r){var i=this;this._mouseZoneManager&&(void 0===this._rowsToLinkify.start||void 0===this._rowsToLinkify.end?(this._rowsToLinkify.start=t,this._rowsToLinkify.end=r):(this._rowsToLinkify.start=Math.min(this._rowsToLinkify.start,t),this._rowsToLinkify.end=Math.max(this._rowsToLinkify.end,r)),this._mouseZoneManager.clearAll(t,r),this._rowsTimeoutId&&clearTimeout(this._rowsTimeoutId),this._rowsTimeoutId=setTimeout((function(){return i._linkifyRows()}),e._timeBeforeLatency))},e.prototype._linkifyRows=function(){this._rowsTimeoutId=void 0;var e=this._bufferService.buffer;if(void 0!==this._rowsToLinkify.start&&void 0!==this._rowsToLinkify.end){var t=e.ydisp+this._rowsToLinkify.start;if(!(t>=e.lines.length)){for(var r=e.ydisp+Math.min(this._rowsToLinkify.end,this._bufferService.rows)+1,i=Math.ceil(2e3/this._bufferService.cols),n=this._bufferService.buffer.iterator(!1,t,r,i,i);n.hasNext();)for(var o=n.next(),s=0;s<this._linkMatchers.length;s++)this._doLinkifyRow(o.range.first,o.content,this._linkMatchers[s]);this._rowsToLinkify.start=void 0,this._rowsToLinkify.end=void 0}}else this._logService.debug("_rowToLinkify was unset before _linkifyRows was called")},e.prototype.registerLinkMatcher=function(e,t,r){if(void 0===r&&(r={}),!t)throw new Error("handler must be defined");var i={id:this._nextLinkMatcherId++,regex:e,handler:t,matchIndex:r.matchIndex,validationCallback:r.validationCallback,hoverTooltipCallback:r.tooltipCallback,hoverLeaveCallback:r.leaveCallback,willLinkActivate:r.willLinkActivate,priority:r.priority||0};return this._addLinkMatcherToList(i),i.id},e.prototype._addLinkMatcherToList=function(e){if(0!==this._linkMatchers.length){for(var t=this._linkMatchers.length-1;t>=0;t--)if(e.priority<=this._linkMatchers[t].priority)return void this._linkMatchers.splice(t+1,0,e);this._linkMatchers.splice(0,0,e)}else this._linkMatchers.push(e)},e.prototype.deregisterLinkMatcher=function(e){for(var t=0;t<this._linkMatchers.length;t++)if(this._linkMatchers[t].id===e)return this._linkMatchers.splice(t,1),!0;return!1},e.prototype._doLinkifyRow=function(e,t,r){for(var i,n=this,o=new RegExp(r.regex.source,(r.regex.flags||"")+"g"),s=-1,a=function(){var a=i["number"!=typeof r.matchIndex?0:r.matchIndex];if(!a)return c._logService.debug("match found without corresponding matchIndex",i,r),"break";if(s=t.indexOf(a,s+1),o.lastIndex=s+a.length,s<0)return"break";var l=c._bufferService.buffer.stringIndexToBufferIndex(e,s);if(l[0]<0)return"break";var h=c._bufferService.buffer.lines.get(l[0]);if(!h)return"break";var u=h.getFg(l[1]),f=u?u>>9&511:void 0;r.validationCallback?r.validationCallback(a,(function(e){n._rowsTimeoutId||e&&n._addLink(l[1],l[0]-n._bufferService.buffer.ydisp,a,r,f)})):c._addLink(l[1],l[0]-c._bufferService.buffer.ydisp,a,r,f)},c=this;null!==(i=o.exec(t))&&"break"!==a(););},e.prototype._addLink=function(e,t,r,i,n){var o=this;if(this._mouseZoneManager&&this._element){var s=this._unicodeService.getStringCellWidth(r),a=e%this._bufferService.cols,l=t+Math.floor(e/this._bufferService.cols),h=(a+s)%this._bufferService.cols,u=l+Math.floor((a+s)/this._bufferService.cols);0===h&&(h=this._bufferService.cols,u--),this._mouseZoneManager.add(new c(a+1,l+1,h+1,u+1,(function(e){if(i.handler)return i.handler(e,r);var t=window.open();t?(t.opener=null,t.location.href=r):console.warn("Opening link blocked as opener could not be cleared")}),(function(){o._onShowLinkUnderline.fire(o._createLinkHoverEvent(a,l,h,u,n)),o._element.classList.add("xterm-cursor-pointer")}),(function(e){o._onLinkTooltip.fire(o._createLinkHoverEvent(a,l,h,u,n)),i.hoverTooltipCallback&&i.hoverTooltipCallback(e,r,{start:{x:a,y:l},end:{x:h,y:u}})}),(function(){o._onHideLinkUnderline.fire(o._createLinkHoverEvent(a,l,h,u,n)),o._element.classList.remove("xterm-cursor-pointer"),i.hoverLeaveCallback&&i.hoverLeaveCallback()}),(function(e){return!i.willLinkActivate||i.willLinkActivate(e,r)})))}},e.prototype._createLinkHoverEvent=function(e,t,r,i,n){return{x1:e,y1:t,x2:r,y2:i,cols:this._bufferService.cols,fg:n}},e._timeBeforeLatency=200,e=i([n(0,s.IBufferService),n(1,s.ILogService),n(2,s.IUnicodeService)],e)}();t.Linkifier=a;var c=function(e,t,r,i,n,o,s,a,c){this.x1=e,this.y1=t,this.x2=r,this.y2=i,this.clickCallback=n,this.hoverCallback=o,this.tooltipCallback=s,this.leaveCallback=a,this.willLinkActivate=c};t.MouseZone=c},6465:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.Linkifier2=void 0;var a=r(2585),c=r(8460),l=r(844),h=r(3656),u=function(e){function t(t){var r=e.call(this)||this;return r._bufferService=t,r._linkProviders=[],r._linkCacheDisposables=[],r._isMouseOut=!0,r._activeLine=-1,r._onShowLinkUnderline=r.register(new c.EventEmitter),r._onHideLinkUnderline=r.register(new c.EventEmitter),r.register(l.getDisposeArrayDisposable(r._linkCacheDisposables)),r}return n(t,e),Object.defineProperty(t.prototype,"onShowLinkUnderline",{get:function(){return this._onShowLinkUnderline.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onHideLinkUnderline",{get:function(){return this._onHideLinkUnderline.event},enumerable:!1,configurable:!0}),t.prototype.registerLinkProvider=function(e){var t=this;return this._linkProviders.push(e),{dispose:function(){var r=t._linkProviders.indexOf(e);-1!==r&&t._linkProviders.splice(r,1)}}},t.prototype.attachToDom=function(e,t,r){var i=this;this._element=e,this._mouseService=t,this._renderService=r,this.register(h.addDisposableDomListener(this._element,"mouseleave",(function(){i._isMouseOut=!0,i._clearCurrentLink()}))),this.register(h.addDisposableDomListener(this._element,"mousemove",this._onMouseMove.bind(this))),this.register(h.addDisposableDomListener(this._element,"click",this._onClick.bind(this)))},t.prototype._onMouseMove=function(e){if(this._lastMouseEvent=e,this._element&&this._mouseService){var t=this._positionFromMouseEvent(e,this._element,this._mouseService);if(t){this._isMouseOut=!1;for(var r=e.composedPath(),i=0;i<r.length;i++){var n=r[i];if(n.classList.contains("xterm"))break;if(n.classList.contains("xterm-hover"))return}this._lastBufferCell&&t.x===this._lastBufferCell.x&&t.y===this._lastBufferCell.y||(this._onHover(t),this._lastBufferCell=t)}}},t.prototype._onHover=function(e){if(this._activeLine!==e.y)return this._clearCurrentLink(),void this._askForLink(e,!1);this._currentLink&&this._linkAtPosition(this._currentLink.link,e)||(this._clearCurrentLink(),this._askForLink(e,!0))},t.prototype._askForLink=function(e,t){var r,i=this;this._activeProviderReplies&&t||(null===(r=this._activeProviderReplies)||void 0===r||r.forEach((function(e){null==e||e.forEach((function(e){e.link.dispose&&e.link.dispose()}))})),this._activeProviderReplies=new Map,this._activeLine=e.y);var n=!1;this._linkProviders.forEach((function(r,o){var s;t?(null===(s=i._activeProviderReplies)||void 0===s?void 0:s.get(o))&&(n=i._checkLinkProviderResult(o,e,n)):r.provideLinks(e.y,(function(t){var r,s;if(!i._isMouseOut){var a=null==t?void 0:t.map((function(e){return{link:e}}));null===(r=i._activeProviderReplies)||void 0===r||r.set(o,a),n=i._checkLinkProviderResult(o,e,n),(null===(s=i._activeProviderReplies)||void 0===s?void 0:s.size)===i._linkProviders.length&&i._removeIntersectingLinks(e.y,i._activeProviderReplies)}}))}))},t.prototype._removeIntersectingLinks=function(e,t){for(var r=new Set,i=0;i<t.size;i++){var n=t.get(i);if(n)for(var o=0;o<n.length;o++)for(var s=n[o],a=s.link.range.start.y<e?0:s.link.range.start.x,c=s.link.range.end.y>e?this._bufferService.cols:s.link.range.end.x,l=a;l<=c;l++){if(r.has(l)){n.splice(o--,1);break}r.add(l)}}},t.prototype._checkLinkProviderResult=function(e,t,r){var i,n=this;if(!this._activeProviderReplies)return r;for(var o=this._activeProviderReplies.get(e),s=!1,a=0;a<e;a++)this._activeProviderReplies.has(a)&&!this._activeProviderReplies.get(a)||(s=!0);if(!s&&o){var c=o.find((function(e){return n._linkAtPosition(e.link,t)}));c&&(r=!0,this._handleNewLink(c))}if(this._activeProviderReplies.size===this._linkProviders.length&&!r)for(a=0;a<this._activeProviderReplies.size;a++){var l=null===(i=this._activeProviderReplies.get(a))||void 0===i?void 0:i.find((function(e){return n._linkAtPosition(e.link,t)}));if(l){r=!0,this._handleNewLink(l);break}}return r},t.prototype._onClick=function(e){if(this._element&&this._mouseService&&this._currentLink){var t=this._positionFromMouseEvent(e,this._element,this._mouseService);t&&this._linkAtPosition(this._currentLink.link,t)&&this._currentLink.link.activate(e,this._currentLink.link.text)}},t.prototype._clearCurrentLink=function(e,t){this._element&&this._currentLink&&this._lastMouseEvent&&(!e||!t||this._currentLink.link.range.start.y>=e&&this._currentLink.link.range.end.y<=t)&&(this._linkLeave(this._element,this._currentLink.link,this._lastMouseEvent),this._currentLink=void 0,l.disposeArray(this._linkCacheDisposables))},t.prototype._handleNewLink=function(e){var t=this;if(this._element&&this._lastMouseEvent&&this._mouseService){var r=this._positionFromMouseEvent(this._lastMouseEvent,this._element,this._mouseService);r&&this._linkAtPosition(e.link,r)&&(this._currentLink=e,this._currentLink.state={decorations:{underline:void 0===e.link.decorations||e.link.decorations.underline,pointerCursor:void 0===e.link.decorations||e.link.decorations.pointerCursor},isHovered:!0},this._linkHover(this._element,e.link,this._lastMouseEvent),e.link.decorations={},Object.defineProperties(e.link.decorations,{pointerCursor:{get:function(){var e,r;return null===(r=null===(e=t._currentLink)||void 0===e?void 0:e.state)||void 0===r?void 0:r.decorations.pointerCursor},set:function(e){var r,i;(null===(r=t._currentLink)||void 0===r?void 0:r.state)&&t._currentLink.state.decorations.pointerCursor!==e&&(t._currentLink.state.decorations.pointerCursor=e,t._currentLink.state.isHovered&&(null===(i=t._element)||void 0===i||i.classList.toggle("xterm-cursor-pointer",e)))}},underline:{get:function(){var e,r;return null===(r=null===(e=t._currentLink)||void 0===e?void 0:e.state)||void 0===r?void 0:r.decorations.underline},set:function(r){var i,n,o;(null===(i=t._currentLink)||void 0===i?void 0:i.state)&&(null===(o=null===(n=t._currentLink)||void 0===n?void 0:n.state)||void 0===o?void 0:o.decorations.underline)!==r&&(t._currentLink.state.decorations.underline=r,t._currentLink.state.isHovered&&t._fireUnderlineEvent(e.link,r))}}}),this._renderService&&this._linkCacheDisposables.push(this._renderService.onRenderedBufferChange((function(e){var r=0===e.start?0:e.start+1+t._bufferService.buffer.ydisp;t._clearCurrentLink(r,e.end+1+t._bufferService.buffer.ydisp)}))))}},t.prototype._linkHover=function(e,t,r){var i;(null===(i=this._currentLink)||void 0===i?void 0:i.state)&&(this._currentLink.state.isHovered=!0,this._currentLink.state.decorations.underline&&this._fireUnderlineEvent(t,!0),this._currentLink.state.decorations.pointerCursor&&e.classList.add("xterm-cursor-pointer")),t.hover&&t.hover(r,t.text)},t.prototype._fireUnderlineEvent=function(e,t){var r=e.range,i=this._bufferService.buffer.ydisp,n=this._createLinkUnderlineEvent(r.start.x-1,r.start.y-i-1,r.end.x,r.end.y-i-1,void 0);(t?this._onShowLinkUnderline:this._onHideLinkUnderline).fire(n)},t.prototype._linkLeave=function(e,t,r){var i;(null===(i=this._currentLink)||void 0===i?void 0:i.state)&&(this._currentLink.state.isHovered=!1,this._currentLink.state.decorations.underline&&this._fireUnderlineEvent(t,!1),this._currentLink.state.decorations.pointerCursor&&e.classList.remove("xterm-cursor-pointer")),t.leave&&t.leave(r,t.text)},t.prototype._linkAtPosition=function(e,t){var r=e.range.start.y===e.range.end.y,i=e.range.start.y<t.y,n=e.range.end.y>t.y;return(r&&e.range.start.x<=t.x&&e.range.end.x>=t.x||i&&e.range.end.x>=t.x||n&&e.range.start.x<=t.x||i&&n)&&e.range.start.y<=t.y&&e.range.end.y>=t.y},t.prototype._positionFromMouseEvent=function(e,t,r){var i=r.getCoords(e,t,this._bufferService.cols,this._bufferService.rows);if(i)return{x:i[0],y:i[1]+this._bufferService.buffer.ydisp}},t.prototype._createLinkUnderlineEvent=function(e,t,r,i,n){return{x1:e,y1:t,x2:r,y2:i,cols:this._bufferService.cols,fg:n}},o([s(0,a.IBufferService)],t)}(l.Disposable);t.Linkifier2=u},9042:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.tooMuchOutput=t.promptLabel=void 0,t.promptLabel="Terminal input",t.tooMuchOutput="Too much output to announce, navigate to rows manually to read"},6954:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MouseZoneManager=void 0;var a=r(844),c=r(3656),l=r(4725),h=r(2585),u=function(e){function t(t,r,i,n,o,s){var a=e.call(this)||this;return a._element=t,a._screenElement=r,a._bufferService=i,a._mouseService=n,a._selectionService=o,a._optionsService=s,a._zones=[],a._areZonesActive=!1,a._lastHoverCoords=[void 0,void 0],a._initialSelectionLength=0,a.register(c.addDisposableDomListener(a._element,"mousedown",(function(e){return a._onMouseDown(e)}))),a._mouseMoveListener=function(e){return a._onMouseMove(e)},a._mouseLeaveListener=function(e){return a._onMouseLeave(e)},a._clickListener=function(e){return a._onClick(e)},a}return n(t,e),t.prototype.dispose=function(){e.prototype.dispose.call(this),this._deactivate()},t.prototype.add=function(e){this._zones.push(e),1===this._zones.length&&this._activate()},t.prototype.clearAll=function(e,t){if(0!==this._zones.length){e&&t||(e=0,t=this._bufferService.rows-1);for(var r=0;r<this._zones.length;r++){var i=this._zones[r];(i.y1>e&&i.y1<=t+1||i.y2>e&&i.y2<=t+1||i.y1<e&&i.y2>t+1)&&(this._currentZone&&this._currentZone===i&&(this._currentZone.leaveCallback(),this._currentZone=void 0),this._zones.splice(r--,1))}0===this._zones.length&&this._deactivate()}},t.prototype._activate=function(){this._areZonesActive||(this._areZonesActive=!0,this._element.addEventListener("mousemove",this._mouseMoveListener),this._element.addEventListener("mouseleave",this._mouseLeaveListener),this._element.addEventListener("click",this._clickListener))},t.prototype._deactivate=function(){this._areZonesActive&&(this._areZonesActive=!1,this._element.removeEventListener("mousemove",this._mouseMoveListener),this._element.removeEventListener("mouseleave",this._mouseLeaveListener),this._element.removeEventListener("click",this._clickListener))},t.prototype._onMouseMove=function(e){this._lastHoverCoords[0]===e.pageX&&this._lastHoverCoords[1]===e.pageY||(this._onHover(e),this._lastHoverCoords=[e.pageX,e.pageY])},t.prototype._onHover=function(e){var t=this,r=this._findZoneEventAt(e);r!==this._currentZone&&(this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=void 0,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout)),r&&(this._currentZone=r,r.hoverCallback&&r.hoverCallback(e),this._tooltipTimeout=window.setTimeout((function(){return t._onTooltip(e)}),this._optionsService.options.linkTooltipHoverDuration)))},t.prototype._onTooltip=function(e){this._tooltipTimeout=void 0;var t=this._findZoneEventAt(e);t&&t.tooltipCallback&&t.tooltipCallback(e)},t.prototype._onMouseDown=function(e){if(this._initialSelectionLength=this._getSelectionLength(),this._areZonesActive){var t=this._findZoneEventAt(e);(null==t?void 0:t.willLinkActivate(e))&&(e.preventDefault(),e.stopImmediatePropagation())}},t.prototype._onMouseLeave=function(e){this._currentZone&&(this._currentZone.leaveCallback(),this._currentZone=void 0,this._tooltipTimeout&&clearTimeout(this._tooltipTimeout))},t.prototype._onClick=function(e){var t=this._findZoneEventAt(e),r=this._getSelectionLength();t&&r===this._initialSelectionLength&&(t.clickCallback(e),e.preventDefault(),e.stopImmediatePropagation())},t.prototype._getSelectionLength=function(){var e=this._selectionService.selectionText;return e?e.length:0},t.prototype._findZoneEventAt=function(e){var t=this._mouseService.getCoords(e,this._screenElement,this._bufferService.cols,this._bufferService.rows);if(t)for(var r=t[0],i=t[1],n=0;n<this._zones.length;n++){var o=this._zones[n];if(o.y1===o.y2){if(i===o.y1&&r>=o.x1&&r<o.x2)return o}else if(i===o.y1&&r>=o.x1||i===o.y2&&r<o.x2||i>o.y1&&i<o.y2)return o}},o([s(2,h.IBufferService),s(3,l.IMouseService),s(4,l.ISelectionService),s(5,h.IOptionsService)],t)}(a.Disposable);t.MouseZoneManager=u},6193:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RenderDebouncer=void 0;var r=function(){function e(e){this._renderCallback=e}return e.prototype.dispose=function(){this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},e.prototype.refresh=function(e,t,r){var i=this;this._rowCount=r,e=void 0!==e?e:0,t=void 0!==t?t:this._rowCount-1,this._rowStart=void 0!==this._rowStart?Math.min(this._rowStart,e):e,this._rowEnd=void 0!==this._rowEnd?Math.max(this._rowEnd,t):t,this._animationFrame||(this._animationFrame=window.requestAnimationFrame((function(){return i._innerRefresh()})))},e.prototype._innerRefresh=function(){if(void 0!==this._rowStart&&void 0!==this._rowEnd&&void 0!==this._rowCount){var e=Math.max(this._rowStart,0),t=Math.min(this._rowEnd,this._rowCount-1);this._rowStart=void 0,this._rowEnd=void 0,this._animationFrame=void 0,this._renderCallback(e,t)}},e}();t.RenderDebouncer=r},5596:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.ScreenDprMonitor=void 0;var o=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._currentDevicePixelRatio=window.devicePixelRatio,t}return n(t,e),t.prototype.setListener=function(e){var t=this;this._listener&&this.clearListener(),this._listener=e,this._outerListener=function(){t._listener&&(t._listener(window.devicePixelRatio,t._currentDevicePixelRatio),t._updateDpr())},this._updateDpr()},t.prototype.dispose=function(){e.prototype.dispose.call(this),this.clearListener()},t.prototype._updateDpr=function(){var e;this._outerListener&&(null===(e=this._resolutionMediaMatchList)||void 0===e||e.removeListener(this._outerListener),this._currentDevicePixelRatio=window.devicePixelRatio,this._resolutionMediaMatchList=window.matchMedia("screen and (resolution: "+window.devicePixelRatio+"dppx)"),this._resolutionMediaMatchList.addListener(this._outerListener))},t.prototype.clearListener=function(){this._resolutionMediaMatchList&&this._listener&&this._outerListener&&(this._resolutionMediaMatchList.removeListener(this._outerListener),this._resolutionMediaMatchList=void 0,this._listener=void 0,this._outerListener=void 0)},t}(r(844).Disposable);t.ScreenDprMonitor=o},3236:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.Terminal=void 0;var o=r(2950),s=r(1680),a=r(3614),c=r(2584),l=r(5435),h=r(3525),u=r(3551),f=r(9312),_=r(6114),d=r(3656),p=r(9042),v=r(357),g=r(6954),y=r(4567),b=r(1296),S=r(7399),m=r(8460),C=r(8437),w=r(5680),E=r(3230),L=r(4725),A=r(428),R=r(8934),k=r(6465),x=r(5114),D=r(8969),T=r(4774),O="undefined"!=typeof window?window.document:null,M=function(e){function t(t){void 0===t&&(t={});var r=e.call(this,t)||this;return r.browser=_,r._keyDownHandled=!1,r._onCursorMove=new m.EventEmitter,r._onKey=new m.EventEmitter,r._onRender=new m.EventEmitter,r._onSelectionChange=new m.EventEmitter,r._onTitleChange=new m.EventEmitter,r._onFocus=new m.EventEmitter,r._onBlur=new m.EventEmitter,r._onA11yCharEmitter=new m.EventEmitter,r._onA11yTabEmitter=new m.EventEmitter,r._setup(),r.linkifier=r._instantiationService.createInstance(u.Linkifier),r.linkifier2=r.register(r._instantiationService.createInstance(k.Linkifier2)),r.register(r._inputHandler.onRequestBell((function(){return r.bell()}))),r.register(r._inputHandler.onRequestRefreshRows((function(e,t){return r.refresh(e,t)}))),r.register(r._inputHandler.onRequestReset((function(){return r.reset()}))),r.register(r._inputHandler.onRequestScroll((function(e,t){return r.scroll(e,t||void 0)}))),r.register(r._inputHandler.onRequestWindowsOptionsReport((function(e){return r._reportWindowsOptions(e)}))),r.register(r._inputHandler.onAnsiColorChange((function(e){return r._changeAnsiColor(e)}))),r.register(m.forwardEvent(r._inputHandler.onCursorMove,r._onCursorMove)),r.register(m.forwardEvent(r._inputHandler.onTitleChange,r._onTitleChange)),r.register(m.forwardEvent(r._inputHandler.onA11yChar,r._onA11yCharEmitter)),r.register(m.forwardEvent(r._inputHandler.onA11yTab,r._onA11yTabEmitter)),r.register(r._bufferService.onResize((function(e){return r._afterResize(e.cols,e.rows)}))),r}return n(t,e),Object.defineProperty(t.prototype,"options",{get:function(){return this.optionsService.options},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCursorMove",{get:function(){return this._onCursorMove.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onKey",{get:function(){return this._onKey.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRender",{get:function(){return this._onRender.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onSelectionChange",{get:function(){return this._onSelectionChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTitleChange",{get:function(){return this._onTitleChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onFocus",{get:function(){return this._onFocus.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBlur",{get:function(){return this._onBlur.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onA11yChar",{get:function(){return this._onA11yCharEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onA11yTab",{get:function(){return this._onA11yTabEmitter.event},enumerable:!1,configurable:!0}),t.prototype._changeAnsiColor=function(e){var t,r,i=this;this._colorManager&&(e.colors.forEach((function(e){var t=T.rgba.toColor(e.red,e.green,e.blue);i._colorManager.colors.ansi[e.colorIndex]=t})),null===(t=this._renderService)||void 0===t||t.setColors(this._colorManager.colors),null===(r=this.viewport)||void 0===r||r.onThemeChange(this._colorManager.colors))},t.prototype.dispose=function(){var t,r,i;this._isDisposed||(e.prototype.dispose.call(this),null===(t=this._renderService)||void 0===t||t.dispose(),this._customKeyEventHandler=void 0,this.write=function(){},null===(i=null===(r=this.element)||void 0===r?void 0:r.parentNode)||void 0===i||i.removeChild(this.element))},t.prototype._setup=function(){e.prototype._setup.call(this),this._customKeyEventHandler=void 0},Object.defineProperty(t.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!1,configurable:!0}),t.prototype.focus=function(){this.textarea&&this.textarea.focus({preventScroll:!0})},t.prototype._updateOptions=function(t){var r,i,n,o;switch(e.prototype._updateOptions.call(this,t),t){case"fontFamily":case"fontSize":null===(r=this._renderService)||void 0===r||r.clear(),null===(i=this._charSizeService)||void 0===i||i.measure();break;case"cursorBlink":case"cursorStyle":this.refresh(this.buffer.y,this.buffer.y);break;case"drawBoldTextInBrightColors":case"letterSpacing":case"lineHeight":case"fontWeight":case"fontWeightBold":case"minimumContrastRatio":this._renderService&&(this._renderService.clear(),this._renderService.onResize(this.cols,this.rows),this.refresh(0,this.rows-1));break;case"rendererType":this._renderService&&(this._renderService.setRenderer(this._createRenderer()),this._renderService.onResize(this.cols,this.rows));break;case"scrollback":null===(n=this.viewport)||void 0===n||n.syncScrollArea();break;case"screenReaderMode":this.optionsService.options.screenReaderMode?!this._accessibilityManager&&this._renderService&&(this._accessibilityManager=new y.AccessibilityManager(this,this._renderService)):(null===(o=this._accessibilityManager)||void 0===o||o.dispose(),this._accessibilityManager=void 0);break;case"tabStopWidth":this.buffers.setupTabStops();break;case"theme":this._setTheme(this.optionsService.options.theme)}},t.prototype._onTextAreaFocus=function(e){this._coreService.decPrivateModes.sendFocus&&this._coreService.triggerDataEvent(c.C0.ESC+"[I"),this.updateCursorStyle(e),this.element.classList.add("focus"),this._showCursor(),this._onFocus.fire()},t.prototype.blur=function(){var e;return null===(e=this.textarea)||void 0===e?void 0:e.blur()},t.prototype._onTextAreaBlur=function(){this.textarea.value="",this.refresh(this.buffer.y,this.buffer.y),this._coreService.decPrivateModes.sendFocus&&this._coreService.triggerDataEvent(c.C0.ESC+"[O"),this.element.classList.remove("focus"),this._onBlur.fire()},t.prototype._syncTextArea=function(){if(this.textarea&&this.buffer.isCursorInViewport&&!this._compositionHelper.isComposing){var e=Math.ceil(this._charSizeService.height*this.optionsService.options.lineHeight),t=this._bufferService.buffer.y*e,r=this._bufferService.buffer.x*this._charSizeService.width;this.textarea.style.left=r+"px",this.textarea.style.top=t+"px",this.textarea.style.width=this._charSizeService.width+"px",this.textarea.style.height=e+"px",this.textarea.style.lineHeight=e+"px",this.textarea.style.zIndex="-5"}},t.prototype._initGlobal=function(){var e=this;this._bindKeys(),this.register(d.addDisposableDomListener(this.element,"copy",(function(t){e.hasSelection()&&a.copyHandler(t,e._selectionService)})));var t=function(t){return a.handlePasteEvent(t,e.textarea,e._coreService)};this.register(d.addDisposableDomListener(this.textarea,"paste",t)),this.register(d.addDisposableDomListener(this.element,"paste",t)),_.isFirefox?this.register(d.addDisposableDomListener(this.element,"mousedown",(function(t){2===t.button&&a.rightClickHandler(t,e.textarea,e.screenElement,e._selectionService,e.options.rightClickSelectsWord)}))):this.register(d.addDisposableDomListener(this.element,"contextmenu",(function(t){a.rightClickHandler(t,e.textarea,e.screenElement,e._selectionService,e.options.rightClickSelectsWord)}))),_.isLinux&&this.register(d.addDisposableDomListener(this.element,"auxclick",(function(t){1===t.button&&a.moveTextAreaUnderMouseCursor(t,e.textarea,e.screenElement)})))},t.prototype._bindKeys=function(){var e=this;this.register(d.addDisposableDomListener(this.textarea,"keyup",(function(t){return e._keyUp(t)}),!0)),this.register(d.addDisposableDomListener(this.textarea,"keydown",(function(t){return e._keyDown(t)}),!0)),this.register(d.addDisposableDomListener(this.textarea,"keypress",(function(t){return e._keyPress(t)}),!0)),this.register(d.addDisposableDomListener(this.textarea,"compositionstart",(function(){return e._compositionHelper.compositionstart()}))),this.register(d.addDisposableDomListener(this.textarea,"compositionupdate",(function(t){return e._compositionHelper.compositionupdate(t)}))),this.register(d.addDisposableDomListener(this.textarea,"compositionend",(function(){return e._compositionHelper.compositionend()}))),this.register(this.onRender((function(){return e._compositionHelper.updateCompositionElements()}))),this.register(this.onRender((function(t){return e._queueLinkification(t.start,t.end)})))},t.prototype.open=function(e){var t=this;if(!e)throw new Error("Terminal requires a parent element.");e.isConnected||this._logService.debug("Terminal.open was called on an element that was not attached to the DOM"),this._document=e.ownerDocument,this.element=this._document.createElement("div"),this.element.dir="ltr",this.element.classList.add("terminal"),this.element.classList.add("xterm"),this.element.setAttribute("tabindex","0"),this.element.setAttribute("role","document"),e.appendChild(this.element);var r=O.createDocumentFragment();this._viewportElement=O.createElement("div"),this._viewportElement.classList.add("xterm-viewport"),r.appendChild(this._viewportElement),this._viewportScrollArea=O.createElement("div"),this._viewportScrollArea.classList.add("xterm-scroll-area"),this._viewportElement.appendChild(this._viewportScrollArea),this.screenElement=O.createElement("div"),this.screenElement.classList.add("xterm-screen"),this._helperContainer=O.createElement("div"),this._helperContainer.classList.add("xterm-helpers"),this.screenElement.appendChild(this._helperContainer),r.appendChild(this.screenElement),this.textarea=O.createElement("textarea"),this.textarea.classList.add("xterm-helper-textarea"),this.textarea.setAttribute("aria-label",p.promptLabel),this.textarea.setAttribute("aria-multiline","false"),this.textarea.setAttribute("autocorrect","off"),this.textarea.setAttribute("autocapitalize","off"),this.textarea.setAttribute("spellcheck","false"),this.textarea.tabIndex=0,this.register(d.addDisposableDomListener(this.textarea,"focus",(function(e){return t._onTextAreaFocus(e)}))),this.register(d.addDisposableDomListener(this.textarea,"blur",(function(){return t._onTextAreaBlur()}))),this._helperContainer.appendChild(this.textarea);var i=this._instantiationService.createInstance(x.CoreBrowserService,this.textarea);this._instantiationService.setService(L.ICoreBrowserService,i),this._charSizeService=this._instantiationService.createInstance(A.CharSizeService,this._document,this._helperContainer),this._instantiationService.setService(L.ICharSizeService,this._charSizeService),this._compositionView=O.createElement("div"),this._compositionView.classList.add("composition-view"),this._compositionHelper=this._instantiationService.createInstance(o.CompositionHelper,this.textarea,this._compositionView),this._helperContainer.appendChild(this._compositionView),this.element.appendChild(r),this._theme=this.options.theme||this._theme,this._colorManager=new w.ColorManager(O,this.options.allowTransparency),this.register(this.optionsService.onOptionChange((function(e){return t._colorManager.onOptionsChange(e)}))),this._colorManager.setTheme(this._theme);var n=this._createRenderer();this._renderService=this.register(this._instantiationService.createInstance(E.RenderService,n,this.rows,this.screenElement)),this._instantiationService.setService(L.IRenderService,this._renderService),this.register(this._renderService.onRenderedBufferChange((function(e){return t._onRender.fire(e)}))),this.onResize((function(e){return t._renderService.resize(e.cols,e.rows)})),this._soundService=this._instantiationService.createInstance(v.SoundService),this._instantiationService.setService(L.ISoundService,this._soundService),this._mouseService=this._instantiationService.createInstance(R.MouseService),this._instantiationService.setService(L.IMouseService,this._mouseService),this.viewport=this._instantiationService.createInstance(s.Viewport,(function(e,r){return t.scrollLines(e,r)}),this._viewportElement,this._viewportScrollArea),this.viewport.onThemeChange(this._colorManager.colors),this.register(this._inputHandler.onRequestSyncScrollBar((function(){return t.viewport.syncScrollArea()}))),this.register(this.viewport),this.register(this.onCursorMove((function(){t._renderService.onCursorMove(),t._syncTextArea()}))),this.register(this.onResize((function(){return t._renderService.onResize(t.cols,t.rows)}))),this.register(this.onBlur((function(){return t._renderService.onBlur()}))),this.register(this.onFocus((function(){return t._renderService.onFocus()}))),this.register(this._renderService.onDimensionsChange((function(){return t.viewport.syncScrollArea()}))),this._selectionService=this.register(this._instantiationService.createInstance(f.SelectionService,this.element,this.screenElement)),this._instantiationService.setService(L.ISelectionService,this._selectionService),this.register(this._selectionService.onRequestScrollLines((function(e){return t.scrollLines(e.amount,e.suppressScrollEvent)}))),this.register(this._selectionService.onSelectionChange((function(){return t._onSelectionChange.fire()}))),this.register(this._selectionService.onRequestRedraw((function(e){return t._renderService.onSelectionChanged(e.start,e.end,e.columnSelectMode)}))),this.register(this._selectionService.onLinuxMouseSelection((function(e){t.textarea.value=e,t.textarea.focus(),t.textarea.select()}))),this.register(this.onScroll((function(){t.viewport.syncScrollArea(),t._selectionService.refresh()}))),this.register(d.addDisposableDomListener(this._viewportElement,"scroll",(function(){return t._selectionService.refresh()}))),this._mouseZoneManager=this._instantiationService.createInstance(g.MouseZoneManager,this.element,this.screenElement),this.register(this._mouseZoneManager),this.register(this.onScroll((function(){return t._mouseZoneManager.clearAll()}))),this.linkifier.attachToDom(this.element,this._mouseZoneManager),this.linkifier2.attachToDom(this.element,this._mouseService,this._renderService),this.register(d.addDisposableDomListener(this.element,"mousedown",(function(e){return t._selectionService.onMouseDown(e)}))),this._coreMouseService.areMouseEventsActive?(this._selectionService.disable(),this.element.classList.add("enable-mouse-events")):this._selectionService.enable(),this.options.screenReaderMode&&(this._accessibilityManager=new y.AccessibilityManager(this,this._renderService)),this._charSizeService.measure(),this.refresh(0,this.rows-1),this._initGlobal(),this.bindMouse()},t.prototype._createRenderer=function(){switch(this.options.rendererType){case"canvas":return this._instantiationService.createInstance(h.Renderer,this._colorManager.colors,this.screenElement,this.linkifier,this.linkifier2);case"dom":return this._instantiationService.createInstance(b.DomRenderer,this._colorManager.colors,this.element,this.screenElement,this._viewportElement,this.linkifier,this.linkifier2);default:throw new Error('Unrecognized rendererType "'+this.options.rendererType+'"')}},t.prototype._setTheme=function(e){var t,r,i;this._theme=e,null===(t=this._colorManager)||void 0===t||t.setTheme(e),null===(r=this._renderService)||void 0===r||r.setColors(this._colorManager.colors),null===(i=this.viewport)||void 0===i||i.onThemeChange(this._colorManager.colors)},t.prototype.bindMouse=function(){var e=this,t=this,r=this.element;function i(e){var r,i,n=t._mouseService.getRawByteCoords(e,t.screenElement,t.cols,t.rows);if(!n)return!1;switch(e.overrideType||e.type){case"mousemove":i=32,void 0===e.buttons?(r=3,void 0!==e.button&&(r=e.button<3?e.button:3)):r=1&e.buttons?0:4&e.buttons?1:2&e.buttons?2:3;break;case"mouseup":i=0,r=e.button<3?e.button:3;break;case"mousedown":i=1,r=e.button<3?e.button:3;break;case"wheel":0!==e.deltaY&&(i=e.deltaY<0?0:1),r=4;break;default:return!1}return!(void 0===i||void 0===r||r>4)&&t._coreMouseService.triggerMouseEvent({col:n.x-33,row:n.y-33,button:r,action:i,ctrl:e.ctrlKey,alt:e.altKey,shift:e.shiftKey})}var n={mouseup:null,wheel:null,mousedrag:null,mousemove:null},o=function(t){return i(t),t.buttons||(e._document.removeEventListener("mouseup",n.mouseup),n.mousedrag&&e._document.removeEventListener("mousemove",n.mousedrag)),e.cancel(t)},s=function(t){return i(t),t.preventDefault(),e.cancel(t)},a=function(e){e.buttons&&i(e)},l=function(e){e.buttons||i(e)};this.register(this._coreMouseService.onProtocolChange((function(t){t?("debug"===e.optionsService.options.logLevel&&e._logService.debug("Binding to mouse events:",e._coreMouseService.explainEvents(t)),e.element.classList.add("enable-mouse-events"),e._selectionService.disable()):(e._logService.debug("Unbinding from mouse events."),e.element.classList.remove("enable-mouse-events"),e._selectionService.enable()),8&t?n.mousemove||(r.addEventListener("mousemove",l),n.mousemove=l):(r.removeEventListener("mousemove",n.mousemove),n.mousemove=null),16&t?n.wheel||(r.addEventListener("wheel",s,{passive:!1}),n.wheel=s):(r.removeEventListener("wheel",n.wheel),n.wheel=null),2&t?n.mouseup||(n.mouseup=o):(e._document.removeEventListener("mouseup",n.mouseup),n.mouseup=null),4&t?n.mousedrag||(n.mousedrag=a):(e._document.removeEventListener("mousemove",n.mousedrag),n.mousedrag=null)}))),this._coreMouseService.activeProtocol=this._coreMouseService.activeProtocol,this.register(d.addDisposableDomListener(r,"mousedown",(function(t){if(t.preventDefault(),e.focus(),e._coreMouseService.areMouseEventsActive&&!e._selectionService.shouldForceSelection(t))return i(t),n.mouseup&&e._document.addEventListener("mouseup",n.mouseup),n.mousedrag&&e._document.addEventListener("mousemove",n.mousedrag),e.cancel(t)}))),this.register(d.addDisposableDomListener(r,"wheel",(function(t){if(n.wheel);else if(!e.buffer.hasScrollback){var r=e.viewport.getLinesScrolled(t);if(0===r)return;for(var i=c.C0.ESC+(e._coreService.decPrivateModes.applicationCursorKeys?"O":"[")+(t.deltaY<0?"A":"B"),o="",s=0;s<Math.abs(r);s++)o+=i;e._coreService.triggerDataEvent(o,!0)}}),{passive:!0})),this.register(d.addDisposableDomListener(r,"wheel",(function(t){if(!n.wheel)return e.viewport.onWheel(t)?void 0:e.cancel(t)}),{passive:!1})),this.register(d.addDisposableDomListener(r,"touchstart",(function(t){if(!e._coreMouseService.areMouseEventsActive)return e.viewport.onTouchStart(t),e.cancel(t)}),{passive:!0})),this.register(d.addDisposableDomListener(r,"touchmove",(function(t){if(!e._coreMouseService.areMouseEventsActive)return e.viewport.onTouchMove(t)?void 0:e.cancel(t)}),{passive:!1}))},t.prototype.refresh=function(e,t){var r;null===(r=this._renderService)||void 0===r||r.refreshRows(e,t)},t.prototype._queueLinkification=function(e,t){var r;null===(r=this.linkifier)||void 0===r||r.linkifyRows(e,t)},t.prototype.updateCursorStyle=function(e){this._selectionService&&this._selectionService.shouldColumnSelect(e)?this.element.classList.add("column-select"):this.element.classList.remove("column-select")},t.prototype._showCursor=function(){this._coreService.isCursorInitialized||(this._coreService.isCursorInitialized=!0,this.refresh(this.buffer.y,this.buffer.y))},t.prototype.scrollLines=function(t,r){e.prototype.scrollLines.call(this,t,r),this.refresh(0,this.rows-1)},t.prototype.paste=function(e){a.paste(e,this.textarea,this._coreService)},t.prototype.attachCustomKeyEventHandler=function(e){this._customKeyEventHandler=e},t.prototype.registerLinkMatcher=function(e,t,r){var i=this.linkifier.registerLinkMatcher(e,t,r);return this.refresh(0,this.rows-1),i},t.prototype.deregisterLinkMatcher=function(e){this.linkifier.deregisterLinkMatcher(e)&&this.refresh(0,this.rows-1)},t.prototype.registerLinkProvider=function(e){return this.linkifier2.registerLinkProvider(e)},t.prototype.registerCharacterJoiner=function(e){var t=this._renderService.registerCharacterJoiner(e);return this.refresh(0,this.rows-1),t},t.prototype.deregisterCharacterJoiner=function(e){this._renderService.deregisterCharacterJoiner(e)&&this.refresh(0,this.rows-1)},Object.defineProperty(t.prototype,"markers",{get:function(){return this.buffer.markers},enumerable:!1,configurable:!0}),t.prototype.addMarker=function(e){if(this.buffer===this.buffers.normal)return this.buffer.addMarker(this.buffer.ybase+this.buffer.y+e)},t.prototype.hasSelection=function(){return!!this._selectionService&&this._selectionService.hasSelection},t.prototype.select=function(e,t,r){this._selectionService.setSelection(e,t,r)},t.prototype.getSelection=function(){return this._selectionService?this._selectionService.selectionText:""},t.prototype.getSelectionPosition=function(){if(this._selectionService&&this._selectionService.hasSelection)return{startColumn:this._selectionService.selectionStart[0],startRow:this._selectionService.selectionStart[1],endColumn:this._selectionService.selectionEnd[0],endRow:this._selectionService.selectionEnd[1]}},t.prototype.clearSelection=function(){var e;null===(e=this._selectionService)||void 0===e||e.clearSelection()},t.prototype.selectAll=function(){var e;null===(e=this._selectionService)||void 0===e||e.selectAll()},t.prototype.selectLines=function(e,t){var r;null===(r=this._selectionService)||void 0===r||r.selectLines(e,t)},t.prototype._keyDown=function(e){if(this._keyDownHandled=!1,this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(!this._compositionHelper.keydown(e))return this.buffer.ybase!==this.buffer.ydisp&&this.scrollToBottom(),!1;var t=S.evaluateKeyboardEvent(e,this._coreService.decPrivateModes.applicationCursorKeys,this.browser.isMac,this.options.macOptionIsMeta);if(this.updateCursorStyle(e),3===t.type||2===t.type){var r=this.rows-1;return this.scrollLines(2===t.type?-r:r),this.cancel(e,!0)}return 1===t.type&&this.selectAll(),!!this._isThirdLevelShift(this.browser,e)||(t.cancel&&this.cancel(e,!0),!t.key||(t.key!==c.C0.ETX&&t.key!==c.C0.CR||(this.textarea.value=""),this._onKey.fire({key:t.key,domEvent:e}),this._showCursor(),this._coreService.triggerDataEvent(t.key,!0),this.optionsService.options.screenReaderMode?void(this._keyDownHandled=!0):this.cancel(e,!0)))},t.prototype._isThirdLevelShift=function(e,t){var r=e.isMac&&!this.options.macOptionIsMeta&&t.altKey&&!t.ctrlKey&&!t.metaKey||e.isWindows&&t.altKey&&t.ctrlKey&&!t.metaKey;return"keypress"===t.type?r:r&&(!t.keyCode||t.keyCode>47)},t.prototype._keyUp=function(e){this._customKeyEventHandler&&!1===this._customKeyEventHandler(e)||(function(e){return 16===e.keyCode||17===e.keyCode||18===e.keyCode}(e)||this.focus(),this.updateCursorStyle(e))},t.prototype._keyPress=function(e){var t;if(this._keyDownHandled)return!1;if(this._customKeyEventHandler&&!1===this._customKeyEventHandler(e))return!1;if(this.cancel(e),e.charCode)t=e.charCode;else if(null===e.which||void 0===e.which)t=e.keyCode;else{if(0===e.which||0===e.charCode)return!1;t=e.which}return!(!t||(e.altKey||e.ctrlKey||e.metaKey)&&!this._isThirdLevelShift(this.browser,e)||(t=String.fromCharCode(t),this._onKey.fire({key:t,domEvent:e}),this._showCursor(),this._coreService.triggerDataEvent(t,!0),0))},t.prototype.bell=function(){this._soundBell()&&this._soundService.playBellSound()},t.prototype.resize=function(t,r){t!==this.cols||r!==this.rows?e.prototype.resize.call(this,t,r):this._charSizeService&&!this._charSizeService.hasValidSize&&this._charSizeService.measure()},t.prototype._afterResize=function(e,t){var r,i;null===(r=this._charSizeService)||void 0===r||r.measure(),null===(i=this.viewport)||void 0===i||i.syncScrollArea(!0)},t.prototype.clear=function(){if(0!==this.buffer.ybase||0!==this.buffer.y){this.buffer.lines.set(0,this.buffer.lines.get(this.buffer.ybase+this.buffer.y)),this.buffer.lines.length=1,this.buffer.ydisp=0,this.buffer.ybase=0,this.buffer.y=0;for(var e=1;e<this.rows;e++)this.buffer.lines.push(this.buffer.getBlankLine(C.DEFAULT_ATTR_DATA));this.refresh(0,this.rows-1),this._onScroll.fire(this.buffer.ydisp)}},t.prototype.reset=function(){var t,r;this.options.rows=this.rows,this.options.cols=this.cols;var i=this._customKeyEventHandler;this._setup(),e.prototype.reset.call(this),null===(t=this._selectionService)||void 0===t||t.reset(),this._customKeyEventHandler=i,this.refresh(0,this.rows-1),null===(r=this.viewport)||void 0===r||r.syncScrollArea()},t.prototype._reportWindowsOptions=function(e){if(this._renderService)switch(e){case l.WindowsOptionsReportType.GET_WIN_SIZE_PIXELS:var t=this._renderService.dimensions.scaledCanvasWidth.toFixed(0),r=this._renderService.dimensions.scaledCanvasHeight.toFixed(0);this._coreService.triggerDataEvent(c.C0.ESC+"[4;"+r+";"+t+"t");break;case l.WindowsOptionsReportType.GET_CELL_SIZE_PIXELS:var i=this._renderService.dimensions.scaledCellWidth.toFixed(0),n=this._renderService.dimensions.scaledCellHeight.toFixed(0);this._coreService.triggerDataEvent(c.C0.ESC+"[6;"+n+";"+i+"t")}},t.prototype.cancel=function(e,t){if(this.options.cancelEvents||t)return e.preventDefault(),e.stopPropagation(),!1},t.prototype._visualBell=function(){return!1},t.prototype._soundBell=function(){return"sound"===this.options.bellStyle},t}(D.CoreTerminal);t.Terminal=M},1680:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.Viewport=void 0;var a=r(844),c=r(3656),l=r(4725),h=r(2585),u=function(e){function t(t,r,i,n,o,s,a){var l=e.call(this)||this;return l._scrollLines=t,l._viewportElement=r,l._scrollArea=i,l._bufferService=n,l._optionsService=o,l._charSizeService=s,l._renderService=a,l.scrollBarWidth=0,l._currentRowHeight=0,l._lastRecordedBufferLength=0,l._lastRecordedViewportHeight=0,l._lastRecordedBufferHeight=0,l._lastTouchY=0,l._lastScrollTop=0,l._wheelPartialScroll=0,l._refreshAnimationFrame=null,l._ignoreNextScrollEvent=!1,l.scrollBarWidth=l._viewportElement.offsetWidth-l._scrollArea.offsetWidth||15,l.register(c.addDisposableDomListener(l._viewportElement,"scroll",l._onScroll.bind(l))),setTimeout((function(){return l.syncScrollArea()}),0),l}return n(t,e),t.prototype.onThemeChange=function(e){this._viewportElement.style.backgroundColor=e.background.css},t.prototype._refresh=function(e){var t=this;if(e)return this._innerRefresh(),void(null!==this._refreshAnimationFrame&&cancelAnimationFrame(this._refreshAnimationFrame));null===this._refreshAnimationFrame&&(this._refreshAnimationFrame=requestAnimationFrame((function(){return t._innerRefresh()})))},t.prototype._innerRefresh=function(){if(this._charSizeService.height>0){this._currentRowHeight=this._renderService.dimensions.scaledCellHeight/window.devicePixelRatio,this._lastRecordedViewportHeight=this._viewportElement.offsetHeight;var e=Math.round(this._currentRowHeight*this._lastRecordedBufferLength)+(this._lastRecordedViewportHeight-this._renderService.dimensions.canvasHeight);this._lastRecordedBufferHeight!==e&&(this._lastRecordedBufferHeight=e,this._scrollArea.style.height=this._lastRecordedBufferHeight+"px")}var t=this._bufferService.buffer.ydisp*this._currentRowHeight;this._viewportElement.scrollTop!==t&&(this._ignoreNextScrollEvent=!0,this._viewportElement.scrollTop=t),this._refreshAnimationFrame=null},t.prototype.syncScrollArea=function(e){if(void 0===e&&(e=!1),this._lastRecordedBufferLength!==this._bufferService.buffer.lines.length)return this._lastRecordedBufferLength=this._bufferService.buffer.lines.length,void this._refresh(e);if(this._lastRecordedViewportHeight===this._renderService.dimensions.canvasHeight){var t=this._bufferService.buffer.ydisp*this._currentRowHeight;this._lastScrollTop===t&&this._lastScrollTop===this._viewportElement.scrollTop&&this._renderService.dimensions.scaledCellHeight/window.devicePixelRatio===this._currentRowHeight||this._refresh(e)}else this._refresh(e)},t.prototype._onScroll=function(e){if(this._lastScrollTop=this._viewportElement.scrollTop,this._viewportElement.offsetParent)if(this._ignoreNextScrollEvent)this._ignoreNextScrollEvent=!1;else{var t=Math.round(this._lastScrollTop/this._currentRowHeight)-this._bufferService.buffer.ydisp;this._scrollLines(t,!0)}},t.prototype._bubbleScroll=function(e,t){var r=this._viewportElement.scrollTop+this._lastRecordedViewportHeight;return!(t<0&&0!==this._viewportElement.scrollTop||t>0&&r<this._lastRecordedBufferHeight)||(e.cancelable&&e.preventDefault(),!1)},t.prototype.onWheel=function(e){var t=this._getPixelsScrolled(e);return 0!==t&&(this._viewportElement.scrollTop+=t,this._bubbleScroll(e,t))},t.prototype._getPixelsScrolled=function(e){if(0===e.deltaY)return 0;var t=this._applyScrollModifier(e.deltaY,e);return e.deltaMode===WheelEvent.DOM_DELTA_LINE?t*=this._currentRowHeight:e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._currentRowHeight*this._bufferService.rows),t},t.prototype.getLinesScrolled=function(e){if(0===e.deltaY)return 0;var t=this._applyScrollModifier(e.deltaY,e);return e.deltaMode===WheelEvent.DOM_DELTA_PIXEL?(t/=this._currentRowHeight+0,this._wheelPartialScroll+=t,t=Math.floor(Math.abs(this._wheelPartialScroll))*(this._wheelPartialScroll>0?1:-1),this._wheelPartialScroll%=1):e.deltaMode===WheelEvent.DOM_DELTA_PAGE&&(t*=this._bufferService.rows),t},t.prototype._applyScrollModifier=function(e,t){var r=this._optionsService.options.fastScrollModifier;return"alt"===r&&t.altKey||"ctrl"===r&&t.ctrlKey||"shift"===r&&t.shiftKey?e*this._optionsService.options.fastScrollSensitivity*this._optionsService.options.scrollSensitivity:e*this._optionsService.options.scrollSensitivity},t.prototype.onTouchStart=function(e){this._lastTouchY=e.touches[0].pageY},t.prototype.onTouchMove=function(e){var t=this._lastTouchY-e.touches[0].pageY;return this._lastTouchY=e.touches[0].pageY,0!==t&&(this._viewportElement.scrollTop+=t,this._bubbleScroll(e,t))},o([s(3,h.IBufferService),s(4,h.IOptionsService),s(5,l.ICharSizeService),s(6,l.IRenderService)],t)}(a.Disposable);t.Viewport=u},2950:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.CompositionHelper=void 0;var o=r(4725),s=r(2585),a=function(){function e(e,t,r,i,n,o){this._textarea=e,this._compositionView=t,this._bufferService=r,this._optionsService=i,this._charSizeService=n,this._coreService=o,this._isComposing=!1,this._isSendingComposition=!1,this._compositionPosition={start:0,end:0},this._dataAlreadySent=""}return Object.defineProperty(e.prototype,"isComposing",{get:function(){return this._isComposing},enumerable:!1,configurable:!0}),e.prototype.compositionstart=function(){this._isComposing=!0,this._compositionPosition.start=this._textarea.value.length,this._compositionView.textContent="",this._dataAlreadySent="",this._compositionView.classList.add("active")},e.prototype.compositionupdate=function(e){var t=this;this._compositionView.textContent=e.data,this.updateCompositionElements(),setTimeout((function(){t._compositionPosition.end=t._textarea.value.length}),0)},e.prototype.compositionend=function(){this._finalizeComposition(!0)},e.prototype.keydown=function(e){if(this._isComposing||this._isSendingComposition){if(229===e.keyCode)return!1;if(16===e.keyCode||17===e.keyCode||18===e.keyCode)return!1;this._finalizeComposition(!1)}return 229!==e.keyCode||(this._handleAnyTextareaChanges(),!1)},e.prototype._finalizeComposition=function(e){var t=this;if(this._compositionView.classList.remove("active"),this._isComposing=!1,e){var r={start:this._compositionPosition.start,end:this._compositionPosition.end};this._isSendingComposition=!0,setTimeout((function(){if(t._isSendingComposition){t._isSendingComposition=!1;var e;r.start+=t._dataAlreadySent.length,(e=t._isComposing?t._textarea.value.substring(r.start,r.end):t._textarea.value.substring(r.start)).length>0&&t._coreService.triggerDataEvent(e,!0)}}),0)}else{this._isSendingComposition=!1;var i=this._textarea.value.substring(this._compositionPosition.start,this._compositionPosition.end);this._coreService.triggerDataEvent(i,!0)}},e.prototype._handleAnyTextareaChanges=function(){var e=this,t=this._textarea.value;setTimeout((function(){if(!e._isComposing){var r=e._textarea.value.replace(t,"");r.length>0&&(e._dataAlreadySent=r,e._coreService.triggerDataEvent(r,!0))}}),0)},e.prototype.updateCompositionElements=function(e){var t=this;if(this._isComposing){if(this._bufferService.buffer.isCursorInViewport){var r=Math.ceil(this._charSizeService.height*this._optionsService.options.lineHeight),i=this._bufferService.buffer.y*r,n=this._bufferService.buffer.x*this._charSizeService.width;this._compositionView.style.left=n+"px",this._compositionView.style.top=i+"px",this._compositionView.style.height=r+"px",this._compositionView.style.lineHeight=r+"px",this._compositionView.style.fontFamily=this._optionsService.options.fontFamily,this._compositionView.style.fontSize=this._optionsService.options.fontSize+"px";var o=this._compositionView.getBoundingClientRect();this._textarea.style.left=n+"px",this._textarea.style.top=i+"px",this._textarea.style.width=o.width+"px",this._textarea.style.height=o.height+"px",this._textarea.style.lineHeight=o.height+"px"}e||setTimeout((function(){return t.updateCompositionElements(!0)}),0)}},i([n(2,s.IBufferService),n(3,s.IOptionsService),n(4,o.ICharSizeService),n(5,s.ICoreService)],e)}();t.CompositionHelper=a},9806:(e,t)=>{function r(e,t){var r=t.getBoundingClientRect();return[e.clientX-r.left,e.clientY-r.top]}Object.defineProperty(t,"__esModule",{value:!0}),t.getRawByteCoords=t.getCoords=t.getCoordsRelativeToElement=void 0,t.getCoordsRelativeToElement=r,t.getCoords=function(e,t,i,n,o,s,a,c){if(o){var l=r(e,t);if(l)return l[0]=Math.ceil((l[0]+(c?s/2:0))/s),l[1]=Math.ceil(l[1]/a),l[0]=Math.min(Math.max(l[0],1),i+(c?1:0)),l[1]=Math.min(Math.max(l[1],1),n),l}},t.getRawByteCoords=function(e){if(e)return{x:e[0]+32,y:e[1]+32}}},9504:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.moveToCellSequence=void 0;var i=r(2584);function n(e,t,r,i){var n=e-o(r,e),a=t-o(r,t);return l(Math.abs(n-a)-function(e,t,r){for(var i=0,n=e-o(r,e),a=t-o(r,t),c=0;c<Math.abs(n-a);c++){var l="A"===s(e,t)?-1:1,h=r.buffer.lines.get(n+l*c);h&&h.isWrapped&&i++}return i}(e,t,r),c(s(e,t),i))}function o(e,t){for(var r=0,i=e.buffer.lines.get(t),n=i&&i.isWrapped;n&&t>=0&&t<e.rows;)r++,n=(i=e.buffer.lines.get(--t))&&i.isWrapped;return r}function s(e,t){return e>t?"A":"B"}function a(e,t,r,i,n,o){for(var s=e,a=t,c="";s!==r||a!==i;)s+=n?1:-1,n&&s>o.cols-1?(c+=o.buffer.translateBufferLineToString(a,!1,e,s),s=0,e=0,a++):!n&&s<0&&(c+=o.buffer.translateBufferLineToString(a,!1,0,e+1),e=s=o.cols-1,a--);return c+o.buffer.translateBufferLineToString(a,!1,e,s)}function c(e,t){var r=t?"O":"[";return i.C0.ESC+r+e}function l(e,t){e=Math.floor(e);for(var r="",i=0;i<e;i++)r+=t;return r}t.moveToCellSequence=function(e,t,r,i){var s,h=r.buffer.x,u=r.buffer.y;if(!r.buffer.hasScrollback)return function(e,t,r,i,s,h){return 0===n(t,i,s,h).length?"":l(a(e,t,e,t-o(s,t),!1,s).length,c("D",h))}(h,u,0,t,r,i)+n(u,t,r,i)+function(e,t,r,i,s,h){var u;u=n(t,i,s,h).length>0?i-o(s,i):t;var f=i,_=function(e,t,r,i,s,a){var c;return c=n(r,i,s,a).length>0?i-o(s,i):t,e<r&&c<=i||e>=r&&c<i?"C":"D"}(e,t,r,i,s,h);return l(a(e,u,r,f,"C"===_,s).length,c(_,h))}(h,u,e,t,r,i);if(u===t)return s=h>e?"D":"C",l(Math.abs(h-e),c(s,i));s=u>t?"D":"C";var f=Math.abs(u-t);return l(function(e,t){return t.cols-e}(u>t?e:h,r)+(f-1)*r.cols+1+((u>t?h:e)-1),c(s,i))}},244:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AddonManager=void 0;var r=function(){function e(){this._addons=[]}return e.prototype.dispose=function(){for(var e=this._addons.length-1;e>=0;e--)this._addons[e].instance.dispose()},e.prototype.loadAddon=function(e,t){var r=this,i={instance:t,dispose:t.dispose,isDisposed:!1};this._addons.push(i),t.dispose=function(){return r._wrappedAddonDispose(i)},t.activate(e)},e.prototype._wrappedAddonDispose=function(e){if(!e.isDisposed){for(var t=-1,r=0;r<this._addons.length;r++)if(this._addons[r]===e){t=r;break}if(-1===t)throw new Error("Could not dispose an addon that has not been loaded");e.isDisposed=!0,e.dispose.apply(e.instance),this._addons.splice(t,1)}},e}();t.AddonManager=r},4389:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Terminal=void 0;var i=r(511),n=r(3236),o=r(9042),s=r(8460),a=r(244),c=function(){function e(e){this._core=new n.Terminal(e),this._addonManager=new a.AddonManager}return e.prototype._checkProposedApi=function(){if(!this._core.optionsService.options.allowProposedApi)throw new Error("You must set the allowProposedApi option to true to use proposed API")},Object.defineProperty(e.prototype,"onCursorMove",{get:function(){return this._core.onCursorMove},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onLineFeed",{get:function(){return this._core.onLineFeed},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onSelectionChange",{get:function(){return this._core.onSelectionChange},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onData",{get:function(){return this._core.onData},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onBinary",{get:function(){return this._core.onBinary},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onTitleChange",{get:function(){return this._core.onTitleChange},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onScroll",{get:function(){return this._core.onScroll},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onKey",{get:function(){return this._core.onKey},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onRender",{get:function(){return this._core.onRender},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onResize",{get:function(){return this._core.onResize},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"element",{get:function(){return this._core.element},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"parser",{get:function(){return this._checkProposedApi(),this._parser||(this._parser=new f(this._core)),this._parser},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"unicode",{get:function(){return this._checkProposedApi(),new _(this._core)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"textarea",{get:function(){return this._core.textarea},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rows",{get:function(){return this._core.rows},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cols",{get:function(){return this._core.cols},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"buffer",{get:function(){return this._checkProposedApi(),this._buffer||(this._buffer=new h(this._core)),this._buffer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"markers",{get:function(){return this._checkProposedApi(),this._core.markers},enumerable:!1,configurable:!0}),e.prototype.blur=function(){this._core.blur()},e.prototype.focus=function(){this._core.focus()},e.prototype.resize=function(e,t){this._verifyIntegers(e,t),this._core.resize(e,t)},e.prototype.open=function(e){this._core.open(e)},e.prototype.attachCustomKeyEventHandler=function(e){this._core.attachCustomKeyEventHandler(e)},e.prototype.registerLinkMatcher=function(e,t,r){return this._checkProposedApi(),this._core.registerLinkMatcher(e,t,r)},e.prototype.deregisterLinkMatcher=function(e){this._checkProposedApi(),this._core.deregisterLinkMatcher(e)},e.prototype.registerLinkProvider=function(e){return this._checkProposedApi(),this._core.registerLinkProvider(e)},e.prototype.registerCharacterJoiner=function(e){return this._checkProposedApi(),this._core.registerCharacterJoiner(e)},e.prototype.deregisterCharacterJoiner=function(e){this._checkProposedApi(),this._core.deregisterCharacterJoiner(e)},e.prototype.registerMarker=function(e){return this._checkProposedApi(),this._verifyIntegers(e),this._core.addMarker(e)},e.prototype.addMarker=function(e){return this.registerMarker(e)},e.prototype.hasSelection=function(){return this._core.hasSelection()},e.prototype.select=function(e,t,r){this._verifyIntegers(e,t,r),this._core.select(e,t,r)},e.prototype.getSelection=function(){return this._core.getSelection()},e.prototype.getSelectionPosition=function(){return this._core.getSelectionPosition()},e.prototype.clearSelection=function(){this._core.clearSelection()},e.prototype.selectAll=function(){this._core.selectAll()},e.prototype.selectLines=function(e,t){this._verifyIntegers(e,t),this._core.selectLines(e,t)},e.prototype.dispose=function(){this._addonManager.dispose(),this._core.dispose()},e.prototype.scrollLines=function(e){this._verifyIntegers(e),this._core.scrollLines(e)},e.prototype.scrollPages=function(e){this._verifyIntegers(e),this._core.scrollPages(e)},e.prototype.scrollToTop=function(){this._core.scrollToTop()},e.prototype.scrollToBottom=function(){this._core.scrollToBottom()},e.prototype.scrollToLine=function(e){this._verifyIntegers(e),this._core.scrollToLine(e)},e.prototype.clear=function(){this._core.clear()},e.prototype.write=function(e,t){this._core.write(e,t)},e.prototype.writeUtf8=function(e,t){this._core.write(e,t)},e.prototype.writeln=function(e,t){this._core.write(e),this._core.write("\r\n",t)},e.prototype.paste=function(e){this._core.paste(e)},e.prototype.getOption=function(e){return this._core.optionsService.getOption(e)},e.prototype.setOption=function(e,t){this._core.optionsService.setOption(e,t)},e.prototype.refresh=function(e,t){this._verifyIntegers(e,t),this._core.refresh(e,t)},e.prototype.reset=function(){this._core.reset()},e.prototype.loadAddon=function(e){return this._addonManager.loadAddon(this,e)},Object.defineProperty(e,"strings",{get:function(){return o},enumerable:!1,configurable:!0}),e.prototype._verifyIntegers=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var r=0,i=e;r<i.length;r++){var n=i[r];if(n===1/0||isNaN(n)||n%1!=0)throw new Error("This API only accepts integers")}},e}();t.Terminal=c;var l=function(){function e(e,t){this._buffer=e,this.type=t}return e.prototype.init=function(e){return this._buffer=e,this},Object.defineProperty(e.prototype,"cursorY",{get:function(){return this._buffer.y},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"cursorX",{get:function(){return this._buffer.x},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"viewportY",{get:function(){return this._buffer.ydisp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"baseY",{get:function(){return this._buffer.ybase},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._buffer.lines.length},enumerable:!1,configurable:!0}),e.prototype.getLine=function(e){var t=this._buffer.lines.get(e);if(t)return new u(t)},e.prototype.getNullCell=function(){return new i.CellData},e}(),h=function(){function e(e){var t=this;this._core=e,this._onBufferChange=new s.EventEmitter,this._normal=new l(this._core.buffers.normal,"normal"),this._alternate=new l(this._core.buffers.alt,"alternate"),this._core.buffers.onBufferActivate((function(){return t._onBufferChange.fire(t.active)}))}return Object.defineProperty(e.prototype,"onBufferChange",{get:function(){return this._onBufferChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"active",{get:function(){if(this._core.buffers.active===this._core.buffers.normal)return this.normal;if(this._core.buffers.active===this._core.buffers.alt)return this.alternate;throw new Error("Active buffer is neither normal nor alternate")},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"normal",{get:function(){return this._normal.init(this._core.buffers.normal)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"alternate",{get:function(){return this._alternate.init(this._core.buffers.alt)},enumerable:!1,configurable:!0}),e}(),u=function(){function e(e){this._line=e}return Object.defineProperty(e.prototype,"isWrapped",{get:function(){return this._line.isWrapped},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._line.length},enumerable:!1,configurable:!0}),e.prototype.getCell=function(e,t){if(!(e<0||e>=this._line.length))return t?(this._line.loadCell(e,t),t):this._line.loadCell(e,new i.CellData)},e.prototype.translateToString=function(e,t,r){return this._line.translateToString(e,t,r)},e}(),f=function(){function e(e){this._core=e}return e.prototype.registerCsiHandler=function(e,t){return this._core.addCsiHandler(e,(function(e){return t(e.toArray())}))},e.prototype.addCsiHandler=function(e,t){return this.registerCsiHandler(e,t)},e.prototype.registerDcsHandler=function(e,t){return this._core.addDcsHandler(e,(function(e,r){return t(e,r.toArray())}))},e.prototype.addDcsHandler=function(e,t){return this.registerDcsHandler(e,t)},e.prototype.registerEscHandler=function(e,t){return this._core.addEscHandler(e,t)},e.prototype.addEscHandler=function(e,t){return this.registerEscHandler(e,t)},e.prototype.registerOscHandler=function(e,t){return this._core.addOscHandler(e,t)},e.prototype.addOscHandler=function(e,t){return this.registerOscHandler(e,t)},e}(),_=function(){function e(e){this._core=e}return e.prototype.register=function(e){this._core.unicodeService.register(e)},Object.defineProperty(e.prototype,"versions",{get:function(){return this._core.unicodeService.versions},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeVersion",{get:function(){return this._core.unicodeService.activeVersion},set:function(e){this._core.unicodeService.activeVersion=e},enumerable:!1,configurable:!0}),e}()},1546:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseRenderLayer=void 0;var i=r(643),n=r(8803),o=r(1420),s=r(3734),a=r(1752),c=r(4774),l=r(9631),h=function(){function e(e,t,r,i,n,o,s,a){this._container=e,this._alpha=i,this._colors=n,this._rendererId=o,this._bufferService=s,this._optionsService=a,this._scaledCharWidth=0,this._scaledCharHeight=0,this._scaledCellWidth=0,this._scaledCellHeight=0,this._scaledCharLeft=0,this._scaledCharTop=0,this._currentGlyphIdentifier={chars:"",code:0,bg:0,fg:0,bold:!1,dim:!1,italic:!1},this._canvas=document.createElement("canvas"),this._canvas.classList.add("xterm-"+t+"-layer"),this._canvas.style.zIndex=r.toString(),this._initCanvas(),this._container.appendChild(this._canvas)}return e.prototype.dispose=function(){var e;l.removeElementFromParent(this._canvas),null===(e=this._charAtlas)||void 0===e||e.dispose()},e.prototype._initCanvas=function(){this._ctx=a.throwIfFalsy(this._canvas.getContext("2d",{alpha:this._alpha})),this._alpha||this._clearAll()},e.prototype.onOptionsChanged=function(){},e.prototype.onBlur=function(){},e.prototype.onFocus=function(){},e.prototype.onCursorMove=function(){},e.prototype.onGridChanged=function(e,t){},e.prototype.onSelectionChanged=function(e,t,r){void 0===r&&(r=!1)},e.prototype.setColors=function(e){this._refreshCharAtlas(e)},e.prototype._setTransparency=function(e){if(e!==this._alpha){var t=this._canvas;this._alpha=e,this._canvas=this._canvas.cloneNode(),this._initCanvas(),this._container.replaceChild(this._canvas,t),this._refreshCharAtlas(this._colors),this.onGridChanged(0,this._bufferService.rows-1)}},e.prototype._refreshCharAtlas=function(e){this._scaledCharWidth<=0&&this._scaledCharHeight<=0||(this._charAtlas=o.acquireCharAtlas(this._optionsService.options,this._rendererId,e,this._scaledCharWidth,this._scaledCharHeight),this._charAtlas.warmUp())},e.prototype.resize=function(e){this._scaledCellWidth=e.scaledCellWidth,this._scaledCellHeight=e.scaledCellHeight,this._scaledCharWidth=e.scaledCharWidth,this._scaledCharHeight=e.scaledCharHeight,this._scaledCharLeft=e.scaledCharLeft,this._scaledCharTop=e.scaledCharTop,this._canvas.width=e.scaledCanvasWidth,this._canvas.height=e.scaledCanvasHeight,this._canvas.style.width=e.canvasWidth+"px",this._canvas.style.height=e.canvasHeight+"px",this._alpha||this._clearAll(),this._refreshCharAtlas(this._colors)},e.prototype._fillCells=function(e,t,r,i){this._ctx.fillRect(e*this._scaledCellWidth,t*this._scaledCellHeight,r*this._scaledCellWidth,i*this._scaledCellHeight)},e.prototype._fillBottomLineAtCells=function(e,t,r){void 0===r&&(r=1),this._ctx.fillRect(e*this._scaledCellWidth,(t+1)*this._scaledCellHeight-window.devicePixelRatio-1,r*this._scaledCellWidth,window.devicePixelRatio)},e.prototype._fillLeftLineAtCell=function(e,t,r){this._ctx.fillRect(e*this._scaledCellWidth,t*this._scaledCellHeight,window.devicePixelRatio*r,this._scaledCellHeight)},e.prototype._strokeRectAtCell=function(e,t,r,i){this._ctx.lineWidth=window.devicePixelRatio,this._ctx.strokeRect(e*this._scaledCellWidth+window.devicePixelRatio/2,t*this._scaledCellHeight+window.devicePixelRatio/2,r*this._scaledCellWidth-window.devicePixelRatio,i*this._scaledCellHeight-window.devicePixelRatio)},e.prototype._clearAll=function(){this._alpha?this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(0,0,this._canvas.width,this._canvas.height))},e.prototype._clearCells=function(e,t,r,i){this._alpha?this._ctx.clearRect(e*this._scaledCellWidth,t*this._scaledCellHeight,r*this._scaledCellWidth,i*this._scaledCellHeight):(this._ctx.fillStyle=this._colors.background.css,this._ctx.fillRect(e*this._scaledCellWidth,t*this._scaledCellHeight,r*this._scaledCellWidth,i*this._scaledCellHeight))},e.prototype._fillCharTrueColor=function(e,t,r){this._ctx.font=this._getFont(!1,!1),this._ctx.textBaseline="middle",this._clipRow(r),this._ctx.fillText(e.getChars(),t*this._scaledCellWidth+this._scaledCharLeft,r*this._scaledCellHeight+this._scaledCharTop+this._scaledCharHeight/2)},e.prototype._drawChars=function(e,t,r){var o,s,a=this._getContrastColor(e);a||e.isFgRGB()||e.isBgRGB()?this._drawUncachedChars(e,t,r,a):(e.isInverse()?(o=e.isBgDefault()?n.INVERTED_DEFAULT_COLOR:e.getBgColor(),s=e.isFgDefault()?n.INVERTED_DEFAULT_COLOR:e.getFgColor()):(s=e.isBgDefault()?i.DEFAULT_COLOR:e.getBgColor(),o=e.isFgDefault()?i.DEFAULT_COLOR:e.getFgColor()),o+=this._optionsService.options.drawBoldTextInBrightColors&&e.isBold()&&o<8?8:0,this._currentGlyphIdentifier.chars=e.getChars()||i.WHITESPACE_CELL_CHAR,this._currentGlyphIdentifier.code=e.getCode()||i.WHITESPACE_CELL_CODE,this._currentGlyphIdentifier.bg=s,this._currentGlyphIdentifier.fg=o,this._currentGlyphIdentifier.bold=!!e.isBold(),this._currentGlyphIdentifier.dim=!!e.isDim(),this._currentGlyphIdentifier.italic=!!e.isItalic(),this._charAtlas&&this._charAtlas.draw(this._ctx,this._currentGlyphIdentifier,t*this._scaledCellWidth+this._scaledCharLeft,r*this._scaledCellHeight+this._scaledCharTop)||this._drawUncachedChars(e,t,r))},e.prototype._drawUncachedChars=function(e,t,r,i){if(this._ctx.save(),this._ctx.font=this._getFont(!!e.isBold(),!!e.isItalic()),this._ctx.textBaseline="middle",e.isInverse())if(i)this._ctx.fillStyle=i.css;else if(e.isBgDefault())this._ctx.fillStyle=c.color.opaque(this._colors.background).css;else if(e.isBgRGB())this._ctx.fillStyle="rgb("+s.AttributeData.toColorRGB(e.getBgColor()).join(",")+")";else{var o=e.getBgColor();this._optionsService.options.drawBoldTextInBrightColors&&e.isBold()&&o<8&&(o+=8),this._ctx.fillStyle=this._colors.ansi[o].css}else if(i)this._ctx.fillStyle=i.css;else if(e.isFgDefault())this._ctx.fillStyle=this._colors.foreground.css;else if(e.isFgRGB())this._ctx.fillStyle="rgb("+s.AttributeData.toColorRGB(e.getFgColor()).join(",")+")";else{var a=e.getFgColor();this._optionsService.options.drawBoldTextInBrightColors&&e.isBold()&&a<8&&(a+=8),this._ctx.fillStyle=this._colors.ansi[a].css}this._clipRow(r),e.isDim()&&(this._ctx.globalAlpha=n.DIM_OPACITY),this._ctx.fillText(e.getChars(),t*this._scaledCellWidth+this._scaledCharLeft,r*this._scaledCellHeight+this._scaledCharTop+this._scaledCharHeight/2),this._ctx.restore()},e.prototype._clipRow=function(e){this._ctx.beginPath(),this._ctx.rect(0,e*this._scaledCellHeight,this._bufferService.cols*this._scaledCellWidth,this._scaledCellHeight),this._ctx.clip()},e.prototype._getFont=function(e,t){return(t?"italic":"")+" "+(e?this._optionsService.options.fontWeightBold:this._optionsService.options.fontWeight)+" "+this._optionsService.options.fontSize*window.devicePixelRatio+"px "+this._optionsService.options.fontFamily},e.prototype._getContrastColor=function(e){if(1!==this._optionsService.options.minimumContrastRatio){var t=this._colors.contrastCache.getColor(e.bg,e.fg);if(void 0!==t)return t||void 0;var r=e.getFgColor(),i=e.getFgColorMode(),n=e.getBgColor(),o=e.getBgColorMode(),s=!!e.isInverse(),a=!!e.isInverse();if(s){var l=r;r=n,n=l;var h=i;i=o,o=h}var u=this._resolveBackgroundRgba(o,n,s),f=this._resolveForegroundRgba(i,r,s,a),_=c.rgba.ensureContrastRatio(u,f,this._optionsService.options.minimumContrastRatio);if(_){var d={css:c.channels.toCss(_>>24&255,_>>16&255,_>>8&255),rgba:_};return this._colors.contrastCache.setColor(e.bg,e.fg,d),d}this._colors.contrastCache.setColor(e.bg,e.fg,null)}},e.prototype._resolveBackgroundRgba=function(e,t,r){switch(e){case 16777216:case 33554432:return this._colors.ansi[t].rgba;case 50331648:return t<<8;case 0:default:return r?this._colors.foreground.rgba:this._colors.background.rgba}},e.prototype._resolveForegroundRgba=function(e,t,r,i){switch(e){case 16777216:case 33554432:return this._optionsService.options.drawBoldTextInBrightColors&&i&&t<8&&(t+=8),this._colors.ansi[t].rgba;case 50331648:return t<<8;case 0:default:return r?this._colors.background.rgba:this._colors.foreground.rgba}},e}();t.BaseRenderLayer=h},5879:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.CharacterJoinerRegistry=t.JoinedCellData=void 0;var o=r(3734),s=r(643),a=r(511),c=function(e){function t(t,r,i){var n=e.call(this)||this;return n.content=0,n.combinedData="",n.fg=t.fg,n.bg=t.bg,n.combinedData=r,n._width=i,n}return n(t,e),t.prototype.isCombined=function(){return 2097152},t.prototype.getWidth=function(){return this._width},t.prototype.getChars=function(){return this.combinedData},t.prototype.getCode=function(){return 2097151},t.prototype.setFromCharData=function(e){throw new Error("not implemented")},t.prototype.getAsCharData=function(){return[this.fg,this.getChars(),this.getWidth(),this.getCode()]},t}(o.AttributeData);t.JoinedCellData=c;var l=function(){function e(e){this._bufferService=e,this._characterJoiners=[],this._nextCharacterJoinerId=0,this._workCell=new a.CellData}return e.prototype.registerCharacterJoiner=function(e){var t={id:this._nextCharacterJoinerId++,handler:e};return this._characterJoiners.push(t),t.id},e.prototype.deregisterCharacterJoiner=function(e){for(var t=0;t<this._characterJoiners.length;t++)if(this._characterJoiners[t].id===e)return this._characterJoiners.splice(t,1),!0;return!1},e.prototype.getJoinedCharacters=function(e){if(0===this._characterJoiners.length)return[];var t=this._bufferService.buffer.lines.get(e);if(!t||0===t.length)return[];for(var r=[],i=t.translateToString(!0),n=0,o=0,a=0,c=t.getFg(0),l=t.getBg(0),h=0;h<t.getTrimmedLength();h++)if(t.loadCell(h,this._workCell),0!==this._workCell.getWidth()){if(this._workCell.fg!==c||this._workCell.bg!==l){if(h-n>1)for(var u=this._getJoinedRanges(i,a,o,t,n),f=0;f<u.length;f++)r.push(u[f]);n=h,a=o,c=this._workCell.fg,l=this._workCell.bg}o+=this._workCell.getChars().length||s.WHITESPACE_CELL_CHAR.length}if(this._bufferService.cols-n>1)for(u=this._getJoinedRanges(i,a,o,t,n),f=0;f<u.length;f++)r.push(u[f]);return r},e.prototype._getJoinedRanges=function(t,r,i,n,o){for(var s=t.substring(r,i),a=this._characterJoiners[0].handler(s),c=1;c<this._characterJoiners.length;c++)for(var l=this._characterJoiners[c].handler(s),h=0;h<l.length;h++)e._mergeRanges(a,l[h]);return this._stringRangesToCellRanges(a,n,o),a},e.prototype._stringRangesToCellRanges=function(e,t,r){var i=0,n=!1,o=0,a=e[i];if(a){for(var c=r;c<this._bufferService.cols;c++){var l=t.getWidth(c),h=t.getString(c).length||s.WHITESPACE_CELL_CHAR.length;if(0!==l){if(!n&&a[0]<=o&&(a[0]=c,n=!0),a[1]<=o){if(a[1]=c,!(a=e[++i]))break;a[0]<=o?(a[0]=c,n=!0):n=!1}o+=h}}a&&(a[1]=this._bufferService.cols)}},e._mergeRanges=function(e,t){for(var r=!1,i=0;i<e.length;i++){var n=e[i];if(r){if(t[1]<=n[0])return e[i-1][1]=t[1],e;if(t[1]<=n[1])return e[i-1][1]=Math.max(t[1],n[1]),e.splice(i,1),e;e.splice(i,1),i--}else{if(t[1]<=n[0])return e.splice(i,0,t),e;if(t[1]<=n[1])return n[0]=Math.min(t[0],n[0]),e;t[0]<n[1]&&(n[0]=Math.min(t[0],n[0]),r=!0)}}return r?e[e.length-1][1]=t[1]:e.push(t),e},e}();t.CharacterJoinerRegistry=l},2512:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.CursorRenderLayer=void 0;var o=r(1546),s=r(511),a=600,c=function(e){function t(t,r,i,n,o,a,c,l,h){var u=e.call(this,t,"cursor",r,!0,i,n,a,c)||this;return u._onRequestRedraw=o,u._coreService=l,u._coreBrowserService=h,u._cell=new s.CellData,u._state={x:0,y:0,isFocused:!1,style:"",width:0},u._cursorRenderers={bar:u._renderBarCursor.bind(u),block:u._renderBlockCursor.bind(u),underline:u._renderUnderlineCursor.bind(u)},u}return n(t,e),t.prototype.resize=function(t){e.prototype.resize.call(this,t),this._state={x:0,y:0,isFocused:!1,style:"",width:0}},t.prototype.reset=function(){this._clearCursor(),this._cursorBlinkStateManager&&(this._cursorBlinkStateManager.dispose(),this._cursorBlinkStateManager=void 0,this.onOptionsChanged())},t.prototype.onBlur=function(){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.pause(),this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},t.prototype.onFocus=function(){this._cursorBlinkStateManager?this._cursorBlinkStateManager.resume():this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},t.prototype.onOptionsChanged=function(){var e,t=this;this._optionsService.options.cursorBlink?this._cursorBlinkStateManager||(this._cursorBlinkStateManager=new l(this._coreBrowserService.isFocused,(function(){t._render(!0)}))):(null===(e=this._cursorBlinkStateManager)||void 0===e||e.dispose(),this._cursorBlinkStateManager=void 0),this._onRequestRedraw.fire({start:this._bufferService.buffer.y,end:this._bufferService.buffer.y})},t.prototype.onCursorMove=function(){this._cursorBlinkStateManager&&this._cursorBlinkStateManager.restartBlinkAnimation()},t.prototype.onGridChanged=function(e,t){!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isPaused?this._render(!1):this._cursorBlinkStateManager.restartBlinkAnimation()},t.prototype._render=function(e){if(this._coreService.isCursorInitialized&&!this._coreService.isCursorHidden){var t=this._bufferService.buffer.ybase+this._bufferService.buffer.y,r=t-this._bufferService.buffer.ydisp;if(r<0||r>=this._bufferService.rows)this._clearCursor();else{var i=Math.min(this._bufferService.buffer.x,this._bufferService.cols-1);if(this._bufferService.buffer.lines.get(t).loadCell(i,this._cell),void 0!==this._cell.content){if(!this._coreBrowserService.isFocused){this._clearCursor(),this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css;var n=this._optionsService.options.cursorStyle;return n&&"block"!==n?this._cursorRenderers[n](i,r,this._cell):this._renderBlurCursor(i,r,this._cell),this._ctx.restore(),this._state.x=i,this._state.y=r,this._state.isFocused=!1,this._state.style=n,void(this._state.width=this._cell.getWidth())}if(!this._cursorBlinkStateManager||this._cursorBlinkStateManager.isCursorVisible){if(this._state){if(this._state.x===i&&this._state.y===r&&this._state.isFocused===this._coreBrowserService.isFocused&&this._state.style===this._optionsService.options.cursorStyle&&this._state.width===this._cell.getWidth())return;this._clearCursor()}this._ctx.save(),this._cursorRenderers[this._optionsService.options.cursorStyle||"block"](i,r,this._cell),this._ctx.restore(),this._state.x=i,this._state.y=r,this._state.isFocused=!1,this._state.style=this._optionsService.options.cursorStyle,this._state.width=this._cell.getWidth()}else this._clearCursor()}}}else this._clearCursor()},t.prototype._clearCursor=function(){this._state&&(this._clearCells(this._state.x,this._state.y,this._state.width,1),this._state={x:0,y:0,isFocused:!1,style:"",width:0})},t.prototype._renderBarCursor=function(e,t,r){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillLeftLineAtCell(e,t,this._optionsService.options.cursorWidth),this._ctx.restore()},t.prototype._renderBlockCursor=function(e,t,r){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillCells(e,t,r.getWidth(),1),this._ctx.fillStyle=this._colors.cursorAccent.css,this._fillCharTrueColor(r,e,t),this._ctx.restore()},t.prototype._renderUnderlineCursor=function(e,t,r){this._ctx.save(),this._ctx.fillStyle=this._colors.cursor.css,this._fillBottomLineAtCells(e,t),this._ctx.restore()},t.prototype._renderBlurCursor=function(e,t,r){this._ctx.save(),this._ctx.strokeStyle=this._colors.cursor.css,this._strokeRectAtCell(e,t,r.getWidth(),1),this._ctx.restore()},t}(o.BaseRenderLayer);t.CursorRenderLayer=c;var l=function(){function e(e,t){this._renderCallback=t,this.isCursorVisible=!0,e&&this._restartInterval()}return Object.defineProperty(e.prototype,"isPaused",{get:function(){return!(this._blinkStartTimeout||this._blinkInterval)},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=void 0),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=void 0),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},e.prototype.restartBlinkAnimation=function(){var e=this;this.isPaused||(this._animationTimeRestarted=Date.now(),this.isCursorVisible=!0,this._animationFrame||(this._animationFrame=window.requestAnimationFrame((function(){e._renderCallback(),e._animationFrame=void 0}))))},e.prototype._restartInterval=function(e){var t=this;void 0===e&&(e=a),this._blinkInterval&&window.clearInterval(this._blinkInterval),this._blinkStartTimeout=window.setTimeout((function(){if(t._animationTimeRestarted){var e=a-(Date.now()-t._animationTimeRestarted);if(t._animationTimeRestarted=void 0,e>0)return void t._restartInterval(e)}t.isCursorVisible=!1,t._animationFrame=window.requestAnimationFrame((function(){t._renderCallback(),t._animationFrame=void 0})),t._blinkInterval=window.setInterval((function(){if(t._animationTimeRestarted){var e=a-(Date.now()-t._animationTimeRestarted);return t._animationTimeRestarted=void 0,void t._restartInterval(e)}t.isCursorVisible=!t.isCursorVisible,t._animationFrame=window.requestAnimationFrame((function(){t._renderCallback(),t._animationFrame=void 0}))}),a)}),e)},e.prototype.pause=function(){this.isCursorVisible=!0,this._blinkInterval&&(window.clearInterval(this._blinkInterval),this._blinkInterval=void 0),this._blinkStartTimeout&&(window.clearTimeout(this._blinkStartTimeout),this._blinkStartTimeout=void 0),this._animationFrame&&(window.cancelAnimationFrame(this._animationFrame),this._animationFrame=void 0)},e.prototype.resume=function(){this.pause(),this._animationTimeRestarted=void 0,this._restartInterval(),this.restartBlinkAnimation()},e}()},3700:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.GridCache=void 0;var r=function(){function e(){this.cache=[]}return e.prototype.resize=function(e,t){for(var r=0;r<e;r++){this.cache.length<=r&&this.cache.push([]);for(var i=this.cache[r].length;i<t;i++)this.cache[r].push(void 0);this.cache[r].length=t}this.cache.length=e},e.prototype.clear=function(){for(var e=0;e<this.cache.length;e++)for(var t=0;t<this.cache[e].length;t++)this.cache[e][t]=void 0},e}();t.GridCache=r},5098:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.LinkRenderLayer=void 0;var o=r(1546),s=r(8803),a=r(2040),c=function(e){function t(t,r,i,n,o,s,a,c){var l=e.call(this,t,"link",r,!0,i,n,a,c)||this;return o.onShowLinkUnderline((function(e){return l._onShowLinkUnderline(e)})),o.onHideLinkUnderline((function(e){return l._onHideLinkUnderline(e)})),s.onShowLinkUnderline((function(e){return l._onShowLinkUnderline(e)})),s.onHideLinkUnderline((function(e){return l._onHideLinkUnderline(e)})),l}return n(t,e),t.prototype.resize=function(t){e.prototype.resize.call(this,t),this._state=void 0},t.prototype.reset=function(){this._clearCurrentLink()},t.prototype._clearCurrentLink=function(){if(this._state){this._clearCells(this._state.x1,this._state.y1,this._state.cols-this._state.x1,1);var e=this._state.y2-this._state.y1-1;e>0&&this._clearCells(0,this._state.y1+1,this._state.cols,e),this._clearCells(0,this._state.y2,this._state.x2,1),this._state=void 0}},t.prototype._onShowLinkUnderline=function(e){if(e.fg===s.INVERTED_DEFAULT_COLOR?this._ctx.fillStyle=this._colors.background.css:e.fg&&a.is256Color(e.fg)?this._ctx.fillStyle=this._colors.ansi[e.fg].css:this._ctx.fillStyle=this._colors.foreground.css,e.y1===e.y2)this._fillBottomLineAtCells(e.x1,e.y1,e.x2-e.x1);else{this._fillBottomLineAtCells(e.x1,e.y1,e.cols-e.x1);for(var t=e.y1+1;t<e.y2;t++)this._fillBottomLineAtCells(0,t,e.cols);this._fillBottomLineAtCells(0,e.y2,e.x2)}this._state=e},t.prototype._onHideLinkUnderline=function(e){this._clearCurrentLink()},t}(o.BaseRenderLayer);t.LinkRenderLayer=c},3525:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;var a=r(9596),c=r(4149),l=r(2512),h=r(5098),u=r(5879),f=r(844),_=r(4725),d=r(2585),p=r(1420),v=r(8460),g=1,y=function(e){function t(t,r,i,n,o,s,f,_,d){var p=e.call(this)||this;p._colors=t,p._screenElement=r,p._bufferService=o,p._charSizeService=s,p._optionsService=f,p._id=g++,p._onRequestRedraw=new v.EventEmitter;var y=p._optionsService.options.allowTransparency;return p._characterJoinerRegistry=new u.CharacterJoinerRegistry(p._bufferService),p._renderLayers=[new a.TextRenderLayer(p._screenElement,0,p._colors,p._characterJoinerRegistry,y,p._id,p._bufferService,f),new c.SelectionRenderLayer(p._screenElement,1,p._colors,p._id,p._bufferService,f),new h.LinkRenderLayer(p._screenElement,2,p._colors,p._id,i,n,p._bufferService,f),new l.CursorRenderLayer(p._screenElement,3,p._colors,p._id,p._onRequestRedraw,p._bufferService,f,_,d)],p.dimensions={scaledCharWidth:0,scaledCharHeight:0,scaledCellWidth:0,scaledCellHeight:0,scaledCharLeft:0,scaledCharTop:0,scaledCanvasWidth:0,scaledCanvasHeight:0,canvasWidth:0,canvasHeight:0,actualCellWidth:0,actualCellHeight:0},p._devicePixelRatio=window.devicePixelRatio,p._updateDimensions(),p.onOptionsChanged(),p}return n(t,e),Object.defineProperty(t.prototype,"onRequestRedraw",{get:function(){return this._onRequestRedraw.event},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){for(var t=0,r=this._renderLayers;t<r.length;t++)r[t].dispose();e.prototype.dispose.call(this),p.removeTerminalFromCache(this._id)},t.prototype.onDevicePixelRatioChange=function(){this._devicePixelRatio!==window.devicePixelRatio&&(this._devicePixelRatio=window.devicePixelRatio,this.onResize(this._bufferService.cols,this._bufferService.rows))},t.prototype.setColors=function(e){this._colors=e;for(var t=0,r=this._renderLayers;t<r.length;t++){var i=r[t];i.setColors(this._colors),i.reset()}},t.prototype.onResize=function(e,t){this._updateDimensions();for(var r=0,i=this._renderLayers;r<i.length;r++)i[r].resize(this.dimensions);this._screenElement.style.width=this.dimensions.canvasWidth+"px",this._screenElement.style.height=this.dimensions.canvasHeight+"px"},t.prototype.onCharSizeChanged=function(){this.onResize(this._bufferService.cols,this._bufferService.rows)},t.prototype.onBlur=function(){this._runOperation((function(e){return e.onBlur()}))},t.prototype.onFocus=function(){this._runOperation((function(e){return e.onFocus()}))},t.prototype.onSelectionChanged=function(e,t,r){void 0===r&&(r=!1),this._runOperation((function(i){return i.onSelectionChanged(e,t,r)}))},t.prototype.onCursorMove=function(){this._runOperation((function(e){return e.onCursorMove()}))},t.prototype.onOptionsChanged=function(){this._runOperation((function(e){return e.onOptionsChanged()}))},t.prototype.clear=function(){this._runOperation((function(e){return e.reset()}))},t.prototype._runOperation=function(e){for(var t=0,r=this._renderLayers;t<r.length;t++)e(r[t])},t.prototype.renderRows=function(e,t){for(var r=0,i=this._renderLayers;r<i.length;r++)i[r].onGridChanged(e,t)},t.prototype._updateDimensions=function(){this._charSizeService.hasValidSize&&(this.dimensions.scaledCharWidth=Math.floor(this._charSizeService.width*window.devicePixelRatio),this.dimensions.scaledCharHeight=Math.ceil(this._charSizeService.height*window.devicePixelRatio),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._optionsService.options.lineHeight),this.dimensions.scaledCharTop=1===this._optionsService.options.lineHeight?0:Math.round((this.dimensions.scaledCellHeight-this.dimensions.scaledCharHeight)/2),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._optionsService.options.letterSpacing),this.dimensions.scaledCharLeft=Math.floor(this._optionsService.options.letterSpacing/2),this.dimensions.scaledCanvasHeight=this._bufferService.rows*this.dimensions.scaledCellHeight,this.dimensions.scaledCanvasWidth=this._bufferService.cols*this.dimensions.scaledCellWidth,this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._bufferService.rows,this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._bufferService.cols)},t.prototype.registerCharacterJoiner=function(e){return this._characterJoinerRegistry.registerCharacterJoiner(e)},t.prototype.deregisterCharacterJoiner=function(e){return this._characterJoinerRegistry.deregisterCharacterJoiner(e)},o([s(4,d.IBufferService),s(5,_.ICharSizeService),s(6,d.IOptionsService),s(7,d.ICoreService),s(8,_.ICoreBrowserService)],t)}(f.Disposable);t.Renderer=y},1752:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.throwIfFalsy=void 0,t.throwIfFalsy=function(e){if(!e)throw new Error("value must not be falsy");return e}},4149:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.SelectionRenderLayer=void 0;var o=function(e){function t(t,r,i,n,o,s){var a=e.call(this,t,"selection",r,!0,i,n,o,s)||this;return a._clearState(),a}return n(t,e),t.prototype._clearState=function(){this._state={start:void 0,end:void 0,columnSelectMode:void 0,ydisp:void 0}},t.prototype.resize=function(t){e.prototype.resize.call(this,t),this._clearState()},t.prototype.reset=function(){this._state.start&&this._state.end&&(this._clearState(),this._clearAll())},t.prototype.onSelectionChanged=function(e,t,r){if(this._didStateChange(e,t,r,this._bufferService.buffer.ydisp))if(this._clearAll(),e&&t){var i=e[1]-this._bufferService.buffer.ydisp,n=t[1]-this._bufferService.buffer.ydisp,o=Math.max(i,0),s=Math.min(n,this._bufferService.rows-1);if(o>=this._bufferService.rows||s<0)this._state.ydisp=this._bufferService.buffer.ydisp;else{if(this._ctx.fillStyle=this._colors.selectionTransparent.css,r){var a=e[0],c=t[0]-a,l=s-o+1;this._fillCells(a,o,c,l)}else{a=i===o?e[0]:0;var h=o===n?t[0]:this._bufferService.cols;this._fillCells(a,o,h-a,1);var u=Math.max(s-o-1,0);if(this._fillCells(0,o+1,this._bufferService.cols,u),o!==s){var f=n===s?t[0]:this._bufferService.cols;this._fillCells(0,s,f,1)}}this._state.start=[e[0],e[1]],this._state.end=[t[0],t[1]],this._state.columnSelectMode=r,this._state.ydisp=this._bufferService.buffer.ydisp}}else this._clearState()},t.prototype._didStateChange=function(e,t,r,i){return!this._areCoordinatesEqual(e,this._state.start)||!this._areCoordinatesEqual(t,this._state.end)||r!==this._state.columnSelectMode||i!==this._state.ydisp},t.prototype._areCoordinatesEqual=function(e,t){return!(!e||!t)&&e[0]===t[0]&&e[1]===t[1]},t}(r(1546).BaseRenderLayer);t.SelectionRenderLayer=o},9596:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.TextRenderLayer=void 0;var o=r(3700),s=r(1546),a=r(3734),c=r(643),l=r(5879),h=r(511),u=function(e){function t(t,r,i,n,s,a,c,l){var u=e.call(this,t,"text",r,s,i,a,c,l)||this;return u._characterWidth=0,u._characterFont="",u._characterOverlapCache={},u._workCell=new h.CellData,u._state=new o.GridCache,u._characterJoinerRegistry=n,u}return n(t,e),t.prototype.resize=function(t){e.prototype.resize.call(this,t);var r=this._getFont(!1,!1);this._characterWidth===t.scaledCharWidth&&this._characterFont===r||(this._characterWidth=t.scaledCharWidth,this._characterFont=r,this._characterOverlapCache={}),this._state.clear(),this._state.resize(this._bufferService.cols,this._bufferService.rows)},t.prototype.reset=function(){this._state.clear(),this._clearAll()},t.prototype._forEachCell=function(e,t,r,i){for(var n=e;n<=t;n++)for(var o=n+this._bufferService.buffer.ydisp,s=this._bufferService.buffer.lines.get(o),a=r?r.getJoinedCharacters(o):[],h=0;h<this._bufferService.cols;h++){s.loadCell(h,this._workCell);var u=this._workCell,f=!1,_=h;if(0!==u.getWidth()){if(a.length>0&&h===a[0][0]){f=!0;var d=a.shift();u=new l.JoinedCellData(this._workCell,s.translateToString(!0,d[0],d[1]),d[1]-d[0]),_=d[1]-1}!f&&this._isOverlapping(u)&&_<s.length-1&&s.getCodePoint(_+1)===c.NULL_CELL_CODE&&(u.content&=-12582913,u.content|=2<<22),i(u,h,n),h=_}}},t.prototype._drawBackground=function(e,t){var r=this,i=this._ctx,n=this._bufferService.cols,o=0,s=0,c=null;i.save(),this._forEachCell(e,t,null,(function(e,t,l){var h=null;e.isInverse()?h=e.isFgDefault()?r._colors.foreground.css:e.isFgRGB()?"rgb("+a.AttributeData.toColorRGB(e.getFgColor()).join(",")+")":r._colors.ansi[e.getFgColor()].css:e.isBgRGB()?h="rgb("+a.AttributeData.toColorRGB(e.getBgColor()).join(",")+")":e.isBgPalette()&&(h=r._colors.ansi[e.getBgColor()].css),null===c&&(o=t,s=l),l!==s?(i.fillStyle=c||"",r._fillCells(o,s,n-o,1),o=t,s=l):c!==h&&(i.fillStyle=c||"",r._fillCells(o,s,t-o,1),o=t,s=l),c=h})),null!==c&&(i.fillStyle=c,this._fillCells(o,s,n-o,1)),i.restore()},t.prototype._drawForeground=function(e,t){var r=this;this._forEachCell(e,t,this._characterJoinerRegistry,(function(e,t,i){if(!e.isInvisible()&&(r._drawChars(e,t,i),e.isUnderline())){if(r._ctx.save(),e.isInverse())if(e.isBgDefault())r._ctx.fillStyle=r._colors.background.css;else if(e.isBgRGB())r._ctx.fillStyle="rgb("+a.AttributeData.toColorRGB(e.getBgColor()).join(",")+")";else{var n=e.getBgColor();r._optionsService.options.drawBoldTextInBrightColors&&e.isBold()&&n<8&&(n+=8),r._ctx.fillStyle=r._colors.ansi[n].css}else if(e.isFgDefault())r._ctx.fillStyle=r._colors.foreground.css;else if(e.isFgRGB())r._ctx.fillStyle="rgb("+a.AttributeData.toColorRGB(e.getFgColor()).join(",")+")";else{var o=e.getFgColor();r._optionsService.options.drawBoldTextInBrightColors&&e.isBold()&&o<8&&(o+=8),r._ctx.fillStyle=r._colors.ansi[o].css}r._fillBottomLineAtCells(t,i,e.getWidth()),r._ctx.restore()}}))},t.prototype.onGridChanged=function(e,t){0!==this._state.cache.length&&(this._charAtlas&&this._charAtlas.beginFrame(),this._clearCells(0,e,this._bufferService.cols,t-e+1),this._drawBackground(e,t),this._drawForeground(e,t))},t.prototype.onOptionsChanged=function(){this._setTransparency(this._optionsService.options.allowTransparency)},t.prototype._isOverlapping=function(e){if(1!==e.getWidth())return!1;if(e.getCode()<256)return!1;var t=e.getChars();if(this._characterOverlapCache.hasOwnProperty(t))return this._characterOverlapCache[t];this._ctx.save(),this._ctx.font=this._characterFont;var r=Math.floor(this._ctx.measureText(t).width)>this._characterWidth;return this._ctx.restore(),this._characterOverlapCache[t]=r,r},t}(s.BaseRenderLayer);t.TextRenderLayer=u},9616:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BaseCharAtlas=void 0;var r=function(){function e(){this._didWarmUp=!1}return e.prototype.dispose=function(){},e.prototype.warmUp=function(){this._didWarmUp||(this._doWarmUp(),this._didWarmUp=!0)},e.prototype._doWarmUp=function(){},e.prototype.beginFrame=function(){},e}();t.BaseCharAtlas=r},1420:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.removeTerminalFromCache=t.acquireCharAtlas=void 0;var i=r(2040),n=r(1906),o=[];t.acquireCharAtlas=function(e,t,r,s,a){for(var c=i.generateConfig(s,a,e,r),l=0;l<o.length;l++){var h=(u=o[l]).ownedBy.indexOf(t);if(h>=0){if(i.configEquals(u.config,c))return u.atlas;1===u.ownedBy.length?(u.atlas.dispose(),o.splice(l,1)):u.ownedBy.splice(h,1);break}}for(l=0;l<o.length;l++){var u=o[l];if(i.configEquals(u.config,c))return u.ownedBy.push(t),u.atlas}var f={atlas:new n.DynamicCharAtlas(document,c),config:c,ownedBy:[t]};return o.push(f),f.atlas},t.removeTerminalFromCache=function(e){for(var t=0;t<o.length;t++){var r=o[t].ownedBy.indexOf(e);if(-1!==r){1===o[t].ownedBy.length?(o[t].atlas.dispose(),o.splice(t,1)):o[t].ownedBy.splice(r,1);break}}}},2040:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.is256Color=t.configEquals=t.generateConfig=void 0;var i=r(643);t.generateConfig=function(e,t,r,i){var n={foreground:i.foreground,background:i.background,cursor:void 0,cursorAccent:void 0,selection:void 0,ansi:i.ansi};return{devicePixelRatio:window.devicePixelRatio,scaledCharWidth:e,scaledCharHeight:t,fontFamily:r.fontFamily,fontSize:r.fontSize,fontWeight:r.fontWeight,fontWeightBold:r.fontWeightBold,allowTransparency:r.allowTransparency,colors:n}},t.configEquals=function(e,t){for(var r=0;r<e.colors.ansi.length;r++)if(e.colors.ansi[r].rgba!==t.colors.ansi[r].rgba)return!1;return e.devicePixelRatio===t.devicePixelRatio&&e.fontFamily===t.fontFamily&&e.fontSize===t.fontSize&&e.fontWeight===t.fontWeight&&e.fontWeightBold===t.fontWeightBold&&e.allowTransparency===t.allowTransparency&&e.scaledCharWidth===t.scaledCharWidth&&e.scaledCharHeight===t.scaledCharHeight&&e.colors.foreground===t.colors.foreground&&e.colors.background===t.colors.background},t.is256Color=function(e){return e<i.DEFAULT_COLOR}},8803:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CHAR_ATLAS_CELL_SPACING=t.DIM_OPACITY=t.INVERTED_DEFAULT_COLOR=void 0,t.INVERTED_DEFAULT_COLOR=257,t.DIM_OPACITY=.5,t.CHAR_ATLAS_CELL_SPACING=1},1906:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.NoneCharAtlas=t.DynamicCharAtlas=t.getGlyphCacheKey=void 0;var o=r(8803),s=r(9616),a=r(5680),c=r(7001),l=r(6114),h=r(1752),u=r(4774),f={css:"rgba(0, 0, 0, 0)",rgba:0};function _(e){return e.code<<21|e.bg<<12|e.fg<<3|(e.bold?0:4)+(e.dim?0:2)+(e.italic?0:1)}t.getGlyphCacheKey=_;var d=function(e){function t(t,r){var i=e.call(this)||this;i._config=r,i._drawToCacheCount=0,i._glyphsWaitingOnBitmap=[],i._bitmapCommitTimeout=null,i._bitmap=null,i._cacheCanvas=t.createElement("canvas"),i._cacheCanvas.width=1024,i._cacheCanvas.height=1024,i._cacheCtx=h.throwIfFalsy(i._cacheCanvas.getContext("2d",{alpha:!0}));var n=t.createElement("canvas");n.width=i._config.scaledCharWidth,n.height=i._config.scaledCharHeight,i._tmpCtx=h.throwIfFalsy(n.getContext("2d",{alpha:i._config.allowTransparency})),i._width=Math.floor(1024/i._config.scaledCharWidth),i._height=Math.floor(1024/i._config.scaledCharHeight);var o=i._width*i._height;return i._cacheMap=new c.LRUMap(o),i._cacheMap.prealloc(o),i}return n(t,e),t.prototype.dispose=function(){null!==this._bitmapCommitTimeout&&(window.clearTimeout(this._bitmapCommitTimeout),this._bitmapCommitTimeout=null)},t.prototype.beginFrame=function(){this._drawToCacheCount=0},t.prototype.draw=function(e,t,r,i){if(32===t.code)return!0;if(!this._canCache(t))return!1;var n=_(t),o=this._cacheMap.get(n);if(null!=o)return this._drawFromCache(e,o,r,i),!0;if(this._drawToCacheCount<100){var s;s=this._cacheMap.size<this._cacheMap.capacity?this._cacheMap.size:this._cacheMap.peek().index;var a=this._drawToCache(t,s);return this._cacheMap.set(n,a),this._drawFromCache(e,a,r,i),!0}return!1},t.prototype._canCache=function(e){return e.code<256},t.prototype._toCoordinateX=function(e){return e%this._width*this._config.scaledCharWidth},t.prototype._toCoordinateY=function(e){return Math.floor(e/this._width)*this._config.scaledCharHeight},t.prototype._drawFromCache=function(e,t,r,i){if(!t.isEmpty){var n=this._toCoordinateX(t.index),o=this._toCoordinateY(t.index);e.drawImage(t.inBitmap?this._bitmap:this._cacheCanvas,n,o,this._config.scaledCharWidth,this._config.scaledCharHeight,r,i,this._config.scaledCharWidth,this._config.scaledCharHeight)}},t.prototype._getColorFromAnsiIndex=function(e){return e<this._config.colors.ansi.length?this._config.colors.ansi[e]:a.DEFAULT_ANSI_COLORS[e]},t.prototype._getBackgroundColor=function(e){return this._config.allowTransparency?f:e.bg===o.INVERTED_DEFAULT_COLOR?this._config.colors.foreground:e.bg<256?this._getColorFromAnsiIndex(e.bg):this._config.colors.background},t.prototype._getForegroundColor=function(e){return e.fg===o.INVERTED_DEFAULT_COLOR?u.color.opaque(this._config.colors.background):e.fg<256?this._getColorFromAnsiIndex(e.fg):this._config.colors.foreground},t.prototype._drawToCache=function(e,t){this._drawToCacheCount++,this._tmpCtx.save();var r=this._getBackgroundColor(e);this._tmpCtx.globalCompositeOperation="copy",this._tmpCtx.fillStyle=r.css,this._tmpCtx.fillRect(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),this._tmpCtx.globalCompositeOperation="source-over";var i=e.bold?this._config.fontWeightBold:this._config.fontWeight,n=e.italic?"italic":"";this._tmpCtx.font=n+" "+i+" "+this._config.fontSize*this._config.devicePixelRatio+"px "+this._config.fontFamily,this._tmpCtx.textBaseline="middle",this._tmpCtx.fillStyle=this._getForegroundColor(e).css,e.dim&&(this._tmpCtx.globalAlpha=o.DIM_OPACITY),this._tmpCtx.fillText(e.chars,0,this._config.scaledCharHeight/2),this._tmpCtx.restore();var s=this._tmpCtx.getImageData(0,0,this._config.scaledCharWidth,this._config.scaledCharHeight),a=!1;this._config.allowTransparency||(a=function(e,t){for(var r=!0,i=t.rgba>>>24,n=t.rgba>>>16&255,o=t.rgba>>>8&255,s=0;s<e.data.length;s+=4)e.data[s]===i&&e.data[s+1]===n&&e.data[s+2]===o?e.data[s+3]=0:r=!1;return r}(s,r));var c=this._toCoordinateX(t),l=this._toCoordinateY(t);this._cacheCtx.putImageData(s,c,l);var h={index:t,isEmpty:a,inBitmap:!1};return this._addGlyphToBitmap(h),h},t.prototype._addGlyphToBitmap=function(e){var t=this;!("createImageBitmap"in window)||l.isFirefox||l.isSafari||(this._glyphsWaitingOnBitmap.push(e),null===this._bitmapCommitTimeout&&(this._bitmapCommitTimeout=window.setTimeout((function(){return t._generateBitmap()}),100)))},t.prototype._generateBitmap=function(){var e=this,t=this._glyphsWaitingOnBitmap;this._glyphsWaitingOnBitmap=[],window.createImageBitmap(this._cacheCanvas).then((function(r){e._bitmap=r;for(var i=0;i<t.length;i++)t[i].inBitmap=!0})),this._bitmapCommitTimeout=null},t}(s.BaseCharAtlas);t.DynamicCharAtlas=d;var p=function(e){function t(t,r){return e.call(this)||this}return n(t,e),t.prototype.draw=function(e,t,r,i){return!1},t}(s.BaseCharAtlas);t.NoneCharAtlas=p},7001:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LRUMap=void 0;var r=function(){function e(e){this.capacity=e,this._map={},this._head=null,this._tail=null,this._nodePool=[],this.size=0}return e.prototype._unlinkNode=function(e){var t=e.prev,r=e.next;e===this._head&&(this._head=r),e===this._tail&&(this._tail=t),null!==t&&(t.next=r),null!==r&&(r.prev=t)},e.prototype._appendNode=function(e){var t=this._tail;null!==t&&(t.next=e),e.prev=t,e.next=null,this._tail=e,null===this._head&&(this._head=e)},e.prototype.prealloc=function(e){for(var t=this._nodePool,r=0;r<e;r++)t.push({prev:null,next:null,key:null,value:null})},e.prototype.get=function(e){var t=this._map[e];return void 0!==t?(this._unlinkNode(t),this._appendNode(t),t.value):null},e.prototype.peekValue=function(e){var t=this._map[e];return void 0!==t?t.value:null},e.prototype.peek=function(){var e=this._head;return null===e?null:e.value},e.prototype.set=function(e,t){var r=this._map[e];if(void 0!==r)r=this._map[e],this._unlinkNode(r),r.value=t;else if(this.size>=this.capacity)r=this._head,this._unlinkNode(r),delete this._map[r.key],r.key=e,r.value=t,this._map[e]=r;else{var i=this._nodePool;i.length>0?((r=i.pop()).key=e,r.value=t):r={prev:null,next:null,key:e,value:t},this._map[e]=r,this.size++}this._appendNode(r)},e}();t.LRUMap=r},1296:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DomRenderer=void 0;var a=r(3787),c=r(8803),l=r(844),h=r(4725),u=r(2585),f=r(8460),_=r(4774),d=r(9631),p="xterm-dom-renderer-owner-",v="xterm-fg-",g="xterm-bg-",y="xterm-focus",b=1,S=function(e){function t(t,r,i,n,o,s,c,l,h){var u=e.call(this)||this;return u._colors=t,u._element=r,u._screenElement=i,u._viewportElement=n,u._linkifier=o,u._linkifier2=s,u._charSizeService=c,u._optionsService=l,u._bufferService=h,u._terminalClass=b++,u._rowElements=[],u._rowContainer=document.createElement("div"),u._rowContainer.classList.add("xterm-rows"),u._rowContainer.style.lineHeight="normal",u._rowContainer.setAttribute("aria-hidden","true"),u._refreshRowElements(u._bufferService.cols,u._bufferService.rows),u._selectionContainer=document.createElement("div"),u._selectionContainer.classList.add("xterm-selection"),u._selectionContainer.setAttribute("aria-hidden","true"),u.dimensions={scaledCharWidth:0,scaledCharHeight:0,scaledCellWidth:0,scaledCellHeight:0,scaledCharLeft:0,scaledCharTop:0,scaledCanvasWidth:0,scaledCanvasHeight:0,canvasWidth:0,canvasHeight:0,actualCellWidth:0,actualCellHeight:0},u._updateDimensions(),u._injectCss(),u._rowFactory=new a.DomRendererRowFactory(document,u._optionsService,u._colors),u._element.classList.add(p+u._terminalClass),u._screenElement.appendChild(u._rowContainer),u._screenElement.appendChild(u._selectionContainer),u._linkifier.onShowLinkUnderline((function(e){return u._onLinkHover(e)})),u._linkifier.onHideLinkUnderline((function(e){return u._onLinkLeave(e)})),u._linkifier2.onShowLinkUnderline((function(e){return u._onLinkHover(e)})),u._linkifier2.onHideLinkUnderline((function(e){return u._onLinkLeave(e)})),u}return n(t,e),Object.defineProperty(t.prototype,"onRequestRedraw",{get:function(){return(new f.EventEmitter).event},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._element.classList.remove(p+this._terminalClass),d.removeElementFromParent(this._rowContainer,this._selectionContainer,this._themeStyleElement,this._dimensionsStyleElement),e.prototype.dispose.call(this)},t.prototype._updateDimensions=function(){this.dimensions.scaledCharWidth=this._charSizeService.width*window.devicePixelRatio,this.dimensions.scaledCharHeight=Math.ceil(this._charSizeService.height*window.devicePixelRatio),this.dimensions.scaledCellWidth=this.dimensions.scaledCharWidth+Math.round(this._optionsService.options.letterSpacing),this.dimensions.scaledCellHeight=Math.floor(this.dimensions.scaledCharHeight*this._optionsService.options.lineHeight),this.dimensions.scaledCharLeft=0,this.dimensions.scaledCharTop=0,this.dimensions.scaledCanvasWidth=this.dimensions.scaledCellWidth*this._bufferService.cols,this.dimensions.scaledCanvasHeight=this.dimensions.scaledCellHeight*this._bufferService.rows,this.dimensions.canvasWidth=Math.round(this.dimensions.scaledCanvasWidth/window.devicePixelRatio),this.dimensions.canvasHeight=Math.round(this.dimensions.scaledCanvasHeight/window.devicePixelRatio),this.dimensions.actualCellWidth=this.dimensions.canvasWidth/this._bufferService.cols,this.dimensions.actualCellHeight=this.dimensions.canvasHeight/this._bufferService.rows;for(var e=0,t=this._rowElements;e<t.length;e++){var r=t[e];r.style.width=this.dimensions.canvasWidth+"px",r.style.height=this.dimensions.actualCellHeight+"px",r.style.lineHeight=this.dimensions.actualCellHeight+"px",r.style.overflow="hidden"}this._dimensionsStyleElement||(this._dimensionsStyleElement=document.createElement("style"),this._screenElement.appendChild(this._dimensionsStyleElement));var i=this._terminalSelector+" .xterm-rows span { display: inline-block; height: 100%; vertical-align: top; width: "+this.dimensions.actualCellWidth+"px}";this._dimensionsStyleElement.textContent=i,this._selectionContainer.style.height=this._viewportElement.style.height,this._screenElement.style.width=this.dimensions.canvasWidth+"px",this._screenElement.style.height=this.dimensions.canvasHeight+"px"},t.prototype.setColors=function(e){this._colors=e,this._injectCss()},t.prototype._injectCss=function(){var e=this;this._themeStyleElement||(this._themeStyleElement=document.createElement("style"),this._screenElement.appendChild(this._themeStyleElement));var t=this._terminalSelector+" .xterm-rows { color: "+this._colors.foreground.css+"; font-family: "+this._optionsService.options.fontFamily+"; font-size: "+this._optionsService.options.fontSize+"px;}";t+=this._terminalSelector+" span:not(."+a.BOLD_CLASS+") { font-weight: "+this._optionsService.options.fontWeight+";}"+this._terminalSelector+" span."+a.BOLD_CLASS+" { font-weight: "+this._optionsService.options.fontWeightBold+";}"+this._terminalSelector+" span."+a.ITALIC_CLASS+" { font-style: italic;}",t+="@keyframes blink_box_shadow_"+this._terminalClass+" { 50% {  box-shadow: none; }}",t+="@keyframes blink_block_"+this._terminalClass+" { 0% {  background-color: "+this._colors.cursor.css+";  color: "+this._colors.cursorAccent.css+"; } 50% {  background-color: "+this._colors.cursorAccent.css+";  color: "+this._colors.cursor.css+"; }}",t+=this._terminalSelector+" .xterm-rows:not(.xterm-focus) ."+a.CURSOR_CLASS+"."+a.CURSOR_STYLE_BLOCK_CLASS+" { outline: 1px solid "+this._colors.cursor.css+"; outline-offset: -1px;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+a.CURSOR_CLASS+"."+a.CURSOR_BLINK_CLASS+":not(."+a.CURSOR_STYLE_BLOCK_CLASS+") { animation: blink_box_shadow_"+this._terminalClass+" 1s step-end infinite;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+a.CURSOR_CLASS+"."+a.CURSOR_BLINK_CLASS+"."+a.CURSOR_STYLE_BLOCK_CLASS+" { animation: blink_block_"+this._terminalClass+" 1s step-end infinite;}"+this._terminalSelector+" .xterm-rows.xterm-focus ."+a.CURSOR_CLASS+"."+a.CURSOR_STYLE_BLOCK_CLASS+" { background-color: "+this._colors.cursor.css+"; color: "+this._colors.cursorAccent.css+";}"+this._terminalSelector+" .xterm-rows ."+a.CURSOR_CLASS+"."+a.CURSOR_STYLE_BAR_CLASS+" { box-shadow: "+this._optionsService.options.cursorWidth+"px 0 0 "+this._colors.cursor.css+" inset;}"+this._terminalSelector+" .xterm-rows ."+a.CURSOR_CLASS+"."+a.CURSOR_STYLE_UNDERLINE_CLASS+" { box-shadow: 0 -1px 0 "+this._colors.cursor.css+" inset;}",t+=this._terminalSelector+" .xterm-selection { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none;}"+this._terminalSelector+" .xterm-selection div { position: absolute; background-color: "+this._colors.selectionTransparent.css+";}",this._colors.ansi.forEach((function(r,i){t+=e._terminalSelector+" ."+v+i+" { color: "+r.css+"; }"+e._terminalSelector+" ."+g+i+" { background-color: "+r.css+"; }"})),t+=this._terminalSelector+" ."+v+c.INVERTED_DEFAULT_COLOR+" { color: "+_.color.opaque(this._colors.background).css+"; }"+this._terminalSelector+" ."+g+c.INVERTED_DEFAULT_COLOR+" { background-color: "+this._colors.foreground.css+"; }",this._themeStyleElement.textContent=t},t.prototype.onDevicePixelRatioChange=function(){this._updateDimensions()},t.prototype._refreshRowElements=function(e,t){for(var r=this._rowElements.length;r<=t;r++){var i=document.createElement("div");this._rowContainer.appendChild(i),this._rowElements.push(i)}for(;this._rowElements.length>t;)this._rowContainer.removeChild(this._rowElements.pop())},t.prototype.onResize=function(e,t){this._refreshRowElements(e,t),this._updateDimensions()},t.prototype.onCharSizeChanged=function(){this._updateDimensions()},t.prototype.onBlur=function(){this._rowContainer.classList.remove(y)},t.prototype.onFocus=function(){this._rowContainer.classList.add(y)},t.prototype.onSelectionChanged=function(e,t,r){for(;this._selectionContainer.children.length;)this._selectionContainer.removeChild(this._selectionContainer.children[0]);if(e&&t){var i=e[1]-this._bufferService.buffer.ydisp,n=t[1]-this._bufferService.buffer.ydisp,o=Math.max(i,0),s=Math.min(n,this._bufferService.rows-1);if(!(o>=this._bufferService.rows||s<0)){var a=document.createDocumentFragment();if(r)a.appendChild(this._createSelectionElement(o,e[0],t[0],s-o+1));else{var c=i===o?e[0]:0,l=o===n?t[0]:this._bufferService.cols;a.appendChild(this._createSelectionElement(o,c,l));var h=s-o-1;if(a.appendChild(this._createSelectionElement(o+1,0,this._bufferService.cols,h)),o!==s){var u=n===s?t[0]:this._bufferService.cols;a.appendChild(this._createSelectionElement(s,0,u))}}this._selectionContainer.appendChild(a)}}},t.prototype._createSelectionElement=function(e,t,r,i){void 0===i&&(i=1);var n=document.createElement("div");return n.style.height=i*this.dimensions.actualCellHeight+"px",n.style.top=e*this.dimensions.actualCellHeight+"px",n.style.left=t*this.dimensions.actualCellWidth+"px",n.style.width=this.dimensions.actualCellWidth*(r-t)+"px",n},t.prototype.onCursorMove=function(){},t.prototype.onOptionsChanged=function(){this._updateDimensions(),this._injectCss()},t.prototype.clear=function(){for(var e=0,t=this._rowElements;e<t.length;e++)t[e].innerText=""},t.prototype.renderRows=function(e,t){for(var r=this._bufferService.buffer.ybase+this._bufferService.buffer.y,i=Math.min(this._bufferService.buffer.x,this._bufferService.cols-1),n=this._optionsService.options.cursorBlink,o=e;o<=t;o++){var s=this._rowElements[o];s.innerText="";var a=o+this._bufferService.buffer.ydisp,c=this._bufferService.buffer.lines.get(a),l=this._optionsService.options.cursorStyle;s.appendChild(this._rowFactory.createRow(c,a===r,l,i,n,this.dimensions.actualCellWidth,this._bufferService.cols))}},Object.defineProperty(t.prototype,"_terminalSelector",{get:function(){return"."+p+this._terminalClass},enumerable:!1,configurable:!0}),t.prototype.registerCharacterJoiner=function(e){return-1},t.prototype.deregisterCharacterJoiner=function(e){return!1},t.prototype._onLinkHover=function(e){this._setCellUnderline(e.x1,e.x2,e.y1,e.y2,e.cols,!0)},t.prototype._onLinkLeave=function(e){this._setCellUnderline(e.x1,e.x2,e.y1,e.y2,e.cols,!1)},t.prototype._setCellUnderline=function(e,t,r,i,n,o){for(;e!==t||r!==i;){var s=this._rowElements[r];if(!s)return;var a=s.children[e];a&&(a.style.textDecoration=o?"underline":"none"),++e>=n&&(e=0,r++)}},o([s(6,h.ICharSizeService),s(7,u.IOptionsService),s(8,u.IBufferService)],t)}(l.Disposable);t.DomRenderer=S},3787:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DomRendererRowFactory=t.CURSOR_STYLE_UNDERLINE_CLASS=t.CURSOR_STYLE_BAR_CLASS=t.CURSOR_STYLE_BLOCK_CLASS=t.CURSOR_BLINK_CLASS=t.CURSOR_CLASS=t.UNDERLINE_CLASS=t.ITALIC_CLASS=t.DIM_CLASS=t.BOLD_CLASS=void 0;var i=r(8803),n=r(643),o=r(511),s=r(4774);t.BOLD_CLASS="xterm-bold",t.DIM_CLASS="xterm-dim",t.ITALIC_CLASS="xterm-italic",t.UNDERLINE_CLASS="xterm-underline",t.CURSOR_CLASS="xterm-cursor",t.CURSOR_BLINK_CLASS="xterm-cursor-blink",t.CURSOR_STYLE_BLOCK_CLASS="xterm-cursor-block",t.CURSOR_STYLE_BAR_CLASS="xterm-cursor-bar",t.CURSOR_STYLE_UNDERLINE_CLASS="xterm-cursor-underline";var a=function(){function e(e,t,r){this._document=e,this._optionsService=t,this._colors=r,this._workCell=new o.CellData}return e.prototype.setColors=function(e){this._colors=e},e.prototype.createRow=function(e,r,o,a,l,h,u){for(var f=this._document.createDocumentFragment(),_=0,d=Math.min(e.length,u)-1;d>=0;d--)if(e.loadCell(d,this._workCell).getCode()!==n.NULL_CELL_CODE||r&&d===a){_=d+1;break}for(d=0;d<_;d++){e.loadCell(d,this._workCell);var p=this._workCell.getWidth();if(0!==p){var v=this._document.createElement("span");if(p>1&&(v.style.width=h*p+"px"),r&&d===a)switch(v.classList.add(t.CURSOR_CLASS),l&&v.classList.add(t.CURSOR_BLINK_CLASS),o){case"bar":v.classList.add(t.CURSOR_STYLE_BAR_CLASS);break;case"underline":v.classList.add(t.CURSOR_STYLE_UNDERLINE_CLASS);break;default:v.classList.add(t.CURSOR_STYLE_BLOCK_CLASS)}this._workCell.isBold()&&v.classList.add(t.BOLD_CLASS),this._workCell.isItalic()&&v.classList.add(t.ITALIC_CLASS),this._workCell.isDim()&&v.classList.add(t.DIM_CLASS),this._workCell.isUnderline()&&v.classList.add(t.UNDERLINE_CLASS),this._workCell.isInvisible()?v.textContent=n.WHITESPACE_CELL_CHAR:v.textContent=this._workCell.getChars()||n.WHITESPACE_CELL_CHAR;var g=this._workCell.getFgColor(),y=this._workCell.getFgColorMode(),b=this._workCell.getBgColor(),S=this._workCell.getBgColorMode(),m=!!this._workCell.isInverse();if(m){var C=g;g=b,b=C;var w=y;y=S,S=w}switch(y){case 16777216:case 33554432:this._workCell.isBold()&&g<8&&this._optionsService.options.drawBoldTextInBrightColors&&(g+=8),this._applyMinimumContrast(v,this._colors.background,this._colors.ansi[g])||v.classList.add("xterm-fg-"+g);break;case 50331648:var E=s.rgba.toColor(g>>16&255,g>>8&255,255&g);this._applyMinimumContrast(v,this._colors.background,E)||this._addStyle(v,"color:#"+c(g.toString(16),"0",6));break;case 0:default:this._applyMinimumContrast(v,this._colors.background,this._colors.foreground)||m&&v.classList.add("xterm-fg-"+i.INVERTED_DEFAULT_COLOR)}switch(S){case 16777216:case 33554432:v.classList.add("xterm-bg-"+b);break;case 50331648:this._addStyle(v,"background-color:#"+c(b.toString(16),"0",6));break;case 0:default:m&&v.classList.add("xterm-bg-"+i.INVERTED_DEFAULT_COLOR)}f.appendChild(v)}}return f},e.prototype._applyMinimumContrast=function(e,t,r){if(1===this._optionsService.options.minimumContrastRatio)return!1;var i=this._colors.contrastCache.getColor(this._workCell.bg,this._workCell.fg);return void 0===i&&(i=s.color.ensureContrastRatio(t,r,this._optionsService.options.minimumContrastRatio),this._colors.contrastCache.setColor(this._workCell.bg,this._workCell.fg,null!=i?i:null)),!!i&&(this._addStyle(e,"color:"+i.css),!0)},e.prototype._addStyle=function(e,t){e.setAttribute("style",""+(e.getAttribute("style")||"")+t+";")},e}();function c(e,t,r){for(;e.length<r;)e=t+e;return e}t.DomRendererRowFactory=a},456:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SelectionModel=void 0;var r=function(){function e(e){this._bufferService=e,this.isSelectAllActive=!1,this.selectionStartLength=0}return e.prototype.clearSelection=function(){this.selectionStart=void 0,this.selectionEnd=void 0,this.isSelectAllActive=!1,this.selectionStartLength=0},Object.defineProperty(e.prototype,"finalSelectionStart",{get:function(){return this.isSelectAllActive?[0,0]:this.selectionEnd&&this.selectionStart&&this.areSelectionValuesReversed()?this.selectionEnd:this.selectionStart},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"finalSelectionEnd",{get:function(){if(this.isSelectAllActive)return[this._bufferService.cols,this._bufferService.buffer.ybase+this._bufferService.rows-1];if(this.selectionStart){if(!this.selectionEnd||this.areSelectionValuesReversed()){var e=this.selectionStart[0]+this.selectionStartLength;return e>this._bufferService.cols?[e%this._bufferService.cols,this.selectionStart[1]+Math.floor(e/this._bufferService.cols)]:[e,this.selectionStart[1]]}return this.selectionStartLength&&this.selectionEnd[1]===this.selectionStart[1]?[Math.max(this.selectionStart[0]+this.selectionStartLength,this.selectionEnd[0]),this.selectionEnd[1]]:this.selectionEnd}},enumerable:!1,configurable:!0}),e.prototype.areSelectionValuesReversed=function(){var e=this.selectionStart,t=this.selectionEnd;return!(!e||!t)&&(e[1]>t[1]||e[1]===t[1]&&e[0]>t[0])},e.prototype.onTrim=function(e){return this.selectionStart&&(this.selectionStart[1]-=e),this.selectionEnd&&(this.selectionEnd[1]-=e),this.selectionEnd&&this.selectionEnd[1]<0?(this.clearSelection(),!0):(this.selectionStart&&this.selectionStart[1]<0&&(this.selectionStart[1]=0),!1)},e}();t.SelectionModel=r},428:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.CharSizeService=void 0;var o=r(2585),s=r(8460),a=function(){function e(e,t,r){this._optionsService=r,this.width=0,this.height=0,this._onCharSizeChange=new s.EventEmitter,this._measureStrategy=new c(e,t,this._optionsService)}return Object.defineProperty(e.prototype,"hasValidSize",{get:function(){return this.width>0&&this.height>0},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onCharSizeChange",{get:function(){return this._onCharSizeChange.event},enumerable:!1,configurable:!0}),e.prototype.measure=function(){var e=this._measureStrategy.measure();e.width===this.width&&e.height===this.height||(this.width=e.width,this.height=e.height,this._onCharSizeChange.fire())},i([n(2,o.IOptionsService)],e)}();t.CharSizeService=a;var c=function(){function e(e,t,r){this._document=e,this._parentElement=t,this._optionsService=r,this._result={width:0,height:0},this._measureElement=this._document.createElement("span"),this._measureElement.classList.add("xterm-char-measure-element"),this._measureElement.textContent="W",this._measureElement.setAttribute("aria-hidden","true"),this._parentElement.appendChild(this._measureElement)}return e.prototype.measure=function(){this._measureElement.style.fontFamily=this._optionsService.options.fontFamily,this._measureElement.style.fontSize=this._optionsService.options.fontSize+"px";var e=this._measureElement.getBoundingClientRect();return 0!==e.width&&0!==e.height&&(this._result.width=e.width,this._result.height=Math.ceil(e.height)),this._result},e}()},5114:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CoreBrowserService=void 0;var r=function(){function e(e){this._textarea=e}return Object.defineProperty(e.prototype,"isFocused",{get:function(){return(this._textarea.getRootNode?this._textarea.getRootNode():document).activeElement===this._textarea&&document.hasFocus()},enumerable:!1,configurable:!0}),e}();t.CoreBrowserService=r},8934:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.MouseService=void 0;var o=r(4725),s=r(9806),a=function(){function e(e,t){this._renderService=e,this._charSizeService=t}return e.prototype.getCoords=function(e,t,r,i,n){return s.getCoords(e,t,r,i,this._charSizeService.hasValidSize,this._renderService.dimensions.actualCellWidth,this._renderService.dimensions.actualCellHeight,n)},e.prototype.getRawByteCoords=function(e,t,r,i){var n=this.getCoords(e,t,r,i);return s.getRawByteCoords(n)},i([n(0,o.IRenderService),n(1,o.ICharSizeService)],e)}();t.MouseService=a},3230:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.RenderService=void 0;var a=r(6193),c=r(8460),l=r(844),h=r(5596),u=r(3656),f=r(2585),_=r(4725),d=function(e){function t(t,r,i,n,o,s){var l=e.call(this)||this;if(l._renderer=t,l._rowCount=r,l._charSizeService=o,l._isPaused=!1,l._needsFullRefresh=!1,l._isNextRenderRedrawOnly=!0,l._needsSelectionRefresh=!1,l._canvasWidth=0,l._canvasHeight=0,l._selectionState={start:void 0,end:void 0,columnSelectMode:!1},l._onDimensionsChange=new c.EventEmitter,l._onRender=new c.EventEmitter,l._onRefreshRequest=new c.EventEmitter,l.register({dispose:function(){return l._renderer.dispose()}}),l._renderDebouncer=new a.RenderDebouncer((function(e,t){return l._renderRows(e,t)})),l.register(l._renderDebouncer),l._screenDprMonitor=new h.ScreenDprMonitor,l._screenDprMonitor.setListener((function(){return l.onDevicePixelRatioChange()})),l.register(l._screenDprMonitor),l.register(s.onResize((function(e){return l._fullRefresh()}))),l.register(n.onOptionChange((function(){return l._renderer.onOptionsChanged()}))),l.register(l._charSizeService.onCharSizeChange((function(){return l.onCharSizeChanged()}))),l._renderer.onRequestRedraw((function(e){return l.refreshRows(e.start,e.end,!0)})),l.register(u.addDisposableDomListener(window,"resize",(function(){return l.onDevicePixelRatioChange()}))),"IntersectionObserver"in window){var f=new IntersectionObserver((function(e){return l._onIntersectionChange(e[e.length-1])}),{threshold:0});f.observe(i),l.register({dispose:function(){return f.disconnect()}})}return l}return n(t,e),Object.defineProperty(t.prototype,"onDimensionsChange",{get:function(){return this._onDimensionsChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRenderedBufferChange",{get:function(){return this._onRender.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRefreshRequest",{get:function(){return this._onRefreshRequest.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"dimensions",{get:function(){return this._renderer.dimensions},enumerable:!1,configurable:!0}),t.prototype._onIntersectionChange=function(e){this._isPaused=void 0===e.isIntersecting?0===e.intersectionRatio:!e.isIntersecting,this._isPaused||this._charSizeService.hasValidSize||this._charSizeService.measure(),!this._isPaused&&this._needsFullRefresh&&(this.refreshRows(0,this._rowCount-1),this._needsFullRefresh=!1)},t.prototype.refreshRows=function(e,t,r){void 0===r&&(r=!1),this._isPaused?this._needsFullRefresh=!0:(r||(this._isNextRenderRedrawOnly=!1),this._renderDebouncer.refresh(e,t,this._rowCount))},t.prototype._renderRows=function(e,t){this._renderer.renderRows(e,t),this._needsSelectionRefresh&&(this._renderer.onSelectionChanged(this._selectionState.start,this._selectionState.end,this._selectionState.columnSelectMode),this._needsSelectionRefresh=!1),this._isNextRenderRedrawOnly||this._onRender.fire({start:e,end:t}),this._isNextRenderRedrawOnly=!0},t.prototype.resize=function(e,t){this._rowCount=t,this._fireOnCanvasResize()},t.prototype.changeOptions=function(){this._renderer.onOptionsChanged(),this.refreshRows(0,this._rowCount-1),this._fireOnCanvasResize()},t.prototype._fireOnCanvasResize=function(){this._renderer.dimensions.canvasWidth===this._canvasWidth&&this._renderer.dimensions.canvasHeight===this._canvasHeight||this._onDimensionsChange.fire(this._renderer.dimensions)},t.prototype.dispose=function(){e.prototype.dispose.call(this)},t.prototype.setRenderer=function(e){var t=this;this._renderer.dispose(),this._renderer=e,this._renderer.onRequestRedraw((function(e){return t.refreshRows(e.start,e.end,!0)})),this._needsSelectionRefresh=!0,this._fullRefresh()},t.prototype._fullRefresh=function(){this._isPaused?this._needsFullRefresh=!0:this.refreshRows(0,this._rowCount-1)},t.prototype.setColors=function(e){this._renderer.setColors(e),this._fullRefresh()},t.prototype.onDevicePixelRatioChange=function(){this._charSizeService.measure(),this._renderer.onDevicePixelRatioChange(),this.refreshRows(0,this._rowCount-1)},t.prototype.onResize=function(e,t){this._renderer.onResize(e,t),this._fullRefresh()},t.prototype.onCharSizeChanged=function(){this._renderer.onCharSizeChanged()},t.prototype.onBlur=function(){this._renderer.onBlur()},t.prototype.onFocus=function(){this._renderer.onFocus()},t.prototype.onSelectionChanged=function(e,t,r){this._selectionState.start=e,this._selectionState.end=t,this._selectionState.columnSelectMode=r,this._renderer.onSelectionChanged(e,t,r)},t.prototype.onCursorMove=function(){this._renderer.onCursorMove()},t.prototype.clear=function(){this._renderer.clear()},t.prototype.registerCharacterJoiner=function(e){return this._renderer.registerCharacterJoiner(e)},t.prototype.deregisterCharacterJoiner=function(e){return this._renderer.deregisterCharacterJoiner(e)},o([s(3,f.IOptionsService),s(4,_.ICharSizeService),s(5,f.IBufferService)],t)}(l.Disposable);t.RenderService=d},9312:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SelectionService=void 0;var a=r(6114),c=r(456),l=r(511),h=r(8460),u=r(4725),f=r(2585),_=r(9806),d=r(9504),p=r(844),v=String.fromCharCode(160),g=new RegExp(v,"g"),y=function(e){function t(t,r,i,n,o,s,a){var u=e.call(this)||this;return u._element=t,u._screenElement=r,u._bufferService=i,u._coreService=n,u._mouseService=o,u._optionsService=s,u._renderService=a,u._dragScrollAmount=0,u._enabled=!0,u._workCell=new l.CellData,u._mouseDownTimeStamp=0,u._oldHasSelection=!1,u._oldSelectionStart=void 0,u._oldSelectionEnd=void 0,u._onLinuxMouseSelection=u.register(new h.EventEmitter),u._onRedrawRequest=u.register(new h.EventEmitter),u._onSelectionChange=u.register(new h.EventEmitter),u._onRequestScrollLines=u.register(new h.EventEmitter),u._mouseMoveListener=function(e){return u._onMouseMove(e)},u._mouseUpListener=function(e){return u._onMouseUp(e)},u._coreService.onUserInput((function(){u.hasSelection&&u.clearSelection()})),u._trimListener=u._bufferService.buffer.lines.onTrim((function(e){return u._onTrim(e)})),u.register(u._bufferService.buffers.onBufferActivate((function(e){return u._onBufferActivate(e)}))),u.enable(),u._model=new c.SelectionModel(u._bufferService),u._activeSelectionMode=0,u}return n(t,e),Object.defineProperty(t.prototype,"onLinuxMouseSelection",{get:function(){return this._onLinuxMouseSelection.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestRedraw",{get:function(){return this._onRedrawRequest.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onSelectionChange",{get:function(){return this._onSelectionChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestScrollLines",{get:function(){return this._onRequestScrollLines.event},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this._removeMouseDownListeners()},t.prototype.reset=function(){this.clearSelection()},t.prototype.disable=function(){this.clearSelection(),this._enabled=!1},t.prototype.enable=function(){this._enabled=!0},Object.defineProperty(t.prototype,"selectionStart",{get:function(){return this._model.finalSelectionStart},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectionEnd",{get:function(){return this._model.finalSelectionEnd},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"hasSelection",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;return!(!e||!t||e[0]===t[0]&&e[1]===t[1])},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"selectionText",{get:function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd;if(!e||!t)return"";var r=this._bufferService.buffer,i=[];if(3===this._activeSelectionMode){if(e[0]===t[0])return"";for(var n=e[1];n<=t[1];n++){var o=r.translateBufferLineToString(n,!0,e[0],t[0]);i.push(o)}}else{var s=e[1]===t[1]?t[0]:void 0;for(i.push(r.translateBufferLineToString(e[1],!0,e[0],s)),n=e[1]+1;n<=t[1]-1;n++){var c=r.lines.get(n);o=r.translateBufferLineToString(n,!0),c&&c.isWrapped?i[i.length-1]+=o:i.push(o)}e[1]!==t[1]&&(c=r.lines.get(t[1]),o=r.translateBufferLineToString(t[1],!0,0,t[0]),c&&c.isWrapped?i[i.length-1]+=o:i.push(o))}return i.map((function(e){return e.replace(g," ")})).join(a.isWindows?"\r\n":"\n")},enumerable:!1,configurable:!0}),t.prototype.clearSelection=function(){this._model.clearSelection(),this._removeMouseDownListeners(),this.refresh(),this._onSelectionChange.fire()},t.prototype.refresh=function(e){var t=this;this._refreshAnimationFrame||(this._refreshAnimationFrame=window.requestAnimationFrame((function(){return t._refresh()}))),a.isLinux&&e&&this.selectionText.length&&this._onLinuxMouseSelection.fire(this.selectionText)},t.prototype._refresh=function(){this._refreshAnimationFrame=void 0,this._onRedrawRequest.fire({start:this._model.finalSelectionStart,end:this._model.finalSelectionEnd,columnSelectMode:3===this._activeSelectionMode})},t.prototype._isClickInSelection=function(e){var t=this._getMouseBufferCoords(e),r=this._model.finalSelectionStart,i=this._model.finalSelectionEnd;return!!(r&&i&&t)&&this._areCoordsInSelection(t,r,i)},t.prototype._areCoordsInSelection=function(e,t,r){return e[1]>t[1]&&e[1]<r[1]||t[1]===r[1]&&e[1]===t[1]&&e[0]>=t[0]&&e[0]<r[0]||t[1]<r[1]&&e[1]===r[1]&&e[0]<r[0]||t[1]<r[1]&&e[1]===t[1]&&e[0]>=t[0]},t.prototype._selectWordAtCursor=function(e){var t=this._getMouseBufferCoords(e);t&&(this._selectWordAt(t,!1),this._model.selectionEnd=void 0,this.refresh(!0))},t.prototype.selectAll=function(){this._model.isSelectAllActive=!0,this.refresh(),this._onSelectionChange.fire()},t.prototype.selectLines=function(e,t){this._model.clearSelection(),e=Math.max(e,0),t=Math.min(t,this._bufferService.buffer.lines.length-1),this._model.selectionStart=[0,e],this._model.selectionEnd=[this._bufferService.cols,t],this.refresh(),this._onSelectionChange.fire()},t.prototype._onTrim=function(e){this._model.onTrim(e)&&this.refresh()},t.prototype._getMouseBufferCoords=function(e){var t=this._mouseService.getCoords(e,this._screenElement,this._bufferService.cols,this._bufferService.rows,!0);if(t)return t[0]--,t[1]--,t[1]+=this._bufferService.buffer.ydisp,t},t.prototype._getMouseEventScrollAmount=function(e){var t=_.getCoordsRelativeToElement(e,this._screenElement)[1],r=this._renderService.dimensions.canvasHeight;return t>=0&&t<=r?0:(t>r&&(t-=r),t=Math.min(Math.max(t,-50),50),(t/=50)/Math.abs(t)+Math.round(14*t))},t.prototype.shouldForceSelection=function(e){return a.isMac?e.altKey&&this._optionsService.options.macOptionClickForcesSelection:e.shiftKey},t.prototype.onMouseDown=function(e){if(this._mouseDownTimeStamp=e.timeStamp,(2!==e.button||!this.hasSelection)&&0===e.button){if(!this._enabled){if(!this.shouldForceSelection(e))return;e.stopPropagation()}e.preventDefault(),this._dragScrollAmount=0,this._enabled&&e.shiftKey?this._onIncrementalClick(e):1===e.detail?this._onSingleClick(e):2===e.detail?this._onDoubleClick(e):3===e.detail&&this._onTripleClick(e),this._addMouseDownListeners(),this.refresh(!0)}},t.prototype._addMouseDownListeners=function(){var e=this;this._screenElement.ownerDocument&&(this._screenElement.ownerDocument.addEventListener("mousemove",this._mouseMoveListener),this._screenElement.ownerDocument.addEventListener("mouseup",this._mouseUpListener)),this._dragScrollIntervalTimer=window.setInterval((function(){return e._dragScroll()}),50)},t.prototype._removeMouseDownListeners=function(){this._screenElement.ownerDocument&&(this._screenElement.ownerDocument.removeEventListener("mousemove",this._mouseMoveListener),this._screenElement.ownerDocument.removeEventListener("mouseup",this._mouseUpListener)),clearInterval(this._dragScrollIntervalTimer),this._dragScrollIntervalTimer=void 0},t.prototype._onIncrementalClick=function(e){this._model.selectionStart&&(this._model.selectionEnd=this._getMouseBufferCoords(e))},t.prototype._onSingleClick=function(e){if(this._model.selectionStartLength=0,this._model.isSelectAllActive=!1,this._activeSelectionMode=this.shouldColumnSelect(e)?3:0,this._model.selectionStart=this._getMouseBufferCoords(e),this._model.selectionStart){this._model.selectionEnd=void 0;var t=this._bufferService.buffer.lines.get(this._model.selectionStart[1]);t&&t.length!==this._model.selectionStart[0]&&0===t.hasWidth(this._model.selectionStart[0])&&this._model.selectionStart[0]++}},t.prototype._onDoubleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=1,this._selectWordAt(t,!0))},t.prototype._onTripleClick=function(e){var t=this._getMouseBufferCoords(e);t&&(this._activeSelectionMode=2,this._selectLineAt(t[1]))},t.prototype.shouldColumnSelect=function(e){return e.altKey&&!(a.isMac&&this._optionsService.options.macOptionClickForcesSelection)},t.prototype._onMouseMove=function(e){if(e.stopImmediatePropagation(),this._model.selectionStart){var t=this._model.selectionEnd?[this._model.selectionEnd[0],this._model.selectionEnd[1]]:null;if(this._model.selectionEnd=this._getMouseBufferCoords(e),this._model.selectionEnd){2===this._activeSelectionMode?this._model.selectionEnd[1]<this._model.selectionStart[1]?this._model.selectionEnd[0]=0:this._model.selectionEnd[0]=this._bufferService.cols:1===this._activeSelectionMode&&this._selectToWordAt(this._model.selectionEnd),this._dragScrollAmount=this._getMouseEventScrollAmount(e),3!==this._activeSelectionMode&&(this._dragScrollAmount>0?this._model.selectionEnd[0]=this._bufferService.cols:this._dragScrollAmount<0&&(this._model.selectionEnd[0]=0));var r=this._bufferService.buffer;if(this._model.selectionEnd[1]<r.lines.length){var i=r.lines.get(this._model.selectionEnd[1]);i&&0===i.hasWidth(this._model.selectionEnd[0])&&this._model.selectionEnd[0]++}t&&t[0]===this._model.selectionEnd[0]&&t[1]===this._model.selectionEnd[1]||this.refresh(!0)}else this.refresh(!0)}},t.prototype._dragScroll=function(){if(this._model.selectionEnd&&this._model.selectionStart&&this._dragScrollAmount){this._onRequestScrollLines.fire({amount:this._dragScrollAmount,suppressScrollEvent:!1});var e=this._bufferService.buffer;this._dragScrollAmount>0?(3!==this._activeSelectionMode&&(this._model.selectionEnd[0]=this._bufferService.cols),this._model.selectionEnd[1]=Math.min(e.ydisp+this._bufferService.rows,e.lines.length-1)):(3!==this._activeSelectionMode&&(this._model.selectionEnd[0]=0),this._model.selectionEnd[1]=e.ydisp),this.refresh()}},t.prototype._onMouseUp=function(e){var t=e.timeStamp-this._mouseDownTimeStamp;if(this._removeMouseDownListeners(),this.selectionText.length<=1&&t<500&&e.altKey&&this._optionsService.getOption("altClickMovesCursor")){if(this._bufferService.buffer.ybase===this._bufferService.buffer.ydisp){var r=this._mouseService.getCoords(e,this._element,this._bufferService.cols,this._bufferService.rows,!1);if(r&&void 0!==r[0]&&void 0!==r[1]){var i=d.moveToCellSequence(r[0]-1,r[1]-1,this._bufferService,this._coreService.decPrivateModes.applicationCursorKeys);this._coreService.triggerDataEvent(i,!0)}}}else this._fireEventIfSelectionChanged()},t.prototype._fireEventIfSelectionChanged=function(){var e=this._model.finalSelectionStart,t=this._model.finalSelectionEnd,r=!(!e||!t||e[0]===t[0]&&e[1]===t[1]);r?e&&t&&(this._oldSelectionStart&&this._oldSelectionEnd&&e[0]===this._oldSelectionStart[0]&&e[1]===this._oldSelectionStart[1]&&t[0]===this._oldSelectionEnd[0]&&t[1]===this._oldSelectionEnd[1]||this._fireOnSelectionChange(e,t,r)):this._oldHasSelection&&this._fireOnSelectionChange(e,t,r)},t.prototype._fireOnSelectionChange=function(e,t,r){this._oldSelectionStart=e,this._oldSelectionEnd=t,this._oldHasSelection=r,this._onSelectionChange.fire()},t.prototype._onBufferActivate=function(e){var t=this;this.clearSelection(),this._trimListener.dispose(),this._trimListener=e.activeBuffer.lines.onTrim((function(e){return t._onTrim(e)}))},t.prototype._convertViewportColToCharacterIndex=function(e,t){for(var r=t[0],i=0;t[0]>=i;i++){var n=e.loadCell(i,this._workCell).getChars().length;0===this._workCell.getWidth()?r--:n>1&&t[0]!==i&&(r+=n-1)}return r},t.prototype.setSelection=function(e,t,r){this._model.clearSelection(),this._removeMouseDownListeners(),this._model.selectionStart=[e,t],this._model.selectionStartLength=r,this.refresh()},t.prototype.rightClickSelect=function(e){this._isClickInSelection(e)||(this._selectWordAtCursor(e),this._fireEventIfSelectionChanged())},t.prototype._getWordAt=function(e,t,r,i){if(void 0===r&&(r=!0),void 0===i&&(i=!0),!(e[0]>=this._bufferService.cols)){var n=this._bufferService.buffer,o=n.lines.get(e[1]);if(o){var s=n.translateBufferLineToString(e[1],!1),a=this._convertViewportColToCharacterIndex(o,e),c=a,l=e[0]-a,h=0,u=0,f=0,_=0;if(" "===s.charAt(a)){for(;a>0&&" "===s.charAt(a-1);)a--;for(;c<s.length&&" "===s.charAt(c+1);)c++}else{var d=e[0],p=e[0];0===o.getWidth(d)&&(h++,d--),2===o.getWidth(p)&&(u++,p++);var v=o.getString(p).length;for(v>1&&(_+=v-1,c+=v-1);d>0&&a>0&&!this._isCharWordSeparator(o.loadCell(d-1,this._workCell));){o.loadCell(d-1,this._workCell);var g=this._workCell.getChars().length;0===this._workCell.getWidth()?(h++,d--):g>1&&(f+=g-1,a-=g-1),a--,d--}for(;p<o.length&&c+1<s.length&&!this._isCharWordSeparator(o.loadCell(p+1,this._workCell));){o.loadCell(p+1,this._workCell);var y=this._workCell.getChars().length;2===this._workCell.getWidth()?(u++,p++):y>1&&(_+=y-1,c+=y-1),c++,p++}}c++;var b=a+l-h+f,S=Math.min(this._bufferService.cols,c-a+h+u-f-_);if(t||""!==s.slice(a,c).trim()){if(r&&0===b&&32!==o.getCodePoint(0)){var m=n.lines.get(e[1]-1);if(m&&o.isWrapped&&32!==m.getCodePoint(this._bufferService.cols-1)){var C=this._getWordAt([this._bufferService.cols-1,e[1]-1],!1,!0,!1);if(C){var w=this._bufferService.cols-C.start;b-=w,S+=w}}}if(i&&b+S===this._bufferService.cols&&32!==o.getCodePoint(this._bufferService.cols-1)){var E=n.lines.get(e[1]+1);if(E&&E.isWrapped&&32!==E.getCodePoint(0)){var L=this._getWordAt([0,e[1]+1],!1,!1,!0);L&&(S+=L.length)}}return{start:b,length:S}}}}},t.prototype._selectWordAt=function(e,t){var r=this._getWordAt(e,t);if(r){for(;r.start<0;)r.start+=this._bufferService.cols,e[1]--;this._model.selectionStart=[r.start,e[1]],this._model.selectionStartLength=r.length}},t.prototype._selectToWordAt=function(e){var t=this._getWordAt(e,!0);if(t){for(var r=e[1];t.start<0;)t.start+=this._bufferService.cols,r--;if(!this._model.areSelectionValuesReversed())for(;t.start+t.length>this._bufferService.cols;)t.length-=this._bufferService.cols,r++;this._model.selectionEnd=[this._model.areSelectionValuesReversed()?t.start:t.start+t.length,r]}},t.prototype._isCharWordSeparator=function(e){return 0!==e.getWidth()&&this._optionsService.options.wordSeparator.indexOf(e.getChars())>=0},t.prototype._selectLineAt=function(e){var t=this._bufferService.buffer.getWrappedRangeForLine(e);this._model.selectionStart=[0,t.first],this._model.selectionEnd=[this._bufferService.cols,t.last],this._model.selectionStartLength=0},o([s(2,f.IBufferService),s(3,f.ICoreService),s(4,u.IMouseService),s(5,f.IOptionsService),s(6,u.IRenderService)],t)}(p.Disposable);t.SelectionService=y},4725:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ISoundService=t.ISelectionService=t.IRenderService=t.IMouseService=t.ICoreBrowserService=t.ICharSizeService=void 0;var i=r(8343);t.ICharSizeService=i.createDecorator("CharSizeService"),t.ICoreBrowserService=i.createDecorator("CoreBrowserService"),t.IMouseService=i.createDecorator("MouseService"),t.IRenderService=i.createDecorator("RenderService"),t.ISelectionService=i.createDecorator("SelectionService"),t.ISoundService=i.createDecorator("SoundService")},357:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.SoundService=void 0;var o=r(2585),s=function(){function e(e){this._optionsService=e}return Object.defineProperty(e,"audioContext",{get:function(){if(!e._audioContext){var t=window.AudioContext||window.webkitAudioContext;if(!t)return console.warn("Web Audio API is not supported by this browser. Consider upgrading to the latest version"),null;e._audioContext=new t}return e._audioContext},enumerable:!1,configurable:!0}),e.prototype.playBellSound=function(){var t=e.audioContext;if(t){var r=t.createBufferSource();t.decodeAudioData(this._base64ToArrayBuffer(this._removeMimeType(this._optionsService.options.bellSound)),(function(e){r.buffer=e,r.connect(t.destination),r.start(0)}))}},e.prototype._base64ToArrayBuffer=function(e){for(var t=window.atob(e),r=t.length,i=new Uint8Array(r),n=0;n<r;n++)i[n]=t.charCodeAt(n);return i.buffer},e.prototype._removeMimeType=function(e){return e.split(",")[1]},e=i([n(0,o.IOptionsService)],e)}();t.SoundService=s},6349:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CircularList=void 0;var i=r(8460),n=function(){function e(e){this._maxLength=e,this.onDeleteEmitter=new i.EventEmitter,this.onInsertEmitter=new i.EventEmitter,this.onTrimEmitter=new i.EventEmitter,this._array=new Array(this._maxLength),this._startIndex=0,this._length=0}return Object.defineProperty(e.prototype,"onDelete",{get:function(){return this.onDeleteEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onInsert",{get:function(){return this.onInsertEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onTrim",{get:function(){return this.onTrimEmitter.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"maxLength",{get:function(){return this._maxLength},set:function(e){if(this._maxLength!==e){for(var t=new Array(e),r=0;r<Math.min(e,this.length);r++)t[r]=this._array[this._getCyclicIndex(r)];this._array=t,this._maxLength=e,this._startIndex=0}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"length",{get:function(){return this._length},set:function(e){if(e>this._length)for(var t=this._length;t<e;t++)this._array[t]=void 0;this._length=e},enumerable:!1,configurable:!0}),e.prototype.get=function(e){return this._array[this._getCyclicIndex(e)]},e.prototype.set=function(e,t){this._array[this._getCyclicIndex(e)]=t},e.prototype.push=function(e){this._array[this._getCyclicIndex(this._length)]=e,this._length===this._maxLength?(this._startIndex=++this._startIndex%this._maxLength,this.onTrimEmitter.fire(1)):this._length++},e.prototype.recycle=function(){if(this._length!==this._maxLength)throw new Error("Can only recycle when the buffer is full");return this._startIndex=++this._startIndex%this._maxLength,this.onTrimEmitter.fire(1),this._array[this._getCyclicIndex(this._length-1)]},Object.defineProperty(e.prototype,"isFull",{get:function(){return this._length===this._maxLength},enumerable:!1,configurable:!0}),e.prototype.pop=function(){return this._array[this._getCyclicIndex(this._length---1)]},e.prototype.splice=function(e,t){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(t){for(var n=e;n<this._length-t;n++)this._array[this._getCyclicIndex(n)]=this._array[this._getCyclicIndex(n+t)];this._length-=t,this.onDeleteEmitter.fire({index:e,amount:t})}for(n=this._length-1;n>=e;n--)this._array[this._getCyclicIndex(n+r.length)]=this._array[this._getCyclicIndex(n)];for(n=0;n<r.length;n++)this._array[this._getCyclicIndex(e+n)]=r[n];if(r.length&&this.onInsertEmitter.fire({index:e,amount:r.length}),this._length+r.length>this._maxLength){var o=this._length+r.length-this._maxLength;this._startIndex+=o,this._length=this._maxLength,this.onTrimEmitter.fire(o)}else this._length+=r.length},e.prototype.trimStart=function(e){e>this._length&&(e=this._length),this._startIndex+=e,this._length-=e,this.onTrimEmitter.fire(e)},e.prototype.shiftElements=function(e,t,r){if(!(t<=0)){if(e<0||e>=this._length)throw new Error("start argument out of range");if(e+r<0)throw new Error("Cannot shift elements in list beyond index 0");if(r>0){for(var i=t-1;i>=0;i--)this.set(e+i+r,this.get(e+i));var n=e+t+r-this._length;if(n>0)for(this._length+=n;this._length>this._maxLength;)this._length--,this._startIndex++,this.onTrimEmitter.fire(1)}else for(i=0;i<t;i++)this.set(e+i+r,this.get(e+i))}},e.prototype._getCyclicIndex=function(e){return(this._startIndex+e)%this._maxLength},e}();t.CircularList=n},1439:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.clone=void 0,t.clone=function e(t,r){if(void 0===r&&(r=5),"object"!=typeof t)return t;var i=Array.isArray(t)?[]:{};for(var n in t)i[n]=r<=1?t[n]:t[n]?e(t[n],r-1):t[n];return i}},8969:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.CoreTerminal=void 0;var o=r(844),s=r(2585),a=r(4348),c=r(7866),l=r(744),h=r(7302),u=r(6975),f=r(8460),_=r(1753),d=r(3730),p=r(1480),v=r(7994),g=r(9282),y=r(5435),b=r(5981),S=function(e){function t(t){var r=e.call(this)||this;return r._onBinary=new f.EventEmitter,r._onData=new f.EventEmitter,r._onLineFeed=new f.EventEmitter,r._onResize=new f.EventEmitter,r._onScroll=new f.EventEmitter,r._instantiationService=new a.InstantiationService,r.optionsService=new h.OptionsService(t),r._instantiationService.setService(s.IOptionsService,r.optionsService),r._bufferService=r.register(r._instantiationService.createInstance(l.BufferService)),r._instantiationService.setService(s.IBufferService,r._bufferService),r._logService=r._instantiationService.createInstance(c.LogService),r._instantiationService.setService(s.ILogService,r._logService),r._coreService=r.register(r._instantiationService.createInstance(u.CoreService,(function(){return r.scrollToBottom()}))),r._instantiationService.setService(s.ICoreService,r._coreService),r._coreMouseService=r._instantiationService.createInstance(_.CoreMouseService),r._instantiationService.setService(s.ICoreMouseService,r._coreMouseService),r._dirtyRowService=r._instantiationService.createInstance(d.DirtyRowService),r._instantiationService.setService(s.IDirtyRowService,r._dirtyRowService),r.unicodeService=r._instantiationService.createInstance(p.UnicodeService),r._instantiationService.setService(s.IUnicodeService,r.unicodeService),r._charsetService=r._instantiationService.createInstance(v.CharsetService),r._instantiationService.setService(s.ICharsetService,r._charsetService),r._inputHandler=new y.InputHandler(r._bufferService,r._charsetService,r._coreService,r._dirtyRowService,r._logService,r.optionsService,r._coreMouseService,r.unicodeService),r.register(f.forwardEvent(r._inputHandler.onLineFeed,r._onLineFeed)),r.register(r._inputHandler),r.register(f.forwardEvent(r._bufferService.onResize,r._onResize)),r.register(f.forwardEvent(r._coreService.onData,r._onData)),r.register(f.forwardEvent(r._coreService.onBinary,r._onBinary)),r.register(r.optionsService.onOptionChange((function(e){return r._updateOptions(e)}))),r._writeBuffer=new b.WriteBuffer((function(e){return r._inputHandler.parse(e)})),r}return n(t,e),Object.defineProperty(t.prototype,"onBinary",{get:function(){return this._onBinary.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onData",{get:function(){return this._onData.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onLineFeed",{get:function(){return this._onLineFeed.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onResize",{get:function(){return this._onResize.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onScroll",{get:function(){return this._onScroll.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"cols",{get:function(){return this._bufferService.cols},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"rows",{get:function(){return this._bufferService.rows},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"buffers",{get:function(){return this._bufferService.buffers},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){var t;this._isDisposed||(e.prototype.dispose.call(this),null===(t=this._windowsMode)||void 0===t||t.dispose(),this._windowsMode=void 0)},t.prototype.write=function(e,t){this._writeBuffer.write(e,t)},t.prototype.writeSync=function(e){this._writeBuffer.writeSync(e)},t.prototype.resize=function(e,t){isNaN(e)||isNaN(t)||(e=Math.max(e,l.MINIMUM_COLS),t=Math.max(t,l.MINIMUM_ROWS),this._bufferService.resize(e,t))},t.prototype.scroll=function(e,t){void 0===t&&(t=!1);var r,i=this._bufferService.buffer;(r=this._cachedBlankLine)&&r.length===this.cols&&r.getFg(0)===e.fg&&r.getBg(0)===e.bg||(r=i.getBlankLine(e,t),this._cachedBlankLine=r),r.isWrapped=t;var n=i.ybase+i.scrollTop,o=i.ybase+i.scrollBottom;if(0===i.scrollTop){var s=i.lines.isFull;o===i.lines.length-1?s?i.lines.recycle().copyFrom(r):i.lines.push(r.clone()):i.lines.splice(o+1,0,r.clone()),s?this._bufferService.isUserScrolling&&(i.ydisp=Math.max(i.ydisp-1,0)):(i.ybase++,this._bufferService.isUserScrolling||i.ydisp++)}else{var a=o-n+1;i.lines.shiftElements(n+1,a-1,-1),i.lines.set(o,r.clone())}this._bufferService.isUserScrolling||(i.ydisp=i.ybase),this._dirtyRowService.markRangeDirty(i.scrollTop,i.scrollBottom),this._onScroll.fire(i.ydisp)},t.prototype.scrollLines=function(e,t){var r=this._bufferService.buffer;if(e<0){if(0===r.ydisp)return;this._bufferService.isUserScrolling=!0}else e+r.ydisp>=r.ybase&&(this._bufferService.isUserScrolling=!1);var i=r.ydisp;r.ydisp=Math.max(Math.min(r.ydisp+e,r.ybase),0),i!==r.ydisp&&(t||this._onScroll.fire(r.ydisp))},t.prototype.scrollPages=function(e){this.scrollLines(e*(this.rows-1))},t.prototype.scrollToTop=function(){this.scrollLines(-this._bufferService.buffer.ydisp)},t.prototype.scrollToBottom=function(){this.scrollLines(this._bufferService.buffer.ybase-this._bufferService.buffer.ydisp)},t.prototype.scrollToLine=function(e){var t=e-this._bufferService.buffer.ydisp;0!==t&&this.scrollLines(t)},t.prototype.addEscHandler=function(e,t){return this._inputHandler.addEscHandler(e,t)},t.prototype.addDcsHandler=function(e,t){return this._inputHandler.addDcsHandler(e,t)},t.prototype.addCsiHandler=function(e,t){return this._inputHandler.addCsiHandler(e,t)},t.prototype.addOscHandler=function(e,t){return this._inputHandler.addOscHandler(e,t)},t.prototype._setup=function(){this.optionsService.options.windowsMode&&this._enableWindowsMode()},t.prototype.reset=function(){this._inputHandler.reset(),this._bufferService.reset(),this._charsetService.reset(),this._coreService.reset(),this._coreMouseService.reset()},t.prototype._updateOptions=function(e){var t;switch(e){case"scrollback":this.buffers.resize(this.cols,this.rows);break;case"windowsMode":this.optionsService.options.windowsMode?this._enableWindowsMode():(null===(t=this._windowsMode)||void 0===t||t.dispose(),this._windowsMode=void 0)}},t.prototype._enableWindowsMode=function(){var e=this;if(!this._windowsMode){var t=[];t.push(this.onLineFeed(g.updateWindowsModeWrappedState.bind(null,this._bufferService))),t.push(this.addCsiHandler({final:"H"},(function(){return g.updateWindowsModeWrappedState(e._bufferService),!1}))),this._windowsMode={dispose:function(){for(var e=0,r=t;e<r.length;e++)r[e].dispose()}}}},t}(o.Disposable);t.CoreTerminal=S},8460:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.forwardEvent=t.EventEmitter=void 0;var r=function(){function e(){this._listeners=[],this._disposed=!1}return Object.defineProperty(e.prototype,"event",{get:function(){var e=this;return this._event||(this._event=function(t){return e._listeners.push(t),{dispose:function(){if(!e._disposed)for(var r=0;r<e._listeners.length;r++)if(e._listeners[r]===t)return void e._listeners.splice(r,1)}}}),this._event},enumerable:!1,configurable:!0}),e.prototype.fire=function(e,t){for(var r=[],i=0;i<this._listeners.length;i++)r.push(this._listeners[i]);for(i=0;i<r.length;i++)r[i].call(void 0,e,t)},e.prototype.dispose=function(){this._listeners&&(this._listeners.length=0),this._disposed=!0},e}();t.EventEmitter=r,t.forwardEvent=function(e,t){return e((function(e){return t.fire(e)}))}},5435:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.InputHandler=t.WindowsOptionsReportType=void 0;var o,s=r(2584),a=r(7116),c=r(2015),l=r(844),h=r(8273),u=r(482),f=r(8437),_=r(8460),d=r(643),p=r(511),v=r(3734),g=r(6242),y=r(6351),b={"(":0,")":1,"*":2,"+":3,"-":1,".":2},S=131072;function m(e,t){if(e>24)return t.setWinLines||!1;switch(e){case 1:return!!t.restoreWin;case 2:return!!t.minimizeWin;case 3:return!!t.setWinPosition;case 4:return!!t.setWinSizePixels;case 5:return!!t.raiseWin;case 6:return!!t.lowerWin;case 7:return!!t.refreshWin;case 8:return!!t.setWinSizeChars;case 9:return!!t.maximizeWin;case 10:return!!t.fullscreenWin;case 11:return!!t.getWinState;case 13:return!!t.getWinPosition;case 14:return!!t.getWinSizePixels;case 15:return!!t.getScreenSizePixels;case 16:return!!t.getCellSizePixels;case 18:return!!t.getWinSizeChars;case 19:return!!t.getScreenSizeChars;case 20:return!!t.getIconTitle;case 21:return!!t.getWinTitle;case 22:return!!t.pushTitle;case 23:return!!t.popTitle;case 24:return!!t.setWinLines}return!1}!function(e){e[e.GET_WIN_SIZE_PIXELS=0]="GET_WIN_SIZE_PIXELS",e[e.GET_CELL_SIZE_PIXELS=1]="GET_CELL_SIZE_PIXELS"}(o=t.WindowsOptionsReportType||(t.WindowsOptionsReportType={}));var C=function(){function e(e,t,r,i){this._bufferService=e,this._coreService=t,this._logService=r,this._optionsService=i,this._data=new Uint32Array(0)}return e.prototype.hook=function(e){this._data=new Uint32Array(0)},e.prototype.put=function(e,t,r){this._data=h.concat(this._data,e.subarray(t,r))},e.prototype.unhook=function(e){if(!e)return this._data=new Uint32Array(0),!0;var t=u.utf32ToString(this._data);switch(this._data=new Uint32Array(0),t){case'"q':this._coreService.triggerDataEvent(s.C0.ESC+'P1$r0"q'+s.C0.ESC+"\\");break;case'"p':this._coreService.triggerDataEvent(s.C0.ESC+'P1$r61;1"p'+s.C0.ESC+"\\");break;case"r":var r=this._bufferService.buffer.scrollTop+1+";"+(this._bufferService.buffer.scrollBottom+1)+"r";this._coreService.triggerDataEvent(s.C0.ESC+"P1$r"+r+s.C0.ESC+"\\");break;case"m":this._coreService.triggerDataEvent(s.C0.ESC+"P1$r0m"+s.C0.ESC+"\\");break;case" q":var i={block:2,underline:4,bar:6}[this._optionsService.options.cursorStyle];i-=this._optionsService.options.cursorBlink?1:0,this._coreService.triggerDataEvent(s.C0.ESC+"P1$r"+i+" q"+s.C0.ESC+"\\");break;default:this._logService.debug("Unknown DCS $q %s",t),this._coreService.triggerDataEvent(s.C0.ESC+"P0$r"+s.C0.ESC+"\\")}return!0},e}(),w=function(e){function t(t,r,i,n,o,l,h,d,v){void 0===v&&(v=new c.EscapeSequenceParser);var y=e.call(this)||this;y._bufferService=t,y._charsetService=r,y._coreService=i,y._dirtyRowService=n,y._logService=o,y._optionsService=l,y._coreMouseService=h,y._unicodeService=d,y._parser=v,y._parseBuffer=new Uint32Array(4096),y._stringDecoder=new u.StringToUtf32,y._utf8Decoder=new u.Utf8ToUtf32,y._workCell=new p.CellData,y._windowTitle="",y._iconName="",y._windowTitleStack=[],y._iconNameStack=[],y._curAttrData=f.DEFAULT_ATTR_DATA.clone(),y._eraseAttrDataInternal=f.DEFAULT_ATTR_DATA.clone(),y._onRequestBell=new _.EventEmitter,y._onRequestRefreshRows=new _.EventEmitter,y._onRequestReset=new _.EventEmitter,y._onRequestScroll=new _.EventEmitter,y._onRequestSyncScrollBar=new _.EventEmitter,y._onRequestWindowsOptionsReport=new _.EventEmitter,y._onA11yChar=new _.EventEmitter,y._onA11yTab=new _.EventEmitter,y._onCursorMove=new _.EventEmitter,y._onLineFeed=new _.EventEmitter,y._onScroll=new _.EventEmitter,y._onTitleChange=new _.EventEmitter,y._onAnsiColorChange=new _.EventEmitter,y.register(y._parser),y._parser.setCsiHandlerFallback((function(e,t){y._logService.debug("Unknown CSI code: ",{identifier:y._parser.identToString(e),params:t.toArray()})})),y._parser.setEscHandlerFallback((function(e){y._logService.debug("Unknown ESC code: ",{identifier:y._parser.identToString(e)})})),y._parser.setExecuteHandlerFallback((function(e){y._logService.debug("Unknown EXECUTE code: ",{code:e})})),y._parser.setOscHandlerFallback((function(e,t,r){y._logService.debug("Unknown OSC code: ",{identifier:e,action:t,data:r})})),y._parser.setDcsHandlerFallback((function(e,t,r){"HOOK"===t&&(r=r.toArray()),y._logService.debug("Unknown DCS code: ",{identifier:y._parser.identToString(e),action:t,payload:r})})),y._parser.setPrintHandler((function(e,t,r){return y.print(e,t,r)})),y._parser.registerCsiHandler({final:"@"},(function(e){return y.insertChars(e)})),y._parser.registerCsiHandler({intermediates:" ",final:"@"},(function(e){return y.scrollLeft(e)})),y._parser.registerCsiHandler({final:"A"},(function(e){return y.cursorUp(e)})),y._parser.registerCsiHandler({intermediates:" ",final:"A"},(function(e){return y.scrollRight(e)})),y._parser.registerCsiHandler({final:"B"},(function(e){return y.cursorDown(e)})),y._parser.registerCsiHandler({final:"C"},(function(e){return y.cursorForward(e)})),y._parser.registerCsiHandler({final:"D"},(function(e){return y.cursorBackward(e)})),y._parser.registerCsiHandler({final:"E"},(function(e){return y.cursorNextLine(e)})),y._parser.registerCsiHandler({final:"F"},(function(e){return y.cursorPrecedingLine(e)})),y._parser.registerCsiHandler({final:"G"},(function(e){return y.cursorCharAbsolute(e)})),y._parser.registerCsiHandler({final:"H"},(function(e){return y.cursorPosition(e)})),y._parser.registerCsiHandler({final:"I"},(function(e){return y.cursorForwardTab(e)})),y._parser.registerCsiHandler({final:"J"},(function(e){return y.eraseInDisplay(e)})),y._parser.registerCsiHandler({prefix:"?",final:"J"},(function(e){return y.eraseInDisplay(e)})),y._parser.registerCsiHandler({final:"K"},(function(e){return y.eraseInLine(e)})),y._parser.registerCsiHandler({prefix:"?",final:"K"},(function(e){return y.eraseInLine(e)})),y._parser.registerCsiHandler({final:"L"},(function(e){return y.insertLines(e)})),y._parser.registerCsiHandler({final:"M"},(function(e){return y.deleteLines(e)})),y._parser.registerCsiHandler({final:"P"},(function(e){return y.deleteChars(e)})),y._parser.registerCsiHandler({final:"S"},(function(e){return y.scrollUp(e)})),y._parser.registerCsiHandler({final:"T"},(function(e){return y.scrollDown(e)})),y._parser.registerCsiHandler({final:"X"},(function(e){return y.eraseChars(e)})),y._parser.registerCsiHandler({final:"Z"},(function(e){return y.cursorBackwardTab(e)})),y._parser.registerCsiHandler({final:"`"},(function(e){return y.charPosAbsolute(e)})),y._parser.registerCsiHandler({final:"a"},(function(e){return y.hPositionRelative(e)})),y._parser.registerCsiHandler({final:"b"},(function(e){return y.repeatPrecedingCharacter(e)})),y._parser.registerCsiHandler({final:"c"},(function(e){return y.sendDeviceAttributesPrimary(e)})),y._parser.registerCsiHandler({prefix:">",final:"c"},(function(e){return y.sendDeviceAttributesSecondary(e)})),y._parser.registerCsiHandler({final:"d"},(function(e){return y.linePosAbsolute(e)})),y._parser.registerCsiHandler({final:"e"},(function(e){return y.vPositionRelative(e)})),y._parser.registerCsiHandler({final:"f"},(function(e){return y.hVPosition(e)})),y._parser.registerCsiHandler({final:"g"},(function(e){return y.tabClear(e)})),y._parser.registerCsiHandler({final:"h"},(function(e){return y.setMode(e)})),y._parser.registerCsiHandler({prefix:"?",final:"h"},(function(e){return y.setModePrivate(e)})),y._parser.registerCsiHandler({final:"l"},(function(e){return y.resetMode(e)})),y._parser.registerCsiHandler({prefix:"?",final:"l"},(function(e){return y.resetModePrivate(e)})),y._parser.registerCsiHandler({final:"m"},(function(e){return y.charAttributes(e)})),y._parser.registerCsiHandler({final:"n"},(function(e){return y.deviceStatus(e)})),y._parser.registerCsiHandler({prefix:"?",final:"n"},(function(e){return y.deviceStatusPrivate(e)})),y._parser.registerCsiHandler({intermediates:"!",final:"p"},(function(e){return y.softReset(e)})),y._parser.registerCsiHandler({intermediates:" ",final:"q"},(function(e){return y.setCursorStyle(e)})),y._parser.registerCsiHandler({final:"r"},(function(e){return y.setScrollRegion(e)})),y._parser.registerCsiHandler({final:"s"},(function(e){return y.saveCursor(e)})),y._parser.registerCsiHandler({final:"t"},(function(e){return y.windowOptions(e)})),y._parser.registerCsiHandler({final:"u"},(function(e){return y.restoreCursor(e)})),y._parser.registerCsiHandler({intermediates:"'",final:"}"},(function(e){return y.insertColumns(e)})),y._parser.registerCsiHandler({intermediates:"'",final:"~"},(function(e){return y.deleteColumns(e)})),y._parser.setExecuteHandler(s.C0.BEL,(function(){return y.bell()})),y._parser.setExecuteHandler(s.C0.LF,(function(){return y.lineFeed()})),y._parser.setExecuteHandler(s.C0.VT,(function(){return y.lineFeed()})),y._parser.setExecuteHandler(s.C0.FF,(function(){return y.lineFeed()})),y._parser.setExecuteHandler(s.C0.CR,(function(){return y.carriageReturn()})),y._parser.setExecuteHandler(s.C0.BS,(function(){return y.backspace()})),y._parser.setExecuteHandler(s.C0.HT,(function(){return y.tab()})),y._parser.setExecuteHandler(s.C0.SO,(function(){return y.shiftOut()})),y._parser.setExecuteHandler(s.C0.SI,(function(){return y.shiftIn()})),y._parser.setExecuteHandler(s.C1.IND,(function(){return y.index()})),y._parser.setExecuteHandler(s.C1.NEL,(function(){return y.nextLine()})),y._parser.setExecuteHandler(s.C1.HTS,(function(){return y.tabSet()})),y._parser.registerOscHandler(0,new g.OscHandler((function(e){return y.setTitle(e),y.setIconName(e),!0}))),y._parser.registerOscHandler(1,new g.OscHandler((function(e){return y.setIconName(e)}))),y._parser.registerOscHandler(2,new g.OscHandler((function(e){return y.setTitle(e)}))),y._parser.registerOscHandler(4,new g.OscHandler((function(e){return y.setAnsiColor(e)}))),y._parser.registerEscHandler({final:"7"},(function(){return y.saveCursor()})),y._parser.registerEscHandler({final:"8"},(function(){return y.restoreCursor()})),y._parser.registerEscHandler({final:"D"},(function(){return y.index()})),y._parser.registerEscHandler({final:"E"},(function(){return y.nextLine()})),y._parser.registerEscHandler({final:"H"},(function(){return y.tabSet()})),y._parser.registerEscHandler({final:"M"},(function(){return y.reverseIndex()})),y._parser.registerEscHandler({final:"="},(function(){return y.keypadApplicationMode()})),y._parser.registerEscHandler({final:">"},(function(){return y.keypadNumericMode()})),y._parser.registerEscHandler({final:"c"},(function(){return y.fullReset()})),y._parser.registerEscHandler({final:"n"},(function(){return y.setgLevel(2)})),y._parser.registerEscHandler({final:"o"},(function(){return y.setgLevel(3)})),y._parser.registerEscHandler({final:"|"},(function(){return y.setgLevel(3)})),y._parser.registerEscHandler({final:"}"},(function(){return y.setgLevel(2)})),y._parser.registerEscHandler({final:"~"},(function(){return y.setgLevel(1)})),y._parser.registerEscHandler({intermediates:"%",final:"@"},(function(){return y.selectDefaultCharset()})),y._parser.registerEscHandler({intermediates:"%",final:"G"},(function(){return y.selectDefaultCharset()}));var b=function(e){S._parser.registerEscHandler({intermediates:"(",final:e},(function(){return y.selectCharset("("+e)})),S._parser.registerEscHandler({intermediates:")",final:e},(function(){return y.selectCharset(")"+e)})),S._parser.registerEscHandler({intermediates:"*",final:e},(function(){return y.selectCharset("*"+e)})),S._parser.registerEscHandler({intermediates:"+",final:e},(function(){return y.selectCharset("+"+e)})),S._parser.registerEscHandler({intermediates:"-",final:e},(function(){return y.selectCharset("-"+e)})),S._parser.registerEscHandler({intermediates:".",final:e},(function(){return y.selectCharset("."+e)})),S._parser.registerEscHandler({intermediates:"/",final:e},(function(){return y.selectCharset("/"+e)}))},S=this;for(var m in a.CHARSETS)b(m);return y._parser.registerEscHandler({intermediates:"#",final:"8"},(function(){return y.screenAlignmentPattern()})),y._parser.setErrorHandler((function(e){return y._logService.error("Parsing error: ",e),e})),y._parser.registerDcsHandler({intermediates:"$",final:"q"},new C(y._bufferService,y._coreService,y._logService,y._optionsService)),y}return n(t,e),Object.defineProperty(t.prototype,"onRequestBell",{get:function(){return this._onRequestBell.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestRefreshRows",{get:function(){return this._onRequestRefreshRows.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestReset",{get:function(){return this._onRequestReset.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestScroll",{get:function(){return this._onRequestScroll.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestSyncScrollBar",{get:function(){return this._onRequestSyncScrollBar.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onRequestWindowsOptionsReport",{get:function(){return this._onRequestWindowsOptionsReport.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onA11yChar",{get:function(){return this._onA11yChar.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onA11yTab",{get:function(){return this._onA11yTab.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onCursorMove",{get:function(){return this._onCursorMove.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onLineFeed",{get:function(){return this._onLineFeed.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onScroll",{get:function(){return this._onScroll.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onTitleChange",{get:function(){return this._onTitleChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onAnsiColorChange",{get:function(){return this._onAnsiColorChange.event},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){e.prototype.dispose.call(this)},t.prototype.parse=function(e){var t=this._bufferService.buffer,r=t.x,i=t.y;if(this._logService.debug("parsing data",e),this._parseBuffer.length<e.length&&this._parseBuffer.length<S&&(this._parseBuffer=new Uint32Array(Math.min(e.length,S))),this._dirtyRowService.clearRange(),e.length>S)for(var n=0;n<e.length;n+=S){var o=n+S<e.length?n+S:e.length,s="string"==typeof e?this._stringDecoder.decode(e.substring(n,o),this._parseBuffer):this._utf8Decoder.decode(e.subarray(n,o),this._parseBuffer);this._parser.parse(this._parseBuffer,s)}else s="string"==typeof e?this._stringDecoder.decode(e,this._parseBuffer):this._utf8Decoder.decode(e,this._parseBuffer),this._parser.parse(this._parseBuffer,s);(t=this._bufferService.buffer).x===r&&t.y===i||this._onCursorMove.fire(),this._onRequestRefreshRows.fire(this._dirtyRowService.start,this._dirtyRowService.end)},t.prototype.print=function(e,t,r){var i,n,o=this._bufferService.buffer,s=this._charsetService.charset,a=this._optionsService.options.screenReaderMode,c=this._bufferService.cols,l=this._coreService.decPrivateModes.wraparound,h=this._coreService.modes.insertMode,f=this._curAttrData,_=o.lines.get(o.ybase+o.y);this._dirtyRowService.markDirty(o.y),o.x&&r-t>0&&2===_.getWidth(o.x-1)&&_.setCellFromCodePoint(o.x-1,0,1,f.fg,f.bg,f.extended);for(var p=t;p<r;++p){if(i=e[p],n=this._unicodeService.wcwidth(i),i<127&&s){var v=s[String.fromCharCode(i)];v&&(i=v.charCodeAt(0))}if(a&&this._onA11yChar.fire(u.stringFromCodePoint(i)),n||!o.x){if(o.x+n-1>=c)if(l){for(;o.x<c;)_.setCellFromCodePoint(o.x++,0,1,f.fg,f.bg,f.extended);o.x=0,o.y++,o.y===o.scrollBottom+1?(o.y--,this._onRequestScroll.fire(this._eraseAttrData(),!0)):(o.y>=this._bufferService.rows&&(o.y=this._bufferService.rows-1),o.lines.get(o.ybase+o.y).isWrapped=!0),_=o.lines.get(o.ybase+o.y)}else if(o.x=c-1,2===n)continue;if(h&&(_.insertCells(o.x,n,o.getNullCell(f),f),2===_.getWidth(c-1)&&_.setCellFromCodePoint(c-1,d.NULL_CELL_CODE,d.NULL_CELL_WIDTH,f.fg,f.bg,f.extended)),_.setCellFromCodePoint(o.x++,i,n,f.fg,f.bg,f.extended),n>0)for(;--n;)_.setCellFromCodePoint(o.x++,0,0,f.fg,f.bg,f.extended)}else _.getWidth(o.x-1)?_.addCodepointToCell(o.x-1,i):_.addCodepointToCell(o.x-2,i)}r-t>0&&(_.loadCell(o.x-1,this._workCell),2===this._workCell.getWidth()||this._workCell.getCode()>65535?this._parser.precedingCodepoint=0:this._workCell.isCombined()?this._parser.precedingCodepoint=this._workCell.getChars().charCodeAt(0):this._parser.precedingCodepoint=this._workCell.content),o.x<c&&r-t>0&&0===_.getWidth(o.x)&&!_.hasContent(o.x)&&_.setCellFromCodePoint(o.x,0,1,f.fg,f.bg,f.extended),this._dirtyRowService.markDirty(o.y)},t.prototype.addCsiHandler=function(e,t){var r=this;return"t"!==e.final||e.prefix||e.intermediates?this._parser.registerCsiHandler(e,t):this._parser.registerCsiHandler(e,(function(e){return!m(e.params[0],r._optionsService.options.windowOptions)||t(e)}))},t.prototype.addDcsHandler=function(e,t){return this._parser.registerDcsHandler(e,new y.DcsHandler(t))},t.prototype.addEscHandler=function(e,t){return this._parser.registerEscHandler(e,t)},t.prototype.addOscHandler=function(e,t){return this._parser.registerOscHandler(e,new g.OscHandler(t))},t.prototype.bell=function(){return this._onRequestBell.fire(),!0},t.prototype.lineFeed=function(){var e=this._bufferService.buffer;return this._dirtyRowService.markDirty(e.y),this._optionsService.options.convertEol&&(e.x=0),e.y++,e.y===e.scrollBottom+1?(e.y--,this._onRequestScroll.fire(this._eraseAttrData())):e.y>=this._bufferService.rows&&(e.y=this._bufferService.rows-1),e.x>=this._bufferService.cols&&e.x--,this._dirtyRowService.markDirty(e.y),this._onLineFeed.fire(),!0},t.prototype.carriageReturn=function(){return this._bufferService.buffer.x=0,!0},t.prototype.backspace=function(){var e,t=this._bufferService.buffer;if(!this._coreService.decPrivateModes.reverseWraparound)return this._restrictCursor(),t.x>0&&t.x--,!0;if(this._restrictCursor(this._bufferService.cols),t.x>0)t.x--;else if(0===t.x&&t.y>t.scrollTop&&t.y<=t.scrollBottom&&(null===(e=t.lines.get(t.ybase+t.y))||void 0===e?void 0:e.isWrapped)){t.lines.get(t.ybase+t.y).isWrapped=!1,t.y--,t.x=this._bufferService.cols-1;var r=t.lines.get(t.ybase+t.y);r.hasWidth(t.x)&&!r.hasContent(t.x)&&t.x--}return this._restrictCursor(),!0},t.prototype.tab=function(){if(this._bufferService.buffer.x>=this._bufferService.cols)return!0;var e=this._bufferService.buffer.x;return this._bufferService.buffer.x=this._bufferService.buffer.nextStop(),this._optionsService.options.screenReaderMode&&this._onA11yTab.fire(this._bufferService.buffer.x-e),!0},t.prototype.shiftOut=function(){return this._charsetService.setgLevel(1),!0},t.prototype.shiftIn=function(){return this._charsetService.setgLevel(0),!0},t.prototype._restrictCursor=function(e){void 0===e&&(e=this._bufferService.cols-1),this._bufferService.buffer.x=Math.min(e,Math.max(0,this._bufferService.buffer.x)),this._bufferService.buffer.y=this._coreService.decPrivateModes.origin?Math.min(this._bufferService.buffer.scrollBottom,Math.max(this._bufferService.buffer.scrollTop,this._bufferService.buffer.y)):Math.min(this._bufferService.rows-1,Math.max(0,this._bufferService.buffer.y)),this._dirtyRowService.markDirty(this._bufferService.buffer.y)},t.prototype._setCursor=function(e,t){this._dirtyRowService.markDirty(this._bufferService.buffer.y),this._coreService.decPrivateModes.origin?(this._bufferService.buffer.x=e,this._bufferService.buffer.y=this._bufferService.buffer.scrollTop+t):(this._bufferService.buffer.x=e,this._bufferService.buffer.y=t),this._restrictCursor(),this._dirtyRowService.markDirty(this._bufferService.buffer.y)},t.prototype._moveCursor=function(e,t){this._restrictCursor(),this._setCursor(this._bufferService.buffer.x+e,this._bufferService.buffer.y+t)},t.prototype.cursorUp=function(e){var t=this._bufferService.buffer.y-this._bufferService.buffer.scrollTop;return t>=0?this._moveCursor(0,-Math.min(t,e.params[0]||1)):this._moveCursor(0,-(e.params[0]||1)),!0},t.prototype.cursorDown=function(e){var t=this._bufferService.buffer.scrollBottom-this._bufferService.buffer.y;return t>=0?this._moveCursor(0,Math.min(t,e.params[0]||1)):this._moveCursor(0,e.params[0]||1),!0},t.prototype.cursorForward=function(e){return this._moveCursor(e.params[0]||1,0),!0},t.prototype.cursorBackward=function(e){return this._moveCursor(-(e.params[0]||1),0),!0},t.prototype.cursorNextLine=function(e){return this.cursorDown(e),this._bufferService.buffer.x=0,!0},t.prototype.cursorPrecedingLine=function(e){return this.cursorUp(e),this._bufferService.buffer.x=0,!0},t.prototype.cursorCharAbsolute=function(e){return this._setCursor((e.params[0]||1)-1,this._bufferService.buffer.y),!0},t.prototype.cursorPosition=function(e){return this._setCursor(e.length>=2?(e.params[1]||1)-1:0,(e.params[0]||1)-1),!0},t.prototype.charPosAbsolute=function(e){return this._setCursor((e.params[0]||1)-1,this._bufferService.buffer.y),!0},t.prototype.hPositionRelative=function(e){return this._moveCursor(e.params[0]||1,0),!0},t.prototype.linePosAbsolute=function(e){return this._setCursor(this._bufferService.buffer.x,(e.params[0]||1)-1),!0},t.prototype.vPositionRelative=function(e){return this._moveCursor(0,e.params[0]||1),!0},t.prototype.hVPosition=function(e){return this.cursorPosition(e),!0},t.prototype.tabClear=function(e){var t=e.params[0];return 0===t?delete this._bufferService.buffer.tabs[this._bufferService.buffer.x]:3===t&&(this._bufferService.buffer.tabs={}),!0},t.prototype.cursorForwardTab=function(e){if(this._bufferService.buffer.x>=this._bufferService.cols)return!0;for(var t=e.params[0]||1;t--;)this._bufferService.buffer.x=this._bufferService.buffer.nextStop();return!0},t.prototype.cursorBackwardTab=function(e){if(this._bufferService.buffer.x>=this._bufferService.cols)return!0;for(var t=e.params[0]||1,r=this._bufferService.buffer;t--;)r.x=r.prevStop();return!0},t.prototype._eraseInBufferLine=function(e,t,r,i){void 0===i&&(i=!1);var n=this._bufferService.buffer.lines.get(this._bufferService.buffer.ybase+e);n.replaceCells(t,r,this._bufferService.buffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),i&&(n.isWrapped=!1)},t.prototype._resetBufferLine=function(e){var t=this._bufferService.buffer.lines.get(this._bufferService.buffer.ybase+e);t.fill(this._bufferService.buffer.getNullCell(this._eraseAttrData())),t.isWrapped=!1},t.prototype.eraseInDisplay=function(e){var t;switch(this._restrictCursor(),e.params[0]){case 0:for(t=this._bufferService.buffer.y,this._dirtyRowService.markDirty(t),this._eraseInBufferLine(t++,this._bufferService.buffer.x,this._bufferService.cols,0===this._bufferService.buffer.x);t<this._bufferService.rows;t++)this._resetBufferLine(t);this._dirtyRowService.markDirty(t);break;case 1:for(t=this._bufferService.buffer.y,this._dirtyRowService.markDirty(t),this._eraseInBufferLine(t,0,this._bufferService.buffer.x+1,!0),this._bufferService.buffer.x+1>=this._bufferService.cols&&(this._bufferService.buffer.lines.get(t+1).isWrapped=!1);t--;)this._resetBufferLine(t);this._dirtyRowService.markDirty(0);break;case 2:for(t=this._bufferService.rows,this._dirtyRowService.markDirty(t-1);t--;)this._resetBufferLine(t);this._dirtyRowService.markDirty(0);break;case 3:var r=this._bufferService.buffer.lines.length-this._bufferService.rows;r>0&&(this._bufferService.buffer.lines.trimStart(r),this._bufferService.buffer.ybase=Math.max(this._bufferService.buffer.ybase-r,0),this._bufferService.buffer.ydisp=Math.max(this._bufferService.buffer.ydisp-r,0),this._onScroll.fire(0))}return!0},t.prototype.eraseInLine=function(e){switch(this._restrictCursor(),e.params[0]){case 0:this._eraseInBufferLine(this._bufferService.buffer.y,this._bufferService.buffer.x,this._bufferService.cols);break;case 1:this._eraseInBufferLine(this._bufferService.buffer.y,0,this._bufferService.buffer.x+1);break;case 2:this._eraseInBufferLine(this._bufferService.buffer.y,0,this._bufferService.cols)}return this._dirtyRowService.markDirty(this._bufferService.buffer.y),!0},t.prototype.insertLines=function(e){this._restrictCursor();var t=e.params[0]||1,r=this._bufferService.buffer;if(r.y>r.scrollBottom||r.y<r.scrollTop)return!0;for(var i=r.ybase+r.y,n=this._bufferService.rows-1-r.scrollBottom,o=this._bufferService.rows-1+r.ybase-n+1;t--;)r.lines.splice(o-1,1),r.lines.splice(i,0,r.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(r.y,r.scrollBottom),r.x=0,!0},t.prototype.deleteLines=function(e){this._restrictCursor();var t=e.params[0]||1,r=this._bufferService.buffer;if(r.y>r.scrollBottom||r.y<r.scrollTop)return!0;var i,n=r.ybase+r.y;for(i=this._bufferService.rows-1-r.scrollBottom,i=this._bufferService.rows-1+r.ybase-i;t--;)r.lines.splice(n,1),r.lines.splice(i,0,r.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(r.y,r.scrollBottom),r.x=0,!0},t.prototype.insertChars=function(e){this._restrictCursor();var t=this._bufferService.buffer.lines.get(this._bufferService.buffer.ybase+this._bufferService.buffer.y);return t&&(t.insertCells(this._bufferService.buffer.x,e.params[0]||1,this._bufferService.buffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._bufferService.buffer.y)),!0},t.prototype.deleteChars=function(e){this._restrictCursor();var t=this._bufferService.buffer.lines.get(this._bufferService.buffer.ybase+this._bufferService.buffer.y);return t&&(t.deleteCells(this._bufferService.buffer.x,e.params[0]||1,this._bufferService.buffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._bufferService.buffer.y)),!0},t.prototype.scrollUp=function(e){for(var t=e.params[0]||1,r=this._bufferService.buffer;t--;)r.lines.splice(r.ybase+r.scrollTop,1),r.lines.splice(r.ybase+r.scrollBottom,0,r.getBlankLine(this._eraseAttrData()));return this._dirtyRowService.markRangeDirty(r.scrollTop,r.scrollBottom),!0},t.prototype.scrollDown=function(e){for(var t=e.params[0]||1,r=this._bufferService.buffer;t--;)r.lines.splice(r.ybase+r.scrollBottom,1),r.lines.splice(r.ybase+r.scrollTop,0,r.getBlankLine(f.DEFAULT_ATTR_DATA));return this._dirtyRowService.markRangeDirty(r.scrollTop,r.scrollBottom),!0},t.prototype.scrollLeft=function(e){var t=this._bufferService.buffer;if(t.y>t.scrollBottom||t.y<t.scrollTop)return!0;for(var r=e.params[0]||1,i=t.scrollTop;i<=t.scrollBottom;++i){var n=t.lines.get(t.ybase+i);n.deleteCells(0,r,t.getNullCell(this._eraseAttrData()),this._eraseAttrData()),n.isWrapped=!1}return this._dirtyRowService.markRangeDirty(t.scrollTop,t.scrollBottom),!0},t.prototype.scrollRight=function(e){var t=this._bufferService.buffer;if(t.y>t.scrollBottom||t.y<t.scrollTop)return!0;for(var r=e.params[0]||1,i=t.scrollTop;i<=t.scrollBottom;++i){var n=t.lines.get(t.ybase+i);n.insertCells(0,r,t.getNullCell(this._eraseAttrData()),this._eraseAttrData()),n.isWrapped=!1}return this._dirtyRowService.markRangeDirty(t.scrollTop,t.scrollBottom),!0},t.prototype.insertColumns=function(e){var t=this._bufferService.buffer;if(t.y>t.scrollBottom||t.y<t.scrollTop)return!0;for(var r=e.params[0]||1,i=t.scrollTop;i<=t.scrollBottom;++i){var n=this._bufferService.buffer.lines.get(t.ybase+i);n.insertCells(t.x,r,t.getNullCell(this._eraseAttrData()),this._eraseAttrData()),n.isWrapped=!1}return this._dirtyRowService.markRangeDirty(t.scrollTop,t.scrollBottom),!0},t.prototype.deleteColumns=function(e){var t=this._bufferService.buffer;if(t.y>t.scrollBottom||t.y<t.scrollTop)return!0;for(var r=e.params[0]||1,i=t.scrollTop;i<=t.scrollBottom;++i){var n=t.lines.get(t.ybase+i);n.deleteCells(t.x,r,t.getNullCell(this._eraseAttrData()),this._eraseAttrData()),n.isWrapped=!1}return this._dirtyRowService.markRangeDirty(t.scrollTop,t.scrollBottom),!0},t.prototype.eraseChars=function(e){this._restrictCursor();var t=this._bufferService.buffer.lines.get(this._bufferService.buffer.ybase+this._bufferService.buffer.y);return t&&(t.replaceCells(this._bufferService.buffer.x,this._bufferService.buffer.x+(e.params[0]||1),this._bufferService.buffer.getNullCell(this._eraseAttrData()),this._eraseAttrData()),this._dirtyRowService.markDirty(this._bufferService.buffer.y)),!0},t.prototype.repeatPrecedingCharacter=function(e){if(!this._parser.precedingCodepoint)return!0;for(var t=e.params[0]||1,r=new Uint32Array(t),i=0;i<t;++i)r[i]=this._parser.precedingCodepoint;return this.print(r,0,r.length),!0},t.prototype.sendDeviceAttributesPrimary=function(e){return e.params[0]>0||(this._is("xterm")||this._is("rxvt-unicode")||this._is("screen")?this._coreService.triggerDataEvent(s.C0.ESC+"[?1;2c"):this._is("linux")&&this._coreService.triggerDataEvent(s.C0.ESC+"[?6c")),!0},t.prototype.sendDeviceAttributesSecondary=function(e){return e.params[0]>0||(this._is("xterm")?this._coreService.triggerDataEvent(s.C0.ESC+"[>0;276;0c"):this._is("rxvt-unicode")?this._coreService.triggerDataEvent(s.C0.ESC+"[>85;95;0c"):this._is("linux")?this._coreService.triggerDataEvent(e.params[0]+"c"):this._is("screen")&&this._coreService.triggerDataEvent(s.C0.ESC+"[>83;40003;0c")),!0},t.prototype._is=function(e){return 0===(this._optionsService.options.termName+"").indexOf(e)},t.prototype.setMode=function(e){for(var t=0;t<e.length;t++)switch(e.params[t]){case 4:this._coreService.modes.insertMode=!0}return!0},t.prototype.setModePrivate=function(e){for(var t=0;t<e.length;t++)switch(e.params[t]){case 1:this._coreService.decPrivateModes.applicationCursorKeys=!0;break;case 2:this._charsetService.setgCharset(0,a.DEFAULT_CHARSET),this._charsetService.setgCharset(1,a.DEFAULT_CHARSET),this._charsetService.setgCharset(2,a.DEFAULT_CHARSET),this._charsetService.setgCharset(3,a.DEFAULT_CHARSET);break;case 3:this._optionsService.options.windowOptions.setWinLines&&(this._bufferService.resize(132,this._bufferService.rows),this._onRequestReset.fire());break;case 6:this._coreService.decPrivateModes.origin=!0,this._setCursor(0,0);break;case 7:this._coreService.decPrivateModes.wraparound=!0;break;case 12:break;case 45:this._coreService.decPrivateModes.reverseWraparound=!0;break;case 66:this._logService.debug("Serial port requested application keypad."),this._coreService.decPrivateModes.applicationKeypad=!0,this._onRequestSyncScrollBar.fire();break;case 9:this._coreMouseService.activeProtocol="X10";break;case 1e3:this._coreMouseService.activeProtocol="VT200";break;case 1002:this._coreMouseService.activeProtocol="DRAG";break;case 1003:this._coreMouseService.activeProtocol="ANY";break;case 1004:this._coreService.decPrivateModes.sendFocus=!0;break;case 1005:this._logService.debug("DECSET 1005 not supported (see #2507)");break;case 1006:this._coreMouseService.activeEncoding="SGR";break;case 1015:this._logService.debug("DECSET 1015 not supported (see #2507)");break;case 25:this._coreService.isCursorHidden=!1;break;case 1048:this.saveCursor();break;case 1049:this.saveCursor();case 47:case 1047:this._bufferService.buffers.activateAltBuffer(this._eraseAttrData()),this._coreService.isCursorInitialized=!0,this._onRequestRefreshRows.fire(0,this._bufferService.rows-1),this._onRequestSyncScrollBar.fire();break;case 2004:this._coreService.decPrivateModes.bracketedPasteMode=!0}return!0},t.prototype.resetMode=function(e){for(var t=0;t<e.length;t++)switch(e.params[t]){case 4:this._coreService.modes.insertMode=!1}return!0},t.prototype.resetModePrivate=function(e){for(var t=0;t<e.length;t++)switch(e.params[t]){case 1:this._coreService.decPrivateModes.applicationCursorKeys=!1;break;case 3:this._optionsService.options.windowOptions.setWinLines&&(this._bufferService.resize(80,this._bufferService.rows),this._onRequestReset.fire());break;case 6:this._coreService.decPrivateModes.origin=!1,this._setCursor(0,0);break;case 7:this._coreService.decPrivateModes.wraparound=!1;break;case 12:break;case 45:this._coreService.decPrivateModes.reverseWraparound=!1;break;case 66:this._logService.debug("Switching back to normal keypad."),this._coreService.decPrivateModes.applicationKeypad=!1,this._onRequestSyncScrollBar.fire();break;case 9:case 1e3:case 1002:case 1003:this._coreMouseService.activeProtocol="NONE";break;case 1004:this._coreService.decPrivateModes.sendFocus=!1;break;case 1005:this._logService.debug("DECRST 1005 not supported (see #2507)");break;case 1006:this._coreMouseService.activeEncoding="DEFAULT";break;case 1015:this._logService.debug("DECRST 1015 not supported (see #2507)");break;case 25:this._coreService.isCursorHidden=!0;break;case 1048:this.restoreCursor();break;case 1049:case 47:case 1047:this._bufferService.buffers.activateNormalBuffer(),1049===e.params[t]&&this.restoreCursor(),this._coreService.isCursorInitialized=!0,this._onRequestRefreshRows.fire(0,this._bufferService.rows-1),this._onRequestSyncScrollBar.fire();break;case 2004:this._coreService.decPrivateModes.bracketedPasteMode=!1}return!0},t.prototype._updateAttrColor=function(e,t,r,i,n){return 2===t?(e|=50331648,e&=-16777216,e|=v.AttributeData.fromColorRGB([r,i,n])):5===t&&(e&=-50331904,e|=33554432|255&r),e},t.prototype._extractColor=function(e,t,r){var i=[0,0,-1,0,0,0],n=0,o=0;do{if(i[o+n]=e.params[t+o],e.hasSubParams(t+o)){var s=e.getSubParams(t+o),a=0;do{5===i[1]&&(n=1),i[o+a+1+n]=s[a]}while(++a<s.length&&a+o+1+n<i.length);break}if(5===i[1]&&o+n>=2||2===i[1]&&o+n>=5)break;i[1]&&(n=1)}while(++o+t<e.length&&o+n<i.length);for(a=2;a<i.length;++a)-1===i[a]&&(i[a]=0);switch(i[0]){case 38:r.fg=this._updateAttrColor(r.fg,i[1],i[3],i[4],i[5]);break;case 48:r.bg=this._updateAttrColor(r.bg,i[1],i[3],i[4],i[5]);break;case 58:r.extended=r.extended.clone(),r.extended.underlineColor=this._updateAttrColor(r.extended.underlineColor,i[1],i[3],i[4],i[5])}return o},t.prototype._processUnderline=function(e,t){t.extended=t.extended.clone(),(!~e||e>5)&&(e=1),t.extended.underlineStyle=e,t.fg|=268435456,0===e&&(t.fg&=-268435457),t.updateExtended()},t.prototype.charAttributes=function(e){if(1===e.length&&0===e.params[0])return this._curAttrData.fg=f.DEFAULT_ATTR_DATA.fg,this._curAttrData.bg=f.DEFAULT_ATTR_DATA.bg,!0;for(var t,r=e.length,i=this._curAttrData,n=0;n<r;n++)(t=e.params[n])>=30&&t<=37?(i.fg&=-50331904,i.fg|=16777216|t-30):t>=40&&t<=47?(i.bg&=-50331904,i.bg|=16777216|t-40):t>=90&&t<=97?(i.fg&=-50331904,i.fg|=16777224|t-90):t>=100&&t<=107?(i.bg&=-50331904,i.bg|=16777224|t-100):0===t?(i.fg=f.DEFAULT_ATTR_DATA.fg,i.bg=f.DEFAULT_ATTR_DATA.bg):1===t?i.fg|=134217728:3===t?i.bg|=67108864:4===t?(i.fg|=268435456,this._processUnderline(e.hasSubParams(n)?e.getSubParams(n)[0]:1,i)):5===t?i.fg|=536870912:7===t?i.fg|=67108864:8===t?i.fg|=1073741824:2===t?i.bg|=134217728:21===t?this._processUnderline(2,i):22===t?(i.fg&=-134217729,i.bg&=-134217729):23===t?i.bg&=-67108865:24===t?i.fg&=-268435457:25===t?i.fg&=-536870913:27===t?i.fg&=-67108865:28===t?i.fg&=-1073741825:39===t?(i.fg&=-67108864,i.fg|=16777215&f.DEFAULT_ATTR_DATA.fg):49===t?(i.bg&=-67108864,i.bg|=16777215&f.DEFAULT_ATTR_DATA.bg):38===t||48===t||58===t?n+=this._extractColor(e,n,i):59===t?(i.extended=i.extended.clone(),i.extended.underlineColor=-1,i.updateExtended()):100===t?(i.fg&=-67108864,i.fg|=16777215&f.DEFAULT_ATTR_DATA.fg,i.bg&=-67108864,i.bg|=16777215&f.DEFAULT_ATTR_DATA.bg):this._logService.debug("Unknown SGR attribute: %d.",t);return!0},t.prototype.deviceStatus=function(e){switch(e.params[0]){case 5:this._coreService.triggerDataEvent(s.C0.ESC+"[0n");break;case 6:var t=this._bufferService.buffer.y+1,r=this._bufferService.buffer.x+1;this._coreService.triggerDataEvent(s.C0.ESC+"["+t+";"+r+"R")}return!0},t.prototype.deviceStatusPrivate=function(e){switch(e.params[0]){case 6:var t=this._bufferService.buffer.y+1,r=this._bufferService.buffer.x+1;this._coreService.triggerDataEvent(s.C0.ESC+"[?"+t+";"+r+"R")}return!0},t.prototype.softReset=function(e){return this._coreService.isCursorHidden=!1,this._onRequestSyncScrollBar.fire(),this._bufferService.buffer.scrollTop=0,this._bufferService.buffer.scrollBottom=this._bufferService.rows-1,this._curAttrData=f.DEFAULT_ATTR_DATA.clone(),this._coreService.reset(),this._charsetService.reset(),this._bufferService.buffer.savedX=0,this._bufferService.buffer.savedY=this._bufferService.buffer.ybase,this._bufferService.buffer.savedCurAttrData.fg=this._curAttrData.fg,this._bufferService.buffer.savedCurAttrData.bg=this._curAttrData.bg,this._bufferService.buffer.savedCharset=this._charsetService.charset,this._coreService.decPrivateModes.origin=!1,!0},t.prototype.setCursorStyle=function(e){var t=e.params[0]||1;switch(t){case 1:case 2:this._optionsService.options.cursorStyle="block";break;case 3:case 4:this._optionsService.options.cursorStyle="underline";break;case 5:case 6:this._optionsService.options.cursorStyle="bar"}var r=t%2==1;return this._optionsService.options.cursorBlink=r,!0},t.prototype.setScrollRegion=function(e){var t,r=e.params[0]||1;return(e.length<2||(t=e.params[1])>this._bufferService.rows||0===t)&&(t=this._bufferService.rows),t>r&&(this._bufferService.buffer.scrollTop=r-1,this._bufferService.buffer.scrollBottom=t-1,this._setCursor(0,0)),!0},t.prototype.windowOptions=function(e){if(!m(e.params[0],this._optionsService.options.windowOptions))return!0;var t=e.length>1?e.params[1]:0;switch(e.params[0]){case 14:2!==t&&this._onRequestWindowsOptionsReport.fire(o.GET_WIN_SIZE_PIXELS);break;case 16:this._onRequestWindowsOptionsReport.fire(o.GET_CELL_SIZE_PIXELS);break;case 18:this._bufferService&&this._coreService.triggerDataEvent(s.C0.ESC+"[8;"+this._bufferService.rows+";"+this._bufferService.cols+"t");break;case 22:0!==t&&2!==t||(this._windowTitleStack.push(this._windowTitle),this._windowTitleStack.length>10&&this._windowTitleStack.shift()),0!==t&&1!==t||(this._iconNameStack.push(this._iconName),this._iconNameStack.length>10&&this._iconNameStack.shift());break;case 23:0!==t&&2!==t||this._windowTitleStack.length&&this.setTitle(this._windowTitleStack.pop()),0!==t&&1!==t||this._iconNameStack.length&&this.setIconName(this._iconNameStack.pop())}return!0},t.prototype.saveCursor=function(e){return this._bufferService.buffer.savedX=this._bufferService.buffer.x,this._bufferService.buffer.savedY=this._bufferService.buffer.ybase+this._bufferService.buffer.y,this._bufferService.buffer.savedCurAttrData.fg=this._curAttrData.fg,this._bufferService.buffer.savedCurAttrData.bg=this._curAttrData.bg,this._bufferService.buffer.savedCharset=this._charsetService.charset,!0},t.prototype.restoreCursor=function(e){return this._bufferService.buffer.x=this._bufferService.buffer.savedX||0,this._bufferService.buffer.y=Math.max(this._bufferService.buffer.savedY-this._bufferService.buffer.ybase,0),this._curAttrData.fg=this._bufferService.buffer.savedCurAttrData.fg,this._curAttrData.bg=this._bufferService.buffer.savedCurAttrData.bg,this._charsetService.charset=this._savedCharset,this._bufferService.buffer.savedCharset&&(this._charsetService.charset=this._bufferService.buffer.savedCharset),this._restrictCursor(),!0},t.prototype.setTitle=function(e){return this._windowTitle=e,this._onTitleChange.fire(e),!0},t.prototype.setIconName=function(e){return this._iconName=e,!0},t.prototype._parseAnsiColorChange=function(e){for(var t,r={colors:[]},i=/(\d+);rgb:([0-9a-f]{2})\/([0-9a-f]{2})\/([0-9a-f]{2})/gi;null!==(t=i.exec(e));)r.colors.push({colorIndex:parseInt(t[1]),red:parseInt(t[2],16),green:parseInt(t[3],16),blue:parseInt(t[4],16)});return 0===r.colors.length?null:r},t.prototype.setAnsiColor=function(e){var t=this._parseAnsiColorChange(e);return t?this._onAnsiColorChange.fire(t):this._logService.warn("Expected format <num>;rgb:<rr>/<gg>/<bb> but got data: "+e),!0},t.prototype.nextLine=function(){return this._bufferService.buffer.x=0,this.index(),!0},t.prototype.keypadApplicationMode=function(){return this._logService.debug("Serial port requested application keypad."),this._coreService.decPrivateModes.applicationKeypad=!0,this._onRequestSyncScrollBar.fire(),!0},t.prototype.keypadNumericMode=function(){return this._logService.debug("Switching back to normal keypad."),this._coreService.decPrivateModes.applicationKeypad=!1,this._onRequestSyncScrollBar.fire(),!0},t.prototype.selectDefaultCharset=function(){return this._charsetService.setgLevel(0),this._charsetService.setgCharset(0,a.DEFAULT_CHARSET),!0},t.prototype.selectCharset=function(e){return 2!==e.length?(this.selectDefaultCharset(),!0):("/"===e[0]||this._charsetService.setgCharset(b[e[0]],a.CHARSETS[e[1]]||a.DEFAULT_CHARSET),!0)},t.prototype.index=function(){this._restrictCursor();var e=this._bufferService.buffer;return this._bufferService.buffer.y++,e.y===e.scrollBottom+1?(e.y--,this._onRequestScroll.fire(this._eraseAttrData())):e.y>=this._bufferService.rows&&(e.y=this._bufferService.rows-1),this._restrictCursor(),!0},t.prototype.tabSet=function(){return this._bufferService.buffer.tabs[this._bufferService.buffer.x]=!0,!0},t.prototype.reverseIndex=function(){this._restrictCursor();var e=this._bufferService.buffer;if(e.y===e.scrollTop){var t=e.scrollBottom-e.scrollTop;e.lines.shiftElements(e.ybase+e.y,t,1),e.lines.set(e.ybase+e.y,e.getBlankLine(this._eraseAttrData())),this._dirtyRowService.markRangeDirty(e.scrollTop,e.scrollBottom)}else e.y--,this._restrictCursor();return!0},t.prototype.fullReset=function(){return this._parser.reset(),this._onRequestReset.fire(),!0},t.prototype.reset=function(){this._curAttrData=f.DEFAULT_ATTR_DATA.clone(),this._eraseAttrDataInternal=f.DEFAULT_ATTR_DATA.clone()},t.prototype._eraseAttrData=function(){return this._eraseAttrDataInternal.bg&=-67108864,this._eraseAttrDataInternal.bg|=67108863&this._curAttrData.bg,this._eraseAttrDataInternal},t.prototype.setgLevel=function(e){return this._charsetService.setgLevel(e),!0},t.prototype.screenAlignmentPattern=function(){var e=new p.CellData;e.content=1<<22|"E".charCodeAt(0),e.fg=this._curAttrData.fg,e.bg=this._curAttrData.bg;var t=this._bufferService.buffer;this._setCursor(0,0);for(var r=0;r<this._bufferService.rows;++r){var i=t.ybase+t.y+r,n=t.lines.get(i);n&&(n.fill(e),n.isWrapped=!1)}return this._dirtyRowService.markAllDirty(),this._setCursor(0,0),!0},t}(l.Disposable);t.InputHandler=w},844:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.getDisposeArrayDisposable=t.disposeArray=t.Disposable=void 0;var r=function(){function e(){this._disposables=[],this._isDisposed=!1}return e.prototype.dispose=function(){this._isDisposed=!0;for(var e=0,t=this._disposables;e<t.length;e++)t[e].dispose();this._disposables.length=0},e.prototype.register=function(e){return this._disposables.push(e),e},e.prototype.unregister=function(e){var t=this._disposables.indexOf(e);-1!==t&&this._disposables.splice(t,1)},e}();function i(e){for(var t=0,r=e;t<r.length;t++)r[t].dispose();e.length=0}t.Disposable=r,t.disposeArray=i,t.getDisposeArrayDisposable=function(e){return{dispose:function(){return i(e)}}}},6114:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.isLinux=t.isWindows=t.isIphone=t.isIpad=t.isMac=t.isSafari=t.isFirefox=void 0;var r="undefined"==typeof navigator,i=r?"node":navigator.userAgent,n=r?"node":navigator.platform;t.isFirefox=i.includes("Firefox"),t.isSafari=/^((?!chrome|android).)*safari/i.test(i),t.isMac=["Macintosh","MacIntel","MacPPC","Mac68K"].includes(n),t.isIpad="iPad"===n,t.isIphone="iPhone"===n,t.isWindows=["Windows","Win16","Win32","WinCE"].includes(n),t.isLinux=n.indexOf("Linux")>=0},8273:(e,t)=>{function r(e,t,r,i){if(void 0===r&&(r=0),void 0===i&&(i=e.length),r>=e.length)return e;r=(e.length+r)%e.length,i=i>=e.length?e.length:(e.length+i)%e.length;for(var n=r;n<i;++n)e[n]=t;return e}Object.defineProperty(t,"__esModule",{value:!0}),t.concat=t.fillFallback=t.fill=void 0,t.fill=function(e,t,i,n){return e.fill?e.fill(t,i,n):r(e,t,i,n)},t.fillFallback=r,t.concat=function(e,t){var r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r}},9282:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.updateWindowsModeWrappedState=void 0;var i=r(643);t.updateWindowsModeWrappedState=function(e){var t=e.buffer.lines.get(e.buffer.ybase+e.buffer.y-1),r=null==t?void 0:t.get(e.cols-1),n=e.buffer.lines.get(e.buffer.ybase+e.buffer.y);n&&r&&(n.isWrapped=r[i.CHAR_DATA_CODE_INDEX]!==i.NULL_CELL_CODE&&r[i.CHAR_DATA_CODE_INDEX]!==i.WHITESPACE_CELL_CODE)}},3734:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ExtendedAttrs=t.AttributeData=void 0;var r=function(){function e(){this.fg=0,this.bg=0,this.extended=new i}return e.toColorRGB=function(e){return[e>>>16&255,e>>>8&255,255&e]},e.fromColorRGB=function(e){return(255&e[0])<<16|(255&e[1])<<8|255&e[2]},e.prototype.clone=function(){var t=new e;return t.fg=this.fg,t.bg=this.bg,t.extended=this.extended.clone(),t},e.prototype.isInverse=function(){return 67108864&this.fg},e.prototype.isBold=function(){return 134217728&this.fg},e.prototype.isUnderline=function(){return 268435456&this.fg},e.prototype.isBlink=function(){return 536870912&this.fg},e.prototype.isInvisible=function(){return 1073741824&this.fg},e.prototype.isItalic=function(){return 67108864&this.bg},e.prototype.isDim=function(){return 134217728&this.bg},e.prototype.getFgColorMode=function(){return 50331648&this.fg},e.prototype.getBgColorMode=function(){return 50331648&this.bg},e.prototype.isFgRGB=function(){return 50331648==(50331648&this.fg)},e.prototype.isBgRGB=function(){return 50331648==(50331648&this.bg)},e.prototype.isFgPalette=function(){return 16777216==(50331648&this.fg)||33554432==(50331648&this.fg)},e.prototype.isBgPalette=function(){return 16777216==(50331648&this.bg)||33554432==(50331648&this.bg)},e.prototype.isFgDefault=function(){return 0==(50331648&this.fg)},e.prototype.isBgDefault=function(){return 0==(50331648&this.bg)},e.prototype.isAttributeDefault=function(){return 0===this.fg&&0===this.bg},e.prototype.getFgColor=function(){switch(50331648&this.fg){case 16777216:case 33554432:return 255&this.fg;case 50331648:return 16777215&this.fg;default:return-1}},e.prototype.getBgColor=function(){switch(50331648&this.bg){case 16777216:case 33554432:return 255&this.bg;case 50331648:return 16777215&this.bg;default:return-1}},e.prototype.hasExtendedAttrs=function(){return 268435456&this.bg},e.prototype.updateExtended=function(){this.extended.isEmpty()?this.bg&=-268435457:this.bg|=268435456},e.prototype.getUnderlineColor=function(){if(268435456&this.bg&&~this.extended.underlineColor)switch(50331648&this.extended.underlineColor){case 16777216:case 33554432:return 255&this.extended.underlineColor;case 50331648:return 16777215&this.extended.underlineColor;default:return this.getFgColor()}return this.getFgColor()},e.prototype.getUnderlineColorMode=function(){return 268435456&this.bg&&~this.extended.underlineColor?50331648&this.extended.underlineColor:this.getFgColorMode()},e.prototype.isUnderlineColorRGB=function(){return 268435456&this.bg&&~this.extended.underlineColor?50331648==(50331648&this.extended.underlineColor):this.isFgRGB()},e.prototype.isUnderlineColorPalette=function(){return 268435456&this.bg&&~this.extended.underlineColor?16777216==(50331648&this.extended.underlineColor)||33554432==(50331648&this.extended.underlineColor):this.isFgPalette()},e.prototype.isUnderlineColorDefault=function(){return 268435456&this.bg&&~this.extended.underlineColor?0==(50331648&this.extended.underlineColor):this.isFgDefault()},e.prototype.getUnderlineStyle=function(){return 268435456&this.fg?268435456&this.bg?this.extended.underlineStyle:1:0},e}();t.AttributeData=r;var i=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=-1),this.underlineStyle=e,this.underlineColor=t}return e.prototype.clone=function(){return new e(this.underlineStyle,this.underlineColor)},e.prototype.isEmpty=function(){return 0===this.underlineStyle},e}();t.ExtendedAttrs=i},9092:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BufferStringIterator=t.Buffer=t.MAX_BUFFER_SIZE=void 0;var i=r(6349),n=r(8437),o=r(511),s=r(643),a=r(4634),c=r(4863),l=r(7116),h=r(3734);t.MAX_BUFFER_SIZE=4294967295;var u=function(){function e(e,t,r){this._hasScrollback=e,this._optionsService=t,this._bufferService=r,this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.savedY=0,this.savedX=0,this.savedCurAttrData=n.DEFAULT_ATTR_DATA.clone(),this.savedCharset=l.DEFAULT_CHARSET,this.markers=[],this._nullCell=o.CellData.fromCharData([0,s.NULL_CELL_CHAR,s.NULL_CELL_WIDTH,s.NULL_CELL_CODE]),this._whitespaceCell=o.CellData.fromCharData([0,s.WHITESPACE_CELL_CHAR,s.WHITESPACE_CELL_WIDTH,s.WHITESPACE_CELL_CODE]),this._cols=this._bufferService.cols,this._rows=this._bufferService.rows,this.lines=new i.CircularList(this._getCorrectBufferLength(this._rows)),this.scrollTop=0,this.scrollBottom=this._rows-1,this.setupTabStops()}return e.prototype.getNullCell=function(e){return e?(this._nullCell.fg=e.fg,this._nullCell.bg=e.bg,this._nullCell.extended=e.extended):(this._nullCell.fg=0,this._nullCell.bg=0,this._nullCell.extended=new h.ExtendedAttrs),this._nullCell},e.prototype.getWhitespaceCell=function(e){return e?(this._whitespaceCell.fg=e.fg,this._whitespaceCell.bg=e.bg,this._whitespaceCell.extended=e.extended):(this._whitespaceCell.fg=0,this._whitespaceCell.bg=0,this._whitespaceCell.extended=new h.ExtendedAttrs),this._whitespaceCell},e.prototype.getBlankLine=function(e,t){return new n.BufferLine(this._bufferService.cols,this.getNullCell(e),t)},Object.defineProperty(e.prototype,"hasScrollback",{get:function(){return this._hasScrollback&&this.lines.maxLength>this._rows},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isCursorInViewport",{get:function(){var e=this.ybase+this.y-this.ydisp;return e>=0&&e<this._rows},enumerable:!1,configurable:!0}),e.prototype._getCorrectBufferLength=function(e){if(!this._hasScrollback)return e;var r=e+this._optionsService.options.scrollback;return r>t.MAX_BUFFER_SIZE?t.MAX_BUFFER_SIZE:r},e.prototype.fillViewportRows=function(e){if(0===this.lines.length){void 0===e&&(e=n.DEFAULT_ATTR_DATA);for(var t=this._rows;t--;)this.lines.push(this.getBlankLine(e))}},e.prototype.clear=function(){this.ydisp=0,this.ybase=0,this.y=0,this.x=0,this.lines=new i.CircularList(this._getCorrectBufferLength(this._rows)),this.scrollTop=0,this.scrollBottom=this._rows-1,this.setupTabStops()},e.prototype.resize=function(e,t){var r=this.getNullCell(n.DEFAULT_ATTR_DATA),i=this._getCorrectBufferLength(t);if(i>this.lines.maxLength&&(this.lines.maxLength=i),this.lines.length>0){if(this._cols<e)for(var o=0;o<this.lines.length;o++)this.lines.get(o).resize(e,r);var s=0;if(this._rows<t)for(var a=this._rows;a<t;a++)this.lines.length<t+this.ybase&&(this._optionsService.options.windowsMode?this.lines.push(new n.BufferLine(e,r)):this.ybase>0&&this.lines.length<=this.ybase+this.y+s+1?(this.ybase--,s++,this.ydisp>0&&this.ydisp--):this.lines.push(new n.BufferLine(e,r)));else for(a=this._rows;a>t;a--)this.lines.length>t+this.ybase&&(this.lines.length>this.ybase+this.y+1?this.lines.pop():(this.ybase++,this.ydisp++));if(i<this.lines.maxLength){var c=this.lines.length-i;c>0&&(this.lines.trimStart(c),this.ybase=Math.max(this.ybase-c,0),this.ydisp=Math.max(this.ydisp-c,0),this.savedY=Math.max(this.savedY-c,0)),this.lines.maxLength=i}this.x=Math.min(this.x,e-1),this.y=Math.min(this.y,t-1),s&&(this.y+=s),this.savedX=Math.min(this.savedX,e-1),this.scrollTop=0}if(this.scrollBottom=t-1,this._isReflowEnabled&&(this._reflow(e,t),this._cols>e))for(o=0;o<this.lines.length;o++)this.lines.get(o).resize(e,r);this._cols=e,this._rows=t},Object.defineProperty(e.prototype,"_isReflowEnabled",{get:function(){return this._hasScrollback&&!this._optionsService.options.windowsMode},enumerable:!1,configurable:!0}),e.prototype._reflow=function(e,t){this._cols!==e&&(e>this._cols?this._reflowLarger(e,t):this._reflowSmaller(e,t))},e.prototype._reflowLarger=function(e,t){var r=a.reflowLargerGetLinesToRemove(this.lines,this._cols,e,this.ybase+this.y,this.getNullCell(n.DEFAULT_ATTR_DATA));if(r.length>0){var i=a.reflowLargerCreateNewLayout(this.lines,r);a.reflowLargerApplyNewLayout(this.lines,i.layout),this._reflowLargerAdjustViewport(e,t,i.countRemoved)}},e.prototype._reflowLargerAdjustViewport=function(e,t,r){for(var i=this.getNullCell(n.DEFAULT_ATTR_DATA),o=r;o-- >0;)0===this.ybase?(this.y>0&&this.y--,this.lines.length<t&&this.lines.push(new n.BufferLine(e,i))):(this.ydisp===this.ybase&&this.ydisp--,this.ybase--);this.savedY=Math.max(this.savedY-r,0)},e.prototype._reflowSmaller=function(e,t){for(var r=this.getNullCell(n.DEFAULT_ATTR_DATA),i=[],o=0,s=this.lines.length-1;s>=0;s--){var c=this.lines.get(s);if(!(!c||!c.isWrapped&&c.getTrimmedLength()<=e)){for(var l=[c];c.isWrapped&&s>0;)c=this.lines.get(--s),l.unshift(c);var h=this.ybase+this.y;if(!(h>=s&&h<s+l.length)){var u,f=l[l.length-1].getTrimmedLength(),_=a.reflowSmallerGetNewLineLengths(l,this._cols,e),d=_.length-l.length;u=0===this.ybase&&this.y!==this.lines.length-1?Math.max(0,this.y-this.lines.maxLength+d):Math.max(0,this.lines.length-this.lines.maxLength+d);for(var p=[],v=0;v<d;v++){var g=this.getBlankLine(n.DEFAULT_ATTR_DATA,!0);p.push(g)}p.length>0&&(i.push({start:s+l.length+o,newLines:p}),o+=p.length),l.push.apply(l,p);var y=_.length-1,b=_[y];0===b&&(b=_[--y]);for(var S=l.length-d-1,m=f;S>=0;){var C=Math.min(m,b);if(l[y].copyCellsFrom(l[S],m-C,b-C,C,!0),0==(b-=C)&&(b=_[--y]),0==(m-=C)){S--;var w=Math.max(S,0);m=a.getWrappedLineTrimmedLength(l,w,this._cols)}}for(v=0;v<l.length;v++)_[v]<e&&l[v].setCell(_[v],r);for(var E=d-u;E-- >0;)0===this.ybase?this.y<t-1?(this.y++,this.lines.pop()):(this.ybase++,this.ydisp++):this.ybase<Math.min(this.lines.maxLength,this.lines.length+o)-t&&(this.ybase===this.ydisp&&this.ydisp++,this.ybase++);this.savedY=Math.min(this.savedY+d,this.ybase+t-1)}}}if(i.length>0){var L=[],A=[];for(v=0;v<this.lines.length;v++)A.push(this.lines.get(v));var R=this.lines.length,k=R-1,x=0,D=i[x];this.lines.length=Math.min(this.lines.maxLength,this.lines.length+o);var T=0;for(v=Math.min(this.lines.maxLength-1,R+o-1);v>=0;v--)if(D&&D.start>k+T){for(var O=D.newLines.length-1;O>=0;O--)this.lines.set(v--,D.newLines[O]);v++,L.push({index:k+1,amount:D.newLines.length}),T+=D.newLines.length,D=i[++x]}else this.lines.set(v,A[k--]);var M=0;for(v=L.length-1;v>=0;v--)L[v].index+=M,this.lines.onInsertEmitter.fire(L[v]),M+=L[v].amount;var P=Math.max(0,R+o-this.lines.maxLength);P>0&&this.lines.onTrimEmitter.fire(P)}},e.prototype.stringIndexToBufferIndex=function(e,t,r){for(void 0===r&&(r=!1);t;){var i=this.lines.get(e);if(!i)return[-1,-1];for(var n=r?i.getTrimmedLength():i.length,o=0;o<n;++o)if(i.get(o)[s.CHAR_DATA_WIDTH_INDEX]&&(t-=i.get(o)[s.CHAR_DATA_CHAR_INDEX].length||1),t<0)return[e,o];e++}return[e,0]},e.prototype.translateBufferLineToString=function(e,t,r,i){void 0===r&&(r=0);var n=this.lines.get(e);return n?n.translateToString(t,r,i):""},e.prototype.getWrappedRangeForLine=function(e){for(var t=e,r=e;t>0&&this.lines.get(t).isWrapped;)t--;for(;r+1<this.lines.length&&this.lines.get(r+1).isWrapped;)r++;return{first:t,last:r}},e.prototype.setupTabStops=function(e){for(null!=e?this.tabs[e]||(e=this.prevStop(e)):(this.tabs={},e=0);e<this._cols;e+=this._optionsService.options.tabStopWidth)this.tabs[e]=!0},e.prototype.prevStop=function(e){for(null==e&&(e=this.x);!this.tabs[--e]&&e>0;);return e>=this._cols?this._cols-1:e<0?0:e},e.prototype.nextStop=function(e){for(null==e&&(e=this.x);!this.tabs[++e]&&e<this._cols;);return e>=this._cols?this._cols-1:e<0?0:e},e.prototype.addMarker=function(e){var t=this,r=new c.Marker(e);return this.markers.push(r),r.register(this.lines.onTrim((function(e){r.line-=e,r.line<0&&r.dispose()}))),r.register(this.lines.onInsert((function(e){r.line>=e.index&&(r.line+=e.amount)}))),r.register(this.lines.onDelete((function(e){r.line>=e.index&&r.line<e.index+e.amount&&r.dispose(),r.line>e.index&&(r.line-=e.amount)}))),r.register(r.onDispose((function(){return t._removeMarker(r)}))),r},e.prototype._removeMarker=function(e){this.markers.splice(this.markers.indexOf(e),1)},e.prototype.iterator=function(e,t,r,i,n){return new f(this,e,t,r,i,n)},e}();t.Buffer=u;var f=function(){function e(e,t,r,i,n,o){void 0===r&&(r=0),void 0===i&&(i=e.lines.length),void 0===n&&(n=0),void 0===o&&(o=0),this._buffer=e,this._trimRight=t,this._startIndex=r,this._endIndex=i,this._startOverscan=n,this._endOverscan=o,this._startIndex<0&&(this._startIndex=0),this._endIndex>this._buffer.lines.length&&(this._endIndex=this._buffer.lines.length),this._current=this._startIndex}return e.prototype.hasNext=function(){return this._current<this._endIndex},e.prototype.next=function(){var e=this._buffer.getWrappedRangeForLine(this._current);e.first<this._startIndex-this._startOverscan&&(e.first=this._startIndex-this._startOverscan),e.last>this._endIndex+this._endOverscan&&(e.last=this._endIndex+this._endOverscan),e.first=Math.max(e.first,0),e.last=Math.min(e.last,this._buffer.lines.length);for(var t="",r=e.first;r<=e.last;++r)t+=this._buffer.translateBufferLineToString(r,this._trimRight);return this._current=e.last+1,{range:e,content:t}},e}();t.BufferStringIterator=f},8437:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.BufferLine=t.DEFAULT_ATTR_DATA=void 0;var i=r(482),n=r(643),o=r(511),s=r(3734);t.DEFAULT_ATTR_DATA=Object.freeze(new s.AttributeData);var a=function(){function e(e,t,r){void 0===r&&(r=!1),this.isWrapped=r,this._combined={},this._extendedAttrs={},this._data=new Uint32Array(3*e);for(var i=t||o.CellData.fromCharData([0,n.NULL_CELL_CHAR,n.NULL_CELL_WIDTH,n.NULL_CELL_CODE]),s=0;s<e;++s)this.setCell(s,i);this.length=e}return e.prototype.get=function(e){var t=this._data[3*e+0],r=2097151&t;return[this._data[3*e+1],2097152&t?this._combined[e]:r?i.stringFromCodePoint(r):"",t>>22,2097152&t?this._combined[e].charCodeAt(this._combined[e].length-1):r]},e.prototype.set=function(e,t){this._data[3*e+1]=t[n.CHAR_DATA_ATTR_INDEX],t[n.CHAR_DATA_CHAR_INDEX].length>1?(this._combined[e]=t[1],this._data[3*e+0]=2097152|e|t[n.CHAR_DATA_WIDTH_INDEX]<<22):this._data[3*e+0]=t[n.CHAR_DATA_CHAR_INDEX].charCodeAt(0)|t[n.CHAR_DATA_WIDTH_INDEX]<<22},e.prototype.getWidth=function(e){return this._data[3*e+0]>>22},e.prototype.hasWidth=function(e){return 12582912&this._data[3*e+0]},e.prototype.getFg=function(e){return this._data[3*e+1]},e.prototype.getBg=function(e){return this._data[3*e+2]},e.prototype.hasContent=function(e){return 4194303&this._data[3*e+0]},e.prototype.getCodePoint=function(e){var t=this._data[3*e+0];return 2097152&t?this._combined[e].charCodeAt(this._combined[e].length-1):2097151&t},e.prototype.isCombined=function(e){return 2097152&this._data[3*e+0]},e.prototype.getString=function(e){var t=this._data[3*e+0];return 2097152&t?this._combined[e]:2097151&t?i.stringFromCodePoint(2097151&t):""},e.prototype.loadCell=function(e,t){var r=3*e;return t.content=this._data[r+0],t.fg=this._data[r+1],t.bg=this._data[r+2],2097152&t.content&&(t.combinedData=this._combined[e]),268435456&t.bg&&(t.extended=this._extendedAttrs[e]),t},e.prototype.setCell=function(e,t){2097152&t.content&&(this._combined[e]=t.combinedData),268435456&t.bg&&(this._extendedAttrs[e]=t.extended),this._data[3*e+0]=t.content,this._data[3*e+1]=t.fg,this._data[3*e+2]=t.bg},e.prototype.setCellFromCodePoint=function(e,t,r,i,n,o){268435456&n&&(this._extendedAttrs[e]=o),this._data[3*e+0]=t|r<<22,this._data[3*e+1]=i,this._data[3*e+2]=n},e.prototype.addCodepointToCell=function(e,t){var r=this._data[3*e+0];2097152&r?this._combined[e]+=i.stringFromCodePoint(t):(2097151&r?(this._combined[e]=i.stringFromCodePoint(2097151&r)+i.stringFromCodePoint(t),r&=-2097152,r|=2097152):r=t|1<<22,this._data[3*e+0]=r)},e.prototype.insertCells=function(e,t,r,i){if((e%=this.length)&&2===this.getWidth(e-1)&&this.setCellFromCodePoint(e-1,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs),t<this.length-e){for(var n=new o.CellData,a=this.length-e-t-1;a>=0;--a)this.setCell(e+t+a,this.loadCell(e+a,n));for(a=0;a<t;++a)this.setCell(e+a,r)}else for(a=e;a<this.length;++a)this.setCell(a,r);2===this.getWidth(this.length-1)&&this.setCellFromCodePoint(this.length-1,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs)},e.prototype.deleteCells=function(e,t,r,i){if(e%=this.length,t<this.length-e){for(var n=new o.CellData,a=0;a<this.length-e-t;++a)this.setCell(e+a,this.loadCell(e+t+a,n));for(a=this.length-t;a<this.length;++a)this.setCell(a,r)}else for(a=e;a<this.length;++a)this.setCell(a,r);e&&2===this.getWidth(e-1)&&this.setCellFromCodePoint(e-1,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs),0!==this.getWidth(e)||this.hasContent(e)||this.setCellFromCodePoint(e,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs)},e.prototype.replaceCells=function(e,t,r,i){for(e&&2===this.getWidth(e-1)&&this.setCellFromCodePoint(e-1,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs),t<this.length&&2===this.getWidth(t-1)&&this.setCellFromCodePoint(t,0,1,(null==i?void 0:i.fg)||0,(null==i?void 0:i.bg)||0,(null==i?void 0:i.extended)||new s.ExtendedAttrs);e<t&&e<this.length;)this.setCell(e++,r)},e.prototype.resize=function(e,t){if(e!==this.length){if(e>this.length){var r=new Uint32Array(3*e);this.length&&(3*e<this._data.length?r.set(this._data.subarray(0,3*e)):r.set(this._data)),this._data=r;for(var i=this.length;i<e;++i)this.setCell(i,t)}else if(e){(r=new Uint32Array(3*e)).set(this._data.subarray(0,3*e)),this._data=r;var n=Object.keys(this._combined);for(i=0;i<n.length;i++){var o=parseInt(n[i],10);o>=e&&delete this._combined[o]}}else this._data=new Uint32Array(0),this._combined={};this.length=e}},e.prototype.fill=function(e){this._combined={},this._extendedAttrs={};for(var t=0;t<this.length;++t)this.setCell(t,e)},e.prototype.copyFrom=function(e){for(var t in this.length!==e.length?this._data=new Uint32Array(e._data):this._data.set(e._data),this.length=e.length,this._combined={},e._combined)this._combined[t]=e._combined[t];for(var t in this._extendedAttrs={},e._extendedAttrs)this._extendedAttrs[t]=e._extendedAttrs[t];this.isWrapped=e.isWrapped},e.prototype.clone=function(){var t=new e(0);for(var r in t._data=new Uint32Array(this._data),t.length=this.length,this._combined)t._combined[r]=this._combined[r];for(var r in this._extendedAttrs)t._extendedAttrs[r]=this._extendedAttrs[r];return t.isWrapped=this.isWrapped,t},e.prototype.getTrimmedLength=function(){for(var e=this.length-1;e>=0;--e)if(4194303&this._data[3*e+0])return e+(this._data[3*e+0]>>22);return 0},e.prototype.copyCellsFrom=function(e,t,r,i,n){var o=e._data;if(n)for(var s=i-1;s>=0;s--)for(var a=0;a<3;a++)this._data[3*(r+s)+a]=o[3*(t+s)+a];else for(s=0;s<i;s++)for(a=0;a<3;a++)this._data[3*(r+s)+a]=o[3*(t+s)+a];var c=Object.keys(e._combined);for(a=0;a<c.length;a++){var l=parseInt(c[a],10);l>=t&&(this._combined[l-t+r]=e._combined[l])}},e.prototype.translateToString=function(e,t,r){void 0===e&&(e=!1),void 0===t&&(t=0),void 0===r&&(r=this.length),e&&(r=Math.min(r,this.getTrimmedLength()));for(var o="";t<r;){var s=this._data[3*t+0],a=2097151&s;o+=2097152&s?this._combined[t]:a?i.stringFromCodePoint(a):n.WHITESPACE_CELL_CHAR,t+=s>>22||1}return o},e}();t.BufferLine=a},4634:(e,t)=>{function r(e,t,r){if(t===e.length-1)return e[t].getTrimmedLength();var i=!e[t].hasContent(r-1)&&1===e[t].getWidth(r-1),n=2===e[t+1].getWidth(0);return i&&n?r-1:r}Object.defineProperty(t,"__esModule",{value:!0}),t.getWrappedLineTrimmedLength=t.reflowSmallerGetNewLineLengths=t.reflowLargerApplyNewLayout=t.reflowLargerCreateNewLayout=t.reflowLargerGetLinesToRemove=void 0,t.reflowLargerGetLinesToRemove=function(e,t,i,n,o){for(var s=[],a=0;a<e.length-1;a++){var c=a,l=e.get(++c);if(l.isWrapped){for(var h=[e.get(a)];c<e.length&&l.isWrapped;)h.push(l),l=e.get(++c);if(n>=a&&n<c)a+=h.length-1;else{for(var u=0,f=r(h,u,t),_=1,d=0;_<h.length;){var p=r(h,_,t),v=p-d,g=i-f,y=Math.min(v,g);h[u].copyCellsFrom(h[_],d,f,y,!1),(f+=y)===i&&(u++,f=0),(d+=y)===p&&(_++,d=0),0===f&&0!==u&&2===h[u-1].getWidth(i-1)&&(h[u].copyCellsFrom(h[u-1],i-1,f++,1,!1),h[u-1].setCell(i-1,o))}h[u].replaceCells(f,i,o);for(var b=0,S=h.length-1;S>0&&(S>u||0===h[S].getTrimmedLength());S--)b++;b>0&&(s.push(a+h.length-b),s.push(b)),a+=h.length-1}}}return s},t.reflowLargerCreateNewLayout=function(e,t){for(var r=[],i=0,n=t[i],o=0,s=0;s<e.length;s++)if(n===s){var a=t[++i];e.onDeleteEmitter.fire({index:s-o,amount:a}),s+=a-1,o+=a,n=t[++i]}else r.push(s);return{layout:r,countRemoved:o}},t.reflowLargerApplyNewLayout=function(e,t){for(var r=[],i=0;i<t.length;i++)r.push(e.get(t[i]));for(i=0;i<r.length;i++)e.set(i,r[i]);e.length=t.length},t.reflowSmallerGetNewLineLengths=function(e,t,i){for(var n=[],o=e.map((function(i,n){return r(e,n,t)})).reduce((function(e,t){return e+t})),s=0,a=0,c=0;c<o;){if(o-c<i){n.push(o-c);break}s+=i;var l=r(e,a,t);s>l&&(s-=l,a++);var h=2===e[a].getWidth(s-1);h&&s--;var u=h?i-1:i;n.push(u),c+=u}return n},t.getWrappedLineTrimmedLength=r},5295:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.BufferSet=void 0;var o=r(9092),s=r(8460),a=function(e){function t(t,r){var i=e.call(this)||this;return i._optionsService=t,i._bufferService=r,i._onBufferActivate=i.register(new s.EventEmitter),i.reset(),i}return n(t,e),Object.defineProperty(t.prototype,"onBufferActivate",{get:function(){return this._onBufferActivate.event},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this._normal=new o.Buffer(!0,this._optionsService,this._bufferService),this._normal.fillViewportRows(),this._alt=new o.Buffer(!1,this._optionsService,this._bufferService),this._activeBuffer=this._normal,this.setupTabStops()},Object.defineProperty(t.prototype,"alt",{get:function(){return this._alt},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"active",{get:function(){return this._activeBuffer},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"normal",{get:function(){return this._normal},enumerable:!1,configurable:!0}),t.prototype.activateNormalBuffer=function(){this._activeBuffer!==this._normal&&(this._normal.x=this._alt.x,this._normal.y=this._alt.y,this._alt.clear(),this._activeBuffer=this._normal,this._onBufferActivate.fire({activeBuffer:this._normal,inactiveBuffer:this._alt}))},t.prototype.activateAltBuffer=function(e){this._activeBuffer!==this._alt&&(this._alt.fillViewportRows(e),this._alt.x=this._normal.x,this._alt.y=this._normal.y,this._activeBuffer=this._alt,this._onBufferActivate.fire({activeBuffer:this._alt,inactiveBuffer:this._normal}))},t.prototype.resize=function(e,t){this._normal.resize(e,t),this._alt.resize(e,t)},t.prototype.setupTabStops=function(e){this._normal.setupTabStops(e),this._alt.setupTabStops(e)},t}(r(844).Disposable);t.BufferSet=a},511:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.CellData=void 0;var o=r(482),s=r(643),a=r(3734),c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.content=0,t.fg=0,t.bg=0,t.extended=new a.ExtendedAttrs,t.combinedData="",t}return n(t,e),t.fromCharData=function(e){var r=new t;return r.setFromCharData(e),r},t.prototype.isCombined=function(){return 2097152&this.content},t.prototype.getWidth=function(){return this.content>>22},t.prototype.getChars=function(){return 2097152&this.content?this.combinedData:2097151&this.content?o.stringFromCodePoint(2097151&this.content):""},t.prototype.getCode=function(){return this.isCombined()?this.combinedData.charCodeAt(this.combinedData.length-1):2097151&this.content},t.prototype.setFromCharData=function(e){this.fg=e[s.CHAR_DATA_ATTR_INDEX],this.bg=0;var t=!1;if(e[s.CHAR_DATA_CHAR_INDEX].length>2)t=!0;else if(2===e[s.CHAR_DATA_CHAR_INDEX].length){var r=e[s.CHAR_DATA_CHAR_INDEX].charCodeAt(0);if(55296<=r&&r<=56319){var i=e[s.CHAR_DATA_CHAR_INDEX].charCodeAt(1);56320<=i&&i<=57343?this.content=1024*(r-55296)+i-56320+65536|e[s.CHAR_DATA_WIDTH_INDEX]<<22:t=!0}else t=!0}else this.content=e[s.CHAR_DATA_CHAR_INDEX].charCodeAt(0)|e[s.CHAR_DATA_WIDTH_INDEX]<<22;t&&(this.combinedData=e[s.CHAR_DATA_CHAR_INDEX],this.content=2097152|e[s.CHAR_DATA_WIDTH_INDEX]<<22)},t.prototype.getAsCharData=function(){return[this.fg,this.getChars(),this.getWidth(),this.getCode()]},t}(a.AttributeData);t.CellData=c},643:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WHITESPACE_CELL_CODE=t.WHITESPACE_CELL_WIDTH=t.WHITESPACE_CELL_CHAR=t.NULL_CELL_CODE=t.NULL_CELL_WIDTH=t.NULL_CELL_CHAR=t.CHAR_DATA_CODE_INDEX=t.CHAR_DATA_WIDTH_INDEX=t.CHAR_DATA_CHAR_INDEX=t.CHAR_DATA_ATTR_INDEX=t.DEFAULT_ATTR=t.DEFAULT_COLOR=void 0,t.DEFAULT_COLOR=256,t.DEFAULT_ATTR=256|t.DEFAULT_COLOR<<9,t.CHAR_DATA_ATTR_INDEX=0,t.CHAR_DATA_CHAR_INDEX=1,t.CHAR_DATA_WIDTH_INDEX=2,t.CHAR_DATA_CODE_INDEX=3,t.NULL_CELL_CHAR="",t.NULL_CELL_WIDTH=1,t.NULL_CELL_CODE=0,t.WHITESPACE_CELL_CHAR=" ",t.WHITESPACE_CELL_WIDTH=1,t.WHITESPACE_CELL_CODE=32},4863:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.Marker=void 0;var o=r(8460),s=function(e){function t(r){var i=e.call(this)||this;return i.line=r,i._id=t._nextId++,i.isDisposed=!1,i._onDispose=new o.EventEmitter,i}return n(t,e),Object.defineProperty(t.prototype,"id",{get:function(){return this._id},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onDispose",{get:function(){return this._onDispose.event},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){this.isDisposed||(this.isDisposed=!0,this.line=-1,this._onDispose.fire(),e.prototype.dispose.call(this))},t._nextId=1,t}(r(844).Disposable);t.Marker=s},7116:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_CHARSET=t.CHARSETS=void 0,t.CHARSETS={},t.DEFAULT_CHARSET=t.CHARSETS.B,t.CHARSETS[0]={"`":"◆",a:"▒",b:"␉",c:"␌",d:"␍",e:"␊",f:"°",g:"±",h:"␤",i:"␋",j:"┘",k:"┐",l:"┌",m:"└",n:"┼",o:"⎺",p:"⎻",q:"─",r:"⎼",s:"⎽",t:"├",u:"┤",v:"┴",w:"┬",x:"│",y:"≤",z:"≥","{":"π","|":"≠","}":"£","~":"·"},t.CHARSETS.A={"#":"£"},t.CHARSETS.B=void 0,t.CHARSETS[4]={"#":"£","@":"¾","[":"ij","\\":"½","]":"|","{":"¨","|":"f","}":"¼","~":"´"},t.CHARSETS.C=t.CHARSETS[5]={"[":"Ä","\\":"Ö","]":"Å","^":"Ü","`":"é","{":"ä","|":"ö","}":"å","~":"ü"},t.CHARSETS.R={"#":"£","@":"à","[":"°","\\":"ç","]":"§","{":"é","|":"ù","}":"è","~":"¨"},t.CHARSETS.Q={"@":"à","[":"â","\\":"ç","]":"ê","^":"î","`":"ô","{":"é","|":"ù","}":"è","~":"û"},t.CHARSETS.K={"@":"§","[":"Ä","\\":"Ö","]":"Ü","{":"ä","|":"ö","}":"ü","~":"ß"},t.CHARSETS.Y={"#":"£","@":"§","[":"°","\\":"ç","]":"é","`":"ù","{":"à","|":"ò","}":"è","~":"ì"},t.CHARSETS.E=t.CHARSETS[6]={"@":"Ä","[":"Æ","\\":"Ø","]":"Å","^":"Ü","`":"ä","{":"æ","|":"ø","}":"å","~":"ü"},t.CHARSETS.Z={"#":"£","@":"§","[":"¡","\\":"Ñ","]":"¿","{":"°","|":"ñ","}":"ç"},t.CHARSETS.H=t.CHARSETS[7]={"@":"É","[":"Ä","\\":"Ö","]":"Å","^":"Ü","`":"é","{":"ä","|":"ö","}":"å","~":"ü"},t.CHARSETS["="]={"#":"ù","@":"à","[":"é","\\":"ç","]":"ê","^":"î",_:"è","`":"ô","{":"ä","|":"ö","}":"ü","~":"û"}},2584:(e,t)=>{var r,i;Object.defineProperty(t,"__esModule",{value:!0}),t.C1=t.C0=void 0,(i=t.C0||(t.C0={})).NUL="\0",i.SOH="",i.STX="",i.ETX="",i.EOT="",i.ENQ="",i.ACK="",i.BEL="",i.BS="\b",i.HT="\t",i.LF="\n",i.VT="\v",i.FF="\f",i.CR="\r",i.SO="",i.SI="",i.DLE="",i.DC1="",i.DC2="",i.DC3="",i.DC4="",i.NAK="",i.SYN="",i.ETB="",i.CAN="",i.EM="",i.SUB="",i.ESC="",i.FS="",i.GS="",i.RS="",i.US="",i.SP=" ",i.DEL="",(r=t.C1||(t.C1={})).PAD="",r.HOP="",r.BPH="",r.NBH="",r.IND="",r.NEL="",r.SSA="",r.ESA="",r.HTS="",r.HTJ="",r.VTS="",r.PLD="",r.PLU="",r.RI="",r.SS2="",r.SS3="",r.DCS="",r.PU1="",r.PU2="",r.STS="",r.CCH="",r.MW="",r.SPA="",r.EPA="",r.SOS="",r.SGCI="",r.SCI="",r.CSI="",r.ST="",r.OSC="",r.PM="",r.APC=""},7399:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.evaluateKeyboardEvent=void 0;var i=r(2584),n={48:["0",")"],49:["1","!"],50:["2","@"],51:["3","#"],52:["4","$"],53:["5","%"],54:["6","^"],55:["7","&"],56:["8","*"],57:["9","("],186:[";",":"],187:["=","+"],188:[",","<"],189:["-","_"],190:[".",">"],191:["/","?"],192:["`","~"],219:["[","{"],220:["\\","|"],221:["]","}"],222:["'",'"']};t.evaluateKeyboardEvent=function(e,t,r,o){var s={type:0,cancel:!1,key:void 0},a=(e.shiftKey?1:0)|(e.altKey?2:0)|(e.ctrlKey?4:0)|(e.metaKey?8:0);switch(e.keyCode){case 0:"UIKeyInputUpArrow"===e.key?s.key=t?i.C0.ESC+"OA":i.C0.ESC+"[A":"UIKeyInputLeftArrow"===e.key?s.key=t?i.C0.ESC+"OD":i.C0.ESC+"[D":"UIKeyInputRightArrow"===e.key?s.key=t?i.C0.ESC+"OC":i.C0.ESC+"[C":"UIKeyInputDownArrow"===e.key&&(s.key=t?i.C0.ESC+"OB":i.C0.ESC+"[B");break;case 8:if(e.shiftKey){s.key=i.C0.BS;break}if(e.altKey){s.key=i.C0.ESC+i.C0.DEL;break}s.key=i.C0.DEL;break;case 9:if(e.shiftKey){s.key=i.C0.ESC+"[Z";break}s.key=i.C0.HT,s.cancel=!0;break;case 13:s.key=e.altKey?i.C0.ESC+i.C0.CR:i.C0.CR,s.cancel=!0;break;case 27:s.key=i.C0.ESC,e.altKey&&(s.key=i.C0.ESC+i.C0.ESC),s.cancel=!0;break;case 37:if(e.metaKey)break;a?(s.key=i.C0.ESC+"[1;"+(a+1)+"D",s.key===i.C0.ESC+"[1;3D"&&(s.key=i.C0.ESC+(r?"b":"[1;5D"))):s.key=t?i.C0.ESC+"OD":i.C0.ESC+"[D";break;case 39:if(e.metaKey)break;a?(s.key=i.C0.ESC+"[1;"+(a+1)+"C",s.key===i.C0.ESC+"[1;3C"&&(s.key=i.C0.ESC+(r?"f":"[1;5C"))):s.key=t?i.C0.ESC+"OC":i.C0.ESC+"[C";break;case 38:if(e.metaKey)break;a?(s.key=i.C0.ESC+"[1;"+(a+1)+"A",r||s.key!==i.C0.ESC+"[1;3A"||(s.key=i.C0.ESC+"[1;5A")):s.key=t?i.C0.ESC+"OA":i.C0.ESC+"[A";break;case 40:if(e.metaKey)break;a?(s.key=i.C0.ESC+"[1;"+(a+1)+"B",r||s.key!==i.C0.ESC+"[1;3B"||(s.key=i.C0.ESC+"[1;5B")):s.key=t?i.C0.ESC+"OB":i.C0.ESC+"[B";break;case 45:e.shiftKey||e.ctrlKey||(s.key=i.C0.ESC+"[2~");break;case 46:s.key=a?i.C0.ESC+"[3;"+(a+1)+"~":i.C0.ESC+"[3~";break;case 36:s.key=a?i.C0.ESC+"[1;"+(a+1)+"H":t?i.C0.ESC+"OH":i.C0.ESC+"[H";break;case 35:s.key=a?i.C0.ESC+"[1;"+(a+1)+"F":t?i.C0.ESC+"OF":i.C0.ESC+"[F";break;case 33:e.shiftKey?s.type=2:s.key=i.C0.ESC+"[5~";break;case 34:e.shiftKey?s.type=3:s.key=i.C0.ESC+"[6~";break;case 112:s.key=a?i.C0.ESC+"[1;"+(a+1)+"P":i.C0.ESC+"OP";break;case 113:s.key=a?i.C0.ESC+"[1;"+(a+1)+"Q":i.C0.ESC+"OQ";break;case 114:s.key=a?i.C0.ESC+"[1;"+(a+1)+"R":i.C0.ESC+"OR";break;case 115:s.key=a?i.C0.ESC+"[1;"+(a+1)+"S":i.C0.ESC+"OS";break;case 116:s.key=a?i.C0.ESC+"[15;"+(a+1)+"~":i.C0.ESC+"[15~";break;case 117:s.key=a?i.C0.ESC+"[17;"+(a+1)+"~":i.C0.ESC+"[17~";break;case 118:s.key=a?i.C0.ESC+"[18;"+(a+1)+"~":i.C0.ESC+"[18~";break;case 119:s.key=a?i.C0.ESC+"[19;"+(a+1)+"~":i.C0.ESC+"[19~";break;case 120:s.key=a?i.C0.ESC+"[20;"+(a+1)+"~":i.C0.ESC+"[20~";break;case 121:s.key=a?i.C0.ESC+"[21;"+(a+1)+"~":i.C0.ESC+"[21~";break;case 122:s.key=a?i.C0.ESC+"[23;"+(a+1)+"~":i.C0.ESC+"[23~";break;case 123:s.key=a?i.C0.ESC+"[24;"+(a+1)+"~":i.C0.ESC+"[24~";break;default:if(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey)if(r&&!o||!e.altKey||e.metaKey)!r||e.altKey||e.ctrlKey||e.shiftKey||!e.metaKey?e.key&&!e.ctrlKey&&!e.altKey&&!e.metaKey&&e.keyCode>=48&&1===e.key.length?s.key=e.key:e.key&&e.ctrlKey&&"_"===e.key&&(s.key=i.C0.US):65===e.keyCode&&(s.type=1);else{var c=n[e.keyCode],l=c&&c[e.shiftKey?1:0];if(l)s.key=i.C0.ESC+l;else if(e.keyCode>=65&&e.keyCode<=90){var h=e.ctrlKey?e.keyCode-64:e.keyCode+32;s.key=i.C0.ESC+String.fromCharCode(h)}}else e.keyCode>=65&&e.keyCode<=90?s.key=String.fromCharCode(e.keyCode-64):32===e.keyCode?s.key=i.C0.NUL:e.keyCode>=51&&e.keyCode<=55?s.key=String.fromCharCode(e.keyCode-51+27):56===e.keyCode?s.key=i.C0.DEL:219===e.keyCode?s.key=i.C0.ESC:220===e.keyCode?s.key=i.C0.FS:221===e.keyCode&&(s.key=i.C0.GS)}return s}},482:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Utf8ToUtf32=t.StringToUtf32=t.utf32ToString=t.stringFromCodePoint=void 0,t.stringFromCodePoint=function(e){return e>65535?(e-=65536,String.fromCharCode(55296+(e>>10))+String.fromCharCode(e%1024+56320)):String.fromCharCode(e)},t.utf32ToString=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=e.length);for(var i="",n=t;n<r;++n){var o=e[n];o>65535?(o-=65536,i+=String.fromCharCode(55296+(o>>10))+String.fromCharCode(o%1024+56320)):i+=String.fromCharCode(o)}return i};var r=function(){function e(){this._interim=0}return e.prototype.clear=function(){this._interim=0},e.prototype.decode=function(e,t){var r=e.length;if(!r)return 0;var i=0,n=0;this._interim&&(56320<=(a=e.charCodeAt(n++))&&a<=57343?t[i++]=1024*(this._interim-55296)+a-56320+65536:(t[i++]=this._interim,t[i++]=a),this._interim=0);for(var o=n;o<r;++o){var s=e.charCodeAt(o);if(55296<=s&&s<=56319){if(++o>=r)return this._interim=s,i;var a;56320<=(a=e.charCodeAt(o))&&a<=57343?t[i++]=1024*(s-55296)+a-56320+65536:(t[i++]=s,t[i++]=a)}else 65279!==s&&(t[i++]=s)}return i},e}();t.StringToUtf32=r;var i=function(){function e(){this.interim=new Uint8Array(3)}return e.prototype.clear=function(){this.interim.fill(0)},e.prototype.decode=function(e,t){var r=e.length;if(!r)return 0;var i,n,o,s,a=0,c=0,l=0;if(this.interim[0]){var h=!1,u=this.interim[0];u&=192==(224&u)?31:224==(240&u)?15:7;for(var f=0,_=void 0;(_=63&this.interim[++f])&&f<4;)u<<=6,u|=_;for(var d=192==(224&this.interim[0])?2:224==(240&this.interim[0])?3:4,p=d-f;l<p;){if(l>=r)return 0;if(128!=(192&(_=e[l++]))){l--,h=!0;break}this.interim[f++]=_,u<<=6,u|=63&_}h||(2===d?u<128?l--:t[a++]=u:3===d?u<2048||u>=55296&&u<=57343||65279===u||(t[a++]=u):u<65536||u>1114111||(t[a++]=u)),this.interim.fill(0)}for(var v=r-4,g=l;g<r;){for(;!(!(g<v)||128&(i=e[g])||128&(n=e[g+1])||128&(o=e[g+2])||128&(s=e[g+3]));)t[a++]=i,t[a++]=n,t[a++]=o,t[a++]=s,g+=4;if((i=e[g++])<128)t[a++]=i;else if(192==(224&i)){if(g>=r)return this.interim[0]=i,a;if(128!=(192&(n=e[g++]))){g--;continue}if((c=(31&i)<<6|63&n)<128){g--;continue}t[a++]=c}else if(224==(240&i)){if(g>=r)return this.interim[0]=i,a;if(128!=(192&(n=e[g++]))){g--;continue}if(g>=r)return this.interim[0]=i,this.interim[1]=n,a;if(128!=(192&(o=e[g++]))){g--;continue}if((c=(15&i)<<12|(63&n)<<6|63&o)<2048||c>=55296&&c<=57343||65279===c)continue;t[a++]=c}else if(240==(248&i)){if(g>=r)return this.interim[0]=i,a;if(128!=(192&(n=e[g++]))){g--;continue}if(g>=r)return this.interim[0]=i,this.interim[1]=n,a;if(128!=(192&(o=e[g++]))){g--;continue}if(g>=r)return this.interim[0]=i,this.interim[1]=n,this.interim[2]=o,a;if(128!=(192&(s=e[g++]))){g--;continue}if((c=(7&i)<<18|(63&n)<<12|(63&o)<<6|63&s)<65536||c>1114111)continue;t[a++]=c}}return a},e}();t.Utf8ToUtf32=i},225:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UnicodeV6=void 0;var i,n=r(8273),o=[[768,879],[1155,1158],[1160,1161],[1425,1469],[1471,1471],[1473,1474],[1476,1477],[1479,1479],[1536,1539],[1552,1557],[1611,1630],[1648,1648],[1750,1764],[1767,1768],[1770,1773],[1807,1807],[1809,1809],[1840,1866],[1958,1968],[2027,2035],[2305,2306],[2364,2364],[2369,2376],[2381,2381],[2385,2388],[2402,2403],[2433,2433],[2492,2492],[2497,2500],[2509,2509],[2530,2531],[2561,2562],[2620,2620],[2625,2626],[2631,2632],[2635,2637],[2672,2673],[2689,2690],[2748,2748],[2753,2757],[2759,2760],[2765,2765],[2786,2787],[2817,2817],[2876,2876],[2879,2879],[2881,2883],[2893,2893],[2902,2902],[2946,2946],[3008,3008],[3021,3021],[3134,3136],[3142,3144],[3146,3149],[3157,3158],[3260,3260],[3263,3263],[3270,3270],[3276,3277],[3298,3299],[3393,3395],[3405,3405],[3530,3530],[3538,3540],[3542,3542],[3633,3633],[3636,3642],[3655,3662],[3761,3761],[3764,3769],[3771,3772],[3784,3789],[3864,3865],[3893,3893],[3895,3895],[3897,3897],[3953,3966],[3968,3972],[3974,3975],[3984,3991],[3993,4028],[4038,4038],[4141,4144],[4146,4146],[4150,4151],[4153,4153],[4184,4185],[4448,4607],[4959,4959],[5906,5908],[5938,5940],[5970,5971],[6002,6003],[6068,6069],[6071,6077],[6086,6086],[6089,6099],[6109,6109],[6155,6157],[6313,6313],[6432,6434],[6439,6440],[6450,6450],[6457,6459],[6679,6680],[6912,6915],[6964,6964],[6966,6970],[6972,6972],[6978,6978],[7019,7027],[7616,7626],[7678,7679],[8203,8207],[8234,8238],[8288,8291],[8298,8303],[8400,8431],[12330,12335],[12441,12442],[43014,43014],[43019,43019],[43045,43046],[64286,64286],[65024,65039],[65056,65059],[65279,65279],[65529,65531]],s=[[68097,68099],[68101,68102],[68108,68111],[68152,68154],[68159,68159],[119143,119145],[119155,119170],[119173,119179],[119210,119213],[119362,119364],[917505,917505],[917536,917631],[917760,917999]],a=function(){function e(){if(this.version="6",!i){i=new Uint8Array(65536),n.fill(i,1),i[0]=0,n.fill(i,0,1,32),n.fill(i,0,127,160),n.fill(i,2,4352,4448),i[9001]=2,i[9002]=2,n.fill(i,2,11904,42192),i[12351]=1,n.fill(i,2,44032,55204),n.fill(i,2,63744,64256),n.fill(i,2,65040,65050),n.fill(i,2,65072,65136),n.fill(i,2,65280,65377),n.fill(i,2,65504,65511);for(var e=0;e<o.length;++e)n.fill(i,0,o[e][0],o[e][1]+1)}}return e.prototype.wcwidth=function(e){return e<32?0:e<127?1:e<65536?i[e]:function(e,t){var r,i=0,n=t.length-1;if(e<t[0][0]||e>t[n][1])return!1;for(;n>=i;)if(e>t[r=i+n>>1][1])i=r+1;else{if(!(e<t[r][0]))return!0;n=r-1}return!1}(e,s)?0:e>=131072&&e<=196605||e>=196608&&e<=262141?2:1},e}();t.UnicodeV6=a},5981:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.WriteBuffer=void 0;var r=function(){function e(e){this._action=e,this._writeBuffer=[],this._callbacks=[],this._pendingData=0,this._bufferOffset=0}return e.prototype.writeSync=function(e){if(this._writeBuffer.length){for(var t=this._bufferOffset;t<this._writeBuffer.length;++t){var r=this._writeBuffer[t],i=this._callbacks[t];this._action(r),i&&i()}this._writeBuffer=[],this._callbacks=[],this._pendingData=0,this._bufferOffset=2147483647}this._action(e)},e.prototype.write=function(e,t){var r=this;if(this._pendingData>5e7)throw new Error("write data discarded, use flow control to avoid losing data");this._writeBuffer.length||(this._bufferOffset=0,setTimeout((function(){return r._innerWrite()}))),this._pendingData+=e.length,this._writeBuffer.push(e),this._callbacks.push(t)},e.prototype._innerWrite=function(){for(var e=this,t=Date.now();this._writeBuffer.length>this._bufferOffset;){var r=this._writeBuffer[this._bufferOffset],i=this._callbacks[this._bufferOffset];if(this._bufferOffset++,this._action(r),this._pendingData-=r.length,i&&i(),Date.now()-t>=12)break}this._writeBuffer.length>this._bufferOffset?(this._bufferOffset>50&&(this._writeBuffer=this._writeBuffer.slice(this._bufferOffset),this._callbacks=this._callbacks.slice(this._bufferOffset),this._bufferOffset=0),setTimeout((function(){return e._innerWrite()}),0)):(this._writeBuffer=[],this._callbacks=[],this._pendingData=0,this._bufferOffset=0)},e}();t.WriteBuffer=r},5770:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.PAYLOAD_LIMIT=void 0,t.PAYLOAD_LIMIT=1e7},6351:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DcsHandler=t.DcsParser=void 0;var i=r(482),n=r(8742),o=r(5770),s=[],a=function(){function e(){this._handlers=Object.create(null),this._active=s,this._ident=0,this._handlerFb=function(){}}return e.prototype.dispose=function(){this._handlers=Object.create(null),this._handlerFb=function(){},this._active=s},e.prototype.registerHandler=function(e,t){void 0===this._handlers[e]&&(this._handlers[e]=[]);var r=this._handlers[e];return r.push(t),{dispose:function(){var e=r.indexOf(t);-1!==e&&r.splice(e,1)}}},e.prototype.clearHandler=function(e){this._handlers[e]&&delete this._handlers[e]},e.prototype.setHandlerFallback=function(e){this._handlerFb=e},e.prototype.reset=function(){this._active.length&&this.unhook(!1),this._active=s,this._ident=0},e.prototype.hook=function(e,t){if(this.reset(),this._ident=e,this._active=this._handlers[e]||s,this._active.length)for(var r=this._active.length-1;r>=0;r--)this._active[r].hook(t);else this._handlerFb(this._ident,"HOOK",t)},e.prototype.put=function(e,t,r){if(this._active.length)for(var n=this._active.length-1;n>=0;n--)this._active[n].put(e,t,r);else this._handlerFb(this._ident,"PUT",i.utf32ToString(e,t,r))},e.prototype.unhook=function(e){if(this._active.length){for(var t=this._active.length-1;t>=0&&!this._active[t].unhook(e);t--);for(t--;t>=0;t--)this._active[t].unhook(!1)}else this._handlerFb(this._ident,"UNHOOK",e);this._active=s,this._ident=0},e}();t.DcsParser=a;var c=new n.Params;c.addParam(0);var l=function(){function e(e){this._handler=e,this._data="",this._params=c,this._hitLimit=!1}return e.prototype.hook=function(e){this._params=e.length>1||e.params[0]?e.clone():c,this._data="",this._hitLimit=!1},e.prototype.put=function(e,t,r){this._hitLimit||(this._data+=i.utf32ToString(e,t,r),this._data.length>o.PAYLOAD_LIMIT&&(this._data="",this._hitLimit=!0))},e.prototype.unhook=function(e){var t=!1;return this._hitLimit?t=!1:e&&(t=this._handler(this._data,this._params)),this._params=c,this._data="",this._hitLimit=!1,t},e}();t.DcsHandler=l},2015:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.EscapeSequenceParser=t.VT500_TRANSITION_TABLE=t.TransitionTable=void 0;var o=r(844),s=r(8273),a=r(8742),c=r(6242),l=r(6351),h=function(){function e(e){this.table=new Uint8Array(e)}return e.prototype.setDefault=function(e,t){s.fill(this.table,e<<4|t)},e.prototype.add=function(e,t,r,i){this.table[t<<8|e]=r<<4|i},e.prototype.addMany=function(e,t,r,i){for(var n=0;n<e.length;n++)this.table[t<<8|e[n]]=r<<4|i},e}();t.TransitionTable=h;var u=160;t.VT500_TRANSITION_TABLE=function(){var e=new h(4095),t=Array.apply(null,Array(256)).map((function(e,t){return t})),r=function(e,r){return t.slice(e,r)},i=r(32,127),n=r(0,24);n.push(25),n.push.apply(n,r(28,32));var o,s=r(0,14);for(o in e.setDefault(1,0),e.addMany(i,0,2,0),s)e.addMany([24,26,153,154],o,3,0),e.addMany(r(128,144),o,3,0),e.addMany(r(144,152),o,3,0),e.add(156,o,0,0),e.add(27,o,11,1),e.add(157,o,4,8),e.addMany([152,158,159],o,0,7),e.add(155,o,11,3),e.add(144,o,11,9);return e.addMany(n,0,3,0),e.addMany(n,1,3,1),e.add(127,1,0,1),e.addMany(n,8,0,8),e.addMany(n,3,3,3),e.add(127,3,0,3),e.addMany(n,4,3,4),e.add(127,4,0,4),e.addMany(n,6,3,6),e.addMany(n,5,3,5),e.add(127,5,0,5),e.addMany(n,2,3,2),e.add(127,2,0,2),e.add(93,1,4,8),e.addMany(i,8,5,8),e.add(127,8,5,8),e.addMany([156,27,24,26,7],8,6,0),e.addMany(r(28,32),8,0,8),e.addMany([88,94,95],1,0,7),e.addMany(i,7,0,7),e.addMany(n,7,0,7),e.add(156,7,0,0),e.add(127,7,0,7),e.add(91,1,11,3),e.addMany(r(64,127),3,7,0),e.addMany(r(48,60),3,8,4),e.addMany([60,61,62,63],3,9,4),e.addMany(r(48,60),4,8,4),e.addMany(r(64,127),4,7,0),e.addMany([60,61,62,63],4,0,6),e.addMany(r(32,64),6,0,6),e.add(127,6,0,6),e.addMany(r(64,127),6,0,0),e.addMany(r(32,48),3,9,5),e.addMany(r(32,48),5,9,5),e.addMany(r(48,64),5,0,6),e.addMany(r(64,127),5,7,0),e.addMany(r(32,48),4,9,5),e.addMany(r(32,48),1,9,2),e.addMany(r(32,48),2,9,2),e.addMany(r(48,127),2,10,0),e.addMany(r(48,80),1,10,0),e.addMany(r(81,88),1,10,0),e.addMany([89,90,92],1,10,0),e.addMany(r(96,127),1,10,0),e.add(80,1,11,9),e.addMany(n,9,0,9),e.add(127,9,0,9),e.addMany(r(28,32),9,0,9),e.addMany(r(32,48),9,9,12),e.addMany(r(48,60),9,8,10),e.addMany([60,61,62,63],9,9,10),e.addMany(n,11,0,11),e.addMany(r(32,128),11,0,11),e.addMany(r(28,32),11,0,11),e.addMany(n,10,0,10),e.add(127,10,0,10),e.addMany(r(28,32),10,0,10),e.addMany(r(48,60),10,8,10),e.addMany([60,61,62,63],10,0,11),e.addMany(r(32,48),10,9,12),e.addMany(n,12,0,12),e.add(127,12,0,12),e.addMany(r(28,32),12,0,12),e.addMany(r(32,48),12,9,12),e.addMany(r(48,64),12,0,11),e.addMany(r(64,127),12,12,13),e.addMany(r(64,127),10,12,13),e.addMany(r(64,127),9,12,13),e.addMany(n,13,13,13),e.addMany(i,13,13,13),e.add(127,13,0,13),e.addMany([27,156,24,26],13,14,0),e.add(u,0,2,0),e.add(u,8,5,8),e.add(u,6,0,6),e.add(u,11,0,11),e.add(u,13,13,13),e}();var f=function(e){function r(r){void 0===r&&(r=t.VT500_TRANSITION_TABLE);var i=e.call(this)||this;return i._transitions=r,i.initialState=0,i.currentState=i.initialState,i._params=new a.Params,i._params.addParam(0),i._collect=0,i.precedingCodepoint=0,i._printHandlerFb=function(e,t,r){},i._executeHandlerFb=function(e){},i._csiHandlerFb=function(e,t){},i._escHandlerFb=function(e){},i._errorHandlerFb=function(e){return e},i._printHandler=i._printHandlerFb,i._executeHandlers=Object.create(null),i._csiHandlers=Object.create(null),i._escHandlers=Object.create(null),i._oscParser=new c.OscParser,i._dcsParser=new l.DcsParser,i._errorHandler=i._errorHandlerFb,i.registerEscHandler({final:"\\"},(function(){return!0})),i}return n(r,e),r.prototype._identifier=function(e,t){void 0===t&&(t=[64,126]);var r=0;if(e.prefix){if(e.prefix.length>1)throw new Error("only one byte as prefix supported");if((r=e.prefix.charCodeAt(0))&&60>r||r>63)throw new Error("prefix must be in range 0x3c .. 0x3f")}if(e.intermediates){if(e.intermediates.length>2)throw new Error("only two bytes as intermediates are supported");for(var i=0;i<e.intermediates.length;++i){var n=e.intermediates.charCodeAt(i);if(32>n||n>47)throw new Error("intermediate must be in range 0x20 .. 0x2f");r<<=8,r|=n}}if(1!==e.final.length)throw new Error("final must be a single byte");var o=e.final.charCodeAt(0);if(t[0]>o||o>t[1])throw new Error("final must be in range "+t[0]+" .. "+t[1]);return(r<<=8)|o},r.prototype.identToString=function(e){for(var t=[];e;)t.push(String.fromCharCode(255&e)),e>>=8;return t.reverse().join("")},r.prototype.dispose=function(){this._csiHandlers=Object.create(null),this._executeHandlers=Object.create(null),this._escHandlers=Object.create(null),this._oscParser.dispose(),this._dcsParser.dispose()},r.prototype.setPrintHandler=function(e){this._printHandler=e},r.prototype.clearPrintHandler=function(){this._printHandler=this._printHandlerFb},r.prototype.registerEscHandler=function(e,t){var r=this._identifier(e,[48,126]);void 0===this._escHandlers[r]&&(this._escHandlers[r]=[]);var i=this._escHandlers[r];return i.push(t),{dispose:function(){var e=i.indexOf(t);-1!==e&&i.splice(e,1)}}},r.prototype.clearEscHandler=function(e){this._escHandlers[this._identifier(e,[48,126])]&&delete this._escHandlers[this._identifier(e,[48,126])]},r.prototype.setEscHandlerFallback=function(e){this._escHandlerFb=e},r.prototype.setExecuteHandler=function(e,t){this._executeHandlers[e.charCodeAt(0)]=t},r.prototype.clearExecuteHandler=function(e){this._executeHandlers[e.charCodeAt(0)]&&delete this._executeHandlers[e.charCodeAt(0)]},r.prototype.setExecuteHandlerFallback=function(e){this._executeHandlerFb=e},r.prototype.registerCsiHandler=function(e,t){var r=this._identifier(e);void 0===this._csiHandlers[r]&&(this._csiHandlers[r]=[]);var i=this._csiHandlers[r];return i.push(t),{dispose:function(){var e=i.indexOf(t);-1!==e&&i.splice(e,1)}}},r.prototype.clearCsiHandler=function(e){this._csiHandlers[this._identifier(e)]&&delete this._csiHandlers[this._identifier(e)]},r.prototype.setCsiHandlerFallback=function(e){this._csiHandlerFb=e},r.prototype.registerDcsHandler=function(e,t){return this._dcsParser.registerHandler(this._identifier(e),t)},r.prototype.clearDcsHandler=function(e){this._dcsParser.clearHandler(this._identifier(e))},r.prototype.setDcsHandlerFallback=function(e){this._dcsParser.setHandlerFallback(e)},r.prototype.registerOscHandler=function(e,t){return this._oscParser.registerHandler(e,t)},r.prototype.clearOscHandler=function(e){this._oscParser.clearHandler(e)},r.prototype.setOscHandlerFallback=function(e){this._oscParser.setHandlerFallback(e)},r.prototype.setErrorHandler=function(e){this._errorHandler=e},r.prototype.clearErrorHandler=function(){this._errorHandler=this._errorHandlerFb},r.prototype.reset=function(){this.currentState=this.initialState,this._oscParser.reset(),this._dcsParser.reset(),this._params.reset(),this._params.addParam(0),this._collect=0,this.precedingCodepoint=0},r.prototype.parse=function(e,t){for(var r=0,i=0,n=this.currentState,o=this._oscParser,s=this._dcsParser,a=this._collect,c=this._params,l=this._transitions.table,h=0;h<t;++h){switch((i=l[n<<8|((r=e[h])<160?r:u)])>>4){case 2:for(var f=h+1;;++f){if(f>=t||(r=e[f])<32||r>126&&r<u){this._printHandler(e,h,f),h=f-1;break}if(++f>=t||(r=e[f])<32||r>126&&r<u){this._printHandler(e,h,f),h=f-1;break}if(++f>=t||(r=e[f])<32||r>126&&r<u){this._printHandler(e,h,f),h=f-1;break}if(++f>=t||(r=e[f])<32||r>126&&r<u){this._printHandler(e,h,f),h=f-1;break}}break;case 3:this._executeHandlers[r]?this._executeHandlers[r]():this._executeHandlerFb(r),this.precedingCodepoint=0;break;case 0:break;case 1:if(this._errorHandler({position:h,code:r,currentState:n,collect:a,params:c,abort:!1}).abort)return;break;case 7:for(var _=this._csiHandlers[a<<8|r],d=_?_.length-1:-1;d>=0&&!_[d](c);d--);d<0&&this._csiHandlerFb(a<<8|r,c),this.precedingCodepoint=0;break;case 8:do{switch(r){case 59:c.addParam(0);break;case 58:c.addSubParam(-1);break;default:c.addDigit(r-48)}}while(++h<t&&(r=e[h])>47&&r<60);h--;break;case 9:a<<=8,a|=r;break;case 10:for(var p=this._escHandlers[a<<8|r],v=p?p.length-1:-1;v>=0&&!p[v]();v--);v<0&&this._escHandlerFb(a<<8|r),this.precedingCodepoint=0;break;case 11:c.reset(),c.addParam(0),a=0;break;case 12:s.hook(a<<8|r,c);break;case 13:for(var g=h+1;;++g)if(g>=t||24===(r=e[g])||26===r||27===r||r>127&&r<u){s.put(e,h,g),h=g-1;break}break;case 14:s.unhook(24!==r&&26!==r),27===r&&(i|=1),c.reset(),c.addParam(0),a=0,this.precedingCodepoint=0;break;case 4:o.start();break;case 5:for(var y=h+1;;y++)if(y>=t||(r=e[y])<32||r>127&&r<u){o.put(e,h,y),h=y-1;break}break;case 6:o.end(24!==r&&26!==r),27===r&&(i|=1),c.reset(),c.addParam(0),a=0,this.precedingCodepoint=0}n=15&i}this._collect=a,this.currentState=n},r}(o.Disposable);t.EscapeSequenceParser=f},6242:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OscHandler=t.OscParser=void 0;var i=r(5770),n=r(482),o=[],s=function(){function e(){this._state=0,this._active=o,this._id=-1,this._handlers=Object.create(null),this._handlerFb=function(){}}return e.prototype.registerHandler=function(e,t){void 0===this._handlers[e]&&(this._handlers[e]=[]);var r=this._handlers[e];return r.push(t),{dispose:function(){var e=r.indexOf(t);-1!==e&&r.splice(e,1)}}},e.prototype.clearHandler=function(e){this._handlers[e]&&delete this._handlers[e]},e.prototype.setHandlerFallback=function(e){this._handlerFb=e},e.prototype.dispose=function(){this._handlers=Object.create(null),this._handlerFb=function(){},this._active=o},e.prototype.reset=function(){2===this._state&&this.end(!1),this._active=o,this._id=-1,this._state=0},e.prototype._start=function(){if(this._active=this._handlers[this._id]||o,this._active.length)for(var e=this._active.length-1;e>=0;e--)this._active[e].start();else this._handlerFb(this._id,"START")},e.prototype._put=function(e,t,r){if(this._active.length)for(var i=this._active.length-1;i>=0;i--)this._active[i].put(e,t,r);else this._handlerFb(this._id,"PUT",n.utf32ToString(e,t,r))},e.prototype._end=function(e){if(this._active.length){for(var t=this._active.length-1;t>=0&&!this._active[t].end(e);t--);for(t--;t>=0;t--)this._active[t].end(!1)}else this._handlerFb(this._id,"END",e)},e.prototype.start=function(){this.reset(),this._state=1},e.prototype.put=function(e,t,r){if(3!==this._state){if(1===this._state)for(;t<r;){var i=e[t++];if(59===i){this._state=2,this._start();break}if(i<48||57<i)return void(this._state=3);-1===this._id&&(this._id=0),this._id=10*this._id+i-48}2===this._state&&r-t>0&&this._put(e,t,r)}},e.prototype.end=function(e){0!==this._state&&(3!==this._state&&(1===this._state&&this._start(),this._end(e)),this._active=o,this._id=-1,this._state=0)},e}();t.OscParser=s;var a=function(){function e(e){this._handler=e,this._data="",this._hitLimit=!1}return e.prototype.start=function(){this._data="",this._hitLimit=!1},e.prototype.put=function(e,t,r){this._hitLimit||(this._data+=n.utf32ToString(e,t,r),this._data.length>i.PAYLOAD_LIMIT&&(this._data="",this._hitLimit=!0))},e.prototype.end=function(e){var t=!1;return this._hitLimit?t=!1:e&&(t=this._handler(this._data)),this._data="",this._hitLimit=!1,t},e}();t.OscHandler=a},8742:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Params=void 0;var r=2147483647,i=function(){function e(e,t){if(void 0===e&&(e=32),void 0===t&&(t=32),this.maxLength=e,this.maxSubParamsLength=t,t>256)throw new Error("maxSubParamsLength must not be greater than 256");this.params=new Int32Array(e),this.length=0,this._subParams=new Int32Array(t),this._subParamsLength=0,this._subParamsIdx=new Uint16Array(e),this._rejectDigits=!1,this._rejectSubDigits=!1,this._digitIsSub=!1}return e.fromArray=function(t){var r=new e;if(!t.length)return r;for(var i=t[0]instanceof Array?1:0;i<t.length;++i){var n=t[i];if(n instanceof Array)for(var o=0;o<n.length;++o)r.addSubParam(n[o]);else r.addParam(n)}return r},e.prototype.clone=function(){var t=new e(this.maxLength,this.maxSubParamsLength);return t.params.set(this.params),t.length=this.length,t._subParams.set(this._subParams),t._subParamsLength=this._subParamsLength,t._subParamsIdx.set(this._subParamsIdx),t._rejectDigits=this._rejectDigits,t._rejectSubDigits=this._rejectSubDigits,t._digitIsSub=this._digitIsSub,t},e.prototype.toArray=function(){for(var e=[],t=0;t<this.length;++t){e.push(this.params[t]);var r=this._subParamsIdx[t]>>8,i=255&this._subParamsIdx[t];i-r>0&&e.push(Array.prototype.slice.call(this._subParams,r,i))}return e},e.prototype.reset=function(){this.length=0,this._subParamsLength=0,this._rejectDigits=!1,this._rejectSubDigits=!1,this._digitIsSub=!1},e.prototype.addParam=function(e){if(this._digitIsSub=!1,this.length>=this.maxLength)this._rejectDigits=!0;else{if(e<-1)throw new Error("values lesser than -1 are not allowed");this._subParamsIdx[this.length]=this._subParamsLength<<8|this._subParamsLength,this.params[this.length++]=e>r?r:e}},e.prototype.addSubParam=function(e){if(this._digitIsSub=!0,this.length)if(this._rejectDigits||this._subParamsLength>=this.maxSubParamsLength)this._rejectSubDigits=!0;else{if(e<-1)throw new Error("values lesser than -1 are not allowed");this._subParams[this._subParamsLength++]=e>r?r:e,this._subParamsIdx[this.length-1]++}},e.prototype.hasSubParams=function(e){return(255&this._subParamsIdx[e])-(this._subParamsIdx[e]>>8)>0},e.prototype.getSubParams=function(e){var t=this._subParamsIdx[e]>>8,r=255&this._subParamsIdx[e];return r-t>0?this._subParams.subarray(t,r):null},e.prototype.getSubParamsAll=function(){for(var e={},t=0;t<this.length;++t){var r=this._subParamsIdx[t]>>8,i=255&this._subParamsIdx[t];i-r>0&&(e[t]=this._subParams.slice(r,i))}return e},e.prototype.addDigit=function(e){var t;if(!(this._rejectDigits||!(t=this._digitIsSub?this._subParamsLength:this.length)||this._digitIsSub&&this._rejectSubDigits)){var i=this._digitIsSub?this._subParams:this.params,n=i[t-1];i[t-1]=~n?Math.min(10*n+e,r):e}},e}();t.Params=i},744:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.BufferService=t.MINIMUM_ROWS=t.MINIMUM_COLS=void 0;var a=r(2585),c=r(5295),l=r(8460),h=r(844);t.MINIMUM_COLS=2,t.MINIMUM_ROWS=1;var u=function(e){function r(r){var i=e.call(this)||this;return i._optionsService=r,i.isUserScrolling=!1,i._onResize=new l.EventEmitter,i.cols=Math.max(r.options.cols,t.MINIMUM_COLS),i.rows=Math.max(r.options.rows,t.MINIMUM_ROWS),i.buffers=new c.BufferSet(r,i),i}return n(r,e),Object.defineProperty(r.prototype,"onResize",{get:function(){return this._onResize.event},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"buffer",{get:function(){return this.buffers.active},enumerable:!1,configurable:!0}),r.prototype.dispose=function(){e.prototype.dispose.call(this),this.buffers.dispose()},r.prototype.resize=function(e,t){this.cols=e,this.rows=t,this.buffers.resize(e,t),this.buffers.setupTabStops(this.cols),this._onResize.fire({cols:e,rows:t})},r.prototype.reset=function(){this.buffers.reset(),this.isUserScrolling=!1},o([s(0,a.IOptionsService)],r)}(h.Disposable);t.BufferService=u},7994:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.CharsetService=void 0;var r=function(){function e(){this.glevel=0,this._charsets=[]}return e.prototype.reset=function(){this.charset=void 0,this._charsets=[],this.glevel=0},e.prototype.setgLevel=function(e){this.glevel=e,this.charset=this._charsets[e]},e.prototype.setgCharset=function(e,t){this._charsets[e]=t,this.glevel===e&&(this.charset=t)},e}();t.CharsetService=r},1753:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.CoreMouseService=void 0;var o=r(2585),s=r(8460),a={NONE:{events:0,restrict:function(){return!1}},X10:{events:1,restrict:function(e){return 4!==e.button&&1===e.action&&(e.ctrl=!1,e.alt=!1,e.shift=!1,!0)}},VT200:{events:19,restrict:function(e){return 32!==e.action}},DRAG:{events:23,restrict:function(e){return 32!==e.action||3!==e.button}},ANY:{events:31,restrict:function(e){return!0}}};function c(e,t){var r=(e.ctrl?16:0)|(e.shift?4:0)|(e.alt?8:0);return 4===e.button?(r|=64,r|=e.action):(r|=3&e.button,4&e.button&&(r|=64),8&e.button&&(r|=128),32===e.action?r|=32:0!==e.action||t||(r|=3)),r}var l=String.fromCharCode,h={DEFAULT:function(e){var t=[c(e,!1)+32,e.col+32,e.row+32];return t[0]>255||t[1]>255||t[2]>255?"":"[M"+l(t[0])+l(t[1])+l(t[2])},SGR:function(e){var t=0===e.action&&4!==e.button?"m":"M";return"[<"+c(e,!0)+";"+e.col+";"+e.row+t}},u=function(){function e(e,t){this._bufferService=e,this._coreService=t,this._protocols={},this._encodings={},this._activeProtocol="",this._activeEncoding="",this._onProtocolChange=new s.EventEmitter,this._lastEvent=null;for(var r=0,i=Object.keys(a);r<i.length;r++){var n=i[r];this.addProtocol(n,a[n])}for(var o=0,c=Object.keys(h);o<c.length;o++){var l=c[o];this.addEncoding(l,h[l])}this.reset()}return e.prototype.addProtocol=function(e,t){this._protocols[e]=t},e.prototype.addEncoding=function(e,t){this._encodings[e]=t},Object.defineProperty(e.prototype,"activeProtocol",{get:function(){return this._activeProtocol},set:function(e){if(!this._protocols[e])throw new Error('unknown protocol "'+e+'"');this._activeProtocol=e,this._onProtocolChange.fire(this._protocols[e].events)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"areMouseEventsActive",{get:function(){return 0!==this._protocols[this._activeProtocol].events},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeEncoding",{get:function(){return this._activeEncoding},set:function(e){if(!this._encodings[e])throw new Error('unknown encoding "'+e+'"');this._activeEncoding=e},enumerable:!1,configurable:!0}),e.prototype.reset=function(){this.activeProtocol="NONE",this.activeEncoding="DEFAULT",this._lastEvent=null},Object.defineProperty(e.prototype,"onProtocolChange",{get:function(){return this._onProtocolChange.event},enumerable:!1,configurable:!0}),e.prototype.triggerMouseEvent=function(e){if(e.col<0||e.col>=this._bufferService.cols||e.row<0||e.row>=this._bufferService.rows)return!1;if(4===e.button&&32===e.action)return!1;if(3===e.button&&32!==e.action)return!1;if(4!==e.button&&(2===e.action||3===e.action))return!1;if(e.col++,e.row++,32===e.action&&this._lastEvent&&this._compareEvents(this._lastEvent,e))return!1;if(!this._protocols[this._activeProtocol].restrict(e))return!1;var t=this._encodings[this._activeEncoding](e);return t&&("DEFAULT"===this._activeEncoding?this._coreService.triggerBinaryEvent(t):this._coreService.triggerDataEvent(t,!0)),this._lastEvent=e,!0},e.prototype.explainEvents=function(e){return{down:!!(1&e),up:!!(2&e),drag:!!(4&e),move:!!(8&e),wheel:!!(16&e)}},e.prototype._compareEvents=function(e,t){return e.col===t.col&&e.row===t.row&&e.button===t.button&&e.action===t.action&&e.ctrl===t.ctrl&&e.alt===t.alt&&e.shift===t.shift},i([n(0,o.IBufferService),n(1,o.ICoreService)],e)}();t.CoreMouseService=u},6975:function(e,t,r){var i,n=this&&this.__extends||(i=function(e,t){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])})(e,t)},function(e,t){function r(){this.constructor=e}i(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),o=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},s=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.CoreService=void 0;var a=r(2585),c=r(8460),l=r(1439),h=r(844),u=Object.freeze({insertMode:!1}),f=Object.freeze({applicationCursorKeys:!1,applicationKeypad:!1,bracketedPasteMode:!1,origin:!1,reverseWraparound:!1,sendFocus:!1,wraparound:!0}),_=function(e){function t(t,r,i,n){var o=e.call(this)||this;return o._bufferService=r,o._logService=i,o._optionsService=n,o.isCursorInitialized=!1,o.isCursorHidden=!1,o._onData=o.register(new c.EventEmitter),o._onUserInput=o.register(new c.EventEmitter),o._onBinary=o.register(new c.EventEmitter),o._scrollToBottom=t,o.register({dispose:function(){return o._scrollToBottom=void 0}}),o.modes=l.clone(u),o.decPrivateModes=l.clone(f),o}return n(t,e),Object.defineProperty(t.prototype,"onData",{get:function(){return this._onData.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onUserInput",{get:function(){return this._onUserInput.event},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"onBinary",{get:function(){return this._onBinary.event},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.modes=l.clone(u),this.decPrivateModes=l.clone(f)},t.prototype.triggerDataEvent=function(e,t){if(void 0===t&&(t=!1),!this._optionsService.options.disableStdin){var r=this._bufferService.buffer;r.ybase!==r.ydisp&&this._scrollToBottom(),t&&this._onUserInput.fire(),this._logService.debug('sending data "'+e+'"',(function(){return e.split("").map((function(e){return e.charCodeAt(0)}))})),this._onData.fire(e)}},t.prototype.triggerBinaryEvent=function(e){this._optionsService.options.disableStdin||(this._logService.debug('sending binary "'+e+'"',(function(){return e.split("").map((function(e){return e.charCodeAt(0)}))})),this._onBinary.fire(e))},o([s(1,a.IBufferService),s(2,a.ILogService),s(3,a.IOptionsService)],t)}(h.Disposable);t.CoreService=_},3730:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}};Object.defineProperty(t,"__esModule",{value:!0}),t.DirtyRowService=void 0;var o=r(2585),s=function(){function e(e){this._bufferService=e,this.clearRange()}return Object.defineProperty(e.prototype,"start",{get:function(){return this._start},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"end",{get:function(){return this._end},enumerable:!1,configurable:!0}),e.prototype.clearRange=function(){this._start=this._bufferService.buffer.y,this._end=this._bufferService.buffer.y},e.prototype.markDirty=function(e){e<this._start?this._start=e:e>this._end&&(this._end=e)},e.prototype.markRangeDirty=function(e,t){if(e>t){var r=e;e=t,t=r}e<this._start&&(this._start=e),t>this._end&&(this._end=t)},e.prototype.markAllDirty=function(){this.markRangeDirty(0,this._bufferService.rows-1)},i([n(0,o.IBufferService)],e)}();t.DirtyRowService=s},4348:function(e,t,r){var i=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.InstantiationService=t.ServiceCollection=void 0;var n=r(2585),o=r(8343),s=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._entries=new Map;for(var r=0,i=e;r<i.length;r++){var n=i[r],o=n[0],s=n[1];this.set(o,s)}}return e.prototype.set=function(e,t){var r=this._entries.get(e);return this._entries.set(e,t),r},e.prototype.forEach=function(e){this._entries.forEach((function(t,r){return e(r,t)}))},e.prototype.has=function(e){return this._entries.has(e)},e.prototype.get=function(e){return this._entries.get(e)},e}();t.ServiceCollection=s;var a=function(){function e(){this._services=new s,this._services.set(n.IInstantiationService,this)}return e.prototype.setService=function(e,t){this._services.set(e,t)},e.prototype.getService=function(e){return this._services.get(e)},e.prototype.createInstance=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];for(var n=o.getServiceDependencies(e).sort((function(e,t){return e.index-t.index})),s=[],a=0,c=n;a<c.length;a++){var l=c[a],h=this._services.get(l.id);if(!h)throw new Error("[createInstance] "+e.name+" depends on UNKNOWN service "+l.id+".");s.push(h)}var u=n.length>0?n[0].index:t.length;if(t.length!==u)throw new Error("[createInstance] First service dependency of "+e.name+" at position "+(u+1)+" conflicts with "+t.length+" static arguments");return new(e.bind.apply(e,i([void 0],i(t,s))))},e}();t.InstantiationService=a},7866:function(e,t,r){var i=this&&this.__decorate||function(e,t,r,i){var n,o=arguments.length,s=o<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,i);else for(var a=e.length-1;a>=0;a--)(n=e[a])&&(s=(o<3?n(s):o>3?n(t,r,s):n(t,r))||s);return o>3&&s&&Object.defineProperty(t,r,s),s},n=this&&this.__param||function(e,t){return function(r,i){t(r,i,e)}},o=this&&this.__spreadArrays||function(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var i=Array(e),n=0;for(t=0;t<r;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,n++)i[n]=o[s];return i};Object.defineProperty(t,"__esModule",{value:!0}),t.LogService=t.LogLevel=void 0;var s,a=r(2585);!function(e){e[e.DEBUG=0]="DEBUG",e[e.INFO=1]="INFO",e[e.WARN=2]="WARN",e[e.ERROR=3]="ERROR",e[e.OFF=4]="OFF"}(s=t.LogLevel||(t.LogLevel={}));var c={debug:s.DEBUG,info:s.INFO,warn:s.WARN,error:s.ERROR,off:s.OFF},l=function(){function e(e){var t=this;this._optionsService=e,this._updateLogLevel(),this._optionsService.onOptionChange((function(e){"logLevel"===e&&t._updateLogLevel()}))}return e.prototype._updateLogLevel=function(){this._logLevel=c[this._optionsService.options.logLevel]},e.prototype._evalLazyOptionalParams=function(e){for(var t=0;t<e.length;t++)"function"==typeof e[t]&&(e[t]=e[t]())},e.prototype._log=function(e,t,r){this._evalLazyOptionalParams(r),e.call.apply(e,o([console,"xterm.js: "+t],r))},e.prototype.debug=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this._logLevel<=s.DEBUG&&this._log(console.log,e,t)},e.prototype.info=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this._logLevel<=s.INFO&&this._log(console.info,e,t)},e.prototype.warn=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this._logLevel<=s.WARN&&this._log(console.warn,e,t)},e.prototype.error=function(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];this._logLevel<=s.ERROR&&this._log(console.error,e,t)},i([n(0,a.IOptionsService)],e)}();t.LogService=l},7302:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.OptionsService=t.DEFAULT_OPTIONS=t.DEFAULT_BELL_SOUND=void 0;var i=r(8460),n=r(6114),o=r(1439);t.DEFAULT_BELL_SOUND="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjMyLjEwNAAAAAAAAAAAAAAA//tQxAADB8AhSmxhIIEVCSiJrDCQBTcu3UrAIwUdkRgQbFAZC1CQEwTJ9mjRvBA4UOLD8nKVOWfh+UlK3z/177OXrfOdKl7pyn3Xf//WreyTRUoAWgBgkOAGbZHBgG1OF6zM82DWbZaUmMBptgQhGjsyYqc9ae9XFz280948NMBWInljyzsNRFLPWdnZGWrddDsjK1unuSrVN9jJsK8KuQtQCtMBjCEtImISdNKJOopIpBFpNSMbIHCSRpRR5iakjTiyzLhchUUBwCgyKiweBv/7UsQbg8isVNoMPMjAAAA0gAAABEVFGmgqK////9bP/6XCykxBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq",t.DEFAULT_OPTIONS=Object.freeze({cols:80,rows:24,cursorBlink:!1,cursorStyle:"block",cursorWidth:1,bellSound:t.DEFAULT_BELL_SOUND,bellStyle:"none",drawBoldTextInBrightColors:!0,fastScrollModifier:"alt",fastScrollSensitivity:5,fontFamily:"courier-new, courier, monospace",fontSize:15,fontWeight:"normal",fontWeightBold:"bold",lineHeight:1,linkTooltipHoverDuration:500,letterSpacing:0,logLevel:"info",scrollback:1e3,scrollSensitivity:1,screenReaderMode:!1,macOptionIsMeta:!1,macOptionClickForcesSelection:!1,minimumContrastRatio:1,disableStdin:!1,allowProposedApi:!0,allowTransparency:!1,tabStopWidth:8,theme:{},rightClickSelectsWord:n.isMac,rendererType:"canvas",windowOptions:{},windowsMode:!1,wordSeparator:" ()[]{}',\"`",altClickMovesCursor:!0,convertEol:!1,termName:"xterm",cancelEvents:!1});var s=["normal","bold","100","200","300","400","500","600","700","800","900"],a=["cols","rows"],c=function(){function e(e){this._onOptionChange=new i.EventEmitter,this.options=o.clone(t.DEFAULT_OPTIONS);for(var r=0,n=Object.keys(e);r<n.length;r++){var s=n[r];if(s in this.options)try{var a=e[s];this.options[s]=this._sanitizeAndValidateOption(s,a)}catch(e){console.error(e)}}}return Object.defineProperty(e.prototype,"onOptionChange",{get:function(){return this._onOptionChange.event},enumerable:!1,configurable:!0}),e.prototype.setOption=function(e,r){if(!(e in t.DEFAULT_OPTIONS))throw new Error('No option with key "'+e+'"');if(a.includes(e))throw new Error('Option "'+e+'" can only be set in the constructor');this.options[e]!==r&&(r=this._sanitizeAndValidateOption(e,r),this.options[e]!==r&&(this.options[e]=r,this._onOptionChange.fire(e)))},e.prototype._sanitizeAndValidateOption=function(e,r){switch(e){case"bellStyle":case"cursorStyle":case"rendererType":case"wordSeparator":r||(r=t.DEFAULT_OPTIONS[e]);break;case"fontWeight":case"fontWeightBold":if("number"==typeof r&&1<=r&&r<=1e3)break;r=s.includes(r)?r:t.DEFAULT_OPTIONS[e];break;case"cursorWidth":r=Math.floor(r);case"lineHeight":case"tabStopWidth":if(r<1)throw new Error(e+" cannot be less than 1, value: "+r);break;case"minimumContrastRatio":r=Math.max(1,Math.min(21,Math.round(10*r)/10));break;case"scrollback":if((r=Math.min(r,4294967295))<0)throw new Error(e+" cannot be less than 0, value: "+r);break;case"fastScrollSensitivity":case"scrollSensitivity":if(r<=0)throw new Error(e+" cannot be less than or equal to 0, value: "+r)}return r},e.prototype.getOption=function(e){if(!(e in t.DEFAULT_OPTIONS))throw new Error('No option with key "'+e+'"');return this.options[e]},e}();t.OptionsService=c},8343:(e,t)=>{function r(e,t,r){t.di$target===t?t.di$dependencies.push({id:e,index:r}):(t.di$dependencies=[{id:e,index:r}],t.di$target=t)}Object.defineProperty(t,"__esModule",{value:!0}),t.createDecorator=t.getServiceDependencies=t.serviceRegistry=void 0,t.serviceRegistry=new Map,t.getServiceDependencies=function(e){return e.di$dependencies||[]},t.createDecorator=function(e){if(t.serviceRegistry.has(e))return t.serviceRegistry.get(e);var i=function(e,t,n){if(3!==arguments.length)throw new Error("@IServiceName-decorator can only be used to decorate a parameter");r(i,e,n)};return i.toString=function(){return e},t.serviceRegistry.set(e,i),i}},2585:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.IUnicodeService=t.IOptionsService=t.ILogService=t.IInstantiationService=t.IDirtyRowService=t.ICharsetService=t.ICoreService=t.ICoreMouseService=t.IBufferService=void 0;var i=r(8343);t.IBufferService=i.createDecorator("BufferService"),t.ICoreMouseService=i.createDecorator("CoreMouseService"),t.ICoreService=i.createDecorator("CoreService"),t.ICharsetService=i.createDecorator("CharsetService"),t.IDirtyRowService=i.createDecorator("DirtyRowService"),t.IInstantiationService=i.createDecorator("InstantiationService"),t.ILogService=i.createDecorator("LogService"),t.IOptionsService=i.createDecorator("OptionsService"),t.IUnicodeService=i.createDecorator("UnicodeService")},1480:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UnicodeService=void 0;var i=r(8460),n=r(225),o=function(){function e(){this._providers=Object.create(null),this._active="",this._onChange=new i.EventEmitter;var e=new n.UnicodeV6;this.register(e),this._active=e.version,this._activeProvider=e}return Object.defineProperty(e.prototype,"onChange",{get:function(){return this._onChange.event},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"versions",{get:function(){return Object.keys(this._providers)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeVersion",{get:function(){return this._active},set:function(e){if(!this._providers[e])throw new Error('unknown Unicode version "'+e+'"');this._active=e,this._activeProvider=this._providers[e],this._onChange.fire(e)},enumerable:!1,configurable:!0}),e.prototype.register=function(e){this._providers[e.version]=e},e.prototype.wcwidth=function(e){return this._activeProvider.wcwidth(e)},e.prototype.getStringCellWidth=function(e){for(var t=0,r=e.length,i=0;i<r;++i){var n=e.charCodeAt(i);if(55296<=n&&n<=56319){if(++i>=r)return t+this.wcwidth(n);var o=e.charCodeAt(i);56320<=o&&o<=57343?n=1024*(n-55296)+o-56320+65536:t+=this.wcwidth(o)}t+=this.wcwidth(n)}return t},e}();t.UnicodeService=o}},t={};return function r(i){if(t[i])return t[i].exports;var n=t[i]={exports:{}};return e[i].call(n.exports,n,n.exports,r),n.exports}(4389)})()}));

},{}],"../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js":[function(require,module,exports) {
var define;
!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.FitAddon=t():e.FitAddon=t()}(self,(function(){return(()=>{"use strict";var e={775:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FitAddon=void 0;var r=function(){function e(){}return e.prototype.activate=function(e){this._terminal=e},e.prototype.dispose=function(){},e.prototype.fit=function(){var e=this.proposeDimensions();if(e&&this._terminal){var t=this._terminal._core;this._terminal.rows===e.rows&&this._terminal.cols===e.cols||(t._renderService.clear(),this._terminal.resize(e.cols,e.rows))}},e.prototype.proposeDimensions=function(){if(this._terminal&&this._terminal.element&&this._terminal.element.parentElement){var e=this._terminal._core;if(0!==e._renderService.dimensions.actualCellWidth&&0!==e._renderService.dimensions.actualCellHeight){var t=window.getComputedStyle(this._terminal.element.parentElement),r=parseInt(t.getPropertyValue("height")),i=Math.max(0,parseInt(t.getPropertyValue("width"))),n=window.getComputedStyle(this._terminal.element),o=r-(parseInt(n.getPropertyValue("padding-top"))+parseInt(n.getPropertyValue("padding-bottom"))),a=i-(parseInt(n.getPropertyValue("padding-right"))+parseInt(n.getPropertyValue("padding-left")))-e.viewport.scrollBarWidth;return{cols:Math.max(2,Math.floor(a/e._renderService.dimensions.actualCellWidth)),rows:Math.max(1,Math.floor(o/e._renderService.dimensions.actualCellHeight))}}}},e}();t.FitAddon=r}},t={};return function r(i){if(t[i])return t[i].exports;var n=t[i]={exports:{}};return e[i](n,n.exports,r),n.exports}(775)})()}));

},{}],"../../../.nvm/versions/node/v14.16.1/lib/node_modules/parcel-bundler/src/builtins/_empty.js":[function(require,module,exports) {

},{}],"../node_modules/v86/build/libv86.js":[function(require,module,exports) {
var global = arguments[3];
;(function(){'use strict';var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);
$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.makeIterator=function(a){$jscomp.initSymbolIterator();var b=a[Symbol.iterator];return b?b.call(a):$jscomp.arrayIterator(a)};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;
$jscomp.polyfill("Promise",function(a){function b(){this.batch_=null}function c(a){return a instanceof e?a:new e(function(b,c){b(a)})}if(a&&!$jscomp.FORCE_POLYFILL_PROMISE)return a;b.prototype.asyncExecute=function(a){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(a);return this};b.prototype.asyncExecuteBatch_=function(){var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var d=$jscomp.global.setTimeout;b.prototype.asyncExecuteFunction=function(a){d(a,
0)};b.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];a[b]=null;try{c()}catch(m){this.asyncThrow_(m)}}}this.batch_=null};b.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a;})};var e=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(l){b.reject(l)}};e.prototype.createResolveAndReject_=
function(){function a(a){return function(e){c||(c=!0,a.call(b,e))}}var b=this,c=!1;return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};e.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof e)this.settleSameAsPromise_(a);else{a:switch(typeof a){case "object":var b=null!=a;break a;case "function":b=!0;break a;default:b=!1}b?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};e.prototype.resolveToNonPromiseObj_=function(a){var b=
void 0;try{b=a.then}catch(l){this.reject_(l);return}"function"==typeof b?this.settleSameAsThenable_(b,a):this.fulfill_(a)};e.prototype.reject_=function(a){this.settle_(2,a)};e.prototype.fulfill_=function(a){this.settle_(1,a)};e.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b+"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};e.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=
0;a<this.onSettledCallbacks_.length;++a)f.asyncExecute(this.onSettledCallbacks_[a]);this.onSettledCallbacks_=null}};var f=new b;e.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};e.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(m){c.reject(m)}};e.prototype.then=function(a,b){function c(a,b){return"function"==typeof a?function(b){try{d(a(b))}catch(w){f(w)}}:
b}var d,f,g=new e(function(a,b){d=a;f=b});this.callWhenSettled_(c(a,d),c(b,f));return g};e.prototype.catch=function(a){return this.then(void 0,a)};e.prototype.callWhenSettled_=function(a,b){function c(){switch(e.state_){case 1:a(e.result_);break;case 2:b(e.result_);break;default:throw Error("Unexpected state: "+e.state_);}}var e=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(c)};e.resolve=c;e.reject=function(a){return new e(function(b,c){c(a)})};e.race=function(a){return new e(function(b,
e){for(var d=$jscomp.makeIterator(a),f=d.next();!f.done;f=d.next())c(f.value).callWhenSettled_(b,e)})};e.all=function(a){var b=$jscomp.makeIterator(a),d=b.next();return d.done?c([]):new e(function(a,e){function f(b){return function(c){g[b]=c;k--;0==k&&a(g)}}var g=[],k=0;do g.push(void 0),k++,c(d.value).callWhenSettled_(f(g.length-1),e),d=b.next();while(!d.done)})};return e},"es6","es3");
$jscomp.polyfill("Math.trunc",function(a){return a?a:function(a){a=Number(a);if(isNaN(a)||Infinity===a||-Infinity===a||0===a)return a;var b=Math.floor(Math.abs(a));return 0>a?-b:b}},"es6","es3");$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill("Array.prototype.entries",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a,c){return[a,c]})}},"es6","es3");$jscomp.checkEs6ConformanceViaProxy=function(){try{var a={},b=Object.create(new $jscomp.global.Proxy(a,{get:function(c,d,e){return c==a&&"q"==d&&e==b}}));return!0===b.q}catch(c){return!1}};$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS=!1;$jscomp.ES6_CONFORMANCE=$jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS&&$jscomp.checkEs6ConformanceViaProxy();
$jscomp.owns=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)};
$jscomp.polyfill("WeakMap",function(a){function b(){if(!a||!Object.seal)return!1;try{var b=Object.seal({}),c=Object.seal({}),e=new a([[b,2],[c,3]]);if(2!=e.get(b)||3!=e.get(c))return!1;e.delete(b);e.set(c,4);return!e.has(b)&&4==e.get(c)}catch(p){return!1}}function c(a){$jscomp.owns(a,e)||$jscomp.defineProperty(a,e,{value:{}})}function d(a){var b=Object[a];b&&(Object[a]=function(a){c(a);return b(a)})}if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(b())return a;
var e="$jscomp_hidden_"+Math.random();d("freeze");d("preventExtensions");d("seal");var f=0,g=function(a){this.id_=(f+=Math.random()+1).toString();if(a){$jscomp.initSymbol();$jscomp.initSymbolIterator();a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};g.prototype.set=function(a,b){c(a);if(!$jscomp.owns(a,e))throw Error("WeakMap key fail: "+a);a[e][this.id_]=b;return this};g.prototype.get=function(a){return $jscomp.owns(a,e)?a[e][this.id_]:void 0};g.prototype.has=
function(a){return $jscomp.owns(a,e)&&$jscomp.owns(a[e],this.id_)};g.prototype.delete=function(a){return $jscomp.owns(a,e)&&$jscomp.owns(a[e],this.id_)?delete a[e][this.id_]:!1};return g},"es6","es3");$jscomp.MapEntry=function(){};
$jscomp.polyfill("Map",function(a){function b(){if($jscomp.ASSUME_NO_NATIVE_MAP||!a||"function"!=typeof a||!a.prototype.entries||"function"!=typeof Object.seal)return!1;try{var b=Object.seal({x:4}),c=new a($jscomp.makeIterator([[b,"s"]]));if("s"!=c.get(b)||1!=c.size||c.get({x:4})||c.set({x:4},"t")!=c||2!=c.size)return!1;var e=c.entries(),d=e.next();if(d.done||d.value[0]!=b||"s"!=d.value[1])return!1;d=e.next();return d.done||4!=d.value[0].x||"t"!=d.value[1]||!e.next().done?!1:!0}catch(r){return!1}}
if($jscomp.USE_PROXY_FOR_ES6_CONFORMANCE_CHECKS){if(a&&$jscomp.ES6_CONFORMANCE)return a}else if(b())return a;$jscomp.initSymbol();$jscomp.initSymbolIterator();var c=new WeakMap,d=function(a){this.data_={};this.head_=g();this.size=0;if(a){a=$jscomp.makeIterator(a);for(var b;!(b=a.next()).done;)b=b.value,this.set(b[0],b[1])}};d.prototype.set=function(a,b){var c=e(this,a);c.list||(c.list=this.data_[c.id]=[]);c.entry?c.entry.value=b:(c.entry={next:this.head_,previous:this.head_.previous,head:this.head_,
key:a,value:b},c.list.push(c.entry),this.head_.previous.next=c.entry,this.head_.previous=c.entry,this.size++);return this};d.prototype.delete=function(a){a=e(this,a);return a.entry&&a.list?(a.list.splice(a.index,1),a.list.length||delete this.data_[a.id],a.entry.previous.next=a.entry.next,a.entry.next.previous=a.entry.previous,a.entry.head=null,this.size--,!0):!1};d.prototype.clear=function(){this.data_={};this.head_=this.head_.previous=g();this.size=0};d.prototype.has=function(a){return!!e(this,a).entry};
d.prototype.get=function(a){return(a=e(this,a).entry)&&a.value};d.prototype.entries=function(){return f(this,function(a){return[a.key,a.value]})};d.prototype.keys=function(){return f(this,function(a){return a.key})};d.prototype.values=function(){return f(this,function(a){return a.value})};d.prototype.forEach=function(a,b){for(var c=this.entries(),e;!(e=c.next()).done;)e=e.value,a.call(b,e[1],e[0],this)};d.prototype[Symbol.iterator]=d.prototype.entries;var e=function(a,b){var e=b&&typeof b;"object"==
e||"function"==e?c.has(b)?e=c.get(b):(e=""+ ++k,c.set(b,e)):e="p_"+b;var d=a.data_[e];if(d&&$jscomp.owns(a.data_,e))for(a=0;a<d.length;a++){var f=d[a];if(b!==b&&f.key!==f.key||b===f.key)return{id:e,list:d,index:a,entry:f}}return{id:e,list:d,index:-1,entry:void 0}},f=function(a,b){var c=a.head_;return $jscomp.iteratorPrototype(function(){if(c){for(;c.head!=a.head_;)c=c.previous;for(;c.next!=c.head;)return c=c.next,{done:!1,value:b(c)};c=null}return{done:!0,value:void 0}})},g=function(){var a={};return a.previous=
a.next=a.head=a},k=0;return d},"es6","es3");$jscomp.objectCreate=$jscomp.ASSUME_ES5||"function"==typeof Object.create?Object.create:function(a){var b=function(){};b.prototype=a;return new b};
$jscomp.construct=function(){function a(){function a(){}new a;Reflect.construct(a,[],function(){});return new a instanceof a}if("undefined"!=typeof Reflect&&Reflect.construct){if(a())return Reflect.construct;var b=Reflect.construct;return function(a,d,e){a=b(a,d);e&&Reflect.setPrototypeOf(a,e.prototype);return a}}return function(a,b,e){void 0===e&&(e=a);e=$jscomp.objectCreate(e.prototype||Object.prototype);return Function.prototype.apply.call(a,e,b)||e}}();
$jscomp.polyfill("Reflect.construct",function(a){return $jscomp.construct},"es6","es3");$jscomp.underscoreProtoCanBeSet=function(){var a={a:!0},b={};try{return b.__proto__=a,b.a}catch(c){}return!1};$jscomp.setPrototypeOf="function"==typeof Object.setPrototypeOf?Object.setPrototypeOf:$jscomp.underscoreProtoCanBeSet()?function(a,b){a.__proto__=b;if(a.__proto__!==b)throw new TypeError(a+" is not extensible");return a}:null;
$jscomp.polyfill("Reflect.setPrototypeOf",function(a){if(a)return a;if($jscomp.setPrototypeOf){var b=$jscomp.setPrototypeOf;return function(a,d){try{return b(a,d),!0}catch(e){return!1}}}return null},"es6","es5");var COMPILED=!0,goog=goog||{};goog.global=this;goog.isDef=function(a){return void 0!==a};
goog.exportPath_=function(a,b,c){a=a.split(".");c=c||goog.global;a[0]in c||!c.execScript||c.execScript("var "+a[0]);for(var d;a.length&&(d=a.shift());)!a.length&&goog.isDef(b)?c[d]=b:c=c[d]?c[d]:c[d]={}};
goog.define=function(a,b){COMPILED||(goog.global.CLOSURE_UNCOMPILED_DEFINES&&Object.prototype.hasOwnProperty.call(goog.global.CLOSURE_UNCOMPILED_DEFINES,a)?b=goog.global.CLOSURE_UNCOMPILED_DEFINES[a]:goog.global.CLOSURE_DEFINES&&Object.prototype.hasOwnProperty.call(goog.global.CLOSURE_DEFINES,a)&&(b=goog.global.CLOSURE_DEFINES[a]));goog.exportPath_(a,b)};goog.DEBUG=!0;goog.LOCALE="en";goog.TRUSTED_SITE=!0;goog.STRICT_MODE_COMPATIBLE=!1;goog.DISALLOW_TEST_ONLY_CODE=COMPILED&&!goog.DEBUG;
goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING=!1;goog.provide=function(a){if(!COMPILED&&goog.isProvided_(a))throw Error('Namespace "'+a+'" already declared.');goog.constructNamespace_(a)};goog.constructNamespace_=function(a,b){if(!COMPILED){delete goog.implicitNamespaces_[a];for(var c=a;(c=c.substring(0,c.lastIndexOf(".")))&&!goog.getObjectByName(c);)goog.implicitNamespaces_[c]=!0}goog.exportPath_(a,b)};goog.VALID_MODULE_RE_=/^[a-zA-Z_$][a-zA-Z0-9._$]*$/;
goog.module=function(a){if(!goog.isString(a)||!a||-1==a.search(goog.VALID_MODULE_RE_))throw Error("Invalid module identifier");if(!goog.isInModuleLoader_())throw Error("Module "+a+" has been loaded incorrectly.");if(goog.moduleLoaderState_.moduleName)throw Error("goog.module may only be called once per module.");goog.moduleLoaderState_.moduleName=a;if(!COMPILED){if(goog.isProvided_(a))throw Error('Namespace "'+a+'" already declared.');delete goog.implicitNamespaces_[a]}};goog.module.get=function(a){return goog.module.getInternal_(a)};
goog.module.getInternal_=function(a){if(!COMPILED)return goog.isProvided_(a)?a in goog.loadedModules_?goog.loadedModules_[a]:goog.getObjectByName(a):null};goog.moduleLoaderState_=null;goog.isInModuleLoader_=function(){return null!=goog.moduleLoaderState_};goog.module.declareTestMethods=function(){if(!goog.isInModuleLoader_())throw Error("goog.module.declareTestMethods must be called from within a goog.module");goog.moduleLoaderState_.declareTestMethods=!0};
goog.module.declareLegacyNamespace=function(){if(!COMPILED&&!goog.isInModuleLoader_())throw Error("goog.module.declareLegacyNamespace must be called from within a goog.module");if(!COMPILED&&!goog.moduleLoaderState_.moduleName)throw Error("goog.module must be called prior to goog.module.declareLegacyNamespace.");goog.moduleLoaderState_.declareLegacyNamespace=!0};
goog.setTestOnly=function(a){if(goog.DISALLOW_TEST_ONLY_CODE)throw a=a||"",Error("Importing test-only code into non-debug environment"+(a?": "+a:"."));};goog.forwardDeclare=function(a){};COMPILED||(goog.isProvided_=function(a){return a in goog.loadedModules_||!goog.implicitNamespaces_[a]&&goog.isDefAndNotNull(goog.getObjectByName(a))},goog.implicitNamespaces_={"goog.module":!0});
goog.getObjectByName=function(a,b){a=a.split(".");b=b||goog.global;for(var c;c=a.shift();)if(goog.isDefAndNotNull(b[c]))b=b[c];else return null;return b};goog.globalize=function(a,b){b=b||goog.global;for(var c in a)b[c]=a[c]};goog.addDependency=function(a,b,c,d){if(goog.DEPENDENCIES_ENABLED){var e;a=a.replace(/\\/g,"/");for(var f=goog.dependencies_,g=0;e=b[g];g++)f.nameToPath[e]=a,f.pathIsModule[a]=!!d;for(d=0;b=c[d];d++)a in f.requires||(f.requires[a]={}),f.requires[a][b]=!0}};
goog.ENABLE_DEBUG_LOADER=!0;goog.logToConsole_=function(a){goog.global.console&&goog.global.console.error(a)};
goog.require=function(a){if(!COMPILED){goog.ENABLE_DEBUG_LOADER&&goog.IS_OLD_IE_&&goog.maybeProcessDeferredDep_(a);if(goog.isProvided_(a))return goog.isInModuleLoader_()?goog.module.getInternal_(a):null;if(goog.ENABLE_DEBUG_LOADER){var b=goog.getPathFromDeps_(a);if(b)return goog.included_[b]=!0,goog.writeScripts_(),null}a="goog.require could not find: "+a;goog.logToConsole_(a);throw Error(a);}};goog.basePath="";goog.nullFunction=function(){};
goog.abstractMethod=function(){throw Error("unimplemented abstract method");};goog.addSingletonGetter=function(a){a.getInstance=function(){if(a.instance_)return a.instance_;goog.DEBUG&&(goog.instantiatedSingletons_[goog.instantiatedSingletons_.length]=a);return a.instance_=new a}};goog.instantiatedSingletons_=[];goog.LOAD_MODULE_USING_EVAL=!0;goog.SEAL_MODULE_EXPORTS=goog.DEBUG;goog.loadedModules_={};goog.DEPENDENCIES_ENABLED=!COMPILED&&goog.ENABLE_DEBUG_LOADER;
goog.DEPENDENCIES_ENABLED&&(goog.included_={},goog.dependencies_={pathIsModule:{},nameToPath:{},requires:{},visited:{},written:{},deferred:{}},goog.inHtmlDocument_=function(){var a=goog.global.document;return"undefined"!=typeof a&&"write"in a},goog.findBasePath_=function(){if(goog.global.CLOSURE_BASE_PATH)goog.basePath=goog.global.CLOSURE_BASE_PATH;else if(goog.inHtmlDocument_())for(var a=goog.global.document.getElementsByTagName("SCRIPT"),b=a.length-1;0<=b;--b){var c=a[b].src,d=c.lastIndexOf("?");
d=-1==d?c.length:d;if("base.js"==c.substr(d-7,7)){goog.basePath=c.substr(0,d-7);break}}},goog.importScript_=function(a,b){(goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_)(a,b)&&(goog.dependencies_.written[a]=!0)},goog.IS_OLD_IE_=!goog.global.atob&&goog.global.document&&goog.global.document.all,goog.importModule_=function(a){goog.importScript_("",'goog.retrieveAndExecModule_("'+a+'");')&&(goog.dependencies_.written[a]=!0)},goog.queuedModules_=[],goog.wrapModule_=function(a,b){return goog.LOAD_MODULE_USING_EVAL&&
goog.isDef(goog.global.JSON)?"goog.loadModule("+goog.global.JSON.stringify(b+"\n//# sourceURL="+a+"\n")+");":'goog.loadModule(function(exports) {"use strict";'+b+"\n;return exports});\n//# sourceURL="+a+"\n"},goog.loadQueuedModules_=function(){var a=goog.queuedModules_.length;if(0<a){var b=goog.queuedModules_;goog.queuedModules_=[];for(var c=0;c<a;c++)goog.maybeProcessDeferredPath_(b[c])}},goog.maybeProcessDeferredDep_=function(a){goog.isDeferredModule_(a)&&goog.allDepsAreAvailable_(a)&&(a=goog.getPathFromDeps_(a),
goog.maybeProcessDeferredPath_(goog.basePath+a))},goog.isDeferredModule_=function(a){return(a=goog.getPathFromDeps_(a))&&goog.dependencies_.pathIsModule[a]?goog.basePath+a in goog.dependencies_.deferred:!1},goog.allDepsAreAvailable_=function(a){if((a=goog.getPathFromDeps_(a))&&a in goog.dependencies_.requires)for(var b in goog.dependencies_.requires[a])if(!goog.isProvided_(b)&&!goog.isDeferredModule_(b))return!1;return!0},goog.maybeProcessDeferredPath_=function(a){if(a in goog.dependencies_.deferred){var b=
goog.dependencies_.deferred[a];delete goog.dependencies_.deferred[a];goog.globalEval(b)}},goog.loadModule=function(a){var b=goog.moduleLoaderState_;try{goog.moduleLoaderState_={moduleName:void 0,declareTestMethods:!1};if(goog.isFunction(a))var c=a.call(goog.global,{});else if(goog.isString(a))c=goog.loadModuleFromSource_.call(goog.global,a);else throw Error("Invalid module definition");var d=goog.moduleLoaderState_.moduleName;if(!goog.isString(d)||!d)throw Error('Invalid module name "'+d+'"');goog.moduleLoaderState_.declareLegacyNamespace?
goog.constructNamespace_(d,c):goog.SEAL_MODULE_EXPORTS&&Object.seal&&Object.seal(c);goog.loadedModules_[d]=c;if(goog.moduleLoaderState_.declareTestMethods)for(var e in c)if(0===e.indexOf("test",0)||"tearDown"==e||"setUp"==e||"setUpPage"==e||"tearDownPage"==e)goog.global[e]=c[e]}finally{goog.moduleLoaderState_=b}},goog.loadModuleFromSource_=function(a){eval(a);return{}},goog.writeScriptSrcNode_=function(a){goog.global.document.write('<script type="text/javascript" src="'+a+'">\x3c/script>')},goog.appendScriptSrcNode_=
function(a){var b=goog.global.document,c=b.createElement("script");c.type="text/javascript";c.src=a;c.defer=!1;c.async=!1;b.head.appendChild(c)},goog.writeScriptTag_=function(a,b){if(goog.inHtmlDocument_()){var c=goog.global.document;if(!goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING&&"complete"==c.readyState){if(/\bdeps.js$/.test(a))return!1;throw Error('Cannot write "'+a+'" after document load');}var d=goog.IS_OLD_IE_;void 0===b?d?(b=" onreadystatechange='goog.onScriptLoad_(this, "+ ++goog.lastNonModuleScriptIndex_+
")' ",c.write('<script type="text/javascript" src="'+a+'"'+b+">\x3c/script>")):goog.ENABLE_CHROME_APP_SAFE_SCRIPT_LOADING?goog.appendScriptSrcNode_(a):goog.writeScriptSrcNode_(a):c.write('<script type="text/javascript">'+b+"\x3c/script>");return!0}return!1},goog.lastNonModuleScriptIndex_=0,goog.onScriptLoad_=function(a,b){"complete"==a.readyState&&goog.lastNonModuleScriptIndex_==b&&goog.loadQueuedModules_();return!0},goog.writeScripts_=function(){function a(e){if(!(e in d.written)){if(!(e in d.visited)&&
(d.visited[e]=!0,e in d.requires))for(var f in d.requires[e])if(!goog.isProvided_(f))if(f in d.nameToPath)a(d.nameToPath[f]);else throw Error("Undefined nameToPath for "+f);e in c||(c[e]=!0,b.push(e))}}var b=[],c={},d=goog.dependencies_;for(f in goog.included_)d.written[f]||a(f);for(var e=0;e<b.length;e++){var f=b[e];goog.dependencies_.written[f]=!0}var g=goog.moduleLoaderState_;goog.moduleLoaderState_=null;for(e=0;e<b.length;e++)if(f=b[e])d.pathIsModule[f]?goog.importModule_(goog.basePath+f):goog.importScript_(goog.basePath+
f);else throw goog.moduleLoaderState_=g,Error("Undefined script input");goog.moduleLoaderState_=g},goog.getPathFromDeps_=function(a){return a in goog.dependencies_.nameToPath?goog.dependencies_.nameToPath[a]:null},goog.findBasePath_(),goog.global.CLOSURE_NO_DEPS||goog.importScript_(goog.basePath+"deps.js"));goog.normalizePath_=function(a){a=a.split("/");for(var b=0;b<a.length;)"."==a[b]?a.splice(b,1):b&&".."==a[b]&&a[b-1]&&".."!=a[b-1]?a.splice(--b,2):b++;return a.join("/")};
goog.loadFileSync_=function(a){if(goog.global.CLOSURE_LOAD_FILE_SYNC)return goog.global.CLOSURE_LOAD_FILE_SYNC(a);var b=new goog.global.XMLHttpRequest;b.open("get",a,!1);b.send();return b.responseText};
goog.retrieveAndExecModule_=function(a){if(!COMPILED){var b=a;a=goog.normalizePath_(a);var c=goog.global.CLOSURE_IMPORT_SCRIPT||goog.writeScriptTag_,d=goog.loadFileSync_(a);if(null!=d)d=goog.wrapModule_(a,d),goog.IS_OLD_IE_?(goog.dependencies_.deferred[b]=d,goog.queuedModules_.push(b)):c(a,d);else throw Error("load of "+a+"failed");}};
goog.typeOf=function(a){var b=typeof a;if("object"==b)if(a){if(a instanceof Array)return"array";if(a instanceof Object)return b;var c=Object.prototype.toString.call(a);if("[object Window]"==c)return"object";if("[object Array]"==c||"number"==typeof a.length&&"undefined"!=typeof a.splice&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("splice"))return"array";if("[object Function]"==c||"undefined"!=typeof a.call&&"undefined"!=typeof a.propertyIsEnumerable&&!a.propertyIsEnumerable("call"))return"function"}else return"null";
else if("function"==b&&"undefined"==typeof a.call)return"object";return b};goog.isNull=function(a){return null===a};goog.isDefAndNotNull=function(a){return null!=a};goog.isArray=function(a){return"array"==goog.typeOf(a)};goog.isArrayLike=function(a){var b=goog.typeOf(a);return"array"==b||"object"==b&&"number"==typeof a.length};goog.isDateLike=function(a){return goog.isObject(a)&&"function"==typeof a.getFullYear};goog.isString=function(a){return"string"==typeof a};
goog.isBoolean=function(a){return"boolean"==typeof a};goog.isNumber=function(a){return"number"==typeof a};goog.isFunction=function(a){return"function"==goog.typeOf(a)};goog.isObject=function(a){var b=typeof a;return"object"==b&&null!=a||"function"==b};goog.getUid=function(a){return a[goog.UID_PROPERTY_]||(a[goog.UID_PROPERTY_]=++goog.uidCounter_)};goog.hasUid=function(a){return!!a[goog.UID_PROPERTY_]};goog.removeUid=function(a){"removeAttribute"in a&&a.removeAttribute(goog.UID_PROPERTY_);try{delete a[goog.UID_PROPERTY_]}catch(b){}};
goog.UID_PROPERTY_="closure_uid_"+(1E9*Math.random()>>>0);goog.uidCounter_=0;goog.getHashCode=goog.getUid;goog.removeHashCode=goog.removeUid;goog.cloneObject=function(a){var b=goog.typeOf(a);if("object"==b||"array"==b){if(a.clone)return a.clone();b="array"==b?[]:{};for(var c in a)b[c]=goog.cloneObject(a[c]);return b}return a};goog.bindNative_=function(a,b,c){return a.call.apply(a.bind,arguments)};
goog.bindJs_=function(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c)}}return function(){return a.apply(b,arguments)}};goog.bind=function(a,b,c){Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?goog.bind=goog.bindNative_:goog.bind=goog.bindJs_;return goog.bind.apply(null,arguments)};
goog.partial=function(a,b){var c=Array.prototype.slice.call(arguments,1);return function(){var b=c.slice();b.push.apply(b,arguments);return a.apply(this,b)}};goog.mixin=function(a,b){for(var c in b)a[c]=b[c]};goog.now=goog.TRUSTED_SITE&&Date.now||function(){return+new Date};
goog.globalEval=function(a){if(goog.global.execScript)goog.global.execScript(a,"JavaScript");else if(goog.global.eval)if(null==goog.evalWorksForGlobals_&&(goog.global.eval("var _et_ = 1;"),"undefined"!=typeof goog.global._et_?(delete goog.global._et_,goog.evalWorksForGlobals_=!0):goog.evalWorksForGlobals_=!1),goog.evalWorksForGlobals_)goog.global.eval(a);else{var b=goog.global.document,c=b.createElement("SCRIPT");c.type="text/javascript";c.defer=!1;c.appendChild(b.createTextNode(a));b.body.appendChild(c);
b.body.removeChild(c)}else throw Error("goog.globalEval not available");};goog.evalWorksForGlobals_=null;goog.getCssName=function(a,b){var c=function(a){return goog.cssNameMapping_[a]||a},d=function(a){a=a.split("-");for(var b=[],e=0;e<a.length;e++)b.push(c(a[e]));return b.join("-")};d=goog.cssNameMapping_?"BY_WHOLE"==goog.cssNameMappingStyle_?c:d:function(a){return a};return b?a+"-"+d(b):d(a)};goog.setCssNameMapping=function(a,b){goog.cssNameMapping_=a;goog.cssNameMappingStyle_=b};
!COMPILED&&goog.global.CLOSURE_CSS_NAME_MAPPING&&(goog.cssNameMapping_=goog.global.CLOSURE_CSS_NAME_MAPPING);goog.getMsg=function(a,b){b&&(a=a.replace(/\{\$([^}]+)}/g,function(a,d){return d in b?b[d]:a}));return a};goog.getMsgWithFallback=function(a,b){return a};goog.exportSymbol=function(a,b,c){goog.exportPath_(a,b,c)};goog.exportProperty=function(a,b,c){a[b]=c};
goog.inherits=function(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a;a.base=function(a,c,f){for(var e=Array(arguments.length-2),d=2;d<arguments.length;d++)e[d-2]=arguments[d];return b.prototype[c].apply(a,e)}};
goog.base=function(a,b,c){var d=arguments.callee.caller;if(goog.STRICT_MODE_COMPATIBLE||goog.DEBUG&&!d)throw Error("arguments.caller not defined.  goog.base() cannot be used with strict mode code. See http://www.ecma-international.org/ecma-262/5.1/#sec-C");if(d.superClass_){for(var e=Array(arguments.length-1),f=1;f<arguments.length;f++)e[f-1]=arguments[f];return d.superClass_.constructor.apply(a,e)}e=Array(arguments.length-2);for(f=2;f<arguments.length;f++)e[f-2]=arguments[f];f=!1;for(var g=a.constructor;g;g=
g.superClass_&&g.superClass_.constructor)if(g.prototype[b]===d)f=!0;else if(f)return g.prototype[b].apply(a,e);if(a[b]===d)return a.constructor.prototype[b].apply(a,e);throw Error("goog.base called from a method of one name to a method of a different name");};goog.scope=function(a){a.call(goog.global)};COMPILED||(goog.global.COMPILED=COMPILED);
goog.defineClass=function(a,b){var c=b.constructor,d=b.statics;c&&c!=Object.prototype.constructor||(c=function(){throw Error("cannot instantiate an interface (no constructor defined).");});c=goog.defineClass.createSealingConstructor_(c,a);a&&goog.inherits(c,a);delete b.constructor;delete b.statics;goog.defineClass.applyProperties_(c.prototype,b);null!=d&&(d instanceof Function?d(c):goog.defineClass.applyProperties_(c,d));return c};goog.defineClass.SEAL_CLASS_INSTANCES=goog.DEBUG;
goog.defineClass.createSealingConstructor_=function(a,b){if(goog.defineClass.SEAL_CLASS_INSTANCES&&Object.seal instanceof Function){if(b&&b.prototype&&b.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_])return a;var c=function(){var b=a.apply(this,arguments)||this;b[goog.UID_PROPERTY_]=b[goog.UID_PROPERTY_];this.constructor===c&&Object.seal(b);return b};return c}return a};goog.defineClass.OBJECT_PROTOTYPE_FIELDS_="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");
goog.defineClass.applyProperties_=function(a,b){for(var c in b)Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c]);for(var d=0;d<goog.defineClass.OBJECT_PROTOTYPE_FIELDS_.length;d++)c=goog.defineClass.OBJECT_PROTOTYPE_FIELDS_[d],Object.prototype.hasOwnProperty.call(b,c)&&(a[c]=b[c])};goog.tagUnsealableClass=function(a){!COMPILED&&goog.defineClass.SEAL_CLASS_INSTANCES&&(a.prototype[goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_]=!0)};goog.UNSEALABLE_CONSTRUCTOR_PROPERTY_="goog_defineClass_legacy_unsealable";var LOG_ALL=-1,LOG_NONE=0,LOG_OTHER=1,LOG_CPU=2,LOG_FPU=4,LOG_MEM=8,LOG_DMA=16,LOG_IO=32,LOG_PS2=64,LOG_PIC=128,LOG_VGA=256,LOG_PIT=512,LOG_MOUSE=1024,LOG_PCI=2048,LOG_BIOS=4096,LOG_FLOPPY=8192,LOG_SERIAL=16384,LOG_DISK=32768,LOG_RTC=65536,LOG_HPET=131072,LOG_ACPI=262144,LOG_APIC=524288,LOG_NET=1048576,LOG_VIRTIO=2097152,LOG_9P=4194304,LOG_SB16=8388608,LOG_NAMES=[[1,""],[LOG_CPU,"CPU"],[LOG_DISK,"DISK"],[LOG_FPU,"FPU"],[LOG_MEM,"MEM"],[LOG_DMA,"DMA"],[LOG_IO,"IO"],[LOG_PS2,"PS2"],[LOG_PIC,"PIC"],
[LOG_VGA,"VGA"],[LOG_PIT,"PIT"],[LOG_MOUSE,"MOUS"],[LOG_PCI,"PCI"],[LOG_BIOS,"BIOS"],[LOG_FLOPPY,"FLOP"],[LOG_SERIAL,"SERI"],[LOG_RTC,"RTC"],[LOG_HPET,"HPET"],[LOG_ACPI,"ACPI"],[LOG_APIC,"APIC"],[LOG_NET,"NET"],[LOG_VIRTIO,"VIO"],[LOG_9P,"9P"],[LOG_SB16,"SB16"]],TLB_SYSTEM_READ=1,TLB_SYSTEM_WRITE=2,TLB_USER_READ=4,TLB_USER_WRITE=8,flag_carry=1,flag_parity=4,flag_adjust=16,flag_zero=64,flag_sign=128,flag_trap=256,flag_interrupt=512,flag_direction=1024,flag_overflow=2048,flag_iopl=12288,flag_nt=16384,
flag_rf=65536,flag_vm=131072,flag_ac=262144,flag_vif=524288,flag_vip=1048576,flag_id=2097152,flags_default=2,flags_mask=flag_carry|flag_parity|flag_adjust|flag_zero|flag_sign|flag_trap|flag_interrupt|flag_direction|flag_overflow|flag_iopl|flag_nt|flag_rf|flag_vm|flag_ac|flag_vif|flag_vip|flag_id,flags_all=flag_carry|flag_parity|flag_adjust|flag_zero|flag_sign|flag_overflow,OPSIZE_8=7,OPSIZE_16=15,OPSIZE_32=31,PSE_ENABLED=128,reg_eax=0,reg_ecx=1,reg_edx=2,reg_ebx=3,reg_esp=4,reg_ebp=5,reg_esi=6,reg_edi=
7,reg_ax=0,reg_cx=2,reg_dx=4,reg_bx=6,reg_sp=8,reg_bp=10,reg_si=12,reg_di=14,reg_al=0,reg_cl=4,reg_dl=8,reg_bl=12,reg_ah=1,reg_ch=5,reg_dh=9,reg_bh=13,reg_es=0,reg_cs=1,reg_ss=2,reg_ds=3,reg_fs=4,reg_gs=5,reg_tr=6,reg_ldtr=7,MMAP_BLOCK_BITS=17,MMAP_BLOCK_SIZE=1<<MMAP_BLOCK_BITS,MEM_PAGE_WRITTEN=1,MAGIC_CPU_EXCEPTION=233495534,REPEAT_STRING_PREFIX_NONE=0,REPEAT_STRING_PREFIX_NZ=1,REPEAT_STRING_PREFIX_Z=2,CR0_PE=1,CR0_MP=2,CR0_EM=4,CR0_TS=8,CR0_ET=16,CR0_WP=65536,CR0_NW=536870912,CR0_CD=1073741824,
CR0_PG=-2147483648,CR4_VME=1,CR4_PVI=2,CR4_TSD=4,CR4_PSE=16,CR4_DE=8,CR4_PAE=32,CR4_PGE=128,CR4_OSFXSR=512,CR4_OSXMMEXCPT=1024,SEG_PREFIX_NONE=-1,SEG_PREFIX_ZERO=7,IA32_SYSENTER_CS=372,IA32_SYSENTER_ESP=373,IA32_SYSENTER_EIP=374,IA32_TIME_STAMP_COUNTER=16,IA32_PLATFORM_ID=23,MSR_EBC_FREQUENCY_ID=44,IA32_APIC_BASE_MSR=27,IA32_BIOS_SIGN_ID=139,IA32_MISC_ENABLE=416,IA32_RTIT_CTL=1392,MSR_SMI_COUNT=52,IA32_MCG_CAP=377,IA32_KERNEL_GS_BASE=-1073741567,MSR_PKG_C2_RESIDENCY=1549,IA32_APIC_BASE_BSP=256,IA32_APIC_BASE_EXTD=
1024,IA32_APIC_BASE_EN=2048,TSR_BACKLINK=0,TSR_CR3=28,TSR_EIP=32,TSR_EFLAGS=36,TSR_EAX=40,TSR_ECX=44,TSR_EDX=48,TSR_EBX=52,TSR_ESP=56,TSR_EBP=60,TSR_ESI=64,TSR_EDI=68,TSR_ES=72,TSR_CS=76,TSR_SS=80,TSR_DS=84,TSR_FS=88,TSR_GS=92,TSR_LDT=96,FW_CFG_SIGNATURE=0,FW_CFG_RAM_SIZE=3,FW_CFG_NB_CPUS=5,PREFIX_MASK_REP=24,PREFIX_REPZ=8,PREFIX_REPNZ=16,PREFIX_MASK_SEGMENT=7,PREFIX_MASK_OPSIZE=32,PREFIX_MASK_ADDRSIZE=64,PREFIX_F2=PREFIX_REPNZ,PREFIX_F3=PREFIX_REPZ,PREFIX_66=PREFIX_MASK_OPSIZE,MXCSR_MASK=65471,MIXER_CHANNEL_LEFT=
0,MIXER_CHANNEL_RIGHT=1,MIXER_CHANNEL_BOTH=2,MIXER_SRC_MASTER=0,MIXER_SRC_PCSPEAKER=1,MIXER_SRC_DAC=2;"undefined"===typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame);
function ScreenAdapter(a,b){function c(a){a=a.toString(16);return"#"+Array(7-a.length).join("0")+a}function d(a,b,c,d){a.style.width="";a.style.height="";d&&(a.style.transform=a.style.webkitTransform=a.style.MozTransform="");var f=a.getBoundingClientRect();d?a.style.transform=a.style.webkitTransform=a.style.MozTransform=(1===b?"":" scaleX("+b+")")+(1===c?"":" scaleY("+c+")"):(0===b%1&&0===c%1?(e.style.imageRendering="pixelated",e.style["-ms-interpolation-mode"]="nearest-neighbor"):(e.style.imageRendering=
"",e.style["-ms-interpolation-mode"]=""),d=window.devicePixelRatio||1,0!==d%1&&(b/=d,c/=d));1!==b&&(a.style.width=f.width*b+"px");1!==c&&(a.style.height=f.height*c+"px")}console.assert(a,"1st argument must be a DOM container");var e=a.getElementsByTagName("canvas")[0],f=e.getContext("2d"),g=a.getElementsByTagName("div")[0],k=document.createElement("div"),l,m,p,n,r=1,q=1,u,w=!1,x,A,C,D=this;a=new Uint16Array([199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,
249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160]);for(var B=new Uint16Array([32,
9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660]),z=[],y,v=0;256>v;v++)y=127<v?a[v-128]:32>v?B[v]:v,z[v]=String.fromCharCode(y);f.imageSmoothingEnabled=!1;k.style.position="absolute";k.style.backgroundColor="#ccc";k.style.width="7px";k.style.display="inline-block";g.style.display="block";e.style.display="none";this.bus=b;b.register("screen-set-mode",function(a){this.set_mode(a)},this);b.register("screen-fill-buffer-end",
function(a){this.update_buffer(a)},this);b.register("screen-put-char",function(a){this.put_char(a[0],a[1],a[2],a[3],a[4])},this);b.register("screen-update-cursor",function(a){this.update_cursor(a[0],a[1])},this);b.register("screen-update-cursor-scanline",function(a){this.update_cursor_scanline(a[0],a[1])},this);b.register("screen-clear",function(){this.clear_screen()},this);b.register("screen-set-size-text",function(a){this.set_size_text(a[0],a[1])},this);b.register("screen-set-size-graphical",function(a){this.set_size_graphical(a[0],
a[1],a[2],a[3])},this);this.init=function(){this.set_size_text(80,25);this.timer()};this.make_screenshot=function(){try{window.open(e.toDataURL())}catch(G){}};this.put_char=function(a,b,c,e,d){a<C&&b<A&&(b=3*(a*A+b),x[b]=c,x[b+1]=e,x[b+2]=d,u[a]=1)};this.timer=function(){requestAnimationFrame(w?E:F)};var F=function(){for(var a=0;a<C;a++)u[a]&&(D.text_update_row(a),u[a]=0);this.timer()}.bind(this),E=function(){this.bus.send("screen-fill-buffer");this.timer()}.bind(this);this.destroy=function(){};this.set_mode=
function(a){(w=a)?(g.style.display="none",e.style.display="block"):(g.style.display="block",e.style.display="none")};this.clear_screen=function(){f.fillStyle="#000";f.fillRect(0,0,e.width,e.height)};this.set_size_text=function(a,b){if(a!==A||b!==C){u=new Int8Array(b);x=new Int32Array(a*b*3);A=a;for(C=b;g.childNodes.length>b;)g.removeChild(g.firstChild);for(;g.childNodes.length<b;)g.appendChild(document.createElement("div"));for(a=0;a<b;a++)this.text_update_row(a);d(g,r,q,!0)}};this.set_size_graphical=
function(a,b,c,g){DEBUG_SCREEN_LAYERS&&(a=c,b=g);e.style.display="block";e.width=a;e.height=b;l=f.createImageData(c,g);new Uint8Array(l.data.buffer);m=new Int32Array(l.data.buffer);this.bus.send("screen-tell-buffer",[m],[m.buffer]);d(e,r,q,!1)};this.set_scale=function(a,b){r=a;q=b;d(g,r,q,!0);d(e,r,q,!1)};this.set_scale(r,q);this.update_cursor_scanline=function(a,b){a&32?k.style.display="none":(k.style.display="inline",k.style.height=Math.min(15,b-a)+"px",k.style.marginTop=Math.min(15,a)+"px")};this.update_cursor=
function(a,b){if(a!==p||b!==n)u[a]=1,u[p]=1,p=a,n=b};this.text_update_row=function(a){var b=3*a*A,e;var d=g.childNodes[a];var f=document.createElement("div");for(var l=0;l<A;){var m=document.createElement("span");var q=x[b+1];var r=x[b+2];m.style.backgroundColor=c(q);m.style.color=c(r);for(e="";l<A&&x[b+1]===q&&x[b+2]===r;)if(e+=z[x[b]],l++,b+=3,a===p)if(l===n)break;else if(l===n+1){f.appendChild(k);break}m.textContent=e;f.appendChild(m)}d.parentNode.replaceChild(f,d)};this.update_buffer=function(a){DEBUG_SCREEN_LAYERS?
(f.putImageData(l,0,0),f.strokeStyle="#0F0",f.lineWidth=4,a.forEach(function(a){f.strokeRect(a.buffer_x,a.buffer_y,a.buffer_width,a.buffer_height)}),f.lineWidth=1):a.forEach(function(a){f.putImageData(l,a.screen_x-a.buffer_x,a.screen_y-a.buffer_y,a.buffer_x,a.buffer_y,a.buffer_width,a.buffer_height)})};this.init()};var DEBUG_CONSOLE=null!==(new URL(window.document.location.href)).searchParams.get("debug");function debug(a){for(var b=[],c=0;c<arguments.length;++c)b[c-0]=arguments[c];DEBUG_CONSOLE&&console.log.apply(console,b)}
var V9FS_MAGIC=16914839,P9_TSTATFS=8,P9_TLOPEN=12,P9_TLCREATE=14,P9_TSYMLINK=16,P9_TMKNOD=18,P9_TREADLINK=22,P9_TGETATTR=24,P9_TSETATTR=26,P9_TXATTRWALK=30,P9_TXATTRCREATE=32,P9_TREADDIR=40,P9_TFSYNC=50,P9_TLOCK=52,P9_TGETLOCK=54,P9_TLINK=70,P9_TMKDIR=72,P9_TRENAMEAT=74,P9_TUNLINKAT=76,P9_TVERSION=100,P9_TATTACH=104,P9_TERROR=106,P9_TFLUSH=108,P9_TWALK=110,P9_TOPEN=112,P9_TREAD=116,P9_TWRITE=118,P9_TCLUNK=120,P9_TRENAME=20,P9_TAUTH=102,P9_TCREATE=114,P9_TREMOVE=122,P9_TSTAT=124,P9_TWSTAT=126,POSIX_ERR_CODE_MAP=
{EPERM:1,ENOENT:2,EBADF:9,EBUSY:11,EINVAL:22,ENOTDIR:20,EISDIR:21,EEXIST:17,ELOOP:40,ENOTEMPTY:39,EIO:5},P9_SETATTR_MODE=1,P9_SETATTR_UID=2,P9_SETATTR_GID=4,P9_SETATTR_SIZE=8,P9_SETATTR_ATIME=16,P9_SETATTR_MTIME=32,P9_SETATTR_CTIME=64,P9_SETATTR_ATIME_SET=128,P9_SETATTR_MTIME_SET=256,P9_STAT_MODE_DIR=2147483648,P9_STAT_MODE_APPEND=1073741824,P9_STAT_MODE_EXCL=536870912,P9_STAT_MODE_MOUNT=268435456,P9_STAT_MODE_AUTH=134217728,P9_STAT_MODE_TMP=67108864,P9_STAT_MODE_SYMLINK=33554432,P9_STAT_MODE_LINK=
16777216,P9_STAT_MODE_DEVICE=8388608,P9_STAT_MODE_NAMED_PIPE=2097152,P9_STAT_MODE_SOCKET=1048576,P9_STAT_MODE_SETUID=524288,P9_STAT_MODE_SETGID=262144,P9_STAT_MODE_SETVTX=65536,P9_QTDIR=128,P9_QTAPPEND=64,P9_QTEXCL=32,P9_QTMOUNT=16,P9_QTAUTH=8,P9_QTTMP=4,P9_QTSYMLINK=2,P9_QTLINK=1,P9_QTFILE=0,FID_NONE=-1,FID_INODE=1,FID_XATTR=2;function hash32(a){for(var b=5381,c=a.length;c;)b=33*b^a.charCodeAt(--c);return b>>>0}
function getQType(a){switch(a){case "FILE":return P9_QTFILE;case "DIRECTORY":return P9_QTDIR;case "SYMLINK":return P9_QTSYMLINK;default:return P9_QTFILE}}function formatQid(a,b){return{type:getQType(b.type),version:b.version,path:hash32(b.node)}}
function Virtio9p(a,b){this.fs=a.fs;this.sh=a.sh;this.Path=a.Path;this.Buffer=a.Buffer;this.bus=b;this.deviceid=9;this.hostfeature=1;this.configspace=new Uint8Array([6,0,104,111,115,116,57,112]);this.VERSION="9P2000.L";this.msize=this.BLOCKSIZE=8192;this.replybuffer=new Uint8Array(2*this.msize);this.replybuffersize=0;this.fids={};this.pendingTags={}}Virtio9p.prototype.addTag=function(a){this.pendingTags[a]={}};Virtio9p.prototype.flushTag=function(a){delete this.pendingTags[a]};
Virtio9p.prototype.shouldAbortRequest=function(a){var b=!this.pendingTags[a];b&&debug("Request can be aborted tag="+a);return b};Virtio9p.prototype.SendReply=function(a,b){debug("Unexpected call to SendReply on Virtio9p",a,b)};Virtio9p.prototype.get_state=function(){var a=[];a[0]=this.deviceid;a[1]=this.hostfeature;a[2]=this.configspace;a[3]=this.VERSION;a[4]=this.BLOCKSIZE;a[5]=this.msize;a[6]=this.replybuffer;a[7]=this.replybuffersize;a[8]=JSON.stringify(this.fids);return a};
Virtio9p.prototype.set_state=function(a){this.deviceid=a[0];this.hostfeature=a[1];this.configspace=a[2];this.VERSION=a[3];this.BLOCKSIZE=a[4];this.msize=a[5];this.replybuffer=a[6];this.replybuffersize=a[7];this.fids=JSON.parse(a[8])};Virtio9p.prototype.Createfid=function(a,b,c){return{path:a,type:b,uid:c}};Virtio9p.prototype.Reset=function(){this.fids={}};
Virtio9p.prototype.BuildReply=function(a,b,c){marshall.Marshall(["w","b","h"],[c+7,a+1,b],this.replybuffer,0);c+7>=this.replybuffer.length&&debug("Error in 9p: payloadsize exceeds maximum length");this.replybuffersize=c+7;this.flushTag(b)};Virtio9p.prototype.SendError=function(a,b){debug("ERROR REPLY",b);b=marshall.Marshall(["w"],[POSIX_ERR_CODE_MAP[b.code]],this.replybuffer,7);this.BuildReply(6,a,b)};
Virtio9p.prototype.ReceiveRequest=function(a,b){var c=this,d=this.Path,e=this.Buffer,f=this.fs,g=this.sh,k=marshall.Unmarshall2(["w","b","h"],b),l=k[0],m=k[1],p=k[2];this.addTag(p);switch(m){case P9_TSTATFS:debug("[statfs]");g=this.BLOCKSIZE;k=Math.floor(274877906944/g);l=marshall.Marshall("wwddddddw".split(""),[V9FS_MAGIC,g,k,k-Math.floor(51200/g),k-Math.floor(51200/g),this.fs.inodes.length,1048576,0,256],this.replybuffer,7);this.BuildReply(m,p,l);this.SendReply(0,a);break;case P9_TLOPEN:var n=marshall.Unmarshall2(["w",
"w"],b),r=n[0],q=this.fids[r].path,u=n[1];debug("[tlopen] fid="+r," path="+q," mode="+u);f.stat(q,function(b,e){c.shouldAbortRequest(p)||(b?c.SendError(p,b):(n[0]=formatQid(q,e),n[1]=c.msize-24,marshall.Marshall(["Q","w"],n,c.replybuffer,7),c.BuildReply(m,p,17)),c.SendReply(0,a))});break;case P9_TLINK:n=marshall.Unmarshall2(["w","w","s"],b);var w=n[0];k=c.fids[w].path;r=n[1];u=c.fids[r].path;g=n[2];var x=d.join(k,g);debug("[link] existingPath="+u+", newPath="+x);f.link(u,x,function(b){c.shouldAbortRequest(p)||
(b?c.SendError(p,b):c.BuildReply(m,p,0),c.SendReply(0,a))});break;case P9_TSYMLINK:n=marshall.Unmarshall2(["w","s","s","w"],b);w=n[0];k=c.fids[w].path;g=n[1];x=d.join(k,g);g=n[2];k=n[3];debug("[symlink] symtgt="+g+", newPath="+x+", gid="+k);f.symlink(g,x,function(b){c.shouldAbortRequest(p)||(b?(c.SendError(p,b),c.SendReply(0,a)):f.stat(x,function(b,e){c.shouldAbortRequest(p)||(b?c.SendError(p,b):(b=formatQid(x,e),marshall.Marshall(["Q"],[b],c.replybuffer,7),c.BuildReply(m,p,13)),c.SendReply(0,a))}))});
break;case P9_TMKNOD:n=marshall.Unmarshall2("wswwww".split(""),b);w=n[0];k=c.fids[w].path;g=n[1];var A=d.join(k,g);u=n[2];g=n[3];u=n[4];k=n[5];debug("[mknod] filePath="+A+", major="+g+", minor="+u+", gid="+k);f.mknod(A,"FILE",function(b){c.shouldAbortRequest(p)||(b?(c.SendError(p,b),c.SendReply(0,a)):f.stat(A,function(b,e){c.shouldAbortRequest(p)||(b?(c.SendError(p,b),c.SendReply(0,a)):(b=formatQid(A,e),marshall.Marshall(["Q"],[b],this.replybuffer,7),this.BuildReply(m,p,13),this.SendReply(0,a)))}))});
break;case P9_TREADLINK:n=marshall.Unmarshall2(["w"],b);r=n[0];q=c.fids[r].path;debug("[readlink] path="+q);f.readlink(q,function(b,e){c.shouldAbortRequest(p)||(b?c.SendError(p,b):(l=marshall.Marshall(["s"],[e],c.replybuffer,7),c.BuildReply(m,p,l)),c.SendReply(0,a))});break;case P9_TMKDIR:n=marshall.Unmarshall2(["w","s","w","w"],b);w=n[0];g=n[1];u=n[2];k=n[3];w=c.fids[w].path;var C=d.join(w,g);debug("[mkdir] fid.path="+w+", name="+C+", mode="+u+", gid="+k);f.mkdir(C,u,function(b){c.shouldAbortRequest(p)||
(b?(c.SendError(p,b),c.SendReply(0,a)):f.stat(C,function(b,e){c.shouldAbortRequest(p)||(b?c.SendError(p,b):(b=formatQid(C,e),marshall.Marshall(["Q"],[b],c.replybuffer,7),c.BuildReply(m,p,13)),c.SendReply(0,a))}))});break;case P9_TLCREATE:n=marshall.Unmarshall2(["w","s","w","w","w"],b);r=n[0];g=n[1];k=n[2];u=n[3];k=n[4];debug("[tlcreate] fid="+r+", name="+g+", mode="+u+", gid="+k);var D=d.join(c.fids[r].path,g);f.open(D,"w+",u,function(b,e){c.shouldAbortRequest(p)?e&&f.close(e):b?(c.SendError(p,b),
c.SendReply(0,a)):f.fstat(e,function(b,d){c.shouldAbortRequest(p)?e&&f.close(e):(b?c.SendError(p,b):(c.fids[r]=c.Createfid(D,FID_INODE,E),f.close(e),b=formatQid(D,d),marshall.Marshall(["Q","w"],[b,c.msize-24],c.replybuffer,7),c.BuildReply(m,p,17)),c.SendReply(0,a))})});break;case P9_TLOCK:debug("lock file\n");marshall.Marshall(["w"],[0],this.replybuffer,7);this.BuildReply(m,p,1);this.SendReply(0,a);break;case P9_TGETATTR:n=marshall.Unmarshall2(["w","d"],b);r=n[0];q=this.fids[r].path;debug("[getattr]: fid="+
r+" path="+q+" request mask="+n[1]);f.lstat(q,function(b,e){if(!c.shouldAbortRequest(p)){if(b)c.SendError(p,b);else{b=formatQid(q,e);var d=e.size;b=[2047,b,e.mode,e.uid,e.gid,e.nlinks,0,d,c.BLOCKSIZE,Math.floor(d/512+1),Math.round(e.atimeMs/1E3),1E6*e.atimeMs,Math.round(e.mtimeMs/1E3),1E6*e.mtimeMs,Math.round(e.ctimeMs/1E3),1E6*e.ctimeMs,0,0,0,0];debug("stats",{mode:e.mode,stats:e,p9Stats:b});marshall.Marshall("dQwwwddddddddddddddd".split(""),b,c.replybuffer,7);c.BuildReply(m,p,153)}c.SendReply(0,
a)}});break;case P9_TSETATTR:n=marshall.Unmarshall2("wwwwwddddd".split(""),b);r=n[0];q=c.fids[r].path;debug("[setattr]: path="+q+" request mask="+n[1]);g=[];n[1]&P9_SETATTR_MODE&&g.push(new Promise(function(a,b){var e=n[2];debug("[setattr]: mode="+e);c.shouldAbortRequest(p)||f.chmod(q,e,function(c){c?b(c):a()})}));n[1]&P9_SETATTR_UID&&n[1]&P9_SETATTR_GID&&g.push(new Promise(function(a,b){var e=n[3],d=n[4];debug("[setattr]: uid="+e+" gid="+d);c.shouldAbortRequest(p)||f.chown(q,e,d,function(c){c?b(c):
a()})}));var B,z;k=Date.now();n[1]&P9_SETATTR_ATIME&&(B=k);n[1]&P9_SETATTR_MTIME&&(z=k);n[1]&P9_SETATTR_CTIME&&debug("[TODO] requested to SETATTR for CTIME, ignoring");n[1]&P9_SETATTR_ATIME_SET&&(B=1E3*n[6]);n[1]&P9_SETATTR_MTIME_SET&&(z=1E3*n[8]);(B||z)&&g.push(new Promise(function(a,b){c.shouldAbortRequest(p)||(debug("[setattr]: atime="+B+" mtime="+z),f.utimes(q,B,z,function(c){c?b(c):a()}))}));n[1]&P9_SETATTR_SIZE&&g.push(new Promise(function(a,b){var c=n[5];debug("[setattr]: size="+c);f.truncate(q,
c,function(c){c?b(c):a()})}));Promise.all(g).then(function(){c.BuildReply(m,p,0);c.SendReply(0,a)}).catch(function(b){c.SendError(p,b);c.SendReply(0,a)});break;case P9_TFSYNC:n=marshall.Unmarshall2(["w","d"],b);r=n[0];this.BuildReply(m,p,0);this.SendReply(0,a);break;case P9_TREADDIR:n=marshall.Unmarshall2(["w","d","w"],b);r=n[0];var y=n[1],v=n[2];q=this.fids[r].path;debug("[treaddir]: fid="+r+" path="+q+" offset="+y+" count="+v);g.ls(q,{recursive:!1},function(b,e){if(!c.shouldAbortRequest(p))if(b)c.SendError(p,
b),c.SendReply(0,a);else{var g=e.reduce(function(a,b){return a+13+8+1+2+UTF8.UTF8Length(b.name)},0);g+=25;g+=26;var k=new Uint8Array(g);f.stat(q,function(b,l){if(!c.shouldAbortRequest(p))if(b)c.SendError(p,b),c.SendReply(0,a);else{var n=0;n+=marshall.Marshall(["Q","d","b","s"],[formatQid(q,l),n+13+8+1+2+1,l.mode>>12,"."],k,n);var r=d.resolve("..",q);f.stat(r,function(b,f){if(!c.shouldAbortRequest(p)){if(b)c.SendError(p,b);else{n+=marshall.Marshall(["Q","d","b","s"],[formatQid(r,f),n+13+8+1+2+2,f.mode>>
12,".."],k,n);e.forEach(function(a){var b=d.join(q,a.name);n+=marshall.Marshall(["Q","d","b","s"],[formatQid(b,a),n+13+8+1+2+UTF8.UTF8Length(a.name),a.mode>>12,a.name],k,n)});g<y+v&&(v=g-y);if(k)for(b=0;b<v;b++)c.replybuffer[11+b]=k[y+b];marshall.Marshall(["w"],[v],c.replybuffer,7);c.BuildReply(m,p,4+v)}c.SendReply(0,a)}})}})}});break;case P9_TREAD:var F=function(b){var e=b.length;y+v>e&&(v=e-y);for(e=0;e<v;e++)c.replybuffer[11+e]=b[y+e];marshall.Marshall(["w"],[v],c.replybuffer,7);c.BuildReply(m,
p,4+v);c.SendReply(0,a)};n=marshall.Unmarshall2(["w","d","w"],b);r=n[0];y=n[1];v=n[2];q=this.fids[r].path;debug("[tread]: fid="+r+" path="+q+" offset="+y+" count="+v);if(g=c.pendingTags[p].data){F(g);break}f.readFile(q,function(b,e){c.shouldAbortRequest(p)||(b?(c.SendError(p,b),c.SendReply(0,a)):(c.pendingTags[p].data=e,F(e)))});break;case P9_TWRITE:n=marshall.Unmarshall2(["w","d","w"],b);r=n[0];y=n[1];v=n[2];q=c.fids[r].path;debug("[twrite]: fid="+r+" path="+q+" offset="+y+" count="+v);f.open(q,
"w",function(d,g){if(c.shouldAbortRequest(p))g&&f.close(g);else if(d)c.SendError(p,d),c.SendReply(0,a);else{d=e.alloc(v);for(var k=0;k<v;k++)d[k]=b();f.write(g,d,0,v,y,function(b,e){c.shouldAbortRequest(p)?g&&f.close(g):(b?c.SendError(p,b):(f.close(g),marshall.Marshall(["w"],[e],c.replybuffer,7),c.BuildReply(m,p,4)),c.SendReply(0,a))})}});break;case P9_TRENAMEAT:n=marshall.Unmarshall2(["w","s","w","s"],b);g=d.join(c.fids[n[0]].path,n[1]);x=d.join(c.fids[n[2]].path,n[3]);debug("[renameat]: oldPath="+
g+" newPath="+x);f.rename(g,x,function(b){c.shouldAbortRequest(p)||(b?c.SendError(p,b):c.BuildReply(m,p,0),c.SendReply(0,a))});break;case P9_TUNLINKAT:n=marshall.Unmarshall2(["w","s","w"],b);u=n[0];g=n[1];k=n[2];q=d.join(c.fids[u].path,g);debug("[tunlinkat]: path="+q);f.stat(q,function(b,e){if(!c.shouldAbortRequest(p))if(b)c.SendError(p,b),c.SendReply(0,a);else f["DIRECTORY"===e.type?"rmdir":"unlink"](q,function(b){c.shouldAbortRequest(p)||(b?c.SendError(p,b):c.BuildReply(m,p,0),c.SendReply(0,a))})});
break;case P9_TVERSION:g=marshall.Unmarshall2(["w","s"],b);debug("[version]: msize="+g[0]+" version="+g[1]);this.msize=g[0];l=marshall.Marshall(["w","s"],[this.msize,this.VERSION],this.replybuffer,7);this.BuildReply(m,p,l);this.SendReply(0,a);break;case P9_TATTACH:n=marshall.Unmarshall2(["w","w","s","s","w"],b);r=n[0];var E=n[4];debug("[attach]: fid="+r+" afid="+hex8(n[1])+" uname="+n[2]+" aname="+n[3]);this.fids[r]=this.Createfid("/",FID_INODE,E);f.stat("/",function(b,e){c.shouldAbortRequest(p)||
(b?c.SendError(p,b):(b=formatQid("/",e),marshall.Marshall(["Q"],[b],c.replybuffer,7),c.BuildReply(m,p,13)),c.SendReply(0,a))});break;case P9_TFLUSH:n=marshall.Unmarshall2(["h"],b);this.flushTag(n[0]);debug("[flush] "+p);this.BuildReply(m,p,0);this.SendReply(0,a);break;case P9_TWALK:var G=function(b,e){var g=e.shift();g?(b=d.join(b,g),f.stat(b,function(d,f){c.shouldAbortRequest(p)||(d?(c.SendError(p,d),c.SendReply(0,a)):(d=formatQid(b,f),c.fids[H]=c.Createfid(b,FID_INODE,f.uid),y+=marshall.Marshall(["Q"],
[d],c.replybuffer,y),I++,G(b,e)))})):(marshall.Marshall(["h"],[I],c.replybuffer,7),c.BuildReply(m,p,y-7),c.SendReply(0,a))};n=marshall.Unmarshall2(["w","w","h"],b);r=n[0];var H=n[1];g=n[2];debug("[walk]: fid="+n[0]+" nwfid="+n[1]+" nwname="+g);if(0==g){c.fids[H]=c.Createfid(c.fids[r].path,FID_INODE,c.fids[r].uid);marshall.Marshall(["h"],[0],c.replybuffer,7);c.BuildReply(m,p,2);c.SendReply(0,a);break}k=[];for(u=0;u<g;u++)k.push("s");g=marshall.Unmarshall2(k,b);q=this.fids[r].path;y=9;var I=0;debug("walk in dir "+
q+" to: "+g.toString());G(q,g);break;case P9_TCLUNK:n=marshall.Unmarshall2(["w"],b);r=n[0];q=c.fids[r].path;debug("[clunk]: fid="+r+" path="+q);delete c.fids[r];this.BuildReply(m,p,0);this.SendReply(0,a);break;case P9_TXATTRCREATE:n=marshall.Unmarshall2(["w","s","d","w"],b);r=n[0];g=n[1];u=n[2];k=n[3];debug("[txattrcreate]: fid="+r+" name="+g+" attr_size="+u+" flags="+k);this.BuildReply(m,p,0);this.SendReply(0,a);break;case P9_TXATTRWALK:n=marshall.Unmarshall2(["w","w","s"],b);r=n[0];k=n[1];g=n[2];
debug("[xattrwalk]: fid="+n[0]+" newfid="+n[1]+" name="+n[2]);this.fids[k]=this.Createfid(this.fids[r].inodeid,FID_NONE,this.fids[r].uid);u=0;"security.capability"==g&&(u=this.fs.PrepareCAPs(this.fids[r].inodeid),this.fids[k].type=FID_XATTR);marshall.Marshall(["d"],[u],this.replybuffer,7);this.BuildReply(m,p,8);this.SendReply(0,a);break;default:debug("Error in Virtio9p: Unknown id "+m+" received"),message.Abort()}};var DEBUG=!1,LOG_TO_FILE=!1,LOG_ALL_IO=!1,LOG_PAGE_FAULTS=!1,LOG_LEVEL=LOG_ALL&LOG_9P,DEBUG_SCREEN_LAYERS=DEBUG&&!1,ENABLE_HPET=DEBUG&&!1,ENABLE_ACPI=!1,LOOP_COUNTER=11001,TIME_PER_FRAME=1,TSC_RATE=8192,APIC_TIMER_FREQ=TSC_RATE,VMWARE_HYPERVISOR_PORT=!0;function IO(a){this.ports=[];this.cpu=a;for(var b=0;65536>b;b++)this.ports[b]=this.create_empty_entry();var c=a.memory_size;for(b=0;b<<MMAP_BLOCK_BITS<c;b++)a.memory_map_read8[b]=a.memory_map_write8[b]=void 0,a.memory_map_read32[b]=a.memory_map_write32[b]=void 0;this.mmap_register(c,4294967296-c,function(a){dbg_log("Read from unmapped memory space, addr="+h(a>>>0,8),LOG_IO);return 255},function(a,b){dbg_log("Write to unmapped memory space, addr="+h(a>>>0,8)+" value="+h(b,2),LOG_IO)},function(a){dbg_log("Read from unmapped memory space, addr="+
h(a>>>0,8),LOG_IO);return-1},function(a,b){dbg_log("Write to unmapped memory space, addr="+h(a>>>0,8)+" value="+h(b>>>0,8),LOG_IO)})}IO.prototype.create_empty_entry=function(){return{read8:this.empty_port_read8,read16:this.empty_port_read16,read32:this.empty_port_read32,write8:this.empty_port_write,write16:this.empty_port_write,write32:this.empty_port_write,device:void 0}};IO.prototype.empty_port_read8=function(){return 255};IO.prototype.empty_port_read16=function(){return 65535};
IO.prototype.empty_port_read32=function(){return-1};IO.prototype.empty_port_write=function(a){};
IO.prototype.register_read=function(a,b,c,d,e){dbg_assert("number"===typeof a);dbg_assert("object"===typeof b);dbg_assert(!c||"function"===typeof c);dbg_assert(!d||"function"===typeof d);dbg_assert(!e||"function"===typeof e);dbg_assert(c||d||e);if(DEBUG){var f=function(c){dbg_assert(!1,"Overlapped read"+c+" "+h(a,4)+" ("+b.name+")");return-1>>>32-c|0};c||(c=f.bind(this,8));d||(d=f.bind(this,16));e||(e=f.bind(this,32))}c&&(this.ports[a].read8=c);d&&(this.ports[a].read16=d);e&&(this.ports[a].read32=
e);this.ports[a].device=b};
IO.prototype.register_write=function(a,b,c,d,e){dbg_assert("number"===typeof a);dbg_assert("object"===typeof b);dbg_assert(!c||"function"===typeof c);dbg_assert(!d||"function"===typeof d);dbg_assert(!e||"function"===typeof e);dbg_assert(c||d||e);if(DEBUG){var f=function(c){dbg_assert(!1,"Overlapped write"+c+" "+h(a)+" ("+b.name+")")};c||(c=f.bind(this,8));d||(d=f.bind(this,16));e||(e=f.bind(this,32))}c&&(this.ports[a].write8=c);d&&(this.ports[a].write16=d);e&&(this.ports[a].write32=e);this.ports[a].device=
b};IO.prototype.register_read_consecutive=function(a,b,c,d,e,f){function g(){return c.call(this)|d.call(this)<<8}function k(){return e.call(this)|f.call(this)<<8}function l(){return c.call(this)|d.call(this)<<8|e.call(this)<<16|f.call(this)<<24}dbg_assert(4===arguments.length||6===arguments.length);e&&f?(this.register_read(a,b,c,g,l),this.register_read(a+1,b,d),this.register_read(a+2,b,e,k),this.register_read(a+3,b,f)):(this.register_read(a,b,c,g),this.register_read(a+1,b,d))};
IO.prototype.register_write_consecutive=function(a,b,c,d,e,f){function g(a){c.call(this,a&255);d.call(this,a>>8&255)}function k(a){e.call(this,a&255);f.call(this,a>>8&255)}function l(a){c.call(this,a&255);d.call(this,a>>8&255);e.call(this,a>>16&255);f.call(this,a>>>24)}dbg_assert(4===arguments.length||6===arguments.length);e&&f?(this.register_write(a,b,c,g,l),this.register_write(a+1,b,d),this.register_write(a+2,b,e,k),this.register_write(a+3,b,f)):(this.register_write(a,b,c,g),this.register_write(a+
1,b,d))};IO.prototype.in_mmap_range=function(a,b){a>>>=0;b=a+(b>>>0);if(b>=this.cpu.memory_size)return!0;for(a&=~(MMAP_BLOCK_SIZE-1);a<b;){if(this.cpu.in_mapped_range(a))return!0;a+=MMAP_BLOCK_SIZE}return!1};IO.prototype.mmap_read32_shim=function(a){var b=this.cpu.memory_map_read8[a>>>MMAP_BLOCK_BITS];return b(a)|b(a+1)<<8|b(a+2)<<16|b(a+3)<<24};
IO.prototype.mmap_write32_shim=function(a,b){var c=this.cpu.memory_map_write8[a>>>MMAP_BLOCK_BITS];c(a,b&255);c(a+1,b>>8&255);c(a+2,b>>16&255);c(a+3,b>>>24)};
IO.prototype.mmap_register=function(a,b,c,d,e,f){dbg_log("mmap_register addr="+h(a>>>0,8)+" size="+h(b,8),LOG_IO);dbg_assert(0===(a&MMAP_BLOCK_SIZE-1));dbg_assert(b&&0===(b&MMAP_BLOCK_SIZE-1));e||(e=this.mmap_read32_shim.bind(this));f||(f=this.mmap_write32_shim.bind(this));for(a>>>=MMAP_BLOCK_BITS;0<b;a++)this.cpu.memory_map_read8[a]=c,this.cpu.memory_map_write8[a]=d,this.cpu.memory_map_read32[a]=e,this.cpu.memory_map_write32[a]=f,b-=MMAP_BLOCK_SIZE};
IO.prototype.port_write8=function(a,b){var c=this.ports[a];(c.write8===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write8 port #"+h(a,4)+" <- "+h(b,2)+this.get_port_description(a),LOG_IO);return c.write8.call(c.device,b)};IO.prototype.port_write16=function(a,b){var c=this.ports[a];(c.write16===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write16 port #"+h(a,4)+" <- "+h(b,4)+this.get_port_description(a),LOG_IO);return c.write16.call(c.device,b)};
IO.prototype.port_write32=function(a,b){var c=this.ports[a];(c.write32===this.empty_port_write||LOG_ALL_IO)&&dbg_log("write32 port #"+h(a,4)+" <- "+h(b>>>0,8)+this.get_port_description(a),LOG_IO);return c.write32.call(c.device,b)};IO.prototype.port_read8=function(a){var b=this.ports[a];(b.read8===this.empty_port_read8||LOG_ALL_IO)&&dbg_log("read8 port  #"+h(a,4)+this.get_port_description(a),LOG_IO);b=b.read8.call(b.device);dbg_assert(256>b,"8 bit port returned large value: "+h(a));return b};
IO.prototype.port_read16=function(a){var b=this.ports[a];(b.read16===this.empty_port_read16||LOG_ALL_IO)&&dbg_log("read16 port  #"+h(a,4)+this.get_port_description(a),LOG_IO);b=b.read16.call(b.device);dbg_assert(65536>b&&0<=b,"16 bit port returned large value: "+h(a));return b};
IO.prototype.port_read32=function(a){var b=this.ports[a];(b.read32===this.empty_port_read32||LOG_ALL_IO)&&dbg_log("read32 port  #"+h(a,4)+this.get_port_description(a),LOG_IO);a=b.read32.call(b.device);dbg_assert((a|0)===a);return a};
var debug_port_list={4:"PORT_DMA_ADDR_2",5:"PORT_DMA_CNT_2",10:"PORT_DMA1_MASK_REG",11:"PORT_DMA1_MODE_REG",12:"PORT_DMA1_CLEAR_FF_REG",13:"PORT_DMA1_MASTER_CLEAR",32:"PORT_PIC1_CMD",33:"PORT_PIC1_DATA",64:"PORT_PIT_COUNTER0",65:"PORT_PIT_COUNTER1",66:"PORT_PIT_COUNTER2",67:"PORT_PIT_MODE",96:"PORT_PS2_DATA",97:"PORT_PS2_CTRLB",100:"PORT_PS2_STATUS",112:"PORT_CMOS_INDEX",113:"PORT_CMOS_DATA",128:"PORT_DIAG",129:"PORT_DMA_PAGE_2",146:"PORT_A20",160:"PORT_PIC2_CMD",161:"PORT_PIC2_DATA",178:"PORT_SMI_CMD",
179:"PORT_SMI_STATUS",212:"PORT_DMA2_MASK_REG",214:"PORT_DMA2_MODE_REG",218:"PORT_DMA2_MASTER_CLEAR",240:"PORT_MATH_CLEAR",368:"PORT_ATA2_CMD_BASE",496:"PORT_ATA1_CMD_BASE",632:"PORT_LPT2",744:"PORT_SERIAL4",760:"PORT_SERIAL2",884:"PORT_ATA2_CTRL_BASE",888:"PORT_LPT1",1E3:"PORT_SERIAL3",1008:"PORT_FD_BASE",1010:"PORT_FD_DOR",1012:"PORT_FD_STATUS",1013:"PORT_FD_DATA",1014:"PORT_HD_DATA",1015:"PORT_FD_DIR",1016:"PORT_SERIAL1",3320:"PORT_PCI_CMD",3321:"PORT_PCI_REBOOT",3324:"PORT_PCI_DATA",1026:"PORT_BIOS_DEBUG",
1296:"PORT_QEMU_CFG_CTL",1297:"PORT_QEMU_CFG_DATA",45056:"PORT_ACPI_PM_BASE",45312:"PORT_SMB_BASE",35072:"PORT_BIOS_APM"};IO.prototype.get_port_description=function(a){return debug_port_list[a]?"  ("+debug_port_list[a]+")":""};function v86(a){this.stopped=this.running=!1;this.cpu=new CPU(a);this.bus=a;a.register("cpu-init",this.init,this);a.register("cpu-run",this.run,this);a.register("cpu-stop",this.stop,this);a.register("cpu-restart",this.restart,this);this.register_tick()}v86.prototype.run=function(){this.running||(this.bus.send("emulator-started"),this.fast_next_tick())};
v86.prototype.do_tick=function(){if(this.stopped)this.stopped=this.running=!1,this.bus.send("emulator-stopped");else{this.running=!0;var a=this.cpu.main_run();0>=a?this.fast_next_tick():this.next_tick(a)}};v86.prototype.stop=function(){this.running&&(this.stopped=!0)};v86.prototype.restart=function(){this.cpu.reset();this.cpu.load_bios()};v86.prototype.init=function(a){this.cpu.init(a,this.bus);this.bus.send("emulator-ready")};
if("undefined"!==typeof setImmediate)var fast_next_tick=function(){var a=this;setImmediate(function(){a.do_tick()})},register_tick=function(){};else if("undefined"!==typeof window&&"undefined"!==typeof postMessage){var MAGIC_POST_MESSAGE=43605;fast_next_tick=function(){window.postMessage(MAGIC_POST_MESSAGE,"*")};register_tick=function(){var a=this;window.addEventListener("message",function(b){b.source===window&&b.data===MAGIC_POST_MESSAGE&&a.do_tick()},!1)}}else fast_next_tick=function(){var a=this;
setTimeout(function(){a.do_tick()},0)},register_tick=function(){};v86.prototype.fast_next_tick=fast_next_tick;v86.prototype.register_tick=register_tick;var next_tick="undefined"!==typeof document&&"boolean"===typeof document.hidden?function(a){var b=this;4>a||document.hidden?this.fast_next_tick():setTimeout(function(){b.do_tick()},a)}:function(a){var b=this;setTimeout(function(){b.do_tick()},a)};v86.prototype.next_tick=next_tick;v86.prototype.save_state=function(){return this.cpu.save_state()};
v86.prototype.restore_state=function(a){return this.cpu.restore_state(a)};v86.microtick="object"===typeof performance&&performance.now?function(){return performance.now()}:Date.now;var v86util=v86util||{};v86util.pads=function(a,b){for(a=a?a+"":"";a.length<b;)a+=" ";return a};v86util.pad0=function(a,b){for(a=a?a+"":"";a.length<b;)a="0"+a;return a};function h(a,b){a=a?a.toString(16):"";return"0x"+v86util.pad0(a.toUpperCase(),b||1)}
if("undefined"!==typeof window&&window.crypto&&window.crypto.getRandomValues){var rand_data=new Int32Array(1);v86util.has_rand_int=function(){return!0};v86util.get_rand_int=function(){window.crypto.getRandomValues(rand_data);return rand_data[0]}}else v86util.has_rand_int=function(){return!1},v86util.get_rand_int=function(){console.assert(!1)};function SyncBuffer(a){this.buffer=a;this.byteLength=a.byteLength;this.onprogress=this.onload=void 0}SyncBuffer.prototype.load=function(){this.onload&&this.onload({buffer:this.buffer})};
SyncBuffer.prototype.get=function(a,b,c){dbg_assert(a+b<=this.byteLength);c(new Uint8Array(this.buffer,a,b))};SyncBuffer.prototype.set=function(a,b,c){dbg_assert(a+b.byteLength<=this.byteLength);(new Uint8Array(this.buffer,a,b.byteLength)).set(b);c()};SyncBuffer.prototype.get_buffer=function(a){a(this.buffer)};
(function(){for(var a=new Int8Array(256),b=0,c=-2;256>b;b++)b&b-1||c++,a[b]=c;v86util.int_log2_byte=function(b){dbg_assert(0<b);dbg_assert(256>b);return a[b]};v86util.int_log2=function(b){dbg_assert(0<b);var c=b>>>16;if(c){var d=c>>>8;return d?24+a[d]:16+a[c]}return(d=b>>>8)?8+a[d]:a[b]}})();
function ByteQueue(a){var b=new Uint8Array(a),c,d;dbg_assert(0===(a&a-1));this.length=0;this.push=function(c){this.length!==a&&this.length++;b[d]=c;d=d+1&a-1};this.shift=function(){if(this.length){var e=b[c];c=c+1&a-1;this.length--;return e}return-1};this.peek=function(){return this.length?b[c]:-1};this.clear=function(){this.length=d=c=0};this.clear()}function FloatQueue(a){this.size=a;this.data=new Float32Array(a);this.length=this.end=this.start=0;dbg_assert(0===(a&a-1))}
FloatQueue.prototype.push=function(a){this.length===this.size?this.start=this.start+1&this.size-1:this.length++;this.data[this.end]=a;this.end=this.end+1&this.size-1};FloatQueue.prototype.shift=function(){if(this.length){var a=this.data[this.start];this.start=this.start+1&this.size-1;this.length--;return a}};
FloatQueue.prototype.shift_block=function(a){var b=new Float32Array(a);a>this.length&&(a=this.length);var c=this.start+a,d=this.data.subarray(this.start,c);b.set(d);c>=this.size&&(c-=this.size,b.set(this.data.subarray(0,c),d.length));this.start=c;this.length-=a;return b};FloatQueue.prototype.peek=function(){if(this.length)return this.data[this.start]};FloatQueue.prototype.clear=function(){this.length=this.end=this.start=0};function CircularQueue(a){this.data=[];this.index=0;this.size=a}
CircularQueue.prototype.add=function(a){this.data[this.index]=a;this.index=(this.index+1)%this.size};CircularQueue.prototype.toArray=function(){return[].slice.call(this.data,this.index).concat([].slice.call(this.data,0,this.index))};CircularQueue.prototype.clear=function(){this.data=[];this.index=0};CircularQueue.prototype.set=function(a){this.data=a;this.index=0};function dump_file(a,b){a instanceof Array||(a=[a]);a=new Blob(a);download(a,b)}
function download(a,b){var c=document.createElement("a");c.download=b;c.href=window.URL.createObjectURL(a);c.dataset.downloadurl=["application/octet-stream",c.download,c.href].join(":");document.createEvent?(a=document.createEvent("MouseEvent"),a.initMouseEvent("click",!0,!0,window,0,0,0,0,0,!1,!1,!1,!1,0,null),c.dispatchEvent(a)):c.click();window.URL.revokeObjectURL(c.href)};var FPU_LOG_OP=!1,FPU_C0=256,FPU_C1=512,FPU_C2=1024,FPU_C3=16384,FPU_RESULT_FLAGS=FPU_C0|FPU_C1|FPU_C2|FPU_C3,FPU_STACK_TOP=14336,FPU_PC=768,FPU_RC=3072,FPU_IF=4096,FPU_EX_SF=64,FPU_EX_P=32,FPU_EX_U=16,FPU_EX_O=8,FPU_EX_Z=4,FPU_EX_D=2,FPU_EX_I=1,TWO_POW_63=0x7fffffffffffffff;
function FPU(a){this.cpu=a;this.st=new Float64Array(8);this.float32=new Float32Array(1);this.float32_byte=new Uint8Array(this.float32.buffer);this.float32_int=new Int32Array(this.float32.buffer);this.float64=new Float64Array(1);this.float64_byte=new Uint8Array(this.float64.buffer);this.float64_int=new Int32Array(this.float64.buffer);this.st8=new Uint8Array(this.st.buffer);this.st32=new Int32Array(this.st.buffer);this.stack_empty=255;this.stack_ptr=0;this.control_word=895;this.fpu_dp_selector=this.fpu_dp=
this.fpu_opcode=this.fpu_ip_selector=this.fpu_ip=this.status_word=0;this.indefinite_nan=NaN;this.constants=new Float64Array([1,Math.log(10)/Math.LN2,Math.LOG2E,Math.PI,Math.log(2)/Math.LN10,Math.LN2,0])}FPU.prototype.get_state=function(){var a=[];a[0]=this.st;a[1]=this.stack_empty;a[2]=this.stack_ptr;a[3]=this.control_word;a[4]=this.fpu_dp_selector;a[5]=this.fpu_ip;a[6]=this.fpu_ip_selector;a[7]=this.fpu_dp;a[8]=this.fpu_dp_selector;a[9]=this.fpu_opcode;return a};
FPU.prototype.set_state=function(a){this.st.set(a[0]);this.stack_empty=a[1];this.stack_ptr=a[2];this.control_word=a[3];this.fpu_ip=a[5];this.fpu_ip_selector=a[6];this.fpu_dp=a[7];this.fpu_dp_selector=a[8];this.fpu_opcode=a[9]};FPU.prototype.fpu_unimpl=function(){dbg_trace();if(DEBUG)throw"fpu: unimplemented";this.cpu.trigger_ud()};FPU.prototype.stack_fault=function(){this.status_word=this.status_word|FPU_EX_SF|FPU_EX_I};FPU.prototype.invalid_arithmatic=function(){this.status_word|=FPU_EX_I};
FPU.prototype.fcom=function(a){var b=this.get_st0();this.status_word&=~FPU_RESULT_FLAGS;b>a||(this.status_word=a>b?this.status_word|FPU_C0:b===a?this.status_word|FPU_C3:this.status_word|FPU_C0|FPU_C2|FPU_C3)};FPU.prototype.fucom=function(a){this.fcom(a)};
FPU.prototype.fcomi=function(a){var b=this.st[this.stack_ptr];this.cpu.flags_changed&=~(1|flag_parity|flag_zero);this.cpu.flags&=~(1|flag_parity|flag_zero);b>a||(this.cpu.flags=a>b?this.cpu.flags|1:b===a?this.cpu.flags|flag_zero:this.cpu.flags|1|flag_parity|flag_zero)};FPU.prototype.fucomi=function(a){this.fcomi(a)};
FPU.prototype.ftst=function(a){this.status_word&=~FPU_RESULT_FLAGS;isNaN(a)?this.status_word=this.status_word|FPU_C3|FPU_C2|FPU_C0:0===a?this.status_word|=FPU_C3:0>a&&(this.status_word|=FPU_C0)};
FPU.prototype.fxam=function(a){this.status_word&=~FPU_RESULT_FLAGS;this.status_word|=this.sign(0)<<9;this.stack_empty>>this.stack_ptr&1?this.status_word=this.status_word|FPU_C3|FPU_C0:isNaN(a)?this.status_word|=FPU_C0:this.status_word=0===a?this.status_word|FPU_C3:Infinity===a||-Infinity===a?this.status_word|FPU_C2|FPU_C0:this.status_word|FPU_C2};FPU.prototype.finit=function(){this.control_word=895;this.fpu_opcode=this.fpu_dp=this.fpu_ip=this.status_word=0;this.stack_empty=255;this.stack_ptr=0};
FPU.prototype.load_status_word=function(){return this.status_word&-14337|this.stack_ptr<<11};FPU.prototype.set_status_word=function(a){this.status_word=a&-14337;this.stack_ptr=a>>11&7};FPU.prototype.load_tag_word=function(){for(var a=0,b,c=0;8>c;c++)b=this.st[c],this.stack_empty>>c&1?a|=3<<(c<<1):0===b?a|=1<<(c<<1):isFinite(b)||(a|=2<<(c<<1));return a};FPU.prototype.set_tag_word=function(a){for(var b=this.stack_empty=0;8>b;b++)this.stack_empty|=a>>b&a>>b+1&1<<b};
FPU.prototype.fstenv=function(a){this.cpu.is_osize_32()?(this.cpu.writable_or_pagefault(a,26),this.cpu.safe_write16(a,this.control_word),this.cpu.safe_write16(a+4,this.load_status_word()),this.cpu.safe_write16(a+8,this.load_tag_word()),this.cpu.safe_write32(a+12,this.fpu_ip),this.cpu.safe_write16(a+16,this.fpu_ip_selector),this.cpu.safe_write16(a+18,this.fpu_opcode),this.cpu.safe_write32(a+20,this.fpu_dp),this.cpu.safe_write16(a+24,this.fpu_dp_selector)):this.fpu_unimpl()};
FPU.prototype.fldenv=function(a){this.cpu.is_osize_32()?(this.control_word=this.cpu.safe_read16(a),this.set_status_word(this.cpu.safe_read16(a+4)),this.set_tag_word(this.cpu.safe_read16(a+8)),this.fpu_ip=this.cpu.safe_read32s(a+12),this.fpu_ip_selector=this.cpu.safe_read16(a+16),this.fpu_opcode=this.cpu.safe_read16(a+18),this.fpu_dp=this.cpu.safe_read32s(a+20),this.fpu_dp_selector=this.cpu.safe_read16(a+24)):this.fpu_unimpl()};
FPU.prototype.fsave=function(a){this.cpu.writable_or_pagefault(a,108);this.fstenv(a);a+=28;for(var b=0;8>b;b++)this.store_m80(a,this.st[this.stack_ptr+b&7]),a+=10;this.finit()};FPU.prototype.frstor=function(a){this.fldenv(a);a+=28;for(var b=0;8>b;b++)this.st[b+this.stack_ptr&7]=this.load_m80(a),a+=10};
FPU.prototype.fxtract=function(){this.float64[0]=this.get_st0();var a=((this.float64_byte[7]&127)<<4|this.float64_byte[6]>>4)-1023;this.float64_byte[7]=63|this.float64_byte[7]&128;this.float64_byte[6]|=240;this.st[this.stack_ptr]=a;this.push(this.float64[0])};FPU.prototype.integer_round=function(a){var b=this.control_word>>10&3;return 0===b?(b=Math.round(a),.5===b-a&&b%2&&b--,b):1===b||3===b&&0<a?Math.floor(a):Math.ceil(a)};FPU.prototype.truncate=function(a){return 0<a?Math.floor(a):Math.ceil(a)};
FPU.prototype.push=function(a){this.stack_ptr=this.stack_ptr-1&7;this.stack_empty>>this.stack_ptr&1?(this.status_word&=~FPU_C1,this.stack_empty&=~(1<<this.stack_ptr),this.st[this.stack_ptr]=a):(this.status_word|=FPU_C1,this.stack_fault(),this.st[this.stack_ptr]=this.indefinite_nan)};FPU.prototype.pop=function(){this.stack_empty|=1<<this.stack_ptr;this.stack_ptr=this.stack_ptr+1&7};
FPU.prototype.get_sti=function(a){dbg_assert("number"===typeof a&&0<=a&&8>a);a=a+this.stack_ptr&7;return this.stack_empty>>a&1?(this.status_word&=~FPU_C1,this.stack_fault(),this.indefinite_nan):this.st[a]};FPU.prototype.get_st0=function(){return this.stack_empty>>this.stack_ptr&1?(this.status_word&=~FPU_C1,this.stack_fault(),this.indefinite_nan):this.st[this.stack_ptr]};
FPU.prototype.load_m80=function(a){var b=this.cpu.safe_read16(a+8),c=this.cpu.safe_read32s(a)>>>0,d=this.cpu.safe_read32s(a+4)>>>0;a=b>>15;b&=-32769;if(0===b)return 0;if(!(32767>b))return this.float64_byte[7]=127|a<<7,this.float64_byte[6]=240|d>>30<<3&8,this.float64_byte[5]=0,this.float64_byte[4]=0,this.float64_int[0]=0,this.float64[0];c+=4294967296*d;a&&(c=-c);return c*Math.pow(2,b-16383-63)};
FPU.prototype.store_m80=function(a,b){this.float64[0]=b;b=this.float64_byte[7]&128;var c=(this.float64_byte[7]&127)<<4|this.float64_byte[6]>>4;if(2047===c){c=32767;var d=0;var e=2147483648|(this.float64_int[1]&524288)<<11}else 0===c?e=d=0:(c+=15360,d=this.float64_int[0]<<11,e=2147483648|(this.float64_int[1]&1048575)<<11|this.float64_int[0]>>>21);dbg_assert(0<=c&&32768>c);this.cpu.safe_write32(a,d);this.cpu.safe_write32(a+4,e);this.cpu.safe_write16(a+8,b<<8|c)};
FPU.prototype.load_m64=function(a){var b=this.cpu.safe_read32s(a);a=this.cpu.safe_read32s(a+4);this.float64_int[0]=b;this.float64_int[1]=a;return this.float64[0]};FPU.prototype.store_m64=function(a,b){this.cpu.writable_or_pagefault(a,8);this.float64[0]=this.get_sti(b);this.cpu.safe_write32(a,this.float64_int[0]);this.cpu.safe_write32(a+4,this.float64_int[1])};FPU.prototype.load_m32=function(a){this.float32_int[0]=this.cpu.safe_read32s(a);return this.float32[0]};
FPU.prototype.store_m32=function(a,b){this.float32[0]=b;this.cpu.safe_write32(a,this.float32_int[0])};FPU.prototype.sign=function(a){return this.st8[(this.stack_ptr+a&7)<<3|7]>>7};
FPU.prototype.dbg_log_fpu_op=function(a,b){FPU_LOG_OP&&(192<=b?dbg_log(h(a,2)+" "+h(b,2)+"/"+(b>>3&7)+"/"+(b&7)+" @"+h(this.cpu.instruction_pointer>>>0,8)+" sp="+this.stack_ptr+" st="+h(this.stack_empty,2),LOG_FPU):dbg_log(h(a,2)+" /"+(b>>3&7)+"     @"+h(this.cpu.instruction_pointer>>>0,8)+" sp="+this.stack_ptr+" st="+h(this.stack_empty,2),LOG_FPU))};FPU.prototype.fwait=function(){};
FPU.prototype.op_D8_reg=function(a){this.dbg_log_fpu_op(216,a);var b=a>>3&7;a=this.get_sti(a&7);var c=this.get_st0();switch(b){case 0:this.st[this.stack_ptr]=c+a;break;case 1:this.st[this.stack_ptr]=c*a;break;case 2:this.fcom(a);break;case 3:this.fcom(a);this.pop();break;case 4:this.st[this.stack_ptr]=c-a;break;case 5:this.st[this.stack_ptr]=a-c;break;case 6:this.st[this.stack_ptr]=c/a;break;case 7:this.st[this.stack_ptr]=a/c;break;default:dbg_assert(!1)}};
FPU.prototype.op_D8_mem=function(a,b){this.dbg_log_fpu_op(216,a);a=a>>3&7;b=this.load_m32(b);var c=this.get_st0();switch(a){case 0:this.st[this.stack_ptr]=c+b;break;case 1:this.st[this.stack_ptr]=c*b;break;case 2:this.fcom(b);break;case 3:this.fcom(b);this.pop();break;case 4:this.st[this.stack_ptr]=c-b;break;case 5:this.st[this.stack_ptr]=b-c;break;case 6:this.st[this.stack_ptr]=c/b;break;case 7:this.st[this.stack_ptr]=b/c;break;default:dbg_assert(!1)}};
FPU.prototype.op_D9_reg=function(a){this.dbg_log_fpu_op(217,a);var b=a&7;switch(a>>3&7){case 0:a=this.get_sti(b);this.push(a);break;case 1:a=this.get_sti(b);this.st[this.stack_ptr+b&7]=this.get_st0();this.st[this.stack_ptr]=a;break;case 2:switch(b){case 0:break;default:dbg_log(b),this.fpu_unimpl()}break;case 3:this.fpu_unimpl();break;case 4:a=this.get_st0();switch(b){case 0:this.st[this.stack_ptr]=-a;break;case 1:this.st[this.stack_ptr]=Math.abs(a);break;case 4:this.ftst(a);break;case 5:this.fxam(a);
break;default:dbg_log(b),this.fpu_unimpl()}break;case 5:this.push(this.constants[b]);break;case 6:a=this.get_st0();switch(b){case 0:this.st[this.stack_ptr]=Math.pow(2,a)-1;break;case 1:this.st[this.stack_ptr+1&7]=this.get_sti(1)*Math.log(a)/Math.LN2;this.pop();break;case 2:this.st[this.stack_ptr]=Math.tan(a);this.push(1);break;case 3:this.st[this.stack_ptr+1&7]=Math.atan2(this.get_sti(1),a);this.pop();break;case 4:this.fxtract();break;case 5:this.st[this.stack_ptr]=a%this.get_sti(1);break;case 6:this.stack_ptr=
this.stack_ptr-1&7;this.status_word&=~FPU_C1;break;case 7:this.stack_ptr=this.stack_ptr+1&7;this.status_word&=~FPU_C1;break;default:dbg_assert(!1)}break;case 7:a=this.get_st0();switch(b){case 0:b=this.get_sti(1);var c=Math.trunc(a/b);this.st[this.stack_ptr]=a%b;this.status_word&=~(FPU_C0|FPU_C1|FPU_C3);c&1&&(this.status_word|=FPU_C1);c&2&&(this.status_word|=FPU_C3);c&4&&(this.status_word|=FPU_C0);this.status_word&=~FPU_C2;break;case 1:this.st[this.stack_ptr+1&7]=this.get_sti(1)*Math.log(a+1)/Math.LN2;
this.pop();break;case 2:this.st[this.stack_ptr]=Math.sqrt(a);break;case 3:this.st[this.stack_ptr]=Math.sin(a);this.push(Math.cos(a));break;case 4:this.st[this.stack_ptr]=this.integer_round(a);break;case 5:this.st[this.stack_ptr]=a*Math.pow(2,this.truncate(this.get_sti(1)));break;case 6:this.st[this.stack_ptr]=Math.sin(a);break;case 7:this.st[this.stack_ptr]=Math.cos(a);break;default:dbg_assert(!1)}break;default:dbg_assert(!1)}};
FPU.prototype.op_D9_mem=function(a,b){this.dbg_log_fpu_op(217,a);switch(a>>3&7){case 0:a=this.load_m32(b);this.push(a);break;case 1:this.fpu_unimpl();break;case 2:this.store_m32(b,this.get_st0());break;case 3:this.store_m32(b,this.get_st0());this.pop();break;case 4:this.fldenv(b);break;case 5:this.control_word=this.cpu.safe_read16(b);break;case 6:this.fstenv(b);break;case 7:this.cpu.safe_write16(b,this.control_word);break;default:dbg_assert(!1)}};
FPU.prototype.op_DA_reg=function(a){this.dbg_log_fpu_op(218,a);var b=a>>3&7;a&=7;switch(b){case 0:this.cpu.test_b()&&(this.st[this.stack_ptr]=this.get_sti(a),this.stack_empty&=~(1<<this.stack_ptr));break;case 1:this.cpu.test_z()&&(this.st[this.stack_ptr]=this.get_sti(a),this.stack_empty&=~(1<<this.stack_ptr));break;case 2:this.cpu.test_be()&&(this.st[this.stack_ptr]=this.get_sti(a),this.stack_empty&=~(1<<this.stack_ptr));break;case 3:this.cpu.test_p()&&(this.st[this.stack_ptr]=this.get_sti(a),this.stack_empty&=
~(1<<this.stack_ptr));break;case 5:1===a?(this.fucom(this.get_sti(1)),this.pop(),this.pop()):(dbg_log(b),this.fpu_unimpl());break;default:dbg_log(b),this.fpu_unimpl()}};
FPU.prototype.op_DA_mem=function(a,b){this.dbg_log_fpu_op(218,a);a=a>>3&7;b=this.cpu.safe_read32s(b);var c=this.get_st0();switch(a){case 0:this.st[this.stack_ptr]=c+b;break;case 1:this.st[this.stack_ptr]=c*b;break;case 2:this.fcom(b);break;case 3:this.fcom(b);this.pop();break;case 4:this.st[this.stack_ptr]=c-b;break;case 5:this.st[this.stack_ptr]=b-c;break;case 6:this.st[this.stack_ptr]=c/b;break;case 7:this.st[this.stack_ptr]=b/c;break;default:dbg_assert(!1)}};
FPU.prototype.op_DB_reg=function(a){this.dbg_log_fpu_op(219,a);var b=a>>3&7,c=a&7;switch(b){case 0:this.cpu.test_b()||(this.st[this.stack_ptr]=this.get_sti(c),this.stack_empty&=~(1<<this.stack_ptr));break;case 1:this.cpu.test_z()||(this.st[this.stack_ptr]=this.get_sti(c),this.stack_empty&=~(1<<this.stack_ptr));break;case 2:this.cpu.test_be()||(this.st[this.stack_ptr]=this.get_sti(c),this.stack_empty&=~(1<<this.stack_ptr));break;case 3:this.cpu.test_p()||(this.st[this.stack_ptr]=this.get_sti(c),this.stack_empty&=
~(1<<this.stack_ptr));break;case 4:227===a?this.finit():228!==a&&225!==a&&(226===a?this.status_word=0:(dbg_log(h(a)),this.fpu_unimpl()));break;case 5:this.fucomi(this.get_sti(c));break;case 6:this.fcomi(this.get_sti(c));break;default:dbg_log(b),this.fpu_unimpl()}};
FPU.prototype.op_DB_mem=function(a,b){this.dbg_log_fpu_op(219,a);a=a>>3&7;switch(a){case 0:b=this.cpu.safe_read32s(b);this.push(b);break;case 2:a=this.integer_round(this.get_st0());2147483647>=a&&-2147483648<=a?this.cpu.safe_write32(b,a):(this.invalid_arithmatic(),this.cpu.safe_write32(b,-2147483648));break;case 3:a=this.integer_round(this.get_st0());2147483647>=a&&-2147483648<=a?this.cpu.safe_write32(b,a):(this.invalid_arithmatic(),this.cpu.safe_write32(b,-2147483648));this.pop();break;case 5:this.push(this.load_m80(b));
break;case 7:this.cpu.writable_or_pagefault(b,10);this.store_m80(b,this.get_st0());this.pop();break;default:dbg_log(a),this.fpu_unimpl()}};
FPU.prototype.op_DC_reg=function(a){this.dbg_log_fpu_op(220,a);var b=a>>3&7,c=a&7;a=this.stack_ptr+c&7;c=this.get_sti(c);var d=this.get_st0();switch(b){case 0:this.st[a]=c+d;break;case 1:this.st[a]=c*d;break;case 2:this.fcom(c);break;case 3:this.fcom(c);this.pop();break;case 4:this.st[a]=d-c;break;case 5:this.st[a]=c-d;break;case 6:this.st[a]=d/c;break;case 7:this.st[a]=c/d;break;default:dbg_assert(!1)}};
FPU.prototype.op_DC_mem=function(a,b){this.dbg_log_fpu_op(220,a);a=a>>3&7;b=this.load_m64(b);var c=this.get_st0();switch(a){case 0:this.st[this.stack_ptr]=c+b;break;case 1:this.st[this.stack_ptr]=c*b;break;case 2:this.fcom(b);break;case 3:this.fcom(b);this.pop();break;case 4:this.st[this.stack_ptr]=c-b;break;case 5:this.st[this.stack_ptr]=b-c;break;case 6:this.st[this.stack_ptr]=c/b;break;case 7:this.st[this.stack_ptr]=b/c;break;default:dbg_assert(!1)}};
FPU.prototype.op_DD_reg=function(a){this.dbg_log_fpu_op(221,a);var b=a>>3&7;a&=7;switch(b){case 0:this.stack_empty|=1<<(this.stack_ptr+a&7);break;case 2:this.st[this.stack_ptr+a&7]=this.get_st0();break;case 3:0!==a&&(this.st[this.stack_ptr+a&7]=this.get_st0());this.pop();break;case 4:this.fucom(this.get_sti(a));break;case 5:this.fucom(this.get_sti(a));this.pop();break;default:dbg_log(b),this.fpu_unimpl()}};
FPU.prototype.op_DD_mem=function(a,b){this.dbg_log_fpu_op(221,a);switch(a>>3&7){case 0:a=this.load_m64(b);this.push(a);break;case 1:this.fpu_unimpl();break;case 2:this.store_m64(b,0);break;case 3:this.store_m64(b,0);this.pop();break;case 4:this.frstor(b);break;case 5:this.fpu_unimpl();break;case 6:this.fsave(b);break;case 7:this.cpu.safe_write16(b,this.load_status_word());break;default:dbg_assert(!1)}};
FPU.prototype.op_DE_reg=function(a){this.dbg_log_fpu_op(222,a);var b=a>>3&7;a&=7;var c=this.stack_ptr+a&7,d=this.get_sti(a),e=this.get_st0();switch(b){case 0:this.st[c]=d+e;break;case 1:this.st[c]=d*e;break;case 2:this.fcom(d);break;case 3:1===a?(this.fcom(this.st[c]),this.pop()):(dbg_log(b),this.fpu_unimpl());break;case 4:this.st[c]=e-d;break;case 5:this.st[c]=d-e;break;case 6:this.st[c]=e/d;break;case 7:this.st[c]=d/e;break;default:dbg_assert(!1)}this.pop()};
FPU.prototype.op_DE_mem=function(a,b){this.dbg_log_fpu_op(222,a);a=a>>3&7;b=this.cpu.safe_read16(b)<<16>>16;var c=this.get_st0();switch(a){case 0:this.st[this.stack_ptr]=c+b;break;case 1:this.st[this.stack_ptr]=c*b;break;case 2:this.fcom(b);break;case 3:this.fcom(b);this.pop();break;case 4:this.st[this.stack_ptr]=c-b;break;case 5:this.st[this.stack_ptr]=b-c;break;case 6:this.st[this.stack_ptr]=c/b;break;case 7:this.st[this.stack_ptr]=b/c;break;default:dbg_assert(!1)}};
FPU.prototype.op_DF_reg=function(a){this.dbg_log_fpu_op(223,a);var b=a>>3&7,c=a&7;switch(b){case 4:224===a?this.cpu.reg16[reg_ax]=this.load_status_word():(dbg_log(a),this.fpu_unimpl());break;case 5:this.fucomi(this.get_sti(c));this.pop();break;case 6:this.fcomi(this.get_sti(c));this.pop();break;default:dbg_log(b),this.fpu_unimpl()}};
FPU.prototype.op_DF_mem=function(a,b){this.dbg_log_fpu_op(223,a);switch(a>>3&7){case 0:b=this.cpu.safe_read16(b)<<16>>16;this.push(b);break;case 1:this.fpu_unimpl();break;case 2:a=this.integer_round(this.get_st0());32767>=a&&-32768<=a?this.cpu.safe_write16(b,a):(this.invalid_arithmatic(),this.cpu.safe_write16(b,32768));break;case 3:a=this.integer_round(this.get_st0());32767>=a&&-32768<=a?this.cpu.safe_write16(b,a):(this.invalid_arithmatic(),this.cpu.safe_write16(b,32768));this.pop();break;case 4:this.fpu_unimpl();
break;case 5:a=this.cpu.safe_read32s(b)>>>0;b=this.cpu.safe_read32s(b+4);this.push(a+4294967296*b);break;case 6:this.fpu_unimpl();break;case 7:this.cpu.writable_or_pagefault(b,8);a=this.integer_round(this.get_st0());if(a<TWO_POW_63&&a>=-TWO_POW_63){var c=a|0;var d=a/4294967296|0;0===d&&0>a&&(d=-1)}else c=0,d=-2147483648,this.invalid_arithmatic();this.cpu.safe_write32(b,c);this.cpu.safe_write32(b+4,d);this.pop();break;default:dbg_assert(!1)}};function hex_dump(a,b){var c=[];b=b||a.byteLength;for(var d,e,f=0;f<b>>4;f++){d=h(f<<4,5)+"   ";for(var g=0;16>g;g++)e=a[(f<<4)+g],d+=h(e,2)+" ";d+="  ";for(g=0;16>g;g++)e=a[(f<<4)+g],d+=33>e||126<e?".":String.fromCharCode(e);c.push(d)}return"\n"+c.join("\n")}var CDROM_SECTOR_SIZE=2048,HD_SECTOR_SIZE=512;
function IDEDevice(a,b,c,d,e){this.master=new IDEInterface(this,a,b,c,d,0,e);this.slave=new IDEInterface(this,a,void 0,!1,d,1,e);this.current_interface=this.master;this.cpu=a;0===d?(this.ata_port=496,this.irq=14,this.pci_id=240):1===d?(this.ata_port=368,this.irq=15,this.pci_id=248):dbg_assert(!1,"IDE device with nr "+d+" ignored",LOG_DISK);this.ata_port_high=this.ata_port|516;this.master_port=46080;this.pci_space=[134,128,16,112,5,0,160,2,0,128,1,1,0,0,0,0,this.ata_port&255|1,this.ata_port>>8,0,0,
this.ata_port_high&255|1,this.ata_port_high>>8,0,0,0,0,0,0,0,0,0,0,this.master_port&255|1,this.master_port>>8,0,0,0,0,0,0,0,0,0,0,67,16,212,130,0,0,0,0,0,0,0,0,0,0,0,0,this.irq,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];this.pci_bars=[{size:8},{size:4},void 0,void 0,{size:16}];this.name="ide"+d;this.device_control=2;a.io.register_read(this.ata_port|
7,this,function(){dbg_log("lower irq",LOG_DISK);this.cpu.device_lower_irq(this.irq);return this.read_status()});a.io.register_read(this.ata_port_high|2,this,this.read_status);a.io.register_write(this.ata_port_high|2,this,this.write_control);a.io.register_read(this.ata_port|0,this,function(){return this.current_interface.read_data(1)},function(){return this.current_interface.read_data(2)},function(){return this.current_interface.read_data(4)});a.io.register_read(this.ata_port|1,this,function(){dbg_log("Read error: "+
h(this.current_interface.error&255)+" slave="+(this.current_interface===this.slave),LOG_DISK);return this.current_interface.error});a.io.register_read(this.ata_port|2,this,function(){dbg_log("Read bytecount: "+h(this.current_interface.bytecount&255),LOG_DISK);return this.current_interface.bytecount&255});a.io.register_read(this.ata_port|3,this,function(){dbg_log("Read sector: "+h(this.current_interface.sector&255),LOG_DISK);return this.current_interface.sector&255});a.io.register_read(this.ata_port|
4,this,function(){dbg_log("Read 1F4: "+h(this.current_interface.cylinder_low&255),LOG_DISK);return this.current_interface.cylinder_low&255});a.io.register_read(this.ata_port|5,this,function(){dbg_log("Read 1F5: "+h(this.current_interface.cylinder_high&255),LOG_DISK);return this.current_interface.cylinder_high&255});a.io.register_read(this.ata_port|6,this,function(){dbg_log("Read 1F6",LOG_DISK);return this.current_interface.drive_head});a.io.register_write(this.ata_port|0,this,function(a){this.current_interface.write_data_port8(a)},
function(a){this.current_interface.write_data_port16(a)},function(a){this.current_interface.write_data_port32(a)});a.io.register_write(this.ata_port|1,this,function(a){dbg_log("1F1/lba_count: "+h(a),LOG_DISK);this.master.lba_count=(this.master.lba_count<<8|a)&65535;this.slave.lba_count=(this.slave.lba_count<<8|a)&65535});a.io.register_write(this.ata_port|2,this,function(a){dbg_log("1F2/bytecount: "+h(a),LOG_DISK);this.master.bytecount=(this.master.bytecount<<8|a)&65535;this.slave.bytecount=(this.slave.bytecount<<
8|a)&65535});a.io.register_write(this.ata_port|3,this,function(a){dbg_log("1F3/sector: "+h(a),LOG_DISK);this.master.sector=(this.master.sector<<8|a)&65535;this.slave.sector=(this.slave.sector<<8|a)&65535});a.io.register_write(this.ata_port|4,this,function(a){dbg_log("1F4/sector low: "+h(a),LOG_DISK);this.master.cylinder_low=(this.master.cylinder_low<<8|a)&65535;this.slave.cylinder_low=(this.slave.cylinder_low<<8|a)&65535});a.io.register_write(this.ata_port|5,this,function(a){dbg_log("1F5/sector high: "+
h(a),LOG_DISK);this.master.cylinder_high=(this.master.cylinder_high<<8|a)&65535;this.slave.cylinder_high=(this.slave.cylinder_high<<8|a)&65535});a.io.register_write(this.ata_port|6,this,function(a){var b=a&16;dbg_log("1F6/drive: "+h(a,2),LOG_DISK);b?(dbg_log("Slave",LOG_DISK),this.current_interface=this.slave):this.current_interface=this.master;this.master.drive_head=a;this.slave.drive_head=a;this.master.is_lba=this.slave.is_lba=a>>6&1;this.master.head=this.slave.head=a&15});this.dma_command=this.dma_status=
this.prdt_addr=0;a.io.register_write(this.ata_port|7,this,function(a){dbg_log("lower irq",LOG_DISK);this.cpu.device_lower_irq(this.irq);this.current_interface.ata_command(a)});a.io.register_read(this.master_port|4,this,void 0,void 0,this.dma_read_addr);a.io.register_write(this.master_port|4,this,void 0,void 0,this.dma_set_addr);a.io.register_read(this.master_port,this,this.dma_read_command8,void 0,this.dma_read_command);a.io.register_write(this.master_port,this,this.dma_write_command8,void 0,this.dma_write_command);
a.io.register_read(this.master_port|2,this,this.dma_read_status);a.io.register_write(this.master_port|2,this,this.dma_write_status);a.io.register_read(this.master_port|8,this,function(){dbg_log("DMA read 0x8",LOG_DISK);return 0});a.io.register_read(this.master_port|10,this,function(){dbg_log("DMA read 0xA",LOG_DISK);return 0});a.devices.pci.register_device(this);DEBUG&&Object.seal(this)}
IDEDevice.prototype.read_status=function(){if(this.current_interface.buffer){var a=this.current_interface.status;dbg_log("ATA read status: "+h(a,2),LOG_DISK);return a}return 0};IDEDevice.prototype.write_control=function(a){dbg_log("set device control: "+h(a,2)+" interrupts "+(a&2?"disabled":"enabled"),LOG_DISK);a&4&&(dbg_log("Reset via control port",LOG_DISK),this.cpu.device_lower_irq(this.irq),this.master.device_reset(),this.slave.device_reset());this.device_control=a};
IDEDevice.prototype.dma_read_addr=function(){dbg_log("dma get address: "+h(this.prdt_addr,8),LOG_DISK);return this.prdt_addr};IDEDevice.prototype.dma_set_addr=function(a){dbg_log("dma set address: "+h(a,8),LOG_DISK);this.prdt_addr=a};IDEDevice.prototype.dma_read_status=function(){dbg_log("DMA read status: "+h(this.dma_status),LOG_DISK);return this.dma_status};IDEDevice.prototype.dma_write_status=function(a){dbg_log("DMA set status: "+h(a),LOG_DISK);this.dma_status&=~(a&6)};
IDEDevice.prototype.dma_read_command=function(){return this.dma_read_command8()|this.dma_read_status()<<16};IDEDevice.prototype.dma_read_command8=function(){dbg_log("DMA read command: "+h(this.dma_command),LOG_DISK);return this.dma_command};IDEDevice.prototype.dma_write_command=function(a){dbg_log("DMA write command: "+h(a),LOG_DISK);this.dma_write_command8(a&255);this.dma_write_status(a>>16&255)};
IDEDevice.prototype.dma_write_command8=function(a){dbg_log("DMA write command8: "+h(a),LOG_DISK);var b=this.dma_command;this.dma_command=a&9;if((b&1)!==(a&1))if(0===(a&1))this.dma_status&=-2;else switch(this.dma_status|=1,this.current_interface.current_command){case 37:case 200:this.current_interface.do_ata_read_sectors_dma();break;case 202:case 53:this.current_interface.do_ata_write_sectors_dma();break;case 160:this.current_interface.do_atapi_dma();break;default:dbg_log("Spurious dma command write, current command: "+
h(this.current_interface.current_command),LOG_DISK),dbg_assert(!1)}};IDEDevice.prototype.push_irq=function(){0===(this.device_control&2)&&(dbg_log("push irq",LOG_DISK),this.dma_status|=4,this.cpu.device_raise_irq(this.irq))};
IDEDevice.prototype.get_state=function(){var a=[];a[0]=this.master;a[1]=this.slave;a[2]=this.ata_port;a[3]=this.irq;a[4]=this.pci_id;a[5]=this.ata_port_high;a[6]=this.master_port;a[7]=this.name;a[8]=this.device_control;a[9]=this.prdt_addr;a[10]=this.dma_status;a[11]=this.current_interface===this.master;a[12]=this.dma_command;return a};
IDEDevice.prototype.set_state=function(a){this.master=a[0];this.slave=a[1];this.ata_port=a[2];this.irq=a[3];this.pci_id=a[4];this.ata_port_high=a[5];this.master_port=a[6];this.name=a[7];this.device_control=a[8];this.prdt_addr=a[9];this.dma_status=a[10];this.current_interface=a[11]?this.master:this.slave;this.dma_command=a[12]};
function IDEInterface(a,b,c,d,e,f,g){this.device=a;this.bus=g;this.nr=e;this.cpu=b;this.buffer=c;this.sector_size=d?CDROM_SECTOR_SIZE:HD_SECTOR_SIZE;this.is_atapi=d;this.cylinder_count=this.sectors_per_track=this.head_count=this.sector_count=0;this.buffer&&(this.sector_count=this.buffer.byteLength/this.sector_size,this.sector_count!==(this.sector_count|0)&&(dbg_log("Warning: Disk size not aligned with sector size",LOG_DISK),this.sector_count=Math.ceil(this.sector_count)),d?(this.head_count=1,this.sectors_per_track=
0):(this.head_count=16,this.sectors_per_track=63),this.cylinder_count=this.sector_count/this.head_count/this.sectors_per_track,this.cylinder_count!==(this.cylinder_count|0)&&(dbg_log("Warning: Rounding up cylinder count. Choose different head number",LOG_DISK),this.cylinder_count=Math.floor(this.cylinder_count)),a=b.devices.rtc,a.cmos_write(CMOS_BIOS_DISKTRANSFLAG,a.cmos_read(CMOS_BIOS_DISKTRANSFLAG)|1<<4*this.nr),a.cmos_write(CMOS_DISK_DATA,a.cmos_read(CMOS_DISK_DATA)&15|240),b=CMOS_DISK_DRIVE1_CYL,
a.cmos_write(b+0,this.cylinder_count&255),a.cmos_write(b+1,this.cylinder_count>>8&255),a.cmos_write(b+2,this.head_count&255),a.cmos_write(b+3,255),a.cmos_write(b+4,255),a.cmos_write(b+5,200),a.cmos_write(b+6,this.cylinder_count&255),a.cmos_write(b+7,this.cylinder_count>>8&255),a.cmos_write(b+8,this.sectors_per_track&255));this.stats={sectors_read:0,sectors_written:0,bytes_read:0,bytes_written:0,loading:!1};this.buffer=c;this.drive_head=this.head=this.cylinder_high=this.cylinder_low=this.lba_count=
this.sector=this.bytecount=this.is_lba=0;this.status=80;this.sectors_per_drq=128;this.data_pointer=this.error=0;this.data=new Uint8Array(65536);this.data16=new Uint16Array(this.data.buffer);this.data32=new Int32Array(this.data.buffer);this.data_end=this.data_length=0;this.current_atapi_command=this.current_command=-1;this.write_dest=0;Object.seal(this)}
IDEInterface.prototype.device_reset=function(){this.is_atapi?(this.status=0,this.sector=this.error=this.bytecount=1,this.cylinder_low=20,this.cylinder_high=235):(this.status=81,this.sector=this.error=this.bytecount=1,this.cylinder_high=this.cylinder_low=0)};IDEInterface.prototype.push_irq=function(){this.device.push_irq()};
IDEInterface.prototype.ata_command=function(a){dbg_log("ATA Command: "+h(a)+" slave="+(this.drive_head>>4&1),LOG_DISK);if(this.buffer)switch(this.current_command=a,this.error=0,a){case 8:dbg_log("ATA device reset",LOG_DISK);this.data_length=this.data_end=this.data_pointer=0;this.device_reset();this.push_irq();break;case 16:this.status=80;this.cylinder_low=0;this.push_irq();break;case 248:this.status=80;a=this.sector_count-1;this.sector=a&255;this.cylinder_low=a>>8&255;this.cylinder_high=a>>16&255;
this.drive_head=this.drive_head&240|a>>24&15;this.push_irq();break;case 39:this.status=80;a=this.sector_count-1;this.sector=a&255;this.cylinder_low=a>>8&255;this.cylinder_high=a>>16&255;this.sector|=a>>24<<8&65280;this.push_irq();break;case 32:case 36:case 41:case 196:this.ata_read_sectors(a);break;case 48:case 52:case 57:case 197:this.ata_write_sectors(a);break;case 144:this.push_irq();this.error=257;this.status=80;break;case 145:this.status=80;this.push_irq();break;case 160:this.is_atapi&&(this.status=
88,this.data_allocate(12),this.data_end=12,this.bytecount=1,this.push_irq());break;case 161:dbg_log("ATA identify packet device",LOG_DISK);this.is_atapi?(this.create_identify_packet(),this.status=88,this.cylinder_low=20,this.cylinder_high=235):this.status=65;this.push_irq();break;case 198:dbg_log("Logical sectors per DRQ Block: "+h(this.bytecount&255),LOG_DISK);this.sectors_per_drq=this.bytecount&255;this.status=80;this.push_irq();break;case 37:case 200:this.ata_read_sectors_dma(a);break;case 53:case 202:this.ata_write_sectors_dma(a);
break;case 64:dbg_log("read verify sectors",LOG_DISK);this.status=80;this.push_irq();break;case 218:dbg_log("Unimplemented: get media status",LOG_DISK);this.status=65;this.error=4;this.push_irq();break;case 224:dbg_log("ATA standby immediate",LOG_DISK);this.status=80;this.push_irq();break;case 225:dbg_log("ATA idle immediate",LOG_DISK);this.status=80;this.push_irq();break;case 231:dbg_log("ATA flush cache",LOG_DISK);this.status=80;this.push_irq();break;case 236:dbg_log("ATA identify device",LOG_DISK);
if(this.is_atapi){this.status=65;this.error=4;this.push_irq();break}this.create_identify_packet();this.status=88;this.push_irq();break;case 234:dbg_log("flush cache ext",LOG_DISK);this.status=80;this.push_irq();break;case 239:dbg_log("set features: "+h(this.bytecount&255),LOG_DISK);this.status=80;this.push_irq();break;case 245:dbg_log("security freeze lock",LOG_DISK);this.status=80;this.push_irq();break;case 249:dbg_log("Unimplemented: set max address",LOG_DISK);this.status=65;this.error=4;break;
default:dbg_assert(!1,"New ATA cmd on 1F7: "+h(a),LOG_DISK),this.status=65,this.error=4}else dbg_log("abort: No buffer",LOG_DISK),this.error=4,this.status=65,this.push_irq()};
IDEInterface.prototype.atapi_handle=function(){dbg_log("ATAPI Command: "+h(this.data[0])+" slave="+(this.drive_head>>4&1),LOG_DISK);this.data_pointer=0;this.current_atapi_command=this.data[0];switch(this.current_atapi_command){case 0:dbg_log("test unit ready",LOG_DISK);this.data_allocate(0);this.data_end=this.data_length;this.status=80;break;case 3:this.data_allocate(this.data[4]);this.data_end=this.data_length;this.status=88;this.data[0]=240;this.data[2]=5;this.data[7]=8;break;case 18:var a=this.data[4];
this.status=88;dbg_log("inquiry: "+h(this.data[1],2)+" length="+a,LOG_DISK);this.data.set([5,128,1,49,31,0,0,0,83,79,78,89,32,32,32,32,67,68,45,82,79,77,32,67,68,85,45,49,48,48,48,32,49,46,49,97]);this.data_end=this.data_length=Math.min(36,a);break;case 26:this.data_allocate(this.data[4]);this.data_end=this.data_length;this.status=88;break;case 30:this.data_allocate(0);this.data_end=this.data_length;this.status=80;break;case 37:a=this.sector_count-1;this.data_set(new Uint8Array([a>>24&255,a>>16&255,
a>>8&255,a&255,0,0,this.sector_size>>8&255,this.sector_size&255]));this.data_end=this.data_length;this.status=88;break;case 40:this.lba_count&1?this.atapi_read_dma(this.data):this.atapi_read(this.data);break;case 66:a=this.data[8];this.data_allocate(Math.min(8,a));this.data_end=this.data_length;dbg_log("read q subcode: length="+a,LOG_DISK);this.status=88;break;case 67:a=this.data[8]|this.data[7]<<8;var b=this.data[9]>>6;this.data_allocate(a);this.data_end=this.data_length;dbg_log("read toc: "+h(b,
2)+" length="+a+" "+(this.data[1]&2)+" "+h(this.data[6]),LOG_DISK);0===b?(a=this.sector_count,this.data.set(new Uint8Array([0,18,1,1,0,20,1,0,0,0,0,0,0,22,170,0,a>>24,a>>16&255,a>>8&255,a&255]))):1===b?this.data.set(new Uint8Array([0,10,1,1,0,0,0,0,0,0,0,0])):dbg_assert(!1,"Unimplemented format: "+b);this.status=88;break;case 70:a=this.data[8]|this.data[7]<<8;a=Math.min(a,32);this.data_allocate(a);this.data_end=this.data_length;this.data[0]=a-4>>24&255;this.data[1]=a-4>>16&255;this.data[2]=a-4>>8&
255;this.data[3]=a-4&255;this.data[6]=8;this.data[10]=3;this.status=88;break;case 81:this.data_allocate(0);this.data_end=this.data_length;this.status=80;break;case 82:dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK);this.status=81;this.data_length=0;this.error=80;break;case 90:a=this.data[8]|this.data[7]<<8;b=this.data[2];dbg_log("mode sense: "+h(b)+" length="+a,LOG_DISK);42===b&&this.data_allocate(Math.min(30,a));this.data_end=this.data_length;this.status=88;break;case 189:this.data_allocate(this.data[9]|
this.data[8]<<8);this.data_end=this.data_length;this.data[5]=1;this.status=88;break;case 74:this.status=81;this.data_length=0;this.error=80;dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK);break;default:this.status=81,this.data_length=0,this.error=80,dbg_log("Unimplemented ATAPI command: "+h(this.data[0]),LOG_DISK),dbg_assert(!1)}this.bytecount=this.bytecount&-8|2;0===(this.status&128)&&this.push_irq();0===(this.status&128)&&0===this.data_length&&(this.bytecount|=1,this.status&=-9)};
IDEInterface.prototype.do_write=function(){this.status=80;dbg_assert(this.data_length<=this.data.length);var a=this.data.subarray(0,this.data_length);dbg_assert(0===this.data_length%512);this.ata_advance(this.current_command,this.data_length/512);this.push_irq();this.buffer.set(this.write_dest,a,function(){});this.report_write(this.data_length)};
IDEInterface.prototype.atapi_read=function(a){var b=this,c=a[2]<<24|a[3]<<16|a[4]<<8|a[5],d=a[7]<<8|a[8];a=a[1];var e=d*this.sector_size,f=c*this.sector_size;dbg_log("CD read lba="+h(c)+" lbacount="+h(d)+" bytecount="+h(e)+" flags="+h(a),LOG_DISK);this.data_length=0;var g=this.cylinder_high<<8&65280|this.cylinder_low&255;dbg_log(h(this.cylinder_high,2)+" "+h(this.cylinder_low,2),LOG_DISK);this.cylinder_low=this.cylinder_high=0;65535===g&&g--;g>e&&(g=e);f>=this.buffer.byteLength?(dbg_assert(!1,"CD read: Outside of disk  end="+
h(f+e)+" size="+h(this.buffer.byteLength),LOG_DISK),this.status=255,this.push_irq()):0===e?(this.status=80,this.data_pointer=0):(e=Math.min(e,this.buffer.byteLength-f),this.status=208,this.report_read_start(),this.buffer.get(f,e,function(a){dbg_log("cd read: data arrived",LOG_DISK);b.data_set(a);b.status=88;b.bytecount=b.bytecount&-8|2;b.push_irq();g&=-4;b.data_end=g;b.data_end>b.data_length&&(b.data_end=b.data_length);b.cylinder_low=b.data_end&255;b.cylinder_high=b.data_end>>8&255;b.report_read_end(e)}))};
IDEInterface.prototype.atapi_read_dma=function(a){var b=this,c=a[2]<<24|a[3]<<16|a[4]<<8|a[5],d=a[7]<<8|a[8];a=a[1];var e=d*this.sector_size,f=c*this.sector_size;dbg_log("CD read DMA lba="+h(c)+" lbacount="+h(d)+" bytecount="+h(e)+" flags="+h(a),LOG_DISK);f>=this.buffer.byteLength?(dbg_assert(!1,"CD read: Outside of disk  end="+h(f+e)+" size="+h(this.buffer.byteLength),LOG_DISK),this.status=255,this.push_irq()):(this.status=208,this.report_read_start(),this.buffer.get(f,e,function(a){dbg_log("atapi_read_dma: Data arrived");
b.report_read_end(e);b.status=88;b.bytecount=b.bytecount&-8|2;b.data_set(a);b.do_atapi_dma()}))};
IDEInterface.prototype.do_atapi_dma=function(){if(0===(this.device.dma_status&1))dbg_log("do_atapi_dma: Status not set",LOG_DISK);else if(0===(this.status&8))dbg_log("do_atapi_dma: DRQ not set",LOG_DISK);else{dbg_log("atapi dma transfer len="+this.data_length,LOG_DISK);var a=this.device.prdt_addr,b=0,c=this.data;do{var d=this.cpu.read32s(a),e=this.cpu.read16(a+4),f=this.cpu.read8(a+7)&128;e||(e=65536);dbg_log("dma read dest="+h(d)+" count="+h(e)+" datalen="+h(this.data_length),LOG_DISK);this.cpu.write_blob(c.subarray(b,
Math.min(b+e,this.data_length)),d);b+=e;a+=8;if(b>=this.data_length&&!f){dbg_log("leave early end="+ +f+" offset="+h(b)+" data_length="+h(this.data_length)+" cmd="+h(this.current_command),LOG_DISK);break}}while(!f);dbg_log("end offset="+b,LOG_DISK);this.status=80;this.device.dma_status&=-2;this.bytecount=this.bytecount&-8|3;this.push_irq()}};
IDEInterface.prototype.read_data=function(a){if(this.data_pointer<this.data_end){dbg_assert(this.data_pointer+a-1<this.data_end);dbg_assert(0===this.data_pointer%a,h(this.data_pointer)+" "+a);var b=1===a?this.data[this.data_pointer]:2===a?this.data16[this.data_pointer>>>1]:this.data32[this.data_pointer>>>2];this.data_pointer+=a;0===(this.data_pointer&(0===(this.data_end&4095)?4095:255))&&dbg_log("Read 1F0: "+h(this.data[this.data_pointer],2)+" cur="+h(this.data_pointer)+" cnt="+h(this.data_length),
LOG_DISK);this.data_pointer>=this.data_end&&this.read_end();return b}dbg_log("Read 1F0: empty",LOG_DISK);this.data_pointer+=a;return 0};
IDEInterface.prototype.read_end=function(){dbg_log("read_end cmd="+h(this.current_command)+" data_pointer="+h(this.data_pointer)+" end="+h(this.data_end)+" length="+h(this.data_length),LOG_DISK);if(160===this.current_command)if(this.data_end===this.data_length)this.status=80,this.bytecount=this.bytecount&-8|3,this.push_irq();else{this.status=88;this.bytecount=this.bytecount&-8|2;this.push_irq();var a=this.cylinder_high<<8&65280|this.cylinder_low&255;this.data_end+a>this.data_length?(this.cylinder_low=
this.data_length-this.data_end&255,this.cylinder_high=this.data_length-this.data_end>>8&255,this.data_end=this.data_length):this.data_end+=a;dbg_log("data_end="+h(this.data_end),LOG_DISK)}else this.error=0,this.data_pointer>=this.data_length?this.status=80:(196===this.current_command||41===this.current_command?(a=Math.min(this.sectors_per_drq,(this.data_length-this.data_end)/512),dbg_assert(0===a%1)):(dbg_assert(32===this.current_command||36===this.current_command),a=1),this.ata_advance(this.current_command,
a),this.data_end+=512*a,this.status=88),this.push_irq()};
IDEInterface.prototype.write_data_port=function(a,b){dbg_assert(0===this.data_pointer%b);this.data_pointer>=this.data_end?dbg_log("Redundant write to data port: "+h(a)+" count="+h(this.data_end)+" cur="+h(this.data_pointer),LOG_DISK):((0===(this.data_pointer+b&(0===(this.data_end&4095)?4095:255))||20>this.data_end)&&dbg_log("Data port: "+h(a>>>0)+" count="+h(this.data_end)+" cur="+h(this.data_pointer),LOG_DISK),1===b?this.data[this.data_pointer++]=a:2===b?(this.data16[this.data_pointer>>>1]=a,this.data_pointer+=
2):(this.data32[this.data_pointer>>>2]=a,this.data_pointer+=4),dbg_assert(this.data_pointer<=this.data_end),this.data_pointer===this.data_end&&this.write_end())};IDEInterface.prototype.write_data_port8=function(a){this.write_data_port(a,1)};IDEInterface.prototype.write_data_port16=function(a){this.write_data_port(a,2)};IDEInterface.prototype.write_data_port32=function(a){this.write_data_port(a,4)};
IDEInterface.prototype.write_end=function(){160===this.current_command?this.atapi_handle():(dbg_log("write_end data_pointer="+h(this.data_pointer)+" data_length="+h(this.data_length),LOG_DISK),this.data_pointer>=this.data_length?this.do_write():(dbg_assert(48===this.current_command||52===this.current_command),this.status=88,this.data_end+=512,this.push_irq()))};
IDEInterface.prototype.ata_advance=function(a,b){dbg_log("Advance sectors="+b+" old_bytecount="+this.bytecount,LOG_DISK);this.bytecount-=b;36===a||41===a||52===a||57===a||37===a||53===a?(a=b+this.get_lba48(),this.sector=a&255|a>>16&65280,this.cylinder_low=a>>8&255,this.cylinder_high=a>>16&255):this.is_lba?(a=b+this.get_lba28(),this.sector=a&255,this.cylinder_low=a>>8&255,this.cylinder_high=a>>16&255,this.head=this.head&-16|a&15):(a=b+this.get_chs(),b=a/(this.head_count*this.sectors_per_track)|0,this.cylinder_low=
b&255,this.cylinder_high=b>>8&255,this.head=(a/this.sectors_per_track|0)%this.head_count&15,this.sector=a%this.sectors_per_track+1&255,dbg_assert(a===this.get_chs()))};
IDEInterface.prototype.ata_read_sectors=function(a){var b=this,c=36===a||41===a,d=this.get_count(c);c=this.get_lba(c);var e=32===a||36===a,f=d*this.sector_size,g=c*this.sector_size;dbg_log("ATA read cmd="+h(a)+" mode="+(this.is_lba?"lba":"chs")+" lba="+h(c)+" lbacount="+h(d)+" bytecount="+h(f),LOG_DISK);g+f>this.buffer.byteLength?(dbg_assert(!1,"ATA read: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=192,this.report_read_start(),this.buffer.get(g,f,function(c){dbg_log("ata_read: Data arrived",
LOG_DISK);b.data_set(c);b.status=88;b.data_end=e?512:Math.min(f,512*b.sectors_per_drq);b.ata_advance(a,e?1:Math.min(d,b.sectors_per_track));b.push_irq();b.report_read_end(f)}))};
IDEInterface.prototype.ata_read_sectors_dma=function(a){var b=37===a;a=this.get_count(b);b=this.get_lba(b);var c=a*this.sector_size,d=b*this.sector_size;dbg_log("ATA DMA read lba="+h(b)+" lbacount="+h(a)+" bytecount="+h(c),LOG_DISK);d+c>this.buffer.byteLength?(dbg_assert(!1,"ATA read: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)};
IDEInterface.prototype.do_ata_read_sectors_dma=function(){var a=this,b=37===this.current_command,c=this.get_count(b);b=this.get_lba(b);var d=c*this.sector_size,e=b*this.sector_size;dbg_assert(b<this.buffer.byteLength);this.report_read_start();var f=this.device.prdt_addr;this.buffer.get(e,d,function(b){dbg_log("do_ata_read_sectors_dma: Data arrived",LOG_DISK);var e=a.device.prdt_addr,g=0;dbg_assert(f===e);do{var m=a.cpu.read32s(e),p=a.cpu.read16(e+4),n=a.cpu.read8(e+7)&128;p||(p=65536,dbg_log("dma: prd count was 0",
LOG_DISK));dbg_log("dma read transfer dest="+h(m)+" prd_count="+h(p),LOG_DISK);a.cpu.write_blob(b.subarray(g,g+p),m);g+=p;e+=8}while(!n);dbg_assert(g===d);a.ata_advance(a.current_command,c);a.status=80;a.device.dma_status&=-2;a.current_command=-1;a.push_irq();a.report_read_end(d)})};
IDEInterface.prototype.ata_write_sectors=function(a){var b=52===a||57===a,c=this.get_count(b);b=this.get_lba(b);a=48===a||52===a;var d=c*this.sector_size,e=b*this.sector_size;dbg_log("ATA write lba="+h(b)+" mode="+(this.is_lba?"lba":"chs")+" lbacount="+h(c)+" bytecount="+h(d),LOG_DISK);e+d>this.buffer.byteLength?(dbg_assert(!1,"ATA write: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.data_allocate_noclear(d),this.data_end=a?512:Math.min(d,512*this.sectors_per_drq),
this.write_dest=e)};IDEInterface.prototype.ata_write_sectors_dma=function(a){var b=53===a;a=this.get_count(b);b=this.get_lba(b);var c=a*this.sector_size,d=b*this.sector_size;dbg_log("ATA DMA write lba="+h(b)+" lbacount="+h(a)+" bytecount="+h(c),LOG_DISK);d+c>this.buffer.byteLength?(dbg_assert(!1,"ATA DMA write: Outside of disk",LOG_DISK),this.status=255,this.push_irq()):(this.status=88,this.device.dma_status|=1)};
IDEInterface.prototype.do_ata_write_sectors_dma=function(){var a=53===this.current_command,b=this.get_count(a),c=this.get_lba(a);a=b*this.sector_size;c*=this.sector_size;var d=this.device.prdt_addr,e=0,f=0,g=0;dbg_log("prdt addr: "+h(d,8),LOG_DISK);do{var k=this.cpu.read32s(d),l=this.cpu.read16(d+4),m=this.cpu.read8(d+7)&128;l||(l=65536,dbg_log("dma: prd count was 0",LOG_DISK));dbg_log("dma write transfer dest="+h(k)+" prd_count="+h(l),LOG_DISK);k=this.cpu.mem8.subarray(k,k+l);dbg_assert(k.length===
l);this.buffer.set(c+g,k,function(){f++});g+=l;d+=8;e++}while(!m);f===e?(dbg_log("dma write completed",LOG_DISK),this.ata_advance(this.current_command,b),this.status=80,this.push_irq(),this.device.dma_status&=-2,this.current_command=-1):dbg_assert(!1,"dma write not completed",LOG_DISK);this.report_write(a)};
IDEInterface.prototype.get_chs=function(){var a=this.cylinder_low&255|this.cylinder_high<<8&65280,b=this.head,c=this.sector&255;dbg_log("get_chs: c="+a+" h="+b+" s="+c,LOG_DISK);return(a*this.head_count+b)*this.sectors_per_track+c-1};IDEInterface.prototype.get_lba28=function(){return this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|(this.head&15)<<24};
IDEInterface.prototype.get_lba48=function(){return(this.sector&255|this.cylinder_low<<8&65280|this.cylinder_high<<16&16711680|this.sector>>8<<24&4278190080)>>>0};IDEInterface.prototype.get_lba=function(a){return a?this.get_lba48():this.is_lba?this.get_lba28():this.get_chs()};IDEInterface.prototype.get_count=function(a){a?(a=this.bytecount,0===a&&(a=65536)):(a=this.bytecount&255,0===a&&(a=256));return a};
IDEInterface.prototype.create_identify_packet=function(){if(this.drive_head&16)this.data_allocate(0);else{for(var a=0;512>a;a++)this.data[a]=0;a=Math.min(16383,this.cylinder_count);this.data_set([64,this.is_atapi?133:0,a,a>>8,0,0,this.head_count,this.head_count>>8,this.sectors_per_track/512,this.sectors_per_track/512>>8,0,2,this.sectors_per_track,this.sectors_per_track>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,2,4,0,0,0,0,0,0,0,0,0,56,118,32,54,68,72,32,32,32,32,32,32,32,32,32,
32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,128,0,1,0,0,2,0,0,0,2,0,2,7,0,a,a>>8,this.head_count,this.head_count>>8,this.sectors_per_track,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255,0,0,160===this.current_command?0:7,160===this.current_command?0:4,0,0,30,0,30,0,30,0,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,126,0,0,0,0,0,0,116,0,64,0,64,0,116,0,64,0,0,0,0,0,0,0,0,0,0,1,96,0,0,0,0,0,0,0,0,0,0,0,0,this.sector_count&255,this.sector_count>>8&255,this.sector_count>>16&255,this.sector_count>>24&255]);this.data_end=this.data_length=512}};IDEInterface.prototype.data_allocate=function(a){this.data_allocate_noclear(a);for(var b=0;b<a+3>>2;b++)this.data32[b]=0};
IDEInterface.prototype.data_allocate_noclear=function(a){this.data.length<a&&(this.data=new Uint8Array(a+3&-4),this.data16=new Uint16Array(this.data.buffer),this.data32=new Int32Array(this.data.buffer));this.data_length=a;this.data_pointer=0};IDEInterface.prototype.data_set=function(a){this.data_allocate_noclear(a.length);this.data.set(a)};IDEInterface.prototype.report_read_start=function(){this.stats.loading=!0;this.bus.send("ide-read-start")};
IDEInterface.prototype.report_read_end=function(a){this.stats.loading=!1;var b=a/this.sector_size|0;this.stats.sectors_read+=b;this.stats.bytes_read+=a;this.bus.send("ide-read-end",[this.nr,a,b])};IDEInterface.prototype.report_write=function(a){var b=a/this.sector_size|0;this.stats.sectors_written+=b;this.stats.bytes_written+=a;this.bus.send("ide-write-end",[this.nr,a,b])};
IDEInterface.prototype.get_state=function(){var a=[];a[0]=this.bytecount;a[1]=this.cylinder_count;a[2]=this.cylinder_high;a[3]=this.cylinder_low;a[4]=this.data_pointer;a[5]=0;a[6]=0;a[7]=0;a[8]=0;a[9]=this.drive_head;a[10]=this.error;a[11]=this.head;a[12]=this.head_count;a[13]=this.is_atapi;a[14]=this.is_lba;a[15]=this.lba_count;a[16]=this.data;a[17]=this.data_length;a[18]=this.sector;a[19]=this.sector_count;a[20]=this.sector_size;a[21]=this.sectors_per_drq;a[22]=this.sectors_per_track;a[23]=this.status;
a[24]=this.write_dest;a[25]=this.current_command;a[26]=this.data_end;a[27]=this.current_atapi_command;return a};
IDEInterface.prototype.set_state=function(a){this.bytecount=a[0];this.cylinder_count=a[1];this.cylinder_high=a[2];this.cylinder_low=a[3];this.data_pointer=a[4];this.drive_head=a[9];this.error=a[10];this.head=a[11];this.head_count=a[12];this.is_atapi=a[13];this.is_lba=a[14];this.lba_count=a[15];this.data=a[16];this.data_length=a[17];this.sector=a[18];this.sector_count=a[19];this.sector_size=a[20];this.sectors_per_drq=a[21];this.sectors_per_track=a[22];this.status=a[23];this.write_dest=a[24];this.current_command=
a[25];this.data_end=a[26];this.current_atapi_command=a[27];this.data16=new Uint16Array(this.data.buffer);this.data32=new Int32Array(this.data.buffer)};var PCI_CONFIG_ADDRESS=3320,PCI_CONFIG_DATA=3324;
function PCI(a){this.pci_addr=new Uint8Array(4);this.pci_value=new Uint8Array(4);this.pci_response=new Uint8Array(4);this.pci_status=new Uint8Array(4);this.pci_addr32=new Int32Array(this.pci_addr.buffer);this.pci_value32=new Int32Array(this.pci_value.buffer);this.pci_response32=new Int32Array(this.pci_response.buffer);this.pci_status32=new Int32Array(this.pci_status.buffer);this.device_spaces=[];this.devices=[];this.cpu=a;for(var b=0;256>b;b++)this.device_spaces[b]=void 0,this.devices[b]=void 0;this.io=
a.io;a.io.register_write(PCI_CONFIG_DATA,this,function(a){this.pci_write8(this.pci_addr32[0],a)},function(a){this.pci_write16(this.pci_addr32[0],a)},function(a){this.pci_write32(this.pci_addr32[0],a)});a.io.register_write(PCI_CONFIG_DATA+1,this,function(a){this.pci_write8(this.pci_addr32[0]+1|0,a)});a.io.register_write(PCI_CONFIG_DATA+2,this,function(a){this.pci_write8(this.pci_addr32[0]+2|0,a)},function(a){this.pci_write16(this.pci_addr32[0]+2|0,a)});a.io.register_write(PCI_CONFIG_DATA+3,this,function(a){this.pci_write8(this.pci_addr32[0]+
3|0,a)});a.io.register_read_consecutive(PCI_CONFIG_DATA,this,function(){return this.pci_response[0]},function(){return this.pci_response[1]},function(){return this.pci_response[2]},function(){return this.pci_response[3]});a.io.register_read_consecutive(PCI_CONFIG_ADDRESS,this,function(){return this.pci_status[0]},function(){return this.pci_status[1]},function(){return this.pci_status[2]},function(){return this.pci_status[3]});a.io.register_write_consecutive(PCI_CONFIG_ADDRESS,this,function(a){this.pci_addr[0]=
a&252},function(a){this.pci_addr[1]=a},function(a){this.pci_addr[2]=a},function(a){this.pci_addr[3]=a;this.pci_query()});this.register_device({pci_id:0,pci_space:[134,128,55,18,0,0,0,0,2,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pci_bars:[],name:"82441FX PMC"});this.isa_bridge={pci_id:8,pci_space:[134,128,0,112,7,0,0,2,0,0,1,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0],pci_bars:[],name:"82371SB PIIX3 ISA"};this.isa_bridge_space=this.register_device(this.isa_bridge);this.isa_bridge_space8=new Uint8Array(this.isa_bridge_space.buffer)}PCI.prototype.get_state=function(){for(var a=[],b=0;256>b;b++)a[b]=this.device_spaces[b];a[256]=this.pci_addr;a[257]=this.pci_value;a[258]=this.pci_response;a[259]=this.pci_status;return a};
PCI.prototype.set_state=function(a){for(var b=0;256>b;b++){var c=this.devices[b],d=a[b];if(c&&d){for(var e=0;e<c.pci_bars.length;e++){var f=d[4+e];if(f&1){var g=c.pci_bars[e];this.set_io_bars(g,g.original_bar&65534,f&65534)}}this.device_spaces[b].set(d)}else c&&dbg_log("Warning: While restoring PCI device: Device exists in current configuration but not in snapshot ("+c.name+")"),d&&dbg_log("Warning: While restoring PCI device: Device doesn't exist in current configuration but does in snapshot (device "+
h(b,2)+")")}this.pci_addr.set(a[256]);this.pci_value.set(a[257]);this.pci_response.set(a[258]);this.pci_status.set(a[259])};
PCI.prototype.pci_query=function(){var a=this.pci_addr[2]<<8|this.pci_addr[1],b=this.pci_addr[0]&252,c=a>>3&31;var d="query enabled="+(this.pci_addr[3]>>7)+(" bdf="+h(a,4));d+=" dev="+h(c,2);d+=" addr="+h(b,2);c=this.device_spaces[a];void 0!==c?(this.pci_status32[0]=-2147483648,this.pci_response32[0]=b<c.byteLength?c[b>>2]:0,d+=" "+h(this.pci_addr32[0]>>>0,8)+" -> "+h(this.pci_response32[0]>>>0,8),b>=c.byteLength&&(d+=" (undef)"),d+=" ("+this.devices[a].name+")",dbg_log(d,LOG_PCI)):(this.pci_response32[0]=
-1,this.pci_status32[0]=0)};PCI.prototype.pci_write8=function(a,b){var c=a>>8&65535;a&=255;var d=new Uint8Array(this.device_spaces[c].buffer),e=this.devices[c];d&&(dbg_assert(!(16<=a&&44>a||48<=a&&52>a),"PCI: Expected 32-bit write"),dbg_log("PCI write8 dev="+h(c>>3,2)+" ("+e.name+") addr="+h(a,4)+" value="+h(b,2),LOG_PCI),d[a]=b)};
PCI.prototype.pci_write16=function(a,b){dbg_assert(0===(a&1));var c=a>>8&65535;a&=255;var d=new Uint16Array(this.device_spaces[c].buffer),e=this.devices[c];d&&(dbg_assert(!(16<=a&&44>a||48<=a&&52>a),"PCI: Expected 32-bit write"),dbg_log("PCI writ16 dev="+h(c>>3,2)+" ("+e.name+") addr="+h(a,4)+" value="+h(b,4),LOG_PCI),d[a>>>1]=b)};
PCI.prototype.pci_write32=function(a,b){dbg_assert(0===(a&3));var c=a>>8&65535;a&=255;var d=this.device_spaces[c],e=this.devices[c];if(d)if(16<=a&&40>a){var f=a-16>>2,g=e.pci_bars[f];dbg_log("BAR"+f+" exists="+(g?"y":"n")+" changed to "+h(b>>>0)+" dev="+h(c>>3,2)+" ("+e.name+") ",LOG_PCI);g?(dbg_assert(!(g.size&g.size-1),"bar size should be power of 2"),c=a>>2,e=d[c]&1,-1===(b|3|g.size-1)?(b=~(g.size-1)|e,0===e&&(d[c]=b)):0===e&&(f=g.original_bar,(b&-16)!==(f&-16)&&dbg_log("Warning: Changing memory bar not supported, ignored",
LOG_PCI),d[c]=f),1===e&&(dbg_assert(1===e),e=d[c]&65534,f=b&65534,dbg_log("io bar changed from "+h(e>>>0,8)+" to "+h(f>>>0,8)+" size="+g.size,LOG_PCI),this.set_io_bars(g,e,f),d[c]=b|1)):d[a>>2]=0;dbg_log("BAR effective value: "+h(d[a>>2]>>>0),LOG_PCI)}else 48===a?(dbg_log("PCI write rom address dev="+h(c>>3,2)+" ("+e.name+") value="+h(b>>>0,8),LOG_PCI),d[a>>2]=e.pci_rom_size?-1===(b|2047)?-e.pci_rom_size|0:e.pci_rom_address|0:0):(dbg_log("PCI write dev="+h(c>>3,2)+" ("+e.name+") addr="+h(a,4)+" value="+
h(b>>>0,8),LOG_PCI),d[a>>>2]=b)};
PCI.prototype.register_device=function(a){dbg_assert(void 0!==a.pci_id);dbg_assert(void 0!==a.pci_space);dbg_assert(void 0!==a.pci_bars);var b=a.pci_id;dbg_log("PCI register bdf="+h(b)+" ("+a.name+")",LOG_PCI);dbg_assert(!this.devices[b]);dbg_assert(64<=a.pci_space.length);dbg_assert(b<this.devices.length);var c=new Int32Array(64);c.set(new Int32Array((new Uint8Array(a.pci_space)).buffer));this.device_spaces[b]=c;this.devices[b]=a;b=c.slice(4,10);for(var d=0;d<a.pci_bars.length;d++){var e=a.pci_bars[d];
if(e){var f=b[d],g=f&1;e.original_bar=f;e.entries=[];if(0!==g)for(dbg_assert(1===g),f&=-2,g=0;g<e.size;g++)e.entries[g]=this.io.ports[f+g]}}return c};
PCI.prototype.set_io_bars=function(a,b,c){var d=a.size;dbg_log("Move io bars: from="+h(b)+" to="+h(c)+" count="+d,LOG_PCI);for(var e=this.io.ports,f=0;f<d;f++){var g=e[b+f];e[b+f]=this.io.create_empty_entry();g.read8===this.io.empty_port_read8&&g.read16===this.io.empty_port_read16&&g.read32===this.io.empty_port_read32&&g.write8===this.io.empty_port_write&&g.write16===this.io.empty_port_write&&g.write32===this.io.empty_port_write&&dbg_log("Move IO bar: Source not mapped, port="+h(b+f,4),LOG_PCI);g=
a.entries[f];var k=e[c+f];dbg_assert(g&&k);e[c+f]=g;dbg_assert(k.read8===this.io.empty_port_read8,"Bad IO bar: Target already mapped");dbg_assert(k.read16===this.io.empty_port_read16,"Bad IO bar: Target already mapped");dbg_assert(k.read32===this.io.empty_port_read32,"Bad IO bar: Target already mapped");dbg_assert(k.write8===this.io.empty_port_write,"Bad IO bar: Target already mapped");dbg_assert(k.write16===this.io.empty_port_write,"Bad IO bar: Target already mapped");dbg_assert(k.write32===this.io.empty_port_write,
"Bad IO bar: Target already mapped")}};PCI.prototype.raise_irq=function(a){var b=this.device_spaces[a];dbg_assert(b);this.cpu.device_raise_irq(this.isa_bridge_space8[96+((b[15]>>8&255)-1+((a>>3)-1&255)&3)])};PCI.prototype.lower_irq=function(a){var b=this.device_spaces[a];dbg_assert(b);this.cpu.device_lower_irq(this.isa_bridge_space8[96+((b[15]>>8&255)+(a>>3&255)-2&3)])};function FloppyController(a,b,c){this.io=a.io;this.cpu=a;this.dma=a.devices.dma;this.bytes_expecting=0;this.receiving_command=new Uint8Array(10);this.receiving_index=0;this.next_command=null;this.response_data=new Uint8Array(10);this.floppy_size=this.response_length=this.response_index=0;this.fda_image=b;this.fdb_image=c;this.last_head=this.last_cylinder=this.drive=this.status_reg2=this.status_reg1=this.status_reg0=0;this.last_sector=1;this.dor=0;if(b){this.floppy_size=b.byteLength;if((c={160:{type:1,
tracks:40,sectors:8,heads:1},180:{type:1,tracks:40,sectors:9,heads:1},200:{type:1,tracks:40,sectors:10,heads:1},320:{type:1,tracks:40,sectors:8,heads:2},360:{type:1,tracks:40,sectors:9,heads:2},400:{type:1,tracks:40,sectors:10,heads:2},720:{type:3,tracks:80,sectors:9,heads:2},1200:{type:2,tracks:80,sectors:15,heads:2},1440:{type:4,tracks:80,sectors:18,heads:2},1722:{type:5,tracks:82,sectors:21,heads:2},2880:{type:5,tracks:80,sectors:36,heads:2}}[this.floppy_size>>10])&&0===(this.floppy_size&1023))a.devices.rtc.cmos_write(CMOS_FLOPPY_DRIVE_TYPE,
c.type<<4),a=c.sectors,b=c.heads,c=c.tracks;else throw"Unknown floppy size: "+h(b.byteLength);this.sectors_per_track=a;this.number_of_heads=b;this.number_of_cylinders=c}else a.devices.rtc.cmos_write(CMOS_FLOPPY_DRIVE_TYPE,64),this.floppy_size=this.number_of_cylinders=this.number_of_heads=this.sectors_per_track=0;this.io.register_read(1008,this,this.port3F0_read);this.io.register_read(1010,this,this.port3F2_read);this.io.register_read(1012,this,this.port3F4_read);this.io.register_read(1013,this,this.port3F5_read);
this.io.register_read(1015,this,this.port3F7_read);this.io.register_write(1010,this,this.port3F2_write);this.io.register_write(1013,this,this.port3F5_write)}
FloppyController.prototype.get_state=function(){var a=[];a[0]=this.bytes_expecting;a[1]=this.receiving_command;a[2]=this.receiving_index;a[4]=this.response_data;a[5]=this.response_index;a[6]=this.response_length;a[7]=this.floppy_size;a[8]=this.status_reg0;a[9]=this.status_reg1;a[10]=this.status_reg2;a[11]=this.drive;a[12]=this.last_cylinder;a[13]=this.last_head;a[14]=this.last_sector;a[15]=this.dor;a[16]=this.sectors_per_track;a[17]=this.number_of_heads;a[18]=this.number_of_cylinders;return a};
FloppyController.prototype.set_state=function(a){this.bytes_expecting=a[0];this.receiving_command=a[1];this.receiving_index=a[2];this.next_command=a[3];this.response_data=a[4];this.response_index=a[5];this.response_length=a[6];this.floppy_size=a[7];this.status_reg0=a[8];this.status_reg1=a[9];this.status_reg2=a[10];this.drive=a[11];this.last_cylinder=a[12];this.last_head=a[13];this.last_sector=a[14];this.dor=a[15];this.sectors_per_track=a[16];this.number_of_heads=a[17];this.number_of_cylinders=a[18]};
FloppyController.prototype.port3F0_read=function(){dbg_log("3F0 read",LOG_FLOPPY);return 0};FloppyController.prototype.port3F4_read=function(){dbg_log("3F4 read",LOG_FLOPPY);var a=128;this.response_index<this.response_length&&(a|=80);0===(this.dor&8)&&(a|=32);return a};FloppyController.prototype.port3F7_read=function(){dbg_log("3F7 read",LOG_FLOPPY);return 0};
FloppyController.prototype.port3F5_read=function(){if(this.response_index<this.response_length)return dbg_log("3F5 read: "+this.response_data[this.response_index],LOG_FLOPPY),this.cpu.device_lower_irq(6),this.response_data[this.response_index++];dbg_log("3F5 read, empty",LOG_FLOPPY);return 255};
FloppyController.prototype.port3F5_write=function(a){if(this.fda_image)if(dbg_log("3F5 write "+h(a),LOG_FLOPPY),0<this.bytes_expecting){if(this.receiving_command[this.receiving_index++]=a,this.bytes_expecting--,0===this.bytes_expecting){if(DEBUG){a="3F5 command received: ";for(var b=0;b<this.receiving_index;b++)a+=h(this.receiving_command[b])+" ";dbg_log(a,LOG_FLOPPY)}this.next_command.call(this,this.receiving_command)}}else{switch(a){case 3:this.next_command=this.fix_drive_data;this.bytes_expecting=
2;break;case 4:this.next_command=this.check_drive_status;this.bytes_expecting=1;break;case 5:case 197:this.next_command=function(a){this.do_sector(!0,a)};this.bytes_expecting=8;break;case 230:this.next_command=function(a){this.do_sector(!1,a)};this.bytes_expecting=8;break;case 7:this.next_command=this.calibrate;this.bytes_expecting=1;break;case 8:this.check_interrupt_status();break;case 74:this.next_command=this.read_sector_id;this.bytes_expecting=1;break;case 15:this.bytes_expecting=2;this.next_command=
this.seek;break;case 14:dbg_log("dump registers",LOG_FLOPPY);this.response_data[0]=128;this.response_index=0;this.response_length=1;this.bytes_expecting=0;break;default:dbg_assert(!1,"Unimplemented floppy command call "+h(a))}this.receiving_index=0}};FloppyController.prototype.port3F2_read=function(){dbg_log("read 3F2: DOR",LOG_FLOPPY);return this.dor};
FloppyController.prototype.port3F2_write=function(a){4===(a&4)&&0===(this.dor&4)&&this.cpu.device_raise_irq(6);dbg_log("start motors: "+h(a>>4),LOG_FLOPPY);dbg_log("enable dma: "+!!(a&8),LOG_FLOPPY);dbg_log("reset fdc: "+!!(a&4),LOG_FLOPPY);dbg_log("drive select: "+(a&3),LOG_FLOPPY);dbg_log("DOR = "+h(a),LOG_FLOPPY);this.dor=a};FloppyController.prototype.check_drive_status=function(a){dbg_log("check drive status",LOG_FLOPPY);this.response_index=0;this.response_length=1;this.response_data[0]=32};
FloppyController.prototype.seek=function(a){dbg_log("seek",LOG_FLOPPY);dbg_assert(0===(a[0]&3),"Unhandled seek drive");this.last_cylinder=a[1];this.last_head=a[0]>>2&1;this.raise_irq()};FloppyController.prototype.calibrate=function(a){dbg_log("floppy calibrate",LOG_FLOPPY);this.raise_irq()};FloppyController.prototype.check_interrupt_status=function(){dbg_log("floppy check interrupt status",LOG_FLOPPY);this.response_index=0;this.response_length=2;this.response_data[0]=32;this.response_data[1]=this.last_cylinder};
FloppyController.prototype.do_sector=function(a,b){var c=b[2],d=b[1],e=b[3],f=128<<b[4],g=b[5]-b[3]+1,k=((c+this.number_of_heads*d)*this.sectors_per_track+e-1)*f;dbg_log("Floppy "+(a?"Write":"Read"),LOG_FLOPPY);dbg_log("from "+h(k)+" length "+h(g*f),LOG_FLOPPY);dbg_log(d+" / "+c+" / "+e,LOG_FLOPPY);b[4]||dbg_log("FDC: sector count is zero, use data length instead",LOG_FLOPPY);this.fda_image&&(a?this.dma.do_write(this.fda_image,k,g*f,2,this.done.bind(this,b,d,c,e)):this.dma.do_read(this.fda_image,
k,g*f,2,this.done.bind(this,b,d,c,e)))};FloppyController.prototype.done=function(a,b,c,d,e){e||(d++,d>this.sectors_per_track&&(d=1,c++,c>=this.number_of_heads&&(c=0,b++)),this.last_cylinder=b,this.last_head=c,this.last_sector=d,this.response_index=0,this.response_length=7,this.response_data[0]=c<<2|32,this.response_data[1]=0,this.response_data[2]=0,this.response_data[3]=b,this.response_data[4]=c,this.response_data[5]=d,this.response_data[6]=a[4],this.raise_irq())};
FloppyController.prototype.fix_drive_data=function(a){dbg_log("floppy fix drive data "+a,LOG_FLOPPY)};FloppyController.prototype.read_sector_id=function(a){dbg_log("floppy read sector id "+a,LOG_FLOPPY);this.response_index=0;this.response_length=7;this.response_data[0]=0;this.response_data[1]=0;this.response_data[2]=0;this.response_data[3]=0;this.response_data[4]=0;this.response_data[5]=0;this.response_data[6]=0;this.raise_irq()};FloppyController.prototype.raise_irq=function(){this.dor&8&&this.cpu.device_raise_irq(6)};var A20_MASK=-1048577,A20_MASK16=-524289,A20_MASK32=-262145,USE_A20=!1;CPU.prototype.debug_write=function(a,b,c){DEBUG&&(dbg_assert("number"===typeof c&&!isNaN(c)),dbg_assert(-2147483648<=c&&2147483648>a),this.debug_read(a,b,!0))};CPU.prototype.debug_read=function(a,b,c){DEBUG&&(dbg_assert("number"===typeof a),dbg_assert(!isNaN(a)))};CPU.prototype.mmap_read8=function(a){return this.memory_map_read8[a>>>MMAP_BLOCK_BITS](a)};
CPU.prototype.mmap_write8=function(a,b){this.memory_map_write8[a>>>MMAP_BLOCK_BITS](a,b)};CPU.prototype.mmap_read16=function(a){var b=this.memory_map_read8[a>>>MMAP_BLOCK_BITS];return b(a)|b(a+1|0)<<8};CPU.prototype.mmap_write16=function(a,b){var c=this.memory_map_write8[a>>>MMAP_BLOCK_BITS];c(a,b&255);c(a+1|0,b>>8&255)};CPU.prototype.mmap_read32=function(a){return this.memory_map_read32[a>>>MMAP_BLOCK_BITS](a)};
CPU.prototype.mmap_write32=function(a,b){this.memory_map_write32[a>>>MMAP_BLOCK_BITS](a,b)};CPU.prototype.in_mapped_range=function(a){return 655360<=(a|0)&&786432>(a|0)||a>>>0>=this.memory_size>>>0};CPU.prototype.read8=function(a){this.debug_read(a,1);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);return this.in_mapped_range(a)?this.mmap_read8(a):this.mem8[a]};
CPU.prototype.read16=function(a){this.debug_read(a,2);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);return this.in_mapped_range(a)?this.mmap_read16(a):this.mem8[a]|this.mem8[a+1|0]<<8};CPU.prototype.read_aligned16=function(a){dbg_assert(0<=a&&2147483648>a);this.debug_read(a<<1,2);USE_A20&&!this.a20_enabled&&(a&=A20_MASK16);return this.in_mapped_range(a<<1)?this.mmap_read16(a<<1):this.mem16[a]};
CPU.prototype.read32s=function(a){this.debug_read(a,4);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);return this.in_mapped_range(a)?this.mmap_read32(a):this.mem8[a]|this.mem8[a+1|0]<<8|this.mem8[a+2|0]<<16|this.mem8[a+3|0]<<24};CPU.prototype.read_aligned32=function(a){dbg_assert(0<=a&&1073741824>a);this.debug_read(a<<2,4);USE_A20&&!this.a20_enabled&&(a&=A20_MASK32);return this.in_mapped_range(a<<2)?this.mmap_read32(a<<2):this.mem32s[a]};
CPU.prototype.write8=function(a,b){this.debug_write(a,1,b);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);this.in_mapped_range(a)?this.mmap_write8(a,b):this.mem8[a]=b};CPU.prototype.write16=function(a,b){this.debug_write(a,2,b);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);this.in_mapped_range(a)?this.mmap_write16(a,b):(this.mem8[a]=b,this.mem8[a+1|0]=b>>8)};
CPU.prototype.write_aligned16=function(a,b){dbg_assert(0<=a&&2147483648>a);this.debug_write(a<<1,2,b);USE_A20&&!this.a20_enabled&&(a&=A20_MASK16);this.in_mapped_range(a<<1)?this.mmap_write16(a<<1,b):this.mem16[a]=b};CPU.prototype.write32=function(a,b){this.debug_write(a,4,b);USE_A20&&!this.a20_enabled&&(a&=A20_MASK);this.in_mapped_range(a)?this.mmap_write32(a,b):(this.mem8[a]=b,this.mem8[a+1|0]=b>>8,this.mem8[a+2|0]=b>>16,this.mem8[a+3|0]=b>>24)};
CPU.prototype.write_aligned32=function(a,b){dbg_assert(0<=a&&1073741824>a);this.debug_write(a<<2,4,b);USE_A20&&!this.a20_enabled&&(a&=A20_MASK32);this.in_mapped_range(a<<2)?this.mmap_write32(a<<2,b):this.mem32s[a]=b};CPU.prototype.write_blob=function(a,b){this.debug_write(b,a.length,0);dbg_assert(a&&0<=a.length);this.mem8.set(a,b)};CPU.prototype.write_blob32=function(a,b){dbg_assert(a&&a.length);this.debug_write(b,a.length<<2,0);this.mem32s.set(a,b)};function DMA(a){this.cpu=a;this.channel_page=new Uint8Array(8);this.channel_pagehi=new Uint8Array(8);this.channel_addr=new Uint16Array(8);this.channel_addr_init=new Uint16Array(8);this.channel_count=new Uint16Array(8);this.channel_count_init=new Uint16Array(8);this.channel_mask=new Uint8Array(8);this.channel_mode=new Uint8Array(8);this.unmask_listeners=[];this.lsb_msb_flipflop=0;a=a.io;a.register_write(0,this,this.port_addr_write.bind(this,0));a.register_write(2,this,this.port_addr_write.bind(this,
1));a.register_write(4,this,this.port_addr_write.bind(this,2));a.register_write(6,this,this.port_addr_write.bind(this,3));a.register_write(1,this,this.port_count_write.bind(this,0));a.register_write(3,this,this.port_count_write.bind(this,1));a.register_write(5,this,this.port_count_write.bind(this,2));a.register_write(7,this,this.port_count_write.bind(this,3));a.register_read(0,this,this.port_addr_read.bind(this,0));a.register_read(2,this,this.port_addr_read.bind(this,1));a.register_read(4,this,this.port_addr_read.bind(this,
2));a.register_read(6,this,this.port_addr_read.bind(this,3));a.register_read(1,this,this.port_count_read.bind(this,0));a.register_read(3,this,this.port_count_read.bind(this,1));a.register_read(5,this,this.port_count_read.bind(this,2));a.register_read(7,this,this.port_count_read.bind(this,3));a.register_write(192,this,this.port_addr_write.bind(this,4));a.register_write(196,this,this.port_addr_write.bind(this,5));a.register_write(200,this,this.port_addr_write.bind(this,6));a.register_write(204,this,
this.port_addr_write.bind(this,7));a.register_write(194,this,this.port_count_write.bind(this,4));a.register_write(198,this,this.port_count_write.bind(this,5));a.register_write(202,this,this.port_count_write.bind(this,6));a.register_write(206,this,this.port_count_write.bind(this,7));a.register_read(192,this,this.port_addr_read.bind(this,4));a.register_read(196,this,this.port_addr_read.bind(this,5));a.register_read(200,this,this.port_addr_read.bind(this,6));a.register_read(204,this,this.port_addr_read.bind(this,
7));a.register_read(194,this,this.port_count_read.bind(this,4));a.register_read(198,this,this.port_count_read.bind(this,5));a.register_read(202,this,this.port_count_read.bind(this,6));a.register_read(206,this,this.port_count_read.bind(this,7));a.register_write(135,this,this.port_page_write.bind(this,0));a.register_write(131,this,this.port_page_write.bind(this,1));a.register_write(129,this,this.port_page_write.bind(this,2));a.register_write(130,this,this.port_page_write.bind(this,3));a.register_write(143,
this,this.port_page_write.bind(this,4));a.register_write(139,this,this.port_page_write.bind(this,5));a.register_write(137,this,this.port_page_write.bind(this,6));a.register_write(138,this,this.port_page_write.bind(this,7));a.register_read(135,this,this.port_page_read.bind(this,0));a.register_read(131,this,this.port_page_read.bind(this,1));a.register_read(129,this,this.port_page_read.bind(this,2));a.register_read(130,this,this.port_page_read.bind(this,3));a.register_read(143,this,this.port_page_read.bind(this,
4));a.register_read(139,this,this.port_page_read.bind(this,5));a.register_read(137,this,this.port_page_read.bind(this,6));a.register_read(138,this,this.port_page_read.bind(this,7));a.register_write(1159,this,this.port_pagehi_write.bind(this,0));a.register_write(1155,this,this.port_pagehi_write.bind(this,1));a.register_write(1153,this,this.port_pagehi_write.bind(this,2));a.register_write(1154,this,this.port_pagehi_write.bind(this,3));a.register_write(1163,this,this.port_pagehi_write.bind(this,5));
a.register_write(1161,this,this.port_pagehi_write.bind(this,6));a.register_write(1162,this,this.port_pagehi_write.bind(this,7));a.register_read(1159,this,this.port_pagehi_read.bind(this,0));a.register_read(1155,this,this.port_pagehi_read.bind(this,1));a.register_read(1153,this,this.port_pagehi_read.bind(this,2));a.register_read(1154,this,this.port_pagehi_read.bind(this,3));a.register_read(1163,this,this.port_pagehi_read.bind(this,5));a.register_read(1161,this,this.port_pagehi_read.bind(this,6));a.register_read(1162,
this,this.port_pagehi_read.bind(this,7));a.register_write(10,this,this.port_singlemask_write.bind(this,0));a.register_write(212,this,this.port_singlemask_write.bind(this,4));a.register_write(15,this,this.port_multimask_write.bind(this,0));a.register_write(222,this,this.port_multimask_write.bind(this,4));a.register_read(15,this,this.port_multimask_read.bind(this,0));a.register_read(222,this,this.port_multimask_read.bind(this,4));a.register_write(11,this,this.port_mode_write.bind(this,0));a.register_write(214,
this,this.port_mode_write.bind(this,4));a.register_write(12,this,this.portC_write);a.register_write(216,this,this.portC_write)}DMA.prototype.get_state=function(){return[this.channel_page,this.channel_pagehi,this.channel_addr,this.channel_addr_init,this.channel_count,this.channel_count_init,this.channel_mask,this.channel_mode,this.lsb_msb_flipflop]};
DMA.prototype.set_state=function(a){this.channel_page=a[0];this.channel_pagehi=a[1];this.channel_addr=a[2];this.channel_addr_init=a[3];this.channel_count=a[4];this.channel_count_init=a[5];this.channel_mask=a[6];this.channel_mode=a[7];this.lsb_msb_flipflop=a[8]};DMA.prototype.port_count_write=function(a,b){dbg_log("count write ["+a+"] = "+h(b),LOG_DMA);this.channel_count[a]=this.flipflop_get(this.channel_count[a],b,!1);this.channel_count_init[a]=this.flipflop_get(this.channel_count_init[a],b,!0)};
DMA.prototype.port_count_read=function(a){dbg_log("count read ["+a+"] -> "+h(this.channel_count[a]),LOG_DMA);return this.flipflop_read(this.channel_count[a])};DMA.prototype.port_addr_write=function(a,b){dbg_log("addr write ["+a+"] = "+h(b),LOG_DMA);this.channel_addr[a]=this.flipflop_get(this.channel_addr[a],b,!1);this.channel_addr_init[a]=this.flipflop_get(this.channel_addr_init[a],b,!0)};DMA.prototype.port_addr_read=function(a){dbg_log("addr read ["+a+"] -> "+h(this.channel_addr[a]),LOG_DMA);return this.flipflop_read(this.channel_addr[a])};
DMA.prototype.port_pagehi_write=function(a,b){dbg_log("pagehi write ["+a+"] = "+h(b),LOG_DMA);this.channel_pagehi[a]=b};DMA.prototype.port_pagehi_read=function(a){dbg_log("pagehi read ["+a+"]",LOG_DMA);return this.channel_pagehi[a]};DMA.prototype.port_page_write=function(a,b){dbg_log("page write ["+a+"] = "+h(b),LOG_DMA);this.channel_page[a]=b};DMA.prototype.port_page_read=function(a){dbg_log("page read ["+a+"]",LOG_DMA);return this.channel_page[a]};
DMA.prototype.port_singlemask_write=function(a,b){a=(b&3)+a;b=b&4?1:0;dbg_log("singlechannel mask write ["+a+"] = "+b,LOG_DMA);this.update_mask(a,b)};DMA.prototype.port_multimask_write=function(a,b){dbg_log("multichannel mask write: "+h(b),LOG_DMA);for(var c=0;4>c;c++)this.update_mask(a+c,b&1<<c)};
DMA.prototype.port_multimask_read=function(a){var b=0|this.channel_mask[a+0];b|=this.channel_mask[a+1]<<1;b|=this.channel_mask[a+2]<<2;b|=this.channel_mask[a+3]<<3;dbg_log("multichannel mask read: "+h(b),LOG_DMA);return b};DMA.prototype.port_mode_write=function(a,b){a=(b&3)+a;dbg_log("mode write ["+a+"] = "+h(b),LOG_DMA);this.channel_mode[a]=b};DMA.prototype.portC_write=function(a){dbg_log("flipflop reset",LOG_DMA);this.lsb_msb_flipflop=0};
DMA.prototype.on_unmask=function(a,b){this.unmask_listeners.push({fn:a,this_value:b})};DMA.prototype.update_mask=function(a,b){if(this.channel_mask[a]!==b&&(this.channel_mask[a]=b,!b))for(dbg_log("firing on_unmask("+a+")",LOG_DMA),b=0;b<this.unmask_listeners.length;b++)this.unmask_listeners[b].fn.call(this.unmask_listeners[b].this_value,a)};
DMA.prototype.do_read=function(a,b,c,d,e){var f=this.count_get_8bit(d),g=this.address_get_8bit(d);dbg_log("DMA write channel "+d,LOG_DMA);dbg_log("to "+h(g)+" len "+h(f),LOG_DMA);c<f&&dbg_log("DMA should read more than provided: "+h(c)+" "+h(f),LOG_DMA);if(b+f>a.byteLength)dbg_log("DMA read outside of buffer",LOG_DMA),e(!0);else{var k=this.cpu;this.channel_addr[d]+=f;a.get(b,f,function(a){k.write_blob(a,g);e(!1)})}};
DMA.prototype.do_write=function(a,b,c,d,e){var f=this,g=this.channel_count[d]+1&65535,k=5<=d?2:1,l=g*k,m=this.address_get_8bit(d),p=!1,n=!1,r=this.channel_mode[d]&16;dbg_log("DMA write channel "+d,LOG_DMA);dbg_log("to "+h(m)+" len "+h(l),LOG_DMA);c<l?(dbg_log("DMA should read more than provided",LOG_DMA),g=Math.floor(c/k),l=g*k,p=!0):c>l&&(dbg_log("DMA attempted to read more than provided",LOG_DMA),n=!0);b+l>a.byteLength?(dbg_log("DMA write outside of buffer",LOG_DMA),e(!0)):(this.channel_addr[d]+=
g,this.channel_count[d]-=g,!p&&r&&(dbg_log("DMA autoinit",LOG_DMA),this.channel_addr[d]=this.channel_addr_init[d],this.channel_count[d]=this.channel_count_init[d]),a.set(b,this.cpu.mem8.subarray(m,m+l),function(){n&&r?(dbg_log("DMA continuing from start",LOG_DMA),f.do_write(a,b+l,c-l,d,e)):e(!1)}))};DMA.prototype.address_get_8bit=function(a){var b=this.channel_addr[a];5<=a&&(b<<=1);b=b&65535|this.channel_page[a]<<16;return b|=this.channel_pagehi[a]<<24};
DMA.prototype.count_get_8bit=function(a){var b=this.channel_count[a]+1;5<=a&&(b*=2);return b};DMA.prototype.flipflop_get=function(a,b,c){c||(this.lsb_msb_flipflop^=1);return this.lsb_msb_flipflop?a&-256|b:a&-65281|b<<8};DMA.prototype.flipflop_read=function(a){return(this.lsb_msb_flipflop^=1)?a&255:a>>8&255};var OSCILLATOR_FREQ=1193.1816666;
function PIT(a,b){this.cpu=a;this.bus=b;this.counter_start_time=new Float64Array(3);this.counter_start_value=new Uint16Array(3);this.counter_next_low=new Uint8Array(4);this.counter_enabled=new Uint8Array(4);this.counter_mode=new Uint8Array(4);this.counter_read_mode=new Uint8Array(4);this.counter_latch=new Uint8Array(4);this.counter_latch_value=new Uint16Array(3);this.counter_reload=new Uint16Array(3);a.io.register_read(97,this,function(){var a=v86.microtick(),b=66.66666666666667*a&1;a=this.did_rollover(2,
a);return b<<4|a<<5});a.io.register_write(97,this,function(a){a&1?this.bus.send("pcspeaker-enable"):this.bus.send("pcspeaker-disable")});a.io.register_read(64,this,function(){return this.counter_read(0)});a.io.register_read(65,this,function(){return this.counter_read(1)});a.io.register_read(66,this,function(){return this.counter_read(2)});a.io.register_write(64,this,function(a){this.counter_write(0,a)});a.io.register_write(65,this,function(a){this.counter_write(1,a)});a.io.register_write(66,this,
function(a){this.counter_write(2,a)});a.io.register_write(67,this,this.port43_write)}PIT.prototype.get_state=function(){var a=[];a[0]=this.counter_next_low;a[1]=this.counter_enabled;a[2]=this.counter_mode;a[3]=this.counter_read_mode;a[4]=this.counter_latch;a[5]=this.counter_latch_value;a[6]=this.counter_reload;a[7]=this.counter_start_time;a[8]=this.counter_start_value;return a};
PIT.prototype.set_state=function(a){this.counter_next_low=a[0];this.counter_enabled=a[1];this.counter_mode=a[2];this.counter_read_mode=a[3];this.counter_latch=a[4];this.counter_latch_value=a[5];this.counter_reload=a[6];this.counter_start_time=a[7];this.counter_start_value=a[8]};
PIT.prototype.timer=function(a,b){b||(this.counter_enabled[0]&&this.did_rollover(0,a)?(this.counter_start_value[0]=this.get_counter_value(0,a),this.counter_start_time[0]=a,dbg_log("pit interrupt. new value: "+this.counter_start_value[0],LOG_PIT),this.cpu.device_raise_irq(0),0===this.counter_mode[0]&&(this.counter_enabled[0]=0)):this.cpu.device_lower_irq(0));return 0};
PIT.prototype.get_counter_value=function(a,b){if(!this.counter_enabled[a])return 0;var c=b-this.counter_start_time[a],d=Math.floor(c*OSCILLATOR_FREQ);b=this.counter_start_value[a]-d;dbg_log("diff="+c+" dticks="+d+" value="+b+" reload="+this.counter_reload[a],LOG_PIT);c=this.counter_reload[a];b>=c?(dbg_log("Warning: Counter"+a+" value "+b+" is larger than reload "+c,LOG_PIT),b%=c):0>b&&(b=b%c+c);return b};
PIT.prototype.did_rollover=function(a,b){b-=this.counter_start_time[a];return 0>b?(dbg_log("Warning: PIT timer difference is negative, resetting"),!0):this.counter_start_value[a]<Math.floor(b*OSCILLATOR_FREQ)};
PIT.prototype.counter_read=function(a){var b=this.counter_latch[a];if(b)return this.counter_latch[a]--,2===b?this.counter_latch_value[a]&255:this.counter_latch_value[a]>>8;b=this.counter_next_low[a];3===this.counter_mode[a]&&(this.counter_next_low[a]^=1);a=this.get_counter_value(a,v86.microtick());return b?a&255:a>>8};
PIT.prototype.counter_write=function(a,b){this.counter_reload[a]=this.counter_next_low[a]?this.counter_reload[a]&-256|b:this.counter_reload[a]&255|b<<8;3===this.counter_read_mode[a]&&this.counter_next_low[a]||(this.counter_reload[a]||(this.counter_reload[a]=65535),this.counter_start_value[a]=this.counter_reload[a],this.counter_enabled[a]=!0,this.counter_start_time[a]=v86.microtick(),dbg_log("counter"+a+" reload="+h(this.counter_reload[a])+" tick="+(this.counter_reload[a]||65536)/OSCILLATOR_FREQ+"ms",
LOG_PIT));3===this.counter_read_mode[a]&&(this.counter_next_low[a]^=1);this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]])};
PIT.prototype.port43_write=function(a){var b=a>>1&7,c=a&1,d=a>>6&3;a=a>>4&3;1===d&&dbg_log("Unimplemented timer1",LOG_PIT);3===d?dbg_log("Unimplemented read back",LOG_PIT):0===a?(this.counter_latch[d]=2,b=this.get_counter_value(d,v86.microtick()),dbg_log("latch: "+b,LOG_PIT),this.counter_latch_value[d]=b?b-1:0):(6<=b&&(b&=-5),dbg_log("Control: mode="+b+" ctr="+d+" read_mode="+a+" bcd="+c,LOG_PIT),this.counter_next_low[d]=1===a?0:1,0===d&&this.cpu.device_lower_irq(0),0!==b&&3!==b&&2!==b&&dbg_log("Unimplemented counter mode: "+
h(b),LOG_PIT),this.counter_mode[d]=b,this.counter_read_mode[d]=a,this.bus.send("pcspeaker-update",[this.counter_mode[2],this.counter_reload[2]]))};var VGA_BANK_SIZE=65536,MAX_XRES=2560,MAX_YRES=1600,MAX_BPP=32,VGA_LFB_ADDRESS=3758096384,VGA_PIXEL_BUFFER_START=4*VGA_BANK_SIZE,VGA_PIXEL_BUFFER_SIZE=8*VGA_BANK_SIZE,VGA_MIN_MEMORY_SIZE=VGA_PIXEL_BUFFER_START+VGA_PIXEL_BUFFER_SIZE,VGA_HOST_MEMORY_SPACE_START=Uint32Array.from([655360,655360,720896,753664]),VGA_HOST_MEMORY_SPACE_SIZE=Uint32Array.from([131072,65536,32768,32768]);
function VGAScreen(a,b,c){var d=this;this.bus=b;this.vga_memory_size=c;this.cursor_address=0;this.cursor_scanline_start=14;this.cursor_scanline_end=15;this.max_cols=80;this.max_rows=25;this.virtual_height=this.virtual_width=this.screen_height=this.screen_width=0;this.layers=[];this.start_address_latched=this.start_address=0;this.crtc=new Uint8Array(25);this.line_compare=this.offset_register=this.preset_row_scan=this.underline_location_register=this.vertical_blank_start=this.vertical_display_enable_end=
this.horizontal_blank_start=this.horizontal_display_enable_end=this.crtc_mode=0;this.graphical_mode_is_linear=!0;this.graphical_mode=!1;setTimeout(function(){b.send("screen-set-mode",d.graphical_mode)},0);this.vga256_palette=new Int32Array(256);this.svga_height=this.svga_width=this.latch_dword=0;this.svga_enabled=!1;this.svga_bpp=32;this.svga_offset=this.svga_bank_offset=0;this.pci_space=[222,16,32,10,7,0,0,0,162,0,0,3,0,0,128,0,8,VGA_LFB_ADDRESS>>>8,VGA_LFB_ADDRESS>>>16,VGA_LFB_ADDRESS>>>24,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,10,1,0,0];this.pci_id=144;this.pci_bars=[{size:c}];this.pci_rom_size=65536;this.pci_rom_address=4272947200;this.name="vga";this.stats={is_graphical:!1,res_x:0,res_y:0,bpp:0};this.dac_state=this.dac_color_index_read=this.dac_color_index_write=this.index_crtc=0;this.dac_map=new Uint8Array(16);this.attribute_controller_index=-1;this.palette_source=32;this.color_select=this.horizontal_panning=this.color_plane_enable=this.attribute_mode=
0;this.sequencer_index=-1;this.plane_write_bm=15;this.clocking_mode=this.sequencer_memory_mode=0;this.graphics_index=-1;this.planar_rotate_reg=this.planar_mode=this.plane_read=0;this.planar_bitmap=255;this.max_scan_line=this.color_dont_care=this.color_compare=this.miscellaneous_graphics_register=this.planar_setreset_enable=this.planar_setreset=0;this.port_3DA_value=this.miscellaneous_output_register=255;c=a.io;c.register_write(960,this,this.port3C0_write);c.register_read(960,this,this.port3C0_read,
this.port3C0_read16);c.register_read(961,this,this.port3C1_read);c.register_write(962,this,this.port3C2_write);c.register_write_consecutive(964,this,this.port3C4_write,this.port3C5_write);c.register_read(964,this,this.port3C4_read);c.register_read(965,this,this.port3C5_read);c.register_write_consecutive(974,this,this.port3CE_write,this.port3CF_write);c.register_read(974,this,this.port3CE_read);c.register_read(975,this,this.port3CF_read);c.register_write(967,this,this.port3C7_write);c.register_read(967,
this,this.port3C7_read);c.register_write(968,this,this.port3C8_write);c.register_read(968,this,this.port3C8_read);c.register_write(969,this,this.port3C9_write);c.register_read(969,this,this.port3C9_read);c.register_read(972,this,this.port3CC_read);c.register_write_consecutive(980,this,this.port3D4_write,this.port3D5_write);c.register_read(980,this,this.port3D4_read);c.register_read(981,this,this.port3D5_read);c.register_read(970,this,function(){dbg_log("3CA read",LOG_VGA);return 0});c.register_read(986,
this,this.port3DA_read);c.register_read(954,this,this.port3DA_read);this.dispi_index=-1;this.dispi_enable_value=0;c.register_write(462,this,void 0,this.port1CE_write);c.register_write(463,this,void 0,this.port1CF_write);c.register_read(463,this,void 0,this.port1CF_read);void 0===this.vga_memory_size||this.vga_memory_size<VGA_MIN_MEMORY_SIZE?(this.vga_memory_size=VGA_MIN_MEMORY_SIZE,dbg_log("vga memory size rounded up to "+this.vga_memory_size,LOG_VGA)):this.vga_memory_size&VGA_BANK_SIZE-1&&(this.vga_memory_size|=
VGA_BANK_SIZE-1,this.vga_memory_size++);this.svga_memory=new Uint8Array(this.vga_memory_size);this.diff_addr_min=this.vga_memory_size;this.diff_addr_max=0;this.diff_plot_min=this.vga_memory_size;this.diff_plot_max=0;this.dest_buffer=void 0;b.register("screen-tell-buffer",function(a){this.dest_buffer&&a[0]&&a[0].set(this.dest_buffer.subarray(0,a[0].length));this.dest_buffer=a[0]},this);b.register("screen-fill-buffer",function(){this.screen_fill_buffer()},this);this.svga_memory16=new Uint16Array(this.svga_memory.buffer);
this.svga_memory32=new Int32Array(this.svga_memory.buffer);this.vga_memory=new Uint8Array(this.svga_memory.buffer,0,4*VGA_BANK_SIZE);this.plane0=new Uint8Array(this.svga_memory.buffer,0*VGA_BANK_SIZE,VGA_BANK_SIZE);this.plane1=new Uint8Array(this.svga_memory.buffer,1*VGA_BANK_SIZE,VGA_BANK_SIZE);this.plane2=new Uint8Array(this.svga_memory.buffer,2*VGA_BANK_SIZE,VGA_BANK_SIZE);this.plane3=new Uint8Array(this.svga_memory.buffer,3*VGA_BANK_SIZE,VGA_BANK_SIZE);this.pixel_buffer=new Uint8Array(this.svga_memory.buffer,
VGA_PIXEL_BUFFER_START,VGA_PIXEL_BUFFER_SIZE);var e=this;c.mmap_register(655360,131072,function(a){return e.vga_memory_read(a)},function(a,b){e.vga_memory_write(a,b)});c.mmap_register(VGA_LFB_ADDRESS,this.vga_memory_size,function(a){return e.svga_memory_read8(a)},function(a,b){e.svga_memory_write8(a,b)},function(a){return e.svga_memory_read32(a)},function(a,b){e.svga_memory_write32(a,b)});a.devices.pci.register_device(this)}
VGAScreen.prototype.get_state=function(){var a=[];a[0]=this.vga_memory_size;a[1]=this.cursor_address;a[2]=this.cursor_scanline_start;a[3]=this.cursor_scanline_end;a[4]=this.max_cols;a[5]=this.max_rows;a[6]=this.layers;a[7]=this.dac_state;a[8]=this.start_address;a[9]=this.graphical_mode;a[10]=this.vga256_palette;a[11]=this.latch_dword;a[12]=this.color_compare;a[13]=this.color_dont_care;a[14]=this.miscellaneous_graphics_register;a[15]=this.svga_width;a[16]=this.svga_height;a[17]=this.crtc_mode;a[18]=
this.svga_enabled;a[19]=this.svga_bpp;a[20]=this.svga_bank_offset;a[21]=this.svga_offset;a[22]=this.index_crtc;a[23]=this.dac_color_index_write;a[24]=this.dac_color_index_read;a[25]=this.dac_map;a[26]=this.sequencer_index;a[27]=this.plane_write_bm;a[28]=this.sequencer_memory_mode;a[29]=this.graphics_index;a[30]=this.plane_read;a[31]=this.planar_mode;a[32]=this.planar_rotate_reg;a[33]=this.planar_bitmap;a[34]=this.max_scan_line;a[35]=this.miscellaneous_output_register;a[36]=this.port_3DA_value;a[37]=
this.dispi_index;a[38]=this.dispi_enable_value;a[39]=this.svga_memory;a[40]=this.graphical_mode_is_linear;a[41]=this.attribute_controller_index;a[42]=this.offset_register;a[43]=this.planar_setreset;a[44]=this.planar_setreset_enable;a[45]=this.start_address_latched;a[46]=this.crtc;a[47]=this.horizontal_display_enable_end;a[48]=this.horizontal_blank_start;a[49]=this.vertical_display_enable_end;a[50]=this.vertical_blank_start;a[51]=this.underline_location_register;a[52]=this.preset_row_scan;a[53]=this.offset_register;
a[54]=this.palette_source;a[55]=this.attribute_mode;a[56]=this.color_plane_enable;a[57]=this.horizontal_panning;a[58]=this.color_select;a[59]=this.clocking_mode;a[60]=this.line_compare;return a};
VGAScreen.prototype.set_state=function(a){this.vga_memory_size=a[0];this.cursor_address=a[1];this.cursor_scanline_start=a[2];this.cursor_scanline_end=a[3];this.max_cols=a[4];this.max_rows=a[5];this.layers=a[6];this.dac_state=a[7];this.start_address=a[8];this.graphical_mode=a[9];this.vga256_palette=a[10];this.latch_dword=a[11];this.color_compare=a[12];this.color_dont_care=a[13];this.miscellaneous_graphics_register=a[14];this.svga_width=a[15];this.svga_height=a[16];this.crtc_mode=a[17];this.svga_enabled=
a[18];this.svga_bpp=a[19];this.svga_bank_offset=a[20];this.svga_offset=a[21];this.index_crtc=a[22];this.dac_color_index_write=a[23];this.dac_color_index_read=a[24];this.dac_map=a[25];this.sequencer_index=a[26];this.plane_write_bm=a[27];this.sequencer_memory_mode=a[28];this.graphics_index=a[29];this.plane_read=a[30];this.planar_mode=a[31];this.planar_rotate_reg=a[32];this.planar_bitmap=a[33];this.max_scan_line=a[34];this.miscellaneous_output_register=a[35];this.port_3DA_value=a[36];this.dispi_index=
a[37];this.dispi_enable_value=a[38];this.svga_memory.set(a[39]);this.graphical_mode_is_linear=a[40];this.attribute_controller_index=a[41];this.offset_register=a[42];this.planar_setreset=a[43];this.planar_setreset_enable=a[44];this.start_address_latched=a[45];this.crtc.set(a[46]);this.horizontal_display_enable_end=a[47];this.horizontal_blank_start=a[48];this.vertical_display_enable_end=a[49];this.vertical_blank_start=a[50];this.underline_location_register=a[51];this.preset_row_scan=a[52];this.offset_register=
a[53];this.palette_source=a[54];this.attribute_mode=a[55];this.color_plane_enable=a[56];this.horizontal_panning=a[57];this.color_select=a[58];this.clocking_mode=a[59];this.line_compare=a[60];this.bus.send("screen-set-mode",this.graphical_mode);this.graphical_mode?(this.screen_height=this.screen_width=0,this.svga_enabled?(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.update_layers()):(this.update_vga_size(),this.complete_replot())):(this.set_size_text(this.max_cols,
this.max_rows),this.update_cursor_scanline(),this.update_cursor());this.complete_redraw()};
VGAScreen.prototype.vga_memory_read=function(a){if(this.svga_enabled&&this.graphical_mode_is_linear)return a=a-655360|this.svga_bank_offset,this.svga_memory[a];var b=this.miscellaneous_graphics_register>>2&3;a-=VGA_HOST_MEMORY_SPACE_START[b];if(0>a||a>=VGA_HOST_MEMORY_SPACE_SIZE[b])return dbg_log("vga read outside memory space: addr:"+h(a),LOG_VGA),0;this.latch_dword=this.plane0[a];this.latch_dword|=this.plane1[a]<<8;this.latch_dword|=this.plane2[a]<<16;this.latch_dword|=this.plane3[a]<<24;if(this.planar_mode&
8)return b=255,this.color_dont_care&1&&(b&=this.plane0[a]^~(this.color_compare&1?255:0)),this.color_dont_care&2&&(b&=this.plane1[a]^~(this.color_compare&2?255:0)),this.color_dont_care&4&&(b&=this.plane2[a]^~(this.color_compare&4?255:0)),this.color_dont_care&8&&(b&=this.plane3[a]^~(this.color_compare&8?255:0)),b;b=this.plane_read;this.graphical_mode?this.sequencer_memory_mode&8?(b=a&3,a&=-4):this.planar_mode&16&&(b=a&1,a&=-2):b=0;return this.vga_memory[b<<16|a]};
VGAScreen.prototype.vga_memory_write=function(a,b){if(this.svga_enabled&&this.graphical_mode&&this.graphical_mode_is_linear)this.vga_memory_write_graphical_linear(a-655360,b);else{var c=this.miscellaneous_graphics_register>>2&3;a-=VGA_HOST_MEMORY_SPACE_START[c];0>a||a>=VGA_HOST_MEMORY_SPACE_SIZE[c]?dbg_log("vga write outside memory space: addr:"+h(a)+", value:"+h(b),LOG_VGA):this.graphical_mode?this.vga_memory_write_graphical(a,b):this.plane_write_bm&3&&this.vga_memory_write_text_mode(a,b)}};
VGAScreen.prototype.vga_memory_write_graphical_linear=function(a,b){a|=this.svga_bank_offset;this.diff_addr_min=a<this.diff_addr_min?a:this.diff_addr_min;this.diff_addr_max=a>this.diff_addr_max?a:this.diff_addr_max;this.svga_memory[a]=b};
VGAScreen.prototype.vga_memory_write_graphical=function(a,b){var c=this.planar_mode&3,d=this.apply_feed(this.planar_bitmap),e=this.apply_expand(this.planar_setreset),f=this.apply_expand(this.planar_setreset_enable);switch(c){case 0:b=this.apply_rotate(b);var g=this.apply_feed(b);g=this.apply_setreset(g,f);g=this.apply_logical(g,this.latch_dword);g=this.apply_bitmask(g,d);break;case 1:g=this.latch_dword;break;case 2:g=this.apply_expand(b);g=this.apply_logical(g,this.latch_dword);g=this.apply_bitmask(g,
d);break;case 3:b=this.apply_rotate(b),d&=this.apply_feed(b),g=this.apply_bitmask(e,d)}b=15;switch(this.sequencer_memory_mode&12){case 0:b=5<<(a&1);a&=-2;break;case 8:case 12:b=1<<(a&3),a&=-4}b&=this.plane_write_bm;b&1&&(this.plane0[a]=g>>0&255);b&2&&(this.plane1[a]=g>>8&255);b&4&&(this.plane2[a]=g>>16&255);b&8&&(this.plane3[a]=g>>24&255);a=this.vga_addr_to_pixel(a);this.partial_replot(a,a+7)};VGAScreen.prototype.apply_feed=function(a){return a|a<<8|a<<16|a<<24};
VGAScreen.prototype.apply_expand=function(a){return(a&1?255:0)|(a&2?255:0)<<8|(a&4?255:0)<<16|(a&8?255:0)<<24};VGAScreen.prototype.apply_rotate=function(a){return(a|a<<8)>>>(this.planar_rotate_reg&7)&255};VGAScreen.prototype.apply_setreset=function(a,b){var c=this.apply_expand(this.planar_setreset);return(a|b&c)&(~b|c)};VGAScreen.prototype.apply_logical=function(a,b){switch(this.planar_rotate_reg&24){case 8:return a&b;case 16:return a|b;case 24:return a^b}return a};
VGAScreen.prototype.apply_bitmask=function(a,b){return b&a|~b&this.latch_dword};VGAScreen.prototype.text_mode_redraw=function(){for(var a=this.start_address<<1,b,c,d=0;d<this.max_rows;d++)for(var e=0;e<this.max_cols;e++)b=this.vga_memory[a],c=this.vga_memory[a|1],this.bus.send("screen-put-char",[d,e,b,this.vga256_palette[c>>4&15],this.vga256_palette[c&15]]),a+=2};
VGAScreen.prototype.vga_memory_write_text_mode=function(a,b){var c=(a>>1)-this.start_address,d=c/this.max_cols|0;c%=this.max_cols;if(a&1){var e=b;var f=this.vga_memory[a&-2]}else f=b,e=this.vga_memory[a|1];this.bus.send("screen-put-char",[d,c,f,this.vga256_palette[e>>4&15],this.vga256_palette[e&15]]);this.vga_memory[a]=b};
VGAScreen.prototype.update_cursor=function(){var a=(this.cursor_address-this.start_address)/this.max_cols|0,b=(this.cursor_address-this.start_address)%this.max_cols;a=Math.min(this.max_rows-1,a);this.bus.send("screen-update-cursor",[a,b])};VGAScreen.prototype.svga_memory_read8=function(a){return this.svga_memory[a&268435455]};
VGAScreen.prototype.svga_memory_read32=function(a){a&=268435455;return a&3?this.svga_memory[a]|this.svga_memory[a+1]<<8|this.svga_memory[a+2]<<16|this.svga_memory[a+3]<<24:this.svga_memory32[a>>2]};VGAScreen.prototype.svga_memory_write8=function(a,b){a&=268435455;this.svga_memory[a]=b;this.diff_addr_min=a<this.diff_addr_min?a:this.diff_addr_min;this.diff_addr_max=a>this.diff_addr_max?a:this.diff_addr_max};
VGAScreen.prototype.svga_memory_write32=function(a,b){a&=268435455;this.diff_addr_min=a<this.diff_addr_min?a:this.diff_addr_min;this.diff_addr_max=a+3>this.diff_addr_max?a+3:this.diff_addr_max;this.svga_memory[a]=b;this.svga_memory[a+1]=b>>8;this.svga_memory[a+2]=b>>16;this.svga_memory[a+3]=b>>24};
VGAScreen.prototype.complete_redraw=function(){dbg_log("complete redraw",LOG_VGA);this.graphical_mode?(this.diff_addr_min=0,this.diff_addr_max=this.svga_enabled?this.vga_memory_size:VGA_PIXEL_BUFFER_SIZE):this.text_mode_redraw()};VGAScreen.prototype.complete_replot=function(){dbg_log("complete replot",LOG_VGA);this.graphical_mode&&!this.svga_enabled&&(this.diff_plot_min=0,this.diff_plot_max=VGA_PIXEL_BUFFER_SIZE,this.complete_redraw())};
VGAScreen.prototype.partial_redraw=function(a,b){a<this.diff_addr_min&&(this.diff_addr_min=a);b>this.diff_addr_max&&(this.diff_addr_max=b)};VGAScreen.prototype.partial_replot=function(a,b){a<this.diff_plot_min&&(this.diff_plot_min=a);b>this.diff_plot_max&&(this.diff_plot_max=b);this.partial_redraw(a,b)};VGAScreen.prototype.reset_diffs=function(){this.diff_addr_min=this.vga_memory_size;this.diff_addr_max=0;this.diff_plot_min=this.vga_memory_size;this.diff_plot_max=0};VGAScreen.prototype.destroy=function(){};
VGAScreen.prototype.vga_bytes_per_line=function(){var a=this.offset_register<<2;this.underline_location_register&64?a<<=1:this.crtc_mode&64&&(a>>>=1);return a};VGAScreen.prototype.vga_addr_shift_count=function(){var a=128+(~this.underline_location_register&this.crtc_mode&64);a-=this.underline_location_register&64;a-=this.attribute_mode&64;return a>>>6};
VGAScreen.prototype.vga_addr_to_pixel=function(a){var b=this.vga_addr_shift_count();if(~this.crtc_mode&3){var c=a-this.start_address;c&=this.crtc_mode<<13|-24577;c<<=b;var d=c/this.virtual_width|0;c%=this.virtual_width;switch(this.crtc_mode&3){case 2:d=d<<1|a>>13&1;break;case 1:d=d<<1|a>>14&1;break;case 0:d=d<<2|a>>13&3}return d*this.virtual_width+c+(this.start_address<<b)}return a<<b};
VGAScreen.prototype.scan_line_to_screen_row=function(a){this.max_scan_line&128&&(a>>>=1);a=Math.ceil(a/(1+(this.max_scan_line&31)));this.crtc_mode&1||(a<<=1);this.crtc_mode&2||(a<<=1);return a};VGAScreen.prototype.set_size_text=function(a,b){this.max_cols=a;this.max_rows=b;this.bus.send("screen-set-size-text",[a,b])};
VGAScreen.prototype.set_size_graphical=function(a,b,c,d,e){this.stats.is_graphical&&this.stats.bpp===c&&this.screen_width===a&&this.screen_height===b&&this.virtual_width===d&&this.virtual_height===e||(this.screen_width=a,this.screen_height=b,this.virtual_width=d,this.virtual_height=e,this.stats.bpp=c,this.stats.is_graphical=!0,this.stats.res_x=a,this.stats.res_y=b,this.bus.send("screen-set-size-graphical",[a,b,d,e,c]))};
VGAScreen.prototype.update_vga_size=function(){if(!this.svga_enabled){var a=Math.min(1+this.horizontal_display_enable_end,this.horizontal_blank_start),b=Math.min(1+this.vertical_display_enable_end,this.vertical_blank_start);if(a&&b)if(this.graphical_mode){a<<=3;var c=this.offset_register<<4;this.attribute_mode&64&&(a>>>=1,c>>>=1);b=this.scan_line_to_screen_row(b);var d=Math.ceil(VGA_HOST_MEMORY_SPACE_SIZE[0]/this.vga_bytes_per_line());this.set_size_graphical(a,b,8,c,d);this.update_vertical_retrace();
this.update_layers()}else this.max_scan_line&128&&(b>>>=1),c=b/(1+(this.max_scan_line&31))|0,a&&c&&this.set_size_text(a,c)}};
VGAScreen.prototype.update_layers=function(){this.graphical_mode||this.text_mode_redraw();if(this.svga_enabled)this.layers=[];else if(this.virtual_width&&this.screen_width)if(!this.palette_source||this.clocking_mode&32)this.layers=[],this.bus.send("screen-clear");else{var a=this.start_address_latched,b=this.horizontal_panning;this.attribute_mode&64&&(b>>>=1);var c=this.preset_row_scan>>5&3,d=this.vga_addr_to_pixel(a+c);a=d/this.virtual_width|0;var e=d%this.virtual_width+b;d=this.scan_line_to_screen_row(1+
this.line_compare);d=Math.min(d,this.screen_height);var f=this.screen_height-d;this.layers=[];e=-e;for(var g=0;e<this.screen_width;e+=this.virtual_width,g++)this.layers.push({screen_x:e,screen_y:0,buffer_x:0,buffer_y:a+g,buffer_width:this.virtual_width,buffer_height:d});a=0;this.attribute_mode&32||(a=this.vga_addr_to_pixel(c)+b);e=-a;for(g=0;e<this.screen_width;e+=this.virtual_width,g++)this.layers.push({screen_x:e,screen_y:d,buffer_x:0,buffer_y:g,buffer_width:this.virtual_width,buffer_height:f})}};
VGAScreen.prototype.update_vertical_retrace=function(){this.port_3DA_value|=8;this.start_address_latched!==this.start_address&&(this.start_address_latched=this.start_address,this.update_layers())};VGAScreen.prototype.update_cursor_scanline=function(){this.bus.send("screen-update-cursor-scanline",[this.cursor_scanline_start,this.cursor_scanline_end])};
VGAScreen.prototype.port3C0_write=function(a){if(-1===this.attribute_controller_index)dbg_log("attribute controller index register: "+h(a),LOG_VGA),this.attribute_controller_index=a&31,dbg_log("attribute actual index: "+h(this.attribute_controller_index),LOG_VGA),this.palette_source!==(a&32)&&(this.palette_source=a&32,this.update_layers());else{if(16>this.attribute_controller_index)dbg_log("internal palette: "+h(this.attribute_controller_index)+" -> "+h(a),LOG_VGA),this.dac_map[this.attribute_controller_index]=
a,this.attribute_mode&64||this.complete_redraw();else switch(this.attribute_controller_index){case 16:dbg_log("3C0 / attribute mode control: "+h(a),LOG_VGA);if(this.attribute_mode!==a){var b=this.attribute_mode;this.attribute_mode=a;var c=0<(a&1);this.svga_enabled||this.graphical_mode===c||(this.graphical_mode=c,this.bus.send("screen-set-mode",this.graphical_mode));(b^a)&64&&this.complete_replot();this.update_vga_size();this.complete_redraw()}break;case 18:dbg_log("3C0 / color plane enable: "+h(a),
LOG_VGA);this.color_plane_enable!==a&&(this.color_plane_enable=a,this.complete_redraw());break;case 19:dbg_log("3C0 / horizontal panning: "+h(a),LOG_VGA);this.horizontal_panning!==a&&(this.horizontal_panning=a&15,this.update_layers());break;case 20:dbg_log("3C0 / color select: "+h(a),LOG_VGA);this.color_select!==a&&(this.color_select=a,this.complete_redraw());break;default:dbg_log("3C0 / attribute controller write "+h(this.attribute_controller_index)+": "+h(a),LOG_VGA)}this.attribute_controller_index=
-1}};VGAScreen.prototype.port3C0_read=function(){dbg_log("3C0 read",LOG_VGA);return this.attribute_controller_index|this.palette_source};VGAScreen.prototype.port3C0_read16=function(){dbg_log("3C0 read16",LOG_VGA);return this.port3C0_read()&255|this.port3C1_read()<<8&65280};
VGAScreen.prototype.port3C1_read=function(){if(16>this.attribute_controller_index)return dbg_log("3C1 / internal palette read: "+h(this.attribute_controller_index)+" -> "+h(this.dac_map[this.attribute_controller_index]),LOG_VGA),this.dac_map[this.attribute_controller_index];switch(this.attribute_controller_index){case 16:return dbg_log("3C1 / attribute mode read: "+h(this.attribute_mode),LOG_VGA),this.attribute_mode;case 18:return dbg_log("3C1 / color plane enable read: "+h(this.color_plane_enable),
LOG_VGA),this.color_plane_enable;case 19:return dbg_log("3C1 / horizontal panning read: "+h(this.horizontal_panning),LOG_VGA),this.horizontal_panning;case 20:return dbg_log("3C1 / color select read: "+h(this.color_select),LOG_VGA),this.color_select;default:dbg_log("3C1 / attribute controller read "+h(this.attribute_controller_index),LOG_VGA)}return-1};VGAScreen.prototype.port3C2_write=function(a){dbg_log("3C2 / miscellaneous output register = "+h(a),LOG_VGA);this.miscellaneous_output_register=a};
VGAScreen.prototype.port3C4_write=function(a){this.sequencer_index=a};VGAScreen.prototype.port3C4_read=function(){return this.sequencer_index};
VGAScreen.prototype.port3C5_write=function(a){switch(this.sequencer_index){case 1:dbg_log("clocking mode: "+h(a),LOG_VGA);var b=this.clocking_mode;this.clocking_mode=a;(b^a)&32&&this.update_layers();break;case 2:dbg_log("plane write mask: "+h(a),LOG_VGA);this.plane_write_bm=a;break;case 4:dbg_log("sequencer memory mode: "+h(a),LOG_VGA);this.sequencer_memory_mode=a;break;default:dbg_log("3C5 / sequencer write "+h(this.sequencer_index)+": "+h(a),LOG_VGA)}};
VGAScreen.prototype.port3C5_read=function(){dbg_log("3C5 / sequencer read "+h(this.sequencer_index),LOG_VGA);switch(this.sequencer_index){case 1:return this.clocking_mode;case 2:return this.plane_write_bm;case 4:return this.sequencer_memory_mode;case 6:return 18}return 0};VGAScreen.prototype.port3C7_write=function(a){dbg_log("3C7 write: "+h(a),LOG_VGA);this.dac_color_index_read=3*a;this.dac_state&=0};VGAScreen.prototype.port3C7_read=function(){return this.dac_state};
VGAScreen.prototype.port3C8_write=function(a){this.dac_color_index_write=3*a;this.dac_state|=3};VGAScreen.prototype.port3C8_read=function(){return this.dac_color_index_write/3|0};
VGAScreen.prototype.port3C9_write=function(a){var b=this.dac_color_index_write/3|0,c=this.dac_color_index_write%3,d=this.vga256_palette[b];a=255*(a&63)/63|0;0===c?d=d&-16711681|a<<16:1===c?d=d&-65281|a<<8:(d=d&-256|a,dbg_log("dac set color, index="+h(b)+" value="+h(d),LOG_VGA));this.vga256_palette[b]!==d&&(this.vga256_palette[b]=d,this.complete_redraw());this.dac_color_index_write++};
VGAScreen.prototype.port3C9_read=function(){dbg_log("3C9 read",LOG_VGA);var a=this.dac_color_index_read%3,b=this.vga256_palette[this.dac_color_index_read/3|0];this.dac_color_index_read++;return(b>>8*(2-a)&255)/255*63|0};VGAScreen.prototype.port3CC_read=function(){dbg_log("3CC read",LOG_VGA);return this.miscellaneous_output_register};VGAScreen.prototype.port3CE_write=function(a){this.graphics_index=a};VGAScreen.prototype.port3CE_read=function(){return this.graphics_index};
VGAScreen.prototype.port3CF_write=function(a){switch(this.graphics_index){case 0:this.planar_setreset=a;dbg_log("plane set/reset: "+h(a),LOG_VGA);break;case 1:this.planar_setreset_enable=a;dbg_log("plane set/reset enable: "+h(a),LOG_VGA);break;case 2:this.color_compare=a;dbg_log("color compare: "+h(a),LOG_VGA);break;case 3:this.planar_rotate_reg=a;dbg_log("plane rotate: "+h(a),LOG_VGA);break;case 4:this.plane_read=a;dbg_log("plane read: "+h(a),LOG_VGA);break;case 5:var b=this.planar_mode;this.planar_mode=
a;dbg_log("planar mode: "+h(a),LOG_VGA);(b^a)&96&&this.complete_replot();break;case 6:dbg_log("miscellaneous graphics register: "+h(a),LOG_VGA);this.miscellaneous_graphics_register!==a&&(this.miscellaneous_graphics_register=a,this.update_vga_size());break;case 7:this.color_dont_care=a;dbg_log("color don't care: "+h(a),LOG_VGA);break;case 8:this.planar_bitmap=a;dbg_log("planar bitmap: "+h(a),LOG_VGA);break;default:dbg_log("3CF / graphics write "+h(this.graphics_index)+": "+h(a),LOG_VGA)}};
VGAScreen.prototype.port3CF_read=function(){dbg_log("3CF / graphics read "+h(this.graphics_index),LOG_VGA);switch(this.graphics_index){case 0:return this.planar_setreset;case 1:return this.planar_setreset_enable;case 2:return this.color_compare;case 3:return this.planar_rotate_reg;case 4:return this.plane_read;case 5:return this.planar_mode;case 6:return this.miscellaneous_graphics_register;case 7:return this.color_dont_care;case 8:return this.planar_bitmap}return 0};
VGAScreen.prototype.port3D4_write=function(a){dbg_log("3D4 / crtc index: "+a,LOG_VGA);this.index_crtc=a};VGAScreen.prototype.port3D4_read=function(){dbg_log("3D4 read / crtc index: "+this.index_crtc,LOG_VGA);return this.index_crtc};
VGAScreen.prototype.port3D5_write=function(a){switch(this.index_crtc){case 1:dbg_log("3D5 / hdisp enable end write: "+h(a),LOG_VGA);this.horizontal_display_enable_end!==a&&(this.horizontal_display_enable_end=a,this.update_vga_size());break;case 2:this.horizontal_blank_start!==a&&(this.horizontal_blank_start=a,this.update_vga_size());break;case 7:dbg_log("3D5 / overflow register write: "+h(a),LOG_VGA);var b=this.vertical_display_enable_end;this.vertical_display_enable_end&=255;this.vertical_display_enable_end=
this.vertical_display_enable_end|a<<3&512|a<<7&256;b!=this.vertical_display_enable_end&&this.update_vga_size();this.line_compare=this.line_compare&767|a<<4&256;b=this.vertical_blank_start;this.vertical_blank_start=this.vertical_blank_start&767|a<<5&256;b!==this.vertical_blank_start&&this.update_vga_size();this.update_layers();break;case 8:dbg_log("3D5 / preset row scan write: "+h(a),LOG_VGA);this.preset_row_scan=a;this.update_layers();break;case 9:dbg_log("3D5 / max scan line write: "+h(a),LOG_VGA);
this.max_scan_line=a;this.line_compare=this.line_compare&511|a<<3&512;b=this.vertical_blank_start;this.vertical_blank_start=this.vertical_blank_start&511|a<<4&512;b!==this.vertical_blank_start&&this.update_vga_size();this.update_layers();break;case 10:dbg_log("3D5 / cursor scanline start write: "+h(a),LOG_VGA);this.cursor_scanline_start=a;this.update_cursor_scanline();break;case 11:dbg_log("3D5 / cursor scanline end write: "+h(a),LOG_VGA);this.cursor_scanline_end=a;this.update_cursor_scanline();break;
case 12:(this.start_address>>8&255)!==a&&(this.start_address=this.start_address&255|a<<8,this.update_layers(),~this.crtc_mode&3&&this.complete_replot());dbg_log("3D5 / start addr hi write: "+h(a)+" -> "+h(this.start_address,4),LOG_VGA);break;case 13:(this.start_address&255)!==a&&(this.start_address=this.start_address&65280|a,this.update_layers(),~this.crtc_mode&3&&this.complete_replot());dbg_log("3D5 / start addr lo write: "+h(a)+" -> "+h(this.start_address,4),LOG_VGA);break;case 14:dbg_log("3D5 / cursor address hi write: "+
h(a),LOG_VGA);this.cursor_address=this.cursor_address&255|a<<8;this.update_cursor();break;case 15:dbg_log("3D5 / cursor address lo write: "+h(a),LOG_VGA);this.cursor_address=this.cursor_address&65280|a;this.update_cursor();break;case 18:dbg_log("3D5 / vdisp enable end write: "+h(a),LOG_VGA);(this.vertical_display_enable_end&255)!==a&&(this.vertical_display_enable_end=this.vertical_display_enable_end&768|a,this.update_vga_size());break;case 19:dbg_log("3D5 / offset register write: "+h(a),LOG_VGA);
this.offset_register!==a&&(this.offset_register=a,this.update_vga_size(),~this.crtc_mode&3&&this.complete_replot());break;case 20:dbg_log("3D5 / underline location write: "+h(a),LOG_VGA);this.underline_location_register!==a&&(b=this.underline_location_register,this.underline_location_register=a,this.update_vga_size(),(b^a)&64&&this.complete_replot());break;case 21:dbg_log("3D5 / vertical blank start write: "+h(a),LOG_VGA);(this.vertical_blank_start&255)!==a&&(this.vertical_blank_start=this.vertical_blank_start&
768|a,this.update_vga_size());break;case 23:dbg_log("3D5 / crtc mode write: "+h(a),LOG_VGA);this.crtc_mode!==a&&(b=this.crtc_mode,this.crtc_mode=a,this.update_vga_size(),(b^a)&67&&this.complete_replot());break;case 24:dbg_log("3D5 / line compare write: "+h(a),LOG_VGA);this.line_compare=this.line_compare&768|a;this.update_layers();break;default:this.index_crtc<this.crtc.length&&(this.crtc[this.index_crtc]=a),dbg_log("3D5 / CRTC write "+h(this.index_crtc)+": "+h(a),LOG_VGA)}};
VGAScreen.prototype.port3D5_read=function(){dbg_log("3D5 read "+h(this.index_crtc),LOG_VGA);switch(this.index_crtc){case 1:return this.horizontal_display_enable_end;case 2:return this.horizontal_blank_start;case 7:return this.vertical_display_enable_end>>7&2|this.vertical_blank_start>>5&8|this.line_compare>>4&16|this.vertical_display_enable_end>>3&64;case 8:return this.preset_row_scan;case 9:return this.max_scan_line;case 10:return this.cursor_scanline_start;case 11:return this.cursor_scanline_end;
case 12:return this.start_address&255;case 13:return this.start_address>>8;case 14:return this.cursor_address>>8;case 15:return this.cursor_address&255;case 18:return this.vertical_display_enable_end&255;case 19:return this.offset_register;case 20:return this.underline_location_register;case 21:return this.vertical_blank_start&255;case 23:return this.crtc_mode;case 24:return this.line_compare&255}return this.index_crtc<this.crtc.length?this.crtc[this.index_crtc]:0};
VGAScreen.prototype.port3DA_read=function(){dbg_log("3DA read - status 1 and clear attr index",LOG_VGA);var a=this.port_3DA_value;this.graphical_mode?(this.port_3DA_value^=1,this.port_3DA_value&=1):(this.port_3DA_value&1&&(this.port_3DA_value^=8),this.port_3DA_value^=1);this.attribute_controller_index=-1;return a};VGAScreen.prototype.svga_bytes_per_line=function(){return this.svga_width*(15===this.svga_bpp?16:this.svga_bpp)/8};VGAScreen.prototype.port1CE_write=function(a){this.dispi_index=a};
VGAScreen.prototype.port1CF_write=function(a){dbg_log("1CF / dispi write "+h(this.dispi_index)+": "+h(a),LOG_VGA);switch(this.dispi_index){case 1:this.svga_width=a;this.svga_width>MAX_XRES&&(dbg_log("svga_width reduced from "+this.svga_width+" to "+MAX_XRES,LOG_VGA),this.svga_width=MAX_XRES);break;case 2:this.svga_height=a;this.svga_height>MAX_YRES&&(dbg_log("svga_height reduced from "+this.svga_height+" to "+MAX_YRES,LOG_VGA),this.svga_height=MAX_YRES);break;case 3:this.svga_bpp=a;break;case 4:this.svga_enabled=
1===(a&1);this.dispi_enable_value=a;break;case 5:this.svga_bank_offset=a<<16;break;case 9:this.svga_offset=a*this.svga_bytes_per_line(),dbg_log("SVGA offset: "+h(this.svga_offset)+" y="+h(a),LOG_VGA),this.complete_redraw()}!this.svga_enabled||this.svga_width&&this.svga_height||(dbg_log("SVGA: disabled because of invalid width/height: "+this.svga_width+"x"+this.svga_height,LOG_VGA),this.svga_enabled=!1);dbg_assert(4!==this.svga_bpp,"unimplemented svga bpp: 4");dbg_assert(15!==this.svga_bpp,"unimplemented svga bpp: 15");
dbg_assert(4===this.svga_bpp||8===this.svga_bpp||15===this.svga_bpp||16===this.svga_bpp||24===this.svga_bpp||32===this.svga_bpp,"unexpected svga bpp: "+this.svga_bpp);dbg_log("SVGA: enabled="+this.svga_enabled+", "+this.svga_width+"x"+this.svga_height+"x"+this.svga_bpp,LOG_VGA);this.svga_enabled&&4===this.dispi_index&&(this.set_size_graphical(this.svga_width,this.svga_height,this.svga_bpp,this.svga_width,this.svga_height),this.bus.send("screen-set-mode",!0),this.graphical_mode_is_linear=this.graphical_mode=
!0);this.svga_enabled||(this.svga_bank_offset=0);this.update_layers()};VGAScreen.prototype.port1CF_read=function(){dbg_log("1CF / dispi read "+h(this.dispi_index),LOG_VGA);return this.svga_register_read(this.dispi_index)};
VGAScreen.prototype.svga_register_read=function(a){switch(a){case 0:return 45248;case 1:return this.dispi_enable_value&2?MAX_XRES:this.svga_width;case 2:return this.dispi_enable_value&2?MAX_YRES:this.svga_height;case 3:return this.dispi_enable_value&2?MAX_BPP:this.svga_bpp;case 4:return this.dispi_enable_value;case 5:return this.svga_bank_offset>>>16;case 6:return this.screen_width?this.screen_width:1;case 8:return 0;case 10:return this.vga_memory_size/VGA_BANK_SIZE|0}return 255};
VGAScreen.prototype.vga_replot=function(){for(var a=this.diff_plot_min&-16,b=Math.min(this.diff_plot_max|15,VGA_PIXEL_BUFFER_SIZE-1),c=this.vga_addr_shift_count(),d=~this.crtc_mode&3,e=this.planar_mode&96,f=this.attribute_mode&64;a<=b;){var g=a>>>c;if(d){var k=a/this.virtual_width|0,l=a-this.virtual_width*k;switch(d){case 1:g=(k&1)<<13;k>>>=1;break;case 2:g=(k&1)<<14;k>>>=1;break;case 3:g=(k&3)<<13,k>>>=2}g|=(k*this.virtual_width+l>>>c)+this.start_address}k=this.plane0[g];l=this.plane1[g];var m=this.plane2[g],
p=this.plane3[g];g=new Uint8Array(8);switch(e){case 0:k<<=0;l<<=1;m<<=2;p<<=3;for(var n=7;0<=n;n--)g[7-n]=k>>n&1|l>>n&2|m>>n&4|p>>n&8;break;case 32:g[0]=k>>6&3|m>>4&12;g[1]=k>>4&3|m>>2&12;g[2]=k>>2&3|m>>0&12;g[3]=k>>0&3|m<<2&12;g[4]=l>>6&3|p>>4&12;g[5]=l>>4&3|p>>2&12;g[6]=l>>2&3|p>>0&12;g[7]=l>>0&3|p<<2&12;break;case 64:case 96:g[0]=k>>4&15,g[1]=k>>0&15,g[2]=l>>4&15,g[3]=l>>0&15,g[4]=m>>4&15,g[5]=m>>0&15,g[6]=p>>4&15,g[7]=p>>0&15}if(f)for(k=n=0;4>n;n++,a++,k+=2)this.pixel_buffer[a]=g[k]<<4|g[k+1];
else for(n=0;8>n;n++,a++)this.pixel_buffer[a]=g[n]}};
VGAScreen.prototype.vga_redraw=function(){var a=this.diff_addr_min,b=Math.min(this.diff_addr_max,VGA_PIXEL_BUFFER_SIZE-1),c=this.dest_buffer;if(c){var d=255,e=0;this.attribute_mode&128&&(d&=207,e|=this.color_select<<4&48);if(this.attribute_mode&64)for(;a<=b;a++){var f=this.pixel_buffer[a]&d|e;f=this.vga256_palette[f];c[a]=f&65280|f<<16|f>>16|4278190080}else for(d&=63,e|=this.color_select<<4&192;a<=b;a++)f=this.dac_map[this.pixel_buffer[a]&this.color_plane_enable]&d|e,f=this.vga256_palette[f],c[a]=
f&65280|f<<16|f>>16|4278190080}};
VGAScreen.prototype.screen_fill_buffer=function(){if(this.graphical_mode)if(this.dest_buffer)if(this.diff_addr_max<this.diff_addr_min&&this.diff_plot_max<this.diff_plot_min)this.bus.send("screen-fill-buffer-end",this.layers);else{if(this.svga_enabled){var a=this.svga_bpp,b=this.dest_buffer,c=this.diff_addr_min,d=this.diff_addr_max;switch(a){case 32:var e=c>>2,f=(d>>2)+1;for(a=e;a<f;a++)d=this.svga_memory32[a],b[a]=d<<16|d>>16&255|d&65280|4278190080;break;case 24:e=c/3|0;f=(d/3|0)+1;var g=3*e;for(a=
e;g<d;a++){var k=this.svga_memory[g++];c=this.svga_memory[g++];var l=this.svga_memory[g++];b[a]=k<<16|c<<8|l|4278190080}break;case 16:e=c>>1;f=(d>>1)+1;for(a=e;a<f;a++)d=this.svga_memory16[a],l=255*(d>>11)/31|0,c=255*(d>>5&63)/63|0,k=255*(d&31)/31|0,b[a]=k<<16|c<<8|l|4278190080;break;case 8:e=c;f=d+1;for(a=c;a<=d;a++)c=this.vga256_palette[this.svga_memory[a]],b[a]=c&65280|c<<16|c>>16|4278190080;break;default:dbg_assert(!1,"Unsupported BPP: "+a)}b=e/this.svga_width|0;this.bus.send("screen-fill-buffer-end",
[{screen_x:0,screen_y:b,buffer_x:0,buffer_y:b,buffer_width:this.svga_width,buffer_height:(f/this.svga_width|0)-b+1}])}else this.vga_replot(),this.vga_redraw(),this.bus.send("screen-fill-buffer-end",this.layers);this.reset_diffs()}else dbg_log("Cannot fill buffer: No destination buffer",LOG_VGA);this.update_vertical_retrace()};function PS2(a,b){this.cpu=a;this.bus=b;this.use_mouse=this.enable_mouse_stream=!1;this.have_mouse=!0;this.mouse_clicks=this.mouse_delta_y=this.mouse_delta_x=0;this.have_keyboard=!0;this.next_read_resolution=this.next_read_rate=this.next_handle_scan_code_set=this.next_read_led=this.next_read_sample=this.next_is_mouse_command=this.enable_keyboard_stream=!1;this.kbd_buffer=new ByteQueue(1024);this.last_port60_byte=0;this.sample_rate=100;this.resolution=4;this.scaling2=!1;this.last_mouse_packet=-1;this.mouse_buffer=
new ByteQueue(1024);this.next_byte_is_aux=this.next_byte_is_ready=!1;this.bus.register("keyboard-code",function(a){this.kbd_send_code(a)},this);this.bus.register("mouse-click",function(a){this.mouse_send_click(a[0],a[1],a[2])},this);this.bus.register("mouse-delta",function(a){this.mouse_send_delta(a[0],a[1])},this);this.bus.register("mouse-wheel",function(a){},this);this.command_register=5;this.read_command_register=this.read_output_register=!1;a.io.register_read(96,this,this.port60_read);a.io.register_read(100,
this,this.port64_read);a.io.register_write(96,this,this.port60_write);a.io.register_write(100,this,this.port64_write)}
PS2.prototype.get_state=function(){var a=[];a[0]=this.enable_mouse_stream;a[1]=this.use_mouse;a[2]=this.have_mouse;a[3]=this.mouse_delta_x;a[4]=this.mouse_delta_y;a[5]=this.mouse_clicks;a[6]=this.have_keyboard;a[7]=this.enable_keyboard_stream;a[8]=this.next_is_mouse_command;a[9]=this.next_read_sample;a[10]=this.next_read_led;a[11]=this.next_handle_scan_code_set;a[12]=this.next_read_rate;a[13]=this.next_read_resolution;a[15]=this.last_port60_byte;a[16]=this.sample_rate;a[17]=this.resolution;a[18]=
this.scaling2;a[20]=this.command_register;a[21]=this.read_output_register;a[22]=this.read_command_register;return a};
PS2.prototype.set_state=function(a){this.enable_mouse_stream=a[0];this.use_mouse=a[1];this.have_mouse=a[2];this.mouse_delta_x=a[3];this.mouse_delta_y=a[4];this.mouse_clicks=a[5];this.have_keyboard=a[6];this.enable_keyboard_stream=a[7];this.next_is_mouse_command=a[8];this.next_read_sample=a[9];this.next_read_led=a[10];this.next_handle_scan_code_set=a[11];this.next_read_rate=a[12];this.next_read_resolution=a[13];this.last_port60_byte=a[15];this.sample_rate=a[16];this.resolution=a[17];this.scaling2=
a[18];this.command_register=a[20];this.read_output_register=a[21];this.read_command_register=a[22];this.next_byte_is_aux=this.next_byte_is_ready=!1;this.kbd_buffer.clear();this.mouse_buffer.clear();this.bus.send("mouse-enable",this.use_mouse)};PS2.prototype.raise_irq=function(){this.next_byte_is_ready||(this.kbd_buffer.length?this.kbd_irq():this.mouse_buffer.length&&this.mouse_irq())};
PS2.prototype.mouse_irq=function(){this.next_byte_is_aux=this.next_byte_is_ready=!0;this.command_register&2&&(dbg_log("Mouse irq",LOG_PS2),this.cpu.device_lower_irq(12),this.cpu.device_raise_irq(12))};PS2.prototype.kbd_irq=function(){this.next_byte_is_ready=!0;this.next_byte_is_aux=!1;this.command_register&1&&(dbg_log("Keyboard irq",LOG_PS2),this.cpu.device_lower_irq(1),this.cpu.device_raise_irq(1))};
PS2.prototype.kbd_send_code=function(a){this.enable_keyboard_stream&&(dbg_log("adding kbd code: "+h(a),LOG_PS2),this.kbd_buffer.push(a),this.raise_irq())};PS2.prototype.mouse_send_delta=function(a,b){if(this.have_mouse&&this.use_mouse){var c=this.resolution*this.sample_rate/80;this.mouse_delta_x+=a*c;this.mouse_delta_y+=b*c;this.enable_mouse_stream&&(a=this.mouse_delta_x|0,b=this.mouse_delta_y|0,a||b)&&(Date.now(),this.mouse_delta_x-=a,this.mouse_delta_y-=b,this.send_mouse_packet(a,b))}};
PS2.prototype.mouse_send_click=function(a,b,c){this.have_mouse&&this.use_mouse&&(this.mouse_clicks=a|c<<1|b<<2,this.enable_mouse_stream&&this.send_mouse_packet(0,0))};PS2.prototype.send_mouse_packet=function(a,b){var c=(0>b)<<5|(0>a)<<4|8|this.mouse_clicks;this.last_mouse_packet=Date.now();this.mouse_buffer.push(c);this.mouse_buffer.push(a);this.mouse_buffer.push(b);dbg_log("adding mouse packets: "+[c,a,b],LOG_PS2);this.raise_irq()};
PS2.prototype.apply_scaling2=function(a){var b=a>>31;switch(Math.abs(a)){case 0:case 1:case 3:return a;case 2:return b;case 4:return 6*b;case 5:return 9*b;default:return a<<1}};
PS2.prototype.port60_read=function(){this.next_byte_is_ready=!1;if(!this.kbd_buffer.length&&!this.mouse_buffer.length)return dbg_log("Port 60 read: Empty",LOG_PS2),this.last_port60_byte;this.next_byte_is_aux?(this.cpu.device_lower_irq(12),this.last_port60_byte=this.mouse_buffer.shift(),dbg_log("Port 60 read (mouse): "+h(this.last_port60_byte),LOG_PS2)):(this.cpu.device_lower_irq(1),this.last_port60_byte=this.kbd_buffer.shift(),dbg_log("Port 60 read (kbd)  : "+h(this.last_port60_byte),LOG_PS2));(this.kbd_buffer.length||
this.mouse_buffer.length)&&this.raise_irq();return this.last_port60_byte};PS2.prototype.port64_read=function(){var a=16;this.next_byte_is_ready&&(a|=1);this.next_byte_is_aux&&(a|=32);dbg_log("port 64 read: "+h(a),LOG_PS2);return a};
PS2.prototype.port60_write=function(a){dbg_log("port 60 write: "+h(a),LOG_PS2);if(this.read_command_register)this.command_register=a,this.read_command_register=!1,dbg_log("Keyboard command register = "+h(this.command_register),LOG_PS2);else if(this.read_output_register)this.read_output_register=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(a),this.mouse_irq();else if(this.next_read_sample)this.next_read_sample=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),this.sample_rate=a,dbg_log("mouse sample rate: "+
h(a),LOG_PS2),this.sample_rate||(dbg_log("invalid sample rate, reset to 100",LOG_PS2),this.sample_rate=100),this.mouse_irq();else if(this.next_read_resolution)this.next_read_resolution=!1,this.mouse_buffer.clear(),this.mouse_buffer.push(250),3<a?(this.resolution=4,dbg_log("invalid resolution, resetting to 4",LOG_PS2)):(this.resolution=1<<a,dbg_log("resolution: "+this.resolution,LOG_PS2)),this.mouse_irq();else if(this.next_read_led)this.next_read_led=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_handle_scan_code_set)this.next_handle_scan_code_set=
!1,this.kbd_buffer.push(250),this.kbd_irq(),a||this.kbd_buffer.push(2);else if(this.next_read_rate)this.next_read_rate=!1,this.kbd_buffer.push(250),this.kbd_irq();else if(this.next_is_mouse_command){if(this.next_is_mouse_command=!1,dbg_log("Port 60 data register write: "+h(a),LOG_PS2),this.have_mouse){this.kbd_buffer.clear();this.mouse_buffer.clear();this.mouse_buffer.push(250);switch(a){case 230:dbg_log("Scaling 1:1",LOG_PS2);this.scaling2=!1;break;case 231:dbg_log("Scaling 2:1",LOG_PS2);this.scaling2=
!0;break;case 232:this.next_read_resolution=!0;break;case 233:this.send_mouse_packet(0,0);break;case 235:dbg_log("unimplemented request single packet",LOG_PS2);this.send_mouse_packet(0,0);break;case 242:this.mouse_buffer.push(0);this.mouse_buffer.push(0);this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;case 243:this.next_read_sample=!0;break;case 244:this.use_mouse=this.enable_mouse_stream=!0;this.bus.send("mouse-enable",!0);this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;
break;case 245:this.enable_mouse_stream=!1;break;case 246:this.enable_mouse_stream=!1;this.sample_rate=100;this.scaling2=!1;this.resolution=4;break;case 255:dbg_log("Mouse reset",LOG_PS2);this.mouse_buffer.push(170);this.mouse_buffer.push(0);this.use_mouse=!0;this.bus.send("mouse-enable",!0);this.enable_mouse_stream=!1;this.sample_rate=100;this.scaling2=!1;this.resolution=4;this.mouse_clicks=this.mouse_delta_x=this.mouse_delta_y=0;break;default:dbg_log("Unimplemented mouse command: "+h(a),LOG_PS2)}this.mouse_irq()}}else{dbg_log("Port 60 data register write: "+
h(a),LOG_PS2);this.mouse_buffer.clear();this.kbd_buffer.clear();this.kbd_buffer.push(250);switch(a){case 237:this.next_read_led=!0;break;case 240:this.next_handle_scan_code_set=!0;break;case 242:this.kbd_buffer.push(171);this.kbd_buffer.push(83);break;case 243:this.next_read_rate=!0;break;case 244:dbg_log("kbd enable scanning",LOG_PS2);this.enable_keyboard_stream=!0;break;case 245:dbg_log("kbd disable scanning",LOG_PS2);this.enable_keyboard_stream=!1;break;case 246:break;case 255:this.kbd_buffer.clear();
this.kbd_buffer.push(250);this.kbd_buffer.push(170);this.kbd_buffer.push(0);break;default:dbg_log("Unimplemented keyboard command: "+h(a),LOG_PS2)}this.kbd_irq()}};
PS2.prototype.port64_write=function(a){dbg_log("port 64 write: "+h(a),LOG_PS2);switch(a){case 32:this.kbd_buffer.clear();this.mouse_buffer.clear();this.kbd_buffer.push(this.command_register);this.kbd_irq();break;case 96:this.read_command_register=!0;break;case 211:this.read_output_register=!0;break;case 212:this.next_is_mouse_command=!0;break;case 167:dbg_log("Disable second port",LOG_PS2);this.command_register|=32;break;case 168:dbg_log("Enable second port",LOG_PS2);this.command_register&=-33;break;
case 169:this.kbd_buffer.clear();this.mouse_buffer.clear();this.kbd_buffer.push(0);this.kbd_irq();break;case 170:this.kbd_buffer.clear();this.mouse_buffer.clear();this.kbd_buffer.push(85);this.kbd_irq();break;case 171:this.kbd_buffer.clear();this.mouse_buffer.clear();this.kbd_buffer.push(0);this.kbd_irq();break;case 173:dbg_log("Disable Keyboard",LOG_PS2);this.command_register|=16;break;case 174:dbg_log("Enable Keyboard",LOG_PS2);this.command_register&=-17;break;case 254:dbg_log("CPU reboot via PS2");
this.cpu.reboot_internal();break;default:dbg_log("port 64: Unimplemented command byte: "+h(a),LOG_PS2)}};var PIC_LOG_VERBOSE=!1;
function PIC(a,b){this.irq_value=this.irr=this.isr=this.irq_map=this.irq_mask=0;this.requested_irq=-1;this.master=b;this.is_master=void 0===this.master;this.slave=void 0;this.name=this.is_master?"master":"slave ";this.expect_icw4=!1;this.read_isr=this.state=0;this.auto_eoi=1;this.elcr=this.special_mask_mode=0;this.cpu=a;this.is_master?(this.slave=new PIC(this.cpu,this),this.check_irqs=function(){if(0<=this.requested_irq)PIC_LOG_VERBOSE&&dbg_log("master> Already requested irq: "+this.requested_irq,
LOG_PIC),this.cpu.handle_irqs();else{var a=this.irr&this.irq_mask;if(a){a&=-a;var b=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&b)<=a?dbg_log("master> higher prio: isr="+h(this.isr,2)+" mask="+h(this.irq_mask&255,2)+" irq="+h(a,2),LOG_PIC):(dbg_assert(0!==a),b=v86util.int_log2_byte(a),dbg_assert(a===1<<b),PIC_LOG_VERBOSE&&dbg_log("master> request irq "+b,LOG_PIC),this.requested_irq=b,this.cpu.handle_irqs())}else PIC_LOG_VERBOSE&&dbg_log("master> no unmasked irrs. irr="+h(this.irr,
2)+" mask="+h(this.irq_mask&255,2)+" isr="+h(this.isr,2),LOG_PIC)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)PIC_LOG_VERBOSE&&dbg_log("master> spurious requested="+this.requested_irq,LOG_PIC),this.requested_irq=-1,this.cpu.pic_call_irq(this.irq_map|7);else{dbg_assert(this.irr);dbg_assert(0<=this.requested_irq);var a=1<<this.requested_irq;0===(this.elcr&a)&&(this.irr&=~a);this.auto_eoi||(this.isr|=a);PIC_LOG_VERBOSE&&dbg_log("master> acknowledge "+this.requested_irq,
LOG_PIC);2===this.requested_irq?this.slave.acknowledge_irq():this.cpu.pic_call_irq(this.irq_map|this.requested_irq);this.requested_irq=-1;this.check_irqs()}}):(this.check_irqs=function(){if(0<=this.requested_irq)PIC_LOG_VERBOSE&&dbg_log("slave > Already requested irq: "+this.requested_irq,LOG_PIC),this.cpu.handle_irqs();else{var a=this.irr&this.irq_mask;if(a){a&=-a;var b=this.special_mask_mode?this.irq_mask:-1;this.isr&&(this.isr&-this.isr&b)<=a?PIC_LOG_VERBOSE&&dbg_log("slave > higher prio: isr="+
h(this.isr,2)+" irq="+h(a,2),LOG_PIC):(dbg_assert(0!==a),b=v86util.int_log2_byte(a),dbg_assert(a===1<<b),PIC_LOG_VERBOSE&&dbg_log("slave > request irq "+b,LOG_PIC),this.requested_irq=b,this.master.set_irq(2))}else PIC_LOG_VERBOSE&&dbg_log("slave > no unmasked irrs. irr="+h(this.irr,2)+" mask="+h(this.irq_mask&255,2)+" isr="+h(this.isr,2),LOG_PIC)}},this.acknowledge_irq=function(){if(-1!==this.requested_irq)if(0===this.irr)PIC_LOG_VERBOSE&&dbg_log("slave > spurious requested="+this.requested_irq,LOG_PIC),
this.requested_irq=-1,this.master.irq_value&=-5,this.cpu.pic_call_irq(this.irq_map|7);else{dbg_assert(this.irr);dbg_assert(0<=this.requested_irq);var a=1<<this.requested_irq;0===(this.elcr&a)&&(this.irr&=~a);this.auto_eoi||(this.isr|=a);this.master.irq_value&=-5;PIC_LOG_VERBOSE&&dbg_log("slave > acknowledge "+this.requested_irq,LOG_PIC);this.cpu.pic_call_irq(this.irq_map|this.requested_irq);this.requested_irq=-1;this.check_irqs()}});this.dump=function(){dbg_log("mask: "+h(this.irq_mask&255),LOG_PIC);
dbg_log("base: "+h(this.irq_map),LOG_PIC);dbg_log("requested: "+h(this.irr),LOG_PIC);dbg_log("serviced: "+h(this.isr),LOG_PIC);this.is_master&&this.slave.dump()};this.is_master?(a=32,b=1232):(a=160,b=1233);this.cpu.io.register_write(a,this,this.port20_write);this.cpu.io.register_read(a,this,this.port20_read);this.cpu.io.register_write(a|1,this,this.port21_write);this.cpu.io.register_read(a|1,this,this.port21_read);this.cpu.io.register_write(b,this,this.port4D0_write);this.cpu.io.register_read(b,this,
this.port4D0_read);this.is_master?(this.set_irq=function(a){dbg_assert(0<=a&&16>a);8<=a?this.slave.set_irq(a-8):(PIC_LOG_VERBOSE&&dbg_log("master> set irq "+a,LOG_PIC),a=1<<a,0===(this.irq_value&a)&&(this.irr|=a,this.irq_value|=a,this.check_irqs()))},this.clear_irq=function(a){dbg_assert(0<=a&&16>a);PIC_LOG_VERBOSE&&dbg_log("master> clear irq "+a,LOG_PIC);8<=a?this.slave.clear_irq(a-8):(a=1<<a,this.irq_value&a&&(this.irq_value&=~a,this.irr&=~a,this.check_irqs()))}):(this.set_irq=function(a){dbg_assert(0<=
a&&8>a);PIC_LOG_VERBOSE&&dbg_log("slave > set irq "+a,LOG_PIC);a=1<<a;0===(this.irq_value&a)&&(this.irr|=a,this.irq_value|=a,this.check_irqs())},this.clear_irq=function(a){dbg_assert(0<=a&&8>a);PIC_LOG_VERBOSE&&dbg_log("slave > clear irq "+a,LOG_PIC);a=1<<a;this.irq_value&a&&(this.irq_value&=~a,this.irr&=~a,this.check_irqs())});this.get_isr=function(){return this.isr}}
PIC.prototype.get_state=function(){var a=[];a[0]=this.irq_mask;a[1]=this.irq_map;a[2]=this.isr;a[3]=this.irr;a[4]=this.is_master;a[5]=this.slave;a[6]=this.expect_icw4;a[7]=this.state;a[8]=this.read_isr;a[9]=this.auto_eoi;a[10]=this.elcr;return a};PIC.prototype.set_state=function(a){this.irq_mask=a[0];this.irq_map=a[1];this.isr=a[2];this.irr=a[3];this.is_master=a[4];this.slave=a[5];this.expect_icw4=a[6];this.state=a[7];this.read_isr=a[8];this.auto_eoi=a[9];this.elcr=a[10]};
PIC.prototype.port20_write=function(a){if(a&16)dbg_log("icw1 = "+h(a),LOG_PIC),this.irq_value=this.irq_mask=this.irr=this.isr=0,this.auto_eoi=1,this.requested_irq=-1,this.expect_icw4=a&1,this.state=1;else if(a&8)dbg_log("ocw3: "+h(a),LOG_PIC),a&2&&(this.read_isr=a&1),a&4&&dbg_assert(!1,"unimplemented: polling",LOG_PIC),a&64&&(this.special_mask_mode=32===(a&32),dbg_log("special mask mode: "+this.special_mask_mode,LOG_PIC));else{dbg_log("eoi: "+h(a)+" ("+this.name+")",LOG_PIC);var b=a>>5;1===b?(this.isr&=
this.isr-1,dbg_log("new isr: "+h(this.isr,2),LOG_PIC)):3===b?this.isr&=~(1<<(a&7)):192===(a&200)?dbg_log("lowest priority: "+h(a&7),LOG_PIC):(dbg_log("Unknown eoi: "+h(a),LOG_PIC),dbg_assert(!1),this.isr&=this.isr-1);this.check_irqs()}};PIC.prototype.port20_read=function(){if(this.read_isr)return dbg_log("read port 20h (isr): "+h(this.isr),LOG_PIC),this.isr;dbg_log("read port 20h (irr): "+h(this.irr),LOG_PIC);return this.irr};
PIC.prototype.port21_write=function(a){0===this.state?this.expect_icw4?(this.expect_icw4=!1,this.auto_eoi=a&2,dbg_log("icw4: "+h(a)+" autoeoi="+this.auto_eoi,LOG_PIC),0===(a&1)&&dbg_assert(!1,"unimplemented: not 8086 mode",LOG_PIC)):(this.irq_mask=~a,PIC_LOG_VERBOSE&&dbg_log("interrupt mask: "+(this.irq_mask&255).toString(2)+" ("+this.name+")",LOG_PIC),this.check_irqs()):1===this.state?(this.irq_map=a,dbg_log("interrupts are mapped to "+h(this.irq_map)+" ("+this.name+")",LOG_PIC),this.state++):2===
this.state&&(this.state=0,dbg_log("icw3: "+h(a),LOG_PIC))};PIC.prototype.port21_read=function(){dbg_log("21h read "+h(~this.irq_mask&255),LOG_PIC);return~this.irq_mask&255};PIC.prototype.port4D0_read=function(){dbg_log("elcr read: "+h(this.elcr,2),LOG_PIC);return this.elcr};PIC.prototype.port4D0_write=function(a){dbg_log("elcr write: "+h(a,2),LOG_PIC);this.elcr=a};var CMOS_RTC_SECONDS=0,CMOS_RTC_SECONDS_ALARM=1,CMOS_RTC_MINUTES=2,CMOS_RTC_MINUTES_ALARM=3,CMOS_RTC_HOURS=4,CMOS_RTC_HOURS_ALARM=5,CMOS_RTC_DAY_WEEK=6,CMOS_RTC_DAY_MONTH=7,CMOS_RTC_MONTH=8,CMOS_RTC_YEAR=9,CMOS_STATUS_A=10,CMOS_STATUS_B=11,CMOS_STATUS_C=12,CMOS_STATUS_D=13,CMOS_RESET_CODE=15,CMOS_FLOPPY_DRIVE_TYPE=16,CMOS_DISK_DATA=18,CMOS_EQUIPMENT_INFO=20,CMOS_MEM_BASE_LOW=21,CMOS_MEM_BASE_HIGH=22,CMOS_MEM_OLD_EXT_LOW=23,CMOS_MEM_OLD_EXT_HIGH=24,CMOS_DISK_DRIVE1_TYPE=25,CMOS_DISK_DRIVE2_TYPE=26,
CMOS_DISK_DRIVE1_CYL=27,CMOS_DISK_DRIVE2_CYL=36,CMOS_MEM_EXTMEM_LOW=48,CMOS_MEM_EXTMEM_HIGH=49,CMOS_CENTURY=50,CMOS_MEM_EXTMEM2_LOW=52,CMOS_MEM_EXTMEM2_HIGH=53,CMOS_BIOS_BOOTFLAG1=56,CMOS_BIOS_DISKTRANSFLAG=57,CMOS_BIOS_BOOTFLAG2=61,CMOS_MEM_HIGHMEM_LOW=91,CMOS_MEM_HIGHMEM_MID=92,CMOS_MEM_HIGHMEM_HIGH=93,CMOS_BIOS_SMP_COUNT=95;
function RTC(a){this.cpu=a;this.cmos_index=0;this.cmos_data=new Uint8Array(128);this.last_update=this.rtc_time=Date.now();this.next_interrupt=0;this.periodic_interrupt=!1;this.periodic_interrupt_time=.9765625;this.cmos_a=38;this.cmos_b=2;this.nmi_disabled=this.cmos_c=0;a.io.register_write(112,this,function(a){this.cmos_index=a&127;this.nmi_disabled=a>>7});a.io.register_write(113,this,this.cmos_port_write);a.io.register_read(113,this,this.cmos_port_read)}
RTC.prototype.get_state=function(){var a=[];a[0]=this.cmos_index;a[1]=this.cmos_data;a[2]=this.rtc_time;a[3]=this.last_update;a[4]=this.next_interrupt;a[6]=this.periodic_interrupt;a[7]=this.periodic_interrupt_time;a[8]=this.cmos_a;a[9]=this.cmos_b;a[10]=this.cmos_c;a[11]=this.nmi_disabled;return a};
RTC.prototype.set_state=function(a){this.cmos_index=a[0];this.cmos_data=a[1];this.rtc_time=a[2];this.last_update=a[3];this.next_interrupt=a[4];this.periodic_interrupt=a[6];this.periodic_interrupt_time=a[7];this.cmos_a=a[8];this.cmos_b=a[9];this.cmos_c=a[10];this.nmi_disabled=a[11]};
RTC.prototype.timer=function(a,b){a=Date.now();this.rtc_time+=a-this.last_update;this.last_update=a;return this.periodic_interrupt&&this.next_interrupt<a?(this.cpu.device_raise_irq(8),this.cmos_c|=192,this.next_interrupt+=this.periodic_interrupt_time*Math.ceil((a-this.next_interrupt)/this.periodic_interrupt_time),Math.max(0,a-this.next_interrupt)):100};RTC.prototype.bcd_pack=function(a){for(var b=0,c=0,d;a;)d=a%10,c|=d<<4*b,b++,a=(a-d)/10;return c};
RTC.prototype.encode_time=function(a){return this.cmos_b&4?a:this.bcd_pack(a)};
RTC.prototype.cmos_port_read=function(){var a=this.cmos_index;switch(a){case CMOS_RTC_SECONDS:return this.encode_time((new Date(this.rtc_time)).getUTCSeconds());case CMOS_RTC_MINUTES:return this.encode_time((new Date(this.rtc_time)).getUTCMinutes());case CMOS_RTC_HOURS:return this.encode_time((new Date(this.rtc_time)).getUTCHours());case CMOS_RTC_DAY_MONTH:return this.encode_time((new Date(this.rtc_time)).getUTCDate());case CMOS_RTC_MONTH:return this.encode_time((new Date(this.rtc_time)).getUTCMonth()+
1);case CMOS_RTC_YEAR:return this.encode_time((new Date(this.rtc_time)).getUTCFullYear()%100);case CMOS_STATUS_A:return this.cmos_a;case CMOS_STATUS_B:return this.cmos_b;case CMOS_STATUS_C:return this.cpu.device_lower_irq(8),dbg_log("cmos reg C read",LOG_RTC),a=this.cmos_c,this.cmos_c&=-241,a;case CMOS_STATUS_D:return 255;case CMOS_CENTURY:return this.encode_time((new Date(this.rtc_time)).getUTCFullYear()/100|0);default:return dbg_log("cmos read from index "+h(a),LOG_RTC),this.cmos_data[this.cmos_index]}};
RTC.prototype.cmos_port_write=function(a){switch(this.cmos_index){case 10:this.cmos_a=a&127;this.periodic_interrupt_time=1E3/(32768>>(this.cmos_a&15)-1);dbg_log("Periodic interrupt, a="+h(this.cmos_a,2)+" t="+this.periodic_interrupt_time,LOG_RTC);break;case 11:this.cmos_b=a;this.cmos_b&64&&(this.next_interrupt=Date.now());this.cmos_b&32&&dbg_log("Unimplemented: alarm interrupt",LOG_RTC);this.cmos_b&16&&dbg_log("Unimplemented: updated interrupt",LOG_RTC);dbg_log("cmos b="+h(this.cmos_b,2),LOG_RTC);
break;default:dbg_log("cmos write index "+h(this.cmos_index)+": "+h(a),LOG_RTC)}this.periodic_interrupt=64===(this.cmos_b&64)&&0<(this.cmos_a&15)};RTC.prototype.cmos_read=function(a){dbg_assert(128>a);return this.cmos_data[a]};RTC.prototype.cmos_write=function(a,b){dbg_log("cmos "+h(a)+" <- "+h(b),LOG_RTC);dbg_assert(128>a);this.cmos_data[a]=b};var DLAB=128,UART_IER_MSI=8,UART_IER_THRI=2,UART_IER_RDI=1,UART_IIR_MSI=0,UART_IIR_NO_INT=1,UART_IIR_THRI=2,UART_IIR_RDI=4,UART_IIR_RLSI=6,UART_IIR_CTI=12,UART_LSR_DATA_READY=1,UART_LSR_TX_EMPTY=32,UART_LSR_TRANSMITTER_EMPTY=64;
function UART(a,b,c){this.bus=c;this.cpu=a;this.ints=1<<UART_IIR_THRI;this.line_control=this.baud_rate=0;this.lsr=UART_LSR_TRANSMITTER_EMPTY|UART_LSR_TX_EMPTY;this.ier=this.fifo_control=0;this.iir=UART_IIR_NO_INT;this.irq=this.scratch_register=this.modem_status=this.modem_control=0;this.input=new ByteQueue(4096);this.current_line=[];if(1E3===b||1016===b)this.irq=4;else if(1E3===b||1E3===b)this.irq=3;else{dbg_log("Invalid port: "+h(b),LOG_SERIAL);return}this.bus.register("serial0-input",function(a){this.data_received(a)},
this);a=a.io;a.register_write(b,this,function(a){this.write_data(a)},function(a){this.write_data(a&255);this.write_data(a>>8)});a.register_write(b|1,this,function(a){this.line_control&DLAB?(this.baud_rate=this.baud_rate&255|a<<8,dbg_log("baud rate: "+h(this.baud_rate),LOG_SERIAL)):(this.ier=a&15,dbg_log("interrupt enable: "+h(a),LOG_SERIAL),this.CheckInterrupt())});a.register_read(b,this,function(){if(this.line_control&DLAB)return this.baud_rate&255;var a=this.input.shift();-1===a?dbg_log("Read input empty",
LOG_SERIAL):dbg_log("Read input: "+h(a),LOG_SERIAL);0===this.input.length&&(this.lsr&=~UART_LSR_DATA_READY,this.ClearInterrupt(UART_IIR_CTI));return a});a.register_read(b|1,this,function(){return this.line_control&DLAB?this.baud_rate>>8:this.ier&15});a.register_read(b|2,this,function(){var a=this.iir&15|192;dbg_log("read interrupt identification: "+h(this.iir),LOG_SERIAL);this.iir==UART_IIR_THRI&&this.ClearInterrupt(UART_IIR_THRI);return a});a.register_write(b|2,this,function(a){dbg_log("fifo control: "+
h(a),LOG_SERIAL);this.fifo_control=a});a.register_read(b|3,this,function(){dbg_log("read line control: "+h(this.line_control),LOG_SERIAL);return this.line_control});a.register_write(b|3,this,function(a){dbg_log("line control: "+h(a),LOG_SERIAL);this.line_control=a});a.register_read(b|4,this,function(){return this.modem_control});a.register_write(b|4,this,function(a){dbg_log("modem control: "+h(a),LOG_SERIAL);this.modem_control=a});a.register_read(b|5,this,function(){dbg_log("read line status: "+h(this.lsr),
LOG_SERIAL);return this.lsr});a.register_write(b|5,this,function(a){dbg_log("Factory test write",LOG_SERIAL)});a.register_read(b|6,this,function(){dbg_log("read modem status: "+h(this.modem_status),LOG_SERIAL);return this.modem_status});a.register_write(b|6,this,function(a){dbg_log("Unkown register write (base+6)",LOG_SERIAL)});a.register_read(b|7,this,function(){return this.scratch_register});a.register_write(b|7,this,function(a){this.scratch_register=a})}
UART.prototype.get_state=function(){var a=[];a[0]=this.ints;a[1]=this.baud_rate;a[2]=this.line_control;a[3]=this.lsr;a[4]=this.fifo_control;a[5]=this.ier;a[6]=this.iir;a[7]=this.modem_control;a[8]=this.modem_status;a[9]=this.scratch_register;a[10]=this.irq;return a};
UART.prototype.set_state=function(a){this.ints=a[0];this.baud_rate=a[1];this.line_control=a[2];this.lsr=a[3];this.fifo_control=a[4];this.ier=a[5];this.iir=a[6];this.modem_control=a[7];this.modem_status=a[8];this.scratch_register=a[9];this.irq=a[10]};
UART.prototype.CheckInterrupt=function(){this.ints&1<<UART_IIR_CTI&&this.ier&UART_IER_RDI?(this.iir=UART_IIR_CTI,this.cpu.device_raise_irq(this.irq)):this.ints&1<<UART_IIR_THRI&&this.ier&UART_IER_THRI?(this.iir=UART_IIR_THRI,this.cpu.device_raise_irq(this.irq)):this.ints&1<<UART_IIR_MSI&&this.ier&UART_IER_MSI?(this.iir=UART_IIR_MSI,this.cpu.device_raise_irq(this.irq)):(this.iir=UART_IIR_NO_INT,this.cpu.device_lower_irq(this.irq))};UART.prototype.ThrowInterrupt=function(a){this.ints|=1<<a;this.CheckInterrupt()};
UART.prototype.ClearInterrupt=function(a){this.ints&=~(1<<a);this.CheckInterrupt()};UART.prototype.data_received=function(a){dbg_log("input: "+h(a),LOG_SERIAL);this.input.push(a);this.lsr|=UART_LSR_DATA_READY;this.ThrowInterrupt(UART_IIR_CTI)};
UART.prototype.write_data=function(a){if(this.line_control&DLAB)this.baud_rate=this.baud_rate&-256|a;else if(dbg_log("data: "+h(a),LOG_SERIAL),this.ThrowInterrupt(UART_IIR_THRI),255!==a){var b=String.fromCharCode(a);this.bus.send("serial0-output-char",b);this.current_line.push(a);"\n"===b&&(dbg_log("SERIAL: "+String.fromCharCode.apply("",this.current_line).trimRight()),this.bus.send("serial0-output-line",String.fromCharCode.apply("",this.current_line)),this.current_line=[])}};var HPET_ADDR=4275044352,HPET_PERIOD=1E8,HPET_FREQ_MS=1E12/HPET_PERIOD,HPET_SUPPORT_64=0,HPET_COUNTER_CONFIG=16|HPET_SUPPORT_64<<5,HPET_COUNTER_CONFIG_MASK=32816,HPET_NUM_COUNTERS=4;
function HPET(a){function b(){return e?(Date.now()-f)*HPET_FREQ_MS+g|0:g}function c(){return HPET_SUPPORT_64?e?(Date.now()-f)*(HPET_FREQ_MS/4294967296)+k|0:k:0}var d=this,e=!1,f=Date.now(),g=0,k=0,l=!1,m=0,p=new Int32Array(HPET_NUM_COUNTERS<<1),n=new Int32Array(HPET_NUM_COUNTERS<<1),r=new Int32Array(HPET_NUM_COUNTERS<<1),q=0;this.legacy_mode=!1;this.timer=function(c){if(e){c=b()>>>0;for(var d,f,g=0;g<HPET_NUM_COUNTERS;g++)if(d=p[g<<1],f=n[g<<1]>>>0,q<=c?f>q&&f<=c:f>q||f<=c)f=d&4,d&2?(f=f&&!(m&1<<
g),m|=1<<g):m&=~(1<<g),d&8&&(n[g<<1]+=r[g<<1]),f&&a.device_raise_irq(0);q=c}};a.io.mmap_register(HPET_ADDR,16384,function(a){dbg_log("Read "+h(a,4)+" (ctr="+h(b()>>>0)+")",LOG_HPET);switch(a){case 0:return HPET_NUM_COUNTERS-1<<8|98305|HPET_SUPPORT_64<<13;case 4:return HPET_PERIOD;case 16:return d.legacy_mode<<1|e;case 240:return b();case 244:return c()}var f=a>>2&7,g=a-256>>5;if(256>a||g>=HPET_NUM_COUNTERS||5<f)return dbg_log("Read reserved address: "+h(a),LOG_HPET),0;dbg_log("Read counter: addr="+
h(a)+" counter="+h(g,2)+" reg="+h(f),LOG_HPET);switch(f){case 0:return p[g<<1]&~HPET_COUNTER_CONFIG_MASK|HPET_COUNTER_CONFIG;case 1:return p[g<<1|1];case 2:return n[g<<1];case 3:return n[g<<1|1];case 4:case 5:return 0}},function(a,q){dbg_log("Write "+h(a,4)+": "+h(q,2),LOG_HPET);switch(a){case 16:dbg_log("conf: enabled="+(q&1)+" legacy="+(q>>1&1),LOG_HPET);(e^q)&1&&(q&1?f=Date.now():(g=b(),k=c()));e=1===(q&1);d.legacy_mode=2===(q&2);return;case 32:m&=~q;return;case 240:g=q;return;case 244:k=q;return}var x=
a>>2&7,u=a-256>>5;if(256>a||u>=HPET_NUM_COUNTERS||2<x)dbg_log("Write reserved address: "+h(a)+" data="+h(q),LOG_HPET);else switch(dbg_log("Write counter: addr="+h(a)+" counter="+h(u,2)+" reg="+h(x)+" data="+h(q,2),LOG_HPET),x){case 0:p[u<<1]=q;break;case 2:l?(r[u<<1]=q,l=!1,dbg_log("Accumulator acc="+h(q>>>0,8)+" ctr="+h(u,2),LOG_HPET)):(n[u<<1]=q,p[u<<1]&64&&(l=!0,p[u<<1]&=-65));break;case 3:n[u<<1|1]=q}})};var PMTIMER_FREQ=3579545;
function ACPI(a){this.cpu=a;var b=a.io;a.devices.pci.register_device({pci_id:56,pci_space:[134,128,19,113,7,0,128,2,8,0,128,6,0,0,128,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,1,0,0],pci_bars:[],name:"acpi"});this.status=1;this.pm1_enable=this.pm1_status=0;this.last_timer=this.get_timer(v86.microtick());this.gpe=new Uint8Array(4);b.register_read(45056,this,void 0,function(){dbg_log("ACPI pm1_status read",LOG_ACPI);return this.pm1_status});b.register_write(45056,
this,void 0,function(a){dbg_log("ACPI pm1_status write: "+h(a,4),LOG_ACPI);this.pm1_status&=~a});b.register_read(45058,this,void 0,function(){dbg_log("ACPI pm1_enable read",LOG_ACPI);return this.pm1_enable});b.register_write(45058,this,void 0,function(a){dbg_log("ACPI pm1_enable write: "+h(a),LOG_ACPI);this.pm1_enable=a});b.register_read(45060,this,void 0,function(){dbg_log("ACPI status read",LOG_ACPI);return this.status});b.register_write(45060,this,void 0,function(a){dbg_log("ACPI status write: "+
h(a),LOG_ACPI);this.status=a});b.register_read(45064,this,void 0,void 0,function(){return this.get_timer(v86.microtick())&16777215});b.register_read(45024,this,function(){dbg_log("Read gpe#0",LOG_ACPI);return this.gpe[0]});b.register_read(45025,this,function(){dbg_log("Read gpe#1",LOG_ACPI);return this.gpe[1]});b.register_read(45026,this,function(){dbg_log("Read gpe#2",LOG_ACPI);return this.gpe[2]});b.register_read(45027,this,function(){dbg_log("Read gpe#3",LOG_ACPI);return this.gpe[3]});b.register_write(45024,
this,function(a){dbg_log("Write gpe#0: "+h(a),LOG_ACPI);this.gpe[0]=a});b.register_write(45025,this,function(a){dbg_log("Write gpe#1: "+h(a),LOG_ACPI);this.gpe[1]=a});b.register_write(45026,this,function(a){dbg_log("Write gpe#2: "+h(a),LOG_ACPI);this.gpe[2]=a});b.register_write(45027,this,function(a){dbg_log("Write gpe#3: "+h(a),LOG_ACPI);this.gpe[3]=a})}
ACPI.prototype.timer=function(a){a=this.get_timer(a);var b=0!==((a^this.last_timer)&8388608);this.pm1_enable&1&&b?(dbg_log("ACPI raise irq",LOG_ACPI),this.pm1_status|=1,this.cpu.device_raise_irq(9)):this.cpu.device_lower_irq(9);this.last_timer=a};ACPI.prototype.get_timer=function(a){return PMTIMER_FREQ/1E3*a|0};ACPI.prototype.get_state=function(){var a=[];a[0]=this.status;a[1]=this.pm1_status;a[2]=this.pm1_enable;return a};
ACPI.prototype.set_state=function(a){this.status=a[0];this.pm1_status=a[1];this.pm1_enable=a[2]};var APIC_LOG_VERBOSE=!1,APIC_ADDRESS=4276092928,APIC_TIMER_MODE_MASK=393216,APIC_TIMER_MODE_ONE_SHOT=0,APIC_TIMER_MODE_PERIODIC=131072,APIC_TIMER_MODE_TSC=262144,DELIVERY_MODES="Fixed (0);Lowest Prio (1);SMI (2);Reserved (3);NMI (4);INIT (5);Reserved (6);ExtINT (7)".split(";"),DESTINATION_MODES=["physical","logical"];
function APIC(a){var b=this;this.cpu=a;this.timer_divider=this.apic_id=0;this.timer_divider_shift=1;this.timer_current_count=this.timer_initial_count=0;this.next_tick=v86.microtick();this.lvt_error=this.lvt_int1=this.lvt_int0=this.lvt_perf_counter=this.lvt_timer=IOAPIC_CONFIG_MASKED;this.icr1=this.icr0=this.tpr=0;this.irr=new Int32Array(8);this.isr=new Int32Array(8);this.tmr=new Int32Array(8);this.spurious_vector=254;this.destination_format=-1;this.read_error=this.error=this.local_destination=0;a.io.mmap_register(APIC_ADDRESS,
1048576,function(a){dbg_log("Unsupported read8 from apic: "+h(a>>>0),LOG_APIC);var c=a&3;return b.read32(a&-4)>>8*c&255},function(a,b){dbg_log("Unsupported write8 from apic: "+h(a)+" <- "+h(b),LOG_APIC);dbg_trace();dbg_assert(!1)},function(a){return b.read32(a)},function(a,d){return b.write32(a,d)})}
APIC.prototype.read32=function(a){a=a-APIC_ADDRESS|0;switch(a){case 32:return dbg_log("APIC read id",LOG_APIC),this.apic_id;case 48:return dbg_log("APIC read version",LOG_APIC),327700;case 128:return APIC_LOG_VERBOSE&&dbg_log("APIC read tpr",LOG_APIC),this.tpr;case 208:return dbg_log("Read local destination",LOG_APIC),this.local_destination;case 224:return dbg_log("Read destination format",LOG_APIC),this.destination_format;case 240:return this.spurious_vector;case 256:case 272:case 288:case 304:case 320:case 336:case 352:case 368:return a=
a-256>>4,dbg_log("Read isr "+a+": "+h(this.isr[a]>>>0,8),LOG_APIC),this.isr[a];case 384:case 400:case 416:case 432:case 448:case 464:case 480:case 496:return a=a-384>>4,dbg_log("Read tmr "+a+": "+h(this.tmr[a]>>>0,8),LOG_APIC),this.tmr[a];case 512:case 528:case 544:case 560:case 576:case 592:case 608:case 624:return a=a-512>>4,dbg_log("Read irr "+a+": "+h(this.irr[a]>>>0,8),LOG_APIC),this.irr[a];case 640:return dbg_log("Read error: "+h(this.read_error>>>0,8),LOG_APIC),this.read_error;case 768:return APIC_LOG_VERBOSE&&
dbg_log("APIC read icr0",LOG_APIC),this.icr0;case 784:return dbg_log("APIC read icr1",LOG_APIC),this.icr1;case 800:return dbg_log("read timer lvt",LOG_APIC),this.lvt_timer;case 832:return dbg_log("read lvt perf counter",LOG_APIC),this.lvt_perf_counter;case 848:return dbg_log("read lvt int0",LOG_APIC),this.lvt_int0;case 864:return dbg_log("read lvt int1",LOG_APIC),this.lvt_int1;case 880:return dbg_log("read lvt error",LOG_APIC),this.lvt_error;case 992:return dbg_log("read timer divider",LOG_APIC),
this.timer_divider;case 896:return dbg_log("read timer initial count",LOG_APIC),this.timer_initial_count;case 912:return dbg_log("read timer current count: "+h(this.timer_current_count>>>0,8),LOG_APIC),this.timer_current_count;default:return dbg_log("APIC read "+h(a),LOG_APIC),dbg_assert(!1),0}};
APIC.prototype.write32=function(a,b){a=a-APIC_ADDRESS|0;switch(a){case 48:dbg_log("APIC write version: "+h(b>>>0,8)+", ignored",LOG_APIC);break;case 128:APIC_LOG_VERBOSE&&dbg_log("Set tpr: "+h(b&255,2),LOG_APIC);this.tpr=b&255;this.check_vector();break;case 176:a=this.highest_isr();-1!==a?(APIC_LOG_VERBOSE&&dbg_log("eoi: "+h(b>>>0,8)+" for vector "+h(a),LOG_APIC),this.register_clear_bit(this.isr,a),this.register_get_bit(this.tmr,a)&&this.cpu.devices.ioapic.remote_eoi(a),this.check_vector()):dbg_log("Bad eoi: No isr set",
LOG_APIC);break;case 208:dbg_log("Set local destination: "+h(b>>>0,8),LOG_APIC);this.local_destination=b&4278190080;break;case 224:dbg_log("Set destination format: "+h(b>>>0,8),LOG_APIC);this.destination_format=b|16777215;break;case 240:dbg_log("Set spurious vector: "+h(b>>>0,8),LOG_APIC);this.spurious_vector=b;break;case 640:dbg_log("Write error: "+h(b>>>0,8),LOG_APIC);this.read_error=this.error;this.error=0;break;case 768:a=b&255;var c=b>>8&7,d=b>>11&1,e=b>>15&1,f=b>>18&3,g=this.icr1>>>24;dbg_log("APIC write icr0: "+
h(b,8)+" vector="+h(a,2)+" destination_mode="+DESTINATION_MODES[d]+" delivery_mode="+DELIVERY_MODES[c]+" destination_shorthand="+["no","self","all with self","all without self"][f],LOG_APIC);this.icr0=b&-4097;0===f?this.route(a,c,e,g,d):1===f?this.deliver(a,IOAPIC_DELIVERY_FIXED,e):2===f?this.deliver(a,c,e):3!==f&&dbg_assert(!1);break;case 784:dbg_log("APIC write icr1: "+h(b>>>0,8),LOG_APIC);this.icr1=b;break;case 800:dbg_log("timer lvt: "+h(b>>>0,8),LOG_APIC);this.lvt_timer=b;break;case 832:dbg_log("lvt perf counter: "+
h(b>>>0,8),LOG_APIC);this.lvt_perf_counter=b;break;case 848:dbg_log("lvt int0: "+h(b>>>0,8),LOG_APIC);this.lvt_int0=b;break;case 864:dbg_log("lvt int1: "+h(b>>>0,8),LOG_APIC);this.lvt_int1=b;break;case 880:dbg_log("lvt error: "+h(b>>>0,8),LOG_APIC);this.lvt_error=b;break;case 992:dbg_log("timer divider: "+h(b>>>0,8),LOG_APIC);this.timer_divider=b;b=b&3|(b&8)>>1;this.timer_divider_shift=7===b?0:b+1;break;case 896:dbg_log("timer initial: "+h(b>>>0,8),LOG_APIC);this.timer_initial_count=b>>>0;this.timer_current_count=
b>>>0;this.next_tick=v86.microtick();this.timer_active=!0;break;case 912:dbg_log("timer current: "+h(b>>>0,8),LOG_APIC);dbg_assert(!1,"read-only register");break;default:dbg_log("APIC write32 "+h(a)+" <- "+h(b>>>0,8),LOG_APIC),dbg_assert(!1)}};
APIC.prototype.timer=function(a){0!==this.timer_current_count&&(a=(a-this.next_tick)*TSC_RATE/(1<<this.timer_divider_shift)>>>0,0!==a&&(this.next_tick+=a/TSC_RATE*(1<<this.timer_divider_shift),this.timer_current_count-=a,0>=this.timer_current_count&&(a=this.lvt_timer&APIC_TIMER_MODE_MASK,a===APIC_TIMER_MODE_PERIODIC?(this.timer_current_count=this.timer_initial_count,0===(this.lvt_timer&IOAPIC_CONFIG_MASKED)&&this.deliver(this.lvt_timer&255,IOAPIC_DELIVERY_FIXED,!1)):a===APIC_TIMER_MODE_ONE_SHOT&&
(this.timer_current_count=0,dbg_log("APIC timer one shot end",LOG_APIC),0===(this.lvt_timer&IOAPIC_CONFIG_MASKED)&&this.deliver(this.lvt_timer&255,IOAPIC_DELIVERY_FIXED,!1)))))};APIC.prototype.route=function(a,b,c,d,e){this.deliver(a,b,c)};
APIC.prototype.deliver=function(a,b,c){APIC_LOG_VERBOSE&&dbg_log("Deliver "+h(a,2)+" mode="+b+" level="+c,LOG_APIC);b!==IOAPIC_DELIVERY_INIT&&b!==IOAPIC_DELIVERY_NMI&&((16>a||255===a)&&dbg_assert(!1,"TODO: Invalid vector"),this.register_get_bit(this.irr,a)?dbg_log("Not delivered: irr already set, vector="+h(a,2),LOG_APIC):(this.register_set_bit(this.irr,a),c?this.register_set_bit(this.tmr,a):this.register_clear_bit(this.tmr,a),this.check_vector()))};
APIC.prototype.highest_irr=function(){var a=this.register_get_highest_bit(this.irr);dbg_assert(255!==a);dbg_assert(16<=a||-1===a);return a};APIC.prototype.highest_isr=function(){var a=this.register_get_highest_bit(this.isr);dbg_assert(255!==a);dbg_assert(16<=a||-1===a);return a};
APIC.prototype.check_vector=function(){var a=this.highest_irr();if(-1!==a){var b=this.highest_isr();b>=a?APIC_LOG_VERBOSE&&dbg_log("Higher isr, isr="+h(b)+" irr="+h(a),LOG_APIC):(a&240)<=(this.tpr&240)?APIC_LOG_VERBOSE&&dbg_log("Higher tpr, tpr="+h(this.tpr&240)+" irr="+h(a),LOG_APIC):this.cpu.handle_irqs()}};
APIC.prototype.acknowledge_irq=function(){var a=this.highest_irr();if(-1!==a){var b=this.highest_isr();b>=a?APIC_LOG_VERBOSE&&dbg_log("Higher isr, isr="+h(b)+" irr="+h(a),LOG_APIC):(a&240)<=(this.tpr&240)?APIC_LOG_VERBOSE&&dbg_log("Higher tpr, tpr="+h(this.tpr&240)+" irr="+h(a),LOG_APIC):(this.register_clear_bit(this.irr,a),this.register_set_bit(this.isr,a),APIC_LOG_VERBOSE&&dbg_log("Calling vector "+h(a),LOG_APIC),this.cpu.pic_call_irq(a),this.check_vector())}};
APIC.prototype.get_state=function(){var a=[];a[0]=this.apic_id;a[1]=this.timer_divider;a[2]=this.timer_divider_shift;a[3]=this.timer_initial_count;a[4]=this.timer_current_count;a[5]=this.next_tick;a[6]=this.lvt_timer;a[7]=this.lvt_perf_counter;a[8]=this.lvt_int0;a[9]=this.lvt_int1;a[10]=this.lvt_error;a[11]=this.tpr;a[12]=this.icr0;a[13]=this.icr1;a[14]=this.irr;a[15]=this.isr;a[16]=this.tmr;a[17]=this.spurious_vector;a[18]=this.destination_format;a[19]=this.local_destination;a[20]=this.error;a[21]=
this.read_error;return a};
APIC.prototype.set_state=function(a){this.apic_id=a[0];this.timer_divider=a[1];this.timer_divider_shift=a[2];this.timer_initial_count=a[3];this.timer_current_count=a[4];this.next_tick=a[5];this.lvt_timer=a[6];this.lvt_perf_counter=a[7];this.lvt_int0=a[8];this.lvt_int1=a[9];this.lvt_error=a[10];this.tpr=a[11];this.icr0=a[12];this.icr1=a[13];this.irr=a[14];this.isr=a[15];this.tmr=a[16];this.spurious_vector=a[17];this.destination_format=a[18];this.local_destination=a[19];this.error=a[20];this.read_error=
a[21]};APIC.prototype.register_get_bit=function(a,b){dbg_assert(0<=b&&256>b);return a[b>>5]>>(b&31)&1};APIC.prototype.register_set_bit=function(a,b){dbg_assert(0<=b&&256>b);a[b>>5]|=1<<(b&31)};APIC.prototype.register_clear_bit=function(a,b){dbg_assert(0<=b&&256>b);a[b>>5]&=~(1<<(b&31))};APIC.prototype.register_get_highest_bit=function(a){for(var b=7;0<=b;b--){var c=a[b];if(c)return v86util.int_log2(c>>>0)|b<<5}return-1};var IOAPIC_ADDRESS=4273995776,IOREGSEL=0,IOWIN=16,IOAPIC_IRQ_COUNT=24,IOAPIC_ID=0,IOAPIC_CONFIG_TRIGGER_MODE_LEVEL=32768,IOAPIC_CONFIG_MASKED=65536,IOAPIC_CONFIG_DELIVS=4096,IOAPIC_CONFIG_REMOTE_IRR=16384,IOAPIC_CONFIG_READONLY_MASK=IOAPIC_CONFIG_REMOTE_IRR|IOAPIC_CONFIG_DELIVS|4294836224,IOAPIC_DELIVERY_FIXED=0,IOAPIC_DELIVERY_LOWEST_PRIORITY=1,IOAPIC_DELIVERY_NMI=4,IOAPIC_DELIVERY_INIT=5;
function IOAPIC(a){var b=this;this.cpu=a;this.ioredtbl_config=new Int32Array(IOAPIC_IRQ_COUNT);this.ioredtbl_destination=new Int32Array(IOAPIC_IRQ_COUNT);for(var c=0;c<this.ioredtbl_config.length;c++)this.ioredtbl_config[c]=IOAPIC_CONFIG_MASKED;this.ioregsel=0;this.ioapic_id=IOAPIC_ID;this.irq_value=this.irr=0;dbg_assert(32<=MMAP_BLOCK_SIZE);a.io.mmap_register(IOAPIC_ADDRESS,MMAP_BLOCK_SIZE,function(a){dbg_assert(!1,"unsupported read8 from ioapic: "+h(a));return 0},function(a,b){dbg_assert(!1,"unsupported write8 from ioapic: "+
h(a))},function(a){a=a-IOAPIC_ADDRESS|0;if(a===IOREGSEL)return b.ioregsel;if(a===IOWIN)return b.read(b.ioregsel);dbg_log("Unexpected IOAPIC register read: "+h(a),LOG_APIC);dbg_assert(!1);return 0},function(a,e){a=a-IOAPIC_ADDRESS|0;a===IOREGSEL?b.ioregsel=e:a===IOWIN?b.write(b.ioregsel,e):(dbg_log("Unexpected IOAPIC register write: "+h(a)+" <- "+h(e>>>0,8),LOG_APIC),dbg_assert(!1))})}
IOAPIC.prototype.remote_eoi=function(a){for(var b=0;b<IOAPIC_IRQ_COUNT;b++){var c=this.ioredtbl_config[b];(c&255)===a&&c&IOAPIC_CONFIG_REMOTE_IRR&&(dbg_log("Clear remote IRR for irq="+h(b),LOG_APIC),this.ioredtbl_config[b]&=~IOAPIC_CONFIG_REMOTE_IRR,this.check_irq(b))}};
IOAPIC.prototype.check_irq=function(a){var b=1<<a;if(0!==(this.irr&b)){var c=this.ioredtbl_config[a];if(0===(c&IOAPIC_CONFIG_MASKED)){var d=c>>8&7,e=c>>11&1,f=c&255,g=this.ioredtbl_destination[a]>>>24,k=(c&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL)===IOAPIC_CONFIG_TRIGGER_MODE_LEVEL;if(0===(c&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL))this.irr&=~b;else if(this.ioredtbl_config[a]|=IOAPIC_CONFIG_REMOTE_IRR,c&IOAPIC_CONFIG_REMOTE_IRR){dbg_log("No route: level interrupt and remote IRR still set",LOG_APIC);return}d===IOAPIC_DELIVERY_FIXED||
d===IOAPIC_DELIVERY_LOWEST_PRIORITY?this.cpu.devices.apic.route(f,d,k,g,e):dbg_assert(!1,"TODO");this.ioredtbl_config[a]&=~IOAPIC_CONFIG_DELIVS}}};IOAPIC.prototype.set_irq=function(a){if(a>=IOAPIC_IRQ_COUNT)dbg_assert(!1,"Bad irq: "+a,LOG_APIC);else{var b=1<<a;0===(this.irq_value&b)&&(APIC_LOG_VERBOSE&&dbg_log("apic set irq "+a,LOG_APIC),this.irq_value|=b,(this.ioredtbl_config[a]&(IOAPIC_CONFIG_TRIGGER_MODE_LEVEL|IOAPIC_CONFIG_MASKED))!==IOAPIC_CONFIG_MASKED&&(this.irr|=b,this.check_irq(a)))}};
IOAPIC.prototype.clear_irq=function(a){if(a>=IOAPIC_IRQ_COUNT)dbg_assert(!1,"Bad irq: "+a,LOG_APIC);else{var b=1<<a;(this.irq_value&b)===b&&(this.irq_value&=~b,this.ioredtbl_config[a]&IOAPIC_CONFIG_TRIGGER_MODE_LEVEL&&(this.irr&=~b))}};
IOAPIC.prototype.read=function(a){if(0===a)return dbg_log("IOAPIC Read id",LOG_APIC),this.ioapic_id<<24;if(1===a)return dbg_log("IOAPIC Read version",LOG_APIC),17|IOAPIC_IRQ_COUNT-1<<16;if(2===a)return dbg_log("IOAPIC Read arbitration id",LOG_APIC),this.ioapic_id<<24;if(16<=a&&a<16+2*IOAPIC_IRQ_COUNT){var b=a-16>>1;a&1?(a=this.ioredtbl_destination[b],dbg_log("IOAPIC Read destination irq="+h(b)+" -> "+h(a,8),LOG_APIC)):(a=this.ioredtbl_config[b],dbg_log("IOAPIC Read config irq="+h(b)+" -> "+h(a,8),
LOG_APIC));return a}dbg_log("IOAPIC register read outside of range "+h(a),LOG_APIC);dbg_assert(!1);return 0};
IOAPIC.prototype.write=function(a,b){if(0===a)this.ioapic_id=b>>>24&15;else if(1===a||2===a)dbg_log("Invalid write: "+a,LOG_APIC);else if(16<=a&&a<16+2*IOAPIC_IRQ_COUNT){var c=a-16>>1;if(a&1)this.ioredtbl_destination[c]=b&4278190080,dbg_log("Write destination "+h(b>>>0,8)+" irq="+h(c)+" dest="+h(b>>>24,2),LOG_APIC);else{this.ioredtbl_config[c]=b&~IOAPIC_CONFIG_READONLY_MASK|this.ioredtbl_config[c]&IOAPIC_CONFIG_READONLY_MASK;a=b&255;var d=b>>8&7,e=b>>11&1,f=b>>15&1,g=b>>16&1;dbg_log("Write config "+
h(b>>>0,8)+" irq="+h(c)+" vector="+h(a,2)+" deliverymode="+DELIVERY_MODES[d]+" destmode="+DESTINATION_MODES[e]+" is_level="+f+" disabled="+g,LOG_APIC);this.check_irq(c)}}else dbg_log("IOAPIC register write outside of range "+h(a)+": "+h(b>>>0,8),LOG_APIC),dbg_assert(!1)};IOAPIC.prototype.get_state=function(){var a=[];a[0]=this.ioredtbl_config;a[1]=this.ioredtbl_destination;a[2]=this.ioregsel;a[3]=this.ioapic_id;a[4]=this.irr;a[5]=this.irq_value;return a};
IOAPIC.prototype.set_state=function(a){this.ioredtbl_config=a[0];this.ioredtbl_destination=a[1];this.ioregsel=a[2];this.ioapic_id=a[3];this.irr=a[4];this.irq_value=a[5]};var STATE_VERSION=5,STATE_MAGIC=-2039052682,STATE_INDEX_MAGIC=0,STATE_INDEX_VERSION=1,STATE_INDEX_TOTAL_LEN=2,STATE_INDEX_INFO_LEN=3,STATE_INFO_BLOCK_START=16;function StateLoadError(a){this.message=a}StateLoadError.prototype=Error();
function save_object(a,b){if("object"!==typeof a||null===a||a instanceof Array)return a;dbg_assert(a.constructor!==Object);if(a.BYTES_PER_ELEMENT){var c=new Uint8Array(a.buffer,a.byteOffset,a.length*a.BYTES_PER_ELEMENT);return{__state_type__:a.constructor.name,buffer_id:b.push(c)-1}}DEBUG&&!a.get_state&&console.log("Object without get_state: ",a);a=a.get_state();c=[];for(var d=0;d<a.length;d++){var e=a[d];dbg_assert("function"!==typeof e);c[d]=save_object(e,b)}return c}
function restore_object(a,b,c){if("object"!==typeof b||null===b)return b;if(a instanceof Array)return b;var d=b.__state_type__;if(void 0===d){DEBUG&&void 0===a&&(console.log("Cannot restore (base doesn't exist)",b),dbg_assert(!1));DEBUG&&!a.get_state&&console.log("No get_state:",a);var e=a.get_state();dbg_assert(e.length===b.length,"Cannot restore: Different number of properties");for(d=0;d<b.length;d++)b[d]=restore_object(e[d],b[d],c);a.set_state(b);return a}e={Uint8Array:Uint8Array,Int8Array:Int8Array,
Uint16Array:Uint16Array,Int16Array:Int16Array,Uint32Array:Uint32Array,Int32Array:Int32Array,Float32Array:Float32Array,Float64Array:Float64Array}[d];dbg_assert(e,"Unkown type: "+d);b=c.infos[b.buffer_id];dbg_assert(a);dbg_assert(a.constructor===e);if(1048576<=b.length&&e===Uint8Array)return new Uint8Array(c.full,b.offset,b.length);a=c.full.slice(b.offset,b.offset+b.length);return new e(a)}
CPU.prototype.save_state=function(){for(var a=[],b=save_object(this,a),c=[],d=0,e=0;e<a.length;e++){var f=a[e].byteLength;c[e]={offset:d,length:f};d+=f;d=d+3&-4}b=JSON.stringify({buffer_infos:c,state:b});e=STATE_INFO_BLOCK_START+2*b.length;e=e+3&-4;var g=e+d;d=new ArrayBuffer(g);var k=new Int32Array(d,0,STATE_INFO_BLOCK_START/4);f=new Uint16Array(d,STATE_INFO_BLOCK_START,b.length);var l=new Uint8Array(d,e);k[STATE_INDEX_MAGIC]=STATE_MAGIC;k[STATE_INDEX_VERSION]=STATE_VERSION;k[STATE_INDEX_TOTAL_LEN]=
g;k[STATE_INDEX_INFO_LEN]=2*b.length;for(e=0;e<b.length;e++)f[e]=b.charCodeAt(e);for(e=0;e<a.length;e++)b=a[e],dbg_assert(b.constructor===Uint8Array),l.set(b,c[e].offset);return d};
CPU.prototype.restore_state=function(a){var b=a.byteLength;if(b<STATE_INFO_BLOCK_START)throw new StateLoadError("Invalid length: "+b);var c=new Int32Array(a,0,4);if(c[STATE_INDEX_MAGIC]!==STATE_MAGIC)throw new StateLoadError("Invalid header: "+h(c[STATE_INDEX_MAGIC]>>>0));if(c[STATE_INDEX_VERSION]!==STATE_VERSION)throw new StateLoadError("Version mismatch: dump="+c[STATE_INDEX_VERSION]+" we="+STATE_VERSION);if(c[STATE_INDEX_TOTAL_LEN]!==b)throw new StateLoadError("Length doesn't match header: real="+
b+" header="+c[STATE_INDEX_TOTAL_LEN]);c=c[STATE_INDEX_INFO_LEN];if(0>c||c+12>=b||c%2)throw new StateLoadError("Invalid info block length: "+c);var d=c/2,e=new Uint16Array(a,STATE_INFO_BLOCK_START,d),f="";for(b=0;b<d-8;)f+=String.fromCharCode(e[b++],e[b++],e[b++],e[b++],e[b++],e[b++],e[b++],e[b++]);for(;b<d;)f+=String.fromCharCode(e[b++]);b=JSON.parse(f);d=b.state;e=b.buffer_infos;c=STATE_INFO_BLOCK_START+c;c=c+3&-4;for(b=0;b<e.length;b++)e[b].offset+=c;restore_object(this,d,{full:a,infos:e})};var E8390_CMD=0,EN0_CLDALO=1,EN0_STARTPG=1,EN0_CLDAHI=2,EN0_STOPPG=2,EN0_BOUNDARY=3,EN0_TSR=4,EN0_TPSR=4,EN0_NCR=5,EN0_TCNTLO=5,EN0_FIFO=6,EN0_TCNTHI=6,EN0_ISR=7,EN0_CRDALO=8,EN0_RSARLO=8,EN0_CRDAHI=9,EN0_RSARHI=9,EN0_RCNTLO=10,EN0_RCNTHI=11,EN0_RSR=12,EN0_RXCR=12,EN0_TXCR=13,EN0_COUNTER0=13,EN0_DCFG=14,EN0_COUNTER1=14,EN0_IMR=15,EN0_COUNTER2=15,NE_DATAPORT=16,NE_RESET=31,ENISR_RX=1,ENISR_TX=2,ENISR_RX_ERR=4,ENISR_TX_ERR=8,ENISR_OVER=16,ENISR_COUNTERS=32,ENISR_RDC=64,ENISR_RESET=128,ENISR_ALL=63,
ENRSR_RXOK=1,START_PAGE=64,START_RX_PAGE=76,STOP_PAGE=128;
function Ne2k(a,b){this.cpu=a;this.pci=a.devices.pci;this.bus=b;this.bus.register("net0-receive",function(a){this.receive(a)},this);this.port=768;this.name="ne2k";this.pci_space=[236,16,41,128,3,1,0,0,0,0,0,2,0,0,0,0,this.port&255|1,this.port>>8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,0,17,0,0,184,254,0,0,0,0,0,0,0,0,0,1,0,0];this.pci_id=40;this.pci_bars=[{size:32}];this.imr=this.isr=0;this.cr=1;this.tpsr=this.tcnt=this.rcnt=this.dcfg=0;this.memory=new Uint8Array(32768);this.txcr=
this.rxcr=0;this.tsr=1;b=[0,34,21,255*Math.random()|0,255*Math.random()|0,255*Math.random()|0];for(var c=0;6>c;c++)this.memory[c<<1]=this.memory[c<<1|1]=b[c];this.memory[14]=this.memory[15]=87;dbg_log("Mac: "+h(b[0],2)+":"+h(b[1],2)+":"+h(b[2],2)+":"+h(b[3],2)+":"+h(b[4],2)+":"+h(b[5],2),LOG_NET);this.rsar=0;this.pstart=START_PAGE;this.pstop=STOP_PAGE;this.boundary=this.curpg=START_RX_PAGE;b=a.io;b.register_read(this.port|E8390_CMD,this,function(){dbg_log("Read cmd",LOG_NET);return this.cr});b.register_write(this.port|
E8390_CMD,this,function(a){this.cr=a&-5;dbg_log("Write command: "+h(a,2)+" newpg="+(this.cr>>6)+" txcr="+h(this.txcr,2),LOG_NET);this.cr&1||(a|24&&0===this.rcnt&&this.do_interrupt(ENISR_RDC),a&4&&(a=this.tpsr<<8,a=this.memory.subarray(a,a+this.tcnt),this.bus.send("net0-send",a),this.bus.send("eth-transmit-end",[a.length]),this.do_interrupt(ENISR_TX),dbg_log("Command: Transfer. length="+h(a.byteLength),LOG_NET)))});b.register_read(this.port|EN0_COUNTER0,this,function(){dbg_log("Read counter0",LOG_NET);
return 0});b.register_read(this.port|EN0_COUNTER1,this,function(){dbg_log("Read counter1",LOG_NET);return 0});b.register_read(this.port|EN0_COUNTER2,this,function(){dbg_log("Read counter2",LOG_NET);return 0});b.register_read(this.port|NE_RESET,this,function(){0===this.get_page()?(dbg_log("Read reset",LOG_NET),this.do_interrupt(ENISR_RESET)):dbg_log("Read pg1/1f",LOG_NET);return 0});b.register_write(this.port|NE_RESET,this,function(a){0===this.get_page()?dbg_log("Write reset: "+h(a,2),LOG_NET):dbg_log("Write pg1/1f: "+
h(a),LOG_NET)});b.register_write(this.port|EN0_STARTPG,this,function(a){0===this.get_page()?(dbg_log("start page: "+h(a,2),LOG_NET),this.pstart=a):dbg_log("pg1/1: "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_STOPPG,this,function(a){0===this.get_page()?(dbg_log("stop page: "+h(a,2),LOG_NET),this.pstop=a):dbg_log("pg1/2: "+h(a,2),LOG_NET)});b.register_read(this.port|EN0_ISR,this,function(){if(0===this.get_page())return dbg_log("Read isr: "+h(this.isr,2),LOG_NET),this.isr;dbg_log("Read curpg: "+
h(this.curpg,2),LOG_NET);return this.curpg});b.register_write(this.port|EN0_ISR,this,function(a){0===this.get_page()?(dbg_log("Write isr: "+h(a,2),LOG_NET),this.isr&=~a,this.update_irq()):(dbg_log("Write curpg: "+h(a,2),LOG_NET),this.curpg=a)});b.register_write(this.port|EN0_TXCR,this,function(a){0===this.get_page()?(this.txcr=a,dbg_log("Write tx config: "+h(a,2),LOG_NET)):dbg_log("Write pg1/0x0d "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_DCFG,this,function(a){0===this.get_page()?(dbg_log("Write data configuration: "+
h(a,2),LOG_NET),this.dcfg=a):dbg_log("Write pg1/0x0e "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_RCNTLO,this,function(a){0===this.get_page()?(dbg_log("Write remote byte count low: "+h(a,2),LOG_NET),this.rcnt=this.rcnt&65280|a&255):dbg_log("Write pg1/0x0a "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_RCNTHI,this,function(a){0===this.get_page()?(dbg_log("Write remote byte count high: "+h(a,2),LOG_NET),this.rcnt=this.rcnt&255|a<<8&65280):dbg_log("Write pg1/0x0b "+h(a,2),LOG_NET)});b.register_write(this.port|
EN0_RSARLO,this,function(a){0===this.get_page()?(dbg_log("Write remote start address low: "+h(a,2),LOG_NET),this.rsar=this.rsar&65280|a&255):dbg_log("Write pg1/0x08 "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_RSARHI,this,function(a){0===this.get_page()?(dbg_log("Write start addresse count high: "+h(a,2),LOG_NET),this.rsar=this.rsar&255|a<<8&65280):dbg_log("Write pg1/0x09 "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_IMR,this,function(a){0===this.get_page()?(dbg_log("Write interrupt mask register: "+
h(a,2)+" isr="+h(this.isr,2),LOG_NET),this.imr=a,this.update_irq()):dbg_log("Write pg1/0x0f "+h(a,2),LOG_NET)});b.register_read(this.port|EN0_BOUNDARY,this,function(){if(0===this.get_page())return dbg_log("Read boundary: "+h(this.boundary,2),LOG_NET),this.boundary;dbg_log("Read pg1/0x03",LOG_NET);return 0});b.register_write(this.port|EN0_BOUNDARY,this,function(a){0===this.get_page()?(dbg_log("Write boundary: "+h(a,2),LOG_NET),this.boundary=a):dbg_log("Write pg1/0x03 "+h(a,2),LOG_NET)});b.register_read(this.port|
EN0_TSR,this,function(){if(0===this.get_page())return this.tsr;dbg_log("Read pg1/0x04",LOG_NET);return 0});b.register_write(this.port|EN0_TPSR,this,function(a){0===this.get_page()?(dbg_log("Write tpsr: "+h(a,2),LOG_NET),this.tpsr=a):dbg_log("Write pg1/0x04 "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_TCNTLO,this,function(a){0===this.get_page()?(dbg_log("Write tcnt low: "+h(a,2),LOG_NET),this.tcnt=this.tcnt&-256|a):dbg_log("Write pg1/0x05 "+h(a,2),LOG_NET)});b.register_write(this.port|EN0_TCNTHI,
this,function(a){0===this.get_page()?(dbg_log("Write tcnt high: "+h(a,2),LOG_NET),this.tcnt=this.tcnt&255|a<<8):dbg_log("Write pg1/0x06 "+h(a,2),LOG_NET)});b.register_read(this.port|EN0_RSR,this,function(){if(0===this.get_page())return 9;dbg_log("Read pg1/0x0c",LOG_NET);return 0});b.register_write(this.port|EN0_RXCR,this,function(a){dbg_log("RX configuration reg write: "+h(a,2),LOG_NET);this.rxcr=a});b.register_read(this.port|NE_DATAPORT|0,this,this.data_port_read8,this.data_port_read16,this.data_port_read32);
b.register_write(this.port|NE_DATAPORT|0,this,this.data_port_write16,this.data_port_write16,this.data_port_write32);a.devices.pci.register_device(this)}Ne2k.prototype.get_state=function(){var a=[];a[0]=this.isr;a[1]=this.imr;a[2]=this.cr;a[3]=this.dcfg;a[4]=this.rcnt;a[5]=this.tcnt;a[6]=this.tpsr;a[7]=this.rsar;a[8]=this.pstart;a[9]=this.curpg;a[10]=this.boundary;return a};
Ne2k.prototype.set_state=function(a){this.isr=a[0];this.imr=a[1];this.cr=a[2];this.dcfg=a[3];this.rcnt=a[4];this.tcnt=a[5];this.tpsr=a[6];this.rsar=a[7];this.pstart=a[8];this.curpg=a[9];this.boundary=a[10]};Ne2k.prototype.do_interrupt=function(a){dbg_log("Do interrupt "+h(a,2),LOG_NET);this.isr|=a;this.update_irq()};Ne2k.prototype.update_irq=function(){this.imr&this.isr?this.pci.raise_irq(this.pci_id):this.pci.lower_irq(this.pci_id)};
Ne2k.prototype.data_port_write=function(a){dbg_log("Write data port: data="+h(a&255,2)+" rsar="+h(this.rsar,4)+" rcnt="+h(this.rcnt,4),LOG_NET);16<this.rsar&&this.rsar<START_PAGE<<8||(this.rcnt--,this.memory[this.rsar++]=a,this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8),0===this.rcnt&&this.do_interrupt(ENISR_RDC))};Ne2k.prototype.data_port_write16=function(a){this.data_port_write(a);this.dcfg&1&&this.data_port_write(a>>8)};
Ne2k.prototype.data_port_write32=function(a){this.data_port_write(a);this.data_port_write(a>>8);this.data_port_write(a>>16);this.data_port_write(a>>24)};Ne2k.prototype.data_port_read=function(){var a=this.memory[this.rsar++];dbg_log("Read data port: data="+h(a,2)+" rsar="+h(this.rsar-1,4)+" rcnt="+h(this.rcnt,4),LOG_NET);this.rcnt--;this.rsar>=this.pstop<<8&&(this.rsar+=this.pstart-this.pstop<<8);0===this.rcnt&&this.do_interrupt(ENISR_RDC);return a};
Ne2k.prototype.data_port_read8=function(){return this.data_port_read16()&255};Ne2k.prototype.data_port_read16=function(){return this.dcfg&1?this.data_port_read()|this.data_port_read()<<8:this.data_port_read()};Ne2k.prototype.data_port_read32=function(){return this.data_port_read()|this.data_port_read()<<8|this.data_port_read()<<16|this.data_port_read()<<24};
Ne2k.prototype.receive=function(a){if(!(this.cr&1)&&(this.bus.send("eth-receive-end",[a.length]),this.rxcr&16||this.rxcr&4&&255===a[0]&&255===a[1]&&255===a[2]&&255===a[3]&&255===a[4]&&255===a[5]||!(this.rxcr&8&&1===(a[0]&1)||a[0]!==this.memory[0]||a[1]!==this.memory[2]||a[2]!==this.memory[4]||a[3]!==this.memory[6]||a[4]!==this.memory[8]||a[5]!==this.memory[10]))){var b=this.curpg<<8,c=Math.max(60,a.length)+4,d=b+4,e=this.curpg+1+(c>>8);if(b+c>this.memory.length){dbg_assert(60<=a.length);var f=this.memory.length-
d;this.memory.set(a.subarray(0,f),d);this.memory.set(a.subarray(f),START_RX_PAGE);dbg_log("rcv cut="+h(f),LOG_NET)}else if(this.memory.set(a,d),60>a.length)for(a=a.length;60>a;a++)this.memory[d+a]=0;e>=this.pstop&&(e+=this.pstart-this.pstop);this.memory[b]=ENRSR_RXOK;this.memory[b+1]=e;this.memory[b+2]=c;this.memory[b+3]=c>>8;this.curpg=e;dbg_log("rcv offset="+h(b)+" len="+h(c)+" next="+h(e),LOG_NET);this.do_interrupt(ENISR_RX)}};Ne2k.prototype.get_page=function(){return this.cr&192};var DSP_COPYRIGHT="COPYRIGHT (C) CREATIVE TECHNOLOGY LTD, 1992.",DSP_NO_COMMAND=0,DSP_BUFSIZE=64,DSP_DACSIZE=65536,SB_DMA_BUFSIZE=65536,SB_DMA_BLOCK_SAMPLES=1024,SB_DMA0=0,SB_DMA1=1,SB_DMA3=3,SB_DMA5=5,SB_DMA6=6,SB_DMA7=7,SB_DMA_CHANNEL_8BIT=SB_DMA1,SB_DMA_CHANNEL_16BIT=SB_DMA5,SB_IRQ2=2,SB_IRQ5=5,SB_IRQ7=7,SB_IRQ10=10,SB_IRQ=SB_IRQ5,SB_IRQ_8BIT=1,SB_IRQ_16BIT=2,SB_IRQ_MIDI=1,SB_IRQ_MPU=4,DSP_COMMAND_SIZES=new Uint8Array(256),DSP_COMMAND_HANDLERS=[],MIXER_READ_HANDLERS=[],MIXER_WRITE_HANDLERS=[],
FM_HANDLERS=[];
function SB16(a,b){this.cpu=a;this.bus=b;this.write_buffer=new ByteQueue(DSP_BUFSIZE);this.read_buffer=new ByteQueue(DSP_BUFSIZE);this.read_buffer_lastvalue=0;this.command=DSP_NO_COMMAND;this.mixer_current_address=this.command_size=0;this.mixer_registers=new Uint8Array(256);this.mixer_reset();this.dummy_speaker_enabled=!1;this.test_register=0;this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1;this.dac_buffers=[new FloatQueue(DSP_DACSIZE),new FloatQueue(DSP_DACSIZE)];this.dma=a.devices.dma;
this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0;this.dma_channel_8bit=SB_DMA_CHANNEL_8BIT;this.dma_channel_16bit=SB_DMA_CHANNEL_16BIT;this.dma_autoinit=!1;this.dma_buffer=new ArrayBuffer(SB_DMA_BUFSIZE);this.dma_buffer_int8=new Int8Array(this.dma_buffer);this.dma_buffer_uint8=new Uint8Array(this.dma_buffer);this.dma_buffer_int16=new Int16Array(this.dma_buffer);this.dma_buffer_uint16=new Uint16Array(this.dma_buffer);this.dma_syncbuffer=
new SyncBuffer(this.dma_buffer);this.dma_paused=this.dma_waiting_transfer=!1;this.sampling_rate=22050;b.send("dac-tell-sampling-rate",this.sampling_rate);this.bytes_per_sample=1;this.e2_value=170;this.e2_count=0;this.asp_registers=new Uint8Array(256);this.mpu_read_buffer=new ByteQueue(DSP_BUFSIZE);this.fm_current_address1=this.fm_current_address0=this.mpu_read_buffer_lastvalue=0;this.fm_waveform_select_enable=!1;this.irq=SB_IRQ;this.irq_triggered=new Uint8Array(16);a.io.register_read_consecutive(544,
this,this.port2x0_read,this.port2x1_read,this.port2x2_read,this.port2x3_read);a.io.register_read_consecutive(904,this,this.port2x0_read,this.port2x1_read);a.io.register_read_consecutive(548,this,this.port2x4_read,this.port2x5_read);a.io.register_read(550,this,this.port2x6_read);a.io.register_read(551,this,this.port2x7_read);a.io.register_read(552,this,this.port2x8_read);a.io.register_read(553,this,this.port2x9_read);a.io.register_read(554,this,this.port2xA_read);a.io.register_read(555,this,this.port2xB_read);
a.io.register_read(556,this,this.port2xC_read);a.io.register_read(557,this,this.port2xD_read);a.io.register_read_consecutive(558,this,this.port2xE_read,this.port2xF_read);a.io.register_write_consecutive(544,this,this.port2x0_write,this.port2x1_write,this.port2x2_write,this.port2x3_write);a.io.register_write_consecutive(904,this,this.port2x0_write,this.port2x1_write);a.io.register_write_consecutive(548,this,this.port2x4_write,this.port2x5_write);a.io.register_write(550,this,this.port2x6_write);a.io.register_write(551,
this,this.port2x7_write);a.io.register_write_consecutive(552,this,this.port2x8_write,this.port2x9_write);a.io.register_write(554,this,this.port2xA_write);a.io.register_write(555,this,this.port2xB_write);a.io.register_write(556,this,this.port2xC_write);a.io.register_write(557,this,this.port2xD_write);a.io.register_write(558,this,this.port2xE_write);a.io.register_write(559,this,this.port2xF_write);a.io.register_read_consecutive(816,this,this.port3x0_read,this.port3x1_read);a.io.register_write_consecutive(816,
this,this.port3x0_write,this.port3x1_write);this.dma.on_unmask(this.dma_on_unmask,this);b.register("dac-request-data",function(){this.dac_handle_request()},this);b.register("speaker-has-initialized",function(){this.mixer_reset()},this);b.send("speaker-confirm-initialized");this.dsp_reset()}
SB16.prototype.dsp_reset=function(){this.write_buffer.clear();this.read_buffer.clear();this.command=DSP_NO_COMMAND;this.command_size=0;this.dummy_speaker_enabled=!1;this.test_register=0;this.dsp_signed=this.dsp_16bit=this.dsp_stereo=this.dsp_highspeed=!1;this.dac_buffers[0].clear();this.dac_buffers[1].clear();this.dma_channel=this.dma_irq=this.dma_bytes_block=this.dma_bytes_left=this.dma_bytes_count=this.dma_sample_count=0;this.dma_autoinit=!1;this.dma_buffer_uint8.fill(0);this.dma_paused=this.dma_waiting_transfer=
!1;this.e2_value=170;this.e2_count=0;this.sampling_rate=22050;this.bytes_per_sample=1;this.lower_irq(SB_IRQ_8BIT);this.irq_triggered.fill(0);this.asp_registers.fill(0);this.asp_registers[5]=1;this.asp_registers[9]=248};
SB16.prototype.get_state=function(){var a=[];a[2]=this.read_buffer_lastvalue;a[3]=this.command;a[4]=this.command_size;a[5]=this.mixer_current_address;a[6]=this.mixer_registers;a[7]=this.dummy_speaker_enabled;a[8]=this.test_register;a[9]=this.dsp_highspeed;a[10]=this.dsp_stereo;a[11]=this.dsp_16bit;a[12]=this.dsp_signed;a[15]=this.dma_sample_count;a[16]=this.dma_bytes_count;a[17]=this.dma_bytes_left;a[18]=this.dma_bytes_block;a[19]=this.dma_irq;a[20]=this.dma_channel;a[21]=this.dma_channel_8bit;a[22]=
this.dma_channel_16bit;a[23]=this.dma_autoinit;a[24]=this.dma_buffer_uint8;a[25]=this.dma_waiting_transfer;a[26]=this.dma_paused;a[27]=this.sampling_rate;a[28]=this.bytes_per_sample;a[29]=this.e2_value;a[30]=this.e2_count;a[31]=this.asp_registers;a[33]=this.mpu_read_buffer_last_value;a[34]=this.irq;a[35]=this.irq_triggered;return a};
SB16.prototype.set_state=function(a){this.read_buffer_lastvalue=a[2];this.command=a[3];this.command_size=a[4];this.mixer_current_address=a[5];this.mixer_registers=a[6];this.mixer_full_update();this.dummy_speaker_enabled=a[7];this.test_register=a[8];this.dsp_highspeed=a[9];this.dsp_stereo=a[10];this.dsp_16bit=a[11];this.dsp_signed=a[12];this.dma_sample_count=a[15];this.dma_bytes_count=a[16];this.dma_bytes_left=a[17];this.dma_bytes_block=a[18];this.dma_irq=a[19];this.dma_channel=a[20];this.dma_channel_8bit=
a[21];this.dma_channel_16bit=a[22];this.dma_autoinit=a[23];this.dma_buffer_uint8=a[24];this.dma_waiting_transfer=a[25];this.dma_paused=a[26];this.sampling_rate=a[27];this.bytes_per_sample=a[28];this.e2_value=a[29];this.e2_count=a[30];this.asp_registers=a[31];this.mpu_read_buffer_last_value=a[33];this.irq=a[34];this.irq_triggered=a[35];this.dma_buffer=this.dma_buffer_uint8.buffer;this.dma_buffer_int8=new Int8Array(this.dma_buffer);this.dma_buffer_int16=new Int16Array(this.dma_buffer);this.dma_buffer_uint16=
new Uint16Array(this.dma_buffer);this.dma_syncbuffer=new SyncBuffer(this.dma_buffer);this.dma_paused?this.bus.send("dac-disable"):this.bus.send("dac-enable")};SB16.prototype.port2x0_read=function(){dbg_log("220 read: fm music status port (unimplemented)",LOG_SB16);return 255};SB16.prototype.port2x1_read=function(){dbg_log("221 read: fm music data port (write only)",LOG_SB16);return 255};
SB16.prototype.port2x2_read=function(){dbg_log("222 read: advanced fm music status port (unimplemented)",LOG_SB16);return 255};SB16.prototype.port2x3_read=function(){dbg_log("223 read: advanced music data port (write only)",LOG_SB16);return 255};SB16.prototype.port2x4_read=function(){dbg_log("224 read: mixer address port",LOG_SB16);return this.mixer_current_address};SB16.prototype.port2x5_read=function(){dbg_log("225 read: mixer data port",LOG_SB16);return this.mixer_read(this.mixer_current_address)};
SB16.prototype.port2x6_read=function(){dbg_log("226 read: (write only)",LOG_SB16);return 255};SB16.prototype.port2x7_read=function(){dbg_log("227 read: undocumented",LOG_SB16);return 255};SB16.prototype.port2x8_read=function(){dbg_log("228 read: fm music status port (unimplemented)",LOG_SB16);return 255};SB16.prototype.port2x9_read=function(){dbg_log("229 read: fm music data port (write only)",LOG_SB16);return 255};
SB16.prototype.port2xA_read=function(){dbg_log("22A read: read data",LOG_SB16);this.read_buffer.length&&(this.read_buffer_lastvalue=this.read_buffer.shift());dbg_log(" <- "+this.read_buffer_lastvalue+" "+h(this.read_buffer_lastvalue)+" '"+String.fromCharCode(this.read_buffer_lastvalue)+"'",LOG_SB16);return this.read_buffer_lastvalue};SB16.prototype.port2xB_read=function(){dbg_log("22B read: undocumented",LOG_SB16);return 255};
SB16.prototype.port2xC_read=function(){dbg_log("22C read: write-buffer status",LOG_SB16);return 127};SB16.prototype.port2xD_read=function(){dbg_log("22D read: undocumented",LOG_SB16);return 255};SB16.prototype.port2xE_read=function(){dbg_log("22E read: read-buffer status / irq 8bit ack.",LOG_SB16);this.irq_triggered[SB_IRQ_8BIT]&&this.lower_irq(SB_IRQ_8BIT);return(this.read_buffer.length&&!this.dsp_highspeed)<<7|127};
SB16.prototype.port2xF_read=function(){dbg_log("22F read: irq 16bit ack",LOG_SB16);this.lower_irq(SB_IRQ_16BIT);return 0};SB16.prototype.port2x0_write=function(a){dbg_log("220 write: (unimplemented) fm register 0 address = "+h(a),LOG_SB16);this.fm_current_address0=0};SB16.prototype.port2x1_write=function(a){dbg_log("221 write: (unimplemented) fm register 0 data = "+h(a),LOG_SB16);var b=FM_HANDLERS[this.fm_current_address0];b||(b=this.fm_default_write);b.call(this,a,0,this.fm_current_address0)};
SB16.prototype.port2x2_write=function(a){dbg_log("222 write: (unimplemented) fm register 1 address = "+h(a),LOG_SB16);this.fm_current_address1=0};SB16.prototype.port2x3_write=function(a){dbg_log("223 write: (unimplemented) fm register 1 data ="+h(a),LOG_SB16);var b=FM_HANDLERS[this.fm_current_address1];b||(b=this.fm_default_write);b.call(this,a,1,this.fm_current_address1)};SB16.prototype.port2x4_write=function(a){dbg_log("224 write: mixer address = "+h(a),LOG_SB16);this.mixer_current_address=a};
SB16.prototype.port2x5_write=function(a){dbg_log("225 write: mixer data = "+h(a),LOG_SB16);this.mixer_write(this.mixer_current_address,a)};SB16.prototype.port2x6_write=function(a){dbg_log("226 write: reset = "+h(a),LOG_SB16);this.dsp_highspeed?(dbg_log(" -> exit highspeed",LOG_SB16),this.dsp_highspeed=!1):a&&(dbg_log(" -> reset",LOG_SB16),this.dsp_reset());this.read_buffer.clear();this.read_buffer.push(170)};SB16.prototype.port2x7_write=function(a){dbg_log("227 write: undocumented",LOG_SB16)};
SB16.prototype.port2x8_write=function(a){dbg_log("228 write: fm music register port (unimplemented)",LOG_SB16)};SB16.prototype.port2x9_write=function(a){dbg_log("229 write: fm music data port (unimplemented)",LOG_SB16)};SB16.prototype.port2xA_write=function(a){dbg_log("22A write: dsp read data port (read only)",LOG_SB16)};SB16.prototype.port2xB_write=function(a){dbg_log("22B write: undocumented",LOG_SB16)};
SB16.prototype.port2xC_write=function(a){dbg_log("22C write: write command/data",LOG_SB16);this.command===DSP_NO_COMMAND?(dbg_log("22C write: command = "+h(a),LOG_SB16),this.command=a,this.write_buffer.clear(),this.command_size=DSP_COMMAND_SIZES[a]):(dbg_log("22C write: data: "+h(a),LOG_SB16),this.write_buffer.push(a));this.write_buffer.length>=this.command_size&&this.command_do()};SB16.prototype.port2xD_write=function(a){dbg_log("22D write: undocumented",LOG_SB16)};
SB16.prototype.port2xE_write=function(a){dbg_log("22E write: dsp read buffer status (read only)",LOG_SB16)};SB16.prototype.port2xF_write=function(a){dbg_log("22F write: undocumented",LOG_SB16)};SB16.prototype.port3x0_read=function(){dbg_log("330 read: mpu data",LOG_SB16);this.mpu_read_buffer.length&&(this.mpu_read_buffer_lastvalue=this.mpu_read_buffer.shift());dbg_log(" <- "+h(this.mpu_read_buffer_lastvalue),LOG_SB16);return this.mpu_read_buffer_lastvalue};
SB16.prototype.port3x0_write=function(a){dbg_log("330 write: mpu data (unimplemented) : "+h(a),LOG_SB16)};SB16.prototype.port3x1_read=function(){dbg_log("331 read: mpu status",LOG_SB16);return 0|128*!this.mpu_read_buffer.length};SB16.prototype.port3x1_write=function(a){dbg_log("331 write: mpu command: "+h(a),LOG_SB16);255==a&&(this.mpu_read_buffer.clear(),this.mpu_read_buffer.push(254))};
SB16.prototype.command_do=function(){var a=DSP_COMMAND_HANDLERS[this.command];a||(a=this.dsp_default_handler);a.call(this);this.command=DSP_NO_COMMAND;this.command_size=0;this.write_buffer.clear()};SB16.prototype.dsp_default_handler=function(){dbg_log("Unhandled command: "+h(this.command),LOG_SB16)};function register_dsp_command(a,b,c){c||(c=SB16.prototype.dsp_default_handler);for(var d=0;d<a.length;d++)DSP_COMMAND_SIZES[a[d]]=b,DSP_COMMAND_HANDLERS[a[d]]=c}
function any_first_digit(a){for(var b=[],c=0;16>c;c++)b.push(a+c);return b}register_dsp_command([14],2,function(){this.asp_registers[this.write_buffer.shift()]=this.write_buffer.shift()});register_dsp_command([15],1,function(){this.read_buffer.clear();this.read_buffer.push(this.asp_registers[this.write_buffer.shift()])});register_dsp_command([16],1,function(){var a=audio_normalize(this.write_buffer.shift(),127.5,-1);this.dac_buffers[0].push(a);this.dac_buffers[1].push(a);this.bus.send("dac-enable")});
register_dsp_command([20,21],2,function(){this.dma_irq=SB_IRQ_8BIT;this.dma_channel=this.dma_channel_8bit;this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=this.dma_autoinit=!1;this.dma_transfer_size_set();this.dma_transfer_start()});register_dsp_command([22],2);register_dsp_command([23],2);register_dsp_command([28],0,function(){this.dma_irq=SB_IRQ_8BIT;this.dma_channel=this.dma_channel_8bit;this.dma_autoinit=!0;this.dsp_highspeed=this.dsp_16bit=this.dsp_signed=!1;this.dma_transfer_start()});
register_dsp_command([31],0);register_dsp_command([32],0,function(){this.read_buffer.clear();this.read_buffer.push(127)});register_dsp_command([36],2);register_dsp_command([44],0);register_dsp_command([48],0);register_dsp_command([49],0);register_dsp_command([52],0);register_dsp_command([53],0);register_dsp_command([54],0);register_dsp_command([55],0);register_dsp_command([56],0);register_dsp_command([64],1,function(){this.sampling_rate_change(1E6/(256-this.write_buffer.shift())/this.get_channel_count())});
register_dsp_command([65,66],2,function(){this.sampling_rate_change(this.write_buffer.shift()<<8|this.write_buffer.shift())});register_dsp_command([72],2,function(){this.dma_transfer_size_set()});register_dsp_command([116],2);register_dsp_command([117],2);register_dsp_command([118],2);register_dsp_command([119],2);register_dsp_command([125],0);register_dsp_command([127],0);register_dsp_command([128],2);
register_dsp_command([144],0,function(){this.dma_irq=SB_IRQ_8BIT;this.dma_channel=this.dma_channel_8bit;this.dma_autoinit=!0;this.dsp_signed=!1;this.dsp_highspeed=!0;this.dsp_16bit=!1;this.dma_transfer_start()});register_dsp_command([145],0);register_dsp_command([152],0);register_dsp_command([153],0);register_dsp_command([160],0);register_dsp_command([168],0);
register_dsp_command(any_first_digit(176),3,function(){if(this.command&8)this.dsp_default_handler();else{var a=this.write_buffer.shift();this.dma_irq=SB_IRQ_16BIT;this.dma_channel=this.dma_channel_16bit;this.dma_autoinit=!!(this.command&4);this.dsp_signed=!!(a&16);this.dsp_stereo=!!(a&32);this.dsp_16bit=!0;this.dma_transfer_size_set();this.dma_transfer_start()}});
register_dsp_command(any_first_digit(192),3,function(){if(this.command&8)this.dsp_default_handler();else{var a=this.write_buffer.shift();this.dma_irq=SB_IRQ_8BIT;this.dma_channel=this.dma_channel_8bit;this.dma_autoinit=!!(this.command&4);this.dsp_signed=!!(a&16);this.dsp_stereo=!!(a&32);this.dsp_16bit=!1;this.dma_transfer_size_set();this.dma_transfer_start()}});register_dsp_command([208],0,function(){this.dma_paused=!0;this.bus.send("dac-disable")});
register_dsp_command([209],0,function(){this.dummy_speaker_enabled=!0});register_dsp_command([211],0,function(){this.dummy_speaker_enabled=!1});register_dsp_command([212],0,function(){this.dma_paused=!1;this.bus.send("dac-enable")});register_dsp_command([213],0,function(){this.dma_paused=!0;this.bus.send("dac-disable")});register_dsp_command([214],0,function(){this.dma_paused=!1;this.bus.send("dac-enable")});
register_dsp_command([216],0,function(){this.read_buffer.clear();this.read_buffer.push(255*this.dummy_speaker_enabled)});register_dsp_command([217,218],0,function(){this.dma_autoinit=!1});register_dsp_command([224],1,function(){this.read_buffer.clear();this.read_buffer.push(~this.write_buffer.shift())});register_dsp_command([225],0,function(){this.read_buffer.clear();this.read_buffer.push(4);this.read_buffer.push(5)});register_dsp_command([226],1);
register_dsp_command([227],0,function(){this.read_buffer.clear();for(var a=0;a<DSP_COPYRIGHT.length;a++)this.read_buffer.push(DSP_COPYRIGHT.charCodeAt(a));this.read_buffer.push(0)});register_dsp_command([228],1,function(){this.test_register=this.write_buffer.shift()});register_dsp_command([232],0,function(){this.read_buffer.clear();this.read_buffer.push(this.test_register)});register_dsp_command([242,243],0,function(){this.raise_irq()});var SB_F9=new Uint8Array(256);SB_F9[14]=255;SB_F9[15]=7;
SB_F9[55]=56;register_dsp_command([249],1,function(){var a=this.write_buffer.shift();dbg_log("dsp 0xf9: unknown function. input: "+a,LOG_SB16);this.read_buffer.clear();this.read_buffer.push(SB_F9[a])});SB16.prototype.mixer_read=function(a){var b=MIXER_READ_HANDLERS[a];b?b=b.call(this):(b=this.mixer_registers[a],dbg_log("unhandled mixer register read. addr:"+h(a)+" data:"+h(b),LOG_SB16));return b};
SB16.prototype.mixer_write=function(a,b){var c=MIXER_WRITE_HANDLERS[a];c?c.call(this,b):dbg_log("unhandled mixer register write. addr:"+h(a)+" data:"+h(b),LOG_SB16)};SB16.prototype.mixer_default_read=function(){dbg_log("mixer register read. addr:"+h(this.mixer_current_address),LOG_SB16);return this.mixer_registers[this.mixer_current_address]};
SB16.prototype.mixer_default_write=function(a){dbg_log("mixer register write. addr:"+h(this.mixer_current_address)+" data:"+h(a),LOG_SB16);this.mixer_registers[this.mixer_current_address]=a};
SB16.prototype.mixer_reset=function(){this.mixer_registers[4]=204;this.mixer_registers[34]=204;this.mixer_registers[38]=204;this.mixer_registers[40]=0;this.mixer_registers[46]=0;this.mixer_registers[10]=0;this.mixer_registers[48]=192;this.mixer_registers[49]=192;this.mixer_registers[50]=192;this.mixer_registers[51]=192;this.mixer_registers[52]=192;this.mixer_registers[53]=192;this.mixer_registers[54]=0;this.mixer_registers[55]=0;this.mixer_registers[56]=0;this.mixer_registers[57]=0;this.mixer_registers[59]=
0;this.mixer_registers[60]=31;this.mixer_registers[61]=21;this.mixer_registers[62]=11;this.mixer_registers[63]=0;this.mixer_registers[64]=0;this.mixer_registers[65]=0;this.mixer_registers[66]=0;this.mixer_registers[67]=0;this.mixer_registers[68]=128;this.mixer_registers[69]=128;this.mixer_registers[70]=128;this.mixer_registers[71]=128;this.mixer_full_update()};SB16.prototype.mixer_full_update=function(){for(var a=1;a<this.mixer_registers.length;a++)this.mixer_write(a,this.mixer_registers[a])};
function register_mixer_read(a,b){b||(b=SB16.prototype.mixer_default_read);MIXER_READ_HANDLERS[a]=b}function register_mixer_write(a,b){b||(b=SB16.prototype.mixer_default_write);MIXER_WRITE_HANDLERS[a]=b}
function register_mixer_legacy(a,b,c){MIXER_READ_HANDLERS[a]=function(){return this.mixer_registers[b]&240|this.mixer_registers[c]>>>4};MIXER_WRITE_HANDLERS[a]=function(d){this.mixer_registers[a]=d;var e=d<<4&240|this.mixer_registers[c]&15;this.mixer_write(b,d&240|this.mixer_registers[b]&15);this.mixer_write(c,e)}}
function register_mixer_volume(a,b,c){MIXER_READ_HANDLERS[a]=SB16.prototype.mixer_default_read;MIXER_WRITE_HANDLERS[a]=function(d){this.mixer_registers[a]=d;this.bus.send("mixer-volume",[b,c,(d>>>2)-62])}}register_mixer_read(0,function(){this.mixer_reset();return 0});register_mixer_write(0);register_mixer_legacy(4,50,51);register_mixer_legacy(34,48,49);register_mixer_legacy(38,52,53);register_mixer_legacy(40,54,55);register_mixer_legacy(46,56,57);register_mixer_volume(48,MIXER_SRC_MASTER,MIXER_CHANNEL_LEFT);
register_mixer_volume(49,MIXER_SRC_MASTER,MIXER_CHANNEL_RIGHT);register_mixer_volume(50,MIXER_SRC_DAC,MIXER_CHANNEL_LEFT);register_mixer_volume(51,MIXER_SRC_DAC,MIXER_CHANNEL_RIGHT);register_mixer_read(59);register_mixer_write(59,function(a){this.mixer_registers[59]=a;this.bus.send("mixer-volume",[MIXER_SRC_PCSPEAKER,MIXER_CHANNEL_BOTH,6*(a>>>6)-18])});register_mixer_read(65);register_mixer_write(65,function(a){this.mixer_registers[65]=a;this.bus.send("mixer-gain-left",6*(a>>>6))});register_mixer_read(66);
register_mixer_write(66,function(a){this.mixer_registers[66]=a;this.bus.send("mixer-gain-right",6*(a>>>6))});register_mixer_read(68);register_mixer_write(68,function(a){this.mixer_registers[68]=a;a>>>=3;this.bus.send("mixer-treble-left",a-(16>a?14:16))});register_mixer_read(69);register_mixer_write(69,function(a){this.mixer_registers[69]=a;a>>>=3;this.bus.send("mixer-treble-right",a-(16>a?14:16))});register_mixer_read(70);
register_mixer_write(70,function(a){this.mixer_registers[70]=a;a>>>=3;this.bus.send("mixer-bass-right",a-(16>a?14:16))});register_mixer_read(71);register_mixer_write(71,function(a){this.mixer_registers[71]=a;a>>>=3;this.bus.send("mixer-bass-right",a-(16>a?14:16))});register_mixer_read(128,function(){switch(this.irq){case SB_IRQ2:return 1;case SB_IRQ5:return 2;case SB_IRQ7:return 4;case SB_IRQ10:return 8;default:return 0}});
register_mixer_write(128,function(a){a&1&&(this.irq=SB_IRQ2);a&2&&(this.irq=SB_IRQ5);a&4&&(this.irq=SB_IRQ7);a&8&&(this.irq=SB_IRQ10)});register_mixer_read(129,function(){var a=0;switch(this.dma_channel_8bit){case SB_DMA0:a|=1;break;case SB_DMA1:a|=2;break;case SB_DMA3:a|=8}switch(this.dma_channel_16bit){case SB_DMA5:a|=32;break;case SB_DMA6:a|=64;break;case SB_DMA7:a|=128}return a});
register_mixer_write(129,function(a){a&1&&(this.dma_channel_8bit=SB_DMA0);a&2&&(this.dma_channel_8bit=SB_DMA1);a&8&&(this.dma_channel_8bit=SB_DMA3);a&32&&(this.dma_channel_16bit=SB_DMA5);a&64&&(this.dma_channel_16bit=SB_DMA6);a&128&&(this.dma_channel_16bit=SB_DMA7)});register_mixer_read(130,function(){for(var a=32,b=0;16>b;b++)a|=b*this.irq_triggered[b];return a});SB16.prototype.fm_default_write=function(a,b,c){dbg_log("unhandled fm register write. addr:"+b+"|"+h(c)+" data:"+h(a),LOG_SB16)};
function register_fm_write(a,b){b||(b=SB16.prototype.fm_default_write);for(var c=0;c<a.length;c++)FM_HANDLERS[a[c]]=b}function between(a,b){for(var c=[];a<=b;a++)c.push(a);return c}var SB_FM_OPERATORS_BY_OFFSET=new Uint8Array(32);SB_FM_OPERATORS_BY_OFFSET[0]=0;SB_FM_OPERATORS_BY_OFFSET[1]=1;SB_FM_OPERATORS_BY_OFFSET[2]=2;SB_FM_OPERATORS_BY_OFFSET[3]=3;SB_FM_OPERATORS_BY_OFFSET[4]=4;SB_FM_OPERATORS_BY_OFFSET[5]=5;SB_FM_OPERATORS_BY_OFFSET[8]=6;SB_FM_OPERATORS_BY_OFFSET[9]=7;
SB_FM_OPERATORS_BY_OFFSET[10]=8;SB_FM_OPERATORS_BY_OFFSET[11]=9;SB_FM_OPERATORS_BY_OFFSET[12]=10;SB_FM_OPERATORS_BY_OFFSET[13]=11;SB_FM_OPERATORS_BY_OFFSET[16]=12;SB_FM_OPERATORS_BY_OFFSET[17]=13;SB_FM_OPERATORS_BY_OFFSET[18]=14;SB_FM_OPERATORS_BY_OFFSET[19]=15;SB_FM_OPERATORS_BY_OFFSET[20]=16;SB_FM_OPERATORS_BY_OFFSET[21]=17;function get_fm_operator(a,b){return 18*a+SB_FM_OPERATORS_BY_OFFSET[b]}register_fm_write([1],function(a,b,c){this.fm_waveform_select_enable[b]=a&1;this.fm_update_waveforms()});
register_fm_write([2]);register_fm_write([3]);register_fm_write([4],function(a,b,c){});register_fm_write([5],function(a,b,c){0===b&&this.fm_default_write(a,b,c)});register_fm_write([8],function(a,b,c){});register_fm_write(between(32,53),function(a,b,c){get_fm_operator(b,c-32)});register_fm_write(between(64,85),function(a,b,c){get_fm_operator(b,c-64)});register_fm_write(between(96,117),function(a,b,c){get_fm_operator(b,c-96)});
register_fm_write(between(128,149),function(a,b,c){get_fm_operator(b,c-128)});register_fm_write(between(160,168),function(a,b,c){});register_fm_write(between(176,184),function(a,b,c){});register_fm_write([189],function(a,b,c){});register_fm_write(between(192,200),function(a,b,c){});register_fm_write(between(224,245),function(a,b,c){get_fm_operator(b,c-224)});SB16.prototype.fm_update_waveforms=function(){};
SB16.prototype.sampling_rate_change=function(a){this.sampling_rate=a;this.bus.send("dac-tell-sampling-rate",a)};SB16.prototype.get_channel_count=function(){return this.dsp_stereo?2:1};SB16.prototype.dma_transfer_size_set=function(){this.dma_sample_count=1+(this.write_buffer.shift()<<0)+(this.write_buffer.shift()<<8)};
SB16.prototype.dma_transfer_start=function(){dbg_log("begin dma transfer",LOG_SB16);this.bytes_per_sample=1;this.dsp_16bit&&(this.bytes_per_sample*=2);this.dma_bytes_count=this.dma_sample_count*this.bytes_per_sample;this.dma_bytes_block=SB_DMA_BLOCK_SAMPLES*this.bytes_per_sample;this.dma_bytes_block=Math.min(Math.max(this.dma_bytes_count>>2&-4,32),this.dma_bytes_block);this.dma_waiting_transfer=!0;this.dma.channel_mask[this.dma_channel]||this.dma_on_unmask(this.dma_channel)};
SB16.prototype.dma_on_unmask=function(a){a===this.dma_channel&&this.dma_waiting_transfer&&(this.dma_waiting_transfer=!1,this.dma_bytes_left=this.dma_bytes_count,this.dma_paused=!1,this.bus.send("dac-enable"))};
SB16.prototype.dma_transfer_next=function(){var a=this;dbg_log("dma transfering next block",LOG_SB16);var b=Math.min(this.dma_bytes_left,this.dma_bytes_block),c=Math.floor(b/this.bytes_per_sample);this.dma.do_write(this.dma_syncbuffer,0,b,this.dma_channel,function(d){dbg_log("dma block transfer "+(d?"unsuccessful":"successful"),LOG_SB16);d||(a.dma_to_dac(c),a.dma_bytes_left-=b,a.dma_bytes_left||(a.raise_irq(a.dma_irq),a.dma_autoinit&&(a.dma_bytes_left=a.dma_bytes_count)))})};
SB16.prototype.dma_to_dac=function(a){var b=this.dsp_16bit?32767.5:127.5,c=this.dsp_signed?0:-1,d=this.dsp_stereo?1:2;var e=this.dsp_16bit?this.dsp_signed?this.dma_buffer_int16:this.dma_buffer_uint16:this.dsp_signed?this.dma_buffer_int8:this.dma_buffer_uint8;for(var f=0,g=0;g<a;g++)for(var k=audio_normalize(e[g],b,c),l=0;l<d;l++)this.dac_buffers[f].push(k),f^=1;this.dac_send()};SB16.prototype.dac_handle_request=function(){!this.dma_bytes_left||this.dma_paused?this.dac_send():this.dma_transfer_next()};
SB16.prototype.dac_send=function(){if(this.dac_buffers[0].length){var a=this.dac_buffers[0].shift_block(this.dac_buffers[0].length),b=this.dac_buffers[1].shift_block(this.dac_buffers[1].length);this.bus.send("dac-send-data",[a,b],[a.buffer,b.buffer])}};SB16.prototype.raise_irq=function(a){dbg_log("raise irq",LOG_SB16);this.irq_triggered[a]=1;this.cpu.device_raise_irq(this.irq)};SB16.prototype.lower_irq=function(a){dbg_log("lower irq",LOG_SB16);this.irq_triggered[a]=0;this.cpu.device_lower_irq(this.irq)};
function audio_normalize(a,b,c){return audio_clip(a/b+c,-1,1)}function audio_clip(a,b,c){return(a<b)*b+(a>c)*c+(b<=a&&a<=c)*a};function VirtIO(a,b,c){this.pci_space=[244,26,9,16,7,5,16,0,0,0,2,0,0,0,0,0,1,168,0,0,0,16,191,254,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,244,26,9,0,0,0,0,0,64,0,0,0,0,0,0,0,0,1,0,0];this.pci_id=48;this.pci_bars=[{size:256}];this.name="virtio";var d=a.io;d.register_read(43008,this,function(){dbg_log("Read device features",LOG_VIRTIO);return 1},void 0,function(){dbg_log("Read device features",LOG_VIRTIO);return 1});d.register_write(43012,this,void 0,void 0,function(a){dbg_log("Guest feature selection: "+
h(a,8),LOG_VIRTIO)});d.register_write(43022,this,void 0,function(a){dbg_log("Queue select: "+h(a,4),LOG_VIRTIO);this.queue_select=a},void 0);d.register_read(43020,this,void 0,function(){dbg_log("Read queue size",LOG_VIRTIO);return this.queue_size},void 0);d.register_read(43016,this,void 0,void 0,function(){dbg_log("Read queue address",LOG_VIRTIO);return 0===this.queue_select?this.queue_address:0});d.register_write(43016,this,void 0,void 0,function(a){dbg_log("Write queue address: "+h(a,8),LOG_VIRTIO);
this.queue_address=a});d.register_write(43026,this,function(a){dbg_log("Write device status: "+h(a,2),LOG_VIRTIO);0===a?(dbg_log("Reset",LOG_VIRTIO),this.reset()):a&128?dbg_log("Warning: Device status failed",LOG_VIRTIO):dbg_log((a&1?"ACKNOWLEDGE ":"")+(a&2?"DRIVER ":"")+(a&4?"DRIVER_OK":""),LOG_VIRTIO);this.device_status=a});d.register_read(43026,this,function(){dbg_log("Read device status: "+h(this.device_status),LOG_VIRTIO);return this.device_status});d.register_read(43027,this,function(){dbg_log("Read isr",
LOG_VIRTIO);var a=this.isr;this.isr=0;this.pci.lower_irq(this.pci_id);return a});d.register_write(43024,this,void 0,function(a){dbg_log("Write queue notify: "+h(a,4),LOG_VIRTIO);dbg_assert(0===a);var b=(this.queue_address<<12)+16*this.queue_size;a=b+4;b=this.cpu.read16(b+2);dbg_log("idx="+h(b,4),LOG_VIRTIO);var e=this.queue_size-1;for(b&=e;this.last_idx!==b;){var c=this.cpu.read16(a+2*this.last_idx);this.handle_descriptor(c);this.last_idx=this.last_idx+1&e}});this.cpu=a;this.pci=a.devices.pci;this.bus=
b;this.last_idx=this.isr=this.device_status=this.queue_select=0;this.queue_size=32;for(var e=this.queue_address=0;128>e;e++)d.register_read(43028+e,this,function(a){dbg_log("Read device "+h(a),LOG_VIRTIO);return a<this.device.configspace.length?this.device.configspace[a]:0}.bind(this,e),void 0,void 0),d.register_write(43028+e,this,function(a,b){dbg_log("Write device "+h(a)+": "+h(b,2),LOG_VIRTIO)}.bind(this,e),void 0,void 0);this.device=new Virtio9p(c,b);this.device.SendReply=this.device_reply.bind(this);
a.devices.pci.register_device(this)}VirtIO.prototype.get_state=function(){var a=[0];a[1]=this.queue_select;a[2]=this.device_status;a[3]=this.isr;a[4]=this.last_idx;a[5]=this.queue_size;a[6]=this.queue_address;a[7]=this.device;return a};VirtIO.prototype.set_state=function(a){this.queue_select=a[1];this.device_status=a[2];this.isr=a[3];this.last_idx=a[4];this.queue_size=a[5];this.queue_address=a[6];this.device=a[7];this.device.SendReply=this.device_reply.bind(this)};
VirtIO.prototype.reset=function(){this.last_idx=this.isr=this.device_status=this.queue_select=0;this.queue_size=32;this.queue_address=0};
VirtIO.prototype.handle_descriptor=function(a){var b=a,c=this.queue_address<<12,d=0,e=[];do{var f=c+16*b,g=this.cpu.read16(f+12);if(g&VRING_DESC_F_WRITE)break;g&VRING_DESC_F_INDIRECT&&dbg_assert(!1,"unsupported");var k=this.cpu.read32s(f),l=this.cpu.read32s(f+4),m=this.cpu.read32s(f+8)>>>0;e.push({addr_low:k,addr_high:l,len:m});dbg_log("descriptor: addr="+h(l,8)+":"+h(k,8)+" len="+h(m,8)+" flags="+h(g,4)+" next="+h(b,4),LOG_VIRTIO);if(g&VRING_DESC_F_NEXT)b=this.cpu.read16(f+14),dbg_assert(b<this.queue_size);
else{b=-1;break}}while(1);var p=-1,n=0;this.device.ReceiveRequest({start:a,next:b},function(){if(n>=p){if(d===e.length)return dbg_log("Read more data than descriptor has",LOG_VIRTIO),0;var a=e[d++];k=a.addr_low;p=a.len;n=0}return this.cpu.read8(k+n++)}.bind(this))};
VirtIO.prototype.device_reply=function(a,b){if(-1===b.next)dbg_log("Reply to invalid index",LOG_VIRTIO);else{var c=this.queue_size-1;a=this.device.replybuffersize;var d=b.next,e=this.queue_address<<12,f=0,g=[];do{var k=e+16*d,l=this.cpu.read16(k+12);if(0===(l&VRING_DESC_F_WRITE)){dbg_log("Bug: Readonly ring after writeonly ring",LOG_VIRTIO);break}var m=this.cpu.read32s(k),p=this.cpu.read32s(k+4),n=this.cpu.read32s(k+8)>>>0;g.push({addr_low:m,addr_high:p,len:n});dbg_log("descriptor: addr="+h(p,8)+
":"+h(m,8)+" len="+h(n,8)+" flags="+h(l,4)+" next="+h(d,4),LOG_VIRTIO);if(l&VRING_DESC_F_NEXT)d=this.cpu.read16(k+14),dbg_assert(d<this.queue_size);else break}while(1);e=-1;for(l=k=0;l<a;l++){d=this.device.replybuffer[l];if(k>=e){if(f===g.length)return dbg_log("Write more data than descriptor has",LOG_VIRTIO),0;e=g[f++];m=e.addr_low;e=e.len;k=0}this.cpu.write8(m+k++,d)}m=(this.queue_address<<12)+16*this.queue_size+4+2*this.queue_size;m=m+4095&-4096;l=this.cpu.read16(m);f=this.cpu.read16(m+2);this.cpu.write16(m+
2,f+1);dbg_log("used descriptor: addr="+h(m,8)+" flags="+h(l,4)+" idx="+h(f,4),LOG_VIRTIO);c=m+4+8*(f&c);this.cpu.write32(c,b.start);this.cpu.write32(c+4,a);this.isr|=1;this.pci.raise_irq(this.pci_id)}};var Bus={};function BusConnector(){this.listeners={};this.pair=void 0}BusConnector.prototype.register=function(a,b,c){var d=this.listeners[a];void 0===d&&(d=this.listeners[a]=[]);d.push({fn:b,this_value:c})};BusConnector.prototype.unregister=function(a,b){var c=this.listeners[a];void 0!==c&&(this.listeners[a]=c.filter(function(a){return a.fn!==b}))};
BusConnector.prototype.send=function(a,b,c){if(this.pair&&(a=this.pair.listeners[a],void 0!==a))for(c=0;c<a.length;c++){var d=a[c];d.fn.call(d.this_value,b)}};BusConnector.prototype.send_async=function(a,b){dbg_assert(1===arguments.length||2===arguments.length);setTimeout(this.send.bind(this,a,b),0)};Bus.create=function(){var a=new BusConnector,b=new BusConnector;a.pair=b;b.pair=a;return[a,b]};var log_data=[];function do_the_log(a){LOG_TO_FILE?log_data.push(a,"\n"):console.log(a)}
var dbg_log=function(){if(!DEBUG)return function(){};var a=LOG_NAMES.reduce(function(a,b){a[b[0]]=b[1];return a},{}),b="",c=0;return function(d,e){if(DEBUG&&(e=e||1,e&LOG_LEVEL)){d="["+v86util.pads(a[e]||"",4)+"] "+d;if(d===b&&(c++,2048>c))return;e=new Date;e=v86util.pad0(e.getHours(),2)+":"+v86util.pad0(e.getMinutes(),2)+":"+v86util.pad0(e.getSeconds(),2)+"+"+v86util.pad0(e.getMilliseconds(),3)+" ";c&&(1===c?do_the_log(e+b):do_the_log("Previous message repeated "+c+" times"),c=0);do_the_log(e+d);
b=d}}}();function dbg_trace(a){DEBUG&&dbg_log(Error().stack.replace(/(?:(?:t|t16|t32)\.\(anonymous function\)\.)+/g,"t.(anonymous function)."),a)}function dbg_assert(a,b,c){DEBUG&&(a||dbg_assert_failed(b))}function dbg_assert_failed(a){debugger;console.trace();if(a)throw"Assert failed: "+a;throw"Assert failed";};var instruction_count,instruction_total,CPU_LOG_VERBOSE=!1;
function CPU(a){this.memory_size=0;this.a20_enabled=!0;this.mem_page_infos=void 0;this.mem8=new Uint8Array(0);this.mem16=new Uint16Array(this.mem8.buffer);this.mem32s=new Int32Array(this.mem8.buffer);this.segment_is_null=new Uint8Array(8);this.segment_limits=new Uint32Array(8);this.segment_offsets=new Int32Array(8);this.tlb_data=new Int32Array(1048576);this.tlb_info=new Uint8Array(1048576);this.tlb_info_global=new Uint8Array(1048576);this.protected_mode=!1;this.gdtr_offset=this.gdtr_size=this.idtr_offset=
this.idtr_size=0;this.page_fault=this.tss_size_32=!1;this.cr=new Int32Array(8);this.cr[0]=0;this.cr[2]=0;this.cr[3]=0;this.page_size_extensions=this.cpl=this.cr[4]=0;this.in_hlt=this.stack_size_32=this.is_32=!1;this.last_result=this.last_add_result=this.last_op_size=this.last_op2=this.last_op1=this.flags_changed=this.flags=this.prefixes=this.sysenter_eip=this.sysenter_esp=this.sysenter_cs=this.esp_phys=this.last_virt_esp=this.eip_phys=this.last_virt_eip=0;this.mul32_result=new Int32Array(2);this.div32_result=
new Float64Array(2);this.phys_addr_high=this.phys_addr=this.modrm_byte=this.tsc_offset=0;this.devices={};this.table=[];this.paging=!1;this.previous_ip=this.instruction_pointer=0;this.apic_enabled=!0;this.timestamp_counter=0;this.reg32s=new Int32Array(8);this.reg32=new Uint32Array(this.reg32s.buffer);this.reg16s=new Int16Array(this.reg32s.buffer);this.reg16=new Uint16Array(this.reg32s.buffer);this.reg8s=new Int8Array(this.reg32s.buffer);this.reg8=new Uint8Array(this.reg32s.buffer);this.reg_mmxs=new Int32Array(16);
this.reg_mmx=new Uint32Array(this.reg_mmxs.buffer);this.reg_mmx8s=new Int8Array(this.reg_mmxs.buffer);this.reg_mmx8=new Uint8Array(this.reg_mmxs.buffer);this.reg_xmm32s=new Int32Array(32);this.mxcsr=8064;this.sreg=new Uint16Array(8);this.dreg=new Int32Array(8);this.memory_map_read8=[];this.memory_map_write8=[];this.memory_map_read32=[];this.memory_map_write32=[];this.bios={main:null,vga:null};this.fw_value=0;this.fpu=this.io=void 0;this.bus=a;dbg_assert(this.table16&&this.table32);dbg_assert(this.table0F_16&&
this.table0F_32);this.update_operand_size();this.tsc_offset=v86.microtick();this.debug_init();this.init2()}
CPU.prototype.get_state=function(){var a=[];a[0]=this.memory_size;a[1]=this.segment_is_null;a[2]=this.segment_offsets;a[3]=this.segment_limits;a[4]=this.protected_mode;a[5]=this.idtr_offset;a[6]=this.idtr_size;a[7]=this.gdtr_offset;a[8]=this.gdtr_size;a[9]=this.page_fault;a[10]=this.cr;a[11]=this.cpl;a[12]=this.page_size_extensions;a[13]=this.is_32;a[16]=this.stack_size_32;a[17]=this.in_hlt;a[18]=this.last_virt_eip;a[19]=this.eip_phys;a[20]=this.last_virt_esp;a[21]=this.esp_phys;a[22]=this.sysenter_cs;
a[23]=this.sysenter_eip;a[24]=this.sysenter_esp;a[25]=this.prefixes;a[26]=this.flags;a[27]=this.flags_changed;a[28]=this.last_op1;a[29]=this.last_op2;a[30]=this.last_op_size;a[31]=this.last_add_result;a[32]=this.modrm_byte;a[36]=this.paging;a[37]=this.instruction_pointer;a[38]=this.previous_ip;a[39]=this.reg32s;a[40]=this.sreg;a[41]=this.dreg;a[42]=this.mem8;a[43]=this.fpu;a[45]=this.devices.virtio;a[46]=this.devices.apic;a[47]=this.devices.rtc;a[48]=this.devices.pci;a[49]=this.devices.dma;a[50]=
this.devices.acpi;a[51]=this.devices.hpet;a[52]=this.devices.vga;a[53]=this.devices.ps2;a[54]=this.devices.uart;a[55]=this.devices.fdc;a[56]=this.devices.cdrom;a[57]=this.devices.hda;a[58]=this.devices.pit;a[59]=this.devices.net;a[60]=this.devices.pic;a[61]=this.devices.sb16;a[62]=this.a20_enabled;a[63]=this.fw_value;a[64]=this.devices.ioapic;a[65]=this.tss_size_32;a[66]=this.reg_mmxs;return a};
CPU.prototype.set_state=function(a){this.memory_size=a[0];this.segment_is_null=a[1];this.segment_offsets=a[2];this.segment_limits=a[3];this.protected_mode=a[4];this.idtr_offset=a[5];this.idtr_size=a[6];this.gdtr_offset=a[7];this.gdtr_size=a[8];this.page_fault=a[9];this.cr=a[10];this.cpl=a[11];this.page_size_extensions=a[12];this.is_32=a[13];this.stack_size_32=a[16];this.in_hlt=a[17];this.last_virt_eip=a[18];this.eip_phys=a[19];this.last_virt_esp=a[20];this.esp_phys=a[21];this.sysenter_cs=a[22];this.sysenter_eip=
a[23];this.sysenter_esp=a[24];this.prefixes=a[25];this.flags=a[26];this.flags_changed=a[27];this.last_op1=a[28];this.last_op2=a[29];this.last_op_size=a[30];this.last_add_result=a[31];this.modrm_byte=a[32];this.paging=a[36];this.instruction_pointer=a[37];this.previous_ip=a[38];this.reg32s=a[39];this.sreg=a[40];this.dreg=a[41];this.mem8=a[42];this.fpu=a[43];this.devices.virtio=a[45];this.devices.apic=a[46];this.devices.rtc=a[47];this.devices.pci=a[48];this.devices.dma=a[49];this.devices.acpi=a[50];
this.devices.hpet=a[51];this.devices.vga=a[52];this.devices.ps2=a[53];this.devices.uart=a[54];this.devices.fdc=a[55];this.devices.cdrom=a[56];this.devices.hda=a[57];this.devices.pit=a[58];this.devices.net=a[59];this.devices.pic=a[60];this.devices.sb16=a[61];this.a20_enabled=a[62];this.fw_value=a[63];this.devices.ioapic=a[64];this.tss_size_32=a[65];this.reg_mmxs=a[66];this.mem16=new Uint16Array(this.mem8.buffer,this.mem8.byteOffset,this.mem8.length>>1);this.mem32s=new Int32Array(this.mem8.buffer,this.mem8.byteOffset,
this.mem8.length>>2);this.full_clear_tlb();this.reg32=new Uint32Array(this.reg32s.buffer);this.reg16s=new Int16Array(this.reg32s.buffer);this.reg16=new Uint16Array(this.reg32s.buffer);this.reg8s=new Int8Array(this.reg32s.buffer);this.reg8=new Uint8Array(this.reg32s.buffer);this.reg_mmx=new Uint32Array(this.reg_mmxs.buffer);this.reg_mmx8s=new Int8Array(this.reg_mmxs.buffer);this.reg_mmx8=new Uint8Array(this.reg_mmxs.buffer);this.update_operand_size()};
CPU.prototype.main_run=function(){if(this.in_hlt){var a=this.hlt_loop();if(this.in_hlt)return a}this.do_run();return 0};CPU.prototype.exception_cleanup=function(a){if(a===MAGIC_CPU_EXCEPTION)this.page_fault=!1,this.clear_prefixes();else throw console.log(a),console.log(a.stack),a;};CPU.prototype.reboot_internal=function(){this.reset();this.load_bios();throw MAGIC_CPU_EXCEPTION;};
CPU.prototype.reset=function(){this.a20_enabled=!0;for(var a=0;8>a;a++)this.segment_is_null[a]=0,this.segment_limits[a]=0,this.segment_offsets[a]=0;this.full_clear_tlb();for(a=0;8>a;a++)this.reg32s[a]=0,this.sreg[a]=0,this.cr[a]=0,this.dreg[a]=0;for(a=0;a<this.reg_mmxs.length;a++)this.reg_mmxs[a]=0;for(a=0;a<this.reg_xmm32s.length;a++)this.reg_xmm32s[a]=0;this.mxcsr=8064;this.protected_mode=!1;this.gdtr_offset=this.gdtr_size=this.idtr_offset=this.idtr_size=0;this.page_fault=!1;this.cr[0]=1610612752;
this.cr[2]=0;this.cr[3]=0;this.cr[4]=0;this.dreg[6]=-61456;this.dreg[7]=1024;this.cpl=0;this.paging=!1;this.page_size_extensions=0;this.stack_size_32=this.is_32=!1;this.prefixes=0;this.last_virt_esp=this.last_virt_eip=-1;this.update_operand_size();this.previous_ip=this.timestamp_counter=0;this.in_hlt=!1;this.sysenter_eip=this.sysenter_esp=this.sysenter_cs=0;this.flags=flags_default;this.last_op_size=this.last_op2=this.last_op1=this.last_add_result=this.last_result=this.flags_changed=0;this.tsc_offset=
v86.microtick();this.instruction_pointer=1048560;this.switch_cs_real_mode(61440);this.switch_seg(reg_ss,48);this.reg16[reg_sp]=256;this.devices.virtio&&this.devices.virtio.reset();this.fw_value=0};CPU.prototype.create_memory=function(a){1048576>a?a=1048576:0>(a|0)&&(a=Math.pow(2,31)-MMAP_BLOCK_SIZE);a=(a-1|MMAP_BLOCK_SIZE-1)+1|0;dbg_assert(0<(a|0));dbg_assert(0===(a&MMAP_BLOCK_SIZE-1));this.memory_size=a;a=new ArrayBuffer(a);this.mem8=new Uint8Array(a);this.mem16=new Uint16Array(a);this.mem32s=new Int32Array(a)};
goog.exportProperty(CPU.prototype,"create_memory",CPU.prototype.create_memory);
CPU.prototype.init=function(a,b){this.create_memory("number"===typeof a.memory_size?a.memory_size:67108864);this.reset();var c=new IO(this);this.io=c;this.bios.main=a.bios;this.bios.vga=a.vga_bios;this.load_bios();var d=0;c.register_read(179,this,function(){dbg_log("port 0xB3 read");return 0});c.register_read(146,this,function(){return d});c.register_write(146,this,function(a){d=a});c.register_read(1297,this,function(){var a=this.fw_value&255;this.fw_value>>>=8;return a});c.register_write(1296,this,
void 0,function(a){dbg_log("bios config port, index="+h(a));a===FW_CFG_SIGNATURE?this.fw_value=-89064784:a===FW_CFG_RAM_SIZE?this.fw_value=this.memory_size:a===FW_CFG_NB_CPUS?this.fw_value=1:(dbg_assert(!1,"Unimplemented fw index: "+h(a)),this.fw_value=0)});DEBUG&&c.register_write(128,this,function(a){});this.devices={};a.load_devices&&(this.devices.pic=new PIC(this),this.devices.pci=new PCI(this),ENABLE_ACPI&&(this.devices.ioapic=new IOAPIC(this),this.devices.apic=new APIC(this),this.devices.acpi=
new ACPI(this)),this.devices.rtc=new RTC(this),this.fill_cmos(this.devices.rtc,a),this.devices.dma=new DMA(this),ENABLE_HPET&&(this.devices.hpet=new HPET(this)),this.devices.vga=new VGAScreen(this,b,a.vga_memory_size||8388608),this.fpu=new FPU(this),this.devices.ps2=new PS2(this,b),this.devices.uart=new UART(this,1016,b),this.devices.fdc=new FloppyController(this,a.fda,a.fdb),c=0,a.hda&&(this.devices.hda=new IDEDevice(this,a.hda,!1,c++,b)),a.cdrom&&(this.devices.cdrom=new IDEDevice(this,a.cdrom,!0,
c++,b)),a.hdb&&(this.devices.hdb=new IDEDevice(this,a.hdb,!1,c++,b)),this.devices.pit=new PIT(this,b),a.enable_ne2k&&(this.devices.net=new Ne2k(this,b)),a.fs9p&&(this.devices.virtio=new VirtIO(this,b,a.fs9p)),this.devices.sb16=new SB16(this,b));a.multiboot&&(dbg_assert(a.multiboot.buffer),this.load_multiboot(a.multiboot.buffer));DEBUG&&this.debug.init()};
CPU.prototype.load_multiboot=function(a){dbg_log("Trying multiboot from buffer of size "+a.byteLength,LOG_CPU);if(8192>a.byteLength){var b=new Int32Array(2048);(new Uint8Array(b.buffer)).set(new Uint8Array(a))}else b=new Int32Array(a,0,2048);for(var c=0;8192>c;c+=4)if(464367618===b[c>>2]){var d=b[c+4>>2];if(464367618+d+b[c+8>>2]|0)dbg_log("Multiboot checksum check failed",LOG_CPU);else{dbg_log("Multiboot magic found, flags: "+h(d>>>0,8),LOG_CPU);dbg_assert(0===(d&-65537),"TODO");this.reg32s[reg_eax]=
732803074;this.reg32s[reg_ebx]=31744;this.write32(31744,0);this.cr[0]=1;this.protected_mode=!0;this.flags=flags_default;this.update_cs_size(!0);this.stack_size_32=!0;for(var e=0;6>e;e++)this.segment_is_null[e]=0,this.segment_offsets[e]=0,this.segment_limits[e]=4294967295,this.sreg[e]=45058;if(d&65536){dbg_log("Multiboot specifies its own address table",LOG_CPU);var f=b[c+12>>2];d=b[c+16>>2];e=b[c+20>>2];var g=b[c+24>>2];b=b[c+28>>2];dbg_log("header="+h(f,8)+" load="+h(d,8)+" load_end="+h(e,8)+" bss_end="+
h(g,8)+" entry="+h(b,8));dbg_assert(d<=f);c-=f-d;0===e?e=void 0:(dbg_assert(e>=d),e-=d);a=new Uint8Array(a,c,e);this.write_blob(a,d);this.instruction_pointer=this.get_seg(reg_cs)+b|0}else if(1179403647===b[0])for(dbg_log("Multiboot image is in elf format",LOG_CPU),d=read_elf(a),this.instruction_pointer=this.get_seg(reg_cs)+d.header.entry|0,d=$jscomp.makeIterator(d.program_headers),c=d.next();!c.done;c=d.next())c=c.value,0!==c.type&&(1===c.type?(dbg_assert(c.paddr===c.vaddr),dbg_assert(c.filesz<=c.memsz),
b=new Uint8Array(a,c.offset,c.filesz),this.write_blob(b,c.paddr)):4!==c.type&&1685382480!==c.type&&1685382481!==c.type&&dbg_assert(!1,"unimplemented elf section type"));else dbg_assert(!1,"Not a bootable multiboot format");this.io.register_write_consecutive(244,this,function(a){console.log("Test exited with code "+h(a,2));throw"HALT";},function(){},function(){},function(){});for(a={i$11:14};15>=a.i$11;a={i$11:a.i$11},a.i$11++)this.io.register_write(8192+a.i$11,this,function(a){return function(b){dbg_log("kvm-unit-test: Set irq "+
h(a.i$11)+" to "+h(b,2));b?this.device_raise_irq(a.i$11):this.device_lower_irq(a.i$11)}}(a));dbg_log("Starting multiboot kernel at:",LOG_CPU);this.debug.dump_state();this.debug.dump_regs();break}}};
CPU.prototype.fill_cmos=function(a,b){var c=b.boot_order||531;a.cmos_write(CMOS_BIOS_BOOTFLAG1,1|c>>4&240);a.cmos_write(CMOS_BIOS_BOOTFLAG2,c&255);a.cmos_write(CMOS_MEM_BASE_LOW,128);a.cmos_write(CMOS_MEM_BASE_HIGH,2);c=0;1048576<=this.memory_size&&(c=this.memory_size-1048576>>10,c=Math.min(c,65535));a.cmos_write(CMOS_MEM_OLD_EXT_LOW,c&255);a.cmos_write(CMOS_MEM_OLD_EXT_HIGH,c>>8&255);a.cmos_write(CMOS_MEM_EXTMEM_LOW,c&255);a.cmos_write(CMOS_MEM_EXTMEM_HIGH,c>>8&255);c=0;16777216<=this.memory_size&&
(c=this.memory_size-16777216>>16,c=Math.min(c,65535));a.cmos_write(CMOS_MEM_EXTMEM2_LOW,c&255);a.cmos_write(CMOS_MEM_EXTMEM2_HIGH,c>>8&255);a.cmos_write(CMOS_MEM_HIGHMEM_LOW,0);a.cmos_write(CMOS_MEM_HIGHMEM_MID,0);a.cmos_write(CMOS_MEM_HIGHMEM_HIGH,0);a.cmos_write(CMOS_EQUIPMENT_INFO,47);a.cmos_write(CMOS_BIOS_SMP_COUNT,0);b.fastboot&&a.cmos_write(63,1)};
CPU.prototype.load_bios=function(){var a=this.bios.main,b=this.bios.vga;if(a){var c=new Uint8Array(a);this.write_blob(c,1048576-a.byteLength);if(b){var d=new Uint8Array(b);this.write_blob(d,786432);this.io.mmap_register(4272947200,1048576,function(a){a=a-4272947200|0;return a<d.length?d[a]:0},function(a,b){dbg_assert(!1,"Unexpected write to VGA rom")})}else dbg_log("Warning: No VGA BIOS");this.io.mmap_register(4293918720,1048576,function(a){return this.mem8[a&1048575]}.bind(this),function(a,b){this.mem8[a&
1048575]=b}.bind(this))}else dbg_log("Warning: No BIOS")};CPU.prototype.do_run=function(){for(var a=v86.microtick(),b=a;b-a<TIME_PER_FRAME;){this.run_hardware_timers(b);this.handle_irqs();this.do_many_cycles();if(this.in_hlt)break;b=v86.microtick()}};CPU.prototype.do_many_cycles=function(){try{this.do_many_cycles_unsafe()}catch(a){this.exception_cleanup(a)}};CPU.prototype.do_many_cycles_unsafe=function(){for(var a=LOOP_COUNTER;a--;)this.cycle_internal()};
"undefined"!==typeof window&&(window.__no_inline_for_closure_compiler__=[CPU.prototype.exception_cleanup,CPU.prototype.do_many_cycles_unsafe,CPU.prototype.do_many_cycles]);var PROFILING=!1;
CPU.prototype.cycle_internal=function(){this.previous_ip=this.instruction_pointer;this.timestamp_counter++;if(PROFILING)var a=performance.now();var b=this.read_imm8();DEBUG&&this.debug.logop(this.instruction_pointer-1>>>0,b);this.table[b](this);if(PROFILING){var c=performance.now();instruction_total[b]+=c-a;instruction_count[b]++}this.flags&flag_trap&&dbg_log("Trap flag: Ignored",LOG_CPU)};CPU.prototype.cycle=function(){try{this.cycle_internal()}catch(a){this.exception_cleanup(a)}};
goog.exportProperty(CPU.prototype,"cycle",CPU.prototype.cycle);CPU.prototype.segment_prefix_op=function(a){dbg_assert(5>=a);this.prefixes|=a+1;this.run_prefix_instruction();this.prefixes=0};CPU.prototype.run_prefix_instruction=function(){if(this.is_osize_32())this.table32[this.read_imm8()](this);else this.table16[this.read_imm8()](this)};CPU.prototype.hlt_loop=function(){dbg_assert(this.flags&flag_interrupt);this.run_hardware_timers(v86.microtick());this.handle_irqs();return 0};
CPU.prototype.run_hardware_timers=function(a){ENABLE_HPET?(this.devices.pit.timer(a,this.devices.hpet.legacy_mode),this.devices.rtc.timer(a,this.devices.hpet.legacy_mode),this.devices.hpet.timer(a)):(this.devices.pit.timer(a,!1),this.devices.rtc.timer(a,!1));ENABLE_ACPI&&(this.devices.acpi.timer(a),this.devices.apic.timer(a))};CPU.prototype.clear_prefixes=function(){this.prefixes=0};
CPU.prototype.set_cr0=function(a){if((a&(CR0_PE|CR0_PG))===CR0_PG)throw this.debug.unimpl("#GP handler");this.cr[0]=a;this.fpu||(this.cr[0]|=CR0_EM);this.cr[0]|=CR0_ET;a=(this.cr[0]&CR0_PG)===CR0_PG;dbg_assert("boolean"===typeof this.paging);a!==this.paging&&(this.paging=a,this.full_clear_tlb());this.protected_mode=(this.cr[0]&CR0_PE)===CR0_PE};
CPU.prototype.set_cr4=function(a){a&-3565568&&this.trigger_gp(0);(this.cr[4]^a)&CR4_PGE&&(a&CR4_PGE?this.clear_tlb():this.full_clear_tlb());this.cr[4]=a;this.page_size_extensions=a&CR4_PSE?PSE_ENABLED:0;if(a&CR4_PAE)throw this.debug.unimpl("PAE");a&4294965504&&(dbg_assert(!1,"Unimplemented CR4 bits: "+h(a)),this.trigger_ud());dbg_log("cr4="+h(a>>>0),LOG_CPU)};CPU.prototype.cpl_changed=function(){this.last_virt_esp=this.last_virt_eip=-1};
CPU.prototype.read_imm8=function(){this.instruction_pointer&-4096^this.last_virt_eip&&(this.eip_phys=this.translate_address_read(this.instruction_pointer)^this.instruction_pointer,this.last_virt_eip=this.instruction_pointer&-4096);var a=this.read8(this.eip_phys^this.instruction_pointer);this.instruction_pointer=this.instruction_pointer+1|0;return a};CPU.prototype.read_imm8s=function(){return this.read_imm8()<<24>>24};
CPU.prototype.read_imm16=function(){if(4094<(this.instruction_pointer^this.last_virt_eip)>>>0)return this.read_imm8()|this.read_imm8()<<8;var a=this.read16(this.eip_phys^this.instruction_pointer);this.instruction_pointer=this.instruction_pointer+2|0;return a};
CPU.prototype.read_imm32s=function(){if(4092<(this.instruction_pointer^this.last_virt_eip)>>>0)return this.read_imm16()|this.read_imm16()<<16;var a=this.read32s(this.eip_phys^this.instruction_pointer);this.instruction_pointer=this.instruction_pointer+4|0;return a};CPU.prototype.create_atom64s=function(a,b){var c=new Int32Array(2);c[0]=a;c[1]=b;return c};CPU.prototype.create_atom128s=function(a,b,c,d){var e=new Int32Array(4);e[0]=a;e[1]=b;e[2]=c;e[3]=d;return e};
CPU.prototype.read_modrm_byte=function(){this.modrm_byte=this.read_imm8()};CPU.prototype.read_op0F=CPU.prototype.read_imm8;CPU.prototype.read_sib=CPU.prototype.read_imm8;CPU.prototype.read_op8=CPU.prototype.read_imm8;CPU.prototype.read_op8s=CPU.prototype.read_imm8s;CPU.prototype.read_op16=CPU.prototype.read_imm16;CPU.prototype.read_op32s=CPU.prototype.read_imm32s;CPU.prototype.read_disp8=CPU.prototype.read_imm8;CPU.prototype.read_disp8s=CPU.prototype.read_imm8s;CPU.prototype.read_disp16=CPU.prototype.read_imm16;
CPU.prototype.read_disp32s=CPU.prototype.read_imm32s;CPU.prototype.init2=function(){};CPU.prototype.branch_taken=function(){};CPU.prototype.branch_not_taken=function(){};CPU.prototype.diverged=function(){};CPU.prototype.modrm_resolve=function(a){dbg_assert(192>a);return(this.is_asize_32()?this.modrm_table32:this.modrm_table16)[a](this)};CPU.prototype.sib_resolve=function(a){return this.sib_table[this.read_sib()](this,a)};CPU.prototype.clear_instruction_cache=function(){};
CPU.prototype.virt_boundary_read16=function(a,b){dbg_assert(4095===(a&4095));dbg_assert(0===(b&4095));return this.read8(a)|this.read8(b)<<8};CPU.prototype.virt_boundary_read32s=function(a,b){dbg_assert(4093<=(a&4095));dbg_assert((b-3&4095)===(a&4095));var c=a&1?a&2?this.read_aligned16(b-2>>1):this.read_aligned16(a+1>>1):this.virt_boundary_read16(a+1|0,b-1|0);return this.read8(a)|c<<8|this.read8(b)<<24};
CPU.prototype.virt_boundary_write16=function(a,b,c){dbg_assert(4095===(a&4095));dbg_assert(0===(b&4095));this.write8(a,c);this.write8(b,c>>8)};CPU.prototype.virt_boundary_write32=function(a,b,c){dbg_assert(4093<=(a&4095));dbg_assert((b-3&4095)===(a&4095));this.write8(a,c);this.write8(b,c>>24);a&1?a&2?(this.write8(b-2,c>>8),this.write8(b-1,c>>16)):(this.write8(a+1|0,c>>8),this.write8(a+2|0,c>>16)):(this.write8(a+1|0,c>>8),this.write8(b-1,c>>16))};
CPU.prototype.safe_read8=function(a){dbg_assert(2147483648>a);return this.read8(this.translate_address_read(a))};CPU.prototype.safe_read16=function(a){return this.paging&&4095===(a&4095)?this.safe_read8(a)|this.safe_read8(a+1|0)<<8:this.read16(this.translate_address_read(a))};CPU.prototype.safe_read32s=function(a){return this.paging&&4093<=(a&4095)?this.safe_read16(a)|this.safe_read16(a+2|0)<<16:this.read32s(this.translate_address_read(a))};
CPU.prototype.safe_read64s=function(a){var b=this.create_atom64s(0,0);this.paging&&4089<=(a&4095)?(b[0]=this.safe_read32s(a),b[1]=this.safe_read32s(a+4|0)):(b[0]=this.read32s(this.translate_address_read(a)),b[1]=this.read32s(this.translate_address_read(a+4|0)));return b};CPU.prototype.safe_read128s_aligned=function(a){dbg_assert(0===(a&15));a=this.translate_address_read(a);return this.create_atom128s(this.read32s(a),this.read32s(a+4|0),this.read32s(a+8|0),this.read32s(a+12|0))};
CPU.prototype.safe_read128s_unaligned=function(a){return this.create_atom128s(this.safe_read32s(a),this.safe_read32s(a+4|0),this.safe_read32s(a+8|0),this.safe_read32s(a+12|0))};CPU.prototype.safe_write8=function(a,b){dbg_assert(2147483648>a);this.write8(this.translate_address_write(a),b)};CPU.prototype.safe_write16=function(a,b){var c=this.translate_address_write(a);4095===(a&4095)?this.virt_boundary_write16(c,this.translate_address_write(a+1|0),b):this.write16(c,b)};
CPU.prototype.safe_write32=function(a,b){var c=this.translate_address_write(a);4093<=(a&4095)?this.virt_boundary_write32(c,this.translate_address_write(a+3&-4)|a+3&3,b):this.write32(c,b)};CPU.prototype.safe_write64=function(a,b,c){this.writable_or_pagefault(a,8);this.safe_write32(a,b);this.safe_write32(a+4|0,c)};CPU.prototype.safe_write128=function(a,b,c,d,e){this.writable_or_pagefault(a,16);this.safe_write32(a,b);this.safe_write32(a+4|0,c);this.safe_write32(a+8|0,d);this.safe_write32(a+12|0,e)};
CPU.prototype.read_moffs=function(){return this.is_asize_32()?this.get_seg_prefix(reg_ds)+this.read_op32s()|0:this.get_seg_prefix(reg_ds)+this.read_op16()|0};CPU.prototype.getiopl=function(){return this.flags>>12&3};CPU.prototype.vm86_mode=function(){return!!(this.flags&flag_vm)};CPU.prototype.get_eflags=function(){return this.flags&~flags_all|!!this.getcf()|!!this.getpf()<<2|!!this.getaf()<<4|!!this.getzf()<<6|!!this.getsf()<<7|!!this.getof()<<11};
CPU.prototype.update_eflags=function(a){var b=flag_rf|flag_vm|flag_vip|flag_vif,c=~flag_vip&~flag_vif&flags_mask;this.flags&flag_vm?(dbg_assert(3===this.getiopl()),b|=flag_iopl,c|=flag_vip|flag_vif):(this.protected_mode||dbg_assert(0===this.cpl),this.cpl&&(b|=flag_iopl,this.cpl>this.getiopl()&&(b|=flag_interrupt)));this.flags=(a^(this.flags^a)&b)&c|flags_default;this.flags_changed=0};CPU.prototype.get_stack_reg=function(){return this.stack_size_32?this.reg32s[reg_esp]:this.reg16[reg_sp]};
CPU.prototype.set_stack_reg=function(a){this.stack_size_32?this.reg32s[reg_esp]=a:this.reg16[reg_sp]=a};CPU.prototype.adjust_stack_reg=function(a){this.stack_size_32?this.reg32s[reg_esp]+=a:this.reg16[reg_sp]+=a};CPU.prototype.get_stack_pointer=function(a){return this.stack_size_32?this.get_seg(reg_ss)+this.reg32s[reg_esp]+a|0:this.get_seg(reg_ss)+(this.reg16[reg_sp]+a&65535)|0};CPU.prototype.get_real_eip=function(){return this.instruction_pointer-this.get_seg(reg_cs)|0};
CPU.prototype.call_interrupt_vector=function(a,b,c){CPU_LOG_VERBOSE&&this.debug.dump_state("int "+h(a)+" start ("+(b?"soft":"hard")+"ware)");CPU_LOG_VERBOSE&&this.debug.dump_regs();this.debug.debug_interrupt(a);dbg_assert(!1===c||"number"===typeof c);this.in_hlt=!1;if(this.protected_mode){if(this.vm86_mode()&&this.cr[4]&CR4_VME)throw this.debug.unimpl("VME");this.vm86_mode()&&b&&3>this.getiopl()&&(dbg_log("call_interrupt_vector #GP. vm86 && software int && iopl < 3",LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0));
if((a<<3|7)>this.idtr_size)throw dbg_log(a,LOG_CPU),dbg_trace(LOG_CPU),this.debug.unimpl("#GP handler");var d=this.idtr_offset+(a<<3)|0;dbg_assert(4088>(d&4095));this.paging&&(d=this.translate_address_system_read(d));var e=this.read16(d)|this.read16(d+6|0)<<16,f=this.read16(d+2|0),g=this.read8(d+5|0),k=g>>5&3,l=g&31;if(0===(g&128))throw this.debug.unimpl("#NP handler");b&&k<this.cpl&&(dbg_log("#gp software interrupt ("+h(a,2)+") and dpl < cpl",LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(a<<3|2));
if(5===l){dbg_log("interrupt to task gate: int="+h(a,2)+" sel="+h(f,4)+" dpl="+k,LOG_CPU);dbg_trace(LOG_CPU);this.do_task_switch(f,c);CPU_LOG_VERBOSE&&this.debug.dump_state("int end");return}if(6!==(l&-10))throw dbg_trace(LOG_CPU),dbg_log("invalid type: "+h(l)),dbg_log(h(d)+" "+h(e>>>0)+" "+h(f)),this.debug.unimpl("#GP handler");b=1===(l&1);l=0===(l&8);d=this.lookup_segment_selector(f);dbg_assert(e>>>0<=d.effective_limit);dbg_assert(d.is_valid);if(d.is_null)throw dbg_log("is null"),this.debug.unimpl("#GP handler");
if(!d.is_executable||d.dpl>this.cpl)throw dbg_log("not exec"),this.debug.unimpl("#GP handler");d.is_present||(dbg_log("not present"),this.trigger_np(a<<3|2));a=this.get_eflags();if(!d.dc_bit&&d.dpl<this.cpl){k=this.get_tss_stack_addr(d.dpl);this.tss_size_32?(g=this.read32s(k),k=this.read16(k+4|0)):(g=this.read16(k),k=this.read16(k+2|0));var m=this.lookup_segment_selector(k);dbg_assert(m.is_valid&&!m.is_system&&m.is_writable);if(m.is_null)throw this.debug.unimpl("#TS handler");if(m.rpl!==d.dpl)throw this.debug.unimpl("#TS handler");
if(m.dpl!==d.dpl||!m.rw_bit)throw this.debug.unimpl("#TS handler");if(!m.is_present)throw this.debug.unimpl("#TS handler");var p=this.reg32s[reg_esp],n=this.sreg[reg_ss];a&flag_vm&&dbg_assert(0===d.dpl,"switch to non-0 dpl from vm86 mode");var r=(l?2:4)*(5+(!1!==c)+4*((a&flag_vm)===flag_vm));this.translate_address_system_write(m.base+(m.size?g-r:g-r&65535));this.translate_address_system_write(m.base+g-1);this.cpl=d.dpl;this.cpl_changed();this.update_cs_size(d.size);this.flags=this.flags&~flag_vm&
~flag_rf;this.switch_seg(reg_ss,k);this.set_stack_reg(g);a&flag_vm&&(l?dbg_assert(!1):(this.push32(this.sreg[reg_gs]),this.push32(this.sreg[reg_fs]),this.push32(this.sreg[reg_ds]),this.push32(this.sreg[reg_es])));l?(this.push16(n),this.push16(p)):(this.push32(n),this.push32(p))}else if(d.dc_bit||d.dpl===this.cpl)this.flags&flag_vm&&(dbg_assert(!1,"check error code"),this.trigger_gp(f&-4)),r=(l?2:4)*(3+(!1!==c)),this.writable_or_pagefault(this.get_stack_pointer(-r),r);else throw this.debug.unimpl("#GP handler");
l?(this.push16(a),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()),!1!==c&&this.push16(c),e&=65535):(this.push32(a),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip()),!1!==c&&this.push32(c));a&flag_vm&&(this.switch_seg(reg_gs,0),this.switch_seg(reg_fs,0),this.switch_seg(reg_ds,0),this.switch_seg(reg_es,0));this.sreg[reg_cs]=f&-4|this.cpl;dbg_assert((this.sreg[reg_cs]&3)===this.cpl);this.update_cs_size(d.size);this.segment_limits[reg_cs]=d.effective_limit;this.segment_offsets[reg_cs]=
d.base;this.instruction_pointer=this.get_seg(reg_cs)+e|0;this.flags=this.flags&~flag_nt&~flag_vm&~flag_rf&~flag_trap;b?this.page_fault||this.handle_irqs():this.flags&=~flag_interrupt}else e=a<<2,c=this.read16(e),e=this.read16(e+2|0),this.push16(this.get_eflags()),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()),this.flags&=~flag_interrupt,this.switch_cs_real_mode(e),this.instruction_pointer=this.get_seg(reg_cs)+c|0;CPU_LOG_VERBOSE&&this.debug.dump_state("int end")};
CPU.prototype.iret16=function(){this.iret(!0)};CPU.prototype.iret32=function(){this.iret(!1)};
CPU.prototype.iret=function(a){CPU_LOG_VERBOSE&&this.debug.dump_state("iret"+(a?"16":"32")+" start");this.vm86_mode()&&3>this.getiopl()&&(dbg_log("#gp iret vm86 mode, iopl != 3",LOG_CPU),this.trigger_gp(0));if(a)var b=this.safe_read16(this.get_stack_pointer(0)),c=this.safe_read16(this.get_stack_pointer(2)),d=this.safe_read16(this.get_stack_pointer(4));else b=this.safe_read32s(this.get_stack_pointer(0)),c=this.safe_read16(this.get_stack_pointer(4)),d=this.safe_read32s(this.get_stack_pointer(8));if(!this.protected_mode||
this.vm86_mode()&&3===this.getiopl()){if(b&4294901760)throw this.debug.unimpl("#GP handler");this.switch_cs_real_mode(c);this.instruction_pointer=b+this.get_seg(reg_cs)|0;a?(this.update_eflags(d|this.flags&-65536),this.adjust_stack_reg(6)):(this.update_eflags(d),this.adjust_stack_reg(12));CPU_LOG_VERBOSE&&this.debug.dump_state("iret end")}else{dbg_assert(!this.vm86_mode());if(this.flags&flag_nt){if(DEBUG)throw this.debug.unimpl("nt");this.trigger_gp(0)}if(d&flag_vm){if(0===this.cpl){dbg_assert(!a);
dbg_assert(0===(b&-65536));var e=this.safe_read32s(this.get_stack_pointer(12)),f=this.safe_read16(this.get_stack_pointer(16));a=this.safe_read16(this.get_stack_pointer(20));var g=this.safe_read16(this.get_stack_pointer(24)),k=this.safe_read16(this.get_stack_pointer(28)),l=this.safe_read16(this.get_stack_pointer(32));this.update_eflags(d);this.flags|=flag_vm;this.switch_cs_real_mode(c);this.instruction_pointer=(b&65535)+this.get_seg(reg_cs)|0;this.switch_seg(reg_es,a);this.switch_seg(reg_ds,g);this.switch_seg(reg_fs,
k);this.switch_seg(reg_gs,l);this.adjust_stack_reg(36);this.reg32s[reg_esp]=e;this.switch_seg(reg_ss,f);this.cpl=3;this.cpl_changed();this.update_cs_size(!1);CPU_LOG_VERBOSE&&this.debug.dump_state("iret end");return}dbg_log("vm86 flag ignored because cpl != 0",LOG_CPU);d&=~flag_vm}g=this.lookup_segment_selector(c);dbg_assert(g.is_valid);dbg_assert(b>>>0<=g.effective_limit);if(g.is_null)throw this.debug.unimpl("is null");if(!g.is_present)throw this.debug.unimpl("not present");if(!g.is_executable)throw this.debug.unimpl("not exec");
if(g.rpl<this.cpl)throw this.debug.unimpl("rpl < cpl");if(g.dc_bit&&g.dpl>g.rpl)throw this.debug.unimpl("conforming and dpl > rpl");g.dc_bit||g.rpl===g.dpl||(dbg_log("#gp iret: non-conforming cs and rpl != dpl, dpl="+g.dpl+" rpl="+g.rpl,LOG_CPU),this.trigger_gp(c&-4));g.rpl>this.cpl?(a?(e=this.safe_read16(this.get_stack_pointer(6)),f=this.safe_read16(this.get_stack_pointer(8))):(e=this.safe_read32s(this.get_stack_pointer(12)),f=this.safe_read16(this.get_stack_pointer(16))),k=this.lookup_segment_selector(f),
l=g.rpl,k.is_null&&(dbg_log("#GP for loading 0 in SS sel="+h(f,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0)),k.is_valid&&!k.is_system&&k.rpl===l&&k.is_writable&&k.dpl===l||(dbg_log("#GP for loading invalid in SS sel="+h(f,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(f&-4)),k.is_present||(dbg_log("#SS for loading non-present in SS sel="+h(f,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_ss(f&-4)),a?this.update_eflags(d|this.flags&-65536):this.update_eflags(d),this.cpl=g.rpl,this.cpl_changed(),
this.switch_seg(reg_ss,f),this.set_stack_reg(e),0===this.cpl&&(this.flags=this.flags&~flag_vif&~flag_vip|d&(flag_vif|flag_vip))):g.rpl===this.cpl?(a?(this.adjust_stack_reg(6),this.update_eflags(d|this.flags&-65536)):(this.adjust_stack_reg(12),this.update_eflags(d)),0===this.cpl&&(this.flags=this.flags&~flag_vif&~flag_vip|d&(flag_vif|flag_vip))):dbg_assert(!1);this.sreg[reg_cs]=c;dbg_assert((c&3)===this.cpl);this.update_cs_size(g.size);this.segment_limits[reg_cs]=g.effective_limit;this.segment_offsets[reg_cs]=
g.base;this.instruction_pointer=b+this.get_seg(reg_cs)|0;CPU_LOG_VERBOSE&&this.debug.dump_state("iret"+(a?"16":"32")+" end")}this.handle_irqs()};CPU.prototype.switch_cs_real_mode=function(a){dbg_assert(!this.protected_mode||this.vm86_mode());this.sreg[reg_cs]=a;this.segment_is_null[reg_cs]=0;this.segment_offsets[reg_cs]=a<<4};
CPU.prototype.far_return=function(a,b,c){dbg_assert("number"===typeof b&&65536>b&&0<=b);CPU_LOG_VERBOSE&&this.debug.dump_state("far ret start");this.protected_mode||dbg_assert(!this.is_32);if(!this.protected_mode||this.vm86_mode())this.switch_cs_real_mode(b),this.instruction_pointer=this.get_seg(reg_cs)+a|0,this.adjust_stack_reg(2*(this.is_osize_32()?4:2)+c);else{var d=this.lookup_segment_selector(b);d.is_null&&(dbg_log("null cs",LOG_CPU),this.trigger_gp(0));d.is_valid||(dbg_log("invalid cs: "+h(b),
LOG_CPU),this.trigger_gp(b&-4));d.is_system&&(dbg_assert(!1,"is system in far return"),this.trigger_gp(b&-4));d.is_executable||(dbg_log("non-executable cs: "+h(b),LOG_CPU),this.trigger_gp(b&-4));d.rpl<this.cpl&&(dbg_log("cs rpl < cpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4));d.dc_bit&&d.dpl>d.rpl&&(dbg_log("cs conforming and dpl > rpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4));d.dc_bit||d.dpl===d.rpl||(dbg_log("cs non-conforming and dpl != rpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4));d.is_present||(dbg_log("#NP for loading not-present in cs sel="+
h(b,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_np(b&-4));if(d.rpl>this.cpl){dbg_log("far return privilege change cs: "+h(b)+" from="+this.cpl+" to="+d.rpl+" is_16="+this.is_osize_32(),LOG_CPU);if(this.is_osize_32())var e=this.safe_read32s(this.get_stack_pointer(c+8)),f=this.safe_read16(this.get_stack_pointer(c+12));else e=this.safe_read16(this.get_stack_pointer(c+4)),f=this.safe_read16(this.get_stack_pointer(c+6));this.cpl=d.rpl;this.cpl_changed();this.switch_seg(reg_ss,f);this.set_stack_reg(e+c)}else this.is_osize_32()?
this.adjust_stack_reg(8+c):this.adjust_stack_reg(4+c);this.update_cs_size(d.size);this.segment_is_null[reg_cs]=0;this.segment_limits[reg_cs]=d.effective_limit;this.segment_offsets[reg_cs]=d.base;this.sreg[reg_cs]=b;dbg_assert((b&3)===this.cpl);this.instruction_pointer=this.get_seg(reg_cs)+a|0;CPU_LOG_VERBOSE&&this.debug.dump_state("far ret end")}};
CPU.prototype.far_jump=function(a,b,c){dbg_assert("number"===typeof b&&65536>b&&0<=b);CPU_LOG_VERBOSE&&this.debug.dump_state("far "+["jump","call"][+c]);if(!this.protected_mode||this.vm86_mode())c&&(this.is_osize_32()?(this.writable_or_pagefault(this.get_stack_pointer(-8),8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip()))),this.switch_cs_real_mode(b),this.instruction_pointer=
this.get_seg(reg_cs)+a|0;else{var d=this.lookup_segment_selector(b);d.is_null&&(dbg_log("#gp null cs",LOG_CPU),this.trigger_gp(0));d.is_valid||(dbg_log("#gp invalid cs: "+h(b),LOG_CPU),this.trigger_gp(b&-4));if(d.is_system)if(dbg_assert(c,"TODO: Jump"),dbg_log("system type cs: "+h(b),LOG_CPU),12===d.type||4===d.type){a=4===d.type;if(d.dpl<this.cpl||d.dpl<d.rpl)dbg_log("#gp cs gate dpl < cpl or dpl < rpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4);d.is_present||(dbg_log("#NP for loading not-present in gate cs sel="+
h(b,4),LOG_CPU),this.trigger_np(b&-4));b=d.raw0>>>16;var e=this.lookup_segment_selector(b);e.is_null&&(dbg_log("#gp null cs",LOG_CPU),this.trigger_gp(0));e.is_valid||(dbg_log("#gp invalid cs: "+h(b),LOG_CPU),this.trigger_gp(b&-4));e.is_executable||(dbg_log("#gp non-executable cs: "+h(b),LOG_CPU),this.trigger_gp(b&-4));e.dpl>this.cpl&&(dbg_log("#gp dpl > cpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4));e.is_present||(dbg_log("#NP for loading not-present in cs sel="+h(b,4),LOG_CPU),this.trigger_np(b&-4));
if(!e.dc_bit&&e.dpl<this.cpl){dbg_log("more privilege call gate is_16="+a+" from="+this.cpl+" to="+e.dpl);var f=this.get_tss_stack_addr(e.dpl);if(this.tss_size_32){var g=this.read32s(f);f=this.read16(f+4|0)}else g=this.read16(f),f=this.read16(f+2|0);var k=this.lookup_segment_selector(f);dbg_assert(k.is_valid&&!k.is_system&&k.is_writable);if(k.is_null)throw this.debug.unimpl("#TS handler");if(k.rpl!==e.dpl)throw this.debug.unimpl("#TS handler");if(k.dpl!==e.dpl||!k.rw_bit)throw this.debug.unimpl("#TS handler");
if(!k.is_present)throw this.debug.unimpl("#SS handler");var l=d.raw1&31,m=a?4:8;c&&(m+=a?4+2*l:8+4*l);k.size?this.writable_or_pagefault(k.base+g-m|0,m):this.writable_or_pagefault(k.base+(g-m&65535)|0,m);m=this.reg32s[reg_esp];var p=this.sreg[reg_ss];k=this.get_stack_pointer(0);this.cpl=e.dpl;this.cpl_changed();this.update_cs_size(e.size);this.switch_seg(reg_ss,f);this.set_stack_reg(g);a?(this.push16(p),this.push16(m)):(this.push32(p),this.push32(m));if(c)if(a){for(g=l-1;0<=g;g--)f=this.safe_read16(k+
2*g),this.push16(f);this.push16(this.sreg[reg_cs]);this.push16(this.get_real_eip())}else{for(g=l-1;0<=g;g--)f=this.safe_read32s(k+4*g),this.push32(f);this.push32(this.sreg[reg_cs]);this.push32(this.get_real_eip())}}else dbg_log("same privilege call gate is_16="+a+" from="+this.cpl+" to="+e.dpl+" conforming="+e.dc_bit),c&&(a?(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-8),
8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())));g=d.raw0&65535;a||(g|=d.raw1&4294901760);dbg_log("call gate eip="+h(g>>>0)+" cs="+h(b)+" conforming="+e.dc_bit);dbg_assert(g>>>0<=e.effective_limit,"todo: #gp");this.update_cs_size(e.size);this.segment_is_null[reg_cs]=0;this.segment_limits[reg_cs]=e.effective_limit;this.segment_offsets[reg_cs]=e.base;this.sreg[reg_cs]=b&-4|this.cpl;dbg_assert((this.sreg[reg_cs]&3)===this.cpl);this.instruction_pointer=this.get_seg(reg_cs)+g|0}else throw this.debug.unimpl("load system segment descriptor, type = "+
(d.access&15)+" ("+{9:"Available 386 TSS",11:"Busy 386 TSS",4:"286 Call Gate",12:"386 Call Gate"}[d.access&15]+")");else{d.is_executable||(dbg_log("#gp non-executable cs: "+h(b),LOG_CPU),this.trigger_gp(b&-4));if(d.dc_bit)d.dpl>this.cpl&&(dbg_log("#gp cs dpl > cpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4));else if(d.rpl>this.cpl||d.dpl!==this.cpl)dbg_log("#gp cs rpl > cpl or dpl != cpl: "+h(b),LOG_CPU),this.trigger_gp(b&-4);d.is_present||(dbg_log("#NP for loading not-present in cs sel="+h(b,4),LOG_CPU),
dbg_trace(LOG_CPU),this.trigger_np(b&-4));c&&(this.is_osize_32()?(this.writable_or_pagefault(this.get_stack_pointer(-8),8),this.push32(this.sreg[reg_cs]),this.push32(this.get_real_eip())):(this.writable_or_pagefault(this.get_stack_pointer(-4),4),this.push16(this.sreg[reg_cs]),this.push16(this.get_real_eip())));dbg_assert(a>>>0<=d.effective_limit,"todo: #gp");this.update_cs_size(d.size);this.segment_is_null[reg_cs]=0;this.segment_limits[reg_cs]=d.effective_limit;this.segment_offsets[reg_cs]=d.base;
this.sreg[reg_cs]=b&-4|this.cpl;this.instruction_pointer=this.get_seg(reg_cs)+a|0}CPU_LOG_VERBOSE&&this.debug.dump_state("far "+["jump","call"][+c]+" end")}};
CPU.prototype.get_tss_stack_addr=function(a){if(this.tss_size_32){a=(a<<3)+4|0;if((a+5|0)>this.segment_limits[reg_tr])throw this.debug.unimpl("#TS handler");a=a+this.segment_offsets[reg_tr]|0;dbg_assert(4090>=(a&4095))}else{a=(a<<2)+2|0;if((a+5|0)>this.segment_limits[reg_tr])throw this.debug.unimpl("#TS handler");a=a+this.segment_offsets[reg_tr]|0;dbg_assert(4092>=(a&4095))}this.paging&&(a=this.translate_address_system_read(a));return a};
CPU.prototype.do_task_switch=function(a,b){dbg_assert(this.tss_size_32,"TODO");dbg_log("do_task_switch sel="+h(a),LOG_CPU);var c=this.lookup_segment_selector(a);dbg_assert(3===(c.type|2)||11===(c.type|2));var d=3>=c.type,e=2===(c.type&2);if(!c.is_valid||c.is_null||!c.from_gdt)throw this.debug.unimpl("#GP handler");if(11===(c.access&31))throw this.debug.unimpl("#GP handler");if(!c.is_present)throw this.debug.unimpl("#NP handler");if(103>c.effective_limit)throw this.debug.unimpl("#NP handler");var f=
this.segment_offsets[reg_tr],g=this.get_eflags();e&&(g&=~flag_nt);this.writable_or_pagefault(f,102);this.safe_write32(f+TSR_EIP,this.get_real_eip());this.safe_write32(f+TSR_EFLAGS,g);this.safe_write32(f+TSR_EAX,this.reg32s[reg_eax]);this.safe_write32(f+TSR_ECX,this.reg32s[reg_ecx]);this.safe_write32(f+TSR_EDX,this.reg32s[reg_edx]);this.safe_write32(f+TSR_EBX,this.reg32s[reg_ebx]);this.safe_write32(f+TSR_ESP,this.reg32s[reg_esp]);this.safe_write32(f+TSR_EBP,this.reg32s[reg_ebp]);this.safe_write32(f+
TSR_ESI,this.reg32s[reg_esi]);this.safe_write32(f+TSR_EDI,this.reg32s[reg_edi]);this.safe_write32(f+TSR_ES,this.sreg[reg_es]);this.safe_write32(f+TSR_CS,this.sreg[reg_cs]);this.safe_write32(f+TSR_SS,this.sreg[reg_ss]);this.safe_write32(f+TSR_DS,this.sreg[reg_ds]);this.safe_write32(f+TSR_FS,this.sreg[reg_fs]);this.safe_write32(f+TSR_GS,this.sreg[reg_gs]);this.write8(c.table_offset+5|0,this.read8(c.table_offset+5|0)|2);e=c.base;dbg_assert(!d,"unimplemented");this.safe_write16(e+TSR_BACKLINK,this.sreg[reg_tr]);
g=this.safe_read32s(e+TSR_CR3);this.flags&=~flag_vm;var k=this.safe_read32s(e+TSR_EIP),l=this.safe_read16(e+TSR_CS),m=this.lookup_segment_selector(l);if(m.is_null)throw dbg_log("null cs",LOG_CPU),this.debug.unimpl("#TS handler");if(!m.is_valid)throw dbg_log("invalid cs: "+h(a),LOG_CPU),this.debug.unimpl("#TS handler");if(m.is_system)throw this.debug.unimpl("#TS handler");if(!m.is_executable)throw this.debug.unimpl("#TS handler");if(m.dc_bit&&m.dpl>m.rpl)throw dbg_log("cs conforming and dpl > rpl: "+
h(a),LOG_CPU),this.debug.unimpl("#TS handler");if(!m.dc_bit&&m.dpl!==m.rpl)throw dbg_log("cs non-conforming and dpl != rpl: "+h(a),LOG_CPU),this.debug.unimpl("#TS handler");if(!m.is_present)throw dbg_log("#NP for loading not-present in cs sel="+h(a,4),LOG_CPU),this.debug.unimpl("#TS handler");this.segment_is_null[reg_cs]=0;this.segment_limits[reg_cs]=m.effective_limit;this.segment_offsets[reg_cs]=m.base;this.sreg[reg_cs]=l;this.cpl=m.dpl;this.cpl_changed();dbg_assert((this.sreg[reg_cs]&3)===this.cpl);
dbg_assert(k>>>0<=m.effective_limit,"todo: #gp");this.update_cs_size(m.size);l=this.safe_read32s(e+TSR_EFLAGS);this.safe_write32(f+TSR_BACKLINK,a);l|=flag_nt;if(l&flag_vm)throw this.debug.unimpl("task switch to VM mode");this.update_eflags(l);this.flags|=flag_nt;f=this.safe_read16(e+TSR_LDT);this.load_ldt(f);this.reg32s[reg_eax]=this.safe_read32s(e+TSR_EAX);this.reg32s[reg_ecx]=this.safe_read32s(e+TSR_ECX);this.reg32s[reg_edx]=this.safe_read32s(e+TSR_EDX);this.reg32s[reg_ebx]=this.safe_read32s(e+
TSR_EBX);this.reg32s[reg_esp]=this.safe_read32s(e+TSR_ESP);this.reg32s[reg_ebp]=this.safe_read32s(e+TSR_EBP);this.reg32s[reg_esi]=this.safe_read32s(e+TSR_ESI);this.reg32s[reg_edi]=this.safe_read32s(e+TSR_EDI);this.switch_seg(reg_es,this.safe_read16(e+TSR_ES));this.switch_seg(reg_ss,this.safe_read16(e+TSR_SS));this.switch_seg(reg_ds,this.safe_read16(e+TSR_DS));this.switch_seg(reg_fs,this.safe_read16(e+TSR_FS));this.switch_seg(reg_gs,this.safe_read16(e+TSR_GS));this.instruction_pointer=this.get_seg(reg_cs)+
k|0;this.segment_offsets[reg_tr]=c.base;this.segment_limits[reg_tr]=c.effective_limit;this.sreg[reg_tr]=a;this.cr[3]=g;dbg_assert(0===(this.cr[3]&4095));this.clear_tlb();this.cr[0]|=CR0_TS;!1!==b&&(d?this.push16(b&65535):this.push32(b))};CPU.prototype.hlt_op=function(){this.cpl&&this.trigger_gp(0);if(0===(this.flags&flag_interrupt))throw this.debug.show("cpu halted"),this.bus.send("cpu-event-halt"),DEBUG&&this.debug.dump_regs(),"HALT";this.in_hlt=!0;throw MAGIC_CPU_EXCEPTION;};
CPU.prototype.raise_exception=function(a){this.call_interrupt_vector(a,!1,!1);throw MAGIC_CPU_EXCEPTION;};CPU.prototype.raise_exception_with_code=function(a,b){dbg_assert("number"===typeof b);this.call_interrupt_vector(a,!1,b);throw MAGIC_CPU_EXCEPTION;};CPU.prototype.trigger_de=function(){this.instruction_pointer=this.previous_ip;this.raise_exception(0)};CPU.prototype.trigger_ud=function(){this.instruction_pointer=this.previous_ip;this.raise_exception(6)};
CPU.prototype.trigger_nm=function(){this.instruction_pointer=this.previous_ip;this.raise_exception(7)};CPU.prototype.trigger_ts=function(a){this.instruction_pointer=this.previous_ip;this.raise_exception_with_code(10,a)};CPU.prototype.trigger_gp=function(a){this.instruction_pointer=this.previous_ip;this.raise_exception_with_code(13,a)};CPU.prototype.trigger_np=function(a){this.instruction_pointer=this.previous_ip;this.raise_exception_with_code(11,a)};
CPU.prototype.trigger_ss=function(a){this.instruction_pointer=this.previous_ip;this.raise_exception_with_code(12,a)};CPU.prototype.task_switch_test=function(){this.cr[0]&(CR0_EM|CR0_TS)&&this.trigger_nm()};CPU.prototype.task_switch_test_mmx=function(){this.cr[0]&(CR0_EM|CR0_TS)&&(this.cr[0]&CR0_TS?this.trigger_nm():this.trigger_ud())};CPU.prototype.todo=function(){if(DEBUG)throw dbg_trace(),"TODO";this.trigger_ud()};
CPU.prototype.undefined_instruction=function(){dbg_assert(!1,"Possible fault: undefined instruction");this.trigger_ud()};CPU.prototype.unimplemented_sse=function(){dbg_log("No SSE",LOG_CPU);dbg_assert(!1);this.trigger_ud()};CPU.prototype.get_seg_prefix_ds=function(){return this.get_seg_prefix(reg_ds)};CPU.prototype.get_seg_prefix_ss=function(){return this.get_seg_prefix(reg_ss)};CPU.prototype.get_seg_prefix_cs=function(){return this.get_seg_prefix(reg_cs)};
CPU.prototype.get_seg_prefix=function(a){var b=this.prefixes&PREFIX_MASK_SEGMENT;return b?b===SEG_PREFIX_ZERO?0:this.get_seg(b-1):this.get_seg(a)};CPU.prototype.get_seg=function(a){dbg_assert(0<=a&&8>a);this.protected_mode&&this.segment_is_null[a]&&(dbg_assert(a!==reg_cs&&a!==reg_ss),dbg_trace(),dbg_log("#gp Use null segment: "+a+" sel="+h(this.sreg[a],4),LOG_CPU),this.trigger_gp(0));return this.segment_offsets[a]};
CPU.prototype.read_e8=function(){return 192>this.modrm_byte?this.safe_read8(this.modrm_resolve(this.modrm_byte)):this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]};CPU.prototype.read_e8s=function(){return this.read_e8()<<24>>24};CPU.prototype.read_e16=function(){return 192>this.modrm_byte?this.safe_read16(this.modrm_resolve(this.modrm_byte)):this.reg16[this.modrm_byte<<1&14]};CPU.prototype.read_e16s=function(){return this.read_e16()<<16>>16};
CPU.prototype.read_e32s=function(){return 192>this.modrm_byte?this.safe_read32s(this.modrm_resolve(this.modrm_byte)):this.reg32s[this.modrm_byte&7]};CPU.prototype.read_e32=function(){return this.read_e32s()>>>0};CPU.prototype.read_mmx_mem32s=function(){return 192>this.modrm_byte?this.safe_read32s(this.modrm_resolve(this.modrm_byte)):this.reg_mmxs[2*(this.modrm_byte&7)]};
CPU.prototype.read_mmx_mem64s=function(){return 192>this.modrm_byte?this.safe_read64s(this.modrm_resolve(this.modrm_byte)):this.create_atom64s(this.reg_mmxs[2*(this.modrm_byte&7)],this.reg_mmxs[2*(this.modrm_byte&7)+1])};CPU.prototype.read_xmm_mem64s=function(){if(192>this.modrm_byte)return this.safe_read64s(this.modrm_resolve(this.modrm_byte));var a=(this.modrm_byte&7)<<2;return this.create_atom64s(this.reg_xmm32s[a],this.reg_xmm32s[a|1])};
CPU.prototype.read_xmm_mem128s=function(){if(192>this.modrm_byte)return this.safe_read128s_aligned(this.modrm_resolve(this.modrm_byte));var a=(this.modrm_byte&7)<<2;return this.create_atom128s(this.reg_xmm32s[a],this.reg_xmm32s[a|1],this.reg_xmm32s[a|2],this.reg_xmm32s[a|3])};
CPU.prototype.read_xmm_mem128s_unaligned=function(){if(192>this.modrm_byte)return this.safe_read128s_unaligned(this.modrm_resolve(this.modrm_byte));var a=(this.modrm_byte&7)<<2;return this.create_atom128s(this.reg_xmm32s[a],this.reg_xmm32s[a|1],this.reg_xmm32s[a|2],this.reg_xmm32s[a|3])};CPU.prototype.set_e8=function(a){if(192>this.modrm_byte){var b=this.modrm_resolve(this.modrm_byte);this.safe_write8(b,a)}else this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]=a};
CPU.prototype.set_e16=function(a){if(192>this.modrm_byte){var b=this.modrm_resolve(this.modrm_byte);this.safe_write16(b,a)}else this.reg16[this.modrm_byte<<1&14]=a};CPU.prototype.set_e32=function(a){if(192>this.modrm_byte){var b=this.modrm_resolve(this.modrm_byte);this.safe_write32(b,a)}else this.reg32s[this.modrm_byte&7]=a};
CPU.prototype.set_mmx_mem64s=function(a,b){if(192>this.modrm_byte){var c=this.modrm_resolve(this.modrm_byte);this.safe_write64(c,a,b)}else this.reg_mmxs[2*(this.modrm_byte&7)]=a,this.reg_mmxs[2*(this.modrm_byte&7)+1]=b};CPU.prototype.read_write_e8=function(){if(192>this.modrm_byte){var a=this.modrm_resolve(this.modrm_byte);this.phys_addr=this.translate_address_write(a);return this.read8(this.phys_addr)}return this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]};
CPU.prototype.write_e8=function(a){192>this.modrm_byte?this.write8(this.phys_addr,a):this.reg8[this.modrm_byte<<2&12|this.modrm_byte>>2&1]=a};
CPU.prototype.read_write_e16=function(){if(192>this.modrm_byte){var a=this.modrm_resolve(this.modrm_byte);this.phys_addr=this.translate_address_write(a);if(this.paging&&4095===(a&4095))return this.phys_addr_high=this.translate_address_write(a+1|0),dbg_assert(this.phys_addr_high),this.virt_boundary_read16(this.phys_addr,this.phys_addr_high);this.phys_addr_high=0;return this.read16(this.phys_addr)}return this.reg16[this.modrm_byte<<1&14]};
CPU.prototype.write_e16=function(a){192>this.modrm_byte?this.phys_addr_high?this.virt_boundary_write16(this.phys_addr,this.phys_addr_high,a):this.write16(this.phys_addr,a):this.reg16[this.modrm_byte<<1&14]=a};
CPU.prototype.read_write_e32=function(){if(192>this.modrm_byte){var a=this.modrm_resolve(this.modrm_byte);this.phys_addr=this.translate_address_write(a);if(this.paging&&4093<=(a&4095))return this.phys_addr_high=this.translate_address_write(a+3&-4)|a+3&3,dbg_assert(this.phys_addr_high),this.virt_boundary_read32s(this.phys_addr,this.phys_addr_high);this.phys_addr_high=0;return this.read32s(this.phys_addr)}return this.reg32s[this.modrm_byte&7]};
CPU.prototype.write_e32=function(a){192>this.modrm_byte?this.phys_addr_high?this.virt_boundary_write32(this.phys_addr,this.phys_addr_high,a):this.write32(this.phys_addr,a):this.reg32s[this.modrm_byte&7]=a};CPU.prototype.read_reg_e16=function(){return this.reg16[this.modrm_byte<<1&14]};CPU.prototype.write_reg_e16=function(a){this.reg16[this.modrm_byte<<1&14]=a};CPU.prototype.read_reg_e32s=function(){return this.reg32s[this.modrm_byte&7]};
CPU.prototype.write_reg_e32=function(a){this.reg32s[this.modrm_byte&7]=a};CPU.prototype.read_g8=function(){return this.reg8[this.modrm_byte>>1&12|this.modrm_byte>>5&1]};CPU.prototype.write_g8=function(a){this.reg8[this.modrm_byte>>1&12|this.modrm_byte>>5&1]=a};CPU.prototype.read_g16=function(){return this.reg16[this.modrm_byte>>2&14]};CPU.prototype.read_g16s=function(){return this.reg16s[this.modrm_byte>>2&14]};CPU.prototype.write_g16=function(a){this.reg16[this.modrm_byte>>2&14]=a};
CPU.prototype.read_g32s=function(){return this.reg32s[this.modrm_byte>>3&7]};CPU.prototype.write_g32=function(a){this.reg32[this.modrm_byte>>3&7]=a};CPU.prototype.read_xmm64s=function(){return this.create_atom64s(this.reg_xmm32s[(this.modrm_byte>>3&7)<<2],this.reg_xmm32s[(this.modrm_byte>>3&7)<<2|1])};CPU.prototype.read_xmm128s=function(){var a=(this.modrm_byte>>3&7)<<2;return this.create_atom128s(this.reg_xmm32s[a|0],this.reg_xmm32s[a|1],this.reg_xmm32s[a|2],this.reg_xmm32s[a|3])};
CPU.prototype.read_mmx64s=function(){return this.create_atom64s(this.reg_mmxs[2*(this.modrm_byte>>3&7)],this.reg_mmxs[2*(this.modrm_byte>>3&7)+1])};CPU.prototype.write_mmx64s=function(a,b){this.reg_mmxs[2*(this.modrm_byte>>3&7)]=a;this.reg_mmxs[2*(this.modrm_byte>>3&7)+1]=b};CPU.prototype.write_xmm64=function(a,b){var c=(this.modrm_byte>>3&7)<<2;this.reg_xmm32s[c]=a;this.reg_xmm32s[c+1]=b};
CPU.prototype.write_xmm128s=function(a,b,c,d){var e=(this.modrm_byte>>3&7)<<2;this.reg_xmm32s[e]=a;this.reg_xmm32s[e+1]=b;this.reg_xmm32s[e+2]=c;this.reg_xmm32s[e+3]=d};CPU.prototype.pic_call_irq=function(a){try{this.previous_ip=this.instruction_pointer,this.call_interrupt_vector(a,!1,!1)}catch(b){this.exception_cleanup(b)}};
CPU.prototype.handle_irqs=function(){dbg_assert(!this.page_fault);this.diverged();this.flags&flag_interrupt&&!this.page_fault&&(this.devices.pic&&this.devices.pic.acknowledge_irq(),this.devices.apic&&this.devices.apic.acknowledge_irq())};CPU.prototype.device_raise_irq=function(a){dbg_assert(1===arguments.length);this.devices.pic&&this.devices.pic.set_irq(a);this.devices.ioapic&&this.devices.ioapic.set_irq(a)};
CPU.prototype.device_lower_irq=function(a){this.devices.pic&&this.devices.pic.clear_irq(a);this.devices.ioapic&&this.devices.ioapic.clear_irq(a)};
CPU.prototype.test_privileges_for_io=function(a,b){if(this.protected_mode&&(this.cpl>this.getiopl()||this.flags&flag_vm)){this.tss_size_32||(dbg_log("#GP for port io, 16-bit TSS  port="+h(a)+" size="+b,LOG_CPU),CPU_LOG_VERBOSE&&this.debug.dump_state(),this.trigger_gp(0));var c=this.segment_limits[reg_tr],d=this.segment_offsets[reg_tr];if(103<=c){dbg_assert(4095>(d+100+2&4095));var e=this.read16(this.translate_address_system_read(d+100+2|0));if(c>=(e+((a+b-1|0)>>3)|0)&&(c=(1<<b)-1<<(a&7),d=this.translate_address_system_read(d+
e+(a>>3)|0),e=c&65280?this.read16(d):this.read8(d),dbg_assert(4095>(d&4095)),!(e&c)))return}dbg_log("#GP for port io  port="+h(a)+" size="+b,LOG_CPU);CPU_LOG_VERBOSE&&this.debug.dump_state();this.trigger_gp(0)}};
CPU.prototype.cpuid=function(){var a=0,b=0,c=0,d=0;switch(this.reg32s[reg_eax]){case 0:a=5;d=1970169159;c=1231384169;b=1818588270;break;case 1:a=3939;d=67584;b=1082130432;VMWARE_HYPERVISOR_PORT&&(b|=-2147483648);c=(this.fpu?1:0)|43320;ENABLE_ACPI&&this.apic_enabled&&(c|=512);break;case 2:a=1717260289;b=d=0;c=8024064;break;case 4:switch(this.reg32s[reg_ecx]){case 0:a=289;d=29360191;b=63;c=1;break;case 1:a=290;d=29360191;b=63;c=1;break;case 2:a=323,d=96469055,b=4095,c=1}break;case 5:d=a=64;b=3;c=1319200;
break;case -2147483648:a=5;break;case 1073741824:VMWARE_HYPERVISOR_PORT&&(d=1635208534,b=1297507698,c=1701994871);break;default:dbg_log("cpuid: unimplemented eax: "+h(this.reg32[reg_eax]),LOG_CPU)}dbg_log("cpuid: eax="+h(this.reg32[reg_eax],8)+" cl="+h(this.reg8[reg_cl],2),LOG_CPU);this.reg32s[reg_eax]=a;this.reg32s[reg_ecx]=b;this.reg32s[reg_edx]=c;this.reg32s[reg_ebx]=d};
CPU.prototype.update_cs_size=function(a){dbg_assert("boolean"===typeof a);this.is_32!==a&&(this.clear_instruction_cache(),this.is_32=a,this.update_operand_size())};CPU.prototype.update_operand_size=function(){this.table=this.is_32?this.table32:this.table16};
CPU.prototype.lookup_segment_selector=function(a){dbg_assert("number"===typeof a&&0<=a&&65536>a);var b=0===(a&4),c=a&-8;var d={rpl:a&3,from_gdt:b,is_null:!1,is_valid:!0,base:0,access:0,flags:0,type:0,dpl:0,is_system:!1,is_present:!1,is_executable:!1,rw_bit:!1,dc_bit:!1,size:!1,is_conforming_executable:!1,effective_limit:0,is_writable:!1,is_readable:!1,table_offset:0,raw0:0,raw1:0};if(b){var e=this.gdtr_offset;var f=this.gdtr_size}else e=this.segment_offsets[reg_ldtr],f=this.segment_limits[reg_ldtr];
if(b&&0===c)return d.is_null=!0,d;if((a|7)>f)return dbg_log("Selector "+h(a,4)+" is outside of the "+(b?"g":"l")+"dt limits",LOG_CPU),d.is_valid=!1,d;e=e+c|0;this.paging&&(e=this.translate_address_system_read(e));d.table_offset=e;d.base=this.read16(e+2|0)|this.read8(e+4|0)<<16|this.read8(e+7|0)<<24;d.access=this.read8(e+5|0);d.flags=this.read8(e+6|0)>>4;d.raw0=this.read32s(e|0);d.raw1=this.read32s(e+4|0);d.type=d.access&15;d.dpl=d.access>>5&3;d.is_system=0===(d.access&16);d.is_present=128===(d.access&
128);d.is_executable=8===(d.access&8);d.rw_bit=2===(d.access&2);d.dc_bit=4===(d.access&4);d.is_conforming_executable=d.dc_bit&&d.is_executable;d.size=4===(d.flags&4);a=this.read16(e)|(this.read8(e+6|0)&15)<<16;d.effective_limit=d.flags&8?(a<<12|4095)>>>0:a;d.is_writable=d.rw_bit&&!d.is_executable;d.is_readable=d.rw_bit||!d.is_executable;return d};
CPU.prototype.switch_seg=function(a,b){dbg_assert(0<=a&&5>=a);dbg_assert("number"===typeof b&&65536>b&&0<=b);if(!this.protected_mode||this.vm86_mode())this.sreg[a]=b,this.segment_is_null[a]=0,this.segment_offsets[a]=b<<4,a===reg_ss&&(this.stack_size_32=!1);else{var c=this.lookup_segment_selector(b);if(a===reg_ss)c.is_null&&(dbg_log("#GP for loading 0 in SS sel="+h(b,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(0)),c.is_valid&&!c.is_system&&c.rpl===this.cpl&&c.is_writable&&c.dpl===this.cpl||(dbg_log("#GP for loading invalid in SS sel="+
h(b,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_gp(b&-4)),c.is_present||(dbg_log("#SS for loading non-present in SS sel="+h(b,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_ss(b&-4)),this.stack_size_32=c.size;else if(a===reg_cs)dbg_assert(!1);else{if(c.is_null){this.sreg[a]=b;this.segment_is_null[a]=1;return}if(!c.is_valid||c.is_system||!c.is_readable||!c.is_conforming_executable&&(c.rpl>c.dpl||this.cpl>c.dpl))dbg_log("#GP for loading invalid in seg "+a+" sel="+h(b,4),LOG_CPU),this.debug.dump_state(),
this.debug.dump_regs(),dbg_trace(LOG_CPU),this.trigger_gp(b&-4);c.is_present||(dbg_log("#NP for loading not-present in seg "+a+" sel="+h(b,4),LOG_CPU),dbg_trace(LOG_CPU),this.trigger_np(b&-4))}this.segment_is_null[a]=0;this.segment_limits[a]=c.effective_limit;this.segment_offsets[a]=c.base;this.sreg[a]=b}};
CPU.prototype.load_tr=function(a){var b=this.lookup_segment_selector(a);dbg_assert(b.is_valid);if(!b.from_gdt)throw this.debug.unimpl("TR can only be loaded from GDT");if(b.is_null)throw dbg_log("#GP(0) | tried to load null selector (ltr)"),this.debug.unimpl("#GP handler");if(!b.is_system)throw dbg_log("#GP | ltr: not a system entry"),this.debug.unimpl("#GP handler (happens when running kvm-unit-test without ACPI)");if(9!==b.type&&1!==b.type)throw dbg_log("#GP | ltr: invalid type (type = "+h(b.type)+
")"),this.debug.unimpl("#GP handler");if(!b.is_present)throw dbg_log("#NT | present bit not set (ltr)"),this.debug.unimpl("#NT handler");this.tss_size_32=9===b.type;this.segment_offsets[reg_tr]=b.base;this.segment_limits[reg_tr]=b.effective_limit;this.sreg[reg_tr]=a;this.write8(b.table_offset+5|0,this.read8(b.table_offset+5|0)|2)};
CPU.prototype.load_ldt=function(a){var b=this.lookup_segment_selector(a);if(b.is_null)this.segment_offsets[reg_ldtr]=0,this.segment_limits[reg_ldtr]=0;else{dbg_assert(b.is_valid);if(!b.from_gdt)throw this.debug.unimpl("LDTR can only be loaded from GDT");if(!b.is_present)throw dbg_log("lldt: present bit not set"),this.debug.unimpl("#GP handler");if(!b.is_system)throw dbg_log("lldt: not a system entry"),this.debug.unimpl("#GP handler");if(2!==b.type)throw dbg_log("lldt: invalid type ("+b.type+")"),
this.debug.unimpl("#GP handler");this.segment_offsets[reg_ldtr]=b.base;this.segment_limits[reg_ldtr]=b.effective_limit;this.sreg[reg_ldtr]=a}};CPU.prototype.arpl=function(a,b){this.flags_changed&=~flag_zero;if((a&3)<(this.reg16[b]&3))return this.flags|=flag_zero,a&-4|this.reg16[b]&3;this.flags&=~flag_zero;return a};
CPU.prototype.lar=function(a,b){dbg_log("lar sel="+h(a,4),LOG_CPU);var c=this.lookup_segment_selector(a);this.flags_changed&=~flag_zero;var d=c.dpl<this.cpl||c.dpl<c.rpl;if(c.is_null||!c.is_valid||(c.is_system?58817>>c.type&1||d:!c.is_conforming_executable&&d))return this.flags&=~flag_zero,dbg_log("lar: invalid selector="+h(a,4)+" is_null="+c.is_null,LOG_CPU),b;this.flags|=flag_zero;return c.raw1&16776960};
CPU.prototype.lsl=function(a,b){dbg_log("lsl sel="+h(a,4),LOG_CPU);var c=this.lookup_segment_selector(a);this.flags_changed&=~flag_zero;var d=c.dpl<this.cpl||c.dpl<c.rpl;if(c.is_null||!c.is_valid||(c.is_system?62833>>c.type&1||d:!c.is_conforming_executable&&d))return this.flags&=~flag_zero,dbg_log("lsl: invalid  selector="+h(a,4)+" is_null="+c.is_null,LOG_CPU),b;this.flags|=flag_zero;return c.effective_limit|0};
CPU.prototype.verr=function(a){var b=this.lookup_segment_selector(a);this.flags_changed&=~flag_zero;b.is_null||!b.is_valid||b.is_system||!b.is_readable||!b.is_conforming_executable&&(b.dpl<this.cpl||b.dpl<b.rpl)?(dbg_log("verr -> invalid. selector="+h(a,4),LOG_CPU),this.flags&=~flag_zero):(dbg_log("verr -> valid. selector="+h(a,4),LOG_CPU),this.flags|=flag_zero)};
CPU.prototype.verw=function(a){var b=this.lookup_segment_selector(a);this.flags_changed&=~flag_zero;b.is_null||!b.is_valid||b.is_system||!b.is_writable||b.dpl<this.cpl||b.dpl<b.rpl?(dbg_log("verw invalid  "+h(a)+" "+b.is_null+" "+!b.is_valid+" "+b.is_system+" "+!b.is_writable+" "+(b.dpl<this.cpl)+" "+(b.dpl<b.rpl)+" "+LOG_CPU),this.flags&=~flag_zero):(dbg_log("verw valid",LOG_CPU),this.flags|=flag_zero)};CPU.prototype.clear_tlb=function(){this.last_virt_esp=this.last_virt_eip=-1;this.tlb_info.set(this.tlb_info_global)};
CPU.prototype.full_clear_tlb=function(){for(var a=new Int32Array(this.tlb_info_global.buffer),b=0;262144>b;)a[b++]=a[b++]=a[b++]=a[b++]=0;this.clear_tlb()};CPU.prototype.invlpg=function(a){a>>>=12;this.tlb_info[a]=0;this.tlb_info_global[a]=0;this.last_virt_esp=this.last_virt_eip=-1};CPU.prototype.translate_address_read=function(a){return this.paging?3===this.cpl?this.translate_address_user_read(a):this.translate_address_system_read(a):a};
CPU.prototype.translate_address_write=function(a){return this.paging?3===this.cpl?this.translate_address_user_write(a):this.translate_address_system_write(a):a};CPU.prototype.translate_address_user_write=function(a){if(!this.paging)return a;var b=a>>>12;return this.tlb_info[b]&TLB_USER_WRITE?this.tlb_data[b]^a:this.do_page_translation(a,1,1)|a&4095};
CPU.prototype.translate_address_user_read=function(a){if(!this.paging)return a;var b=a>>>12;return this.tlb_info[b]&TLB_USER_READ?this.tlb_data[b]^a:this.do_page_translation(a,0,1)|a&4095};CPU.prototype.translate_address_system_write=function(a){if(!this.paging)return a;var b=a>>>12;return this.tlb_info[b]&TLB_SYSTEM_WRITE?this.tlb_data[b]^a:this.do_page_translation(a,1,0)|a&4095};
CPU.prototype.translate_address_system_read=function(a){if(!this.paging)return a;var b=a>>>12;return this.tlb_info[b]&TLB_SYSTEM_READ?this.tlb_data[b]^a:this.do_page_translation(a,0,0)|a&4095};
CPU.prototype.do_page_translation=function(a,b,c){var d=a>>>12,e=(this.cr[3]>>>2)+(d>>10)|0,f=this.mem32s[e],g=!0,k=!0;dbg_assert(2147483648>a);f&1||(this.cr[2]=a,this.trigger_pagefault(b,c,0),dbg_assert(!1));0===(f&2)&&(g=!1,b&&(c||this.cr[0]&CR0_WP)&&(this.cr[2]=a,this.trigger_pagefault(b,c,1),dbg_assert(!1)));0===(f&4)&&(k=!1,c&&(this.cr[2]=a,this.trigger_pagefault(b,c,1),dbg_assert(!1)));if(f&this.page_size_extensions)this.mem32s[e]=f|32|b<<6,a=f&4290772992|a&4190208,f&=256;else{var l=((f&4294963200)>>>
2)+(d&1023)|0,m=this.mem32s[l];0===(m&1)&&(this.cr[2]=a,this.trigger_pagefault(b,c,0),dbg_assert(!1));0===(m&2)&&(g=!1,b&&(c||this.cr[0]&CR0_WP)&&(this.cr[2]=a,this.trigger_pagefault(b,c,1),dbg_assert(!1)));0===(m&4)&&(k=!1,c&&(this.cr[2]=a,this.trigger_pagefault(b,c,1),dbg_assert(!1)));this.write_aligned32(e,f|32);this.write_aligned32(l,m|32|b<<6);a=m&4294963200;f=m&256}this.tlb_data[d]=a^d<<12;g=k?g?TLB_SYSTEM_READ|TLB_SYSTEM_WRITE|TLB_USER_READ|TLB_USER_WRITE:TLB_SYSTEM_READ|TLB_USER_READ:g?TLB_SYSTEM_READ|
TLB_SYSTEM_WRITE:TLB_SYSTEM_READ;this.tlb_info[d]=g;f&&this.cr[4]&CR4_PGE&&(this.tlb_info_global[d]=g);return a};CPU.prototype.writable_or_pagefault=function(a,b){dbg_assert(4096>b,"not supported yet");dbg_assert(0<b);if(this.paging){var c=3===this.cpl?1:0,d=c?TLB_USER_WRITE:TLB_SYSTEM_WRITE,e=a>>>12;0===(this.tlb_info[e]&d)&&this.do_page_translation(a,1,c);4096<=(a&4095)+b-1&&0===(this.tlb_info[e+1|0]&d)&&this.do_page_translation(a+b-1|0,1,c)}};
CPU.prototype.trigger_pagefault=function(a,b,c){LOG_PAGE_FAULTS&&(dbg_log("page fault w="+a+" u="+b+" p="+c+" eip="+h(this.previous_ip>>>0,8)+" cr2="+h(this.cr[2]>>>0,8),LOG_CPU),dbg_trace(LOG_CPU));if(this.page_fault)throw dbg_trace(LOG_CPU),this.debug.unimpl("Double fault");var d=this.cr[2]>>>12;this.tlb_info[d]=0;this.tlb_info_global[d]=0;this.instruction_pointer=this.previous_ip;this.page_fault=!0;this.call_interrupt_vector(14,!1,b<<2|a<<1|c);throw MAGIC_CPU_EXCEPTION;};
CPU.prototype.is_osize_32=function(){return this.is_32!==((this.prefixes&PREFIX_MASK_OPSIZE)===PREFIX_MASK_OPSIZE)};CPU.prototype.is_asize_32=function(){return this.is_32!==((this.prefixes&PREFIX_MASK_ADDRSIZE)===PREFIX_MASK_ADDRSIZE)};CPU.prototype.get_reg_asize=function(a){dbg_assert(a===reg_ecx||a===reg_esi||a===reg_edi);a=this.reg32s[a];return this.is_asize_32()?a:a&65535};CPU.prototype.set_ecx_asize=function(a){this.is_asize_32()?this.reg32s[reg_ecx]=a:this.reg16[reg_cx]=a};
CPU.prototype.add_reg_asize=function(a,b){dbg_assert(a===reg_ecx||a===reg_esi||a===reg_edi);this.is_asize_32()?this.reg32s[a]+=b:this.reg16[a<<1]+=b};CPU.prototype.decr_ecx_asize=function(){return this.is_asize_32()?--this.reg32s[reg_ecx]:--this.reg16[reg_cx]};"undefined"!==typeof window?window.CPU=CPU:"undefined"!==typeof module&&"undefined"!==typeof module.exports?module.exports.CPU=CPU:"function"===typeof importScripts&&(self.CPU=CPU);function DynamicTranslator(a){dbg_assert(!1);this.clear_cache=function(){};this.cycle_translated=function(){}};(function(){CPU.prototype.modrm_table16=Array(192);CPU.prototype.modrm_table32=Array(192);CPU.prototype.sib_table=Array(256);CPU.prototype.modrm_table16[0]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_si]&65535)|0};CPU.prototype.modrm_table16[64]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_si]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[128]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_si]+a.read_disp16()&65535)|
0};CPU.prototype.modrm_table16[1]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_di]&65535)|0};CPU.prototype.modrm_table16[65]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_di]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[129]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.reg16[reg_di]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[2]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_si]&65535)|0};CPU.prototype.modrm_table16[66]=
function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_si]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[130]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_si]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[3]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_di]&65535)|0};CPU.prototype.modrm_table16[67]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_di]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[131]=
function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.reg16[reg_di]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[4]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_si]&65535)|0};CPU.prototype.modrm_table16[68]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_si]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[132]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_si]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[5]=function(a){return a.get_seg_prefix_ds()+
(a.reg16[reg_di]&65535)|0};CPU.prototype.modrm_table16[69]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_di]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[133]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_di]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[6]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]&65535)|0};CPU.prototype.modrm_table16[70]=function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[134]=
function(a){return a.get_seg_prefix_ss()+(a.reg16[reg_bp]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table16[7]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]&65535)|0};CPU.prototype.modrm_table16[71]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.read_disp8s()&65535)|0};CPU.prototype.modrm_table16[135]=function(a){return a.get_seg_prefix_ds()+(a.reg16[reg_bx]+a.read_disp16()&65535)|0};CPU.prototype.modrm_table32[0]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]|
0};CPU.prototype.modrm_table32[64]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]+a.read_disp8s()|0};CPU.prototype.modrm_table32[128]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]+a.read_disp32s()|0};CPU.prototype.modrm_table32[1]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.modrm_table32[65]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]+a.read_disp8s()|0};CPU.prototype.modrm_table32[129]=function(a){return a.get_seg_prefix_ds()+
a.reg32s[reg_ecx]+a.read_disp32s()|0};CPU.prototype.modrm_table32[2]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.modrm_table32[66]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]+a.read_disp8s()|0};CPU.prototype.modrm_table32[130]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]+a.read_disp32s()|0};CPU.prototype.modrm_table32[3]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.modrm_table32[67]=function(a){return a.get_seg_prefix_ds()+
a.reg32s[reg_ebx]+a.read_disp8s()|0};CPU.prototype.modrm_table32[131]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]+a.read_disp32s()|0};CPU.prototype.modrm_table32[5]=function(a){return a.get_seg_prefix_ss()+a.reg32s[reg_ebp]|0};CPU.prototype.modrm_table32[69]=function(a){return a.get_seg_prefix_ss()+a.reg32s[reg_ebp]+a.read_disp8s()|0};CPU.prototype.modrm_table32[133]=function(a){return a.get_seg_prefix_ss()+a.reg32s[reg_ebp]+a.read_disp32s()|0};CPU.prototype.modrm_table32[6]=function(a){return a.get_seg_prefix_ds()+
a.reg32s[reg_esi]|0};CPU.prototype.modrm_table32[70]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]+a.read_disp8s()|0};CPU.prototype.modrm_table32[134]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]+a.read_disp32s()|0};CPU.prototype.modrm_table32[7]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.modrm_table32[71]=function(a){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]+a.read_disp8s()|0};CPU.prototype.modrm_table32[135]=function(a){return a.get_seg_prefix_ds()+
a.reg32s[reg_edi]+a.read_disp32s()|0};CPU.prototype.modrm_table16[6]=function(a){return a.get_seg_prefix_ds()+a.read_disp16()|0};CPU.prototype.modrm_table32[5]=function(a){return a.get_seg_prefix_ds()+a.read_disp32s()|0};CPU.prototype.modrm_table32[4]=function(a){return a.sib_resolve(!1)|0};CPU.prototype.modrm_table32[68]=function(a){return a.sib_resolve(!0)+a.read_disp8s()|0};CPU.prototype.modrm_table32[132]=function(a){return a.sib_resolve(!0)+a.read_disp32s()|0};for(var a=0;8>a;a++)for(var b=0;3>
b;b++)for(var c=a|b<<6,d=1;8>d;d++)CPU.prototype.modrm_table32[c|d<<3]=CPU.prototype.modrm_table32[c],CPU.prototype.modrm_table16[c|d<<3]=CPU.prototype.modrm_table16[c];CPU.prototype.sib_table[0]=function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[1]=function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[2]=function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[3]=
function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[4]=function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[5]=function(a,b){return a.reg32s[reg_eax]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[6]=function(a,b){return a.reg32s[reg_eax]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[7]=function(a,b){return a.reg32s[reg_eax]+
a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[64]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[65]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[66]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[67]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[68]=
function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[69]=function(a,b){return(a.reg32s[reg_eax]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[70]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[71]=function(a,b){return(a.reg32s[reg_eax]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[128]=function(a,
b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[129]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[130]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[131]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[132]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ss()+
a.reg32s[reg_esp]|0};CPU.prototype.sib_table[133]=function(a,b){return(a.reg32s[reg_eax]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[134]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[135]=function(a,b){return(a.reg32s[reg_eax]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[192]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+
a.reg32s[reg_eax]|0};CPU.prototype.sib_table[193]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[194]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[195]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[196]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[197]=
function(a,b){return(a.reg32s[reg_eax]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[198]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[199]=function(a,b){return(a.reg32s[reg_eax]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[8]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[9]=function(a,
b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[10]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[11]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[12]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[13]=function(a,b){return a.reg32s[reg_ecx]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:
a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[14]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[15]=function(a,b){return a.reg32s[reg_ecx]+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[72]=function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[73]=function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[74]=
function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[75]=function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[76]=function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[77]=function(a,b){return(a.reg32s[reg_ecx]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[78]=function(a,
b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[79]=function(a,b){return(a.reg32s[reg_ecx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[136]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[137]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[138]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+
a.reg32s[reg_edx]|0};CPU.prototype.sib_table[139]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[140]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[141]=function(a,b){return(a.reg32s[reg_ecx]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[142]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+
a.reg32s[reg_esi]|0};CPU.prototype.sib_table[143]=function(a,b){return(a.reg32s[reg_ecx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[200]=function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[201]=function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[202]=function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[203]=
function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[204]=function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[205]=function(a,b){return(a.reg32s[reg_ecx]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[206]=function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[207]=
function(a,b){return(a.reg32s[reg_ecx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[16]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[17]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[18]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[19]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+
a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[20]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[21]=function(a,b){return a.reg32s[reg_edx]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[22]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[23]=function(a,b){return a.reg32s[reg_edx]+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|
0};CPU.prototype.sib_table[80]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[81]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[82]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[83]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[84]=function(a,b){return(a.reg32s[reg_edx]<<
1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[85]=function(a,b){return(a.reg32s[reg_edx]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[86]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[87]=function(a,b){return(a.reg32s[reg_edx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[144]=function(a,b){return(a.reg32s[reg_edx]<<2)+
a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[145]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[146]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[147]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[148]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};
CPU.prototype.sib_table[149]=function(a,b){return(a.reg32s[reg_edx]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[150]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[151]=function(a,b){return(a.reg32s[reg_edx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[208]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};
CPU.prototype.sib_table[209]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[210]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[211]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[212]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[213]=function(a,b){return(a.reg32s[reg_edx]<<
3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[214]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[215]=function(a,b){return(a.reg32s[reg_edx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[24]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[25]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+
a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[26]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[27]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[28]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[29]=function(a,b){return a.reg32s[reg_ebx]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|
0};CPU.prototype.sib_table[30]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[31]=function(a,b){return a.reg32s[reg_ebx]+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[88]=function(a,b){return(a.reg32s[reg_ebx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[89]=function(a,b){return(a.reg32s[reg_ebx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[90]=function(a,b){return(a.reg32s[reg_ebx]<<
1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[91]=function(a,b){return(a.reg32s[reg_ebx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[92]=function(a,b){return(a.reg32s[reg_ebx]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[93]=function(a,b){return(a.reg32s[reg_ebx]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[94]=function(a,b){return(a.reg32s[reg_ebx]<<1)+
a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[95]=function(a,b){return(a.reg32s[reg_ebx]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[152]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[153]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[154]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};
CPU.prototype.sib_table[155]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[156]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[157]=function(a,b){return(a.reg32s[reg_ebx]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[158]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};
CPU.prototype.sib_table[159]=function(a,b){return(a.reg32s[reg_ebx]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[216]=function(a,b){return(a.reg32s[reg_ebx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[217]=function(a,b){return(a.reg32s[reg_ebx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[218]=function(a,b){return(a.reg32s[reg_ebx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[219]=function(a,b){return(a.reg32s[reg_ebx]<<
3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[220]=function(a,b){return(a.reg32s[reg_ebx]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[221]=function(a,b){return(a.reg32s[reg_ebx]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[222]=function(a,b){return(a.reg32s[reg_ebx]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[223]=function(a,b){return(a.reg32s[reg_ebx]<<
3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[32]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[33]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[34]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[35]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[36]=function(a,b){return a.get_seg_prefix_ss()+a.reg32s[reg_esp]|
0};CPU.prototype.sib_table[37]=function(a,b){return(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[38]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[39]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[96]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[97]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|
0};CPU.prototype.sib_table[98]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[99]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[100]=function(a,b){return a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[101]=function(a,b){return(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[102]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]|
0};CPU.prototype.sib_table[103]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[160]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[161]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[162]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[163]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[164]=function(a,
b){return a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[165]=function(a,b){return(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[166]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[167]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[224]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[225]=function(a,
b){return a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[226]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[227]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[228]=function(a,b){return a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[229]=function(a,b){return(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[230]=function(a,
b){return a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[231]=function(a,b){return a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[40]=function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[41]=function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[42]=function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[43]=
function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[44]=function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[45]=function(a,b){return a.reg32s[reg_ebp]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[46]=function(a,b){return a.reg32s[reg_ebp]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[47]=function(a,b){return a.reg32s[reg_ebp]+
a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[104]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[105]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[106]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[107]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};
CPU.prototype.sib_table[108]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[109]=function(a,b){return(a.reg32s[reg_ebp]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[110]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[111]=function(a,b){return(a.reg32s[reg_ebp]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};
CPU.prototype.sib_table[168]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[169]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[170]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[171]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[172]=function(a,b){return(a.reg32s[reg_ebp]<<
2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[173]=function(a,b){return(a.reg32s[reg_ebp]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[174]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[175]=function(a,b){return(a.reg32s[reg_ebp]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[232]=function(a,b){return(a.reg32s[reg_ebp]<<
3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[233]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[234]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[235]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[236]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|
0};CPU.prototype.sib_table[237]=function(a,b){return(a.reg32s[reg_ebp]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[238]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[239]=function(a,b){return(a.reg32s[reg_ebp]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[48]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};
CPU.prototype.sib_table[49]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[50]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[51]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[52]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[53]=function(a,b){return a.reg32s[reg_esi]+
(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[54]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[55]=function(a,b){return a.reg32s[reg_esi]+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[112]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[113]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+
a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[114]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[115]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[116]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[117]=function(a,b){return(a.reg32s[reg_esi]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+
a.read_disp32s())|0};CPU.prototype.sib_table[118]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[119]=function(a,b){return(a.reg32s[reg_esi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[176]=function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[177]=function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[178]=
function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[179]=function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[180]=function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[181]=function(a,b){return(a.reg32s[reg_esi]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[182]=
function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[183]=function(a,b){return(a.reg32s[reg_esi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[240]=function(a,b){return(a.reg32s[reg_esi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[241]=function(a,b){return(a.reg32s[reg_esi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[242]=function(a,b){return(a.reg32s[reg_esi]<<3)+
a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[243]=function(a,b){return(a.reg32s[reg_esi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[244]=function(a,b){return(a.reg32s[reg_esi]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[245]=function(a,b){return(a.reg32s[reg_esi]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[246]=function(a,b){return(a.reg32s[reg_esi]<<3)+
a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[247]=function(a,b){return(a.reg32s[reg_esi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[56]=function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[57]=function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[58]=function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[59]=
function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[60]=function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[61]=function(a,b){return a.reg32s[reg_edi]+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[62]=function(a,b){return a.reg32s[reg_edi]+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[63]=function(a,b){return a.reg32s[reg_edi]+
a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[120]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[121]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[122]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[123]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};
CPU.prototype.sib_table[124]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[125]=function(a,b){return(a.reg32s[reg_edi]<<1)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[126]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[127]=function(a,b){return(a.reg32s[reg_edi]<<1)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};
CPU.prototype.sib_table[184]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[185]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[186]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[187]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[188]=function(a,b){return(a.reg32s[reg_edi]<<
2)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|0};CPU.prototype.sib_table[189]=function(a,b){return(a.reg32s[reg_edi]<<2)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[190]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[191]=function(a,b){return(a.reg32s[reg_edi]<<2)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0};CPU.prototype.sib_table[248]=function(a,b){return(a.reg32s[reg_edi]<<
3)+a.get_seg_prefix_ds()+a.reg32s[reg_eax]|0};CPU.prototype.sib_table[249]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ecx]|0};CPU.prototype.sib_table[250]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edx]|0};CPU.prototype.sib_table[251]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_ebx]|0};CPU.prototype.sib_table[252]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ss()+a.reg32s[reg_esp]|
0};CPU.prototype.sib_table[253]=function(a,b){return(a.reg32s[reg_edi]<<3)+(b?a.get_seg_prefix_ss()+a.reg32s[reg_ebp]:a.get_seg_prefix_ds()+a.read_disp32s())|0};CPU.prototype.sib_table[254]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_esi]|0};CPU.prototype.sib_table[255]=function(a,b){return(a.reg32s[reg_edi]<<3)+a.get_seg_prefix_ds()+a.reg32s[reg_edi]|0}})();var MAX_COUNT_PER_CYCLE=4096;function string_get_cycle_count(a,b){dbg_assert(a&&4>=a&&-4<=a);return 0>a?(b&4095)>>(-a>>1):(~b&4095)>>a}function string_get_cycle_count2(a,b,c){dbg_assert(3===arguments.length);return Math.min(string_get_cycle_count(a,b),string_get_cycle_count(a,c))}
CPU.prototype.movsb=function(){var a=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,b=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,c=this.flags&flag_direction?-1:1;if(this.prefixes&PREFIX_MASK_REP){var d=this.get_reg_asize(reg_ecx)>>>0;if(0===d)return;var e=d,f=MAX_COUNT_PER_CYCLE,g=this.translate_address_read(a),k=this.translate_address_write(b);this.paging&&(f=string_get_cycle_count2(c,a,b));do this.write8(k,this.read8(g)),k+=c,g+=c,a=0!==--d;while(a&&f--);c=c*(e-d)|0;this.add_reg_asize(reg_edi,
c);this.add_reg_asize(reg_esi,c);this.set_ecx_asize(d);this.timestamp_counter+=e-d;a&&(this.instruction_pointer=this.previous_ip)}else this.safe_write8(b,this.safe_read8(a)),this.add_reg_asize(reg_edi,c),this.add_reg_asize(reg_esi,c);this.diverged()};
CPU.prototype.movsw=function(){var a=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,b=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,c=this.flags&flag_direction?-2:2;if(this.prefixes&PREFIX_MASK_REP){var d=this.get_reg_asize(reg_ecx)>>>0;if(0===d)return;var e=d,f=MAX_COUNT_PER_CYCLE;if(b&1||a&1){do{this.safe_write16(b,this.safe_read16(a));b+=c;this.add_reg_asize(reg_edi,c);a+=c;this.add_reg_asize(reg_esi,c);var g=0!==this.decr_ecx_asize()}while(g&&f--)}else{var k=0>c?-1:1,l=this.translate_address_read(a)>>>
1,m=this.translate_address_write(b)>>>1;this.paging&&(f=string_get_cycle_count2(c,a,b));do this.write_aligned16(m,this.read_aligned16(l)),m+=k,l+=k,g=0!==--d;while(g&&f--);a=c*(e-d)|0;this.add_reg_asize(reg_edi,a);this.add_reg_asize(reg_esi,a);this.set_ecx_asize(d);this.timestamp_counter+=e-d}g&&(this.instruction_pointer=this.previous_ip)}else this.safe_write16(b,this.safe_read16(a)),this.add_reg_asize(reg_edi,c),this.add_reg_asize(reg_esi,c);this.diverged()};
CPU.prototype.movsd=function(){if(this.prefixes&PREFIX_MASK_REP){var a=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0,b=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0,c=this.get_reg_asize(reg_ecx)>>>0;if(!c)return;var d=this.paging?4095:3;if(0===(b&d)&&0===(a&d)&&0===(this.flags&flag_direction)&&(d=!1,this.paging&&(a=this.translate_address_read(a),b=this.translate_address_write(b),1024<c&&(c=1024,d=!0)),!this.io.in_mmap_range(a,c)&&!this.io.in_mmap_range(b,c))){var e=c<<2;this.add_reg_asize(reg_ecx,
-c);this.add_reg_asize(reg_edi,e);this.add_reg_asize(reg_esi,e);b>>>=2;a>>>=2;this.write_blob32(this.mem32s.subarray(a,a+c),b);d&&(this.instruction_pointer=this.previous_ip);return}}a=this.get_seg_prefix(reg_ds)+this.get_reg_asize(reg_esi)|0;b=this.get_seg(reg_es)+this.get_reg_asize(reg_edi)|0;e=this.flags&flag_direction?-4:4;if(this.prefixes&PREFIX_MASK_REP){c=this.get_reg_asize(reg_ecx)>>>0;if(0===c)return;var f=c,g=MAX_COUNT_PER_CYCLE;if(b&3||a&3){do this.safe_write32(b,this.safe_read32s(a)),b+=
e,this.add_reg_asize(reg_edi,e),a+=e,this.add_reg_asize(reg_esi,e),d=0!==this.decr_ecx_asize();while(d&&g--)}else{var k=0>e?-1:1,l=this.translate_address_read(a)>>>2,m=this.translate_address_write(b)>>>2;this.paging&&(g=string_get_cycle_count2(e,a,b));do this.write_aligned32(m,this.read_aligned32(l)),m+=k,l+=k,d=0!==--c;while(d&&g--);e=e*(f-c)|0;this.add_reg_asize(reg_edi,e);this.add_reg_asize(reg_esi,e);this.set_ecx_asize(c);this.timestamp_counter+=f-c}d&&(this.instruction_pointer=this.previous_ip)}else this.safe_write32(b,
this.safe_read32s(a)),this.add_reg_asize(reg_edi,e),this.add_reg_asize(reg_esi,e);this.diverged()};
function cmpsb(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-1:1;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE,l=a.translate_address_read(b),m=a.translate_address_read(c);a.paging&&(k=string_get_cycle_count2(d,b,c));do{c=a.read8(m);b=a.read8(l);m+=d;l+=d;var p=0!==--e&&b===c===g}while(p&&k--);d=d*(f-e)|
0;a.add_reg_asize(reg_edi,d);a.add_reg_asize(reg_esi,d);a.set_ecx_asize(e);a.timestamp_counter+=f-e;p&&(a.instruction_pointer=a.previous_ip)}else b=a.safe_read8(b),c=a.safe_read8(c),a.add_reg_asize(reg_edi,d),a.add_reg_asize(reg_esi,d);a.cmp8(b,c);a.diverged()}
function cmpsw(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-2:2;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE;if(c&1||b&1){do{var l=a.safe_read16(c);var m=a.safe_read16(b);c+=d;a.add_reg_asize(reg_edi,d);b+=d;a.add_reg_asize(reg_esi,d);var p=0!==a.decr_ecx_asize()&&m===l===g}while(p&&k--)}else{var n=
0>d?-1:1,r=a.translate_address_read(b)>>>1,q=a.translate_address_read(c)>>>1;a.paging&&(k=string_get_cycle_count2(d,b,c));do l=a.read_aligned16(q),m=a.read_aligned16(r),q+=n,r+=n,p=0!==--e&&m===l===g;while(p&&k--);b=d*(f-e)|0;a.add_reg_asize(reg_edi,b);a.add_reg_asize(reg_esi,b);a.set_ecx_asize(e);a.timestamp_counter+=f-e}p&&(a.instruction_pointer=a.previous_ip)}else l=a.safe_read16(c),m=a.safe_read16(b),a.add_reg_asize(reg_edi,d),a.add_reg_asize(reg_esi,d);a.cmp16(m,l);a.diverged()}
function cmpsd(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-4:4;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE;if(c&3||b&3){do{var l=a.safe_read32s(c);var m=a.safe_read32s(b);c+=d;a.add_reg_asize(reg_edi,d);b+=d;a.add_reg_asize(reg_esi,d);var p=0!==a.decr_ecx_asize()&&m===l===g}while(p&&k--)}else{var n=
0>d?-1:1,r=a.translate_address_read(b)>>>2,q=a.translate_address_read(c)>>>2;a.paging&&(k=string_get_cycle_count2(d,b,c));do l=a.read_aligned32(q),m=a.read_aligned32(r),q+=n,r+=n,p=0!==--e&&m===l===g;while(p&&k--);b=d*(f-e)|0;a.add_reg_asize(reg_edi,b);a.add_reg_asize(reg_esi,b);a.set_ecx_asize(e);a.timestamp_counter+=f-e}p&&(a.instruction_pointer=a.previous_ip)}else l=a.safe_read32s(c),m=a.safe_read32s(b),a.add_reg_asize(reg_edi,d),a.add_reg_asize(reg_esi,d);a.cmp32(m,l);a.diverged()}
function stosb(a){var b=a.reg8[reg_al],c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-1:1;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE,k=a.translate_address_write(c);a.paging&&(g=string_get_cycle_count(d,c));do a.write8(k,b),k+=d,c=0!==--e;while(c&&g--);a.add_reg_asize(reg_edi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e;c&&(a.instruction_pointer=a.previous_ip)}else a.safe_write8(c,b),a.add_reg_asize(reg_edi,
d);a.diverged()}
function stosw(a){var b=a.reg16[reg_ax],c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-2:2;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&1){do{a.safe_write16(c,b);c+=d;a.add_reg_asize(reg_edi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_write(c)>>>1;a.paging&&(g=string_get_cycle_count(d,c));do a.write_aligned16(m,b),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_edi,
d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.safe_write16(c,b),a.add_reg_asize(reg_edi,d);a.diverged()}
function stosd(a){var b=a.reg32s[reg_eax],c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-4:4;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&3){do{a.safe_write32(c,b);c+=d;a.add_reg_asize(reg_edi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_write(c)>>>2;a.paging&&(g=string_get_cycle_count(d,c));do a.write_aligned32(m,b),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_edi,
d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.safe_write32(c,b),a.add_reg_asize(reg_edi,d);a.diverged()}
function lodsb(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.flags&flag_direction?-1:1;if(a.prefixes&PREFIX_MASK_REP){var d=a.get_reg_asize(reg_ecx)>>>0;if(0===d)return;var e=d,f=MAX_COUNT_PER_CYCLE,g=a.translate_address_read(b);a.paging&&(f=string_get_cycle_count(c,b));do a.reg8[reg_al]=a.read8(g),g+=c,b=0!==--d;while(b&&f--);a.add_reg_asize(reg_esi,c*(e-d)|0);a.set_ecx_asize(d);a.timestamp_counter+=e-d;b&&(a.instruction_pointer=a.previous_ip)}else a.reg8[reg_al]=a.safe_read8(b),
a.add_reg_asize(reg_esi,c);a.diverged()}function lodsw(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.flags&flag_direction?-2:2;if(a.prefixes&PREFIX_MASK_REP){if(0===a.get_reg_asize(reg_ecx)>>>0)return;var d=MAX_COUNT_PER_CYCLE;do{a.reg16[reg_ax]=a.safe_read16(b);b+=c;a.add_reg_asize(reg_esi,c);var e=0!==a.decr_ecx_asize()}while(e&&d--);e&&(a.instruction_pointer=a.previous_ip)}else a.reg16[reg_ax]=a.safe_read16(b),a.add_reg_asize(reg_esi,c);a.diverged()}
function lodsd(a){var b=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,c=a.flags&flag_direction?-4:4;if(a.prefixes&PREFIX_MASK_REP){if(0===a.get_reg_asize(reg_ecx)>>>0)return;var d=MAX_COUNT_PER_CYCLE;do{a.reg32s[reg_eax]=a.safe_read32s(b);b+=c;a.add_reg_asize(reg_esi,c);var e=0!==a.decr_ecx_asize()}while(e&&d--);e&&(a.instruction_pointer=a.previous_ip)}else a.reg32s[reg_eax]=a.safe_read32s(b),a.add_reg_asize(reg_esi,c);a.diverged()}
function scasb(a){var b=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,c=a.flags&flag_direction?-1:1,d=a.reg8[reg_al];if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE,l=a.translate_address_read(b);a.paging&&(k=string_get_cycle_count(c,b));do{b=a.read8(l);l+=c;var m=0!==--e&&d===b===g}while(m&&k--);a.add_reg_asize(reg_edi,c*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e;m&&(a.instruction_pointer=
a.previous_ip)}else b=a.safe_read8(b),a.add_reg_asize(reg_edi,c);a.cmp8(d,b);a.diverged()}
function scasw(a){var b=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,c=a.flags&flag_direction?-2:2,d=a.reg16[reg_al];if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE;if(b&1){do{var l=a.safe_read16(b);b+=c;a.add_reg_asize(reg_edi,c);var m=0!==a.decr_ecx_asize()&&d===l===g}while(m&&k--)}else{var p=0>c?-1:1,n=a.translate_address_read(b)>>>1;a.paging&&(k=string_get_cycle_count(c,b));do l=a.read_aligned16(n),
n+=p,m=0!==--e&&d===l===g;while(m&&k--);a.add_reg_asize(reg_edi,c*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}m&&(a.instruction_pointer=a.previous_ip)}else l=a.safe_read16(b),a.add_reg_asize(reg_edi,c);a.cmp16(d,l);a.diverged()}
function scasd(a){var b=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,c=a.flags&flag_direction?-4:4,d=a.reg32s[reg_eax];if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=(a.prefixes&PREFIX_MASK_REP)===PREFIX_REPZ,k=MAX_COUNT_PER_CYCLE;if(b&3){do{var l=a.safe_read32s(b);b+=c;a.add_reg_asize(reg_edi,c);var m=0!==a.decr_ecx_asize()&&d===l===g}while(m&&k--)}else{var p=0>c?-1:1,n=a.translate_address_read(b)>>>2;a.paging&&(k=string_get_cycle_count(c,b));do l=a.read_aligned32(n),
n+=p,m=0!==--e&&d===l===g;while(m&&k--);a.add_reg_asize(reg_edi,c*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}m&&(a.instruction_pointer=a.previous_ip)}else l=a.safe_read32s(b),a.add_reg_asize(reg_edi,c);a.cmp32(d,l);a.diverged()}
function insb(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,1);var c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-1:1;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE,k=a.translate_address_write(c);a.paging&&(g=string_get_cycle_count(d,c));do a.write8(k,a.io.port_read8(b)),k+=d,c=0!==--e;while(c&&g--);a.add_reg_asize(reg_edi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e;c&&(a.instruction_pointer=
a.previous_ip)}else a.writable_or_pagefault(c,1),a.safe_write8(c,a.io.port_read8(b)),a.add_reg_asize(reg_edi,d);a.diverged()}
function insw(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,2);var c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-2:2;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&1){do{a.safe_write16(c,a.io.port_read16(b));c+=d;a.add_reg_asize(reg_edi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_write(c)>>>1;a.paging&&(g=string_get_cycle_count(d,c));do a.write_aligned16(m,
a.io.port_read16(b)),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_edi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.writable_or_pagefault(c,2),a.safe_write16(c,a.io.port_read16(b)),a.add_reg_asize(reg_edi,d);a.diverged()}
function insd(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,4);var c=a.get_seg(reg_es)+a.get_reg_asize(reg_edi)|0,d=a.flags&flag_direction?-4:4;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&3){do{a.safe_write32(c,a.io.port_read32(b));c+=d;a.add_reg_asize(reg_edi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_write(c)>>>2;a.paging&&(g=string_get_cycle_count(d,c));do a.write_aligned32(m,
a.io.port_read32(b)),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_edi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.writable_or_pagefault(c,4),a.safe_write32(c,a.io.port_read32(b)),a.add_reg_asize(reg_edi,d);a.diverged()}
function outsb(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,1);var c=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,d=a.flags&flag_direction?-1:1;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE,k=a.translate_address_read(c);a.paging&&(g=string_get_cycle_count(d,c));do a.io.port_write8(b,a.read8(k)),k+=d,c=0!==--e;while(c&&g--);a.add_reg_asize(reg_esi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e;c&&(a.instruction_pointer=
a.previous_ip)}else a.io.port_write8(b,a.safe_read8(c)),a.add_reg_asize(reg_esi,d);a.diverged()}
function outsw(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,2);var c=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,d=a.flags&flag_direction?-2:2;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&1){do{a.io.port_write16(b,a.safe_read16(c));c+=d;a.add_reg_asize(reg_esi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_read(c)>>>1;a.paging&&(g=string_get_cycle_count(d,c));do a.io.port_write16(b,
a.read_aligned16(m)),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_esi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.io.port_write16(b,a.safe_read16(c)),a.add_reg_asize(reg_esi,d);a.diverged()}
function outsd(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,4);var c=a.get_seg_prefix(reg_ds)+a.get_reg_asize(reg_esi)|0,d=a.flags&flag_direction?-4:4;if(a.prefixes&PREFIX_MASK_REP){var e=a.get_reg_asize(reg_ecx)>>>0;if(0===e)return;var f=e,g=MAX_COUNT_PER_CYCLE;if(c&3){do{a.io.port_write32(b,a.safe_read32s(c));c+=d;a.add_reg_asize(reg_esi,d);var k=0!==a.decr_ecx_asize()}while(k&&g--)}else{var l=0>d?-1:1,m=a.translate_address_read(c)>>>2;a.paging&&(g=string_get_cycle_count(d,c));do a.io.port_write32(b,
a.read_aligned32(m)),m+=l,k=0!==--e;while(k&&g--);a.add_reg_asize(reg_esi,d*(f-e)|0);a.set_ecx_asize(e);a.timestamp_counter+=f-e}k&&(a.instruction_pointer=a.previous_ip)}else a.io.port_write32(b,a.safe_read32s(c)),a.add_reg_asize(reg_esi,d);a.diverged()};CPU.prototype.add8=function(a,b){return this.add(a,b,OPSIZE_8)};CPU.prototype.add16=function(a,b){return this.add(a,b,OPSIZE_16)};CPU.prototype.add32=function(a,b){return this.add(a,b,OPSIZE_32)};CPU.prototype.adc8=function(a,b){return this.adc(a,b,OPSIZE_8)};CPU.prototype.adc16=function(a,b){return this.adc(a,b,OPSIZE_16)};CPU.prototype.adc32=function(a,b){return this.adc(a,b,OPSIZE_32)};CPU.prototype.sub8=function(a,b){return this.sub(a,b,OPSIZE_8)};
CPU.prototype.sub16=function(a,b){return this.sub(a,b,OPSIZE_16)};CPU.prototype.sub32=function(a,b){return this.sub(a,b,OPSIZE_32)};CPU.prototype.cmp8=function(a,b){return this.sub(a,b,OPSIZE_8)};CPU.prototype.cmp16=function(a,b){return this.sub(a,b,OPSIZE_16)};CPU.prototype.cmp32=function(a,b){return this.sub(a,b,OPSIZE_32)};CPU.prototype.sbb8=function(a,b){return this.sbb(a,b,OPSIZE_8)};CPU.prototype.sbb16=function(a,b){return this.sbb(a,b,OPSIZE_16)};
CPU.prototype.sbb32=function(a,b){return this.sbb(a,b,OPSIZE_32)};CPU.prototype.add=function(a,b,c){this.last_op1=a;this.last_op2=b;this.last_add_result=this.last_result=a+b|0;this.last_op_size=c;this.flags_changed=flags_all;return this.last_result};CPU.prototype.adc=function(a,b,c){var d=this.getcf();this.last_op1=a;this.last_op2=b;this.last_add_result=this.last_result=(a+b|0)+d|0;this.last_op_size=c;this.flags_changed=flags_all;return this.last_result};
CPU.prototype.sub=function(a,b,c){this.last_add_result=a;this.last_op2=b;this.last_op1=this.last_result=a-b|0;this.last_op_size=c;this.flags_changed=flags_all;return this.last_result};CPU.prototype.sbb=function(a,b,c){var d=this.getcf();this.last_add_result=a;this.last_op2=b;this.last_op1=this.last_result=a-b-d|0;this.last_op_size=c;this.flags_changed=flags_all;return this.last_result};CPU.prototype.inc8=function(a){return this.inc(a,OPSIZE_8)};CPU.prototype.inc16=function(a){return this.inc(a,OPSIZE_16)};
CPU.prototype.inc32=function(a){return this.inc(a,OPSIZE_32)};CPU.prototype.dec8=function(a){return this.dec(a,OPSIZE_8)};CPU.prototype.dec16=function(a){return this.dec(a,OPSIZE_16)};CPU.prototype.dec32=function(a){return this.dec(a,OPSIZE_32)};CPU.prototype.inc=function(a,b){this.flags=this.flags&-2|this.getcf();this.last_op1=a;this.last_op2=1;this.last_add_result=this.last_result=a+1|0;this.last_op_size=b;this.flags_changed=flags_all&-2;return this.last_result};
CPU.prototype.dec=function(a,b){this.flags=this.flags&-2|this.getcf();this.last_add_result=a;this.last_op2=1;this.last_op1=this.last_result=a-1|0;this.last_op_size=b;this.flags_changed=flags_all&-2;return this.last_result};CPU.prototype.neg8=function(a){return this.neg(a,OPSIZE_8)};CPU.prototype.neg16=function(a){return this.neg(a,OPSIZE_16)};CPU.prototype.neg32=function(a){return this.neg(a,OPSIZE_32)};
CPU.prototype.neg=function(a,b){this.last_op1=this.last_result=-a|0;this.flags_changed=flags_all;this.last_add_result=0;this.last_op2=a;this.last_op_size=b;return this.last_result};CPU.prototype.mul8=function(a){a*=this.reg8[reg_al];this.reg16[reg_ax]=a;this.last_result=a&255;this.last_op_size=OPSIZE_8;this.flags=256>a?this.flags&-2&~flag_overflow:this.flags|1|flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.imul8=function(a){a*=this.reg8s[reg_al];this.reg16[reg_ax]=a;this.last_result=a&255;this.last_op_size=OPSIZE_8;this.flags=127<a||-128>a?this.flags|1|flag_overflow:this.flags&-2&~flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.mul16=function(a){a*=this.reg16[reg_ax];var b=a>>>16;this.reg16[reg_ax]=a;this.reg16[reg_dx]=b;this.last_result=a&65535;this.last_op_size=OPSIZE_16;this.flags=0===b?this.flags&-2&~flag_overflow:this.flags|1|flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.imul16=function(a){a*=this.reg16s[reg_ax];this.reg16[reg_ax]=a;this.reg16[reg_dx]=a>>16;this.last_result=a&65535;this.last_op_size=OPSIZE_16;this.flags=32767<a||-32768>a?this.flags|1|flag_overflow:this.flags&-2&~flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.imul_reg16=function(a,b){dbg_assert(32768>a&&-32768<=a);dbg_assert(32768>b&&-32768<=b);a*=b;this.last_result=a&65535;this.last_op_size=OPSIZE_16;this.flags=32767<a||-32768>a?this.flags|1|flag_overflow:this.flags&-2&~flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow;return a};
CPU.prototype.do_mul32=function(a,b){var c=a&65535;a>>>=16;var d=b&65535;b>>>=16;var e=c*d;d=(e>>>16)+(a*d|0)|0;var f=d>>>16;d=(d&65535)+(c*b|0)|0;this.mul32_result[0]=d<<16|e&65535;this.mul32_result[1]=((d>>>16)+(a*b|0)|0)+f|0;return this.mul32_result};CPU.prototype.do_imul32=function(a,b){var c=!1;0>a&&(c=!0,a=-a|0);0>b&&(c=!c,b=-b|0);a=this.do_mul32(a,b);c&&(a[0]=-a[0]|0,a[1]=~a[1]+!a[0]|0);return a};
CPU.prototype.mul32=function(a){a=this.do_mul32(this.reg32s[reg_eax],a);this.reg32s[reg_eax]=a[0];this.reg32s[reg_edx]=a[1];this.last_result=a[0];this.last_op_size=OPSIZE_32;this.flags=0===a[1]?this.flags&-2&~flag_overflow:this.flags|1|flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.imul32=function(a){dbg_assert(2147483648>a&&-2147483648<=a);a=this.do_imul32(this.reg32s[reg_eax],a);this.reg32s[reg_eax]=a[0];this.reg32s[reg_edx]=a[1];this.last_result=a[0];this.last_op_size=OPSIZE_32;this.flags=a[1]===a[0]>>31?this.flags&-2&~flag_overflow:this.flags|1|flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow};
CPU.prototype.imul_reg32=function(a,b){dbg_assert(2147483648>a&&-2147483648<=a);dbg_assert(2147483648>b&&-2147483648<=b);a=this.do_imul32(a,b);this.last_result=a[0];this.last_op_size=OPSIZE_32;this.flags=a[1]===a[0]>>31?this.flags&-2&~flag_overflow:this.flags|1|flag_overflow;this.flags_changed=flags_all&-2&~flag_overflow;return a[0]};
CPU.prototype.div8=function(a){dbg_assert(0<=a&&256>a);if(0===a)this.trigger_de();else{var b=this.reg16[reg_ax],c=b/a|0;256<=c?this.trigger_de():(this.reg8[reg_al]=c,this.reg8[reg_ah]=b%a)}};CPU.prototype.idiv8=function(a){dbg_assert(-128<=a&&128>a);if(0===a)this.trigger_de();else{var b=this.reg16s[reg_ax],c=b/a|0;128<=c||-129>=c?this.trigger_de():(this.reg8[reg_al]=c,this.reg8[reg_ah]=b%a)}};
CPU.prototype.div16=function(a){dbg_assert(0<=a&&65536>a);if(0===a)this.trigger_de();else{var b=(this.reg16[reg_ax]|this.reg16[reg_dx]<<16)>>>0,c=b/a|0;65536<=c||0>c?this.trigger_de():(this.reg16[reg_ax]=c,this.reg16[reg_dx]=b%a)}};CPU.prototype.idiv16=function(a){dbg_assert(-32768<=a&&32768>a);if(0===a)this.trigger_de();else{var b=this.reg16[reg_ax]|this.reg16[reg_dx]<<16,c=b/a|0;32768<=c||-32769>=c?this.trigger_de():(this.reg16[reg_ax]=c,this.reg16[reg_dx]=b%a)}};
CPU.prototype.do_div32=function(a,b,c){if(b>=c||0===c)dbg_log("div32 #DE: "+h(b,8)+":"+h(a,8)+" div "+h(c,8)),this.trigger_de();var d=0;if(1048576<b){for(var e=32,f=c;f>b;)f>>>=1,e--;for(;1048576<b;){if(b>=f){b-=f;var g=c<<e>>>0;g>a&&b--;a=a-g>>>0;d|=1<<e}e--;f>>=1}d>>>=0}a+=4294967296*b;this.div32_result[0]=d+(a/c|0);this.div32_result[1]=a%c;return this.div32_result};
CPU.prototype.div32=function(a){dbg_assert(0<=a&&4294967295>=a);var b=this.reg32[reg_eax],c=this.reg32[reg_edx],d=this.do_div32(b,c,a),e=d[0];d=d[1];dbg_assert(a);4294967296<=e?(dbg_log("div32 #DE: "+h(c,8)+":"+h(b,8)+" div "+h(a,8)),dbg_log("-> "+h(e)),this.trigger_de()):(this.reg32s[reg_eax]=e,this.reg32s[reg_edx]=d)};
CPU.prototype.idiv32=function(a){dbg_assert(2147483648>a&&-2147483648<=a);var b=this.reg32[reg_eax],c=this.reg32s[reg_edx],d=!1,e=!1;0>a&&(e=!0,a=-a);0>c&&(d=!0,e=!e,b=-b>>>0,c=~c+!b);var f=this.do_div32(b,c,a),g=f[0];f=f[1];e&&(g=-g|0);d&&(f=-f|0);dbg_assert(a);2147483648<=g||-2147483649>=g?(dbg_log("div32 #DE: "+h(c,8)+":"+h(b,8)+" div "+h(a,8)),dbg_log("-> "+h(g)),this.trigger_de()):(this.reg32s[reg_eax]=g,this.reg32s[reg_edx]=f)};
CPU.prototype.xadd8=function(a,b){var c=this.reg8[b];this.reg8[b]=a;return this.add(a,c,OPSIZE_8)};CPU.prototype.xadd16=function(a,b){var c=this.reg16[b];this.reg16[b]=a;return this.add(a,c,OPSIZE_16)};CPU.prototype.xadd32=function(a,b){var c=this.reg32s[b];this.reg32s[b]=a;return this.add(a,c,OPSIZE_32)};
CPU.prototype.bcd_daa=function(){var a=this.reg8[reg_al],b=this.getcf(),c=this.getaf();this.flags=this.flags&-2&~flag_adjust;if(9<(a&15)||c)this.reg8[reg_al]+=6,this.flags|=flag_adjust;if(153<a||b)this.reg8[reg_al]+=96,this.flags|=1;this.last_result=this.reg8[reg_al];this.last_op_size=OPSIZE_8;this.last_op1=this.last_op2=0;this.flags_changed=flags_all&-2&~flag_adjust&~flag_overflow};
CPU.prototype.bcd_das=function(){var a=this.reg8[reg_al],b=this.getcf();this.flags&=-2;9<(a&15)||this.getaf()?(this.reg8[reg_al]-=6,this.flags|=flag_adjust,this.flags=this.flags&-2|b|6>a):this.flags&=~flag_adjust;if(153<a||b)this.reg8[reg_al]-=96,this.flags|=1;this.last_result=this.reg8[reg_al];this.last_op_size=OPSIZE_8;this.last_op1=this.last_op2=0;this.flags_changed=flags_all&-2&~flag_adjust&~flag_overflow};
CPU.prototype.bcd_aam=function(a){if(0===a)this.trigger_de();else{var b=this.reg8[reg_al];this.reg8[reg_ah]=b/a;this.reg8[reg_al]=b%a;this.last_result=this.reg8[reg_al];this.flags_changed=flags_all&-2&~flag_adjust&~flag_overflow;this.flags=this.flags&-2&~flag_adjust&~flag_overflow}};
CPU.prototype.bcd_aad=function(a){a=this.reg8[reg_al]+this.reg8[reg_ah]*a;this.last_result=a&255;this.reg16[reg_ax]=this.last_result;this.last_op_size=OPSIZE_8;this.flags_changed=flags_all&-2&~flag_adjust&~flag_overflow;this.flags=this.flags&-2&~flag_adjust&~flag_overflow;65535<a&&(this.flags|=1)};
CPU.prototype.bcd_aaa=function(){9<(this.reg8[reg_al]&15)||this.getaf()?(this.reg16[reg_ax]+=6,this.reg8[reg_ah]+=1,this.flags=this.flags|flag_adjust|1):this.flags=this.flags&~flag_adjust&-2;this.reg8[reg_al]&=15;this.flags_changed=this.flags_changed&~flag_adjust&-2};
CPU.prototype.bcd_aas=function(){9<(this.reg8[reg_al]&15)||this.getaf()?(this.reg16[reg_ax]-=6,--this.reg8[reg_ah],this.flags=this.flags|flag_adjust|1):this.flags=this.flags&~flag_adjust&-2;this.reg8[reg_al]&=15;this.flags_changed=this.flags_changed&~flag_adjust&-2};CPU.prototype.and8=function(a,b){return this.and(a,b,OPSIZE_8)};CPU.prototype.and16=function(a,b){return this.and(a,b,OPSIZE_16)};CPU.prototype.and32=function(a,b){return this.and(a,b,OPSIZE_32)};
CPU.prototype.test8=function(a,b){return this.and(a,b,OPSIZE_8)};CPU.prototype.test16=function(a,b){return this.and(a,b,OPSIZE_16)};CPU.prototype.test32=function(a,b){return this.and(a,b,OPSIZE_32)};CPU.prototype.or8=function(a,b){return this.or(a,b,OPSIZE_8)};CPU.prototype.or16=function(a,b){return this.or(a,b,OPSIZE_16)};CPU.prototype.or32=function(a,b){return this.or(a,b,OPSIZE_32)};CPU.prototype.xor8=function(a,b){return this.xor(a,b,OPSIZE_8)};
CPU.prototype.xor16=function(a,b){return this.xor(a,b,OPSIZE_16)};CPU.prototype.xor32=function(a,b){return this.xor(a,b,OPSIZE_32)};CPU.prototype.and=function(a,b,c){this.last_result=a&b;this.last_op_size=c;this.flags=this.flags&-2&~flag_overflow&~flag_adjust;this.flags_changed=flags_all&-2&~flag_overflow&~flag_adjust;return this.last_result};
CPU.prototype.or=function(a,b,c){this.last_result=a|b;this.last_op_size=c;this.flags=this.flags&-2&~flag_overflow&~flag_adjust;this.flags_changed=flags_all&-2&~flag_overflow&~flag_adjust;return this.last_result};CPU.prototype.xor=function(a,b,c){this.last_result=a^b;this.last_op_size=c;this.flags=this.flags&-2&~flag_overflow&~flag_adjust;this.flags_changed=flags_all&-2&~flag_overflow&~flag_adjust;return this.last_result};
CPU.prototype.rol8=function(a,b){if(!b)return a;b&=7;a=a<<b|a>>8-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a&1|(a<<11^a<<4)&flag_overflow;return a};CPU.prototype.rol16=function(a,b){if(!b)return a;b&=15;a=a<<b|a>>16-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a&1|(a<<11^a>>4)&flag_overflow;return a};
CPU.prototype.rol32=function(a,b){if(!b)return a;a=a<<b|a>>>32-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a&1|(a<<11^a>>20)&flag_overflow;return a};CPU.prototype.rcl8=function(a,b){b%=9;if(!b)return a;a=a<<b|this.getcf()<<b-1|a>>9-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>8&1|(a<<3^a<<4)&flag_overflow;return a};
CPU.prototype.rcl16=function(a,b){b%=17;if(!b)return a;a=a<<b|this.getcf()<<b-1|a>>17-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>16&1|(a>>5^a>>4)&flag_overflow;return a};CPU.prototype.rcl32=function(a,b){if(!b)return a;var c=a<<b|this.getcf()<<b-1;1<b&&(c|=a>>>33-b);this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>>32-b&1;this.flags|=(this.flags<<11^c>>20)&flag_overflow;return c};
CPU.prototype.ror8=function(a,b){if(!b)return a;b&=7;a=a>>b|a<<8-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>7&1|(a<<4^a<<5)&flag_overflow;return a};CPU.prototype.ror16=function(a,b){if(!b)return a;b&=15;a=a>>b|a<<16-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>15&1|(a>>4^a>>3)&flag_overflow;return a};
CPU.prototype.ror32=function(a,b){if(!b)return a;a=a>>>b|a<<32-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>31&1|(a>>20^a>>19)&flag_overflow;return a};CPU.prototype.rcr8=function(a,b){b%=9;if(!b)return a;a=a>>b|this.getcf()<<8-b|a<<9-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>8&1|(a<<4^a<<5)&flag_overflow;return a};
CPU.prototype.rcr16=function(a,b){b%=17;if(!b)return a;a=a>>b|this.getcf()<<16-b|a<<17-b;this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>16&1|(a>>4^a>>3)&flag_overflow;return a};CPU.prototype.rcr32=function(a,b){if(!b)return a;var c=a>>>b|this.getcf()<<32-b;1<b&&(c|=a<<33-b);this.flags_changed=this.flags_changed&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>b-1&1|(c>>20^c>>19)&flag_overflow;return c};
CPU.prototype.shl8=function(a,b){if(0===b)return a;this.last_result=a<<b;this.last_op_size=OPSIZE_8;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|this.last_result>>8&1|(this.last_result<<3^this.last_result<<4)&flag_overflow;return this.last_result};
CPU.prototype.shl16=function(a,b){if(0===b)return a;this.last_result=a<<b;this.last_op_size=OPSIZE_16;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|this.last_result>>16&1|(this.last_result>>5^this.last_result>>4)&flag_overflow;return this.last_result};
CPU.prototype.shl32=function(a,b){if(0===b)return a;this.last_result=a<<b;this.last_op_size=OPSIZE_32;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>>32-b&1;this.flags|=(this.flags&1^this.last_result>>31&1)<<11&flag_overflow;return this.last_result};
CPU.prototype.shr8=function(a,b){if(0===b)return a;this.last_result=a>>b;this.last_op_size=OPSIZE_8;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>b-1&1|(a>>7&1)<<11&flag_overflow;return this.last_result};CPU.prototype.shr16=function(a,b){if(0===b)return a;this.last_result=a>>b;this.last_op_size=OPSIZE_16;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>b-1&1|a>>4&flag_overflow;return this.last_result};
CPU.prototype.shr32=function(a,b){if(0===b)return a;this.last_result=a>>>b;this.last_op_size=OPSIZE_32;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>>b-1&1|a>>20&flag_overflow;return this.last_result};
CPU.prototype.sar8=function(a,b){if(0===b)return a;8>b?(this.last_result=a<<24>>b+24,this.flags=this.flags&-2&~flag_overflow|a>>b-1&1):(this.last_result=a<<24>>31,this.flags=this.flags&-2&~flag_overflow|this.last_result&1);this.last_op_size=OPSIZE_8;this.flags_changed=flags_all&-2&~flag_overflow;return this.last_result};
CPU.prototype.sar16=function(a,b){if(0===b)return a;16>b?(this.last_result=a<<16>>b+16,this.flags=this.flags&-2&~flag_overflow|a>>b-1&1):(this.last_result=a<<16>>31,this.flags=this.flags&-2&~flag_overflow|this.last_result&1);this.last_op_size=OPSIZE_16;this.flags_changed=flags_all&-2&~flag_overflow;return this.last_result};
CPU.prototype.sar32=function(a,b){if(0===b)return a;this.last_result=a>>b;this.last_op_size=OPSIZE_32;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2&~flag_overflow|a>>>b-1&1;return this.last_result};
CPU.prototype.shrd16=function(a,b,c){if(0===c)return a;16>=c?(this.last_result=a>>c|b<<16-c,this.flags=this.flags&-2|a>>c-1&1):(this.last_result=a<<32-c|b>>c-16,this.flags=this.flags&-2|b>>c-17&1);this.last_op_size=OPSIZE_16;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&~flag_overflow|(this.last_result^a)>>4&flag_overflow;return this.last_result};
CPU.prototype.shrd32=function(a,b,c){if(0===c)return a;this.last_result=a>>>c|b<<32-c;this.last_op_size=OPSIZE_32;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2|a>>>c-1&1;this.flags=this.flags&~flag_overflow|(this.last_result^a)>>20&flag_overflow;return this.last_result};
CPU.prototype.shld16=function(a,b,c){if(0===c)return a;16>=c?(this.last_result=a<<c|b>>>16-c,this.flags=this.flags&-2|a>>>16-c&1):(this.last_result=a>>32-c|b<<c-16,this.flags=this.flags&-2|b>>>32-c&1);this.last_op_size=OPSIZE_16;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&~flag_overflow|(this.flags&1^this.last_result>>15&1)<<11;return this.last_result};
CPU.prototype.shld32=function(a,b,c){if(0===c)return a;this.last_result=a<<c|b>>>32-c;this.last_op_size=OPSIZE_32;this.flags_changed=flags_all&-2&~flag_overflow;this.flags=this.flags&-2|a>>>32-c&1;this.flags=1===c?this.flags&~flag_overflow|(this.flags&1^this.last_result>>31&1)<<11:this.flags&~flag_overflow;return this.last_result};CPU.prototype.bt_reg=function(a,b){this.flags=this.flags&-2|a>>b&1;this.flags_changed&=-2};
CPU.prototype.btc_reg=function(a,b){this.flags=this.flags&-2|a>>b&1;this.flags_changed&=-2;return a^1<<b};CPU.prototype.bts_reg=function(a,b){this.flags=this.flags&-2|a>>b&1;this.flags_changed&=-2;return a|1<<b};CPU.prototype.btr_reg=function(a,b){this.flags=this.flags&-2|a>>b&1;this.flags_changed&=-2;return a&~(1<<b)};CPU.prototype.bt_mem=function(a,b){a=this.safe_read8(a+(b>>3)|0);this.flags=this.flags&-2|a>>(b&7)&1;this.flags_changed&=-2};
CPU.prototype.btc_mem=function(a,b){a=this.translate_address_write(a+(b>>3)|0);var c=this.read8(a);b&=7;this.flags=this.flags&-2|c>>b&1;this.flags_changed&=-2;this.write8(a,c^1<<b)};CPU.prototype.btr_mem=function(a,b){a=this.translate_address_write(a+(b>>3)|0);var c=this.read8(a);b&=7;this.flags=this.flags&-2|c>>b&1;this.flags_changed&=-2;this.write8(a,c&~(1<<b))};
CPU.prototype.bts_mem=function(a,b){a=this.translate_address_write(a+(b>>3)|0);var c=this.read8(a);b&=7;this.flags=this.flags&-2|c>>b&1;this.flags_changed&=-2;this.write8(a,c|1<<b)};CPU.prototype.bsf16=function(a,b){this.flags_changed=flags_all&~flag_zero;this.last_op_size=OPSIZE_16;if(0===b)return this.flags|=flag_zero,this.last_result=b,a;this.flags&=~flag_zero;return this.last_result=v86util.int_log2(-b&b)};
CPU.prototype.bsf32=function(a,b){this.flags_changed=flags_all&~flag_zero;this.last_op_size=OPSIZE_32;if(0===b)return this.flags|=flag_zero,this.last_result=b,a;this.flags&=~flag_zero;return this.last_result=v86util.int_log2((-b&b)>>>0)};CPU.prototype.bsr16=function(a,b){this.flags_changed=flags_all&~flag_zero;this.last_op_size=OPSIZE_16;if(0===b)return this.flags|=flag_zero,this.last_result=b,a;this.flags&=~flag_zero;return this.last_result=v86util.int_log2(b)};
CPU.prototype.bsr32=function(a,b){this.flags_changed=flags_all&~flag_zero;this.last_op_size=OPSIZE_32;if(0===b)return this.flags|=flag_zero,this.last_result=b,a;this.flags&=~flag_zero;return this.last_result=v86util.int_log2(b>>>0)};CPU.prototype.popcnt=function(a){this.flags_changed=0;this.flags&=~flags_all;if(a)return a-=a>>1&1431655765,a=(a&858993459)+(a>>2&858993459),16843009*(a+(a>>4)&252645135)>>24;this.flags|=flag_zero;return 0};
CPU.prototype.saturate_sw_to_ub=function(a){dbg_assert(0===(a&4294901760));a>>>=0;32768<=a?a=0:255<a&&(a=255);dbg_assert(0===(a&4294967040));return a};CPU.prototype.saturate_sw_to_sb=function(a){dbg_assert(0===(a&4294901760));65408<a?a&=255:32767<a?a=128:127<a&&(a=127);dbg_assert(0===(a&4294967040));return a};CPU.prototype.saturate_sd_to_sw=function(a){a>>>=0;4294934528<a?a&=65535:2147483647<a?a=32768:32767<a&&(a=32767);dbg_assert(0===(a&4294901760));return a};
CPU.prototype.saturate_sd_to_sb=function(a){a>>>=0;4294967168<a?a&=255:2147483647<a?a=128:127<a&&(a=127);dbg_assert(0===(a&4294967040));return a};CPU.prototype.saturate_sd_to_ub=function(a){a|=0;0>a&&(a=0);dbg_assert(0===(a&4294967040));return a};CPU.prototype.saturate_ud_to_ub=function(a){a>>>=0;255<a&&(a=255);dbg_assert(0===(a&4294967040));return a};CPU.prototype.saturate_uw=function(a){dbg_assert(0<=a);return 65535<a?65535:a};CPU.prototype.jmpcc8=function(a){var b=this.read_op8s();a?(this.instruction_pointer=this.instruction_pointer+b|0,this.branch_taken()):this.branch_not_taken()};CPU.prototype.jmp_rel16=function(a){var b=this.get_seg(reg_cs);this.instruction_pointer-=b;this.instruction_pointer=this.instruction_pointer+a&65535;this.instruction_pointer=this.instruction_pointer+b|0};CPU.prototype.jmpcc16=function(a){var b=this.read_op16();a?(this.jmp_rel16(b),this.branch_taken()):this.branch_not_taken()};
CPU.prototype.jmpcc32=function(a){var b=this.read_op32s();a?(this.instruction_pointer=this.instruction_pointer+b|0,this.branch_taken()):this.branch_not_taken()};CPU.prototype.cmovcc16=function(a){var b=this.read_e16();a&&this.write_g16(b)};CPU.prototype.cmovcc32=function(a){var b=this.read_e32s();a&&this.write_g32(b)};CPU.prototype.setcc=function(a){this.set_e8(a?1:0)};
CPU.prototype.loopne=function(a){this.decr_ecx_asize()&&!this.getzf()?(this.instruction_pointer=this.instruction_pointer+a|0,this.branch_taken()):this.branch_not_taken()};CPU.prototype.loope=function(a){this.decr_ecx_asize()&&this.getzf()?(this.instruction_pointer=this.instruction_pointer+a|0,this.branch_taken()):this.branch_not_taken()};CPU.prototype.loop=function(a){this.decr_ecx_asize()?(this.instruction_pointer=this.instruction_pointer+a|0,this.branch_taken()):this.branch_not_taken()};
CPU.prototype.jcxz=function(a){0===this.get_reg_asize(reg_ecx)?(this.instruction_pointer=this.instruction_pointer+a|0,this.branch_taken()):this.branch_not_taken()};CPU.prototype.getcf=function(){return this.flags_changed&1?(this.last_op1^(this.last_op1^this.last_op2)&(this.last_op2^this.last_add_result))>>>this.last_op_size&1:this.flags&1};CPU.prototype.getpf=function(){return this.flags_changed&flag_parity?154020>>((this.last_result^this.last_result>>4)&15)&flag_parity:this.flags&flag_parity};
CPU.prototype.getaf=function(){return this.flags_changed&flag_adjust?(this.last_op1^this.last_op2^this.last_add_result)&flag_adjust:this.flags&flag_adjust};CPU.prototype.getzf=function(){return this.flags_changed&flag_zero?(~this.last_result&this.last_result-1)>>>this.last_op_size&1:this.flags&flag_zero};CPU.prototype.getsf=function(){return this.flags_changed&flag_sign?this.last_result>>>this.last_op_size&1:this.flags&flag_sign};
CPU.prototype.getof=function(){return this.flags_changed&flag_overflow?((this.last_op1^this.last_add_result)&(this.last_op2^this.last_add_result))>>>this.last_op_size&1:this.flags&flag_overflow};CPU.prototype.test_o=CPU.prototype.getof;CPU.prototype.test_b=CPU.prototype.getcf;CPU.prototype.test_z=CPU.prototype.getzf;CPU.prototype.test_s=CPU.prototype.getsf;CPU.prototype.test_p=CPU.prototype.getpf;CPU.prototype.test_be=function(){return this.getcf()||this.getzf()};
CPU.prototype.test_l=function(){return!this.getsf()!==!this.getof()};CPU.prototype.test_le=function(){return this.getzf()||!this.getsf()!==!this.getof()};CPU.prototype.push16=function(a){var b=this.get_stack_pointer(-2);this.safe_write16(b,a);this.adjust_stack_reg(-2)};CPU.prototype.push32=function(a){var b=this.get_stack_pointer(-4);this.safe_write32(b,a);this.adjust_stack_reg(-4)};
CPU.prototype.pop16=function(){var a=this.get_seg(reg_ss)+this.get_stack_reg()|0;a=this.safe_read16(a);this.adjust_stack_reg(2);return a};CPU.prototype.pop32s=function(){var a=this.get_seg(reg_ss)+this.get_stack_reg()|0;a=this.safe_read32s(a);this.adjust_stack_reg(4);return a};
CPU.prototype.pusha16=function(){var a=this.reg16[reg_sp];this.writable_or_pagefault(this.get_stack_pointer(-16),16);this.push16(this.reg16[reg_ax]);this.push16(this.reg16[reg_cx]);this.push16(this.reg16[reg_dx]);this.push16(this.reg16[reg_bx]);this.push16(a);this.push16(this.reg16[reg_bp]);this.push16(this.reg16[reg_si]);this.push16(this.reg16[reg_di])};
CPU.prototype.pusha32=function(){var a=this.reg32s[reg_esp];this.writable_or_pagefault(this.get_stack_pointer(-32),32);this.push32(this.reg32s[reg_eax]);this.push32(this.reg32s[reg_ecx]);this.push32(this.reg32s[reg_edx]);this.push32(this.reg32s[reg_ebx]);this.push32(a);this.push32(this.reg32s[reg_ebp]);this.push32(this.reg32s[reg_esi]);this.push32(this.reg32s[reg_edi])};
CPU.prototype.popa16=function(){this.translate_address_read(this.get_stack_pointer(0));this.translate_address_read(this.get_stack_pointer(15));this.reg16[reg_di]=this.pop16();this.reg16[reg_si]=this.pop16();this.reg16[reg_bp]=this.pop16();this.adjust_stack_reg(2);this.reg16[reg_bx]=this.pop16();this.reg16[reg_dx]=this.pop16();this.reg16[reg_cx]=this.pop16();this.reg16[reg_ax]=this.pop16()};
CPU.prototype.popa32=function(){this.translate_address_read(this.get_stack_pointer(0));this.translate_address_read(this.get_stack_pointer(31));this.reg32s[reg_edi]=this.pop32s();this.reg32s[reg_esi]=this.pop32s();this.reg32s[reg_ebp]=this.pop32s();this.adjust_stack_reg(4);this.reg32s[reg_ebx]=this.pop32s();this.reg32s[reg_edx]=this.pop32s();this.reg32s[reg_ecx]=this.pop32s();this.reg32s[reg_eax]=this.pop32s()};CPU.prototype.xchg8=function(a,b){b=b>>1&12|b>>5&1;var c=this.reg8[b];this.reg8[b]=a;return c};
CPU.prototype.xchg16=function(a,b){b=b>>2&14;var c=this.reg16[b];this.reg16[b]=a;return c};CPU.prototype.xchg16r=function(a){var b=this.reg16[reg_ax];this.reg16[reg_ax]=this.reg16[a];this.reg16[a]=b};CPU.prototype.xchg32=function(a,b){b=b>>3&7;var c=this.reg32s[b];this.reg32s[b]=a;return c};CPU.prototype.xchg32r=function(a){var b=this.reg32s[reg_eax];this.reg32s[reg_eax]=this.reg32s[a];this.reg32s[a]=b};
CPU.prototype.lss16=function(a){192<=this.modrm_byte&&this.trigger_ud();var b=this.modrm_resolve(this.modrm_byte),c=this.safe_read16(b);b=this.safe_read16(b+2|0);this.switch_seg(a,b);this.reg16[this.modrm_byte>>2&14]=c};CPU.prototype.lss32=function(a){192<=this.modrm_byte&&this.trigger_ud();var b=this.modrm_resolve(this.modrm_byte),c=this.safe_read32s(b);b=this.safe_read16(b+4|0);this.switch_seg(a,b);this.reg32s[this.modrm_byte>>3&7]=c};
CPU.prototype.enter16=function(a,b){(b&=31)&&dbg_log("enter16 stack="+(this.stack_size_32?32:16)+" size="+a+" nest="+b,LOG_CPU);this.push16(this.reg16[reg_bp]);var c=this.reg16[reg_sp];if(0<b){for(var d=this.reg16[reg_ebp],e=1;e<b;e++)d-=2,this.push16(this.safe_read16(this.get_seg(reg_ss)+d|0));this.push16(c)}this.reg16[reg_bp]=c;this.adjust_stack_reg(-a)};
CPU.prototype.enter32=function(a,b){(b&=31)&&dbg_log("enter32 stack="+(this.stack_size_32?32:16)+" size="+a+" nest="+b,LOG_CPU);this.push32(this.reg32s[reg_ebp]);var c=this.reg32s[reg_esp];if(0<b){for(var d=this.reg32s[reg_ebp],e=1;e<b;e++)d-=4,this.push32(this.safe_read32s(this.get_seg(reg_ss)+d|0));this.push32(c)}this.reg32s[reg_ebp]=c;this.adjust_stack_reg(-a)};CPU.prototype.bswap=function(a){var b=this.reg32s[a];this.reg32s[a]=b>>>24|b<<24|b>>8&65280|b<<8&16711680};
CPU.prototype.fxsave=function(a){this.writable_or_pagefault(a,512);this.safe_write16(a+0|0,this.fpu.control_word);this.safe_write16(a+2|0,this.fpu.load_status_word());this.safe_write8(a+4|0,~this.fpu.stack_empty&255);this.safe_write16(a+6|0,this.fpu.fpu_opcode);this.safe_write32(a+8|0,this.fpu.fpu_ip);this.safe_write16(a+12|0,this.fpu.fpu_ip_selector);this.safe_write32(a+16|0,this.fpu.fpu_dp);this.safe_write16(a+20|0,this.fpu.fpu_dp_selector);this.safe_write32(a+24|0,this.mxcsr);this.safe_write32(a+
28|0,MXCSR_MASK);for(var b=0;8>b;b++)this.fpu.store_m80(a+32+(b<<4)|0,this.fpu.st[this.fpu.stack_ptr+b&7]);for(b=0;8>b;b++)this.safe_write32(a+160+(b<<4)+0|0,this.reg_xmm32s[b<<2|0]),this.safe_write32(a+160+(b<<4)+4|0,this.reg_xmm32s[b<<2|1]),this.safe_write32(a+160+(b<<4)+8|0,this.reg_xmm32s[b<<2|2]),this.safe_write32(a+160+(b<<4)+12|0,this.reg_xmm32s[b<<2|3])};
CPU.prototype.fxrstor=function(a){this.translate_address_read(a|0);this.translate_address_read(a+511|0);var b=this.safe_read32s(a+24|0);b&~MXCSR_MASK&&(dbg_log("Invalid mxcsr bits: "+h((b&~MXCSR_MASK)>>>0,8)),this.trigger_gp(0));this.fpu.control_word=this.safe_read16(a+0|0);this.fpu.set_status_word(this.safe_read16(a+2|0));this.fpu.stack_empty=~this.safe_read8(a+4|0)&255;this.fpu.fpu_opcode=this.safe_read16(a+6|0);this.fpu.fpu_ip=this.safe_read32s(a+8|0);this.fpu.fpu_ip=this.safe_read16(a+12|0);this.fpu.fpu_dp=
this.safe_read32s(a+16|0);this.fpu.fpu_dp_selector=this.safe_read16(a+20|0);this.mxcsr=b;for(b=0;8>b;b++)this.fpu.st[this.fpu.stack_ptr+b&7]=this.fpu.load_m80(a+32+(b<<4)|0);for(b=0;8>b;b++)this.reg_xmm32s[b<<2|0]=this.safe_read32s(a+160+(b<<4)+0|0),this.reg_xmm32s[b<<2|1]=this.safe_read32s(a+160+(b<<4)+4|0),this.reg_xmm32s[b<<2|2]=this.safe_read32s(a+160+(b<<4)+8|0),this.reg_xmm32s[b<<2|3]=this.safe_read32s(a+160+(b<<4)+12|0)};var t=[],t16=[],t32=[];t[0]=function(a){a.read_modrm_byte();a.write_e8(a.add8(a.read_write_e8(),a.read_g8()))};t16[1]=function(a){a.read_modrm_byte();a.write_e16(a.add16(a.read_write_e16(),a.read_g16()))};t32[1]=function(a){a.read_modrm_byte();a.write_e32(a.add32(a.read_write_e32(),a.read_g32s()))};t[2]=function(a){a.read_modrm_byte();a.write_g8(a.add8(a.read_g8(),a.read_e8()))};t16[3]=function(a){a.read_modrm_byte();a.write_g16(a.add16(a.read_g16(),a.read_e16()))};
t32[3]=function(a){a.read_modrm_byte();a.write_g32(a.add32(a.read_g32s(),a.read_e32s()))};t[4]=function(a){a.reg8[reg_al]=a.add8(a.reg8[reg_al],a.read_op8())};t16[5]=function(a){a.reg16[reg_ax]=a.add16(a.reg16[reg_ax],a.read_op16())};t32[5]=function(a){a.reg32s[reg_eax]=a.add32(a.reg32s[reg_eax],a.read_op32s())};t16[6]=function(a){a.push16(a.sreg[reg_es])};t32[6]=function(a){a.push32(a.sreg[reg_es])};t16[7]=function(a){a.switch_seg(reg_es,a.safe_read16(a.get_stack_pointer(0)));a.adjust_stack_reg(2)};
t32[7]=function(a){a.switch_seg(reg_es,a.safe_read32s(a.get_stack_pointer(0))&65535);a.adjust_stack_reg(4)};t[8]=function(a){a.read_modrm_byte();a.write_e8(a.or8(a.read_write_e8(),a.read_g8()))};t16[9]=function(a){a.read_modrm_byte();a.write_e16(a.or16(a.read_write_e16(),a.read_g16()))};t32[9]=function(a){a.read_modrm_byte();a.write_e32(a.or32(a.read_write_e32(),a.read_g32s()))};t[10]=function(a){a.read_modrm_byte();a.write_g8(a.or8(a.read_g8(),a.read_e8()))};
t16[11]=function(a){a.read_modrm_byte();a.write_g16(a.or16(a.read_g16(),a.read_e16()))};t32[11]=function(a){a.read_modrm_byte();a.write_g32(a.or32(a.read_g32s(),a.read_e32s()))};t[12]=function(a){a.reg8[reg_al]=a.or8(a.reg8[reg_al],a.read_op8())};t16[13]=function(a){a.reg16[reg_ax]=a.or16(a.reg16[reg_ax],a.read_op16())};t32[13]=function(a){a.reg32s[reg_eax]=a.or32(a.reg32s[reg_eax],a.read_op32s())};t16[14]=function(a){a.push16(a.sreg[reg_cs])};t32[14]=function(a){a.push32(a.sreg[reg_cs])};
t16[15]=function(a){a.table0F_16[a.read_op0F()](a)};t32[15]=function(a){a.table0F_32[a.read_op0F()](a)};t[16]=function(a){a.read_modrm_byte();a.write_e8(a.adc8(a.read_write_e8(),a.read_g8()))};t16[17]=function(a){a.read_modrm_byte();a.write_e16(a.adc16(a.read_write_e16(),a.read_g16()))};t32[17]=function(a){a.read_modrm_byte();a.write_e32(a.adc32(a.read_write_e32(),a.read_g32s()))};t[18]=function(a){a.read_modrm_byte();a.write_g8(a.adc8(a.read_g8(),a.read_e8()))};
t16[19]=function(a){a.read_modrm_byte();a.write_g16(a.adc16(a.read_g16(),a.read_e16()))};t32[19]=function(a){a.read_modrm_byte();a.write_g32(a.adc32(a.read_g32s(),a.read_e32s()))};t[20]=function(a){a.reg8[reg_al]=a.adc8(a.reg8[reg_al],a.read_op8())};t16[21]=function(a){a.reg16[reg_ax]=a.adc16(a.reg16[reg_ax],a.read_op16())};t32[21]=function(a){a.reg32s[reg_eax]=a.adc32(a.reg32s[reg_eax],a.read_op32s())};t16[22]=function(a){a.push16(a.sreg[reg_ss])};t32[22]=function(a){a.push32(a.sreg[reg_ss])};
t16[23]=function(a){a.switch_seg(reg_ss,a.safe_read16(a.get_stack_pointer(0)));a.adjust_stack_reg(2);a.clear_prefixes();a.cycle_internal()};t32[23]=function(a){a.switch_seg(reg_ss,a.safe_read32s(a.get_stack_pointer(0))&65535);a.adjust_stack_reg(4);a.clear_prefixes();a.cycle_internal()};t[24]=function(a){a.read_modrm_byte();a.write_e8(a.sbb8(a.read_write_e8(),a.read_g8()))};t16[25]=function(a){a.read_modrm_byte();a.write_e16(a.sbb16(a.read_write_e16(),a.read_g16()))};
t32[25]=function(a){a.read_modrm_byte();a.write_e32(a.sbb32(a.read_write_e32(),a.read_g32s()))};t[26]=function(a){a.read_modrm_byte();a.write_g8(a.sbb8(a.read_g8(),a.read_e8()))};t16[27]=function(a){a.read_modrm_byte();a.write_g16(a.sbb16(a.read_g16(),a.read_e16()))};t32[27]=function(a){a.read_modrm_byte();a.write_g32(a.sbb32(a.read_g32s(),a.read_e32s()))};t[28]=function(a){a.reg8[reg_al]=a.sbb8(a.reg8[reg_al],a.read_op8())};t16[29]=function(a){a.reg16[reg_ax]=a.sbb16(a.reg16[reg_ax],a.read_op16())};
t32[29]=function(a){a.reg32s[reg_eax]=a.sbb32(a.reg32s[reg_eax],a.read_op32s())};t16[30]=function(a){a.push16(a.sreg[reg_ds])};t32[30]=function(a){a.push32(a.sreg[reg_ds])};t16[31]=function(a){a.switch_seg(reg_ds,a.safe_read16(a.get_stack_pointer(0)));a.adjust_stack_reg(2)};t32[31]=function(a){a.switch_seg(reg_ds,a.safe_read32s(a.get_stack_pointer(0))&65535);a.adjust_stack_reg(4)};t[32]=function(a){a.read_modrm_byte();a.write_e8(a.and8(a.read_write_e8(),a.read_g8()))};
t16[33]=function(a){a.read_modrm_byte();a.write_e16(a.and16(a.read_write_e16(),a.read_g16()))};t32[33]=function(a){a.read_modrm_byte();a.write_e32(a.and32(a.read_write_e32(),a.read_g32s()))};t[34]=function(a){a.read_modrm_byte();a.write_g8(a.and8(a.read_g8(),a.read_e8()))};t16[35]=function(a){a.read_modrm_byte();a.write_g16(a.and16(a.read_g16(),a.read_e16()))};t32[35]=function(a){a.read_modrm_byte();a.write_g32(a.and32(a.read_g32s(),a.read_e32s()))};
t[36]=function(a){a.reg8[reg_al]=a.and8(a.reg8[reg_al],a.read_op8())};t16[37]=function(a){a.reg16[reg_ax]=a.and16(a.reg16[reg_ax],a.read_op16())};t32[37]=function(a){a.reg32s[reg_eax]=a.and32(a.reg32s[reg_eax],a.read_op32s())};t[38]=function(a){a.segment_prefix_op(reg_es)};t[39]=function(a){a.bcd_daa()};t[40]=function(a){a.read_modrm_byte();a.write_e8(a.sub8(a.read_write_e8(),a.read_g8()))};t16[41]=function(a){a.read_modrm_byte();a.write_e16(a.sub16(a.read_write_e16(),a.read_g16()))};
t32[41]=function(a){a.read_modrm_byte();a.write_e32(a.sub32(a.read_write_e32(),a.read_g32s()))};t[42]=function(a){a.read_modrm_byte();a.write_g8(a.sub8(a.read_g8(),a.read_e8()))};t16[43]=function(a){a.read_modrm_byte();a.write_g16(a.sub16(a.read_g16(),a.read_e16()))};t32[43]=function(a){a.read_modrm_byte();a.write_g32(a.sub32(a.read_g32s(),a.read_e32s()))};t[44]=function(a){a.reg8[reg_al]=a.sub8(a.reg8[reg_al],a.read_op8())};t16[45]=function(a){a.reg16[reg_ax]=a.sub16(a.reg16[reg_ax],a.read_op16())};
t32[45]=function(a){a.reg32s[reg_eax]=a.sub32(a.reg32s[reg_eax],a.read_op32s())};t[46]=function(a){a.segment_prefix_op(reg_cs)};t[47]=function(a){a.bcd_das()};t[48]=function(a){a.read_modrm_byte();a.write_e8(a.xor8(a.read_write_e8(),a.read_g8()))};t16[49]=function(a){a.read_modrm_byte();a.write_e16(a.xor16(a.read_write_e16(),a.read_g16()))};t32[49]=function(a){a.read_modrm_byte();a.write_e32(a.xor32(a.read_write_e32(),a.read_g32s()))};
t[50]=function(a){a.read_modrm_byte();a.write_g8(a.xor8(a.read_g8(),a.read_e8()))};t16[51]=function(a){a.read_modrm_byte();a.write_g16(a.xor16(a.read_g16(),a.read_e16()))};t32[51]=function(a){a.read_modrm_byte();a.write_g32(a.xor32(a.read_g32s(),a.read_e32s()))};t[52]=function(a){a.reg8[reg_al]=a.xor8(a.reg8[reg_al],a.read_op8())};t16[53]=function(a){a.reg16[reg_ax]=a.xor16(a.reg16[reg_ax],a.read_op16())};t32[53]=function(a){a.reg32s[reg_eax]=a.xor32(a.reg32s[reg_eax],a.read_op32s())};t[54]=function(a){a.segment_prefix_op(reg_ss)};
t[55]=function(a){a.bcd_aaa()};t[56]=function(a){a.read_modrm_byte();a.cmp8(a.read_e8(),a.read_g8())};t16[57]=function(a){a.read_modrm_byte();a.cmp16(a.read_e16(),a.read_g16())};t32[57]=function(a){a.read_modrm_byte();a.cmp32(a.read_e32s(),a.read_g32s())};t[58]=function(a){a.read_modrm_byte();a.cmp8(a.read_g8(),a.read_e8())};t16[59]=function(a){a.read_modrm_byte();a.cmp16(a.read_g16(),a.read_e16())};t32[59]=function(a){a.read_modrm_byte();a.cmp32(a.read_g32s(),a.read_e32s())};
t[60]=function(a){a.cmp8(a.reg8[reg_al],a.read_op8())};t16[61]=function(a){a.cmp16(a.reg16[reg_ax],a.read_op16())};t32[61]=function(a){a.cmp32(a.reg32s[reg_eax],a.read_op32s())};t[62]=function(a){a.segment_prefix_op(reg_ds)};t[63]=function(a){a.bcd_aas()};t16[64]=function(a){a.reg16[reg_ax]=a.inc16(a.reg16[reg_ax])};t32[64]=function(a){a.reg32s[reg_eax]=a.inc32(a.reg32s[reg_eax])};t16[65]=function(a){a.reg16[reg_cx]=a.inc16(a.reg16[reg_cx])};t32[65]=function(a){a.reg32s[reg_ecx]=a.inc32(a.reg32s[reg_ecx])};
t16[66]=function(a){a.reg16[reg_dx]=a.inc16(a.reg16[reg_dx])};t32[66]=function(a){a.reg32s[reg_edx]=a.inc32(a.reg32s[reg_edx])};t16[67]=function(a){a.reg16[reg_bx]=a.inc16(a.reg16[reg_bx])};t32[67]=function(a){a.reg32s[reg_ebx]=a.inc32(a.reg32s[reg_ebx])};t16[68]=function(a){a.reg16[reg_sp]=a.inc16(a.reg16[reg_sp])};t32[68]=function(a){a.reg32s[reg_esp]=a.inc32(a.reg32s[reg_esp])};t16[69]=function(a){a.reg16[reg_bp]=a.inc16(a.reg16[reg_bp])};t32[69]=function(a){a.reg32s[reg_ebp]=a.inc32(a.reg32s[reg_ebp])};
t16[70]=function(a){a.reg16[reg_si]=a.inc16(a.reg16[reg_si])};t32[70]=function(a){a.reg32s[reg_esi]=a.inc32(a.reg32s[reg_esi])};t16[71]=function(a){a.reg16[reg_di]=a.inc16(a.reg16[reg_di])};t32[71]=function(a){a.reg32s[reg_edi]=a.inc32(a.reg32s[reg_edi])};t16[72]=function(a){a.reg16[reg_ax]=a.dec16(a.reg16[reg_ax])};t32[72]=function(a){a.reg32s[reg_eax]=a.dec32(a.reg32s[reg_eax])};t16[73]=function(a){a.reg16[reg_cx]=a.dec16(a.reg16[reg_cx])};t32[73]=function(a){a.reg32s[reg_ecx]=a.dec32(a.reg32s[reg_ecx])};
t16[74]=function(a){a.reg16[reg_dx]=a.dec16(a.reg16[reg_dx])};t32[74]=function(a){a.reg32s[reg_edx]=a.dec32(a.reg32s[reg_edx])};t16[75]=function(a){a.reg16[reg_bx]=a.dec16(a.reg16[reg_bx])};t32[75]=function(a){a.reg32s[reg_ebx]=a.dec32(a.reg32s[reg_ebx])};t16[76]=function(a){a.reg16[reg_sp]=a.dec16(a.reg16[reg_sp])};t32[76]=function(a){a.reg32s[reg_esp]=a.dec32(a.reg32s[reg_esp])};t16[77]=function(a){a.reg16[reg_bp]=a.dec16(a.reg16[reg_bp])};t32[77]=function(a){a.reg32s[reg_ebp]=a.dec32(a.reg32s[reg_ebp])};
t16[78]=function(a){a.reg16[reg_si]=a.dec16(a.reg16[reg_si])};t32[78]=function(a){a.reg32s[reg_esi]=a.dec32(a.reg32s[reg_esi])};t16[79]=function(a){a.reg16[reg_di]=a.dec16(a.reg16[reg_di])};t32[79]=function(a){a.reg32s[reg_edi]=a.dec32(a.reg32s[reg_edi])};t16[80]=function(a){a.push16(a.reg16[reg_ax])};t32[80]=function(a){a.push32(a.reg32s[reg_eax])};t16[81]=function(a){a.push16(a.reg16[reg_cx])};t32[81]=function(a){a.push32(a.reg32s[reg_ecx])};t16[82]=function(a){a.push16(a.reg16[reg_dx])};
t32[82]=function(a){a.push32(a.reg32s[reg_edx])};t16[83]=function(a){a.push16(a.reg16[reg_bx])};t32[83]=function(a){a.push32(a.reg32s[reg_ebx])};t16[84]=function(a){a.push16(a.reg16[reg_sp])};t32[84]=function(a){a.push32(a.reg32s[reg_esp])};t16[85]=function(a){a.push16(a.reg16[reg_bp])};t32[85]=function(a){a.push32(a.reg32s[reg_ebp])};t16[86]=function(a){a.push16(a.reg16[reg_si])};t32[86]=function(a){a.push32(a.reg32s[reg_esi])};t16[87]=function(a){a.push16(a.reg16[reg_di])};t32[87]=function(a){a.push32(a.reg32s[reg_edi])};
t16[88]=function(a){a.reg16[reg_ax]=a.pop16()};t32[88]=function(a){a.reg32s[reg_eax]=a.pop32s()};t16[89]=function(a){a.reg16[reg_cx]=a.pop16()};t32[89]=function(a){a.reg32s[reg_ecx]=a.pop32s()};t16[90]=function(a){a.reg16[reg_dx]=a.pop16()};t32[90]=function(a){a.reg32s[reg_edx]=a.pop32s()};t16[91]=function(a){a.reg16[reg_bx]=a.pop16()};t32[91]=function(a){a.reg32s[reg_ebx]=a.pop32s()};t16[92]=function(a){a.reg16[reg_sp]=a.pop16()};t32[92]=function(a){a.reg32s[reg_esp]=a.pop32s()};
t16[93]=function(a){a.reg16[reg_bp]=a.pop16()};t32[93]=function(a){a.reg32s[reg_ebp]=a.pop32s()};t16[94]=function(a){a.reg16[reg_si]=a.pop16()};t32[94]=function(a){a.reg32s[reg_esi]=a.pop32s()};t16[95]=function(a){a.reg16[reg_di]=a.pop16()};t32[95]=function(a){a.reg32s[reg_edi]=a.pop32s()};t16[96]=function(a){a.pusha16()};t32[96]=function(a){a.pusha32()};t16[97]=function(a){a.popa16()};t32[97]=function(a){a.popa32()};t[98]=function(a){dbg_log("Unimplemented BOUND instruction",LOG_CPU);dbg_assert(!1)};
t[99]=function(a){a.read_modrm_byte();a.protected_mode&&!a.vm86_mode()?a.write_e16(a.arpl(a.read_write_e16(),a.modrm_byte>>2&14)):(dbg_log("arpl #ud",LOG_CPU),a.trigger_ud())};t[100]=function(a){a.segment_prefix_op(reg_fs)};t[101]=function(a){a.segment_prefix_op(reg_gs)};t[102]=function(a){a.prefixes|=PREFIX_MASK_OPSIZE;a.run_prefix_instruction();a.prefixes=0};t[103]=function(a){dbg_assert(a.is_asize_32()===a.is_32);a.prefixes|=PREFIX_MASK_ADDRSIZE;a.run_prefix_instruction();a.prefixes=0};
t16[104]=function(a){a.push16(a.read_op16())};t32[104]=function(a){a.push32(a.read_op32s())};t16[105]=function(a){a.read_modrm_byte();a.write_g16(a.imul_reg16(a.read_e16s(),a.read_op16()<<16>>16))};t32[105]=function(a){a.read_modrm_byte();a.write_g32(a.imul_reg32(a.read_e32s(),a.read_op32s()))};t16[106]=function(a){a.push16(a.read_op8s())};t32[106]=function(a){a.push32(a.read_op8s())};t16[107]=function(a){a.read_modrm_byte();a.write_g16(a.imul_reg16(a.read_e16s(),a.read_op8s()))};
t32[107]=function(a){a.read_modrm_byte();a.write_g32(a.imul_reg32(a.read_e32s(),a.read_op8s()))};t[108]=function(a){insb(a)};t16[109]=function(a){insw(a)};t32[109]=function(a){insd(a)};t[110]=function(a){outsb(a)};t16[111]=function(a){outsw(a)};t32[111]=function(a){outsd(a)};t[112]=function(a){a.jmpcc8(a.test_o())};t[113]=function(a){a.jmpcc8(!a.test_o())};t[114]=function(a){a.jmpcc8(a.test_b())};t[115]=function(a){a.jmpcc8(!a.test_b())};t[116]=function(a){a.jmpcc8(a.test_z())};t[117]=function(a){a.jmpcc8(!a.test_z())};
t[118]=function(a){a.jmpcc8(a.test_be())};t[119]=function(a){a.jmpcc8(!a.test_be())};t[120]=function(a){a.jmpcc8(a.test_s())};t[121]=function(a){a.jmpcc8(!a.test_s())};t[122]=function(a){a.jmpcc8(a.test_p())};t[123]=function(a){a.jmpcc8(!a.test_p())};t[124]=function(a){a.jmpcc8(a.test_l())};t[125]=function(a){a.jmpcc8(!a.test_l())};t[126]=function(a){a.jmpcc8(a.test_le())};t[127]=function(a){a.jmpcc8(!a.test_le())};
t[128]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:a.write_e8(a.add8(a.read_write_e8(),a.read_op8()));break;case 1:a.write_e8(a.or8(a.read_write_e8(),a.read_op8()));break;case 2:a.write_e8(a.adc8(a.read_write_e8(),a.read_op8()));break;case 3:a.write_e8(a.sbb8(a.read_write_e8(),a.read_op8()));break;case 4:a.write_e8(a.and8(a.read_write_e8(),a.read_op8()));break;case 5:a.write_e8(a.sub8(a.read_write_e8(),a.read_op8()));break;case 6:a.write_e8(a.xor8(a.read_write_e8(),a.read_op8()));
break;case 7:a.cmp8(a.read_e8(),a.read_op8())}};
t16[129]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:a.write_e16(a.add16(a.read_write_e16(),a.read_op16()));break;case 1:a.write_e16(a.or16(a.read_write_e16(),a.read_op16()));break;case 2:a.write_e16(a.adc16(a.read_write_e16(),a.read_op16()));break;case 3:a.write_e16(a.sbb16(a.read_write_e16(),a.read_op16()));break;case 4:a.write_e16(a.and16(a.read_write_e16(),a.read_op16()));break;case 5:a.write_e16(a.sub16(a.read_write_e16(),a.read_op16()));break;case 6:a.write_e16(a.xor16(a.read_write_e16(),
a.read_op16()));break;case 7:a.cmp16(a.read_e16(),a.read_op16())}};
t32[129]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:a.write_e32(a.add32(a.read_write_e32(),a.read_op32s()));break;case 1:a.write_e32(a.or32(a.read_write_e32(),a.read_op32s()));break;case 2:a.write_e32(a.adc32(a.read_write_e32(),a.read_op32s()));break;case 3:a.write_e32(a.sbb32(a.read_write_e32(),a.read_op32s()));break;case 4:a.write_e32(a.and32(a.read_write_e32(),a.read_op32s()));break;case 5:a.write_e32(a.sub32(a.read_write_e32(),a.read_op32s()));break;case 6:a.write_e32(a.xor32(a.read_write_e32(),
a.read_op32s()));break;case 7:a.cmp32(a.read_e32s(),a.read_op32s())}};t[130]=t[128];
t16[131]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:a.write_e16(a.add16(a.read_write_e16(),a.read_op8s()));break;case 1:a.write_e16(a.or16(a.read_write_e16(),a.read_op8s()));break;case 2:a.write_e16(a.adc16(a.read_write_e16(),a.read_op8s()));break;case 3:a.write_e16(a.sbb16(a.read_write_e16(),a.read_op8s()));break;case 4:a.write_e16(a.and16(a.read_write_e16(),a.read_op8s()));break;case 5:a.write_e16(a.sub16(a.read_write_e16(),a.read_op8s()));break;case 6:a.write_e16(a.xor16(a.read_write_e16(),
a.read_op8s()));break;case 7:a.cmp16(a.read_e16(),a.read_op8s())}};
t32[131]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:a.write_e32(a.add32(a.read_write_e32(),a.read_op8s()));break;case 1:a.write_e32(a.or32(a.read_write_e32(),a.read_op8s()));break;case 2:a.write_e32(a.adc32(a.read_write_e32(),a.read_op8s()));break;case 3:a.write_e32(a.sbb32(a.read_write_e32(),a.read_op8s()));break;case 4:a.write_e32(a.and32(a.read_write_e32(),a.read_op8s()));break;case 5:a.write_e32(a.sub32(a.read_write_e32(),a.read_op8s()));break;case 6:a.write_e32(a.xor32(a.read_write_e32(),
a.read_op8s()));break;case 7:a.cmp32(a.read_e32s(),a.read_op8s())}};t[132]=function(a){a.read_modrm_byte();var b=a.read_e8();a.test8(b,a.read_g8())};t16[133]=function(a){a.read_modrm_byte();var b=a.read_e16();a.test16(b,a.read_g16())};t32[133]=function(a){a.read_modrm_byte();var b=a.read_e32s();a.test32(b,a.read_g32s())};t[134]=function(a){a.read_modrm_byte();var b=a.read_write_e8();a.write_e8(a.xchg8(b,a.modrm_byte))};
t16[135]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.xchg16(b,a.modrm_byte))};t32[135]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.xchg32(b,a.modrm_byte))};t[136]=function(a){a.read_modrm_byte();a.set_e8(a.read_g8())};t16[137]=function(a){a.read_modrm_byte();a.set_e16(a.read_g16())};t32[137]=function(a){a.read_modrm_byte();a.set_e32(a.read_g32s())};t[138]=function(a){a.read_modrm_byte();var b=a.read_e8();a.write_g8(b)};
t16[139]=function(a){a.read_modrm_byte();var b=a.read_e16();a.write_g16(b)};t32[139]=function(a){a.read_modrm_byte();var b=a.read_e32s();a.write_g32(b)};t16[140]=function(a){a.read_modrm_byte();a.set_e16(a.sreg[a.modrm_byte>>3&7])};t32[140]=function(a){a.read_modrm_byte();a.set_e32(a.sreg[a.modrm_byte>>3&7])};
t16[141]=function(a){a.read_modrm_byte();192<=a.modrm_byte&&(dbg_log("lea #ud",LOG_CPU),a.trigger_ud());var b=a.modrm_byte>>3&7;a.prefixes|=SEG_PREFIX_ZERO;a.reg16[b<<1]=a.modrm_resolve(a.modrm_byte);a.prefixes=0};t32[141]=function(a){a.read_modrm_byte();192<=a.modrm_byte&&(dbg_log("lea #ud",LOG_CPU),a.trigger_ud());var b=a.modrm_byte>>3&7;a.prefixes|=SEG_PREFIX_ZERO;a.reg32s[b]=a.modrm_resolve(a.modrm_byte);a.prefixes=0};
t[142]=function(a){a.read_modrm_byte();var b=a.modrm_byte>>3&7,c=a.read_e16();a.switch_seg(b,c);b===reg_ss&&(a.clear_prefixes(),a.cycle_internal())};t16[143]=function(a){a.read_modrm_byte();var b=a.safe_read16(a.get_stack_pointer(0));a.adjust_stack_reg(2);if(192>a.modrm_byte){var c=a.modrm_resolve(a.modrm_byte);a.adjust_stack_reg(-2);a.safe_write16(c,b);a.adjust_stack_reg(2)}else a.write_reg_e16(b)};
t32[143]=function(a){a.read_modrm_byte();var b=a.safe_read32s(a.get_stack_pointer(0));a.adjust_stack_reg(4);if(192>a.modrm_byte){var c=a.modrm_resolve(a.modrm_byte);a.adjust_stack_reg(-4);a.safe_write32(c,b);a.adjust_stack_reg(4)}else a.write_reg_e32(b)};t[144]=function(a){};t16[145]=function(a){a.xchg16r(reg_cx)};t32[145]=function(a){a.xchg32r(reg_ecx)};t16[146]=function(a){a.xchg16r(reg_dx)};t32[146]=function(a){a.xchg32r(reg_edx)};t16[147]=function(a){a.xchg16r(reg_bx)};t32[147]=function(a){a.xchg32r(reg_ebx)};
t16[148]=function(a){a.xchg16r(reg_sp)};t32[148]=function(a){a.xchg32r(reg_esp)};t16[149]=function(a){a.xchg16r(reg_bp)};t32[149]=function(a){a.xchg32r(reg_ebp)};t16[150]=function(a){a.xchg16r(reg_si)};t32[150]=function(a){a.xchg32r(reg_esi)};t16[151]=function(a){a.xchg16r(reg_di)};t32[151]=function(a){a.xchg32r(reg_edi)};t16[152]=function(a){a.reg16[reg_ax]=a.reg8s[reg_al]};t32[152]=function(a){a.reg32s[reg_eax]=a.reg16s[reg_ax]};t16[153]=function(a){a.reg16[reg_dx]=a.reg16s[reg_ax]>>15};
t32[153]=function(a){a.reg32s[reg_edx]=a.reg32s[reg_eax]>>31};t16[154]=function(a){var b=a.read_op16(),c=a.read_disp16();a.far_jump(b,c,!0);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t32[154]=function(a){var b=a.read_op32s(),c=a.read_disp16();if((!a.protected_mode||a.vm86_mode())&&b&4294901760)throw a.debug.unimpl("#GP handler");a.far_jump(b,c,!0);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};
t[155]=function(a){(a.cr[0]&(CR0_MP|CR0_TS))===(CR0_MP|CR0_TS)?a.trigger_nm():a.fpu&&a.fpu.fwait()};t16[156]=function(a){a.flags&flag_vm&&3>a.getiopl()?(dbg_assert(a.protected_mode),dbg_log("pushf #gp",LOG_CPU),a.trigger_gp(0)):a.push16(a.get_eflags())};t32[156]=function(a){a.flags&flag_vm&&3>a.getiopl()?(dbg_assert(a.protected_mode),dbg_log("pushf #gp",LOG_CPU),a.trigger_gp(0)):a.push32(a.get_eflags()&16580607)};
t16[157]=function(a){a.flags&flag_vm&&3>a.getiopl()&&(dbg_log("popf #gp",LOG_CPU),a.trigger_gp(0));a.update_eflags(a.flags&-65536|a.pop16());a.flags&flag_trap?a.flags&=~flag_trap:a.handle_irqs()};t32[157]=function(a){a.flags&flag_vm&&3>a.getiopl()&&(dbg_log("popf #gp",LOG_CPU),a.trigger_gp(0));a.update_eflags(a.pop32s());a.handle_irqs()};t[158]=function(a){a.flags=a.flags&-256|a.reg8[reg_ah];a.flags=a.flags&flags_mask|flags_default;a.flags_changed=0};t[159]=function(a){a.reg8[reg_ah]=a.get_eflags()};
t[160]=function(a){var b=a.safe_read8(a.read_moffs());a.reg8[reg_al]=b};t16[161]=function(a){var b=a.safe_read16(a.read_moffs());a.reg16[reg_ax]=b};t32[161]=function(a){var b=a.safe_read32s(a.read_moffs());a.reg32s[reg_eax]=b};t[162]=function(a){a.safe_write8(a.read_moffs(),a.reg8[reg_al])};t16[163]=function(a){a.safe_write16(a.read_moffs(),a.reg16[reg_ax])};t32[163]=function(a){a.safe_write32(a.read_moffs(),a.reg32s[reg_eax])};t[164]=function(a){a.movsb()};t16[165]=function(a){a.movsw()};
t32[165]=function(a){a.movsd()};t[166]=function(a){cmpsb(a)};t16[167]=function(a){cmpsw(a)};t32[167]=function(a){cmpsd(a)};t[168]=function(a){a.test8(a.reg8[reg_al],a.read_op8())};t16[169]=function(a){a.test16(a.reg16[reg_ax],a.read_op16())};t32[169]=function(a){a.test32(a.reg32s[reg_eax],a.read_op32s())};t[170]=function(a){stosb(a)};t16[171]=function(a){stosw(a)};t32[171]=function(a){stosd(a)};t[172]=function(a){lodsb(a)};t16[173]=function(a){lodsw(a)};t32[173]=function(a){lodsd(a)};t[174]=function(a){scasb(a)};
t16[175]=function(a){scasw(a)};t32[175]=function(a){scasd(a)};t[176]=function(a){a.reg8[reg_al]=a.read_op8()};t[177]=function(a){a.reg8[reg_cl]=a.read_op8()};t[178]=function(a){a.reg8[reg_dl]=a.read_op8()};t[179]=function(a){a.reg8[reg_bl]=a.read_op8()};t[180]=function(a){a.reg8[reg_ah]=a.read_op8()};t[181]=function(a){a.reg8[reg_ch]=a.read_op8()};t[182]=function(a){a.reg8[reg_dh]=a.read_op8()};t[183]=function(a){a.reg8[reg_bh]=a.read_op8()};t16[184]=function(a){a.reg16[reg_ax]=a.read_op16()};
t32[184]=function(a){a.reg32s[reg_eax]=a.read_op32s()};t16[185]=function(a){a.reg16[reg_cx]=a.read_op16()};t32[185]=function(a){a.reg32s[reg_ecx]=a.read_op32s()};t16[186]=function(a){a.reg16[reg_dx]=a.read_op16()};t32[186]=function(a){a.reg32s[reg_edx]=a.read_op32s()};t16[187]=function(a){a.reg16[reg_bx]=a.read_op16()};t32[187]=function(a){a.reg32s[reg_ebx]=a.read_op32s()};t16[188]=function(a){a.reg16[reg_sp]=a.read_op16()};t32[188]=function(a){a.reg32s[reg_esp]=a.read_op32s()};
t16[189]=function(a){a.reg16[reg_bp]=a.read_op16()};t32[189]=function(a){a.reg32s[reg_ebp]=a.read_op32s()};t16[190]=function(a){a.reg16[reg_si]=a.read_op16()};t32[190]=function(a){a.reg32s[reg_esi]=a.read_op32s()};t16[191]=function(a){a.reg16[reg_di]=a.read_op16()};t32[191]=function(a){a.reg32s[reg_edi]=a.read_op32s()};
t[192]=function(a){a.read_modrm_byte();var b=a.read_write_e8(),c=a.read_op8()&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol8(b,c);break;case 1:d=a.ror8(b,c);break;case 2:d=a.rcl8(b,c);break;case 3:d=a.rcr8(b,c);break;case 4:d=a.shl8(b,c);break;case 5:d=a.shr8(b,c);break;case 6:d=a.shl8(b,c);break;case 7:d=a.sar8(b,c)}a.write_e8(d)};
t16[193]=function(a){a.read_modrm_byte();var b=a.read_write_e16(),c=a.read_op8()&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol16(b,c);break;case 1:d=a.ror16(b,c);break;case 2:d=a.rcl16(b,c);break;case 3:d=a.rcr16(b,c);break;case 4:d=a.shl16(b,c);break;case 5:d=a.shr16(b,c);break;case 6:d=a.shl16(b,c);break;case 7:d=a.sar16(b,c)}a.write_e16(d)};
t32[193]=function(a){a.read_modrm_byte();var b=a.read_write_e32(),c=a.read_op8()&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol32(b,c);break;case 1:d=a.ror32(b,c);break;case 2:d=a.rcl32(b,c);break;case 3:d=a.rcr32(b,c);break;case 4:d=a.shl32(b,c);break;case 5:d=a.shr32(b,c);break;case 6:d=a.shl32(b,c);break;case 7:d=a.sar32(b,c)}a.write_e32(d)};
t16[194]=function(a){var b=a.read_op16();a.instruction_pointer=a.get_seg(reg_cs)+a.pop16()|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.adjust_stack_reg(b);a.diverged()};t32[194]=function(a){var b=a.read_op16(),c=a.pop32s();dbg_assert(a.is_asize_32()||65536>c);a.instruction_pointer=a.get_seg(reg_cs)+c|0;a.adjust_stack_reg(b);a.diverged()};t16[195]=function(a){a.instruction_pointer=a.get_seg(reg_cs)+a.pop16()|0;a.diverged()};
t32[195]=function(a){var b=a.pop32s();dbg_assert(a.is_asize_32()||65536>b);a.instruction_pointer=a.get_seg(reg_cs)+b|0;a.diverged()};t16[196]=function(a){a.read_modrm_byte();a.lss16(reg_es)};t32[196]=function(a){a.read_modrm_byte();a.lss32(reg_es)};t16[197]=function(a){a.read_modrm_byte();a.lss16(reg_ds)};t32[197]=function(a){a.read_modrm_byte();a.lss32(reg_ds)};
t[198]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.safe_write8(a.modrm_resolve(a.modrm_byte),a.read_op8()):a.reg8[a.modrm_byte<<2&12|a.modrm_byte>>2&1]=a.read_op8()};t16[199]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.safe_write16(a.modrm_resolve(a.modrm_byte),a.read_op16()):a.reg16[a.modrm_byte<<1&14]=a.read_op16()};t32[199]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.safe_write32(a.modrm_resolve(a.modrm_byte),a.read_op32s()):a.reg32s[a.modrm_byte&7]=a.read_op32s()};
t16[200]=function(a){a.enter16(a.read_op16(),a.read_disp8())};t32[200]=function(a){a.enter32(a.read_op16(),a.read_disp8())};t16[201]=function(a){var b=a.stack_size_32?a.reg32s[reg_ebp]:a.reg16[reg_bp],c=a.safe_read16(a.get_seg(reg_ss)+b|0);a.set_stack_reg(b+2|0);a.reg16[reg_bp]=c};t32[201]=function(a){var b=a.stack_size_32?a.reg32s[reg_ebp]:a.reg16[reg_bp],c=a.safe_read32s(a.get_seg(reg_ss)+b|0);a.set_stack_reg(b+4|0);a.reg32s[reg_ebp]=c};
t16[202]=function(a){var b=a.read_op16(),c=a.safe_read16(a.get_stack_pointer(0)),d=a.safe_read16(a.get_stack_pointer(2));a.far_return(c,d,b);a.diverged()};t32[202]=function(a){var b=a.read_op16(),c=a.safe_read32s(a.get_stack_pointer(0)),d=a.safe_read32s(a.get_stack_pointer(4))&65535;a.far_return(c,d,b);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};
t16[203]=function(a){var b=a.safe_read16(a.get_stack_pointer(0)),c=a.safe_read16(a.get_stack_pointer(2));a.far_return(b,c,0);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t32[203]=function(a){var b=a.safe_read32s(a.get_stack_pointer(0)),c=a.safe_read32s(a.get_stack_pointer(4))&65535;a.far_return(b,c,0);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t[204]=function(a){dbg_log("INT3",LOG_CPU);a.call_interrupt_vector(3,!0,!1);a.diverged()};
t[205]=function(a){var b=a.read_op8();a.call_interrupt_vector(b,!0,!1);a.diverged()};t[206]=function(a){dbg_log("INTO",LOG_CPU);a.getof()&&a.call_interrupt_vector(4,!0,!1);a.diverged()};t16[207]=function(a){a.iret16();a.diverged()};t32[207]=function(a){a.iret32();a.diverged()};
t[208]=function(a){a.read_modrm_byte();var b=a.read_write_e8(),c=0;switch(a.modrm_byte>>3&7){case 0:c=a.rol8(b,1);break;case 1:c=a.ror8(b,1);break;case 2:c=a.rcl8(b,1);break;case 3:c=a.rcr8(b,1);break;case 4:c=a.shl8(b,1);break;case 5:c=a.shr8(b,1);break;case 6:c=a.shl8(b,1);break;case 7:c=a.sar8(b,1)}a.write_e8(c)};
t16[209]=function(a){a.read_modrm_byte();var b=a.read_write_e16(),c=0;switch(a.modrm_byte>>3&7){case 0:c=a.rol16(b,1);break;case 1:c=a.ror16(b,1);break;case 2:c=a.rcl16(b,1);break;case 3:c=a.rcr16(b,1);break;case 4:c=a.shl16(b,1);break;case 5:c=a.shr16(b,1);break;case 6:c=a.shl16(b,1);break;case 7:c=a.sar16(b,1)}a.write_e16(c)};
t32[209]=function(a){a.read_modrm_byte();var b=a.read_write_e32(),c=0;switch(a.modrm_byte>>3&7){case 0:c=a.rol32(b,1);break;case 1:c=a.ror32(b,1);break;case 2:c=a.rcl32(b,1);break;case 3:c=a.rcr32(b,1);break;case 4:c=a.shl32(b,1);break;case 5:c=a.shr32(b,1);break;case 6:c=a.shl32(b,1);break;case 7:c=a.sar32(b,1)}a.write_e32(c)};
t[210]=function(a){a.read_modrm_byte();var b=a.read_write_e8(),c=a.reg8[reg_cl]&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol8(b,c);break;case 1:d=a.ror8(b,c);break;case 2:d=a.rcl8(b,c);break;case 3:d=a.rcr8(b,c);break;case 4:d=a.shl8(b,c);break;case 5:d=a.shr8(b,c);break;case 6:d=a.shl8(b,c);break;case 7:d=a.sar8(b,c)}a.write_e8(d)};
t16[211]=function(a){a.read_modrm_byte();var b=a.read_write_e16(),c=a.reg8[reg_cl]&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol16(b,c);break;case 1:d=a.ror16(b,c);break;case 2:d=a.rcl16(b,c);break;case 3:d=a.rcr16(b,c);break;case 4:d=a.shl16(b,c);break;case 5:d=a.shr16(b,c);break;case 6:d=a.shl16(b,c);break;case 7:d=a.sar16(b,c)}a.write_e16(d)};
t32[211]=function(a){a.read_modrm_byte();var b=a.read_write_e32(),c=a.reg8[reg_cl]&31,d=0;switch(a.modrm_byte>>3&7){case 0:d=a.rol32(b,c);break;case 1:d=a.ror32(b,c);break;case 2:d=a.rcl32(b,c);break;case 3:d=a.rcr32(b,c);break;case 4:d=a.shl32(b,c);break;case 5:d=a.shr32(b,c);break;case 6:d=a.shl32(b,c);break;case 7:d=a.sar32(b,c)}a.write_e32(d)};t[212]=function(a){a.bcd_aam(a.read_op8())};t[213]=function(a){a.bcd_aad(a.read_op8())};t[214]=function(a){a.reg8[reg_al]=-a.getcf()};
t[215]=function(a){a.is_asize_32()?a.reg8[reg_al]=a.safe_read8(a.get_seg_prefix(reg_ds)+a.reg32s[reg_ebx]+a.reg8[reg_al]|0):a.reg8[reg_al]=a.safe_read8(a.get_seg_prefix(reg_ds)+(a.reg16[reg_bx]+a.reg8[reg_al]&65535)|0)};t[216]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_D8_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_D8_reg(a.modrm_byte)};
t[217]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_D9_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_D9_reg(a.modrm_byte)};t[218]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DA_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DA_reg(a.modrm_byte)};t[219]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DB_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DB_reg(a.modrm_byte)};
t[220]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DC_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DC_reg(a.modrm_byte)};t[221]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DD_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DD_reg(a.modrm_byte)};t[222]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DE_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DE_reg(a.modrm_byte)};
t[223]=function(a){a.read_modrm_byte();a.task_switch_test();192>a.modrm_byte?a.fpu.op_DF_mem(a.modrm_byte,a.modrm_resolve(a.modrm_byte)):a.fpu.op_DF_reg(a.modrm_byte)};t[224]=function(a){a.loopne(a.read_op8s())};t[225]=function(a){a.loope(a.read_op8s())};t[226]=function(a){a.loop(a.read_op8s())};t[227]=function(a){a.jcxz(a.read_op8s())};t[228]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,1);a.reg8[reg_al]=a.io.port_read8(b);a.diverged()};
t16[229]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,2);a.reg16[reg_ax]=a.io.port_read16(b);a.diverged()};t32[229]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,4);a.reg32s[reg_eax]=a.io.port_read32(b);a.diverged()};t[230]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,1);a.io.port_write8(b,a.reg8[reg_al]);a.diverged()};t16[231]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,2);a.io.port_write16(b,a.reg16[reg_ax]);a.diverged()};
t32[231]=function(a){var b=a.read_op8();a.test_privileges_for_io(b,4);a.io.port_write32(b,a.reg32s[reg_eax]);a.diverged()};t16[232]=function(a){var b=a.read_op16();a.push16(a.get_real_eip());a.jmp_rel16(b);a.diverged()};t32[232]=function(a){var b=a.read_op32s();a.push32(a.get_real_eip());a.instruction_pointer=a.instruction_pointer+b|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t16[233]=function(a){var b=a.read_op16();a.jmp_rel16(b);a.diverged()};
t32[233]=function(a){var b=a.read_op32s();a.instruction_pointer=a.instruction_pointer+b|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t16[234]=function(a){var b=a.read_op16(),c=a.read_disp16();a.far_jump(b,c,!1);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t32[234]=function(a){var b=a.read_op32s(),c=a.read_disp16();a.far_jump(b,c,!1);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};
t[235]=function(a){var b=a.read_op8s();a.instruction_pointer=a.instruction_pointer+b|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged()};t[236]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,1);a.reg8[reg_al]=a.io.port_read8(b);a.diverged()};t16[237]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,2);a.reg16[reg_ax]=a.io.port_read16(b);a.diverged()};
t32[237]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,4);a.reg32s[reg_eax]=a.io.port_read32(b);a.diverged()};t[238]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,1);a.io.port_write8(b,a.reg8[reg_al]);a.diverged()};t16[239]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,2);a.io.port_write16(b,a.reg16[reg_ax]);a.diverged()};t32[239]=function(a){var b=a.reg16[reg_dx];a.test_privileges_for_io(b,4);a.io.port_write32(b,a.reg32s[reg_eax]);a.diverged()};
t[240]=function(a){a.run_prefix_instruction()};t[241]=function(a){throw a.debug.unimpl("int1 instruction");};t[242]=function(a){dbg_assert(0===(a.prefixes&PREFIX_MASK_REP));a.prefixes|=PREFIX_REPNZ;a.run_prefix_instruction();a.prefixes=0};t[243]=function(a){dbg_assert(0===(a.prefixes&PREFIX_MASK_REP));a.prefixes|=PREFIX_REPZ;a.run_prefix_instruction();a.prefixes=0};t[244]=function(a){a.hlt_op()};t[245]=function(a){a.flags=(a.flags|1)^a.getcf();a.flags_changed&=-2};
t[246]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:var b=a.read_e8();a.test8(b,a.read_op8());break;case 1:b=a.read_e8();a.test8(b,a.read_op8());break;case 2:b=a.read_write_e8();a.write_e8(~b);break;case 3:b=a.read_write_e8();a.write_e8(a.neg8(b));break;case 4:b=a.read_e8();a.mul8(b);break;case 5:b=a.read_e8s();a.imul8(b);break;case 6:b=a.read_e8();a.div8(b);break;case 7:b=a.read_e8s(),a.idiv8(b)}};
t16[247]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:var b=a.read_e16();a.test16(b,a.read_op16());break;case 1:b=a.read_e16();a.test16(b,a.read_op16());break;case 2:b=a.read_write_e16();a.write_e16(~b);break;case 3:b=a.read_write_e16();a.write_e16(a.neg16(b));break;case 4:b=a.read_e16();a.mul16(b);break;case 5:b=a.read_e16s();a.imul16(b);break;case 6:b=a.read_e16();a.div16(b);break;case 7:b=a.read_e16s(),a.idiv16(b)}};
t32[247]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:var b=a.read_e32s();a.test32(b,a.read_op32s());break;case 1:b=a.read_e32s();a.test32(b,a.read_op32s());break;case 2:b=a.read_write_e32();a.write_e32(~b);break;case 3:b=a.read_write_e32();a.write_e32(a.neg32(b));break;case 4:b=a.read_e32();a.mul32(b);break;case 5:b=a.read_e32s();a.imul32(b);break;case 6:b=a.read_e32();a.div32(b);break;case 7:b=a.read_e32s(),a.idiv32(b)}};
t[248]=function(a){a.flags&=~flag_carry;a.flags_changed&=-2};t[249]=function(a){a.flags|=flag_carry;a.flags_changed&=-2};t[250]=function(a){!a.protected_mode||(a.flags&flag_vm?3===a.getiopl():a.getiopl()>=a.cpl)?a.flags&=~flag_interrupt:(dbg_log("cli #gp",LOG_CPU),a.trigger_gp(0))};t[251]=function(a){!a.protected_mode||(a.flags&flag_vm?3===a.getiopl():a.getiopl()>=a.cpl)?(a.flags|=flag_interrupt,a.clear_prefixes(),a.cycle_internal(),a.handle_irqs()):(dbg_log("sti #gp",LOG_CPU),a.trigger_gp(0))};
t[252]=function(a){a.flags&=~flag_direction};t[253]=function(a){a.flags|=flag_direction};t[254]=function(a){a.read_modrm_byte();var b=a.modrm_byte&56;0===b?(b=a.read_write_e8(),a.write_e8(a.inc8(b))):8===b?(b=a.read_write_e8(),a.write_e8(a.dec8(b))):a.todo()};
t16[255]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:var b=a.read_write_e16();a.write_e16(a.inc16(b));break;case 1:b=a.read_write_e16();a.write_e16(a.dec16(b));break;case 2:b=a.read_e16();a.push16(a.get_real_eip());a.instruction_pointer=a.get_seg(reg_cs)+b|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged();break;case 3:192<=a.modrm_byte&&(dbg_log("callf #ud",LOG_CPU),a.trigger_ud(),dbg_assert(!1,"unreachable"));var c=a.modrm_resolve(a.modrm_byte);b=a.safe_read16(c);
c=a.safe_read16(c+2|0);a.far_jump(b,c,!0);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged();break;case 4:b=a.read_e16();a.instruction_pointer=a.get_seg(reg_cs)+b|0;dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged();break;case 5:192<=a.modrm_byte&&(dbg_log("jmpf #ud",LOG_CPU),a.trigger_ud(),dbg_assert(!1,"unreachable"));c=a.modrm_resolve(a.modrm_byte);b=a.safe_read16(c);c=a.safe_read16(c+2|0);a.far_jump(b,c,!1);dbg_assert(a.is_asize_32()||65536>a.get_real_eip());a.diverged();
break;case 6:b=a.read_e16();a.push16(b);break;case 7:a.todo()}};
t32[255]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 0:var b=a.read_write_e32();a.write_e32(a.inc32(b));break;case 1:b=a.read_write_e32();a.write_e32(a.dec32(b));break;case 2:b=a.read_e32s();a.push32(a.get_real_eip());dbg_assert(a.is_asize_32()||65536>b);a.instruction_pointer=a.get_seg(reg_cs)+b|0;a.diverged();break;case 3:192<=a.modrm_byte&&(dbg_log("callf #ud",LOG_CPU),a.trigger_ud(),dbg_assert(!1,"unreachable"));var c=a.modrm_resolve(a.modrm_byte);b=a.safe_read32s(c);c=a.safe_read16(c+
4|0);if((!a.protected_mode||a.vm86_mode())&&b&4294901760)throw a.debug.unimpl("#GP handler");a.far_jump(b,c,!0);dbg_assert(a.is_asize_32()||65536>b);a.diverged();break;case 4:b=a.read_e32s();dbg_assert(a.is_asize_32()||65536>b);a.instruction_pointer=a.get_seg(reg_cs)+b|0;a.diverged();break;case 5:192<=a.modrm_byte&&(dbg_log("jmpf #ud",LOG_CPU),a.trigger_ud(),dbg_assert(!1,"unreachable"));c=a.modrm_resolve(a.modrm_byte);b=a.safe_read32s(c);c=a.safe_read16(c+4|0);if((!a.protected_mode||a.vm86_mode())&&
b&4294901760)throw a.debug.unimpl("#GP handler");a.far_jump(b,c,!1);dbg_assert(a.is_asize_32()||65536>b);a.diverged();break;case 6:b=a.read_e32s();a.push32(b);break;case 7:a.todo()}};var table16=[],table32=[];CPU.prototype.table16=table16;CPU.prototype.table32=table32;for(var i=0;256>i;i++)t[i]?table16[i]=table32[i]=t[i]:t16[i]&&(table16[i]=t16[i],table32[i]=t32[i]);t=[];t16=[];t32=[];
t[0]=function(a){a.read_modrm_byte();if(!a.protected_mode||a.vm86_mode())dbg_log("0f 00 #ud",LOG_CPU),a.trigger_ud();switch(a.modrm_byte>>3&7){case 0:a.set_e16(a.sreg[reg_ldtr]);a.is_osize_32()&&192<=a.modrm_byte&&(a.reg32s[a.modrm_byte&7]&=65535);break;case 1:a.set_e16(a.sreg[reg_tr]);a.is_osize_32()&&192<=a.modrm_byte&&(a.reg32s[a.modrm_byte&7]&=65535);break;case 2:a.cpl&&a.trigger_gp(0);var b=a.read_e16();a.load_ldt(b);break;case 3:a.cpl&&a.trigger_gp(0);b=a.read_e16();a.load_tr(b);break;case 4:a.verr(a.read_e16());
break;case 5:a.verw(a.read_e16());break;default:dbg_log(a.modrm_byte>>3&7,LOG_CPU),a.todo()}};
t[1]=function(a){a.read_modrm_byte();var b=a.modrm_byte>>3&7;if(4===b)192<=a.modrm_byte&&a.is_osize_32()?a.set_e32(a.cr[0]):a.set_e16(a.cr[0]);else if(6===b){a.cpl&&a.trigger_gp(0);var c=a.read_e16();c=a.cr[0]&-16|c&15;a.protected_mode&&(c|=CR0_PE);a.set_cr0(c)}else switch(192<=a.modrm_byte&&(dbg_log("0f 01 #ud",LOG_CPU),a.trigger_ud()),c=a.modrm_resolve(a.modrm_byte),b){case 0:a.writable_or_pagefault(c,6);a.safe_write16(c,a.gdtr_size);b=a.is_osize_32()?-1:16777215;a.safe_write32(c+2,a.gdtr_offset&
b);break;case 1:a.writable_or_pagefault(c,6);a.safe_write16(c,a.idtr_size);b=a.is_osize_32()?-1:16777215;a.safe_write32(c+2,a.idtr_offset&b);break;case 2:a.cpl&&a.trigger_gp(0);b=a.safe_read16(c);c=a.safe_read32s(c+2);a.gdtr_size=b;a.gdtr_offset=c;a.is_osize_32()||(a.gdtr_offset&=16777215);break;case 3:a.cpl&&a.trigger_gp(0);b=a.safe_read16(c);c=a.safe_read32s(c+2);a.idtr_size=b;a.idtr_offset=c;a.is_osize_32()||(a.idtr_offset&=16777215);break;case 7:a.cpl&&a.trigger_gp(0);a.invlpg(c);break;default:dbg_log(b),
a.todo()}};t16[2]=function(a){a.read_modrm_byte();if(!a.protected_mode||a.vm86_mode())dbg_log("lar #ud",LOG_CPU),a.trigger_ud();var b=a.read_e16();a.write_g16(a.lar(b,a.read_g16()))};t32[2]=function(a){a.read_modrm_byte();if(!a.protected_mode||a.vm86_mode())dbg_log("lar #ud",LOG_CPU),a.trigger_ud();var b=a.read_e16();a.write_g32(a.lar(b,a.read_g32s()))};
t16[3]=function(a){a.read_modrm_byte();if(!a.protected_mode||a.vm86_mode())dbg_log("lsl #ud",LOG_CPU),a.trigger_ud();var b=a.read_e16();a.write_g16(a.lsl(b,a.read_g16()))};t32[3]=function(a){a.read_modrm_byte();if(!a.protected_mode||a.vm86_mode())dbg_log("lsl #ud",LOG_CPU),a.trigger_ud();var b=a.read_e16();a.write_g32(a.lsl(b,a.read_g32s()))};t[4]=function(a){a.undefined_instruction()};t[5]=function(a){a.undefined_instruction()};
t[6]=function(a){a.cpl?(dbg_log("clts #gp",LOG_CPU),a.trigger_gp(0)):a.cr[0]&=~CR0_TS};t[7]=function(a){a.undefined_instruction()};t[8]=function(a){a.todo()};t[9]=function(a){a.cpl&&(dbg_log("wbinvd #gp",LOG_CPU),a.trigger_gp(0))};t[10]=function(a){a.undefined_instruction()};t[11]=function(a){a.trigger_ud()};t[12]=function(a){a.undefined_instruction()};t[13]=function(a){a.todo()};t[14]=function(a){a.undefined_instruction()};t[15]=function(a){a.undefined_instruction()};t[16]=function(a){a.unimplemented_sse()};
t[17]=function(a){a.unimplemented_sse()};t[18]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm_mem64s();a.write_xmm64(b[0],b[1])};t[19]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm64s();dbg_assert(192>a.modrm_byte);var c=a.modrm_resolve(a.modrm_byte);a.safe_write64(c,b[0],b[1])};
t[20]=function(a){a.unimplemented_sse()};t[21]=function(a){a.unimplemented_sse()};t[22]=function(a){a.unimplemented_sse()};t[23]=function(a){a.unimplemented_sse()};t[24]=function(a){a.read_modrm_byte();192>a.modrm_byte&&a.modrm_resolve(a.modrm_byte)};t[25]=function(a){a.unimplemented_sse()};t[26]=function(a){a.unimplemented_sse()};t[27]=function(a){a.unimplemented_sse()};t[28]=function(a){a.unimplemented_sse()};t[29]=function(a){a.unimplemented_sse()};t[30]=function(a){a.unimplemented_sse()};
t[31]=function(a){a.read_modrm_byte();192>a.modrm_byte&&a.modrm_resolve(a.modrm_byte)};t[32]=function(a){a.read_modrm_byte();a.cpl&&a.trigger_gp(0);switch(a.modrm_byte>>3&7){case 0:a.write_reg_e32(a.cr[0]);break;case 2:a.write_reg_e32(a.cr[2]);break;case 3:a.write_reg_e32(a.cr[3]);break;case 4:a.write_reg_e32(a.cr[4]);break;default:dbg_log(a.modrm_byte>>3&7),dbg_assert(!1),a.trigger_ud()}};
t[33]=function(a){a.read_modrm_byte();a.cpl&&a.trigger_gp(0);var b=a.modrm_byte>>3&7;a.cr[4]&CR4_DE&&(4===b||5===b)&&(dbg_log("#ud mov dreg 4/5 with cr4.DE set",LOG_CPU),a.trigger_ud());a.reg32s[a.modrm_byte&7]=a.dreg[b]};
t[34]=function(a){a.read_modrm_byte();a.cpl&&a.trigger_gp(0);var b=a.read_reg_e32s();switch(a.modrm_byte>>3&7){case 0:a.set_cr0(b);break;case 2:a.cr[2]=b;break;case 3:b&=-4072;dbg_assert(0===(b&4095),"TODO");a.cr[3]=b;a.clear_tlb();break;case 4:a.set_cr4(b);break;default:dbg_log(a.modrm_byte>>3&7),dbg_assert(!1),a.trigger_ud()}};
t[35]=function(a){a.read_modrm_byte();a.cpl&&a.trigger_gp(0);var b=a.modrm_byte>>3&7;a.cr[4]&CR4_DE&&(4===b||5===b)&&(dbg_log("#ud mov dreg 4/5 with cr4.DE set",LOG_CPU),a.trigger_ud());a.dreg[b]=a.read_reg_e32s()};t[36]=function(a){a.undefined_instruction()};t[37]=function(a){a.undefined_instruction()};t[38]=function(a){a.undefined_instruction()};t[39]=function(a){a.undefined_instruction()};
t[40]=function(a){dbg_assert(0===(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm_mem128s();a.write_xmm128s(b[0],b[1],b[2],b[3])};
t[41]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var b=a.read_xmm128s();dbg_assert(192>a.modrm_byte);var c=a.modrm_resolve(a.modrm_byte);a.safe_write128(c,b[0],b[1],b[2],b[3])}else dbg_assert(0===(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_xmm128s(),dbg_assert(192>a.modrm_byte),c=a.modrm_resolve(a.modrm_byte),a.safe_write128(c,b[0],b[1],b[2],b[3])};t[42]=function(a){a.unimplemented_sse()};
t[43]=function(a){a.unimplemented_sse()};t[44]=function(a){a.unimplemented_sse()};t[45]=function(a){a.unimplemented_sse()};t[46]=function(a){a.unimplemented_sse()};t[47]=function(a){a.unimplemented_sse()};
t[48]=function(a){a.cpl&&a.trigger_gp(0);var b=a.reg32s[reg_ecx],c=a.reg32s[reg_eax],d=a.reg32s[reg_edx];b!==IA32_SYSENTER_ESP&&dbg_log("wrmsr ecx="+h(b>>>0,8)+" data="+h(d>>>0,8)+":"+h(c>>>0,8),LOG_CPU);switch(b){case IA32_SYSENTER_CS:a.sysenter_cs=c&65535;break;case IA32_SYSENTER_EIP:a.sysenter_eip=c;break;case IA32_SYSENTER_ESP:a.sysenter_esp=c;break;case IA32_APIC_BASE_MSR:dbg_assert(0===d,"Changing APIC address (high 32 bits) not supported");dbg_assert((c&~(IA32_APIC_BASE_BSP|IA32_APIC_BASE_EXTD|
IA32_APIC_BASE_EN))>>>0===APIC_ADDRESS,"Changing APIC address not supported");dbg_assert(0===(c&IA32_APIC_BASE_EXTD),"x2apic not supported");a.apic_enabled=(c&IA32_APIC_BASE_EN)===IA32_APIC_BASE_EN;break;case IA32_TIME_STAMP_COUNTER:b=(c>>>0)+4294967296*(d>>>0);a.tsc_offset=v86.microtick()-b/TSC_RATE;break;case IA32_BIOS_SIGN_ID:break;case IA32_MISC_ENABLE:dbg_log("IA32_MISC_ENABLE="+h(c>>>0,8),LOG_CPU);break;case IA32_MCG_CAP:break;case IA32_KERNEL_GS_BASE:dbg_log("GS Base written",LOG_CPU);break;
default:dbg_assert(!1,"Unknown msr: "+h(b>>>0,8))}};t[49]=function(a){if(a.cpl&&a.cr[4]&CR4_TSD)a.trigger_gp(0);else{var b=v86.microtick()-a.tsc_offset;dbg_assert(isFinite(b),"non-finite tsc: "+b);a.reg32s[reg_eax]=b*TSC_RATE;a.reg32s[reg_edx]=TSC_RATE/4294967296*b}};
t[50]=function(a){a.cpl&&a.trigger_gp(0);var b=a.reg32s[reg_ecx];dbg_log("rdmsr ecx="+h(b>>>0,8),LOG_CPU);var c=0,d=0;switch(b){case IA32_SYSENTER_CS:c=a.sysenter_cs;break;case IA32_SYSENTER_EIP:c=a.sysenter_eip;break;case IA32_SYSENTER_ESP:c=a.sysenter_esp;break;case IA32_TIME_STAMP_COUNTER:b=v86.microtick()-a.tsc_offset;c=b*TSC_RATE;d=TSC_RATE/4294967296*b;break;case IA32_PLATFORM_ID:break;case IA32_APIC_BASE_MSR:ENABLE_ACPI&&(c=APIC_ADDRESS,a.apic_enabled&&(c|=IA32_APIC_BASE_EN));break;case IA32_BIOS_SIGN_ID:break;
case IA32_MISC_ENABLE:break;case IA32_RTIT_CTL:break;case MSR_SMI_COUNT:break;case IA32_MCG_CAP:break;case MSR_PKG_C2_RESIDENCY:break;case MSR_EBC_FREQUENCY_ID:c=16777216;break;default:dbg_assert(!1,"Unknown msr: "+h(b>>>0,8))}a.reg32s[reg_eax]=c;a.reg32s[reg_edx]=d};t[51]=function(a){a.todo()};
t[52]=function(a){var b=a.sysenter_cs&65532;a.protected_mode&&0!==b||a.trigger_gp(0);a.flags=a.flags&~flag_vm&~flag_interrupt;a.instruction_pointer=a.sysenter_eip;a.reg32s[reg_esp]=a.sysenter_esp;a.sreg[reg_cs]=b;a.segment_is_null[reg_cs]=0;a.segment_limits[reg_cs]=-1;a.segment_offsets[reg_cs]=0;a.update_cs_size(!0);a.cpl=0;a.cpl_changed();a.sreg[reg_ss]=b+8;a.segment_is_null[reg_ss]=0;a.segment_limits[reg_ss]=-1;a.segment_offsets[reg_ss]=0;a.stack_size_32=!0;a.diverged()};
t[53]=function(a){var b=a.sysenter_cs&65532;a.protected_mode&&!a.cpl&&0!==b||a.trigger_gp(0);a.instruction_pointer=a.reg32s[reg_edx];a.reg32s[reg_esp]=a.reg32s[reg_ecx];a.sreg[reg_cs]=b+16|3;a.segment_is_null[reg_cs]=0;a.segment_limits[reg_cs]=-1;a.segment_offsets[reg_cs]=0;a.update_cs_size(!0);a.cpl=3;a.cpl_changed();a.sreg[reg_ss]=b+24|3;a.segment_is_null[reg_ss]=0;a.segment_limits[reg_ss]=-1;a.segment_offsets[reg_ss]=0;a.stack_size_32=!0;a.diverged()};t[54]=function(a){a.undefined_instruction()};
t[55]=function(a){a.todo()};t[56]=function(a){a.unimplemented_sse()};t[57]=function(a){a.unimplemented_sse()};t[58]=function(a){a.unimplemented_sse()};t[59]=function(a){a.unimplemented_sse()};t[60]=function(a){a.unimplemented_sse()};t[61]=function(a){a.unimplemented_sse()};t[62]=function(a){a.unimplemented_sse()};t[63]=function(a){a.unimplemented_sse()};t16[64]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_o())};t32[64]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_o())};
t16[65]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_o())};t32[65]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_o())};t16[66]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_b())};t32[66]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_b())};t16[67]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_b())};t32[67]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_b())};t16[68]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_z())};t32[68]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_z())};
t16[69]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_z())};t32[69]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_z())};t16[70]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_be())};t32[70]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_be())};t16[71]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_be())};t32[71]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_be())};t16[72]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_s())};t32[72]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_s())};
t16[73]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_s())};t32[73]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_s())};t16[74]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_p())};t32[74]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_p())};t16[75]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_p())};t32[75]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_p())};t16[76]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_l())};t32[76]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_l())};
t16[77]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_l())};t32[77]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_l())};t16[78]=function(a){a.read_modrm_byte();a.cmovcc16(a.test_le())};t32[78]=function(a){a.read_modrm_byte();a.cmovcc32(a.test_le())};t16[79]=function(a){a.read_modrm_byte();a.cmovcc16(!a.test_le())};t32[79]=function(a){a.read_modrm_byte();a.cmovcc32(!a.test_le())};t[80]=function(a){a.unimplemented_sse()};t[81]=function(a){a.unimplemented_sse()};t[82]=function(a){a.unimplemented_sse()};
t[83]=function(a){a.unimplemented_sse()};t[84]=function(a){a.unimplemented_sse()};t[85]=function(a){a.unimplemented_sse()};t[86]=function(a){a.unimplemented_sse()};t[87]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm_mem128s(),c=a.read_xmm128s();a.write_xmm128s(b[0]^c[0],b[1]^c[1],b[2]^c[2],b[3]^c[3])};t[88]=function(a){a.unimplemented_sse()};t[89]=function(a){a.unimplemented_sse()};t[90]=function(a){a.unimplemented_sse()};t[91]=function(a){a.unimplemented_sse()};
t[92]=function(a){a.unimplemented_sse()};t[93]=function(a){a.unimplemented_sse()};t[94]=function(a){a.unimplemented_sse()};t[95]=function(a){a.unimplemented_sse()};
t[96]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem64s();b=new Uint8Array(b.buffer);var c=a.read_xmm64s();c=new Uint8Array(c.buffer);a.write_xmm128s(c[0]|b[0]<<8|c[1]<<16|b[1]<<24,c[2]|b[2]<<8|c[3]<<16|b[3]<<24,c[4]|b[4]<<8|c[5]<<16|b[5]<<24,c[6]|b[6]<<8|c[7]<<16|b[7]<<24)}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem32s(),c=a.reg_mmxs[2*(a.modrm_byte>>
3&7)],a.write_mmx64s(c&255|(b&255)<<8|(c>>8&255)<<16|(b>>8&255)<<24,c>>16&255|(b>>16&255)<<8|c>>>24<<16|b>>>24<<24)};
t[97]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem64s();b=new Uint16Array(b.buffer);var c=a.read_xmm64s();c=new Uint16Array(c.buffer);a.write_xmm128s(c[0]|b[0]<<16,c[1]|b[1]<<16,c[2]|b[2]<<16,c[3]|b[3]<<16)}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem32s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],a.write_mmx64s(c&65535|(b&65535)<<16,c>>>16|b>>>16<<16)};
t[98]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem32s();a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)],b)};
t[99]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];var e=0|a.saturate_sw_to_sb(c&65535);e|=a.saturate_sw_to_sb(c>>>16)<<8;e|=a.saturate_sw_to_sb(d&65535)<<16;e|=a.saturate_sw_to_sb(d>>>16)<<24;c=0|a.saturate_sw_to_sb(b[0]&65535);c|=a.saturate_sw_to_sb(b[0]>>>16)<<8;c|=a.saturate_sw_to_sb(b[1]&65535)<<16;c|=a.saturate_sw_to_sb(b[1]>>>
16)<<24;a.write_mmx64s(e,c)};t[100]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();b=new Int8Array(b.buffer);var c=8*(a.modrm_byte>>3&7),d=a.reg_mmx8s;a.write_mmx64s((d[c]>b[0]?255:0)|(d[c+1]>b[1]?255:0)<<8|(d[c+2]>b[2]?255:0)<<16|(d[c+3]>b[3]?255:0)<<24,(d[c+4]>b[4]?255:0)|(d[c+5]>b[5]?255:0)<<8|(d[c+6]>b[6]?255:0)<<16|(d[c+7]>b[7]?255:0)<<24)};
t[101]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s((c<<16>>16>b[0]<<16>>16?65535:0)|(c>>16>b[0]>>16?65535:0)<<16,(d<<16>>16>b[1]<<16>>16?65535:0)|(d>>16>b[1]>>16?65535:0)<<16)};
t[102]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)]>b[0]?-1:0,a.reg_mmxs[2*(a.modrm_byte>>3&7)+1]>b[1]?-1:0)};
t[103]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Int16Array(b.buffer);var c=a.read_xmm128s();c=new Int16Array(c.buffer);for(var d=a.create_atom128s(0,0,0,0),e=new Uint8Array(d.buffer),f=0;8>f;f++)e[f]=a.saturate_sw_to_ub(c[f]),e[f|8]=a.saturate_sw_to_ub(b[f]);a.write_xmm128s(d[0],d[1],d[2],d[3])}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),
d=a.reg_mmxs[2*(a.modrm_byte>>3&7)],e=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1],c=0|a.saturate_sw_to_ub(d&65535),c|=a.saturate_sw_to_ub(d>>>16)<<8,c|=a.saturate_sw_to_ub(e&65535)<<16,c|=a.saturate_sw_to_ub(e>>>16)<<24,d=0|a.saturate_sw_to_ub(b[0]&65535),d|=a.saturate_sw_to_ub(b[0]>>>16)<<8,d|=a.saturate_sw_to_ub(b[1]&65535)<<16,d|=a.saturate_sw_to_ub(b[1]>>>16)<<24,a.write_mmx64s(c,d)};
t[104]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);var c=a.read_xmm128s();c=new Uint8Array(c.buffer);a.write_xmm128s(c[8]|b[8]<<8|c[9]<<16|b[9]<<24,c[10]|b[10]<<8|c[11]<<16|b[11]<<24,c[12]|b[12]<<8|c[13]<<16|b[13]<<24,c[14]|b[14]<<8|c[15]<<16|b[15]<<24)}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*
(a.modrm_byte>>3&7)+1],a.write_mmx64s(c&255|(b[1]&255)<<8|(c>>8&255)<<16|(b[1]>>8&255)<<24,c>>16&255|(b[1]>>16&255)<<8|c>>>24<<16|b[1]>>>24<<24)};t[105]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s(c&65535|(b[1]&65535)<<16,c>>>16|b[1]>>>16<<16)};
t[106]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)+1],b[1])};
t[107]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];var d=0|a.saturate_sd_to_sw(a.reg_mmxs[2*(a.modrm_byte>>3&7)]);d|=a.saturate_sd_to_sw(c)<<16;c=0|a.saturate_sd_to_sw(b[0]);c|=a.saturate_sd_to_sw(b[1])<<16;a.write_mmx64s(d,c)};t[108]=function(a){a.unimplemented_sse()};t[109]=function(a){a.unimplemented_sse()};
t[110]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var b=a.read_e32s();a.write_xmm128s(b,0,0,0)}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_e32s(),a.write_mmx64s(b,0)};
t[111]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();a.write_xmm128s(b[0],b[1],b[2],b[3])}else(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_REPZ?(b=a.read_xmm_mem128s_unaligned(),a.write_xmm128s(b[0],b[1],b[2],b[3])):(dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),a.write_mmx64s(b[0],b[1]))};
t[112]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s(),c=a.read_op8();a.write_xmm128s(b[c&3],b[c>>2&3],b[c>>4&3],b[c>>6&3])}else if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_REPNZ){b=a.read_xmm_mem128s();c=new Uint16Array(b.buffer);var d=a.read_op8();a.write_xmm128s(c[d&3]|c[d>>2&3]<<16,c[d>>4&3]|c[d>>6&3]<<16,b[2],b[3])}else if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===
PREFIX_REPZ)b=a.read_xmm_mem128s(),c=new Uint16Array(b.buffer),d=a.read_op8(),a.write_xmm128s(b[0],b[1],c[d&3|4]|c[d>>2&3|4]<<16,c[d>>4&3|4]|c[d>>6&3|4]<<16);else{dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));b=a.read_mmx_mem64s();var e=a.read_op8();c=e&3;d=e>>2&3;var f=e>>4&3;e>>>=6;a.write_mmx64s(b[c>>1]>>>16*(c&1)&65535|b[d>>1]>>>16*(d&1)<<16,b[f>>1]>>>16*(f&1)&65535|b[e>>1]>>>16*(e&1)<<16)}};
t[113]=function(a){a.read_modrm_byte();dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();192>a.modrm_byte&&a.trigger_ud();switch(a.modrm_byte>>3&7){case 2:var b=a.read_op8(),c=a.modrm_byte&7,d=a.reg_mmxs[2*c],e=a.reg_mmxs[2*c+1],f=0,g=0;15>=b&&(f=(d&65535)>>>b|d>>>16>>>b<<16,g=(e&65535)>>>b|e>>>16>>>b<<16);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;case 4:b=a.read_op8();c=a.modrm_byte&7;d=a.reg_mmxs[2*c];e=a.reg_mmxs[2*c+1];15<b&&(b=16);a.reg_mmxs[2*c]=d<<
16>>16>>b&65535|(d>>16>>b&65535)<<16;a.reg_mmxs[2*c+1]=e<<16>>16>>b&65535|(e>>16>>b&65535)<<16;break;case 6:b=a.read_op8();c=a.modrm_byte&7;d=a.reg_mmxs[2*c];e=a.reg_mmxs[2*c+1];g=f=0;15>=b&&(f=(d&65535)<<b&65535|d>>>16<<b<<16,g=(e&65535)<<b&65535|e>>>16<<b<<16);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;default:a.unimplemented_sse()}};
t[114]=function(a){a.read_modrm_byte();dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();192>a.modrm_byte&&a.trigger_ud();switch(a.modrm_byte>>3&7){case 2:var b=a.read_op8(),c=a.modrm_byte&7,d=a.reg_mmxs[2*c],e=a.reg_mmxs[2*c+1],f=0,g=0;31>=b&&(f=d>>>b,g=e>>>b);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;case 4:b=a.read_op8();c=a.modrm_byte&7;d=a.reg_mmxs[2*c];e=a.reg_mmxs[2*c+1];31<b&&(b=31);a.reg_mmxs[2*c]=d>>b;a.reg_mmxs[2*c+1]=e>>b;break;case 6:b=a.read_op8();
c=a.modrm_byte&7;d=a.reg_mmxs[2*c];e=a.reg_mmxs[2*c+1];g=f=0;31>=b&&(f=d<<b,g=e<<b);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;default:a.unimplemented_sse()}};
t[115]=function(a){a.read_modrm_byte();dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();192>a.modrm_byte&&a.trigger_ud();switch(a.modrm_byte>>3&7){case 2:var b=a.read_op8(),c=a.modrm_byte&7,d=a.reg_mmxs[2*c],e=a.reg_mmxs[2*c+1],f=0,g=0;31>=b?(f=d>>>b|e<<32-b,g=e>>>b):63>=b&&(f=e>>>(b&31),g=0);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;case 6:b=a.read_op8();c=a.modrm_byte&7;d=a.reg_mmxs[2*c];e=a.reg_mmxs[2*c+1];g=f=0;31>=b?(f=d<<b,g=e<<b|d>>>32-b):63>=b&&(g=
d<<(b&31),f=0);a.reg_mmxs[2*c]=f;a.reg_mmxs[2*c+1]=g;break;default:a.unimplemented_sse()}};
t[116]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);var c=a.read_xmm128s();c=new Uint8Array(c.buffer);for(var d=a.create_atom128s(0,0,0,0),e=new Uint8Array(d.buffer),f=0;16>f;f++)e[f]=b[f]===c[f]?255:0;a.write_xmm128s(d[0],d[1],d[2],d[3])}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),b=new Int8Array(b.buffer),c=8*
(a.modrm_byte>>3&7),d=a.reg_mmx8s,a.write_mmx64s((d[c]===b[0]?255:0)|(d[c+1]===b[1]?255:0)<<8|(d[c+2]===b[2]?255:0)<<16|(d[c+3]===b[3]?255:0)<<24,(d[c+4]===b[4]?255:0)|(d[c+5]===b[5]?255:0)<<8|(d[c+6]===b[6]?255:0)<<16|(d[c+7]===b[7]?255:0)<<24)};
t[117]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s(((c&65535)===(b[0]&65535)?65535:0)|((c&4294901760)===(b[0]&4294901760)?65535:0)<<16,((d&65535)===(b[1]&65535)?65535:0)|((d&4294901760)===(b[1]&4294901760)?65535:0)<<16)};
t[118]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s(),c=a.read_xmm128s();a.write_xmm128s(b[0]===c[0]?-1:0,b[1]===c[1]?-1:0,b[2]===c[2]?-1:0,b[3]===c[3]?-1:0)}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)]===b[0]?-1:0,a.reg_mmxs[2*(a.modrm_byte>>3&7)+1]===b[1]?-1:0)};
t[119]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.fpu.stack_empty=255};t[120]=function(a){a.unimplemented_sse()};t[121]=function(a){a.unimplemented_sse()};t[122]=function(a){a.unimplemented_sse()};t[123]=function(a){a.unimplemented_sse()};t[124]=function(a){a.unimplemented_sse()};t[125]=function(a){a.unimplemented_sse()};
t[126]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_REPZ){var b=a.read_xmm_mem64s();a.write_xmm128s(b[0],b[1],0,0)}else(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE?(b=a.read_xmm64s(),a.set_e32(b[0])):(dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx64s(),a.set_e32(b[0]))};
t[127]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_REPZ){var b=a.read_xmm128s();dbg_assert(192>a.modrm_byte);var c=a.modrm_resolve(a.modrm_byte);a.safe_write128(c,b[0],b[1],b[2],b[3])}else(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE?(b=a.read_xmm128s(),dbg_assert(192>a.modrm_byte),c=a.modrm_resolve(a.modrm_byte),a.safe_write128(c,b[0],b[1],b[2],b[3])):(dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),
b=a.read_mmx64s(),a.set_mmx_mem64s(b[0],b[1]))};t16[128]=function(a){a.jmpcc16(a.test_o())};t32[128]=function(a){a.jmpcc32(a.test_o())};t16[129]=function(a){a.jmpcc16(!a.test_o())};t32[129]=function(a){a.jmpcc32(!a.test_o())};t16[130]=function(a){a.jmpcc16(a.test_b())};t32[130]=function(a){a.jmpcc32(a.test_b())};t16[131]=function(a){a.jmpcc16(!a.test_b())};t32[131]=function(a){a.jmpcc32(!a.test_b())};t16[132]=function(a){a.jmpcc16(a.test_z())};t32[132]=function(a){a.jmpcc32(a.test_z())};
t16[133]=function(a){a.jmpcc16(!a.test_z())};t32[133]=function(a){a.jmpcc32(!a.test_z())};t16[134]=function(a){a.jmpcc16(a.test_be())};t32[134]=function(a){a.jmpcc32(a.test_be())};t16[135]=function(a){a.jmpcc16(!a.test_be())};t32[135]=function(a){a.jmpcc32(!a.test_be())};t16[136]=function(a){a.jmpcc16(a.test_s())};t32[136]=function(a){a.jmpcc32(a.test_s())};t16[137]=function(a){a.jmpcc16(!a.test_s())};t32[137]=function(a){a.jmpcc32(!a.test_s())};t16[138]=function(a){a.jmpcc16(a.test_p())};
t32[138]=function(a){a.jmpcc32(a.test_p())};t16[139]=function(a){a.jmpcc16(!a.test_p())};t32[139]=function(a){a.jmpcc32(!a.test_p())};t16[140]=function(a){a.jmpcc16(a.test_l())};t32[140]=function(a){a.jmpcc32(a.test_l())};t16[141]=function(a){a.jmpcc16(!a.test_l())};t32[141]=function(a){a.jmpcc32(!a.test_l())};t16[142]=function(a){a.jmpcc16(a.test_le())};t32[142]=function(a){a.jmpcc32(a.test_le())};t16[143]=function(a){a.jmpcc16(!a.test_le())};t32[143]=function(a){a.jmpcc32(!a.test_le())};
t[144]=function(a){a.read_modrm_byte();a.setcc(a.test_o())};t[145]=function(a){a.read_modrm_byte();a.setcc(!a.test_o())};t[146]=function(a){a.read_modrm_byte();a.setcc(a.test_b())};t[147]=function(a){a.read_modrm_byte();a.setcc(!a.test_b())};t[148]=function(a){a.read_modrm_byte();a.setcc(a.test_z())};t[149]=function(a){a.read_modrm_byte();a.setcc(!a.test_z())};t[150]=function(a){a.read_modrm_byte();a.setcc(a.test_be())};t[151]=function(a){a.read_modrm_byte();a.setcc(!a.test_be())};
t[152]=function(a){a.read_modrm_byte();a.setcc(a.test_s())};t[153]=function(a){a.read_modrm_byte();a.setcc(!a.test_s())};t[154]=function(a){a.read_modrm_byte();a.setcc(a.test_p())};t[155]=function(a){a.read_modrm_byte();a.setcc(!a.test_p())};t[156]=function(a){a.read_modrm_byte();a.setcc(a.test_l())};t[157]=function(a){a.read_modrm_byte();a.setcc(!a.test_l())};t[158]=function(a){a.read_modrm_byte();a.setcc(a.test_le())};t[159]=function(a){a.read_modrm_byte();a.setcc(!a.test_le())};t16[160]=function(a){a.push16(a.sreg[reg_fs])};
t32[160]=function(a){a.push32(a.sreg[reg_fs])};t16[161]=function(a){a.switch_seg(reg_fs,a.safe_read16(a.get_stack_pointer(0)));a.adjust_stack_reg(2)};t32[161]=function(a){a.switch_seg(reg_fs,a.safe_read32s(a.get_stack_pointer(0))&65535);a.adjust_stack_reg(4)};t[162]=function(a){a.cpuid()};t16[163]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.bt_mem(a.modrm_resolve(a.modrm_byte),a.read_g16s()):a.bt_reg(a.read_reg_e16(),a.read_g16()&15)};
t32[163]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.bt_mem(a.modrm_resolve(a.modrm_byte),a.read_g32s()):a.bt_reg(a.read_reg_e32s(),a.read_g32s()&31)};t16[164]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.shld16(b,a.read_g16(),a.read_op8()&31))};t32[164]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.shld32(b,a.read_g32s(),a.read_op8()&31))};
t16[165]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.shld16(b,a.read_g16(),a.reg8[reg_cl]&31))};t32[165]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.shld32(b,a.read_g32s(),a.reg8[reg_cl]&31))};t[166]=function(a){a.trigger_ud()};t[167]=function(a){a.undefined_instruction()};t16[168]=function(a){a.push16(a.sreg[reg_gs])};t32[168]=function(a){a.push32(a.sreg[reg_gs])};
t16[169]=function(a){a.switch_seg(reg_gs,a.safe_read16(a.get_stack_pointer(0)));a.adjust_stack_reg(2)};t32[169]=function(a){a.switch_seg(reg_gs,a.safe_read32s(a.get_stack_pointer(0))&65535);a.adjust_stack_reg(4)};t[170]=function(a){a.todo()};t16[171]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.bts_mem(a.modrm_resolve(a.modrm_byte),a.read_g16s()):a.write_reg_e16(a.bts_reg(a.read_reg_e16(),a.read_g16s()&15))};
t32[171]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.bts_mem(a.modrm_resolve(a.modrm_byte),a.read_g32s()):a.write_reg_e32(a.bts_reg(a.read_reg_e32s(),a.read_g32s()&31))};t16[172]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.shrd16(b,a.read_g16(),a.read_op8()&31))};t32[172]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.shrd32(b,a.read_g32s(),a.read_op8()&31))};
t16[173]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.shrd16(b,a.read_g16(),a.reg8[reg_cl]&31))};t32[173]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.shrd32(b,a.read_g32s(),a.reg8[reg_cl]&31))};
t[174]=function(a){a.read_modrm_byte();a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)&&a.todo();switch(a.modrm_byte>>3&7){case 0:192<=a.modrm_byte&&a.trigger_ud();var b=a.modrm_resolve(a.modrm_byte);a.fxsave(b);break;case 1:192<=a.modrm_byte&&a.trigger_ud();b=a.modrm_resolve(a.modrm_byte);a.fxrstor(b);break;case 2:192<=a.modrm_byte&&a.trigger_ud();b=a.modrm_resolve(a.modrm_byte);b=a.safe_read32s(b);b&~MXCSR_MASK&&(dbg_log("Invalid mxcsr bits: "+h((b&~MXCSR_MASK)>>>0,8)),a.trigger_gp(0));a.mxcsr=
b;break;case 3:192<=a.modrm_byte&&a.trigger_ud();b=a.modrm_resolve(a.modrm_byte);a.safe_write32(b,a.mxcsr);break;case 5:dbg_assert(192<=a.modrm_byte,"Unexpected lfence encoding");192>a.modrm_byte&&a.trigger_ud();break;case 6:dbg_assert(192<=a.modrm_byte,"Unexpected mfence encoding");192>a.modrm_byte&&a.trigger_ud();break;case 7:dbg_assert(192<=a.modrm_byte,"Unexpected sfence encoding");192>a.modrm_byte&&a.trigger_ud();break;default:dbg_log("missing "+(a.modrm_byte>>3&7),LOG_CPU),a.todo()}};
t16[175]=function(a){a.read_modrm_byte();var b=a.read_e16s();a.write_g16(a.imul_reg16(a.read_g16s(),b))};t32[175]=function(a){a.read_modrm_byte();var b=a.read_e32s();a.write_g32(a.imul_reg32(a.read_g32s(),b))};
t[176]=function(a){a.read_modrm_byte();if(192>a.modrm_byte){var b=a.modrm_resolve(a.modrm_byte);a.writable_or_pagefault(b,1);var c=a.safe_read8(b)}else c=a.reg8[a.modrm_byte<<2&12|a.modrm_byte>>2&1];a.cmp8(a.reg8[reg_al],c);a.getzf()?192>a.modrm_byte?a.safe_write8(b,a.read_g8()):a.reg8[a.modrm_byte<<2&12|a.modrm_byte>>2&1]=a.read_g8():(192>a.modrm_byte&&a.safe_write8(b,c),a.reg8[reg_al]=c)};
t16[177]=function(a){a.read_modrm_byte();if(192>a.modrm_byte){var b=a.modrm_resolve(a.modrm_byte);a.writable_or_pagefault(b,2);var c=a.safe_read16(b)}else c=a.read_reg_e16();a.cmp16(a.reg16[reg_ax],c);a.getzf()?192>a.modrm_byte?a.safe_write16(b,a.read_g16()):a.write_reg_e16(a.read_g16()):(192>a.modrm_byte&&a.safe_write16(b,c),a.reg16[reg_ax]=c)};
t32[177]=function(a){a.read_modrm_byte();if(192>a.modrm_byte){var b=a.modrm_resolve(a.modrm_byte);a.writable_or_pagefault(b,4);var c=a.safe_read32s(b)}else c=a.read_reg_e32s();a.cmp32(a.reg32s[reg_eax],c);a.getzf()?192>a.modrm_byte?a.safe_write32(b,a.read_g32s()):a.write_reg_e32(a.read_g32s()):(192>a.modrm_byte&&a.safe_write32(b,c),a.reg32s[reg_eax]=c)};t16[178]=function(a){a.read_modrm_byte();a.lss16(reg_ss)};t32[178]=function(a){a.read_modrm_byte();a.lss32(reg_ss)};
t16[179]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.btr_mem(a.modrm_resolve(a.modrm_byte),a.read_g16s()):a.write_reg_e16(a.btr_reg(a.read_reg_e16(),a.read_g16s()&15))};t32[179]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.btr_mem(a.modrm_resolve(a.modrm_byte),a.read_g32s()):a.write_reg_e32(a.btr_reg(a.read_reg_e32s(),a.read_g32s()&31))};t16[180]=function(a){a.read_modrm_byte();a.lss16(reg_fs)};t32[180]=function(a){a.read_modrm_byte();a.lss32(reg_fs)};
t16[181]=function(a){a.read_modrm_byte();a.lss16(reg_gs)};t32[181]=function(a){a.read_modrm_byte();a.lss32(reg_gs)};t16[182]=function(a){a.read_modrm_byte();var b=a.read_e8();a.write_g16(b)};t32[182]=function(a){a.read_modrm_byte();var b=a.read_e8();a.write_g32(b)};t16[183]=function(a){a.read_modrm_byte();dbg_assert(!1,"Possibly invalid encoding");var b=a.read_e16();a.write_g16(b)};t32[183]=function(a){a.read_modrm_byte();var b=a.read_e16();a.write_g32(b)};
t16[184]=function(a){a.read_modrm_byte();0===(a.prefixes&PREFIX_REPZ)&&a.trigger_ud();var b=a.read_e16();a.write_g16(a.popcnt(b))};t32[184]=function(a){a.read_modrm_byte();0===(a.prefixes&PREFIX_REPZ)&&a.trigger_ud();var b=a.read_e32s();a.write_g32(a.popcnt(b))};t[185]=function(a){a.todo()};
t16[186]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 4:192>a.modrm_byte?a.bt_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&15):a.bt_reg(a.read_reg_e16(),a.read_op8()&15);break;case 5:192>a.modrm_byte?a.bts_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&15):a.write_reg_e16(a.bts_reg(a.read_reg_e16(),a.read_op8()&15));break;case 6:192>a.modrm_byte?a.btr_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&15):a.write_reg_e16(a.btr_reg(a.read_reg_e16(),a.read_op8()&15));break;case 7:192>
a.modrm_byte?a.btc_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&15):a.write_reg_e16(a.btc_reg(a.read_reg_e16(),a.read_op8()&15));break;default:dbg_log(a.modrm_byte>>3&7),a.todo()}};
t32[186]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 4:192>a.modrm_byte?a.bt_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&31):a.bt_reg(a.read_reg_e32s(),a.read_op8()&31);break;case 5:192>a.modrm_byte?a.bts_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&31):a.write_reg_e32(a.bts_reg(a.read_reg_e32s(),a.read_op8()&31));break;case 6:192>a.modrm_byte?a.btr_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&31):a.write_reg_e32(a.btr_reg(a.read_reg_e32s(),a.read_op8()&31));break;case 7:192>
a.modrm_byte?a.btc_mem(a.modrm_resolve(a.modrm_byte),a.read_op8()&31):a.write_reg_e32(a.btc_reg(a.read_reg_e32s(),a.read_op8()&31));break;default:dbg_log(a.modrm_byte>>3&7),a.todo()}};t16[187]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.btc_mem(a.modrm_resolve(a.modrm_byte),a.read_g16s()):a.write_reg_e16(a.btc_reg(a.read_reg_e16(),a.read_g16s()&15))};
t32[187]=function(a){a.read_modrm_byte();192>a.modrm_byte?a.btc_mem(a.modrm_resolve(a.modrm_byte),a.read_g32s()):a.write_reg_e32(a.btc_reg(a.read_reg_e32s(),a.read_g32s()&31))};t16[188]=function(a){a.read_modrm_byte();var b=a.read_e16();a.write_g16(a.bsf16(a.read_g16(),b))};t32[188]=function(a){a.read_modrm_byte();var b=a.read_e32s();a.write_g32(a.bsf32(a.read_g32s(),b))};t16[189]=function(a){a.read_modrm_byte();var b=a.read_e16();a.write_g16(a.bsr16(a.read_g16(),b))};
t32[189]=function(a){a.read_modrm_byte();var b=a.read_e32s();a.write_g32(a.bsr32(a.read_g32s(),b))};t16[190]=function(a){a.read_modrm_byte();var b=a.read_e8s();a.write_g16(b)};t32[190]=function(a){a.read_modrm_byte();var b=a.read_e8s();a.write_g32(b)};t16[191]=function(a){a.read_modrm_byte();dbg_assert(!1,"Possibly invalid encoding");var b=a.read_e16();a.write_g16(b)};t32[191]=function(a){a.read_modrm_byte();var b=a.read_e16s();a.write_g32(b)};
t[192]=function(a){a.read_modrm_byte();var b=a.read_write_e8();a.write_e8(a.xadd8(b,a.modrm_byte>>1&12|a.modrm_byte>>5&1))};t16[193]=function(a){a.read_modrm_byte();var b=a.read_write_e16();a.write_e16(a.xadd16(b,a.modrm_byte>>2&14))};t32[193]=function(a){a.read_modrm_byte();var b=a.read_write_e32();a.write_e32(a.xadd32(b,a.modrm_byte>>3&7))};t[194]=function(a){a.unimplemented_sse()};t[195]=function(a){a.read_modrm_byte();192<=a.modrm_byte&&a.trigger_ud();a.set_e32(a.read_g32s())};t[196]=function(a){a.unimplemented_sse()};
t[197]=function(a){a.unimplemented_sse()};t[198]=function(a){a.unimplemented_sse()};
t[199]=function(a){a.read_modrm_byte();switch(a.modrm_byte>>3&7){case 1:192<=a.modrm_byte&&a.trigger_ud();var b=a.modrm_resolve(a.modrm_byte);a.writable_or_pagefault(b,8);var c=a.safe_read32s(b),d=a.safe_read32s(b+4|0);a.reg32s[reg_eax]===c&&a.reg32s[reg_edx]===d?(a.flags|=flag_zero,a.safe_write32(b,a.reg32s[reg_ebx]),a.safe_write32(b+4|0,a.reg32s[reg_ecx])):(a.flags&=~flag_zero,a.reg32s[reg_eax]=c,a.reg32s[reg_edx]=d,a.safe_write32(b,c),a.safe_write32(b+4|0,d));a.flags_changed&=~flag_zero;break;
case 6:c=(b=v86util.has_rand_int())?v86util.get_rand_int():0;a.is_osize_32()?a.set_e32(c):a.set_e16(c);a.flags&=~flags_all;a.flags|=b;a.flags_changed=0;break;default:dbg_log(a.modrm_byte>>3&7,LOG_CPU),a.todo()}};t[200]=function(a){a.bswap(reg_eax)};t[201]=function(a){a.bswap(reg_ecx)};t[202]=function(a){a.bswap(reg_edx)};t[203]=function(a){a.bswap(reg_ebx)};t[204]=function(a){a.bswap(reg_esp)};t[205]=function(a){a.bswap(reg_ebp)};t[206]=function(a){a.bswap(reg_esi)};t[207]=function(a){a.bswap(reg_edi)};
t[208]=function(a){a.unimplemented_sse()};t[209]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;var e=0,f=0;15>=b&&(e=(c&65535)>>>b|c>>>16>>>b<<16,f=(d&65535)>>>b|d>>>16>>>b<<16);a.write_mmx64s(e,f)};
t[210]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;var e=0,f=0;31>=b&&(e=c>>>b,f=d>>>b);a.write_mmx64s(e,f)};
t[211]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;if(0!==b){var e=0,f=0;31>=b?(e=c>>>b|d<<32-b,f=d>>>b):63>=b&&(e=d>>>(b&31),f=0);a.write_mmx64s(e,f)}};t[212]=function(a){a.unimplemented_sse()};
t[213]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Int16Array(b.buffer);var c=a.read_xmm128s();c=new Int16Array(c.buffer);a.write_xmm128s(b[0]*c[0]&65535|b[1]*c[1]<<16,b[2]*c[2]&65535|b[3]*c[3]<<16,b[4]*c[4]&65535|b[5]*c[5]<<16,b[6]*c[6]&65535|b[7]*c[7]<<16)}else{dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));b=a.read_mmx_mem64s();c=a.reg_mmxs[2*(a.modrm_byte>>
3&7)];var d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s((c&65535)*(b[0]&65535)&65535|((c>>>16)*(b[0]>>>16)&65535)<<16,(d&65535)*(b[1]&65535)&65535|((d>>>16)*(b[1]>>>16)&65535)<<16)}};t[214]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm64s();dbg_assert(192>a.modrm_byte);var c=a.modrm_resolve(a.modrm_byte);a.safe_write64(c,b[0],b[1])};
t[215]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();192>a.modrm_byte&&a.trigger_ud();var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);a.write_g32(b[0]>>7<<0|b[1]>>7<<1|b[2]>>7<<2|b[3]>>7<<3|b[4]>>7<<4|b[5]>>7<<5|b[6]>>7<<6|b[7]>>7<<7|b[8]>>7<<8|b[9]>>7<<9|b[10]>>7<<10|b[11]>>7<<11|b[12]>>7<<12|b[13]>>7<<13|b[14]>>7<<14|b[15]>>7<<15)};
t[216]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=new Uint8Array(b.buffer),d=8*(a.modrm_byte>>3&7),e=a.reg_mmx8;b=a.saturate_sd_to_ub(e[d]-c[0]);var f=a.saturate_sd_to_ub(e[d+1]-c[1]),g=a.saturate_sd_to_ub(e[d+2]-c[2]),k=a.saturate_sd_to_ub(e[d+3]-c[3]),l=a.saturate_sd_to_ub(e[d+4]-c[4]),m=a.saturate_sd_to_ub(e[d+5]-c[5]),p=a.saturate_sd_to_ub(e[d+6]-c[6]);c=a.saturate_sd_to_ub(e[d+7]-c[7]);
a.write_mmx64s(b|f<<8|g<<16|k<<24,l|m<<8|p<<16|c<<24)};t[217]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1],e=(c&65535)-(b[0]&65535);c=(c>>>16)-(b[0]>>>16);0>e&&(e=0);0>c&&(c=0);var f=(d&65535)-(b[1]&65535);b=(d>>>16)-(b[1]>>>16);0>f&&(f=0);0>b&&(b=0);a.write_mmx64s(e|c<<16,f|b<<16)};
t[218]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);var c=a.read_xmm128s();c=new Uint8Array(c.buffer);for(var d=a.create_atom128s(0,0,0,0),e=new Uint8Array(d.buffer),f=0;16>f;f++)e[f]=b[f]<c[f]?b[f]:c[f];a.write_xmm128s(d[0],d[1],d[2],d[3])};
t[219]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(b[0]&a.reg_mmxs[2*(a.modrm_byte>>3&7)],b[1]&a.reg_mmxs[2*(a.modrm_byte>>3&7)+1])};
t[220]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);var c=a.read_xmm128s();c=new Uint8Array(c.buffer);for(var d=a.create_atom128s(0,0,0,0),e=new Uint8Array(d.buffer),f=0;16>f;f++)e[f]=a.saturate_ud_to_ub(b[f]+c[f]);a.write_xmm128s(d[0],d[1],d[2],d[3])}else{dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));b=a.read_mmx_mem64s();var g=new Uint8Array(b.buffer),
k=8*(a.modrm_byte>>3&7),l=a.reg_mmx8;b=a.saturate_ud_to_ub(l[k]+g[0]);c=a.saturate_ud_to_ub(l[k+1]+g[1]);d=a.saturate_ud_to_ub(l[k+2]+g[2]);e=a.saturate_ud_to_ub(l[k+3]+g[3]);f=a.saturate_ud_to_ub(l[k+4]+g[4]);var m=a.saturate_ud_to_ub(l[k+5]+g[5]),p=a.saturate_ud_to_ub(l[k+6]+g[6]);g=a.saturate_ud_to_ub(l[k+7]+g[7]);a.write_mmx64s(b|c<<8|d<<16|e<<24,f|m<<8|p<<16|g<<24)}};
t[221]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Uint16Array(b.buffer);var c=a.read_xmm128s();c=new Uint16Array(c.buffer);a.write_xmm128s(a.saturate_uw(b[0]+c[0])|a.saturate_uw(b[1]+c[1])<<16,a.saturate_uw(b[2]+c[2])|a.saturate_uw(b[3]+c[3])<<16,a.saturate_uw(b[4]+c[4])|a.saturate_uw(b[5]+c[5])<<16,a.saturate_uw(b[6]+c[6])|a.saturate_uw(b[7]+c[7])<<16)}else{dbg_assert(0==(a.prefixes&
(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));c=a.read_mmx_mem64s();var d=a.reg_mmxs[2*(a.modrm_byte>>3&7)],e=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=a.saturate_uw((d&65535)+(c[0]&65535));d=a.saturate_uw((d>>>16)+(c[0]>>>16));var f=a.saturate_uw((e&65535)+(c[1]&65535));c=a.saturate_uw((e>>>16)+(c[1]>>>16));a.write_mmx64s(b|d<<16,f|c<<16)}};
t[222]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s();b=new Uint8Array(b.buffer);var c=a.read_xmm128s();c=new Uint8Array(c.buffer);for(var d=a.create_atom128s(0,0,0,0),e=new Uint8Array(d.buffer),f=0;16>f;f++)e[f]=b[f]>c[f]?b[f]:c[f];a.write_xmm128s(d[0],d[1],d[2],d[3])}else dbg_assert(!1)};
t[223]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(b[0]&~a.reg_mmxs[2*(a.modrm_byte>>3&7)],b[1]&~a.reg_mmxs[2*(a.modrm_byte>>3&7)+1])};t[224]=function(a){a.unimplemented_sse()};
t[225]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;15<b&&(b=16);a.write_mmx64s(c<<16>>16>>b&65535|(c>>16>>b&65535)<<16,d<<16>>16>>b&65535|(d>>16>>b&65535)<<16)};
t[226]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;31<b&&(b=31);a.write_mmx64s(c>>b,d>>b)};t[227]=function(a){a.unimplemented_sse()};
t[228]=function(a){dbg_assert((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE);a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_xmm_mem128s();b=new Uint16Array(b.buffer);var c=a.read_xmm128s();c=new Uint16Array(c.buffer);a.write_xmm128s(b[0]*c[0]>>>16|b[1]*c[1]&4294901760,b[2]*c[2]>>>16|b[3]*c[3]&4294901760,b[4]*c[4]>>>16|b[5]*c[5]&4294901760,b[6]*c[6]>>>16|b[7]*c[7]&4294901760)};
t[229]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s((c<<16>>16)*(b[0]<<16>>16)>>>16|(c>>16)*(b[0]>>16)>>>16<<16,(d<<16>>16)*(b[1]<<16>>16)>>>16|(d>>16)*(b[1]>>16)>>>16<<16)};t[230]=function(a){a.unimplemented_sse()};
t[231]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();192<=a.modrm_byte&&a.trigger_ud();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm128s(),c=a.modrm_resolve(a.modrm_byte);a.safe_write128(c,b[0],b[1],b[2],b[3])}else dbg_assert(!1)};
t[232]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=new Int8Array(b.buffer),d=8*(a.modrm_byte>>3&7),e=a.reg_mmx8s;b=a.saturate_sd_to_sb(e[d]-c[0]);var f=a.saturate_sd_to_sb(e[d+1]-c[1]),g=a.saturate_sd_to_sb(e[d+2]-c[2]),k=a.saturate_sd_to_sb(e[d+3]-c[3]),l=a.saturate_sd_to_sb(e[d+4]-c[4]),m=a.saturate_sd_to_sb(e[d+5]-c[5]),p=a.saturate_sd_to_sb(e[d+6]-c[6]);c=a.saturate_sd_to_sb(e[d+7]-c[7]);
a.write_mmx64s(b|f<<8|g<<16|k<<24,l|m<<8|p<<16|c<<24)};t[233]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1],e=a.saturate_sd_to_sw((c<<16>>16)-(b[0]<<16>>16));c=a.saturate_sd_to_sw((c>>16)-(b[0]>>16));var f=a.saturate_sd_to_sw((d<<16>>16)-(b[1]<<16>>16));b=a.saturate_sd_to_sw((d>>16)-(b[1]>>16));a.write_mmx64s(e|c<<16,f|b<<16)};
t[234]=function(a){a.unimplemented_sse()};t[235]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))===PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s(),c=a.read_xmm128s();a.write_xmm128s(b[0]|c[0],b[1]|c[1],b[2]|c[2],b[3]|c[3])}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),a.write_mmx64s(b[0]|a.reg_mmxs[2*(a.modrm_byte>>3&7)],b[1]|a.reg_mmxs[2*(a.modrm_byte>>3&7)+1])};
t[236]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=new Int8Array(b.buffer),d=8*(a.modrm_byte>>3&7),e=a.reg_mmx8s;b=a.saturate_sd_to_sb(e[d]+c[0]);var f=a.saturate_sd_to_sb(e[d+1]+c[1]),g=a.saturate_sd_to_sb(e[d+2]+c[2]),k=a.saturate_sd_to_sb(e[d+3]+c[3]),l=a.saturate_sd_to_sb(e[d+4]+c[4]),m=a.saturate_sd_to_sb(e[d+5]+c[5]),p=a.saturate_sd_to_sb(e[d+6]+c[6]);c=a.saturate_sd_to_sb(e[d+7]+c[7]);
a.write_mmx64s(b|f<<8|g<<16|k<<24,l|m<<8|p<<16|c<<24)};t[237]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1],e=a.saturate_sd_to_sw((c<<16>>16)+(b[0]<<16>>16));c=a.saturate_sd_to_sw((c>>16)+(b[0]>>16));var f=a.saturate_sd_to_sw((d<<16>>16)+(b[1]<<16>>16));b=a.saturate_sd_to_sw((d>>16)+(b[1]>>16));a.write_mmx64s(e|c<<16,f|b<<16)};
t[238]=function(a){a.unimplemented_sse()};t[239]=function(a){a.task_switch_test_mmx();a.read_modrm_byte();if((a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))==PREFIX_MASK_OPSIZE){var b=a.read_xmm_mem128s(),c=a.read_xmm128s();a.write_xmm128s(b[0]^c[0],b[1]^c[1],b[2]^c[2],b[3]^c[3])}else dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE))),b=a.read_mmx_mem64s(),a.write_mmx64s(b[0]^a.reg_mmxs[2*(a.modrm_byte>>3&7)],b[1]^a.reg_mmxs[2*(a.modrm_byte>>3&7)+1])};t[240]=function(a){a.unimplemented_sse()};
t[241]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;var e=0,f=0;15>=b&&(e=(c&65535)<<b&65535|c>>>16<<b<<16,f=(d&65535)<<b&65535|d>>>16<<b<<16);a.write_mmx64s(e,f)};
t[242]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;var e=0,f=0;31>=b&&(e=c<<b,f=d<<b);a.write_mmx64s(e,f)};
t[243]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];b=b[0]>>>0;if(0!==b){var e=0,f=0;31>=b?(e=c<<b,f=d<<b|c>>>32-b):63>=b&&(f=c<<(b&31),e=0);a.write_mmx64s(e,f)}};t[244]=function(a){a.unimplemented_sse()};
t[245]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s((c<<16>>16)*(b[0]<<16>>16)+(c>>16)*(b[0]>>16)|0,(d<<16>>16)*(b[1]<<16>>16)+(d>>16)*(b[1]>>16)|0)};t[246]=function(a){a.unimplemented_sse()};t[247]=function(a){a.unimplemented_sse()};
t[248]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();b=new Int8Array(b.buffer);var c=8*(a.modrm_byte>>3&7),d=a.reg_mmx8s;a.write_mmx64s(d[c]-b[0]&255|(d[c+1]-b[1]&255)<<8|(d[c+2]-b[2]&255)<<16|(d[c+3]-b[3]&255)<<24,d[c+4]-b[4]&255|(d[c+5]-b[5]&255)<<8|(d[c+6]-b[6]&255)<<16|(d[c+7]-b[7]&255)<<24)};
t[249]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s(c-b[0]&65535|((c>>>16)-(b[0]>>>16)&65535)<<16,d-b[1]&65535|((d>>>16)-(b[1]>>>16)&65535)<<16)};
t[250]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)]-b[0],a.reg_mmxs[2*(a.modrm_byte>>3&7)+1]-b[1])};t[251]=function(a){a.unimplemented_sse()};
t[252]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();b=new Int8Array(b.buffer);var c=8*(a.modrm_byte>>3&7),d=a.reg_mmx8s;a.write_mmx64s(d[c]+b[0]&255|(d[c+1]+b[1]&255)<<8|(d[c+2]+b[2]&255)<<16|(d[c+3]+b[3]&255)<<24,d[c+4]+b[4]&255|(d[c+5]+b[5]&255)<<8|(d[c+6]+b[6]&255)<<16|(d[c+7]+b[7]&255)<<24)};
t[253]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s(),c=a.reg_mmxs[2*(a.modrm_byte>>3&7)],d=a.reg_mmxs[2*(a.modrm_byte>>3&7)+1];a.write_mmx64s(c+b[0]&65535|((c>>>16)+(b[0]>>>16)&65535)<<16,d+b[1]&65535|((d>>>16)+(b[1]>>>16)&65535)<<16)};
t[254]=function(a){dbg_assert(0==(a.prefixes&(PREFIX_MASK_REP|PREFIX_MASK_OPSIZE)));a.task_switch_test_mmx();a.read_modrm_byte();var b=a.read_mmx_mem64s();a.write_mmx64s(a.reg_mmxs[2*(a.modrm_byte>>3&7)]+b[0]|0,a.reg_mmxs[2*(a.modrm_byte>>3&7)+1]+b[1]|0)};t[255]=function(a){dbg_log("#ud: 0F FF");a.trigger_ud()};var table0F_16=[],table0F_32=[];CPU.prototype.table0F_16=table0F_16;CPU.prototype.table0F_32=table0F_32;
for(i=0;256>i;i++)t[i]?table0F_16[i]=table0F_32[i]=t[i]:t16[i]&&(table0F_16[i]=t16[i],table0F_32[i]=t32[i]);CPU.prototype.debug_init=function(){function a(){DEBUG&&(k.running||k.cycle(),d(),Date.now(),k.running=!1,f())}function b(a){var b=k.flags&flag_vm?1:0;b=k.protected_mode?b?"vm86":"prot":"real";var c=k.get_eflags(),d=k.getiopl(),e=k.cpl,f=h(k.sreg[reg_cs],4)+":"+h(k.get_real_eip()>>>0,8),g=h(k.sreg[reg_ss],4)+":"+h(k.get_stack_reg()>>>0,8),l=k.is_32?"32":"16",p=k.flags&flag_interrupt?1:0,m={};m=(m[flag_carry]="c",m[flag_parity]="p",m[flag_adjust]="a",m[flag_zero]="z",m[flag_sign]="s",m[flag_trap]=
"t",m[flag_interrupt]="i",m[flag_direction]="d",m[flag_overflow]="o",m);for(var B="",z=0;16>z;z++)m[1<<z]&&(B=c&1<<z?B+m[1<<z]:B+" ");return"mode="+b+"/"+l+" paging="+ +k.paging+" iopl="+d+" cpl="+e+" if="+p+" cs:eip="+f+" cs_off="+h(k.get_seg(reg_cs)>>>0,8)+" flgs="+h(k.get_eflags()>>>0,6)+" ("+B+") ss:esp="+g+" ssize="+ +k.stack_size_32+(a?" in "+a:"")}function c(){for(var a={eax:reg_eax,ecx:reg_ecx,edx:reg_edx,ebx:reg_ebx,esp:reg_esp,ebp:reg_ebp,esi:reg_esi,edi:reg_edi},b="eax ecx edx ebx esp ebp esi edi".split(" "),
c="",d="",e=0;4>e;e++)c+=b[e]+"="+h(k.reg32[a[b[e]]],8)+" ",d+=b[e+4]+"="+h(k.reg32[a[b[e+4]]],8)+" ";c+="  ds="+h(k.sreg[reg_ds],4)+" es="+h(k.sreg[reg_es],4)+" fs="+h(k.sreg[reg_fs],4);d+="  gs="+h(k.sreg[reg_gs],4)+" cs="+h(k.sreg[reg_cs],4)+" ss="+h(k.sreg[reg_ss],4);return[c,d]}function d(){if(DEBUG){var a=c();dbg_log(a[0],LOG_CPU);dbg_log(a[1],LOG_CPU)}}function e(){if(DEBUG){l.step_mode=!0;var a,b="";l.trace_all&&l.all_ops?a=l.all_ops:l.ops&&(a=l.ops.toArray());if(!a)return"";for(var c=0;c<
a.length;c+=2){var d=a[c+1];b+=h(a[c],8)+":        "+v86util.pads(m[d]||"unkown",20)+h(d,2)+"\n"}l.ops.clear();l.all_ops=[];return b}}function f(){DEBUG&&l.show(e())}function g(a,b){if(DEBUG){if(!(a&1))return!1;var c=128===(a&128);return{size:c,global:256===(a&256),accessed:32===(a&32),dirty:64===(a&64),cache_disable:16===(a&16),user:4===(a&4),read_write:2===(a&2),address:(c&&!b?a&4290772992:a&4294963200)>>>0}}}var k=this,l={};this.debug=l;l.step_mode=!1;l.ops=void 0;l.all_ops=[];l.trace_all=!1;l.show=
function(a){if("undefined"!==typeof document){var b=document.getElementById("log");if(b){b.textContent+=a+"\n";b.scrollTop=1E9;return}}console.log(a)};l.init=function(){function a(a){10===a?(dbg_log(b,LOG_BIOS),b=""):b+=String.fromCharCode(a)}if(DEBUG&&(l.ops=new CircularQueue(2E5),k.io)){var b="";k.io.register_write(1026,this,a);k.io.register_write(1280,this,a)}};l.get_regs_short=c;l.dump_regs=d;l.dump_instructions=f;l.get_instructions=e;l.get_state=b;l.dump_state=function(a){DEBUG&&dbg_log(b(a),
LOG_CPU)};l.dump_stack=function(a,b){if(DEBUG){var c=k.reg32[reg_esp];dbg_log("========= STACK ==========");if(b>=a||void 0===b)a=5,b=-5;for(;a>b;a--){var d="    ";a||(d="=>  ");d+=h(a,2)+" | ";dbg_log(d+h(c+4*a,8)+" | "+h(k.read32s(c+4*a)>>>0))}}};l.dump_page_directory=function(){if(DEBUG)for(var a=0;1024>a;a++){var b=k.read32s(k.cr[3]+4*a),c=g(b,!0);if(c)if(b="",b+=c.size?"S ":"  ",b+=c.accessed?"A ":"  ",b+=c.cache_disable?"Cd ":"  ",b+=c.user?"U ":"  ",b+=c.read_write?"Rw ":"   ",c.size)dbg_log("=== "+
h(a<<22>>>0,8)+" -> "+h(c.address>>>0,8)+" | "+b);else{dbg_log("=== "+h(a<<22>>>0,8)+" | "+b);for(var d=0;1024>d;d++){var e=c.address+4*d;b=k.read32s(e);var f=g(b,!1);f&&(b="",b+=f.cache_disable?"Cd ":"   ",b+=f.user?"U ":"  ",b+=f.read_write?"Rw ":"   ",b+=f.global?"G ":"  ",b+=f.accessed?"A ":"  ",b+=f.dirty?"Di ":"   ",dbg_log("# "+h((a<<22|d<<12)>>>0,8)+" -> "+h(f.address,8)+" | "+b+"        (at "+h(e,8)+")"))}}}};l.dump_gdt_ldt=function(){function a(a,b){for(var c=0;c<b;c+=8,a+=8){var d=k.read16(a+
2)|k.read8(a+4)<<16|k.read8(a+7)<<24,e=k.read16(a)|(k.read8(a+6)&15)<<16,f=k.read8(a+5),g=k.read8(a+6)>>4,l="",m=f>>5&3;l=f&128?l+" P ":l+"NP ";f&16?(l=g&4?l+"32b ":l+"16b ",f&8?(l+="X ",f&4&&(l+="C ")):l+="R ",l+="RW "):l+="sys: "+h(f&15);g&8&&(e=e<<12|4095);dbg_log(h(c&-8,4)+" "+h(d>>>0,8)+" ("+h(e>>>0,8)+" bytes) "+l+";  dpl = "+m+", a = "+f.toString(2)+", f = "+g.toString(2))}}DEBUG&&(dbg_log("gdt: (len = "+h(k.gdtr_size)+")"),a(k.translate_address_system_read(k.gdtr_offset),k.gdtr_size),dbg_log("\nldt: (len = "+
h(k.segment_limits[reg_ldtr])+")"),a(k.translate_address_system_read(k.segment_offsets[reg_ldtr]),k.segment_limits[reg_ldtr]))};l.dump_idt=function(){if(DEBUG)for(var a=0;a<k.idtr_size;a+=8){var b=k.translate_address_system_read(k.idtr_offset+a),c=k.read16(b)|k.read16(b+6)<<16,d=k.read16(b+2);b=k.read8(b+5);var e=b>>5&3;var f=5===(b&31)?"task gate ":14===(b&31)?"intr gate ":15===(b&31)?"trap gate ":"invalid   ";f=b&128?f+" P":f+"NP";dbg_log(h(a>>3,4)+" "+h(c>>>0,8)+", "+h(d,4)+"; "+f+";  dpl = "+
e+", t = "+b.toString(2))}};l.get_memory_dump=function(a,b){if(DEBUG)return void 0===a?(a=0,b=k.memory_size):void 0===b&&(b=a,a=0),k.mem8.slice(a,a+b).buffer};l.memory_hex_dump=function(a,b){if(DEBUG){b=b||64;for(var c,d,e=0;e<b>>4;e++){c=h(a+(e<<4),5)+"   ";for(var f=0;16>f;f++)d=k.read8(a+(e<<4)+f),c+=h(d,2)+" ";c+="  ";for(f=0;16>f;f++)d=k.read8(a+(e<<4)+f),c+=33>d||126<d?".":String.fromCharCode(d);dbg_log(c)}}};l.used_memory_dump=function(){if(DEBUG)for(var a=k.memory_size/128/16|0,b,c=0;16>c;c++){b=
h(128*c*a,8)+" | ";for(var d=0;128>d;d++)b+=0<k.mem32s[(128*c+d)*a]?"X":" ";dbg_log(b)}};l.step=a;l.run_until=function(){if(DEBUG){k.running=!1;var b=parseInt(prompt("input hex",""),16);if(b)for(;k.instruction_pointer!=b;)a()}};l.unimpl=function(a){a="Unimplemented"+(a?": "+a:"");l.show(a);DEBUG?console.trace():l.show("Execution stopped");return a};var m="ADD ADD ADD ADD ADD ADD PUSH POP OR OR OR OR OR OR PUSH 0F: ADC ADC ADC ADC ADC ADC PUSH POP SBB SBB SBB SBB SBB SBB PUSH POP AND AND AND AND AND AND ES DAA SUB SUB SUB SUB SUB SUB CS DAS XOR XOR XOR XOR XOR XOR SS AAA CMP CMP CMP CMP CMP CMP DS AAS INC INC INC INC INC INC INC INC DEC DEC DEC DEC DEC DEC DEC DEC PUSH PUSH PUSH PUSH PUSH PUSH PUSH PUSH POP POP POP POP POP POP POP POP PUSHA POPA BOUND ARPL FS GS none none PUSH IMUL PUSH IMUL INS INS OUTS OUTS JO JNO JB JNB JZ JNZ JBE JNBE JS JNS JP JNP JL JNL JLE JNLE ADD ADD ADD ADD TEST TEST XCHG XCHG MOV MOV MOV MOV MOV LEA MOV POP NOP XCHG XCHG XCHG XCHG XCHG XCHG XCHG CBW CWD CALLF FWAIT PUSHF POPF SAHF LAHF MOV MOV MOV MOV MOVS MOVS CMPS CMPS TEST TEST STOS STOS LODS LODS SCAS SCAS MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV MOV ROL ROL RETN RETN LES LDS MOV MOV ENTER LEAVE RETF RETF INT INT INTO IRET ROL ROL ROL ROL AAM AAD none XLAT FADD FLD FIADD FILD FADD FLD FIADD FILD LOOPNZ LOOPZ LOOP JCXZ IN IN OUT OUT CALL JMP JMPF JMP IN IN OUT OUT LOCK none REPNZ REPZ HLT CMC TEST TEST CLC STC CLI STI CLD STD INC INC".split(" ");
l.logop=function(a,b){DEBUG&&l.step_mode&&(l.trace_all&&l.all_ops?l.all_ops.push(a,b):l.ops&&(l.ops.add(a),l.ops.add(b)))};l.debug_interrupt=function(a){}};var ELF_MAGIC=1179403647,types=DataView.prototype,U8={size:1,get:types.getUint8,set:types.setUint8},U16={size:2,get:types.getUint16,set:types.setUint16},U32={size:4,get:types.getUint32,set:types.setUint32},pad=function(a){return{size:a,get:function(a){return-1}}},Header=create_struct([{magic:U32},{class:U8},{data:U8},{version0:U8},{osabi:U8},{abiversion:U8},{pad0:pad(7)},{type:U16},{machine:U16},{version1:U32},{entry:U32},{phoff:U32},{shoff:U32},{flags:U32},{ehsize:U16},{phentsize:U16},{phnum:U16},
{shentsize:U16},{shnum:U16},{shstrndx:U16}]);console.assert(52===Header.reduce(function(a,b){return a+b.size},0));var ProgramHeader=create_struct([{type:U32},{offset:U32},{vaddr:U32},{paddr:U32},{filesz:U32},{memsz:U32},{flags:U32},{align:U32}]);console.assert(32===ProgramHeader.reduce(function(a,b){return a+b.size},0));var SectionHeader=create_struct([{name:U32},{type:U32},{flags:U32},{addr:U32},{offset:U32},{size:U32},{link:U32},{info:U32},{addralign:U32},{entsize:U32}]);
console.assert(40===SectionHeader.reduce(function(a,b){return a+b.size},0));function create_struct(a){return a.map(function(a){var b=Object.keys(a);console.assert(1===b.length);b=b[0];a=a[b];console.assert(0<a.size);return{name:b,type:a,size:a.size,get:a.get,set:a.set}})}
function read_elf(a){var b=new DataView(a),c=$jscomp.makeIterator(read_struct(b,Header));a=c.next().value;c=c.next().value;console.assert(52===c);if(DEBUG){for(var d in a)console.log(d+": 0x"+a[d].toString(16));console.log(a)}console.assert(a.magic===ELF_MAGIC,"Bad magic");console.assert(1===a.class,"Unimplemented: 64 bit elf");console.assert(1===a.data,"Unimplemented: big endian");console.assert(1===a.version0,"Bad version0");console.assert(2===a.type,"Unimplemented type");console.assert(1===a.version1,
"Bad version1");console.assert(52===a.ehsize,"Bad header size");console.assert(32===a.phentsize,"Bad program header size");console.assert(40===a.shentsize,"Bad section header size");c=$jscomp.makeIterator(read_structs(view_slice(b,a.phoff,a.phentsize*a.phnum),ProgramHeader,a.phnum));d=c.next().value;c.next();c=$jscomp.makeIterator(read_structs(view_slice(b,a.shoff,a.shentsize*a.shnum),SectionHeader,a.shnum));b=c.next().value;c.next();if(DEBUG){console.log("%d program headers:",d.length);c=$jscomp.makeIterator(d);
for(var e=c.next();!e.done;e=c.next())e=e.value,console.log("type=%s offset=%s vaddr=%s paddr=%s filesz=%s memsz=%s flags=%s align=%s",e.type.toString(16),e.offset.toString(16),e.vaddr.toString(16),e.paddr.toString(16),e.filesz.toString(16),e.memsz.toString(16),e.flags.toString(16),e.align.toString(16));console.log("%d program headers:",b.length);c=$jscomp.makeIterator(b);for(e=c.next();!e.done;e=c.next())e=e.value,console.log("name=%s type=%s flags=%s addr=%s offset=%s size=%s link=%s info=%s addralign=%s entsize=%s",
e.name.toString(16),e.type.toString(16),e.flags.toString(16),e.addr.toString(16),e.offset.toString(16),e.size.toString(16),e.link.toString(16),e.info.toString(16),e.addralign.toString(16),e.entsize.toString(16))}return{header:a,program_headers:d,sections_headers:b}}function read_struct(a,b){var c={},d=0;b=$jscomp.makeIterator(b);for(var e=b.next();!e.done;e=b.next()){e=e.value;var f=e.get.call(a,d,!0);console.assert(void 0===c[e.name]);c[e.name]=f;d+=e.size}return[c,d]}
function read_structs(a,b,c){for(var d=[],e=0,f=0;f<c;f++){var g=$jscomp.makeIterator(read_struct(view_slice(a,e),b)),k=g.next().value;g=g.next().value;d.push(k);e+=g}return[d,e]}function view_slice(a,b,c){return new DataView(a.buffer,a.byteOffset+b,c)};var SHIFT_SCAN_CODE=42,SCAN_CODE_RELEASE=128;
function KeyboardAdapter(a){function b(a){!a.altKey&&k[56]&&f(56,!1);return e(a,!1)}function c(a){!a.altKey&&k[56]&&f(56,!1);return e(a,!0)}function d(a){a=Object.keys(k);for(var b,c=0;c<a.length;c++)b=+a[c],k[b]&&f(b,!1);k={}}function e(a,b){if(l.bus&&(a.shiftKey&&a.ctrlKey&&(74===a.keyCode||75===a.keyCode)||!l.emu_enabled?0:a.target?"phone_keyboard"===a.target.className||"INPUT"!==a.target.nodeName&&"TEXTAREA"!==a.target.nodeName:1)){a:{if(void 0!==a.code){var c=r[a.code];if(void 0!==c)break a}c=
m[a.keyCode]}if(c)return f(c,b),a.preventDefault&&a.preventDefault(),!1;console.log("Missing char in map: "+a.keyCode.toString(16))}}function f(a,b){if(b)k[a]&&f(a,!1);else if(!k[a])return;(k[a]=b)||(a|=128);255<a?(g(a>>8),g(a&255)):g(a)}function g(a){l.bus.send("keyboard-code",a)}var k={},l=this;this.emu_enabled=!0;var m=new Uint16Array([0,0,0,0,0,0,0,0,14,15,0,0,0,28,0,0,42,29,56,0,58,0,0,0,0,0,0,1,0,0,0,0,57,57417,57425,57423,57415,57419,57416,57421,80,0,0,0,0,82,83,0,11,2,3,4,5,6,7,8,9,10,0,39,
0,13,0,0,0,30,48,46,32,18,33,34,35,23,36,37,38,50,49,24,25,16,19,31,20,22,47,17,45,21,44,57435,57436,57437,0,0,82,79,80,81,75,76,77,71,72,73,0,0,0,0,0,0,59,60,61,62,63,64,65,66,67,68,87,88,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,69,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,0,0,0,0,0,0,0,0,0,0,0,0,39,13,51,12,52,53,41,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,26,43,27,40,0,57435,57400,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),p={10:13,32:32,39:222,44:188,45:189,46:190,47:191,48:48,49:49,
50:50,51:51,52:52,53:53,54:54,55:55,56:56,57:57,59:186,61:187,91:219,92:220,93:221,96:192,97:65,98:66,99:67,100:68,101:69,102:70,103:71,104:72,105:73,106:74,107:75,108:76,109:77,110:78,111:79,112:80,113:81,114:82,115:83,116:84,117:85,118:86,119:87,120:88,121:89,122:90},n={33:49,34:222,35:51,36:52,37:53,38:55,40:57,41:48,42:56,43:187,58:186,60:188,62:190,63:191,64:50,65:65,66:66,67:67,68:68,69:69,70:70,71:71,72:72,73:73,74:74,75:75,76:76,77:77,78:78,79:79,80:80,81:81,82:82,83:83,84:84,85:85,86:86,
87:87,88:88,89:89,90:90,94:54,95:189,123:219,124:220,125:221,126:192},r={Escape:1,Digit1:2,Digit2:3,Digit3:4,Digit4:5,Digit5:6,Digit6:7,Digit7:8,Digit8:9,Digit9:10,Digit0:11,Minus:12,Equal:13,Backspace:14,Tab:15,KeyQ:16,KeyW:17,KeyE:18,KeyR:19,KeyT:20,KeyY:21,KeyU:22,KeyI:23,KeyO:24,KeyP:25,BracketLeft:26,BracketRight:27,Enter:28,ControlLeft:29,KeyA:30,KeyS:31,KeyD:32,KeyF:33,KeyG:34,KeyH:35,KeyJ:36,KeyK:37,KeyL:38,Semicolon:39,Quote:40,Backquote:41,ShiftLeft:42,Backslash:43,KeyZ:44,KeyX:45,KeyC:46,
KeyV:47,KeyB:48,KeyN:49,KeyM:50,Comma:51,Period:52,Slash:53,ShiftRight:54,NumpadMultiply:55,AltLeft:56,Space:57,CapsLock:58,F1:59,F2:60,F3:61,F4:62,F5:63,F6:64,F7:65,F8:66,F9:67,F10:68,NumLock:69,ScrollLock:70,Numpad7:71,Numpad8:72,Numpad9:73,NumpadSubtract:74,Numpad4:75,Numpad5:76,Numpad6:77,NumpadAdd:78,Numpad1:79,Numpad2:80,Numpad3:81,Numpad0:82,NumpadDecimal:83,IntlBackslash:86,F11:87,F12:88,NumpadEnter:57372,ControlRight:57373,NumpadDivide:57397,AltRight:57400,Home:57423,ArrowUp:57416,PageUp:57417,
ArrowLeft:57419,ArrowRight:57421,End:57423,ArrowDown:57424,PageDown:57425,Insert:57426,Delete:57427,OSLeft:57435,OSRight:57436,ContextMenu:57437};this.bus=a;this.destroy=function(){"undefined"!==typeof window&&(window.removeEventListener("keyup",b,!1),window.removeEventListener("keydown",c,!1),window.removeEventListener("blur",d,!1))};this.init=function(){"undefined"!==typeof window&&(this.destroy(),window.addEventListener("keyup",b,!1),window.addEventListener("keydown",c,!1),window.addEventListener("blur",
d,!1))};this.init();this.simulate_press=function(a){a={keyCode:a};e(a,!0);e(a,!1)};this.simulate_char=function(a){var b=a.charCodeAt(0);b in p?this.simulate_press(p[b]):b in n?(g(SHIFT_SCAN_CODE),this.simulate_press(n[b]),g(SHIFT_SCAN_CODE|SCAN_CODE_RELEASE)):console.log("ascii -> keyCode not found: ",b,a)}};function MouseAdapter(a,b){function c(a){if(!w.enabled||!w.emu_enabled)return!1;if("mousemove"===a.type||"touchmove"===a.type)return!0;if("mousewheel"===a.type||"DOMMouseScroll"===a.type){var c=b||document.body;a:{for(a=a.target;a.parentNode;){if(a===c){c=!0;break a}a=a.parentNode}c=!1}return c}return!a.target||"INPUT"!==a.target.nodeName&&"TEXTAREA"!==a.target.nodeName}function d(a){c(a)&&(a=a.changedTouches)&&a.length&&(a=a[a.length-1],q=a.clientX,u=a.clientY)}function e(a){if(p||r||n)w.bus.send("mouse-click",
[!1,!1,!1]),p=r=n=!1}function f(a){if(w.bus&&c(a)){var d=0,e=0,f=a.changedTouches;f?f.length&&(f=f[f.length-1],d=f.clientX-q,e=f.clientY-u,q=f.clientX,u=f.clientY,a.preventDefault()):"number"===typeof a.movementX?(d=a.movementX,e=a.movementY):"number"===typeof a.webkitMovementX?(d=a.webkitMovementX,e=a.webkitMovementY):"number"===typeof a.mozMovementX?(d=a.mozMovementX,e=a.mozMovementY):(d=a.clientX-q,e=a.clientY-u,q=a.clientX,u=a.clientY);w.bus.send("mouse-delta",[.15*d,-(.15*e)]);w.bus.send("mouse-absolute",
[a.pageX-b.offsetLeft,a.pageY-b.offsetTop,b.offsetWidth,b.offsetHeight])}}function g(a){c(a)&&l(a,!0)}function k(a){c(a)&&l(a,!1)}function l(a,b){w.bus&&(1===a.which?p=b:2===a.which?r=b:3===a.which?n=b:console.log("Unknown event.which: "+a.which),w.bus.send("mouse-click",[p,r,n]))}function m(a){if(c(a)){var b=a.wheelDelta||-a.detail;0>b?b=-1:0<b&&(b=1);w.bus.send("mouse-wheel",[b,0]);a.preventDefault()}}var p=!1,n=!1,r=!1,q=0,u=0,w=this;this.enabled=!1;this.emu_enabled=!0;this.bus=a;this.bus.register("mouse-enable",
function(a){this.enabled=a},this);this.destroy=function(){window.removeEventListener("touchstart",d,!1);window.removeEventListener("touchend",e,!1);window.removeEventListener("touchmove",f,!1);window.removeEventListener("mousemove",f,!1);window.removeEventListener("mousedown",g,!1);window.removeEventListener("mouseup",k,!1);window.removeEventListener("DOMMouseScroll",m,!1);window.removeEventListener("mousewheel",m,!1)};this.init=function(){"undefined"!==typeof window&&(this.destroy(),window.addEventListener("touchstart",
d,!1),window.addEventListener("touchend",e,!1),window.addEventListener("touchmove",f,!1),window.addEventListener("mousemove",f,!1),window.addEventListener("mousedown",g,!1),window.addEventListener("mouseup",k,!1),window.addEventListener("DOMMouseScroll",m,!1),window.addEventListener("mousewheel",m,!1))};this.init()};var DAC_QUEUE_RESERVE=.2,AUDIOBUFFER_MINIMUM_SAMPLING_RATE=8E3;
function SpeakerAdapter(a){if("undefined"!==typeof window)if(window.AudioContext||window.webkitAudioContext){var b=window.AudioWorklet?SpeakerWorkletDAC:SpeakerBufferSourceDAC;this.bus=a;this.audio_context=new (window.AudioContext||window.webkitAudioContext);this.mixer=new SpeakerMixer(a,this.audio_context);this.pcspeaker=new PCSpeaker(a,this.audio_context,this.mixer);this.dac=new b(a,this.audio_context,this.mixer);this.pcspeaker.start();a.register("emulator-stopped",function(){this.audio_context.suspend()},
this);a.register("emulator-started",function(){this.audio_context.resume()},this);a.register("speaker-confirm-initialized",function(){a.send("speaker-has-initialized")},this);a.send("speaker-has-initialized")}else console.warn("Web browser doesn't support Web Audio API")}
function SpeakerMixer(a,b){function c(a){return function(b){a.gain.setValueAtTime(b,this.audio_context.currentTime)}}this.audio_context=b;this.sources=new Map;this.gain_right=this.gain_left=this.volume_right=this.volume_left=this.volume_both=1;this.node_treble_left=this.audio_context.createBiquadFilter();this.node_treble_right=this.audio_context.createBiquadFilter();this.node_treble_left.type="highshelf";this.node_treble_right.type="highshelf";this.node_treble_left.frequency.setValueAtTime(2E3,this.audio_context.currentTime);
this.node_treble_right.frequency.setValueAtTime(2E3,this.audio_context.currentTime);this.node_bass_left=this.audio_context.createBiquadFilter();this.node_bass_right=this.audio_context.createBiquadFilter();this.node_bass_left.type="lowshelf";this.node_bass_right.type="lowshelf";this.node_bass_left.frequency.setValueAtTime(200,this.audio_context.currentTime);this.node_bass_right.frequency.setValueAtTime(200,this.audio_context.currentTime);this.node_gain_left=this.audio_context.createGain();this.node_gain_right=
this.audio_context.createGain();this.node_merger=this.audio_context.createChannelMerger(2);this.input_left=this.node_treble_left;this.input_right=this.node_treble_right;this.node_treble_left.connect(this.node_bass_left);this.node_bass_left.connect(this.node_gain_left);this.node_gain_left.connect(this.node_merger,0,0);this.node_treble_right.connect(this.node_bass_right);this.node_bass_right.connect(this.node_gain_right);this.node_gain_right.connect(this.node_merger,0,1);this.node_merger.connect(this.audio_context.destination);
a.register("mixer-connect",function(a){this.connect_source(a[0],a[1])},this);a.register("mixer-disconnect",function(a){this.disconnect_source(a[0],a[1])},this);a.register("mixer-volume",function(a){var b=a[0],c=a[1];a=Math.pow(10,a[2]/20);var d=b===MIXER_SRC_MASTER?this:this.sources.get(b);void 0===d?dbg_assert(!1,"Mixer set volume - cannot set volume for undefined source: "+b):d.set_volume(a,c)},this);a.register("mixer-gain-left",function(a){this.gain_left=Math.pow(10,a/20);this.update()},this);
a.register("mixer-gain-right",function(a){this.gain_right=Math.pow(10,a/20);this.update()},this);a.register("mixer-treble-left",c(this.node_treble_left),this);a.register("mixer-treble-right",c(this.node_treble_right),this);a.register("mixer-bass-left",c(this.node_bass_left),this);a.register("mixer-bass-right",c(this.node_bass_right),this)}
SpeakerMixer.prototype.add_source=function(a,b){a=new SpeakerMixerSource(this.audio_context,a,this.input_left,this.input_right);dbg_assert(!this.sources.has(b),"Mixer add source - overwritting source: "+b);this.sources.set(b,a);return a};SpeakerMixer.prototype.connect_source=function(a,b){var c=this.sources.get(a);void 0===c?dbg_assert(!1,"Mixer connect - cannot connect undefined source: "+a):c.connect(b)};
SpeakerMixer.prototype.disconnect_source=function(a,b){var c=this.sources.get(a);void 0===c?dbg_assert(!1,"Mixer disconnect - cannot disconnect undefined source: "+a):c.disconnect(b)};SpeakerMixer.prototype.set_volume=function(a,b){void 0===b&&(b=MIXER_CHANNEL_BOTH);switch(b){case MIXER_CHANNEL_LEFT:this.volume_left=a;break;case MIXER_CHANNEL_RIGHT:this.volume_right=a;break;case MIXER_CHANNEL_BOTH:this.volume_both=a;break;default:dbg_assert(!1,"Mixer set master volume - unknown channel: "+b);return}this.update()};
SpeakerMixer.prototype.update=function(){var a=this.volume_both*this.volume_right*this.gain_right;this.node_gain_left.gain.setValueAtTime(this.volume_both*this.volume_left*this.gain_left,this.audio_context.currentTime);this.node_gain_right.gain.setValueAtTime(a,this.audio_context.currentTime)};
function SpeakerMixerSource(a,b,c,d){this.audio_context=a;this.connected_right=this.connected_left=!0;this.volume_right=this.volume_left=this.volume_both=this.gain_hidden=1;this.node_splitter=a.createChannelSplitter(2);this.node_gain_left=a.createGain();this.node_gain_right=a.createGain();b.connect(this.node_splitter);this.node_splitter.connect(this.node_gain_left,0);this.node_gain_left.connect(c);this.node_splitter.connect(this.node_gain_right,1);this.node_gain_right.connect(d)}
SpeakerMixerSource.prototype.update=function(){var a=this.connected_right*this.gain_hidden*this.volume_both*this.volume_right;this.node_gain_left.gain.setValueAtTime(this.connected_left*this.gain_hidden*this.volume_both*this.volume_left,this.audio_context.currentTime);this.node_gain_right.gain.setValueAtTime(a,this.audio_context.currentTime)};
SpeakerMixerSource.prototype.connect=function(a){var b=!a||a===MIXER_CHANNEL_BOTH;if(b||a===MIXER_CHANNEL_LEFT)this.connected_left=!0;if(b||a===MIXER_CHANNEL_RIGHT)this.connected_right=!0;this.update()};SpeakerMixerSource.prototype.disconnect=function(a){var b=!a||a===MIXER_CHANNEL_BOTH;if(b||a===MIXER_CHANNEL_LEFT)this.connected_left=!1;if(b||a===MIXER_CHANNEL_RIGHT)this.connected_right=!1;this.update()};
SpeakerMixerSource.prototype.set_volume=function(a,b){void 0===b&&(b=MIXER_CHANNEL_BOTH);switch(b){case MIXER_CHANNEL_LEFT:this.volume_left=a;break;case MIXER_CHANNEL_RIGHT:this.volume_right=a;break;case MIXER_CHANNEL_BOTH:this.volume_both=a;break;default:dbg_assert(!1,"Mixer set volume - unknown channel: "+b);return}this.update()};SpeakerMixerSource.prototype.set_gain_hidden=function(a){this.gain_hidden=a};
function PCSpeaker(a,b,c){this.node_oscillator=b.createOscillator();this.node_oscillator.type="square";this.node_oscillator.frequency.setValueAtTime(440,b.currentTime);this.mixer_connection=c.add_source(this.node_oscillator,MIXER_SRC_PCSPEAKER);this.mixer_connection.disconnect();a.register("pcspeaker-enable",function(){c.connect_source(MIXER_SRC_PCSPEAKER)},this);a.register("pcspeaker-disable",function(){c.disconnect_source(MIXER_SRC_PCSPEAKER)},this);a.register("pcspeaker-update",function(a){var c=
a[1],d=0;3===a[0]&&(d=1E3*OSCILLATOR_FREQ/c,d=Math.min(d,this.node_oscillator.frequency.maxValue),d=Math.max(d,0));this.node_oscillator.frequency.setValueAtTime(d,b.currentTime)},this)}PCSpeaker.prototype.start=function(){this.node_oscillator.start()};
function SpeakerWorkletDAC(a,b,c){var d=this;this.bus=a;this.audio_context=b;this.enabled=!1;this.sampling_rate=48E3;b=function(){function a(a){if(0===a)return 1;a*=Math.PI;return Math.sin(a)/a}function b(){var a=Reflect.construct(AudioWorkletProcessor,[],b);a.kernel_size=3;a.queue_data=Array(1024);a.queue_start=0;a.queue_end=0;a.queue_length=0;a.queue_size=a.queue_data.length;a.queued_samples=0;a.source_buffer_previous=c;a.source_buffer_current=c;a.source_samples_per_destination=1;a.source_block_start=
0;a.source_time=0;a.source_offset=0;a.port.onmessage=function(b){switch(b.data.type){case "queue":a.queue_push(b.data.value);break;case "sampling-rate":a.source_samples_per_destination=b.data.value/sampleRate}};return a}var c=[new Float32Array(256),new Float32Array(256)];Reflect.setPrototypeOf(b.prototype,AudioWorkletProcessor.prototype);Reflect.setPrototypeOf(b,AudioWorkletProcessor);b.prototype.process=b.prototype.process=function(a,b,c){for(a=0;a<b[0][0].length;a++){for(var d=c=0,e=this.source_offset+
this.kernel_size,f=this.source_offset-this.kernel_size+1;f<=e;f++){var g=this.source_block_start+f;c+=this.get_sample(g,0)*this.kernel(this.source_time-f);d+=this.get_sample(g,1)*this.kernel(this.source_time-f)}if(isNaN(c)||isNaN(d))c=d=0,this.dbg_log("ERROR: NaN values! Ignoring for now.");b[0][0][a]=c;b[0][1][a]=d;this.source_time+=this.source_samples_per_destination;this.source_offset=Math.floor(this.source_time)}b=this.source_offset;b+=this.kernel_size+2;this.source_time-=this.source_offset;this.source_block_start+=
this.source_offset;this.source_offset=0;this.ensure_enough_data(b);return!0};b.prototype.kernel=function(b){return a(b)*a(b/this.kernel_size)};b.prototype.get_sample=function(a,b){return 0>a?(a+=this.source_buffer_previous[0].length,this.source_buffer_previous[b][a]):this.source_buffer_current[b][a]};b.prototype.ensure_enough_data=function(a){var b=this.source_buffer_current[0].length;b-this.source_block_start<a&&(this.prepare_next_buffer(),this.source_block_start-=b)};b.prototype.prepare_next_buffer=
function(){256>this.queued_samples&&this.queue_length&&this.dbg_log("Not enough samples - should not happen during midway of playback");this.source_buffer_previous=this.source_buffer_current;this.source_buffer_current=this.queue_shift();var a=this.source_buffer_current[0].length;if(256>a){for(var b=this.queue_start,c=0;256>a&&c<this.queue_length;)a+=this.queue_data[b][0].length,b=b+1&this.queue_size-1,c++;a=Math.max(a,256);a=[new Float32Array(a),new Float32Array(a)];a[0].set(this.source_buffer_current[0]);
a[1].set(this.source_buffer_current[1]);b=this.source_buffer_current[0].length;for(var d=0;d<c;d++){var e=this.queue_shift();a[0].set(e[0],b);a[1].set(e[1],b);b+=e[0].length}this.source_buffer_current=a}this.pump()};b.prototype.pump=function(){1024>this.queued_samples/this.source_samples_per_destination&&this.port.postMessage({type:"pump"})};b.prototype.queue_push=function(a){this.queue_length<this.queue_size&&(this.queue_data[this.queue_end]=a,this.queue_end=this.queue_end+1&this.queue_size-1,this.queue_length++,
this.queued_samples+=a[0].length,this.pump())};b.prototype.queue_shift=function(){if(!this.queue_length)return c;var a=this.queue_data[this.queue_start];this.queue_data[this.queue_start]=null;this.queue_start=this.queue_start+1&this.queue_size-1;this.queue_length--;this.queued_samples-=a[0].length;return a};b.prototype.dbg_log=function(a){DEBUG&&this.port.postMessage({type:"debug-log",value:a})};registerProcessor("dac-processor",b)}.toString();var e=b.indexOf("{")+1,f=b.lastIndexOf("}");b=b.substring(e,
f);DEBUG&&(b="var DEBUG = true;\n"+b);b=new Blob([b],{type:"application/javascript"});var g=URL.createObjectURL(b);this.node_processor=null;this.node_output=this.audio_context.createGain();this.audio_context.audioWorklet.addModule(g).then(function(){URL.revokeObjectURL(g);d.node_processor=new AudioWorkletNode(d.audio_context,"dac-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]});d.node_processor.port.postMessage({type:"sampling-rate",value:d.sampling_rate});d.node_processor.port.onmessage=
function(a){switch(a.data.type){case "pump":d.pump();break;case "debug-log":dbg_log("SpeakerWorkletDAC - Worklet: "+a.data.value)}};d.node_processor.connect(d.node_output)});this.mixer_connection=c.add_source(this.node_output,MIXER_SRC_DAC);this.mixer_connection.set_gain_hidden(3);a.register("dac-send-data",function(a){this.queue(a)},this);a.register("dac-enable",function(a){this.enabled=!0},this);a.register("dac-disable",function(){this.enabled=!1},this);a.register("dac-tell-sampling-rate",function(a){dbg_assert(0<
a,"Sampling rate should be nonzero");this.sampling_rate=a;this.node_processor&&this.node_processor.port.postMessage({type:"sampling-rate",value:a})},this);DEBUG&&(this.debugger=new SpeakerDACDebugger(this.audio_context,this.node_output))}SpeakerWorkletDAC.prototype.queue=function(a){this.node_processor&&(DEBUG&&this.debugger.push_queued_data(a),this.node_processor.port.postMessage({type:"queue",value:a},[a[0].buffer,a[1].buffer]))};SpeakerWorkletDAC.prototype.pump=function(){this.enabled&&this.bus.send("dac-request-data")};
function SpeakerBufferSourceDAC(a,b,c){this.bus=a;this.audio_context=b;this.enabled=!1;this.sampling_rate=22050;this.buffered_time=0;this.rate_ratio=1;this.node_lowpass=this.audio_context.createBiquadFilter();this.node_lowpass.type="lowpass";this.node_output=this.node_lowpass;this.mixer_connection=c.add_source(this.node_output,MIXER_SRC_DAC);this.mixer_connection.set_gain_hidden(3);a.register("dac-send-data",function(a){this.queue(a)},this);a.register("dac-enable",function(a){this.enabled=!0;this.pump()},
this);a.register("dac-disable",function(){this.enabled=!1},this);a.register("dac-tell-sampling-rate",function(a){dbg_assert(0<a,"Sampling rate should be nonzero");this.sampling_rate=a;this.rate_ratio=Math.ceil(AUDIOBUFFER_MINIMUM_SAMPLING_RATE/a);this.node_lowpass.frequency.setValueAtTime(a/2,this.audio_context.currentTime)},this);DEBUG&&(this.debugger=new SpeakerDACDebugger(this.audio_context,this.node_output))}
SpeakerBufferSourceDAC.prototype.queue=function(a){var b=this;DEBUG&&this.debugger.push_queued_data(a);var c=a[0].length,d=c/this.sampling_rate;if(1<this.rate_ratio){var e=this.audio_context.createBuffer(2,c*this.rate_ratio,this.sampling_rate*this.rate_ratio);for(var f=e.getChannelData(0),g=e.getChannelData(1),k=0,l=0;l<c;l++)for(var m=0;m<this.rate_ratio;m++,k++)f[k]=a[0][l],g[k]=a[1][l]}else e=this.audio_context.createBuffer(2,c,this.sampling_rate),e.copyToChannel(a[0],0),e.copyToChannel(a[1],1);
a=this.audio_context.createBufferSource();a.buffer=e;a.connect(this.node_lowpass);a.addEventListener("ended",this.pump.bind(this));e=this.audio_context.currentTime;if(this.buffered_time<e)for(dbg_log("Speaker DAC - Creating/Recreating reserve - shouldn't occur frequently during playback"),this.buffered_time=e,e=DAC_QUEUE_RESERVE-d,c=0;c<=e;)c+=d,this.buffered_time+=d,setTimeout(function(){return b.pump()},1E3*c);a.start(this.buffered_time);this.buffered_time+=d;setTimeout(function(){return b.pump()},
0)};SpeakerBufferSourceDAC.prototype.pump=function(){this.enabled&&(this.buffered_time-this.audio_context.currentTime>DAC_QUEUE_RESERVE||this.bus.send("dac-request-data"))};
function SpeakerDACDebugger(a,b){this.audio_context=a;this.node_source=b;this.node_processor=null;this.node_gain=this.audio_context.createGain();this.node_gain.gain.setValueAtTime(0,this.audio_context.currentTime);this.node_gain.connect(this.audio_context.destination);this.is_active=!1;this.queued_history=[];this.output_history=[];this.queued=[[],[]];this.output=[[],[]]}
SpeakerDACDebugger.prototype.start=function(a){var b=this;this.is_active=!0;this.queued=[[],[]];this.output=[[],[]];this.queued_history.push(this.queued);this.output_history.push(this.output);this.node_processor=this.audio_context.createScriptProcessor(1024,2,2);this.node_processor.onaudioprocess=function(a){b.output[0].push(a.inputBuffer.getChannelData(0).slice());b.output[1].push(a.inputBuffer.getChannelData(1).slice())};this.node_source.connect(this.node_processor);this.node_processor.connect(this.node_gain);
setTimeout(function(){b.stop()},a)};SpeakerDACDebugger.prototype.stop=function(){this.is_active=!1;this.node_source.disconnect(this.node_processor);this.node_processor.disconnect();this.node_processor=null};SpeakerDACDebugger.prototype.push_queued_data=function(a){this.is_active&&(this.queued[0].push(a[0].slice()),this.queued[1].push(a[1].slice()))};SpeakerDACDebugger.prototype.download_txt=function(a,b){a=this.output_history[a][b].map(function(a){return a.join(" ")}).join(" ");dump_file(a,"dacdata.txt")};
SpeakerDACDebugger.prototype.download_csv=function(a){a=this.output_history[a];for(var b=[],c=0;c<a[0].length;c++)for(var d=0;d<a[0][c].length;d++)b.push(a[0][c][d]+","+a[1][c][d]);dump_file(b.join("\n"),"dacdata.csv")};function SerialAdapter(a,b){function c(a){g.bus&&g.enabled&&(g.send_char(a.which),a.preventDefault())}function d(a){var b=a.which;8===b?(g.send_char(127),a.preventDefault()):9===b&&(g.send_char(9),a.preventDefault())}function e(a){if(g.enabled){for(var b=a.clipboardData.getData("text/plain"),c=0;c<b.length;c++)g.send_char(b.charCodeAt(c));a.preventDefault()}}function f(b){b.target!==a&&a.blur()}var g=this;this.enabled=!0;this.bus=b;this.text="";this.text_new_line=!1;this.last_update=0;this.bus.register("serial0-output-char",
function(a){this.show_char(a)},this);this.destroy=function(){a.removeEventListener("keypress",c,!1);a.removeEventListener("keydown",d,!1);a.removeEventListener("paste",e,!1);window.removeEventListener("mousedown",f,!1)};this.init=function(){this.destroy();a.addEventListener("keypress",c,!1);a.addEventListener("keydown",d,!1);a.addEventListener("paste",e,!1);window.addEventListener("mousedown",f,!1)};this.init();this.show_char=function(a){"\b"===a?(this.text=this.text.slice(0,-1),this.update()):"\r"!==
a&&(this.text+=a,"\n"===a&&(this.text_new_line=!0),this.update())};this.update=function(){var a=this,b=Date.now(),c=b-this.last_update;16>c?void 0===this.update_timer&&(this.update_timer=setTimeout(function(){a.update_timer=void 0;var b=Date.now();dbg_assert(16<=b-a.last_update);a.last_update=b;a.render()},16-c)):(void 0!==this.update_timer&&(clearTimeout(this.update_timer),this.update_timer=void 0),this.last_update=b,this.render())};this.render=function(){a.value=this.text;this.text_new_line&&(this.text_new_line=
!1,a.scrollTop=1E9)};this.send_char=function(a){g.bus&&g.bus.send("serial0-input",a)}};function NetworkAdapter(a,b){this.send_data=function(a){};this.bus=b;this.socket=void 0;this.send_queue=[];this.url=a;this.reconnect_interval=1E4;this.last_connect_attempt=Date.now()-this.reconnect_interval;this.send_queue_limit=64;this.bus.register("net0-send",function(a){this.send(a)},this)}NetworkAdapter.prototype.handle_message=function(a){this.bus&&this.bus.send("net0-receive",new Uint8Array(a.data))};
NetworkAdapter.prototype.handle_close=function(a){this.connect();setTimeout(this.connect.bind(this),this.reconnect_interval)};NetworkAdapter.prototype.handle_open=function(a){for(a=0;a<this.send_queue.length;a++)this.send(this.send_queue[a]);this.send_queue=[]};NetworkAdapter.prototype.handle_error=function(a){};NetworkAdapter.prototype.destroy=function(){this.socket&&this.socket.close()};
NetworkAdapter.prototype.connect=function(){if(this.socket){var a=this.socket.readyState;if(0===a||1===a)return}a=Date.now();if(!(this.last_connect_attempt+this.reconnect_interval>a)){this.last_connect_attempt=Date.now();try{this.socket=new WebSocket(this.url)}catch(b){this.handle_close(void 0);return}this.socket.binaryType="arraybuffer";this.socket.onopen=this.handle_open.bind(this);this.socket.onmessage=this.handle_message.bind(this);this.socket.onclose=this.handle_close.bind(this);this.socket.onerror=
this.handle_error.bind(this)}};NetworkAdapter.prototype.send=function(a){this.socket&&1===this.socket.readyState?this.socket.send(a):(this.send_queue.push(a),this.send_queue.length>2*this.send_queue_limit&&(this.send_queue=this.send_queue.slice(-this.send_queue_limit)),this.connect())};var ASYNC_SAFE=!1;
(function(){function a(a,b){var c=new XMLHttpRequest;c.open(b.method||"get",a,!0);b.as_text||(c.responseType="arraybuffer");if(b.headers)for(var d=Object.keys(b.headers),e=0;e<d.length;e++){var f=d[e];c.setRequestHeader(f,b.headers[f])}b.range&&(d=b.range.start,c.setRequestHeader("Range","bytes="+d+"-"+(d+b.range.length-1)));c.onload=function(d){4===c.readyState&&(200!==c.status&&206!==c.status?console.error("Loading the image `"+a+"` failed (status %d)",c.status):c.response&&b.done&&b.done(c.response,
c))};b.progress&&(c.onprogress=function(a){b.progress(a)});c.send(null)}function b(a,b){var c=require("fs");b.range?(dbg_assert(!b.as_text),c.open(a,"r",function(a,d){if(a)throw a;var e=b.range.length,f=new global.Buffer(e);c.read(d,f,0,e,b.range.start,function(a,g){if(a)throw a;dbg_assert(g===e);b.done&&b.done(new Uint8Array(f));c.close(d,function(a){if(a)throw a;})})})):c.readFile(a,{encoding:b.as_text?"utf-8":null},function(c,d){c?console.log("Could not read file:",a,c):(c=d,b.as_text||(c=(new Uint8Array(c)).buffer),
b.done(c))})}function c(a,b){this.filename=a;this.block_size=256;this.byteLength=b;this.loaded_blocks={};this.onprogress=this.onload=void 0}function d(a){this.file=a;this.byteLength=a.size;1073741824<a.size&&console.warn("SyncFileBuffer: Allocating buffer of "+(a.size>>20)+" MB ...");this.buffer=new ArrayBuffer(a.size);this.onprogress=this.onload=void 0}function e(a){this.file=a;this.byteLength=a.size;this.block_size=256;this.loaded_blocks={};this.onprogress=this.onload=void 0}v86util.load_file="undefined"===
typeof XMLHttpRequest?b:a;v86util.AsyncXHRBuffer=c;v86util.AsyncFileBuffer=e;v86util.SyncFileBuffer=d;var f="undefined"===typeof XMLHttpRequest?function(a,b){require("fs").stat(a,function(a,c){a?b(a):b(null,c.size)})}:function(a,b){v86util.load_file(a,{done:function(a,c){a=c.getResponseHeader("Content-Range")||"";(c=a.match(/\/(\d+)\s*$/))?b(null,+c[1]):b({header:a})},headers:{Range:"bytes=0-0"}})};c.prototype.load=function(){var a=this;void 0!==this.byteLength?this.onload&&this.onload({}):f(this.filename,
function(b,c){b?console.assert(!1,"Cannot use: "+a.filename+". `Range: bytes=...` header not supported (Got `"+b.header+"`)"):(dbg_assert(0<=c),a.byteLength=c,a.onload&&a.onload({}))})};c.prototype.get_from_cache=function(a,b,c){c=b/this.block_size;a/=this.block_size;for(var d=0;d<c;d++)if(!this.loaded_blocks[a+d])return;if(1===c)return this.loaded_blocks[a];b=new Uint8Array(b);for(d=0;d<c;d++)b.set(this.loaded_blocks[a+d],d*this.block_size);return b};c.prototype.get=function(a,b,c){console.assert(a+
b<=this.byteLength);console.assert(0===a%this.block_size);console.assert(0===b%this.block_size);console.assert(b);var d=this.get_from_cache(a,b,c);d?ASYNC_SAFE?setTimeout(c.bind(this,d),0):c(d):v86util.load_file(this.filename,{done:function(d){d=new Uint8Array(d);this.handle_read(a,b,d);c(d)}.bind(this),range:{start:a,length:b}})};c.prototype.set=function(a,b,c){console.assert(a+b.byteLength<=this.byteLength);var d=b.length;console.assert(0===a%this.block_size);console.assert(0===d%this.block_size);
console.assert(d);a/=this.block_size;d/=this.block_size;for(var e=0;e<d;e++){var f=this.loaded_blocks[a+e];void 0===f&&(f=this.loaded_blocks[a+e]=new Uint8Array(this.block_size));var g=b.subarray(e*this.block_size,(e+1)*this.block_size);f.set(g);console.assert(f.byteLength===g.length)}c()};c.prototype.handle_read=function(a,b,c){a/=this.block_size;b/=this.block_size;for(var d=0;d<b;d++){var e=this.loaded_blocks[a+d];e&&c.set(e,d*this.block_size)}};c.prototype.get_buffer=function(a){a()};c.prototype.get_written_blocks=
function(){var a=0;for(b in this.loaded_blocks)a++;a=new Uint8Array(a*this.block_size);var b=[];var c=0;for(e in this.loaded_blocks){var d=this.loaded_blocks[e];dbg_assert(d.length===this.block_size);var e=+e;b.push(e);a.set(d,c*this.block_size);c++}return{buffer:a,indices:b,block_size:this.block_size}};d.prototype.load=function(){this.load_next(0)};d.prototype.load_next=function(a){var b=new FileReader;b.onload=function(b){b=new Uint8Array(b.target.result);(new Uint8Array(this.buffer,a)).set(b);
this.load_next(a+4194304)}.bind(this);if(this.onprogress)this.onprogress({loaded:a,total:this.byteLength,lengthComputable:!0});if(a<this.byteLength){var c=this.file.slice(a,Math.min(a+4194304,this.byteLength));b.readAsArrayBuffer(c)}else this.file=void 0,this.onload&&this.onload({buffer:this.buffer})};d.prototype.get=function(a,b,c){console.assert(a+b<=this.byteLength);c(new Uint8Array(this.buffer,a,b))};d.prototype.set=function(a,b,c){console.assert(a+b.byteLength<=this.byteLength);(new Uint8Array(this.buffer,
a,b.byteLength)).set(b);c()};d.prototype.get_buffer=function(a){a(this.buffer)};e.prototype.load=function(){this.onload&&this.onload({})};e.prototype.get=function(a,b,c){console.assert(0===a%this.block_size);console.assert(0===b%this.block_size);console.assert(b);var d=this.get_from_cache(a,b,c);d?c(d):(d=new FileReader,d.onload=function(d){d=new Uint8Array(d.target.result);this.handle_read(a,b,d);c(d)}.bind(this),d.readAsArrayBuffer(this.file.slice(a,a+b)))};e.prototype.get_from_cache=c.prototype.get_from_cache;
e.prototype.set=c.prototype.set;e.prototype.handle_read=c.prototype.handle_read;e.prototype.get_buffer=function(a){a()};e.prototype.get_as_file=function(a){for(var b=[],c=Object.keys(this.loaded_blocks).map(Number).sort(function(a,b){return a-b}),d=0,e=0;e<c.length;e++){var f=c[e],g=this.loaded_blocks[f];f*=this.block_size;console.assert(f>=d);f!==d&&(b.push(this.file.slice(d,f)),d=f);b.push(g);d+=g.length}d!==this.file.size&&b.push(this.file.slice(d));a=new File(b,a);console.assert(a.size===this.file.size);
return a}})();function V86Starter(a){function b(a,b){switch(a){case "hda":k.hda=this.disk_images.hda=b;break;case "hdb":k.hdb=this.disk_images.hdb=b;break;case "cdrom":k.cdrom=this.disk_images.cdrom=b;break;case "fda":k.fda=this.disk_images.fda=b;break;case "fdb":k.fdb=this.disk_images.fdb=b;break;case "multiboot":k.multiboot=this.disk_images.multiboot=b;break;case "bios":k.bios=b.buffer;break;case "vga_bios":k.vga_bios=b.buffer;break;case "initial_state":k.initial_state=b.buffer;break;case "fs9p_json":k.fs9p_json=
b.buffer;break;default:dbg_assert(!1,a)}}function c(a,b){if(b)if(b.get&&b.set&&b.load)l.push({name:a,loadable:b});else{b={buffer:b.buffer,async:b.async,url:b.url,size:b.size};if("bios"===a||"vga_bios"===a||"initial_state"===a||"multiboot"===a)b.async=!1;b.buffer instanceof ArrayBuffer?(b=new SyncBuffer(b.buffer),l.push({name:a,loadable:b})):"undefined"!==typeof File&&b.buffer instanceof File?(void 0===b.async&&(b.async=268435456<=b.buffer.size),b=b.async?new v86util.AsyncFileBuffer(b.buffer):new v86util.SyncFileBuffer(b.buffer),
l.push({name:a,loadable:b})):b.url?b.async?(b=new v86util.AsyncXHRBuffer(b.url,b.size),l.push({name:a,loadable:b})):l.push({name:a,url:b.url,size:b.size}):dbg_log("Ignored file: url="+b.url+" buffer="+b.buffer)}}function d(){k.initial_state&&(k.memory_size=0);this.bus.send("cpu-init",k);setTimeout(function(){k.initial_state&&g.restore_state(k.initial_state);setTimeout(function(){k.fs9p&&k.fs9p_json&&k.fs9p.OnJSONLoaded(k.fs9p_json);a.autostart&&this.bus.send("cpu-run")}.bind(this),0)}.bind(this),
0)}this.cpu_is_running=!1;var e=Bus.create(),f=this.bus=e[0];this.emulator_bus=e[1];var g=this.v86=new v86(this.emulator_bus);this.bus.register("emulator-stopped",function(){this.cpu_is_running=!1},this);this.bus.register("emulator-started",function(){this.cpu_is_running=!0},this);var k={};this.disk_images={fda:void 0,fdb:void 0,hda:void 0,hdb:void 0,cdrom:void 0};k.load_devices=!0;k.memory_size=a.memory_size||67108864;k.vga_memory_size=a.vga_memory_size||8388608;k.boot_order=a.boot_order||531;k.fastboot=
a.fastboot||!1;k.fda=void 0;k.fdb=void 0;a.network_relay_url&&(this.network_adapter=new NetworkAdapter(a.network_relay_url,f),k.enable_ne2k=!0);a.disable_keyboard||(this.keyboard_adapter=new KeyboardAdapter(f));a.disable_mouse||(this.mouse_adapter=new MouseAdapter(f,a.screen_container));a.screen_container?this.screen_adapter=new ScreenAdapter(a.screen_container,f):a.screen_dummy&&(this.screen_adapter=new DummyScreenAdapter(f));a.serial_container&&(this.serial_adapter=new SerialAdapter(a.serial_container,
f));a.disable_speaker||(this.speaker_adapter=new SpeakerAdapter(f));var l=[];e="bios vga_bios cdrom hda hdb fda fdb initial_state multiboot".split(" ");for(f=0;f<e.length;f++)c(e[f],a[e[f]]);a.filesystem&&(k.fs9p=a.filesystem);var m=this,p=l.length,n=function(a){if(a===p)setTimeout(d.bind(this),0);else{var c=l[a];c.loadable?(c.loadable.onload=function(d){b.call(this,c.name,c.loadable);n(a+1)}.bind(this),c.loadable.load()):v86util.load_file(c.url,{done:function(d){b.call(this,c.name,new SyncBuffer(d));
n(a+1)}.bind(this),progress:function(b){200===b.target.status?m.emulator_bus.send("download-progress",{file_index:a,file_count:p,file_name:c.url,lengthComputable:b.lengthComputable,total:b.total||c.size,loaded:b.loaded}):m.emulator_bus.send("download-error",{file_index:a,file_count:p,file_name:c.url,request:b.target})},as_text:c.as_text})}}.bind(this);n(0)}V86Starter.prototype.run=function(){this.bus.send("cpu-run")};goog.exportProperty(V86Starter.prototype,"run",V86Starter.prototype.run);
V86Starter.prototype.stop=function(){this.bus.send("cpu-stop")};goog.exportProperty(V86Starter.prototype,"stop",V86Starter.prototype.stop);V86Starter.prototype.destroy=function(){this.keyboard_adapter.destroy()};goog.exportProperty(V86Starter.prototype,"destroy",V86Starter.prototype.destroy);V86Starter.prototype.restart=function(){this.bus.send("cpu-restart")};goog.exportProperty(V86Starter.prototype,"restart",V86Starter.prototype.restart);
V86Starter.prototype.add_listener=function(a,b){this.bus.register(a,b,this)};goog.exportProperty(V86Starter.prototype,"add_listener",V86Starter.prototype.add_listener);V86Starter.prototype.remove_listener=function(a,b){this.bus.unregister(a,b)};goog.exportProperty(V86Starter.prototype,"remove_listener",V86Starter.prototype.remove_listener);V86Starter.prototype.restore_state=function(a){this.v86.restore_state(a)};goog.exportProperty(V86Starter.prototype,"restore_state",V86Starter.prototype.restore_state);
V86Starter.prototype.save_state=function(a){setTimeout(function(){try{a(null,this.v86.save_state())}catch(b){a(b,null)}}.bind(this),0)};goog.exportProperty(V86Starter.prototype,"save_state",V86Starter.prototype.save_state);V86Starter.prototype.is_running=function(){return this.cpu_is_running};goog.exportProperty(V86Starter.prototype,"is_running",V86Starter.prototype.is_running);V86Starter.prototype.serial0_send=function(a){for(var b=0;b<a.length;b++)this.bus.send("serial0-input",a.charCodeAt(b))};
goog.exportProperty(V86Starter.prototype,"serial0_send",V86Starter.prototype.serial0_send);"undefined"!==typeof module&&"undefined"!==typeof module.exports?(module.exports.V86Starter=V86Starter,module.exports.V86=V86Starter):(self.V86Starter=V86Starter,self.V86=V86Starter);var WorkerBus={Connector:function(a){this.listeners={};this.pair=a;a.addEventListener("message",function(a){a=a.data;for(var b=this.listeners[a[0]],d=0;d<b.length;d++){var e=b[d];e.fn.call(e.this_value,a[1])}}.bind(this),!1)}};WorkerBus.Connector.prototype.register=function(a,b,c){var d=this.listeners[a];void 0===d&&(d=this.listeners[a]=[]);d.push({fn:b,this_value:c})};WorkerBus.Connector.prototype.send=function(a,b,c){dbg_assert(1<=arguments.length);this.pair&&this.pair.postMessage([a,b],c)};
WorkerBus.init=function(a){return new WorkerBus.Connector(a)};function DummyScreenAdapter(a){var b,c,d,e,f,g,k;this.bus=a;a.register("screen-set-mode",function(a){this.set_mode(a)},this);a.register("screen-fill-buffer-end",function(a){this.update_buffer(a[0],a[1])},this);a.register("screen-put-char",function(a){this.put_char(a[0],a[1],a[2],a[3],a[4])},this);a.register("screen-text-scroll",function(a){console.log("scroll",a)},this);a.register("screen-update-cursor",function(a){this.update_cursor(a[0],a[1])},this);a.register("screen-update-cursor-scanline",function(a){this.update_cursor_scanline(a[0],
a[1])},this);a.register("screen-set-size-text",function(a){this.set_size_text(a[0],a[1])},this);a.register("screen-set-size-graphical",function(a){this.set_size_graphical(a[0],a[1])},this);this.put_char=function(a,b,c,d,e){a<k&&b<g&&(a=3*(a*g+b),f[a]=c,f[a+1]=d,f[a+2]=e)};this.destroy=function(){};this.set_mode=function(a){};this.clear_screen=function(){};this.set_size_text=function(a,b){if(a!==g||b!==k)f=new Int32Array(a*b*3),g=a,k=b};this.set_size_graphical=function(a,d){b=new Uint8Array(4*a*d);
c=new Int32Array(b.buffer);this.bus.send("screen-tell-buffer",[c],[c.buffer])};this.set_scale=function(a,b){};this.update_cursor_scanline=function(a,b){};this.update_cursor=function(a,b){if(a!==d||b!==e)d=a,e=b};this.update_buffer=function(a,b){};this.get_text_screen=function(){for(var a=[],b=0;b<k;b++)a.push(this.get_text_row(b));return a};this.get_text_row=function(a){var b="";a=3*a*g;for(var c=0;c<g;c++)b+=String.fromCharCode(f[a+3*c]);return b}};var VIRTIO_MAGIC_REG=0,VIRTIO_VERSION_REG=4,VIRTIO_DEVICE_REG=8,VIRTIO_VENDOR_REG=12,VIRTIO_HOSTFEATURES_REG=16,VIRTIO_HOSTFEATURESSEL_REG=20,VIRTIO_GUESTFEATURES_REG=32,VIRTIO_GUESTFEATURESSEL_REG=36,VIRTIO_GUEST_PAGE_SIZE_REG=40,VIRTIO_QUEUESEL_REG=48,VIRTIO_QUEUENUMMAX_REG=52,VIRTIO_QUEUENUM_REG=56,VIRTIO_QUEUEALIGN_REG=60,VIRTIO_QUEUEPFN_REG=64,VIRTIO_QUEUENOTIFY_REG=80,VIRTIO_INTERRUPTSTATUS_REG=96,VIRTIO_INTERRUPTACK_REG=100,VIRTIO_STATUS_REG=112,VRING_DESC_F_NEXT=1,VRING_DESC_F_WRITE=2,VRING_DESC_F_INDIRECT=
4;function hex8(a){return h(a)}var message={Debug:function(a){dbg_log([].slice.apply(arguments).join(" "),LOG_9P)},Abort:function(){if(DEBUG)throw"abort";}},LoadBinaryResource;
LoadBinaryResource="undefined"!==typeof XMLHttpRequest?function(a,b,c){var d=new XMLHttpRequest;d.open("GET",a,!0);d.responseType="arraybuffer";d.onreadystatechange=function(){if(4==d.readyState)if(200!=d.status&&0!=d.status)c("Error: Could not load file "+a);else{var e=d.response;e?b(e):c("Error: No data received from: "+a)}};d.send(null)}:function(a,b,c){require("fs").readFile(a,function(a,e){a?c(a):b((new Uint8Array(e)).buffer)})};var marshall={Marshall:function(a,b,c,d){for(var e,f=0,g=0;g<a.length;g++)switch(e=b[g],a[g]){case "w":c[d++]=e&255;c[d++]=e>>8&255;c[d++]=e>>16&255;c[d++]=e>>24&255;f+=4;break;case "d":c[d++]=e&255;c[d++]=e>>8&255;c[d++]=e>>16&255;c[d++]=e>>24&255;c[d++]=0;c[d++]=0;c[d++]=0;c[d++]=0;f+=8;break;case "h":c[d++]=e&255;c[d++]=e>>8;f+=2;break;case "b":c[d++]=e;f+=1;break;case "s":var k=d,l=0;c[d++]=0;c[d++]=0;f+=2;for(var m in e)UnicodeToUTF8Stream(e.charCodeAt(m)).forEach(function(a){c[d++]=a;f+=1;l++});
c[k+0]=l&255;c[k+1]=l>>8&255;break;case "Q":marshall.Marshall(["b","w","d"],[e.type,e.version,e.path],c,d);d+=13;f+=13;break;default:message.Debug("Marshall: Unknown type="+a[g])}return f},Unmarshall:function(a,b,c){for(var d=[],e=0;e<a.length;e++)switch(a[e]){case "w":var f=b[c++];f+=b[c++]<<8;f+=b[c++]<<16;f+=b[c++]<<24>>>0;d.push(f);break;case "d":f=b[c++];f+=b[c++]<<8;f+=b[c++]<<16;f+=b[c++]<<24>>>0;c+=4;d.push(f);break;case "h":f=b[c++];d.push(f+(b[c++]<<8));break;case "b":d.push(b[c++]);break;
case "s":f=b[c++];f+=b[c++]<<8;for(var g="",k=new UTF8StreamToUnicode,l=0;l<f;l++){var m=k.Put(b[c++]);-1!=m&&(g+=String.fromCharCode(m))}d.push(g);break;default:message.Debug("Error in Unmarshall: Unknown type="+a[e])}return d},Unmarshall2:function(a,b){for(var c=[],d=0;d<a.length;d++)switch(a[d]){case "w":var e=b();e+=b()<<8;e+=b()<<16;e+=b()<<24>>>0;c.push(e);break;case "d":e=b();e+=b()<<8;e+=b()<<16;e+=b()<<24>>>0;b();b();b();b();c.push(e);break;case "h":e=b();c.push(e+(b()<<8));break;case "b":c.push(b());
break;case "s":e=b();e+=b()<<8;for(var f="",g=new UTF8StreamToUnicode,k=0;k<e;k++){var l=g.Put(b());-1!=l&&(f+=String.fromCharCode(l))}c.push(f);break;default:message.Debug("Error in Unmarshall2: Unknown type="+a[d])}return c}};var UTF8={};function UTF8StreamToUnicode(){this.stream=new Uint8Array(5);this.ofs=0;this.Put=function(a){this.stream[this.ofs]=a;this.ofs++;switch(this.ofs){case 1:if(128>this.stream[0])return this.ofs=0,this.stream[0];break;case 2:if(192==(this.stream[0]&224)&&128==(this.stream[1]&192))return this.ofs=0,(this.stream[0]&31)<<6|this.stream[1]&63}return-1}}function UnicodeToUTF8Stream(a){if(128>a)return[a];if(2048>a)return[192|a>>6&31,128|a&63]}
UTF8.UTF8Length=function(a){for(var b=0,c=0;c<a.length;c++){var d=a.charCodeAt(c);b+=128>d?1:2}return b};}).call(this);

},{"fs":"../../../.nvm/versions/node/v14.16.1/lib/node_modules/parcel-bundler/src/builtins/_empty.js"}],"dtsnapshot.js":[function(require,module,exports) {
'use strict';

var _require = require('./dtconfig'),
    dtSnapshotsCache = _require.dtSnapshotsCache,
    snapshotUrl = _require.snapshotUrl;

var getSnapshotUrl = function getSnapshotUrl() {
  return new URL(snapshotUrl, window.location);
}; // check for the last snapshot available.


var getSnapshot = function getSnapshot() {
  return caches.open(dtSnapshotsCache).then(function (cache) {
    return cache.match(getSnapshotUrl());
  });
}; // Check for the digital twin snapshot availability


var hasSnapshot = function hasSnapshot() {
  return getSnapshot().then(function (res) {
    return !!res;
  });
}; // Saving the digital twin state as snapshot.


var saveSnapshot = function saveSnapshot(err, state) {
  var blob = new Blob([new Uint8Array(state)], {
    type: 'application/octet-stream'
  });
  var res = new Response(blob, {
    status: 200,
    statusText: 'OK, The DT snapshot has been created.'
  });
  var header = new Headers();
  header.append('Content-Type', 'application/octet-stream');
  header.append('Content-Length', blob.size);
  var url = getSnapshotUrl();
  var req = new Request(url, {
    method: 'GET',
    header: header
  });
  caches.open(dtSnapshotsCache).then(function (cache) {
    return cache.put(req, res);
  }).catch(function (err) {
    return console.error(err);
  });
};

module.exports = {
  getSnapshot: getSnapshot,
  hasSnapshot: hasSnapshot,
  saveSnapshot: saveSnapshot
};
},{"./dtconfig":"dtconfig.js"}],"../node_modules/regenerator-runtime/runtime.js":[function(require,module,exports) {
var define;
/**
 * Copyright (c) 2014-present, Facebook, Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */

var runtime = (function (exports) {
  "use strict";

  var Op = Object.prototype;
  var hasOwn = Op.hasOwnProperty;
  var undefined; // More compressible than void 0.
  var $Symbol = typeof Symbol === "function" ? Symbol : {};
  var iteratorSymbol = $Symbol.iterator || "@@iterator";
  var asyncIteratorSymbol = $Symbol.asyncIterator || "@@asyncIterator";
  var toStringTagSymbol = $Symbol.toStringTag || "@@toStringTag";

  function define(obj, key, value) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
    return obj[key];
  }
  try {
    // IE 8 has a broken Object.defineProperty that only works on DOM objects.
    define({}, "");
  } catch (err) {
    define = function(obj, key, value) {
      return obj[key] = value;
    };
  }

  function wrap(innerFn, outerFn, self, tryLocsList) {
    // If outerFn provided and outerFn.prototype is a Generator, then outerFn.prototype instanceof Generator.
    var protoGenerator = outerFn && outerFn.prototype instanceof Generator ? outerFn : Generator;
    var generator = Object.create(protoGenerator.prototype);
    var context = new Context(tryLocsList || []);

    // The ._invoke method unifies the implementations of the .next,
    // .throw, and .return methods.
    generator._invoke = makeInvokeMethod(innerFn, self, context);

    return generator;
  }
  exports.wrap = wrap;

  // Try/catch helper to minimize deoptimizations. Returns a completion
  // record like context.tryEntries[i].completion. This interface could
  // have been (and was previously) designed to take a closure to be
  // invoked without arguments, but in all the cases we care about we
  // already have an existing method we want to call, so there's no need
  // to create a new function object. We can even get away with assuming
  // the method takes exactly one argument, since that happens to be true
  // in every case, so we don't have to touch the arguments object. The
  // only additional allocation required is the completion record, which
  // has a stable shape and so hopefully should be cheap to allocate.
  function tryCatch(fn, obj, arg) {
    try {
      return { type: "normal", arg: fn.call(obj, arg) };
    } catch (err) {
      return { type: "throw", arg: err };
    }
  }

  var GenStateSuspendedStart = "suspendedStart";
  var GenStateSuspendedYield = "suspendedYield";
  var GenStateExecuting = "executing";
  var GenStateCompleted = "completed";

  // Returning this object from the innerFn has the same effect as
  // breaking out of the dispatch switch statement.
  var ContinueSentinel = {};

  // Dummy constructor functions that we use as the .constructor and
  // .constructor.prototype properties for functions that return Generator
  // objects. For full spec compliance, you may wish to configure your
  // minifier not to mangle the names of these two functions.
  function Generator() {}
  function GeneratorFunction() {}
  function GeneratorFunctionPrototype() {}

  // This is a polyfill for %IteratorPrototype% for environments that
  // don't natively support it.
  var IteratorPrototype = {};
  IteratorPrototype[iteratorSymbol] = function () {
    return this;
  };

  var getProto = Object.getPrototypeOf;
  var NativeIteratorPrototype = getProto && getProto(getProto(values([])));
  if (NativeIteratorPrototype &&
      NativeIteratorPrototype !== Op &&
      hasOwn.call(NativeIteratorPrototype, iteratorSymbol)) {
    // This environment has a native %IteratorPrototype%; use it instead
    // of the polyfill.
    IteratorPrototype = NativeIteratorPrototype;
  }

  var Gp = GeneratorFunctionPrototype.prototype =
    Generator.prototype = Object.create(IteratorPrototype);
  GeneratorFunction.prototype = Gp.constructor = GeneratorFunctionPrototype;
  GeneratorFunctionPrototype.constructor = GeneratorFunction;
  GeneratorFunction.displayName = define(
    GeneratorFunctionPrototype,
    toStringTagSymbol,
    "GeneratorFunction"
  );

  // Helper for defining the .next, .throw, and .return methods of the
  // Iterator interface in terms of a single ._invoke method.
  function defineIteratorMethods(prototype) {
    ["next", "throw", "return"].forEach(function(method) {
      define(prototype, method, function(arg) {
        return this._invoke(method, arg);
      });
    });
  }

  exports.isGeneratorFunction = function(genFun) {
    var ctor = typeof genFun === "function" && genFun.constructor;
    return ctor
      ? ctor === GeneratorFunction ||
        // For the native GeneratorFunction constructor, the best we can
        // do is to check its .name property.
        (ctor.displayName || ctor.name) === "GeneratorFunction"
      : false;
  };

  exports.mark = function(genFun) {
    if (Object.setPrototypeOf) {
      Object.setPrototypeOf(genFun, GeneratorFunctionPrototype);
    } else {
      genFun.__proto__ = GeneratorFunctionPrototype;
      define(genFun, toStringTagSymbol, "GeneratorFunction");
    }
    genFun.prototype = Object.create(Gp);
    return genFun;
  };

  // Within the body of any async function, `await x` is transformed to
  // `yield regeneratorRuntime.awrap(x)`, so that the runtime can test
  // `hasOwn.call(value, "__await")` to determine if the yielded value is
  // meant to be awaited.
  exports.awrap = function(arg) {
    return { __await: arg };
  };

  function AsyncIterator(generator, PromiseImpl) {
    function invoke(method, arg, resolve, reject) {
      var record = tryCatch(generator[method], generator, arg);
      if (record.type === "throw") {
        reject(record.arg);
      } else {
        var result = record.arg;
        var value = result.value;
        if (value &&
            typeof value === "object" &&
            hasOwn.call(value, "__await")) {
          return PromiseImpl.resolve(value.__await).then(function(value) {
            invoke("next", value, resolve, reject);
          }, function(err) {
            invoke("throw", err, resolve, reject);
          });
        }

        return PromiseImpl.resolve(value).then(function(unwrapped) {
          // When a yielded Promise is resolved, its final value becomes
          // the .value of the Promise<{value,done}> result for the
          // current iteration.
          result.value = unwrapped;
          resolve(result);
        }, function(error) {
          // If a rejected Promise was yielded, throw the rejection back
          // into the async generator function so it can be handled there.
          return invoke("throw", error, resolve, reject);
        });
      }
    }

    var previousPromise;

    function enqueue(method, arg) {
      function callInvokeWithMethodAndArg() {
        return new PromiseImpl(function(resolve, reject) {
          invoke(method, arg, resolve, reject);
        });
      }

      return previousPromise =
        // If enqueue has been called before, then we want to wait until
        // all previous Promises have been resolved before calling invoke,
        // so that results are always delivered in the correct order. If
        // enqueue has not been called before, then it is important to
        // call invoke immediately, without waiting on a callback to fire,
        // so that the async generator function has the opportunity to do
        // any necessary setup in a predictable way. This predictability
        // is why the Promise constructor synchronously invokes its
        // executor callback, and why async functions synchronously
        // execute code before the first await. Since we implement simple
        // async functions in terms of async generators, it is especially
        // important to get this right, even though it requires care.
        previousPromise ? previousPromise.then(
          callInvokeWithMethodAndArg,
          // Avoid propagating failures to Promises returned by later
          // invocations of the iterator.
          callInvokeWithMethodAndArg
        ) : callInvokeWithMethodAndArg();
    }

    // Define the unified helper method that is used to implement .next,
    // .throw, and .return (see defineIteratorMethods).
    this._invoke = enqueue;
  }

  defineIteratorMethods(AsyncIterator.prototype);
  AsyncIterator.prototype[asyncIteratorSymbol] = function () {
    return this;
  };
  exports.AsyncIterator = AsyncIterator;

  // Note that simple async functions are implemented on top of
  // AsyncIterator objects; they just return a Promise for the value of
  // the final result produced by the iterator.
  exports.async = function(innerFn, outerFn, self, tryLocsList, PromiseImpl) {
    if (PromiseImpl === void 0) PromiseImpl = Promise;

    var iter = new AsyncIterator(
      wrap(innerFn, outerFn, self, tryLocsList),
      PromiseImpl
    );

    return exports.isGeneratorFunction(outerFn)
      ? iter // If outerFn is a generator, return the full iterator.
      : iter.next().then(function(result) {
          return result.done ? result.value : iter.next();
        });
  };

  function makeInvokeMethod(innerFn, self, context) {
    var state = GenStateSuspendedStart;

    return function invoke(method, arg) {
      if (state === GenStateExecuting) {
        throw new Error("Generator is already running");
      }

      if (state === GenStateCompleted) {
        if (method === "throw") {
          throw arg;
        }

        // Be forgiving, per 25.3.3.3.3 of the spec:
        // https://people.mozilla.org/~jorendorff/es6-draft.html#sec-generatorresume
        return doneResult();
      }

      context.method = method;
      context.arg = arg;

      while (true) {
        var delegate = context.delegate;
        if (delegate) {
          var delegateResult = maybeInvokeDelegate(delegate, context);
          if (delegateResult) {
            if (delegateResult === ContinueSentinel) continue;
            return delegateResult;
          }
        }

        if (context.method === "next") {
          // Setting context._sent for legacy support of Babel's
          // function.sent implementation.
          context.sent = context._sent = context.arg;

        } else if (context.method === "throw") {
          if (state === GenStateSuspendedStart) {
            state = GenStateCompleted;
            throw context.arg;
          }

          context.dispatchException(context.arg);

        } else if (context.method === "return") {
          context.abrupt("return", context.arg);
        }

        state = GenStateExecuting;

        var record = tryCatch(innerFn, self, context);
        if (record.type === "normal") {
          // If an exception is thrown from innerFn, we leave state ===
          // GenStateExecuting and loop back for another invocation.
          state = context.done
            ? GenStateCompleted
            : GenStateSuspendedYield;

          if (record.arg === ContinueSentinel) {
            continue;
          }

          return {
            value: record.arg,
            done: context.done
          };

        } else if (record.type === "throw") {
          state = GenStateCompleted;
          // Dispatch the exception by looping back around to the
          // context.dispatchException(context.arg) call above.
          context.method = "throw";
          context.arg = record.arg;
        }
      }
    };
  }

  // Call delegate.iterator[context.method](context.arg) and handle the
  // result, either by returning a { value, done } result from the
  // delegate iterator, or by modifying context.method and context.arg,
  // setting context.delegate to null, and returning the ContinueSentinel.
  function maybeInvokeDelegate(delegate, context) {
    var method = delegate.iterator[context.method];
    if (method === undefined) {
      // A .throw or .return when the delegate iterator has no .throw
      // method always terminates the yield* loop.
      context.delegate = null;

      if (context.method === "throw") {
        // Note: ["return"] must be used for ES3 parsing compatibility.
        if (delegate.iterator["return"]) {
          // If the delegate iterator has a return method, give it a
          // chance to clean up.
          context.method = "return";
          context.arg = undefined;
          maybeInvokeDelegate(delegate, context);

          if (context.method === "throw") {
            // If maybeInvokeDelegate(context) changed context.method from
            // "return" to "throw", let that override the TypeError below.
            return ContinueSentinel;
          }
        }

        context.method = "throw";
        context.arg = new TypeError(
          "The iterator does not provide a 'throw' method");
      }

      return ContinueSentinel;
    }

    var record = tryCatch(method, delegate.iterator, context.arg);

    if (record.type === "throw") {
      context.method = "throw";
      context.arg = record.arg;
      context.delegate = null;
      return ContinueSentinel;
    }

    var info = record.arg;

    if (! info) {
      context.method = "throw";
      context.arg = new TypeError("iterator result is not an object");
      context.delegate = null;
      return ContinueSentinel;
    }

    if (info.done) {
      // Assign the result of the finished delegate to the temporary
      // variable specified by delegate.resultName (see delegateYield).
      context[delegate.resultName] = info.value;

      // Resume execution at the desired location (see delegateYield).
      context.next = delegate.nextLoc;

      // If context.method was "throw" but the delegate handled the
      // exception, let the outer generator proceed normally. If
      // context.method was "next", forget context.arg since it has been
      // "consumed" by the delegate iterator. If context.method was
      // "return", allow the original .return call to continue in the
      // outer generator.
      if (context.method !== "return") {
        context.method = "next";
        context.arg = undefined;
      }

    } else {
      // Re-yield the result returned by the delegate method.
      return info;
    }

    // The delegate iterator is finished, so forget it and continue with
    // the outer generator.
    context.delegate = null;
    return ContinueSentinel;
  }

  // Define Generator.prototype.{next,throw,return} in terms of the
  // unified ._invoke helper method.
  defineIteratorMethods(Gp);

  define(Gp, toStringTagSymbol, "Generator");

  // A Generator should always return itself as the iterator object when the
  // @@iterator function is called on it. Some browsers' implementations of the
  // iterator prototype chain incorrectly implement this, causing the Generator
  // object to not be returned from this call. This ensures that doesn't happen.
  // See https://github.com/facebook/regenerator/issues/274 for more details.
  Gp[iteratorSymbol] = function() {
    return this;
  };

  Gp.toString = function() {
    return "[object Generator]";
  };

  function pushTryEntry(locs) {
    var entry = { tryLoc: locs[0] };

    if (1 in locs) {
      entry.catchLoc = locs[1];
    }

    if (2 in locs) {
      entry.finallyLoc = locs[2];
      entry.afterLoc = locs[3];
    }

    this.tryEntries.push(entry);
  }

  function resetTryEntry(entry) {
    var record = entry.completion || {};
    record.type = "normal";
    delete record.arg;
    entry.completion = record;
  }

  function Context(tryLocsList) {
    // The root entry object (effectively a try statement without a catch
    // or a finally block) gives us a place to store values thrown from
    // locations where there is no enclosing try statement.
    this.tryEntries = [{ tryLoc: "root" }];
    tryLocsList.forEach(pushTryEntry, this);
    this.reset(true);
  }

  exports.keys = function(object) {
    var keys = [];
    for (var key in object) {
      keys.push(key);
    }
    keys.reverse();

    // Rather than returning an object with a next method, we keep
    // things simple and return the next function itself.
    return function next() {
      while (keys.length) {
        var key = keys.pop();
        if (key in object) {
          next.value = key;
          next.done = false;
          return next;
        }
      }

      // To avoid creating an additional object, we just hang the .value
      // and .done properties off the next function object itself. This
      // also ensures that the minifier will not anonymize the function.
      next.done = true;
      return next;
    };
  };

  function values(iterable) {
    if (iterable) {
      var iteratorMethod = iterable[iteratorSymbol];
      if (iteratorMethod) {
        return iteratorMethod.call(iterable);
      }

      if (typeof iterable.next === "function") {
        return iterable;
      }

      if (!isNaN(iterable.length)) {
        var i = -1, next = function next() {
          while (++i < iterable.length) {
            if (hasOwn.call(iterable, i)) {
              next.value = iterable[i];
              next.done = false;
              return next;
            }
          }

          next.value = undefined;
          next.done = true;

          return next;
        };

        return next.next = next;
      }
    }

    // Return an iterator with no values.
    return { next: doneResult };
  }
  exports.values = values;

  function doneResult() {
    return { value: undefined, done: true };
  }

  Context.prototype = {
    constructor: Context,

    reset: function(skipTempReset) {
      this.prev = 0;
      this.next = 0;
      // Resetting context._sent for legacy support of Babel's
      // function.sent implementation.
      this.sent = this._sent = undefined;
      this.done = false;
      this.delegate = null;

      this.method = "next";
      this.arg = undefined;

      this.tryEntries.forEach(resetTryEntry);

      if (!skipTempReset) {
        for (var name in this) {
          // Not sure about the optimal order of these conditions:
          if (name.charAt(0) === "t" &&
              hasOwn.call(this, name) &&
              !isNaN(+name.slice(1))) {
            this[name] = undefined;
          }
        }
      }
    },

    stop: function() {
      this.done = true;

      var rootEntry = this.tryEntries[0];
      var rootRecord = rootEntry.completion;
      if (rootRecord.type === "throw") {
        throw rootRecord.arg;
      }

      return this.rval;
    },

    dispatchException: function(exception) {
      if (this.done) {
        throw exception;
      }

      var context = this;
      function handle(loc, caught) {
        record.type = "throw";
        record.arg = exception;
        context.next = loc;

        if (caught) {
          // If the dispatched exception was caught by a catch block,
          // then let that catch block handle the exception normally.
          context.method = "next";
          context.arg = undefined;
        }

        return !! caught;
      }

      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        var record = entry.completion;

        if (entry.tryLoc === "root") {
          // Exception thrown outside of any try block that could handle
          // it, so set the completion value of the entire function to
          // throw the exception.
          return handle("end");
        }

        if (entry.tryLoc <= this.prev) {
          var hasCatch = hasOwn.call(entry, "catchLoc");
          var hasFinally = hasOwn.call(entry, "finallyLoc");

          if (hasCatch && hasFinally) {
            if (this.prev < entry.catchLoc) {
              return handle(entry.catchLoc, true);
            } else if (this.prev < entry.finallyLoc) {
              return handle(entry.finallyLoc);
            }

          } else if (hasCatch) {
            if (this.prev < entry.catchLoc) {
              return handle(entry.catchLoc, true);
            }

          } else if (hasFinally) {
            if (this.prev < entry.finallyLoc) {
              return handle(entry.finallyLoc);
            }

          } else {
            throw new Error("try statement without catch or finally");
          }
        }
      }
    },

    abrupt: function(type, arg) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.tryLoc <= this.prev &&
            hasOwn.call(entry, "finallyLoc") &&
            this.prev < entry.finallyLoc) {
          var finallyEntry = entry;
          break;
        }
      }

      if (finallyEntry &&
          (type === "break" ||
           type === "continue") &&
          finallyEntry.tryLoc <= arg &&
          arg <= finallyEntry.finallyLoc) {
        // Ignore the finally entry if control is not jumping to a
        // location outside the try/catch block.
        finallyEntry = null;
      }

      var record = finallyEntry ? finallyEntry.completion : {};
      record.type = type;
      record.arg = arg;

      if (finallyEntry) {
        this.method = "next";
        this.next = finallyEntry.finallyLoc;
        return ContinueSentinel;
      }

      return this.complete(record);
    },

    complete: function(record, afterLoc) {
      if (record.type === "throw") {
        throw record.arg;
      }

      if (record.type === "break" ||
          record.type === "continue") {
        this.next = record.arg;
      } else if (record.type === "return") {
        this.rval = this.arg = record.arg;
        this.method = "return";
        this.next = "end";
      } else if (record.type === "normal" && afterLoc) {
        this.next = afterLoc;
      }

      return ContinueSentinel;
    },

    finish: function(finallyLoc) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.finallyLoc === finallyLoc) {
          this.complete(entry.completion, entry.afterLoc);
          resetTryEntry(entry);
          return ContinueSentinel;
        }
      }
    },

    "catch": function(tryLoc) {
      for (var i = this.tryEntries.length - 1; i >= 0; --i) {
        var entry = this.tryEntries[i];
        if (entry.tryLoc === tryLoc) {
          var record = entry.completion;
          if (record.type === "throw") {
            var thrown = record.arg;
            resetTryEntry(entry);
          }
          return thrown;
        }
      }

      // The context.catch method must only be called with a location
      // argument that corresponds to a known catch block.
      throw new Error("illegal catch attempt");
    },

    delegateYield: function(iterable, resultName, nextLoc) {
      this.delegate = {
        iterator: values(iterable),
        resultName: resultName,
        nextLoc: nextLoc
      };

      if (this.method === "next") {
        // Deliberately forget the last sent value so that we don't
        // accidentally pass it on to the delegate.
        this.arg = undefined;
      }

      return ContinueSentinel;
    }
  };

  // Regardless of whether this script is executing as a CommonJS module
  // or not, return the runtime object so that we can declare the variable
  // regeneratorRuntime in the outer scope, which allows this module to be
  // injected easily by `bin/regenerator --include-runtime script.js`.
  return exports;

}(
  // If this script is executing as a CommonJS module, use module.exports
  // as the regeneratorRuntime namespace. Otherwise create a new empty
  // object. Either way, the resulting object will be used to initialize
  // the regeneratorRuntime variable at the top of this file.
  typeof module === "object" ? module.exports : {}
));

try {
  regeneratorRuntime = runtime;
} catch (accidentalStrictMode) {
  // This module should not be running in strict mode, so the above
  // assignment should always work unless something is misconfigured. Just
  // in case runtime.js accidentally runs in strict mode, we can escape
  // strict mode using a global Function call. This could conceivably fail
  // if a Content Security Policy forbids using Function, but in that case
  // the proper solution is to fix the accidental strict mode problem. If
  // you've misconfigured your bundler to force strict mode and applied a
  // CSP to forbid Function, and you're not willing to fix either of those
  // problems, please detail your unique predicament in a GitHub issue.
  Function("r", "regeneratorRuntime = r")(runtime);
}

},{}],"dtemulator.js":[function(require,module,exports) {
'use strict';

function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(_next, _throw); } }

function _asyncToGenerator(fn) { return function () { var self = this, args = arguments; return new Promise(function (resolve, reject) { var gen = fn.apply(self, args); function _next(value) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value); } function _throw(err) { asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err); } _next(undefined); }); }; }

var filesystem = require('./filesystem');

var _require = require('v86'),
    V86Starter = _require.V86Starter;

var _require2 = require('./dtconfig'),
    emulatorDefaultParams = _require2.emulatorDefaultParams;

var dtSnapshot = require('./dtsnapshot');

require("regenerator-runtime");

var emulator = null;

var bootDT =
/*#__PURE__*/
function () {
  var _ref = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee(xterm) {
    var isSnapshotExists;
    return regeneratorRuntime.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            if (emulator) {
              _context.next = 24;
              break;
            }

            console.log('boot called');
            _context.next = 4;
            return dtSnapshot.hasSnapshot();

          case 4:
            isSnapshotExists = _context.sent;

            if (!isSnapshotExists) {
              _context.next = 19;
              break;
            }

            _context.prev = 6;
            _context.next = 9;
            return snapshotBoot(xterm);

          case 9:
            _context.next = 17;
            break;

          case 11:
            _context.prev = 11;
            _context.t0 = _context["catch"](6);
            console.log('Cached boot failed:', _context.t0.message);
            console.log('trying normal boot...please wait');
            _context.next = 17;
            return freshBoot(xterm);

          case 17:
            _context.next = 22;
            break;

          case 19:
            console.log('Booting...please wait.');
            _context.next = 22;
            return freshBoot(xterm);

          case 22:
            _context.next = 25;
            break;

          case 24:
            return _context.abrupt("return");

          case 25:
          case "end":
            return _context.stop();
        }
      }
    }, _callee, null, [[6, 11]]);
  }));

  return function bootDT(_x) {
    return _ref.apply(this, arguments);
  };
}(); // Restart the Digital Twin emulator


var suspend = function suspend() {
  if (emulator && emulator.is_running()) {
    emulator.stop();
  }
}; // Set welcome screen and clear booting console message.


var setWelcomeScreen = function setWelcomeScreen(emulator, xterm) {
  xterm.reset();
  xterm.writeln('Now you can interact with the Digital Twin using this serial console.');
  xterm.writeln('Welcome to SPRECON Digital Twin');
  xterm.writeln('The filesystem is mounted in /mnt. Guest <-> Host');
  xterm.write('/ # ');
  xterm.onData(function (data) {
    emulator.serial0_send(data);
  });
  emulator.add_listener('serial0-output-char', function (char) {
    return xterm.write(char);
  });
  xterm.clear();
}; // Pass Filer filesystem object


var getEmulatorParams = function getEmulatorParams() {
  var params = Object.create(emulatorDefaultParams);
  params.filesystem = filesystem;
  return params;
}; // Inital digital twin booting and taking snapshot.


var freshBoot =
/*#__PURE__*/
function () {
  var _ref2 = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee2(xterm) {
    var params;
    return regeneratorRuntime.wrap(function _callee2$(_context2) {
      while (1) {
        switch (_context2.prev = _context2.next) {
          case 0:
            params = getEmulatorParams();
            emulator = new V86Starter(params);
            _context2.next = 4;
            return takeSnapshotAfterBoot(emulator, xterm);

          case 4:
            // iframeSet();
            console.log('fresh bboot');
            filesystem.welcome();
            return _context2.abrupt("return", emulator);

          case 7:
          case "end":
            return _context2.stop();
        }
      }
    }, _callee2);
  }));

  return function freshBoot(_x2) {
    return _ref2.apply(this, arguments);
  };
}(); // Booting digital twin from the latest snapshot.


var snapshotBoot =
/*#__PURE__*/
function () {
  var _ref3 = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee3(xterm) {
    var params;
    return regeneratorRuntime.wrap(function _callee3$(_context3) {
      while (1) {
        switch (_context3.prev = _context3.next) {
          case 0:
            console.log('cached boot');
            params = getEmulatorParams();
            return _context3.abrupt("return", dtSnapshot.getSnapshot().then(function (res) {
              return res.arrayBuffer();
            }).then(function (buffer) {
              return URL.createObjectURL(new Blob([buffer], {
                type: 'application/octet-stream'
              }));
            }).then(function (cacheURL) {
              params.initial_state = {
                cacheURL: cacheURL
              };
              emulator = new V86Starter(params);
              setWelcomeScreen(emulator, xterm);
            }));

          case 3:
          case "end":
            return _context3.stop();
        }
      }
    }, _callee3);
  }));

  return function snapshotBoot(_x3) {
    return _ref3.apply(this, arguments);
  };
}(); // Read the console and  the boot message in the console


var checkBootCompletion =
/*#__PURE__*/
function () {
  var _ref4 = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee4(emulator, xterm) {
    return regeneratorRuntime.wrap(function _callee4$(_context4) {
      while (1) {
        switch (_context4.prev = _context4.next) {
          case 0:
            return _context4.abrupt("return", new Promise(function (resolve) {
              var screenData = [];
              var serialData = '';
              var row;

              function checkScreenData(data) {
                var rows = data[0];
                var columns = data[1];
                var char = data[2];

                if (rows !== row) {
                  row = rows;
                  xterm.writeln(screenData.join(''));
                  screenData = [];
                }

                screenData[columns] = String.fromCharCode(char);
              }

              function checkSerialData(char) {
                serialData += char; // check for the root user character in the terminal

                if (serialData.endsWith('/ # ')) {
                  emulator.remove_listener('screen-put-char', checkScreenData);
                  emulator.remove_listener('serial0-output-char', checkSerialData);
                  xterm.clear();
                  resolve();
                }
              }

              emulator.add_listener('screen-put-char', checkScreenData);
              emulator.add_listener('serial0-output-char', checkSerialData);
            }));

          case 1:
          case "end":
            return _context4.stop();
        }
      }
    }, _callee4);
  }));

  return function checkBootCompletion(_x4, _x5) {
    return _ref4.apply(this, arguments);
  };
}();

var takeSnapshotAfterBoot =
/*#__PURE__*/
function () {
  var _ref5 = _asyncToGenerator(
  /*#__PURE__*/
  regeneratorRuntime.mark(function _callee5(emulator, xterm) {
    return regeneratorRuntime.wrap(function _callee5$(_context5) {
      while (1) {
        switch (_context5.prev = _context5.next) {
          case 0:
            // check boot completion, set welcome screen and save the snapshot
            console.log('take snapshot');
            _context5.next = 3;
            return checkBootCompletion(emulator, xterm);

          case 3:
            setWelcomeScreen(emulator, xterm);
            emulator.save_state(dtSnapshot.saveSnapshot);
            console.log('DT snapshot saved to Browser Cache Storage');

          case 6:
          case "end":
            return _context5.stop();
        }
      }
    }, _callee5);
  }));

  return function takeSnapshotAfterBoot(_x6, _x7) {
    return _ref5.apply(this, arguments);
  };
}();

module.exports = {
  bootDT: bootDT,
  suspend: suspend
};
},{"./filesystem":"filesystem.js","v86":"../node_modules/v86/build/libv86.js","./dtconfig":"dtconfig.js","./dtsnapshot":"dtsnapshot.js","regenerator-runtime":"../node_modules/regenerator-runtime/runtime.js"}],"dtconsole.js":[function(require,module,exports) {
'use strict';

var _require = require('xterm'),
    Terminal = _require.Terminal;

var _require2 = require('xterm-addon-fit'),
    FitAddon = _require2.FitAddon;

var dtEmulator = require('./dtemulator');

function startDigitalTwin() {
  window.addEventListener('DOMContentLoaded', function () {
    var xterm = window.xterm = new Terminal();
    var fitAddon = new FitAddon();
    xterm.loadAddon(fitAddon);
    xterm.open(document.getElementById('dt_console'));
    fitAddon.fit(); //Power up the virtual machine

    document.querySelector('#dt_poweron').onclick = function () {
      dtEmulator.bootDT(xterm);
    }; //Restart the virtual machine


    document.querySelector('#dt_restart').onclick = function () {
      dtEmulator.suspend();
    };
  });
}

module.exports.startDigitalTwin = startDigitalTwin;
},{"xterm":"../node_modules/xterm/lib/xterm.js","xterm-addon-fit":"../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js","./dtemulator":"dtemulator.js"}],"app.js":[function(require,module,exports) {
'use strict';

var dtWebServer = require('./dtwebserver');

var dtConsole = require('./dtconsole'); //Building the Console Terminal for VM


dtConsole.startDigitalTwin();
dtWebServer.start();
},{"./dtwebserver":"dtwebserver.js","./dtconsole":"dtconsole.js"}],"../../../.nvm/versions/node/v14.16.1/lib/node_modules/parcel-bundler/src/builtins/hmr-runtime.js":[function(require,module,exports) {
var global = arguments[3];
var OVERLAY_ID = '__parcel__error__overlay__';
var OldModule = module.bundle.Module;

function Module(moduleName) {
  OldModule.call(this, moduleName);
  this.hot = {
    data: module.bundle.hotData,
    _acceptCallbacks: [],
    _disposeCallbacks: [],
    accept: function (fn) {
      this._acceptCallbacks.push(fn || function () {});
    },
    dispose: function (fn) {
      this._disposeCallbacks.push(fn);
    }
  };
  module.bundle.hotData = null;
}

module.bundle.Module = Module;
var checkedAssets, assetsToAccept;
var parent = module.bundle.parent;

if ((!parent || !parent.isParcelRequire) && typeof WebSocket !== 'undefined') {
  var hostname = "" || location.hostname;
  var protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  var ws = new WebSocket(protocol + '://' + hostname + ':' + "37563" + '/');

  ws.onmessage = function (event) {
    checkedAssets = {};
    assetsToAccept = [];
    var data = JSON.parse(event.data);

    if (data.type === 'update') {
      var handled = false;
      data.assets.forEach(function (asset) {
        if (!asset.isNew) {
          var didAccept = hmrAcceptCheck(global.parcelRequire, asset.id);

          if (didAccept) {
            handled = true;
          }
        }
      }); // Enable HMR for CSS by default.

      handled = handled || data.assets.every(function (asset) {
        return asset.type === 'css' && asset.generated.js;
      });

      if (handled) {
        console.clear();
        data.assets.forEach(function (asset) {
          hmrApply(global.parcelRequire, asset);
        });
        assetsToAccept.forEach(function (v) {
          hmrAcceptRun(v[0], v[1]);
        });
      } else {
        window.location.reload();
      }
    }

    if (data.type === 'reload') {
      ws.close();

      ws.onclose = function () {
        location.reload();
      };
    }

    if (data.type === 'error-resolved') {
      console.log('[parcel] ✨ Error resolved');
      removeErrorOverlay();
    }

    if (data.type === 'error') {
      console.error('[parcel] 🚨  ' + data.error.message + '\n' + data.error.stack);
      removeErrorOverlay();
      var overlay = createErrorOverlay(data);
      document.body.appendChild(overlay);
    }
  };
}

function removeErrorOverlay() {
  var overlay = document.getElementById(OVERLAY_ID);

  if (overlay) {
    overlay.remove();
  }
}

function createErrorOverlay(data) {
  var overlay = document.createElement('div');
  overlay.id = OVERLAY_ID; // html encode message and stack trace

  var message = document.createElement('div');
  var stackTrace = document.createElement('pre');
  message.innerText = data.error.message;
  stackTrace.innerText = data.error.stack;
  overlay.innerHTML = '<div style="background: black; font-size: 16px; color: white; position: fixed; height: 100%; width: 100%; top: 0px; left: 0px; padding: 30px; opacity: 0.85; font-family: Menlo, Consolas, monospace; z-index: 9999;">' + '<span style="background: red; padding: 2px 4px; border-radius: 2px;">ERROR</span>' + '<span style="top: 2px; margin-left: 5px; position: relative;">🚨</span>' + '<div style="font-size: 18px; font-weight: bold; margin-top: 20px;">' + message.innerHTML + '</div>' + '<pre>' + stackTrace.innerHTML + '</pre>' + '</div>';
  return overlay;
}

function getParents(bundle, id) {
  var modules = bundle.modules;

  if (!modules) {
    return [];
  }

  var parents = [];
  var k, d, dep;

  for (k in modules) {
    for (d in modules[k][1]) {
      dep = modules[k][1][d];

      if (dep === id || Array.isArray(dep) && dep[dep.length - 1] === id) {
        parents.push(k);
      }
    }
  }

  if (bundle.parent) {
    parents = parents.concat(getParents(bundle.parent, id));
  }

  return parents;
}

function hmrApply(bundle, asset) {
  var modules = bundle.modules;

  if (!modules) {
    return;
  }

  if (modules[asset.id] || !bundle.parent) {
    var fn = new Function('require', 'module', 'exports', asset.generated.js);
    asset.isNew = !modules[asset.id];
    modules[asset.id] = [fn, asset.deps];
  } else if (bundle.parent) {
    hmrApply(bundle.parent, asset);
  }
}

function hmrAcceptCheck(bundle, id) {
  var modules = bundle.modules;

  if (!modules) {
    return;
  }

  if (!modules[id] && bundle.parent) {
    return hmrAcceptCheck(bundle.parent, id);
  }

  if (checkedAssets[id]) {
    return;
  }

  checkedAssets[id] = true;
  var cached = bundle.cache[id];
  assetsToAccept.push([bundle, id]);

  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {
    return true;
  }

  return getParents(global.parcelRequire, id).some(function (id) {
    return hmrAcceptCheck(global.parcelRequire, id);
  });
}

function hmrAcceptRun(bundle, id) {
  var cached = bundle.cache[id];
  bundle.hotData = {};

  if (cached) {
    cached.hot.data = bundle.hotData;
  }

  if (cached && cached.hot && cached.hot._disposeCallbacks.length) {
    cached.hot._disposeCallbacks.forEach(function (cb) {
      cb(bundle.hotData);
    });
  }

  delete bundle.cache[id];
  bundle(id);
  cached = bundle.cache[id];

  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {
    cached.hot._acceptCallbacks.forEach(function (cb) {
      cb();
    });

    return true;
  }
}
},{}]},{},["../../../.nvm/versions/node/v14.16.1/lib/node_modules/parcel-bundler/src/builtins/hmr-runtime.js","app.js"], null)
//# sourceMappingURL=/app.c328ef1a.js.map